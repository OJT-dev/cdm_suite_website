
// ==========================================
// File: app/(dashboard)/crm/page.tsx
// ==========================================

'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { Lead, LeadStatus, LeadFilters } from '@/lib/crm-types';
import { KanbanBoard } from '@/components/crm/kanban-board';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ActivityTimeline } from '@/components/crm/activity-timeline';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import {
  Search,
  Plus,
  Filter,
  Users,
  TrendingUp,
  Star,
  Calendar,
  Phone,
  Mail,
  Building2,
  DollarSign,
  Clock,
  Save,
  X
} from 'lucide-react';
import { LEAD_PRIORITIES, LEAD_SOURCES, formatLeadSource, getPriorityColor } from '@/lib/crm-utils';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';

export default function CRMPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [leads, setLeads] = useState<Lead[]>([]);
  const [filteredLeads, setFilteredLeads] = useState<Lead[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedLead, setSelectedLead] = useState<Lead | null>(null);
  const [showLeadDialog, setShowLeadDialog] = useState(false);
  const [showNewActivityDialog, setShowNewActivityDialog] = useState(false);
  
  // Filters
  const [filters, setFilters] = useState<LeadFilters>({
    search: '',
    status: undefined,
    priority: undefined,
    source: undefined
  });

  // New Activity Form
  const [newActivity, setNewActivity] = useState({
    type: 'note',
    title: '',
    description: ''
  });

  // Fetch leads
  useEffect(() => {
    if (status === 'authenticated') {
      fetchLeads();
    }
  }, [status]);

  // Apply filters
  useEffect(() => {
    let filtered = [...leads];

    if (filters.search) {
      const search = filters.search.toLowerCase();
      filtered = filtered.filter(
        lead =>
          lead.email.toLowerCase().includes(search) ||
          lead.name?.toLowerCase().includes(search) ||
          lead.company?.toLowerCase().includes(search)
      );
    }

    if (filters.status) {
      filtered = filtered.filter(lead => lead.status === filters.status);
    }

    if (filters.priority) {
      filtered = filtered.filter(lead => lead.priority === filters.priority);
    }

    if (filters.source) {
      filtered = filtered.filter(lead => lead.source === filters.source);
    }

    setFilteredLeads(filtered);
  }, [leads, filters]);

  const fetchLeads = async () => {
    try {
      setLoading(true);
      const res = await fetch('/api/crm/leads');
      if (res.ok) {
        const data = await res.json();
        setLeads(data.leads);
      } else {
        toast.error('Failed to fetch leads');
      }
    } catch (error) {
      console.error('Error fetching leads:', error);
      toast.error('An error occurred');
    } finally {
      setLoading(false);
    }
  };

  const handleLeadClick = async (lead: Lead) => {
    try {
      // Fetch full lead details
      const res = await fetch(`/api/crm/leads/${lead.id}`);
      if (res.ok) {
        const data = await res.json();
        setSelectedLead(data.lead);
        setShowLeadDialog(true);
      }
    } catch (error) {
      console.error('Error fetching lead details:', error);
      toast.error('Failed to load lead details');
    }
  };

  const handleStatusChange = async (leadId: string, newStatus: LeadStatus) => {
    try {
      const res = await fetch(`/api/crm/leads/${leadId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });

      if (res.ok) {
        const data = await res.json();
        setLeads(leads.map(l => (l.id === leadId ? data.lead : l)));
        toast.success('Lead status updated');
      } else {
        toast.error('Failed to update lead status');
      }
    } catch (error) {
      console.error('Error updating lead:', error);
      toast.error('An error occurred');
    }
  };

  const handleAddActivity = async () => {
    if (!selectedLead || !newActivity.title) {
      toast.error('Please fill in all required fields');
      return;
    }

    try {
      const res = await fetch(`/api/crm/leads/${selectedLead.id}/activities`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newActivity)
      });

      if (res.ok) {
        const data = await res.json();
        // Refresh lead details
        const leadRes = await fetch(`/api/crm/leads/${selectedLead.id}`);
        if (leadRes.ok) {
          const leadData = await leadRes.json();
          setSelectedLead(leadData.lead);
        }
        
        setNewActivity({ type: 'note', title: '', description: '' });
        setShowNewActivityDialog(false);
        toast.success('Activity added');
      } else {
        toast.error('Failed to add activity');
      }
    } catch (error) {
      console.error('Error adding activity:', error);
      toast.error('An error occurred');
    }
  };

  if (status === 'loading' || loading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600" />
      </div>
    );
  }

  if (status === 'unauthenticated') {
    router.push('/login');
    return null;
  }

  return (
    <div className="h-screen flex flex-col bg-gray-50">
      {/* Header */}
      <div className="bg-white border-b border-gray-200 px-6 py-4">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Lead CRM</h1>
            <p className="text-sm text-gray-600">Manage and nurture your leads</p>
          </div>

          <div className="flex items-center gap-3">
            <Button variant="outline" size="sm">
              <Filter className="h-4 w-4 mr-2" />
              Export
            </Button>
            <Button size="sm">
              <Plus className="h-4 w-4 mr-2" />
              New Lead
            </Button>
          </div>
        </div>

        {/* Filters */}
        <div className="flex gap-3 mt-4">
          <div className="flex-1 max-w-md">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
              <Input
                placeholder="Search leads..."
                value={filters.search}
                onChange={e => setFilters({ ...filters, search: e.target.value })}
                className="pl-10"
              />
            </div>
          </div>

          <Select
            value={filters.priority || 'all'}
            onValueChange={value =>
              setFilters({ ...filters, priority: value === 'all' ? undefined : value as any })
            }
          >
            <SelectTrigger className="w-40">
              <SelectValue placeholder="Priority" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Priorities</SelectItem>
              {LEAD_PRIORITIES.map(p => (
                <SelectItem key={p.value} value={p.value}>
                  {p.label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>

          <Select
            value={filters.source || 'all'}
            onValueChange={value =>
              setFilters({ ...filters, source: value === 'all' ? undefined : value })
            }
          >
            <SelectTrigger className="w-48">
              <SelectValue placeholder="Source" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Sources</SelectItem>
              {LEAD_SOURCES.map(s => (
                <SelectItem key={s.value} value={s.value}>
                  {s.label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>

          {(filters.priority || filters.source || filters.search) && (
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setFilters({ search: '', status: undefined, priority: undefined, source: undefined })}
            >
              <X className="h-4 w-4 mr-2" />
              Clear
            </Button>
          )}
        </div>
      </div>

      {/* Kanban Board */}
      <div className="flex-1 overflow-hidden px-6 pt-4">
        <KanbanBoard
          leads={filteredLeads}
          onLeadClick={handleLeadClick}
          onStatusChange={handleStatusChange}
        />
      </div>

      {/* Lead Detail Dialog */}
      <Dialog open={showLeadDialog} onOpenChange={setShowLeadDialog}>
        <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
          {selectedLead && (
            <>
              <DialogHeader>
                <DialogTitle className="flex items-center gap-3">
                  <span>{selectedLead.name || selectedLead.email}</span>
                  <Badge className={cn(
                    selectedLead.score >= 80 ? "bg-green-100 text-green-700" :
                    selectedLead.score >= 50 ? "bg-yellow-100 text-yellow-700" :
                    "bg-gray-100 text-gray-700"
                  )}>
                    <Star className="h-3 w-3 mr-1" />
                    Score: {selectedLead.score}
                  </Badge>
                </DialogTitle>
                <DialogDescription>
                  Lead from {formatLeadSource(selectedLead.source)}
                </DialogDescription>
              </DialogHeader>

              <Tabs defaultValue="details" className="mt-4">
                <TabsList>
                  <TabsTrigger value="details">Details</TabsTrigger>
                  <TabsTrigger value="activity">
                    Activity
                    {selectedLead.activities && selectedLead.activities.length > 0 && (
                      <Badge variant="secondary" className="ml-2">
                        {selectedLead.activities.length}
                      </Badge>
                    )}
                  </TabsTrigger>
                  <TabsTrigger value="sequences">Sequences</TabsTrigger>
                </TabsList>

                <TabsContent value="details" className="space-y-4">
                  {/* Contact Information */}
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label className="text-xs text-gray-500">Email</Label>
                      <div className="flex items-center gap-2 mt-1">
                        <Mail className="h-4 w-4 text-gray-400" />
                        <span className="text-sm">{selectedLead.email}</span>
                      </div>
                    </div>

                    {selectedLead.phone && (
                      <div>
                        <Label className="text-xs text-gray-500">Phone</Label>
                        <div className="flex items-center gap-2 mt-1">
                          <Phone className="h-4 w-4 text-gray-400" />
                          <span className="text-sm">{selectedLead.phone}</span>
                        </div>
                      </div>
                    )}

                    {selectedLead.company && (
                      <div>
                        <Label className="text-xs text-gray-500">Company</Label>
                        <div className="flex items-center gap-2 mt-1">
                          <Building2 className="h-4 w-4 text-gray-400" />
                          <span className="text-sm">{selectedLead.company}</span>
                        </div>
                      </div>
                    )}

                    <div>
                      <Label className="text-xs text-gray-500">Priority</Label>
                      <div className="flex items-center gap-2 mt-1">
                        <span className={cn("text-sm capitalize", getPriorityColor(selectedLead.priority))}>
                          {selectedLead.priority}
                        </span>
                      </div>
                    </div>

                    {selectedLead.budget && (
                      <div>
                        <Label className="text-xs text-gray-500">Budget</Label>
                        <div className="flex items-center gap-2 mt-1">
                          <DollarSign className="h-4 w-4 text-gray-400" />
                          <span className="text-sm">{selectedLead.budget}</span>
                        </div>
                      </div>
                    )}

                    {selectedLead.timeline && (
                      <div>
                        <Label className="text-xs text-gray-500">Timeline</Label>
                        <div className="flex items-center gap-2 mt-1">
                          <Clock className="h-4 w-4 text-gray-400" />
                          <span className="text-sm">{selectedLead.timeline}</span>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Interest */}
                  {selectedLead.interest && (
                    <div>
                      <Label className="text-xs text-gray-500">Interest</Label>
                      <p className="text-sm mt-1">{selectedLead.interest}</p>
                    </div>
                  )}

                  {/* Notes */}
                  {selectedLead.notes && (
                    <div>
                      <Label className="text-xs text-gray-500">Notes</Label>
                      <p className="text-sm mt-1 whitespace-pre-wrap">{selectedLead.notes}</p>
                    </div>
                  )}

                  {/* Tags */}
                  {selectedLead.tags && selectedLead.tags.length > 0 && (
                    <div>
                      <Label className="text-xs text-gray-500">Tags</Label>
                      <div className="flex flex-wrap gap-2 mt-1">
                        {selectedLead.tags.map(tag => (
                          <Badge key={tag} variant="secondary">{tag}</Badge>
                        ))}
                      </div>
                    </div>
                  )}
                </TabsContent>

                <TabsContent value="activity" className="space-y-4">
                  <div className="flex justify-between items-center">
                    <h3 className="font-semibold">Activity Timeline</h3>
                    <Button size="sm" onClick={() => setShowNewActivityDialog(true)}>
                      <Plus className="h-4 w-4 mr-2" />
                      Add Activity
                    </Button>
                  </div>
                  
                  <ActivityTimeline activities={selectedLead.activities || []} />
                </TabsContent>

                <TabsContent value="sequences">
                  <div className="text-center py-8 text-gray-500">
                    <p className="text-sm">Sequence management coming soon</p>
                  </div>
                </TabsContent>
              </Tabs>
            </>
          )}
        </DialogContent>
      </Dialog>

      {/* New Activity Dialog */}
      <Dialog open={showNewActivityDialog} onOpenChange={setShowNewActivityDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Add Activity</DialogTitle>
            <DialogDescription>Record an interaction with this lead</DialogDescription>
          </DialogHeader>

          <div className="space-y-4 mt-4">
            <div>
              <Label>Type</Label>
              <Select
                value={newActivity.type}
                onValueChange={value => setNewActivity({ ...newActivity, type: value })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="note">Note</SelectItem>
                  <SelectItem value="email">Email</SelectItem>
                  <SelectItem value="call">Call</SelectItem>
                  <SelectItem value="meeting">Meeting</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label>Title</Label>
              <Input
                value={newActivity.title}
                onChange={e => setNewActivity({ ...newActivity, title: e.target.value })}
                placeholder="Brief summary"
              />
            </div>

            <div>
              <Label>Description</Label>
              <Textarea
                value={newActivity.description}
                onChange={e => setNewActivity({ ...newActivity, description: e.target.value })}
                placeholder="Additional details..."
                rows={4}
              />
            </div>

            <div className="flex justify-end gap-2">
              <Button variant="outline" onClick={() => setShowNewActivityDialog(false)}>
                Cancel
              </Button>
              <Button onClick={handleAddActivity}>
                <Save className="h-4 w-4 mr-2" />
                Save Activity
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}

// ==========================================
// File: app/404/page.tsx
// ==========================================


import NotFound from '../not-found';

export default function Custom404Page() {
  return <NotFound />;
}

// ==========================================
// File: app/about/page.tsx
// ==========================================


import Navigation from "@/components/navigation";
import Footer from "@/components/footer";
import AboutHero from "@/components/about/about-hero";
import AboutStory from "@/components/about/about-story";
import AboutMission from "@/components/about/about-mission";
import AboutTeam from "@/components/about/about-team";

export const metadata = {
  title: "About CDM Suite - Digital Marketing Agency",
  description: "Learn about CDM Suite's mission, values, and team. Founded in 2015, we're a digital marketing agency that helps businesses get real, measurable results.",
};

export default function AboutPage() {
  return (
    <main>
      <Navigation />
      <AboutHero />
      <AboutStory />
      <AboutMission />
      <AboutTeam />
      <Footer />
    </main>
  );
}

// ==========================================
// File: app/admin/employees/employee-form.tsx
// ==========================================

'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Badge } from '@/components/ui/badge';
import { ArrowLeft, Save, Shield } from 'lucide-react';
import Link from 'next/link';
import { toast } from 'sonner';
import {
  EMPLOYEE_ROLES,
  DEPARTMENTS,
  DEFAULT_CAPABILITIES,
  getRoleDisplayName,
  getDepartmentDisplayName,
  type EmployeeCapabilities,
  type EmployeeRole,
} from '@/lib/roles';

interface EmployeeFormData {
  name: string;
  email: string;
  phone: string;
  password?: string;
  employeeRole: string;
  department: string;
  weeklyCapacity: number;
  skillSet: string[];
  capabilities: EmployeeCapabilities;
  status: string;
}

interface EmployeeFormProps {
  mode: 'create' | 'edit';
  employeeId?: string;
}

export default function EmployeeForm({ mode, employeeId }: EmployeeFormProps) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [submitting, setSubmitting] = useState(false);
  const [skillInput, setSkillInput] = useState('');

  const [formData, setFormData] = useState<EmployeeFormData>({
    name: '',
    email: '',
    phone: '',
    password: '',
    employeeRole: EMPLOYEE_ROLES.DEVELOPER,
    department: DEPARTMENTS.DEVELOPMENT,
    weeklyCapacity: 40,
    skillSet: [],
    capabilities: DEFAULT_CAPABILITIES[EMPLOYEE_ROLES.DEVELOPER],
    status: 'active',
  });

  useEffect(() => {
    if (mode === 'edit' && employeeId) {
      fetchEmployee();
    }
  }, [mode, employeeId]);

  const fetchEmployee = async () => {
    try {
      setLoading(true);
      const response = await fetch(`/api/admin/employees/${employeeId}`);
      
      if (!response.ok) {
        throw new Error('Failed to fetch employee');
      }

      const data = await response.json();
      setFormData({
        name: data.user.name || '',
        email: data.user.email,
        phone: data.user.phone || '',
        employeeRole: data.employeeRole,
        department: data.department || DEPARTMENTS.DEVELOPMENT,
        weeklyCapacity: data.weeklyCapacity,
        skillSet: data.skillSet,
        capabilities: data.capabilities,
        status: data.status,
      });
    } catch (error) {
      console.error('Error fetching employee:', error);
      toast.error('Failed to load employee data');
      router.push('/admin/employees');
    } finally {
      setLoading(false);
    }
  };

  const handleRoleChange = (newRole: string) => {
    setFormData({
      ...formData,
      employeeRole: newRole,
      capabilities: DEFAULT_CAPABILITIES[newRole as EmployeeRole],
    });
  };

  const handleCapabilityToggle = (capability: keyof EmployeeCapabilities) => {
    setFormData({
      ...formData,
      capabilities: {
        ...formData.capabilities,
        [capability]: !formData.capabilities[capability],
      },
    });
  };

  const addSkill = () => {
    if (skillInput.trim() && !formData.skillSet.includes(skillInput.trim())) {
      setFormData({
        ...formData,
        skillSet: [...formData.skillSet, skillInput.trim()],
      });
      setSkillInput('');
    }
  };

  const removeSkill = (skill: string) => {
    setFormData({
      ...formData,
      skillSet: formData.skillSet.filter((s) => s !== skill),
    });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!formData.name || !formData.email || !formData.employeeRole) {
      toast.error('Please fill in all required fields');
      return;
    }

    if (mode === 'create' && !formData.password) {
      toast.error('Password is required for new employees');
      return;
    }

    try {
      setSubmitting(true);

      const url = mode === 'create' 
        ? '/api/admin/employees'
        : `/api/admin/employees/${employeeId}`;

      const method = mode === 'create' ? 'POST' : 'PATCH';

      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to save employee');
      }

      toast.success(
        mode === 'create'
          ? 'Employee created successfully'
          : 'Employee updated successfully'
      );

      router.push('/admin/employees');
      router.refresh();
    } catch (error: any) {
      console.error('Error saving employee:', error);
      toast.error(error.message || 'Failed to save employee');
    } finally {
      setSubmitting(false);
    }
  };

  if (loading) {
    return (
      <div className="container mx-auto py-8 px-4">
        <div className="flex items-center justify-center min-h-[400px]">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p className="text-muted-foreground">Loading employee data...</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto py-8 px-4 max-w-5xl">
      <div className="mb-6">
        <Link href="/admin/employees">
          <Button variant="ghost" className="gap-2 mb-4">
            <ArrowLeft className="h-4 w-4" />
            Back to Employees
          </Button>
        </Link>
        <h1 className="text-3xl font-bold">
          {mode === 'create' ? 'Add New Employee' : 'Edit Employee'}
        </h1>
        <p className="text-muted-foreground mt-2">
          {mode === 'create'
            ? 'Create a new employee account with role and permissions'
            : 'Update employee information and permissions'}
        </p>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Basic Information */}
        <Card>
          <CardHeader>
            <CardTitle>Basic Information</CardTitle>
            <CardDescription>
              Employee personal and contact details
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="name">Full Name *</Label>
                <Input
                  id="name"
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                  required
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="email">Email *</Label>
                <Input
                  id="email"
                  type="email"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                  disabled={mode === 'edit'}
                  required
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="phone">Phone</Label>
                <Input
                  id="phone"
                  type="tel"
                  value={formData.phone}
                  onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="password">
                  Password {mode === 'create' ? '*' : '(leave blank to keep current)'}
                </Label>
                <Input
                  id="password"
                  type="password"
                  value={formData.password}
                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                  required={mode === 'create'}
                />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Role & Department */}
        <Card>
          <CardHeader>
            <CardTitle>Role & Department</CardTitle>
            <CardDescription>
              Define the employee's role and department assignment
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="space-y-2">
                <Label htmlFor="employeeRole">Employee Role *</Label>
                <Select
                  value={formData.employeeRole}
                  onValueChange={handleRoleChange}
                >
                  <SelectTrigger id="employeeRole">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {Object.values(EMPLOYEE_ROLES).map((role) => (
                      <SelectItem key={role} value={role}>
                        {getRoleDisplayName(role)}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label htmlFor="department">Department</Label>
                <Select
                  value={formData.department}
                  onValueChange={(value) => setFormData({ ...formData, department: value })}
                >
                  <SelectTrigger id="department">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {Object.values(DEPARTMENTS).map((dept) => (
                      <SelectItem key={dept} value={dept}>
                        {getDepartmentDisplayName(dept)}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label htmlFor="status">Status</Label>
                <Select
                  value={formData.status}
                  onValueChange={(value) => setFormData({ ...formData, status: value })}
                >
                  <SelectTrigger id="status">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="active">Active</SelectItem>
                    <SelectItem value="on_leave">On Leave</SelectItem>
                    <SelectItem value="inactive">Inactive</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Work Details */}
        <Card>
          <CardHeader>
            <CardTitle>Work Details</CardTitle>
            <CardDescription>
              Weekly capacity and skill set
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="weeklyCapacity">Weekly Capacity (hours)</Label>
              <Input
                id="weeklyCapacity"
                type="number"
                min="0"
                max="168"
                value={formData.weeklyCapacity}
                onChange={(e) =>
                  setFormData({ ...formData, weeklyCapacity: parseFloat(e.target.value) })
                }
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="skillSet">Skills</Label>
              <div className="flex gap-2">
                <Input
                  id="skillSet"
                  value={skillInput}
                  onChange={(e) => setSkillInput(e.target.value)}
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      addSkill();
                    }
                  }}
                  placeholder="e.g., Web Development, SEO, Design"
                />
                <Button type="button" onClick={addSkill}>
                  Add
                </Button>
              </div>
              <div className="flex flex-wrap gap-2 mt-2">
                {formData.skillSet.map((skill) => (
                  <Badge key={skill} variant="secondary" className="gap-1">
                    {skill}
                    <button
                      type="button"
                      onClick={() => removeSkill(skill)}
                      className="ml-1 hover:text-destructive"
                    >
                      Ã—
                    </button>
                  </Badge>
                ))}
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Capabilities Matrix */}
        <Card>
          <CardHeader>
            <div className="flex items-center gap-2">
              <Shield className="h-5 w-5" />
              <CardTitle>Capabilities Matrix</CardTitle>
            </div>
            <CardDescription>
              Define specific permissions and access rights for this employee
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-6">
              {/* AI & Automation */}
              <div>
                <h4 className="font-semibold mb-3">AI & Automation</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canApproveSequences" className="cursor-pointer">
                      Approve Sequences
                    </Label>
                    <Switch
                      id="canApproveSequences"
                      checked={formData.capabilities.canApproveSequences}
                      onCheckedChange={() => handleCapabilityToggle('canApproveSequences')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canCreateSequences" className="cursor-pointer">
                      Create Sequences
                    </Label>
                    <Switch
                      id="canCreateSequences"
                      checked={formData.capabilities.canCreateSequences}
                      onCheckedChange={() => handleCapabilityToggle('canCreateSequences')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canViewAIRecommendations" className="cursor-pointer">
                      View AI Recommendations
                    </Label>
                    <Switch
                      id="canViewAIRecommendations"
                      checked={formData.capabilities.canViewAIRecommendations}
                      onCheckedChange={() => handleCapabilityToggle('canViewAIRecommendations')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canApproveAIRecommendations" className="cursor-pointer">
                      Approve AI Recommendations
                    </Label>
                    <Switch
                      id="canApproveAIRecommendations"
                      checked={formData.capabilities.canApproveAIRecommendations}
                      onCheckedChange={() => handleCapabilityToggle('canApproveAIRecommendations')}
                    />
                  </div>
                </div>
              </div>

              {/* Project Management */}
              <div>
                <h4 className="font-semibold mb-3">Project Management</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canViewAllProjects" className="cursor-pointer">
                      View All Projects
                    </Label>
                    <Switch
                      id="canViewAllProjects"
                      checked={formData.capabilities.canViewAllProjects}
                      onCheckedChange={() => handleCapabilityToggle('canViewAllProjects')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canViewAssignedProjects" className="cursor-pointer">
                      View Assigned Projects
                    </Label>
                    <Switch
                      id="canViewAssignedProjects"
                      checked={formData.capabilities.canViewAssignedProjects}
                      onCheckedChange={() => handleCapabilityToggle('canViewAssignedProjects')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canEditProjects" className="cursor-pointer">
                      Edit Projects
                    </Label>
                    <Switch
                      id="canEditProjects"
                      checked={formData.capabilities.canEditProjects}
                      onCheckedChange={() => handleCapabilityToggle('canEditProjects')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canAssignProjects" className="cursor-pointer">
                      Assign Projects
                    </Label>
                    <Switch
                      id="canAssignProjects"
                      checked={formData.capabilities.canAssignProjects}
                      onCheckedChange={() => handleCapabilityToggle('canAssignProjects')}
                    />
                  </div>
                </div>
              </div>

              {/* Client Communication */}
              <div>
                <h4 className="font-semibold mb-3">Client Communication</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canMessageClients" className="cursor-pointer">
                      Message Clients
                    </Label>
                    <Switch
                      id="canMessageClients"
                      checked={formData.capabilities.canMessageClients}
                      onCheckedChange={() => handleCapabilityToggle('canMessageClients')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canViewClientMessages" className="cursor-pointer">
                      View Client Messages
                    </Label>
                    <Switch
                      id="canViewClientMessages"
                      checked={formData.capabilities.canViewClientMessages}
                      onCheckedChange={() => handleCapabilityToggle('canViewClientMessages')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canSendClientEmails" className="cursor-pointer">
                      Send Client Emails
                    </Label>
                    <Switch
                      id="canSendClientEmails"
                      checked={formData.capabilities.canSendClientEmails}
                      onCheckedChange={() => handleCapabilityToggle('canSendClientEmails')}
                    />
                  </div>
                </div>
              </div>

              {/* File Management */}
              <div>
                <h4 className="font-semibold mb-3">File Management</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canUploadFiles" className="cursor-pointer">
                      Upload Files
                    </Label>
                    <Switch
                      id="canUploadFiles"
                      checked={formData.capabilities.canUploadFiles}
                      onCheckedChange={() => handleCapabilityToggle('canUploadFiles')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canViewClientFiles" className="cursor-pointer">
                      View Client Files
                    </Label>
                    <Switch
                      id="canViewClientFiles"
                      checked={formData.capabilities.canViewClientFiles}
                      onCheckedChange={() => handleCapabilityToggle('canViewClientFiles')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canEditClientFiles" className="cursor-pointer">
                      Edit Client Files
                    </Label>
                    <Switch
                      id="canEditClientFiles"
                      checked={formData.capabilities.canEditClientFiles}
                      onCheckedChange={() => handleCapabilityToggle('canEditClientFiles')}
                    />
                  </div>
                </div>
              </div>

              {/* Analytics & Reports */}
              <div>
                <h4 className="font-semibold mb-3">Analytics & Reports</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canViewAnalytics" className="cursor-pointer">
                      View Analytics
                    </Label>
                    <Switch
                      id="canViewAnalytics"
                      checked={formData.capabilities.canViewAnalytics}
                      onCheckedChange={() => handleCapabilityToggle('canViewAnalytics')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canViewFinancials" className="cursor-pointer">
                      View Financials
                    </Label>
                    <Switch
                      id="canViewFinancials"
                      checked={formData.capabilities.canViewFinancials}
                      onCheckedChange={() => handleCapabilityToggle('canViewFinancials')}
                    />
                  </div>
                  <div className="flex items-center justify-between p-3 border rounded-lg">
                    <Label htmlFor="canExportReports" className="cursor-pointer">
                      Export Reports
                    </Label>
                    <Switch
                      id="canExportReports"
                      checked={formData.capabilities.canExportReports}
                      onCheckedChange={() => handleCapabilityToggle('canExportReports')}
                    />
                  </div>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Submit Button */}
        <div className="flex justify-end gap-4">
          <Link href="/admin/employees">
            <Button type="button" variant="outline">
              Cancel
            </Button>
          </Link>
          <Button type="submit" disabled={submitting} className="gap-2">
            {submitting ? (
              <>
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                Saving...
              </>
            ) : (
              <>
                <Save className="h-4 w-4" />
                {mode === 'create' ? 'Create Employee' : 'Save Changes'}
              </>
            )}
          </Button>
        </div>
      </form>
    </div>
  );
}

// ==========================================
// File: app/admin/employees/employees-client.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { Plus, Edit, Trash2, UserCircle, Mail, Phone, Briefcase } from 'lucide-react';
import { getRoleDisplayName, getDepartmentDisplayName } from '@/lib/roles';
import { toast } from 'sonner';

interface Employee {
  id: string;
  employeeRole: string;
  department: string | null;
  status: string;
  weeklyCapacity: number;
  skillSet: string[];
  projectsCompleted: number;
  avgProjectRating: number | null;
  hireDate: string;
  user: {
    id: string;
    email: string;
    name: string | null;
    phone: string | null;
    image: string | null;
    createdAt: string;
    lastLoginAt: string | null;
  };
  capabilities: any;
}

export default function EmployeesClient() {
  const router = useRouter();
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [loading, setLoading] = useState(true);
  const [deleteId, setDeleteId] = useState<string | null>(null);
  const [deleting, setDeleting] = useState(false);

  useEffect(() => {
    fetchEmployees();
  }, []);

  const fetchEmployees = async () => {
    try {
      setLoading(true);
      const response = await fetch('/api/admin/employees');
      
      if (!response.ok) {
        throw new Error('Failed to fetch employees');
      }

      const data = await response.json();
      setEmployees(data);
    } catch (error) {
      console.error('Error fetching employees:', error);
      toast.error('Failed to load employees');
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async () => {
    if (!deleteId) return;

    try {
      setDeleting(true);
      const response = await fetch(`/api/admin/employees/${deleteId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Failed to delete employee');
      }

      toast.success('Employee deleted successfully');
      setDeleteId(null);
      fetchEmployees();
    } catch (error) {
      console.error('Error deleting employee:', error);
      toast.error('Failed to delete employee');
    } finally {
      setDeleting(false);
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'active':
        return 'bg-green-500/10 text-green-700 hover:bg-green-500/20';
      case 'on_leave':
        return 'bg-yellow-500/10 text-yellow-700 hover:bg-yellow-500/20';
      case 'inactive':
        return 'bg-gray-500/10 text-gray-700 hover:bg-gray-500/20';
      default:
        return 'bg-gray-500/10 text-gray-700 hover:bg-gray-500/20';
    }
  };

  if (loading) {
    return (
      <div className="container mx-auto py-8 px-4">
        <div className="flex items-center justify-center min-h-[400px]">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
            <p className="text-muted-foreground">Loading employees...</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto py-8 px-4 max-w-7xl">
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-3xl font-bold">Employee Management</h1>
          <p className="text-muted-foreground mt-2">
            Manage your team members, roles, and permissions
          </p>
        </div>
        <Link href="/admin/employees/new">
          <Button size="lg" className="gap-2">
            <Plus className="h-5 w-5" />
            Add Employee
          </Button>
        </Link>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Team Members</CardTitle>
          <CardDescription>
            {employees.length} {employees.length === 1 ? 'employee' : 'employees'} in your organization
          </CardDescription>
        </CardHeader>
        <CardContent>
          {employees.length === 0 ? (
            <div className="text-center py-12">
              <UserCircle className="h-16 w-16 text-muted-foreground mx-auto mb-4" />
              <h3 className="text-lg font-semibold mb-2">No employees yet</h3>
              <p className="text-muted-foreground mb-6">
                Get started by adding your first team member
              </p>
              <Link href="/admin/employees/new">
                <Button>
                  <Plus className="h-4 w-4 mr-2" />
                  Add Employee
                </Button>
              </Link>
            </div>
          ) : (
            <div className="overflow-x-auto">
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Name</TableHead>
                    <TableHead>Role</TableHead>
                    <TableHead>Department</TableHead>
                    <TableHead>Status</TableHead>
                    <TableHead>Projects</TableHead>
                    <TableHead className="text-right">Actions</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {employees.map((employee) => (
                    <TableRow key={employee.id}>
                      <TableCell>
                        <div>
                          <div className="font-medium">{employee.user.name}</div>
                          <div className="text-sm text-muted-foreground flex items-center gap-1 mt-1">
                            <Mail className="h-3 w-3" />
                            {employee.user.email}
                          </div>
                          {employee.user.phone && (
                            <div className="text-sm text-muted-foreground flex items-center gap-1">
                              <Phone className="h-3 w-3" />
                              {employee.user.phone}
                            </div>
                          )}
                        </div>
                      </TableCell>
                      <TableCell>
                        <div className="flex items-center gap-2">
                          <Briefcase className="h-4 w-4 text-muted-foreground" />
                          {getRoleDisplayName(employee.employeeRole)}
                        </div>
                      </TableCell>
                      <TableCell>
                        {employee.department ? getDepartmentDisplayName(employee.department) : '-'}
                      </TableCell>
                      <TableCell>
                        <Badge variant="secondary" className={getStatusColor(employee.status)}>
                          {employee.status.replace('_', ' ')}
                        </Badge>
                      </TableCell>
                      <TableCell>
                        <div className="text-sm">
                          <div className="font-medium">{employee.projectsCompleted} completed</div>
                          {employee.avgProjectRating && (
                            <div className="text-muted-foreground">
                              â­ {employee.avgProjectRating.toFixed(1)} rating
                            </div>
                          )}
                        </div>
                      </TableCell>
                      <TableCell className="text-right">
                        <div className="flex items-center justify-end gap-2">
                          <Link href={`/admin/employees/${employee.id}`}>
                            <Button variant="ghost" size="sm">
                              <Edit className="h-4 w-4" />
                            </Button>
                          </Link>
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => setDeleteId(employee.id)}
                            className="text-destructive hover:text-destructive"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </div>
          )}
        </CardContent>
      </Card>

      <AlertDialog open={!!deleteId} onOpenChange={(open) => !open && setDeleteId(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete Employee</AlertDialogTitle>
            <AlertDialogDescription>
              Are you sure you want to delete this employee? This action cannot be undone and will
              remove their account and all associated data.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={deleting}>Cancel</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              disabled={deleting}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              {deleting ? 'Deleting...' : 'Delete'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}

// ==========================================
// File: app/admin/employees/new/page.tsx
// ==========================================


import { redirect } from 'next/navigation';
import { requireAdmin } from '@/lib/auth-helpers';
import EmployeeForm from '../employee-form';

export const metadata = {
  title: 'Add New Employee | CDM Suite Admin',
  description: 'Create a new employee account',
};

export default async function NewEmployeePage() {
  try {
    await requireAdmin();
  } catch (error) {
    redirect('/dashboard');
  }

  return <EmployeeForm mode="create" />;
}

// ==========================================
// File: app/admin/employees/page.tsx
// ==========================================


import { redirect } from 'next/navigation';
import { requireAdmin } from '@/lib/auth-helpers';
import EmployeesClient from './employees-client';

export const metadata = {
  title: 'Employee Management | CDM Suite Admin',
  description: 'Manage employees, roles, and permissions',
};

export default async function EmployeesPage() {
  try {
    await requireAdmin();
  } catch (error) {
    redirect('/dashboard');
  }

  return <EmployeesClient />;
}

// ==========================================
// File: app/admin/employees/[id]/page.tsx
// ==========================================


import { redirect } from 'next/navigation';
import { requireAdmin } from '@/lib/auth-helpers';
import EmployeeForm from '../employee-form';

export const metadata = {
  title: 'Edit Employee | CDM Suite Admin',
  description: 'Update employee information and permissions',
};

interface EditEmployeePageProps {
  params: {
    id: string;
  };
}

export default async function EditEmployeePage({ params }: EditEmployeePageProps) {
  try {
    await requireAdmin();
  } catch (error) {
    redirect('/dashboard');
  }

  return <EmployeeForm mode="edit" employeeId={params.id} />;
}

// ==========================================
// File: app/admin/page.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Switch } from '@/components/ui/switch';
import { toast } from 'react-hot-toast';
import { 
  Loader2, 
  Plus, 
  Edit, 
  Trash2, 
  Users, 
  Briefcase, 
  Settings,
  BarChart3,
  ArrowRight 
} from 'lucide-react';

interface Service {
  id: string;
  slug: string;
  name: string;
  description: string;
  price: number;
  features: string[];
  popular: boolean;
  active: boolean;
  sortOrder: number;
}

export default function AdminPage() {
  const [services, setServices] = useState<Service[]>([]);
  const [loading, setLoading] = useState(true);
  const [editingService, setEditingService] = useState<Service | null>(null);
  const [featuresText, setFeaturesText] = useState('');

  useEffect(() => {
    fetchServices();
  }, []);

  const fetchServices = async () => {
    try {
      const res = await fetch('/api/services');
      const data = await res.json();
      setServices(data);
    } catch (error) {
      toast.error('Failed to fetch services');
    } finally {
      setLoading(false);
    }
  };

  const handleEdit = (service: Service) => {
    setEditingService(service);
    setFeaturesText(service.features.join('\n'));
  };

  const handleSave = async () => {
    if (!editingService) return;

    try {
      const features = featuresText.split('\n').filter(f => f.trim());
      
      const res = await fetch(`/api/services/${editingService.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...editingService,
          features,
        }),
      });

      if (!res.ok) throw new Error('Failed to update service');

      toast.success('Service updated successfully!');
      setEditingService(null);
      fetchServices();
    } catch (error) {
      toast.error('Failed to update service');
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900 py-12">
      <div className="container mx-auto px-4 max-w-7xl">
        {/* Admin Dashboard Header */}
        <div className="mb-12">
          <h1 className="text-4xl font-bold mb-3">Admin Dashboard</h1>
          <p className="text-muted-foreground">
            Manage your team, services, and platform configuration
          </p>
        </div>

        {/* Quick Access Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
          <Link href="/admin/employees">
            <Card className="cursor-pointer hover:shadow-lg transition-shadow">
              <CardHeader>
                <div className="flex items-center justify-between">
                  <Users className="h-8 w-8 text-primary" />
                  <ArrowRight className="h-5 w-5 text-muted-foreground" />
                </div>
                <CardTitle className="mt-4">Employees</CardTitle>
                <CardDescription>
                  Manage team members, roles & permissions
                </CardDescription>
              </CardHeader>
            </Card>
          </Link>

          <Card className="opacity-50">
            <CardHeader>
              <div className="flex items-center justify-between">
                <Briefcase className="h-8 w-8 text-muted-foreground" />
              </div>
              <CardTitle className="mt-4">Projects</CardTitle>
              <CardDescription>
                Coming soon: Project management
              </CardDescription>
            </CardHeader>
          </Card>

          <Card className="opacity-50">
            <CardHeader>
              <div className="flex items-center justify-between">
                <BarChart3 className="h-8 w-8 text-muted-foreground" />
              </div>
              <CardTitle className="mt-4">Analytics</CardTitle>
              <CardDescription>
                Coming soon: Team & project analytics
              </CardDescription>
            </CardHeader>
          </Card>

          <Link href="/admin/settings">
            <Card className="cursor-pointer hover:shadow-lg transition-shadow">
              <CardHeader>
                <div className="flex items-center justify-between">
                  <Settings className="h-8 w-8 text-primary" />
                  <ArrowRight className="h-5 w-5 text-muted-foreground" />
                </div>
                <CardTitle className="mt-4">Settings</CardTitle>
                <CardDescription>
                  Manage default contact info & global settings
                </CardDescription>
              </CardHeader>
            </Card>
          </Link>
        </div>

        {/* Services Management Section */}
        <div className="flex justify-between items-center mb-8">
          <h1 className="text-4xl font-bold">Service Management</h1>
        </div>

        {editingService ? (
          <Card>
            <CardHeader>
              <CardTitle>Edit Service: {editingService.name}</CardTitle>
            </CardHeader>
            <CardContent className="space-y-6">
              <div>
                <Label htmlFor="name">Service Name</Label>
                <Input
                  id="name"
                  value={editingService.name}
                  onChange={(e) =>
                    setEditingService({ ...editingService, name: e.target.value })
                  }
                />
              </div>

              <div>
                <Label htmlFor="description">Description</Label>
                <Input
                  id="description"
                  value={editingService.description}
                  onChange={(e) =>
                    setEditingService({ ...editingService, description: e.target.value })
                  }
                />
              </div>

              <div>
                <Label htmlFor="price">Price (USD)</Label>
                <Input
                  id="price"
                  type="number"
                  value={editingService.price}
                  onChange={(e) =>
                    setEditingService({
                      ...editingService,
                      price: parseFloat(e.target.value),
                    })
                  }
                />
              </div>

              <div>
                <Label htmlFor="features">Features (one per line)</Label>
                <Textarea
                  id="features"
                  value={featuresText}
                  onChange={(e) => setFeaturesText(e.target.value)}
                  rows={10}
                  placeholder="Enter each feature on a new line"
                />
              </div>

              <div className="flex items-center space-x-2">
                <Switch
                  id="popular"
                  checked={editingService.popular}
                  onCheckedChange={(checked) =>
                    setEditingService({ ...editingService, popular: checked })
                  }
                />
                <Label htmlFor="popular">Mark as Popular</Label>
              </div>

              <div className="flex items-center space-x-2">
                <Switch
                  id="active"
                  checked={editingService.active}
                  onCheckedChange={(checked) =>
                    setEditingService({ ...editingService, active: checked })
                  }
                />
                <Label htmlFor="active">Active</Label>
              </div>

              <div className="flex gap-4">
                <Button onClick={handleSave}>Save Changes</Button>
                <Button variant="outline" onClick={() => setEditingService(null)}>
                  Cancel
                </Button>
              </div>
            </CardContent>
          </Card>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {services.map((service) => (
              <Card key={service.id} className="relative">
                <CardHeader>
                  <CardTitle className="flex items-center justify-between">
                    <span className="truncate">{service.name}</span>
                    {service.popular && (
                      <span className="text-xs bg-blue-600 text-white px-2 py-1 rounded">
                        Popular
                      </span>
                    )}
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <p className="text-gray-600 dark:text-gray-400 text-sm">
                    {service.description}
                  </p>
                  <div className="text-3xl font-bold text-blue-600">
                    ${service.price.toLocaleString()}
                  </div>
                  <div className="text-sm text-gray-500">
                    {service.features.length} features
                  </div>
                  <div className="flex gap-2">
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => handleEdit(service)}
                      className="flex-1"
                    >
                      <Edit className="w-4 h-4 mr-2" />
                      Edit
                    </Button>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

// ==========================================
// File: app/admin/reddit-test/page.tsx
// ==========================================


"use client";

import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Loader2, CheckCircle2, AlertCircle, Send } from "lucide-react";
import { trackRedditEvent } from "@/lib/reddit-tracking";

const TEST_ID = "t2_20lcxjcqah";

const EVENT_TYPES = [
  { value: "SignUp", label: "SignUp" },
  { value: "Lead", label: "Lead" },
  { value: "Purchase", label: "Purchase" },
  { value: "AddToCart", label: "AddToCart" },
  { value: "ViewContent", label: "ViewContent" },
  { value: "custom", label: "Custom Event" },
];

export default function RedditTestPage() {
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState<any>(null);
  const [error, setError] = useState<string>("");

  const [eventType, setEventType] = useState("SignUp");
  const [customEventName, setCustomEventName] = useState("");
  const [email, setEmail] = useState("test@example.com");
  const [value, setValue] = useState("99.00");
  const [currency, setCurrency] = useState("USD");
  const [testId, setTestId] = useState(TEST_ID);

  const handleSendTestEvent = async () => {
    setLoading(true);
    setResult(null);
    setError("");

    try {
      const options: any = {
        email,
        testId: testId || undefined,
      };

      if (eventType === "custom" && customEventName) {
        options.customEventName = customEventName;
      }

      if (eventType === "Purchase" || eventType === "AddToCart") {
        options.value = parseFloat(value);
        options.currency = currency;
      }

      // Send the event
      const conversionId = await trackRedditEvent(eventType, options);

      setResult({
        success: true,
        conversionId,
        message: "Test event sent successfully!",
        details: {
          eventType,
          testId: testId || "None (Production Mode)",
          email,
          conversionId,
        },
      });
    } catch (err: any) {
      console.error("Error sending test event:", err);
      setError(err.message || "Failed to send test event");
    } finally {
      setLoading(false);
    }
  };

  const handleSendDirectAPITest = async () => {
    setLoading(true);
    setResult(null);
    setError("");

    try {
      const response = await fetch("/api/analytics/reddit-conversion", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          eventType,
          customEventName: eventType === "custom" ? customEventName : undefined,
          testId: testId || undefined,
          eventMetadata: {
            conversionId: `test-${Date.now()}-${eventType}`,
            email,
            value: eventType === "Purchase" ? parseFloat(value) : undefined,
            currency: eventType === "Purchase" ? currency : undefined,
          },
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        // Show detailed error information
        const errorDetails = data.details ? `\n\nDetails: ${data.details}` : '';
        throw new Error(data.error + errorDetails || "Failed to send test event");
      }

      setResult({
        success: true,
        message: "Test event sent via direct API call!",
        details: data,
      });
    } catch (err: any) {
      console.error("Error sending test event:", err);
      setError(err.message || "Failed to send test event");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-charcoal via-charcoal/95 to-charcoal p-8">
      <div className="max-w-4xl mx-auto">
        <div className="mb-8">
          <h1 className="text-4xl font-bold text-white mb-2">
            Reddit Conversions API Tester
          </h1>
          <p className="text-white/70">
            Send test events to verify your Reddit Pixel and Conversions API integration
          </p>
        </div>

        <Card className="bg-white/5 border-white/10 backdrop-blur-sm mb-6">
          <CardHeader>
            <CardTitle className="text-white">Test Configuration</CardTitle>
            <CardDescription className="text-white/70">
              Configure and send test events with the test_id parameter
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6">
            {/* Test ID */}
            <div className="space-y-2">
              <Label htmlFor="testId" className="text-white">
                Test ID (Reddit provided)
              </Label>
              <Input
                id="testId"
                value={testId}
                onChange={(e) => setTestId(e.target.value)}
                placeholder="t2_20lcxjcqah"
                className="bg-white/10 border-white/20 text-white"
              />
              <p className="text-xs text-white/50">
                Leave this as is to use the provided test ID. Events with test_id will appear in
                Reddit&apos;s test events panel.
              </p>
            </div>

            {/* Event Type */}
            <div className="space-y-2">
              <Label htmlFor="eventType" className="text-white">
                Event Type
              </Label>
              <Select value={eventType} onValueChange={setEventType}>
                <SelectTrigger className="bg-white/10 border-white/20 text-white">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {EVENT_TYPES.map((type) => (
                    <SelectItem key={type.value} value={type.value}>
                      {type.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Custom Event Name */}
            {eventType === "custom" && (
              <div className="space-y-2">
                <Label htmlFor="customEventName" className="text-white">
                  Custom Event Name
                </Label>
                <Input
                  id="customEventName"
                  value={customEventName}
                  onChange={(e) => setCustomEventName(e.target.value)}
                  placeholder="MyCustomEvent"
                  className="bg-white/10 border-white/20 text-white"
                />
              </div>
            )}

            {/* Email */}
            <div className="space-y-2">
              <Label htmlFor="email" className="text-white">
                Email (Match Key)
              </Label>
              <Input
                id="email"
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="test@example.com"
                className="bg-white/10 border-white/20 text-white"
              />
            </div>

            {/* Value and Currency */}
            {(eventType === "Purchase" || eventType === "AddToCart") && (
              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="value" className="text-white">
                    Value
                  </Label>
                  <Input
                    id="value"
                    type="number"
                    step="0.01"
                    value={value}
                    onChange={(e) => setValue(e.target.value)}
                    placeholder="99.00"
                    className="bg-white/10 border-white/20 text-white"
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="currency" className="text-white">
                    Currency
                  </Label>
                  <Input
                    id="currency"
                    value={currency}
                    onChange={(e) => setCurrency(e.target.value.toUpperCase())}
                    placeholder="USD"
                    maxLength={3}
                    className="bg-white/10 border-white/20 text-white"
                  />
                </div>
              </div>
            )}

            {/* Action Buttons */}
            <div className="flex gap-4 pt-4">
              <Button
                onClick={handleSendTestEvent}
                disabled={loading}
                className="flex-1 bg-gradient-to-r from-accent to-secondary hover:from-accent/90 hover:to-secondary/90 text-charcoal"
              >
                {loading ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Sending...
                  </>
                ) : (
                  <>
                    <Send className="w-4 h-4 mr-2" />
                    Send Test Event (Full Flow)
                  </>
                )}
              </Button>

              <Button
                onClick={handleSendDirectAPITest}
                disabled={loading}
                variant="outline"
                className="flex-1 border-white/20 text-white hover:bg-white/10"
              >
                {loading ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Sending...
                  </>
                ) : (
                  <>
                    <Send className="w-4 h-4 mr-2" />
                    Send Test Event (API Only)
                  </>
                )}
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Result Display */}
        {result && (
          <Alert className="bg-green-500/10 border-green-500/50 mb-6">
            <CheckCircle2 className="h-4 w-4 text-green-500" />
            <AlertDescription className="text-white">
              <div className="space-y-2">
                <p className="font-semibold">{result.message}</p>
                {result.details && (
                  <pre className="bg-white/5 p-3 rounded text-xs overflow-auto">
                    {JSON.stringify(result.details, null, 2)}
                  </pre>
                )}
              </div>
            </AlertDescription>
          </Alert>
        )}

        {/* Error Display */}
        {error && (
          <Alert className="bg-red-500/10 border-red-500/50 mb-6">
            <AlertCircle className="h-4 w-4 text-red-500" />
            <AlertDescription className="text-white">
              <p className="font-semibold">Error sending test event</p>
              <p className="text-sm">{error}</p>
            </AlertDescription>
          </Alert>
        )}

        {/* Instructions */}
        <Card className="bg-white/5 border-white/10 backdrop-blur-sm">
          <CardHeader>
            <CardTitle className="text-white">Testing Instructions</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4 text-white/70">
            <div>
              <h3 className="font-semibold text-white mb-2">How to Test:</h3>
              <ol className="list-decimal list-inside space-y-2 text-sm">
                <li>Keep the Test ID field as provided: <code className="bg-white/10 px-2 py-0.5 rounded">t2_20lcxjcqah</code></li>
                <li>Select an event type (SignUp, Lead, Purchase, etc.)</li>
                <li>Fill in test data (email, value, etc.)</li>
                <li><strong>Full Flow:</strong> Sends via BOTH client-side Pixel + server-side API (deduplication works)</li>
                <li><strong>API Only:</strong> Sends ONLY via server-side API (no client-side pixel, tests server tracking)</li>
                <li>Check Reddit Ads Manager &gt; Pixels &gt; Test Events panel</li>
                <li>If the event appears, your integration is working correctly!</li>
              </ol>
            </div>

            <div>
              <h3 className="font-semibold text-white mb-2">What Gets Sent:</h3>
              <ul className="list-disc list-inside space-y-1 text-sm">
                <li><strong>test_id:</strong> {testId}</li>
                <li><strong>conversion_id:</strong> Unique ID for deduplication</li>
                <li><strong>event_type:</strong> Selected event type</li>
                <li><strong>user data:</strong> Email, IP address, User Agent</li>
                <li><strong>metadata:</strong> Value, currency (for Purchase events)</li>
              </ul>
            </div>

            <div>
              <h3 className="font-semibold text-white mb-2">Production vs Test Mode:</h3>
              <ul className="list-disc list-inside space-y-1 text-sm">
                <li><strong>With test_id:</strong> Events appear in Test Events panel (not counted)</li>
                <li><strong>Without test_id:</strong> Events are sent to production and counted</li>
                <li>Remove or clear test_id to send production events</li>
              </ul>
            </div>

            <div className="pt-4 border-t border-white/10">
              <p className="text-xs">
                <strong>Note:</strong> Test events may take 1-2 minutes to appear in Reddit&apos;s dashboard.
                If events don&apos;t appear, check the browser console and server logs for errors.
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

// ==========================================
// File: app/admin/settings/page.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'react-hot-toast';
import { Loader2, Save, RotateCcw, Mail, Phone, FileText } from 'lucide-react';
import Link from 'next/link';

interface SettingConfig {
  key: string;
  label: string;
  description: string;
  defaultValue: string;
  icon: any;
  multiline?: boolean;
}

const SETTING_CONFIGS: SettingConfig[] = [
  {
    key: 'default_contact_email',
    label: 'Default Contact Email',
    description: 'Email address used in all bid proposals and contracts',
    defaultValue: 'contracts@cdmsuite.com',
    icon: Mail,
  },
  {
    key: 'default_contact_phone',
    label: 'Default Contact Phone',
    description: 'Phone number used in all bid proposals and contracts',
    defaultValue: '(862) 272-7623',
    icon: Phone,
  },
  {
    key: 'default_signees',
    label: 'Authorized Signees',
    description: 'Comma-separated list of authorized signees for contracts (e.g., "Fray, Everoy")',
    defaultValue: 'Fray, Everoy',
    icon: FileText,
    multiline: false,
  },
];

export default function AdminSettingsPage() {
  const [settings, setSettings] = useState<Record<string, string>>({});
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [hasChanges, setHasChanges] = useState(false);

  useEffect(() => {
    fetchSettings();
  }, []);

  const fetchSettings = async () => {
    try {
      const res = await fetch('/api/admin/settings');
      const data = await res.json();
      
      if (res.ok) {
        // Extract just the values from the settings map
        const settingsValues: Record<string, string> = {};
        Object.keys(data.settings).forEach((key) => {
          settingsValues[key] = data.settings[key].value;
        });
        setSettings(settingsValues);
      } else {
        toast.error(data.error || 'Failed to fetch settings');
      }
    } catch (error) {
      console.error('[Admin Settings] Fetch error:', error);
      toast.error('Failed to fetch settings');
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (key: string, value: string) => {
    setSettings((prev) => ({ ...prev, [key]: value }));
    setHasChanges(true);
  };

  const handleSave = async () => {
    setSaving(true);
    try {
      // Prepare bulk update payload
      const settingsArray = SETTING_CONFIGS.map((config) => ({
        settingKey: config.key,
        settingValue: settings[config.key] || config.defaultValue,
        description: config.description,
      }));

      const res = await fetch('/api/admin/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ settings: settingsArray }),
      });

      const data = await res.json();

      if (res.ok) {
        toast.success('Settings saved successfully!');
        setHasChanges(false);
        fetchSettings(); // Refresh to get latest values
      } else {
        toast.error(data.error || 'Failed to save settings');
      }
    } catch (error) {
      console.error('[Admin Settings] Save error:', error);
      toast.error('Failed to save settings');
    } finally {
      setSaving(false);
    }
  };

  const handleReset = () => {
    // Reset to default values
    const defaultSettings: Record<string, string> = {};
    SETTING_CONFIGS.forEach((config) => {
      defaultSettings[config.key] = config.defaultValue;
    });
    setSettings(defaultSettings);
    setHasChanges(true);
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900 py-12">
      <div className="container mx-auto px-4 max-w-4xl">
        {/* Header */}
        <div className="mb-8">
          <div className="flex items-center gap-3 mb-3">
            <Link href="/admin" className="text-muted-foreground hover:text-foreground">
              Admin
            </Link>
            <span className="text-muted-foreground">/</span>
            <span>Settings</span>
          </div>
          <h1 className="text-4xl font-bold mb-3">System Settings</h1>
          <p className="text-muted-foreground">
            Manage default contact information and global configuration used across all bid proposals
          </p>
        </div>

        {/* Info Banner */}
        <Card className="mb-8 border-blue-200 bg-blue-50 dark:bg-blue-950 dark:border-blue-800">
          <CardContent className="pt-6">
            <p className="text-sm text-blue-900 dark:text-blue-100">
              <strong>Note:</strong> Changes to these settings will apply to all <strong>new</strong> bid proposals generated after saving. 
              Existing proposals will retain their original values.
            </p>
          </CardContent>
        </Card>

        {/* Settings Form */}
        <Card>
          <CardHeader>
            <CardTitle>Default Contact Information</CardTitle>
            <CardDescription>
              This information will be automatically included in all generated bid proposals and contracts
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6">
            {SETTING_CONFIGS.map((config) => {
              const Icon = config.icon;
              return (
                <div key={config.key} className="space-y-2">
                  <Label htmlFor={config.key} className="flex items-center gap-2">
                    <Icon className="h-4 w-4 text-muted-foreground" />
                    {config.label}
                  </Label>
                  {config.multiline ? (
                    <Textarea
                      id={config.key}
                      value={settings[config.key] || config.defaultValue}
                      onChange={(e) => handleChange(config.key, e.target.value)}
                      placeholder={config.description}
                      rows={2}
                    />
                  ) : (
                    <Input
                      id={config.key}
                      value={settings[config.key] || config.defaultValue}
                      onChange={(e) => handleChange(config.key, e.target.value)}
                      placeholder={config.description}
                    />
                  )}
                  <p className="text-xs text-muted-foreground">{config.description}</p>
                </div>
              );
            })}

            {/* Action Buttons */}
            <div className="flex gap-4 pt-4 border-t">
              <Button
                onClick={handleSave}
                disabled={!hasChanges || saving}
                className="flex-1"
              >
                {saving ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    Saving...
                  </>
                ) : (
                  <>
                    <Save className="w-4 h-4 mr-2" />
                    Save Changes
                  </>
                )}
              </Button>
              <Button
                variant="outline"
                onClick={handleReset}
                disabled={saving}
              >
                <RotateCcw className="w-4 h-4 mr-2" />
                Reset to Defaults
              </Button>
            </div>
          </CardContent>
        </Card>

        {/* Usage Instructions */}
        <Card className="mt-8">
          <CardHeader>
            <CardTitle>How It Works</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3 text-sm text-muted-foreground">
            <p>
              <strong>1. Update Default Values:</strong> Change the contact email, phone, and signees above.
            </p>
            <p>
              <strong>2. Save Changes:</strong> Click "Save Changes" to store the new defaults.
            </p>
            <p>
              <strong>3. Automatic Integration:</strong> All new bid proposals will automatically use these values in generated PDFs and slide decks.
            </p>
            <p>
              <strong>4. Manual Override:</strong> You can still manually edit individual proposals if needed.
            </p>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

// ==========================================
// File: app/auditor/page.tsx
// ==========================================


import { Metadata } from 'next';
import Navigation from '@/components/navigation';
import Footer from '@/components/footer';
import AuditorClient from '@/components/auditor/auditor-client';

export const metadata: Metadata = {
  title: 'Free Website Audit | CDM Suite - Get Your Marketing Score',
  description: 'Get a comprehensive free audit of your website. Analyze SEO, performance, mobile-friendliness, and security. Receive personalized recommendations to grow your business.',
  keywords: 'website audit, SEO audit, website analyzer, marketing audit, free website check',
};

export default function AuditorPage() {
  return (
    <main>
      <Navigation />
      <AuditorClient />
      <Footer />
    </main>
  );
}

// ==========================================
// File: app/auth/error/page.tsx
// ==========================================


"use client";

import { Suspense } from "react";
import { useSearchParams } from "next/navigation";
import Link from "next/link";
import { AlertCircle } from "lucide-react";
import { Button } from "@/components/ui/button";

function ErrorContent() {
  const searchParams = useSearchParams();
  const error = searchParams.get("error");

  const errorMessages: Record<string, string> = {
    Configuration: "There is a problem with the server configuration.",
    AccessDenied: "You do not have permission to sign in.",
    Verification: "The verification token has expired or has already been used.",
    Default: "An error occurred during authentication.",
  };

  const message = error ? errorMessages[error] || errorMessages.Default : errorMessages.Default;

  return (
    <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
      <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mb-4">
        <AlertCircle className="w-8 h-8 text-red-600" />
      </div>
      <h1 className="text-2xl font-bold text-gray-900 mb-2">
        Authentication Error
      </h1>
      <p className="text-gray-600 mb-6">{message}</p>
      <Button asChild className="w-full">
        <Link href="/auth/login">Back to Login</Link>
      </Button>
    </div>
  );
}

export default function AuthErrorPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-white to-purple-50 px-4">
      <div className="w-full max-w-md">
        <Suspense fallback={
          <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
            <p>Loading...</p>
          </div>
        }>
          <ErrorContent />
        </Suspense>
      </div>
    </div>
  );
}

// ==========================================
// File: app/auth/forgot-password/page.tsx
// ==========================================


"use client";

import { useState } from "react";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Mail, Loader2, CheckCircle2 } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState("");
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const { toast } = useToast();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!email) {
      toast({
        title: "Error",
        description: "Please enter your email address",
        variant: "destructive",
      });
      return;
    }

    setLoading(true);
    try {
      const response = await fetch("/api/auth/request-reset", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ email }),
      });

      const data = await response.json();

      if (response.ok) {
        setSuccess(true);
        toast({
          title: "Check your email",
          description: data.message,
        });
      } else {
        toast({
          title: "Error",
          description: data.error || "Failed to send reset link",
          variant: "destructive",
        });
      }
    } catch (error) {
      console.error("Password reset error:", error);
      toast({
        title: "Error",
        description: "Failed to send reset link. Please try again.",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-white to-purple-50 px-4 py-12">
      <div className="w-full max-w-md">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            Forgot Password?
          </h1>
          <p className="text-gray-600">
            Enter your email and we&apos;ll send you a password reset link
          </p>
        </div>
        
        <Card>
          <CardHeader>
            <CardTitle>Password Reset</CardTitle>
            <CardDescription>
              Enter the email associated with your account
            </CardDescription>
          </CardHeader>
          <CardContent>
            {success ? (
              <div className="text-center py-6">
                <CheckCircle2 className="w-16 h-16 text-green-600 mx-auto mb-4" />
                <h3 className="text-lg font-semibold mb-2">Check your email</h3>
                <p className="text-sm text-muted-foreground mb-4">
                  If an account exists with <strong>{email}</strong>, you will receive a password reset link shortly.
                </p>
                <p className="text-xs text-muted-foreground">
                  Didn&apos;t receive the email? Check your spam folder or try again.
                </p>
              </div>
            ) : (
              <form onSubmit={handleSubmit} className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="email">Email</Label>
                  <Input
                    id="email"
                    type="email"
                    placeholder="you@example.com"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    required
                    disabled={loading}
                  />
                </div>

                <Button type="submit" disabled={loading} className="w-full">
                  {loading ? (
                    <>
                      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                      Sending...
                    </>
                  ) : (
                    <>
                      <Mail className="mr-2 h-4 w-4" />
                      Send Reset Link
                    </>
                  )}
                </Button>
              </form>
            )}

            <div className="text-center pt-4 mt-4 border-t">
              <Link
                href="/auth/login"
                className="text-sm text-blue-600 hover:text-blue-500 font-medium"
              >
                â† Back to Login
              </Link>
            </div>

            <div className="text-center pt-4">
              <p className="text-sm text-gray-600">
                Need help? Contact us at{" "}
                <a
                  href="mailto:support@cdmsuite.com"
                  className="text-blue-600 hover:text-blue-500 font-medium"
                >
                  support@cdmsuite.com
                </a>
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

// ==========================================
// File: app/auth/login/page.tsx
// ==========================================



import { Metadata } from "next";
import Link from "next/link";
import Navigation from "@/components/navigation";
import { LoginForm } from "@/components/auth/login-form";
import { 
  CheckCircle2, 
  TrendingUp, 
  Users, 
  Zap, 
  Shield,
  BarChart3,
  Star,
  Sparkles,
  Gift,
  Target
} from "lucide-react";

export const metadata: Metadata = {
  title: "Login | CDM Suite",
  description: "Login to your CDM Suite account and access powerful marketing tools",
};

const benefits = [
  {
    icon: Gift,
    title: "Free Website Audit",
    description: "Get instant analysis of your site's performance and SEO",
    highlight: true
  },
  {
    icon: TrendingUp,
    title: "Track Your Growth",
    description: "Monitor your digital marketing performance in real-time"
  },
  {
    icon: BarChart3,
    title: "Actionable Insights",
    description: "Get data-driven recommendations to improve your results"
  },
  {
    icon: Zap,
    title: "Fast Support",
    description: "Access our team of experts whenever you need help"
  }
];

const testimonial = {
  quote: "CDM Suite transformed our online presence. Our traffic increased by 300% in just 3 months!",
  author: "Sarah Johnson",
  role: "CEO, TechStart Inc.",
  rating: 5
};

export default function LoginPage({
  searchParams,
}: {
  searchParams: { redirect?: string; audit?: string };
}) {
  const showAuditMessage = searchParams.redirect === 'auditor' || searchParams.audit === 'true';

  return (
    <>
      <Navigation />
      <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
        <div className="section-container py-12 lg:py-20">
          <div className="grid lg:grid-cols-2 gap-12 items-center max-w-6xl mx-auto">
            {/* Left Column - Benefits & Info */}
            <div className="space-y-8">
              <div>
                <h1 className="text-4xl lg:text-5xl font-bold text-gray-900 mb-4">
                  Welcome Back to
                  <span className="block mt-2 bg-gradient-to-r from-secondary to-accent bg-clip-text text-transparent">
                    CDM Suite
                  </span>
                </h1>
                <p className="text-lg text-gray-600 leading-relaxed">
                  Log in to access your dashboard and continue growing your digital presence. Your marketing success is just one click away.
                </p>
              </div>

              {/* Special Audit Message */}
              {showAuditMessage && (
                <div className="p-5 bg-gradient-to-r from-accent/20 to-secondary/20 rounded-2xl border-2 border-accent shadow-lg animate-in slide-in-from-top">
                  <div className="flex items-start gap-4">
                    <div className="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-accent to-secondary rounded-xl flex items-center justify-center">
                      <Sparkles className="w-6 h-6 text-white" />
                    </div>
                    <div>
                      <h3 className="font-bold text-lg text-gray-900 mb-2">
                        ðŸŽ‰ Log in to save your audit results!
                      </h3>
                      <p className="text-gray-700 mb-3">
                        Keep track of your website performance over time and access personalized recommendations in your dashboard.
                      </p>
                      <div className="flex items-center gap-2 text-sm text-gray-600">
                        <CheckCircle2 className="w-4 h-4 text-accent" />
                        <span>Free audit â€¢ Instant results â€¢ No credit card required</span>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Benefits Grid */}
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                {benefits.map((benefit, index) => {
                  const Icon = benefit.icon;
                  return (
                    <div 
                      key={index}
                      className={`flex gap-3 p-4 rounded-xl shadow-sm border transition-all ${
                        benefit.highlight
                          ? 'bg-gradient-to-r from-accent/10 to-secondary/10 border-accent hover:shadow-md'
                          : 'bg-white border-gray-100 hover:shadow-md'
                      }`}
                    >
                      <div className="flex-shrink-0">
                        <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                          benefit.highlight
                            ? 'bg-gradient-to-br from-accent to-secondary'
                            : 'bg-gradient-to-br from-secondary to-accent'
                        }`}>
                          <Icon className="w-5 h-5 text-white" />
                        </div>
                      </div>
                      <div>
                        <h3 className="font-semibold text-gray-900 mb-1">
                          {benefit.title}
                        </h3>
                        <p className="text-sm text-gray-600">
                          {benefit.description}
                        </p>
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Testimonial */}
              <div className="bg-gradient-to-r from-secondary/10 to-accent/10 rounded-2xl p-6 border border-secondary/20">
                <div className="flex gap-1 mb-3">
                  {[...Array(testimonial.rating)].map((_, i) => (
                    <Star key={i} className="w-5 h-5 fill-accent text-accent" />
                  ))}
                </div>
                <p className="text-gray-700 mb-4 italic">
                  "{testimonial.quote}"
                </p>
                <div>
                  <p className="font-semibold text-gray-900">{testimonial.author}</p>
                  <p className="text-sm text-gray-600">{testimonial.role}</p>
                </div>
              </div>

              {/* Trust Indicators */}
              <div className="flex flex-wrap gap-6 items-center text-sm text-gray-600">
                <div className="flex items-center gap-2">
                  <Users className="w-5 h-5 text-secondary" />
                  <span>500+ Happy Clients</span>
                </div>
                <div className="flex items-center gap-2">
                  <Shield className="w-5 h-5 text-accent" />
                  <span>Bank-Level Security</span>
                </div>
                <div className="flex items-center gap-2">
                  <Zap className="w-5 h-5 text-secondary" />
                  <span>24/7 Support</span>
                </div>
              </div>
            </div>

            {/* Right Column - Login Form */}
            <div>
              <div className="text-center mb-6">
                <h2 className="text-2xl font-bold text-gray-900 mb-2">
                  Login to Your Account
                </h2>
                <p className="text-gray-600">
                  Access your dashboard and grow your business
                </p>
              </div>
              <LoginForm />
              
              {/* Quick Access to Audit */}
              {!showAuditMessage && (
                <div className="mt-6 text-center p-5 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border-2 border-blue-200">
                  <div className="flex items-center justify-center gap-2 mb-3">
                    <Sparkles className="w-5 h-5 text-accent" />
                    <p className="font-semibold text-gray-900">
                      Want a Free Audit First?
                    </p>
                  </div>
                  <p className="text-sm text-gray-600 mb-3">
                    Get instant insights into your website's performance before signing in.
                  </p>
                  <Link 
                    href="/auditor"
                    className="inline-flex items-center justify-center px-5 py-2.5 bg-gradient-to-r from-accent to-secondary hover:from-accent/90 hover:to-secondary/90 text-charcoal font-semibold rounded-lg shadow-md hover:shadow-lg transition-all"
                  >
                    <Target className="w-4 h-4 mr-2" />
                    Get Your Free Audit
                  </Link>
                </div>
              )}
              
              {/* Additional CTA */}
              <div className="mt-6 text-center p-4 bg-blue-50 rounded-xl border border-blue-100">
                <p className="text-sm text-gray-700 mb-2">
                  New to CDM Suite? Start your journey today!
                </p>
                <Link 
                  href="/auth/signup"
                  className="text-secondary hover:text-accent font-semibold text-sm transition-colors"
                >
                  Create a free account â†’
                </Link>
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  );
}

// ==========================================
// File: app/auth/reset-password/page.tsx
// ==========================================


"use client";

import { useState, useEffect, Suspense } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Lock, Loader2, CheckCircle2, AlertCircle } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

function ResetPasswordContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { toast } = useToast();
  
  const [token, setToken] = useState<string | null>(null);
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const tokenParam = searchParams.get("token");
    if (!tokenParam) {
      setError("Invalid reset link. Please request a new password reset.");
    } else {
      setToken(tokenParam);
    }
  }, [searchParams]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!token) {
      toast({
        title: "Error",
        description: "Invalid reset token",
        variant: "destructive",
      });
      return;
    }

    if (password.length < 8) {
      toast({
        title: "Error",
        description: "Password must be at least 8 characters long",
        variant: "destructive",
      });
      return;
    }

    if (password !== confirmPassword) {
      toast({
        title: "Error",
        description: "Passwords do not match",
        variant: "destructive",
      });
      return;
    }

    setLoading(true);
    try {
      const response = await fetch("/api/auth/reset-password", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ token, password }),
      });

      const data = await response.json();

      if (response.ok) {
        setSuccess(true);
        toast({
          title: "Success!",
          description: "Your password has been reset successfully",
        });
        
        // Redirect to login after 3 seconds
        setTimeout(() => {
          router.push("/auth/login");
        }, 3000);
      } else {
        toast({
          title: "Error",
          description: data.error || "Failed to reset password",
          variant: "destructive",
        });
        
        if (data.error?.includes("expired")) {
          setError("This reset link has expired. Please request a new one.");
        }
      }
    } catch (error) {
      console.error("Password reset error:", error);
      toast({
        title: "Error",
        description: "Failed to reset password. Please try again.",
        variant: "destructive",
      });
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-white to-purple-50 px-4 py-12">
      <div className="w-full max-w-md">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            Reset Your Password
          </h1>
          <p className="text-gray-600">
            Enter your new password below
          </p>
        </div>
        
        <Card>
          <CardHeader>
            <CardTitle>Create New Password</CardTitle>
            <CardDescription>
              Choose a strong password for your account
            </CardDescription>
          </CardHeader>
          <CardContent>
            {error ? (
              <div className="text-center py-6">
                <AlertCircle className="w-16 h-16 text-red-600 mx-auto mb-4" />
                <h3 className="text-lg font-semibold mb-2 text-red-600">Invalid or Expired Link</h3>
                <p className="text-sm text-muted-foreground mb-4">
                  {error}
                </p>
                <Button asChild>
                  <Link href="/auth/forgot-password">
                    Request New Reset Link
                  </Link>
                </Button>
              </div>
            ) : success ? (
              <div className="text-center py-6">
                <CheckCircle2 className="w-16 h-16 text-green-600 mx-auto mb-4" />
                <h3 className="text-lg font-semibold mb-2">Password Reset Successful!</h3>
                <p className="text-sm text-muted-foreground mb-4">
                  Your password has been reset successfully. Redirecting you to login...
                </p>
                <Button asChild>
                  <Link href="/auth/login">
                    Go to Login
                  </Link>
                </Button>
              </div>
            ) : (
              <form onSubmit={handleSubmit} className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="password">New Password</Label>
                  <Input
                    id="password"
                    type="password"
                    placeholder="Enter new password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    required
                    disabled={loading}
                    minLength={8}
                  />
                  <p className="text-xs text-muted-foreground">
                    Must be at least 8 characters long
                  </p>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="confirmPassword">Confirm Password</Label>
                  <Input
                    id="confirmPassword"
                    type="password"
                    placeholder="Confirm new password"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    required
                    disabled={loading}
                    minLength={8}
                  />
                </div>

                <Button type="submit" disabled={loading || !token} className="w-full">
                  {loading ? (
                    <>
                      <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                      Resetting Password...
                    </>
                  ) : (
                    <>
                      <Lock className="mr-2 h-4 w-4" />
                      Reset Password
                    </>
                  )}
                </Button>
              </form>
            )}

            <div className="text-center pt-4 mt-4 border-t">
              <Link
                href="/auth/login"
                className="text-sm text-blue-600 hover:text-blue-500 font-medium"
              >
                â† Back to Login
              </Link>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

export default function ResetPasswordPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-blue-600" />
      </div>
    }>
      <ResetPasswordContent />
    </Suspense>
  );
}

// ==========================================
// File: app/auth/signup/page.tsx
// ==========================================


import { Metadata } from "next";
import Link from "next/link";
import Navigation from "@/components/navigation";
import { SignupForm } from "@/components/auth/signup-form";
import { 
  CheckCircle2, 
  TrendingUp, 
  Users, 
  Zap, 
  Shield,
  BarChart3,
  Gift,
  Sparkles,
  Target,
  DollarSign,
  Globe,
  MessageSquare
} from "lucide-react";

export const metadata: Metadata = {
  title: "Sign Up | CDM Suite",
  description: "Create your CDM Suite account and unlock powerful marketing tools",
};

const benefits = [
  {
    icon: Gift,
    title: "Free Website Audit",
    description: "Get a comprehensive analysis of your current online presence",
    highlight: true
  },
  {
    icon: Target,
    title: "Custom Strategy",
    description: "Receive a personalized marketing plan tailored to your business goals"
  },
  {
    icon: BarChart3,
    title: "Real-Time Analytics",
    description: "Track your performance with detailed insights and reporting"
  },
  {
    icon: Zap,
    title: "Fast Implementation",
    description: "See results quickly with our proven marketing strategies"
  },
  {
    icon: Users,
    title: "Expert Support",
    description: "Access our team of marketing professionals whenever you need help"
  },
  {
    icon: Shield,
    title: "No Long-Term Contracts",
    description: "Flexible monthly plans that scale with your business"
  }
];

const features = [
  {
    category: "Marketing Services",
    items: [
      "SEO optimization for higher rankings",
      "Social media management & growth",
      "Targeted advertising campaigns",
      "Content creation & strategy"
    ]
  },
  {
    category: "Web Development",
    items: [
      "Custom website design & development",
      "Mobile app creation",
      "E-commerce solutions",
      "Ongoing maintenance & support"
    ]
  },
  {
    category: "Business Tools",
    items: [
      "Lead capture & automation",
      "Email marketing campaigns",
      "Performance tracking dashboard",
      "Competitor analysis tools"
    ]
  }
];

const pricingHighlights = [
  { label: "Free Tier", description: "Start with a free website audit", icon: Gift },
  { label: "Starter Plans", description: "From $250/mo with 7-day trial", icon: DollarSign },
  { label: "No Hidden Fees", description: "Transparent, all-inclusive pricing", icon: CheckCircle2 }
];

export default function SignupPage({
  searchParams,
}: {
  searchParams: { ref?: string };
}) {
  const referralCode = searchParams.ref;

  return (
    <>
      <Navigation />
      <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
        <div className="section-container py-12 lg:py-20">
          <div className="max-w-6xl mx-auto">
            {/* Header Section */}
            <div className="text-center mb-12">
              <div className="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-secondary to-accent text-charcoal rounded-full font-semibold text-sm mb-4 shadow-lg">
                <Sparkles className="w-4 h-4" />
                Limited Time: Get Your First Month 50% Off
              </div>
              <h1 className="text-4xl lg:text-5xl font-bold text-gray-900 mb-4">
                Start Growing Your Business
                <span className="block mt-2 bg-gradient-to-r from-secondary to-accent bg-clip-text text-transparent">
                  With CDM Suite
                </span>
              </h1>
              <p className="text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
                Join hundreds of businesses that trust CDM Suite to handle their digital marketing. 
                Create your account now and get immediate access to powerful tools that drive real results.
              </p>
            </div>

            <div className="grid lg:grid-cols-2 gap-12 items-start">
              {/* Left Column - What You Get */}
              <div className="space-y-8">
                {/* Main Benefits */}
                <div>
                  <h2 className="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                    <CheckCircle2 className="w-7 h-7 text-accent" />
                    What You Get When You Sign Up
                  </h2>
                  <div className="space-y-4">
                    {benefits.map((benefit, index) => {
                      const Icon = benefit.icon;
                      return (
                        <div 
                          key={index}
                          className={`flex gap-4 p-4 rounded-xl border transition-all ${
                            benefit.highlight 
                              ? 'bg-gradient-to-r from-accent/10 to-secondary/10 border-accent shadow-md' 
                              : 'bg-white border-gray-100 hover:shadow-md'
                          }`}
                        >
                          <div className="flex-shrink-0">
                            <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${
                              benefit.highlight
                                ? 'bg-gradient-to-br from-accent to-secondary'
                                : 'bg-gradient-to-br from-secondary to-accent'
                            }`}>
                              <Icon className="w-6 h-6 text-white" />
                            </div>
                          </div>
                          <div>
                            <h3 className="font-semibold text-gray-900 mb-1 text-lg">
                              {benefit.title}
                            </h3>
                            <p className="text-gray-600">
                              {benefit.description}
                            </p>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Pricing Highlights */}
                <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6 border border-blue-200">
                  <h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <DollarSign className="w-6 h-6 text-secondary" />
                    Flexible Pricing Options
                  </h3>
                  <div className="space-y-3">
                    {pricingHighlights.map((item, index) => {
                      const Icon = item.icon;
                      return (
                        <div key={index} className="flex items-start gap-3">
                          <Icon className="w-5 h-5 text-accent flex-shrink-0 mt-0.5" />
                          <div>
                            <p className="font-semibold text-gray-900">{item.label}</p>
                            <p className="text-sm text-gray-600">{item.description}</p>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Feature Categories */}
                <div>
                  <h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <Globe className="w-6 h-6 text-secondary" />
                    Complete Digital Marketing Suite
                  </h3>
                  <div className="space-y-4">
                    {features.map((feature, index) => (
                      <div key={index} className="bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
                        <h4 className="font-semibold text-gray-900 mb-3">
                          {feature.category}
                        </h4>
                        <ul className="space-y-2">
                          {feature.items.map((item, itemIndex) => (
                            <li key={itemIndex} className="flex items-start gap-2 text-sm text-gray-600">
                              <CheckCircle2 className="w-4 h-4 text-accent flex-shrink-0 mt-0.5" />
                              {item}
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Trust Signals */}
                <div className="flex flex-wrap gap-6 items-center text-sm text-gray-600 pt-4">
                  <div className="flex items-center gap-2">
                    <Users className="w-5 h-5 text-secondary" />
                    <span className="font-medium">500+ Active Clients</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <TrendingUp className="w-5 h-5 text-accent" />
                    <span className="font-medium">Average 3x ROI</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <MessageSquare className="w-5 h-5 text-secondary" />
                    <span className="font-medium">24/7 Expert Support</span>
                  </div>
                </div>
              </div>

              {/* Right Column - Signup Form */}
              <div className="lg:sticky lg:top-24">
                <div className="text-center mb-6">
                  <h2 className="text-2xl font-bold text-gray-900 mb-2">
                    Create Your Free Account
                  </h2>
                  <p className="text-gray-600">
                    No credit card required â€¢ Start free today
                  </p>
                  {referralCode && (
                    <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                      <p className="text-sm text-green-800 font-medium">
                        ðŸŽ‰ Special Offer: You've been referred! Get an extra 10% off your first 3 months.
                      </p>
                    </div>
                  )}
                </div>
                
                <SignupForm referralCode={referralCode} />
                
                {/* Additional Info */}
                <div className="mt-6 space-y-4">
                  <div className="text-center p-4 bg-gradient-to-r from-secondary/10 to-accent/10 rounded-xl border border-secondary/20">
                    <p className="text-sm text-gray-700 mb-2 font-medium">
                      Already have an account?
                    </p>
                    <Link 
                      href="/auth/login"
                      className="text-secondary hover:text-accent font-semibold text-sm transition-colors"
                    >
                      Log in here â†’
                    </Link>
                  </div>

                  <div className="text-center text-xs text-gray-500">
                    By signing up, you agree to our{" "}
                    <Link href="/terms" className="text-secondary hover:underline">
                      Terms of Service
                    </Link>{" "}
                    and{" "}
                    <Link href="/privacy" className="text-secondary hover:underline">
                      Privacy Policy
                    </Link>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </>
  );
}

// ==========================================
// File: app/blog/page.tsx
// ==========================================


import { Metadata } from 'next';
import Navigation from '@/components/navigation';
import Footer from '@/components/footer';
import { BlogPostGrid } from '@/components/blog-post-grid';
import { prisma } from '@/lib/db';

export const metadata: Metadata = {
  title: 'Blog | CDM Suite - Digital Marketing Insights & Tips',
  description: 'Stay updated with the latest digital marketing trends, strategies, and insights from CDM Suite experts.',
};

export const revalidate = 3600; // Revalidate every hour

async function getBlogPosts(page: number = 1, limit: number = 12) {
  const skip = (page - 1) * limit;

  const [posts, totalCount] = await Promise.all([
    prisma.blogPost.findMany({
      where: {
        status: 'published',
      },
      orderBy: {
        publishedAt: 'desc',
      },
      take: limit,
      skip,
      select: {
        id: true,
        title: true,
        slug: true,
        excerpt: true,
        author: true,
        featuredImage: true,
        categories: true,
        tags: true,
        publishedAt: true,
      },
    }),
    prisma.blogPost.count({
      where: {
        status: 'published',
      },
    }),
  ]);

  // Parse categories and tags from JSON strings
  const parsedPosts = posts.map(post => ({
    ...post,
    categories: JSON.parse(post.categories),
    tags: JSON.parse(post.tags)
  }));

  return {
    posts: parsedPosts,
    totalCount,
    totalPages: Math.ceil(totalCount / limit),
    currentPage: page,
  };
}

async function getCategories() {
  const posts = await prisma.blogPost.findMany({
    where: {
      status: 'published',
    },
    select: {
      categories: true,
    },
  });

  const categoriesSet = new Set<string>();
  posts.forEach((post: { categories: string }) => {
    // Parse the categories JSON string
    try {
      const parsedCategories = JSON.parse(post.categories);
      if (Array.isArray(parsedCategories)) {
        parsedCategories.forEach((cat: string) => categoriesSet.add(cat));
      }
    } catch (e) {
      console.error('Error parsing categories:', e);
    }
  });

  return Array.from(categoriesSet).sort();
}

export default async function BlogPage({
  searchParams,
}: {
  searchParams: { page?: string; category?: string };
}) {
  const page = parseInt(searchParams.page || '1');
  const { posts, totalCount, totalPages, currentPage } = await getBlogPosts(page);
  const categories = await getCategories();

  return (
    <main>
      <Navigation />
      <div className="min-h-screen bg-gradient-to-b from-background to-muted/20">
        {/* Hero Section */}
        <section className="relative pt-32 pb-20 px-4 overflow-hidden">
          <div className="absolute inset-0 bg-grid-white/10 bg-[size:20px_20px]" />
          <div className="container mx-auto relative z-10">
            <div className="max-w-3xl mx-auto text-center">
              <h1 className="text-4xl md:text-5xl lg:text-6xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-primary via-purple-500 to-pink-500">
                Digital Marketing Insights
              </h1>
              <p className="text-xl text-muted-foreground mb-8">
                Stay ahead with expert tips, strategies, and industry insights from CDM Suite
              </p>
              <div className="flex items-center justify-center gap-4 text-sm text-muted-foreground">
                <div className="flex items-center gap-2">
                  <div className="h-2 w-2 rounded-full bg-green-500 animate-pulse" />
                  <span>{totalCount} Articles</span>
                </div>
                <div className="h-4 w-px bg-border" />
                <div className="flex items-center gap-2">
                  <span>{categories.length} Categories</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        {/* Blog Posts Grid */}
        <section className="py-12 px-4">
          <div className="container mx-auto">
            <BlogPostGrid
              posts={posts}
              categories={categories}
              totalPages={totalPages}
              currentPage={currentPage}
              selectedCategory={searchParams.category}
            />
          </div>
        </section>
      </div>
      <Footer />
    </main>
  );
}

// ==========================================
// File: app/blog/[slug]/page.tsx
// ==========================================

import { Metadata } from 'next';
import { notFound } from 'next/navigation';
import Image from 'next/image';
import Link from 'next/link';
import Navigation from '@/components/navigation';
import Footer from '@/components/footer';
import { prisma } from '@/lib/db';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { CalendarDays, Clock, ArrowLeft, Share2, Facebook, Twitter, Linkedin, Volume2, Eye } from 'lucide-react';
import { format } from 'date-fns';
import { generateStructuredData, calculateReadTime, addIdsToHeadings, extractHeadings } from '@/lib/blog-seo';
import { formatBlogPost } from '@/lib/blog-formatter';
import { BlogAudioPlayer } from '@/components/blog-audio-player';
import { TableOfContents } from '@/components/table-of-contents';
import { safeJSONParse } from '@/lib/json-helper';

export const revalidate = 3600;

interface BlogPostPageProps {
  params: {
    slug: string;
  };
}

async function getBlogPost(slug: string) {
  const post = await prisma.blogPost.findUnique({
    where: {
      slug,
      status: 'published',
    },
  });

  if (post) {
    // Increment view count
    await prisma.blogPost.update({
      where: { id: post.id },
      data: { views: { increment: 1 } },
    });

    // Parse JSON fields
    return {
      ...post,
      tags: safeJSONParse<string[]>(post.tags, []),
      categories: safeJSONParse<string[]>(post.categories, []),
    };
  }

  return null;
}

async function getRelatedPosts(slug: string, categories: string[], limit: number = 3) {
  // For D1/SQLite, we can't use hasSome on a string field.
  // We'll use OR with contains for each category as a workaround.
  const categoryFilters = categories.map(cat => ({
    categories: {
      contains: cat
    }
  }));

  const posts = await prisma.blogPost.findMany({
    where: {
      slug: { not: slug },
      status: 'published',
      OR: categoryFilters.length > 0 ? categoryFilters : undefined,
    },
    take: limit,
    orderBy: {
      publishedAt: 'desc',
    },
    select: {
      id: true,
      title: true,
      slug: true,
      excerpt: true,
      featuredImage: true,
      categories: true,
      publishedAt: true,
      readTime: true,
    },
  });

  // Parse categories for returned posts
  return posts.map((post: any) => ({
    ...post,
    categories: safeJSONParse(post.categories, []),
  }));
}

export async function generateMetadata({ params }: BlogPostPageProps): Promise<Metadata> {
  const post = await getBlogPost(params.slug);

  if (!post) {
    return {
      title: 'Post Not Found',
    };
  }

  const description = post.metaDescription || post.excerpt || post.content.substring(0, 160);

  return {
    title: `${post.title} | CDM Suite Blog`,
    description,
    keywords: post.tags.join(', '),
    authors: [{ name: post.author }],
    openGraph: {
      title: post.title,
      description,
      type: 'article',
      publishedTime: post.publishedAt?.toISOString(),
      modifiedTime: post.updatedAt.toISOString(),
      authors: [post.author],
      images: [
        {
          url: post.featuredImage || '/og-image.png',
          width: 1200,
          height: 630,
          alt: post.title,
        },
      ],
    },
    twitter: {
      card: 'summary_large_image',
      title: post.title,
      description,
      images: [post.featuredImage || '/og-image.png'],
    },
  };
}

export default async function BlogPostPage({ params }: BlogPostPageProps) {
  const post = await getBlogPost(params.slug);

  if (!post) {
    notFound();
  }

  const relatedPosts = await getRelatedPosts(post.slug, post.categories);
  const shareUrl = `https://cdmsuite.com/blog/${post.slug}`;
  const structuredData = generateStructuredData(post);

  // Process content for better rendering
  let processedContent = formatBlogPost(post.content);
  processedContent = addIdsToHeadings(processedContent);
  const headings = extractHeadings(processedContent);
  const readTime = post.readTime || calculateReadTime(post.content);

  return (
    <main>
      {/* JSON-LD Structured Data */}
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={{ __html: JSON.stringify(structuredData) }}
      />

      <Navigation />
      <div className="min-h-screen bg-background">
        {/* Hero Section */}
        <section className="pt-32 pb-12 px-4 bg-gradient-to-b from-muted/50 to-background">
          <div className="container mx-auto max-w-4xl">
            <Link href="/blog">
              <Button variant="ghost" className="mb-6 -ml-4">
                <ArrowLeft className="mr-2 h-4 w-4" />
                Back to Blog
              </Button>
            </Link>

            {/* Categories */}
            <div className="flex flex-wrap gap-2 mb-6">
              {post.categories.map((category: string) => (
                <Badge key={category} variant="secondary">
                  {category}
                </Badge>
              ))}
            </div>

            {/* Title */}
            <h1 className="text-4xl md:text-5xl font-bold mb-6 leading-tight">
              {post.title}
            </h1>

            {/* Meta Info */}
            <div className="flex flex-wrap items-center gap-4 text-muted-foreground mb-8">
              <div className="flex items-center gap-2">
                <CalendarDays className="h-4 w-4" />
                <span>
                  {post.publishedAt
                    ? format(new Date(post.publishedAt), 'MMMM d, yyyy')
                    : 'Coming soon'}
                </span>
              </div>
              <div className="flex items-center gap-2">
                <Clock className="h-4 w-4" />
                <span>{readTime} min read</span>
              </div>
              <div className="flex items-center gap-2">
                <Eye className="h-4 w-4" />
                <span>{post.views.toLocaleString()} views</span>
              </div>
              <div className="flex items-center gap-2">
                <span>By {post.author}</span>
              </div>
            </div>

            {/* Audio Player */}
            {post.audioUrl && (
              <div className="mb-8">
                <BlogAudioPlayer audioUrl={post.audioUrl} title={post.title} />
              </div>
            )}

            {/* Share Buttons */}
            <div className="flex items-center gap-2">
              <span className="text-sm text-muted-foreground mr-2">Share:</span>
              <Button
                variant="outline"
                size="sm"
                asChild
              >
                <a
                  href={`https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <Facebook className="h-4 w-4" />
                </a>
              </Button>
              <Button
                variant="outline"
                size="sm"
                asChild
              >
                <a
                  href={`https://twitter.com/intent/tweet?url=${shareUrl}&text=${encodeURIComponent(post.title)}`}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <Twitter className="h-4 w-4" />
                </a>
              </Button>
              <Button
                variant="outline"
                size="sm"
                asChild
              >
                <a
                  href={`https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`}
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <Linkedin className="h-4 w-4" />
                </a>
              </Button>
            </div>
          </div>
        </section>

        {/* Featured Image */}
        {post.featuredImage && (
          <section className="px-4 mb-12">
            <div className="container mx-auto max-w-4xl">
              <div className="relative w-full aspect-video rounded-xl overflow-hidden bg-muted">
                <Image
                  src={post.featuredImage}
                  alt={post.title}
                  fill
                  className="object-cover"
                  priority
                />
              </div>
            </div>
          </section>
        )}

        {/* Content */}
        <section className="px-4 pb-20">
          <div className="container mx-auto max-w-7xl">
            <div className="grid grid-cols-1 lg:grid-cols-4 gap-12">
              {/* Table of Contents - Desktop Sidebar, Mobile Floating Button */}
              <TableOfContents headings={headings} />

              {/* Main Content */}
              <div className="lg:col-span-3">
                <article
                  className="prose prose-lg dark:prose-invert max-w-none 
                    prose-headings:scroll-mt-20 prose-headings:font-bold
                    prose-h1:text-4xl prose-h1:mb-6 prose-h1:mt-8
                    prose-h2:text-3xl prose-h2:mb-4 prose-h2:mt-8 prose-h2:border-b prose-h2:pb-2
                    prose-h3:text-2xl prose-h3:mb-3 prose-h3:mt-6
                    prose-h4:text-xl prose-h4:mb-2 prose-h4:mt-4
                    prose-p:mb-4 prose-p:leading-relaxed prose-p:text-base
                    prose-a:text-primary prose-a:no-underline hover:prose-a:underline prose-a:font-medium
                    prose-strong:text-foreground prose-strong:font-bold
                    prose-em:text-foreground/90
                    prose-ul:my-4 prose-ul:space-y-2 prose-ul:list-disc prose-ul:pl-6
                    prose-ol:my-4 prose-ol:space-y-2 prose-ol:list-decimal prose-ol:pl-6
                    prose-li:text-base prose-li:leading-relaxed prose-li:pl-1
                    prose-blockquote:border-l-4 prose-blockquote:border-primary prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:my-4 prose-blockquote:bg-muted/50 prose-blockquote:py-2
                    prose-code:bg-muted prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm prose-code:font-mono prose-code:before:content-none prose-code:after:content-none
                    prose-pre:bg-muted prose-pre:border prose-pre:p-4 prose-pre:rounded-lg prose-pre:overflow-x-auto prose-pre:my-4
                    prose-img:rounded-xl prose-img:shadow-lg prose-img:my-8
                    prose-hr:my-8 prose-hr:border-border
                    prose-table:border-collapse prose-table:my-6
                    prose-th:border prose-th:border-border prose-th:bg-muted prose-th:p-2 prose-th:font-semibold
                    prose-td:border prose-td:border-border prose-td:p-2"
                  dangerouslySetInnerHTML={{ __html: processedContent }}
                />

                <Separator className="my-12" />

                {/* Tags */}
                {post.tags.length > 0 && (
                  <div className="mb-12">
                    <h3 className="text-sm font-semibold text-muted-foreground mb-4">Tags:</h3>
                    <div className="flex flex-wrap gap-2">
                      {post.tags.map((tag: string) => (
                        <Badge key={tag} variant="outline">
                          #{tag}
                        </Badge>
                      ))}
                    </div>
                  </div>
                )}

                {/* CTA Section */}
                <div className="bg-gradient-to-r from-primary/10 to-purple-500/10 rounded-2xl p-8 text-center mb-12">
                  <h3 className="text-2xl font-bold mb-4">Ready to Grow Your Business?</h3>
                  <p className="text-muted-foreground mb-6 max-w-2xl mx-auto">
                    Get a comprehensive evaluation of your digital presence with our free marketing assessment,
                    or run a quick website audit to identify immediate opportunities.
                  </p>
                  <div className="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <Button size="lg" className="w-full sm:w-auto" asChild>
                      <Link href="/marketing-assessment">
                        Get Free Marketing Assessment
                      </Link>
                    </Button>
                    <Button size="lg" variant="outline" className="w-full sm:w-auto" asChild>
                      <Link href="/auditor">
                        Run Free Website Audit
                      </Link>
                    </Button>
                    <Button size="lg" variant="secondary" className="w-full sm:w-auto" asChild>
                      <Link href="/contact">
                        Contact Us
                      </Link>
                    </Button>
                  </div>
                </div>

                {/* Related Posts */}
                {relatedPosts.length > 0 && (
                  <div>
                    <h3 className="text-2xl font-bold mb-6">Related Articles</h3>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                      {relatedPosts.map((relatedPost: any) => (
                        <Link
                          key={relatedPost.id}
                          href={`/blog/${relatedPost.slug}`}
                          className="group"
                        >
                          <div className="border rounded-lg overflow-hidden hover:shadow-lg transition-all">
                            <div className="relative h-40 bg-muted">
                              {relatedPost.featuredImage ? (
                                <Image
                                  src={relatedPost.featuredImage}
                                  alt={relatedPost.title}
                                  fill
                                  className="object-cover group-hover:scale-105 transition-transform"
                                />
                              ) : (
                                <div className="w-full h-full bg-gradient-to-br from-primary/20 to-purple-500/20" />
                              )}
                            </div>
                            <div className="p-4">
                              <h4 className="font-semibold line-clamp-2 group-hover:text-primary transition-colors">
                                {relatedPost.title}
                              </h4>
                              <div className="flex items-center gap-2 mt-2 text-sm text-muted-foreground">
                                <Clock className="h-3 w-3" />
                                <span>{relatedPost.readTime} min read</span>
                              </div>
                            </div>
                          </div>
                        </Link>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </section>
      </div>
      <Footer />
    </main>
  );
}

// ==========================================
// File: app/builder/editor/[id]/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { DashboardLayout } from "@/components/dashboard/dashboard-layout";
import { prisma } from "@/lib/db";
import { EnhancedVisualEditor } from "@/components/builder/enhanced-visual-editor";

export default async function EditorPage({
  params,
}: {
  params: { id: string };
}) {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  const project = await prisma.project.findUnique({
    where: {
      id: params.id,
      userId: user.id,
    },
  });

  if (!project) {
    redirect("/dashboard/projects");
  }

  // Parse project data
  const pages = project.pages ? JSON.parse(project.pages) : [];
  const siteConfig = project.siteConfig ? JSON.parse(project.siteConfig) : {};
  const businessData = project.businessData ? JSON.parse(project.businessData) : {};

  return (
    <DashboardLayout user={user}>
      <EnhancedVisualEditor
        project={{
          ...project,
          pages,
          siteConfig,
          businessData,
        }}
      />
    </DashboardLayout>
  );
}

// ==========================================
// File: app/builder/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { BuilderClient } from "@/components/builder/builder-client";
import { DashboardLayout } from "@/components/dashboard/dashboard-layout";
import { prisma } from "@/lib/db";

export const metadata = {
  title: "AI Website Builder | CDM Suite",
  description: "Build your professional website in minutes with AI",
};

export default async function BuilderPage({
  searchParams,
}: {
  searchParams: { audit?: string };
}) {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login?callbackUrl=/builder");
  }

  // Check tier access
  if (user.tier === "free") {
    redirect("/dashboard?upgrade=true");
  }

  // Fetch audit data if provided
  let auditData = null;
  if (searchParams.audit) {
    const audit = await prisma.websiteAudit.findFirst({
      where: {
        id: searchParams.audit,
        userId: user.id
      }
    });
    if (audit) {
      auditData = {
        id: audit.id,
        websiteUrl: audit.websiteUrl,
        seoScore: audit.seoScore,
        performanceScore: audit.performanceScore,
        mobileScore: audit.mobileScore,
        securityScore: audit.securityScore,
        issues: JSON.parse(audit.issues),
        recommendations: JSON.parse(audit.recommendations)
      };
    }
  }

  return (
    <DashboardLayout user={user}>
      <BuilderClient user={user} auditData={auditData} />
    </DashboardLayout>
  );
}

// ==========================================
// File: app/builder/preview/[id]/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { prisma } from "@/lib/db";
import { PreviewClient } from "@/components/builder/preview-client";
import { SslNotice } from "@/components/builder/ssl-notice";

export default async function PreviewPage({
  params,
}: {
  params: { id: string };
}) {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  const project = await prisma.project.findUnique({
    where: {
      id: params.id,
      userId: user.id,
    },
  });

  if (!project) {
    redirect("/dashboard/projects");
  }

  // Parse project data
  const pages = project.pages ? JSON.parse(project.pages) : [];
  const siteConfig = project.siteConfig ? JSON.parse(project.siteConfig) : {};
  const businessData = project.businessData ? JSON.parse(project.businessData) : {};

  return (
    <>
      <div className="bg-white border-b p-4">
        <div className="max-w-7xl mx-auto">
          <SslNotice subdomain={project.subdomain || undefined} showDetails={true} />
        </div>
      </div>
      <PreviewClient
        project={{
          ...project,
          pages,
          siteConfig,
          businessData,
        }}
      />
    </>
  );
}

// ==========================================
// File: app/case-studies/page.tsx
// ==========================================


import Navigation from "@/components/navigation";
import Footer from "@/components/footer";
import CaseStudiesHero from "@/components/case-studies/case-studies-hero";
import CaseStudiesList from "@/components/case-studies/case-studies-list";
import { prisma } from "@/lib/db";

export const metadata = {
  title: "Case Studies - CDM Suite Success Stories",
  description: "See how CDM Suite has helped businesses achieve 150-300% ROI through data-driven digital marketing strategies. Real results, real growth.",
};

async function getCaseStudies() {
  try {
    const studies = await prisma.caseStudy.findMany({
      where: { status: 'published' },
      orderBy: [
        { order: 'asc' },
        { createdAt: 'desc' }
      ]
    });
    return studies;
  } catch (error) {
    console.error('Error fetching case studies:', error);
    return [];
  }
}

export default async function CaseStudiesPage() {
  const caseStudies = await getCaseStudies();
  
  return (
    <main>
      <Navigation />
      <CaseStudiesHero />
      <CaseStudiesList studies={caseStudies} />
      <Footer />
    </main>
  );
}

// ==========================================
// File: app/case-studies/[slug]/page.tsx
// ==========================================


import { notFound } from 'next/navigation';
import Image from 'next/image';
import Link from 'next/link';
import { ArrowLeft, CheckCircle, Quote } from 'lucide-react';
import { Button } from '@/components/ui/button';
import Navigation from '@/components/navigation';
import Footer from '@/components/footer';
import { prisma } from '@/lib/db';

export async function generateStaticParams() {
  // Avoid hitting the database during static generation to keep builds independent
  // of database availability. Case study pages will be generated on-demand.
  return [];
}

async function getCaseStudy(slug: string) {
  try {
    const study = await prisma.caseStudy.findUnique({
      where: { slug, status: 'published' }
    });
    return study;
  } catch (error) {
    console.error('Error fetching case study:', error);
    return null;
  }
}

export default async function CaseStudyDetailPage({ params }: { params: { slug: string } }) {
  const study = await getCaseStudy(params.slug);

  if (!study) {
    notFound();
  }
  
  // Parse JSON fields
  const results = Array.isArray(study.results) ? study.results : [];
  const tags = Array.isArray(study.tags) ? study.tags : [];

  return (
    <main>
      <Navigation />
      
      {/* Hero Section */}
      <section className="pt-32 pb-16 bg-gradient-to-r from-primary to-primary/80 text-white">
        <div className="section-container">
          <Link href="/case-studies" className="inline-flex items-center gap-2 text-white/90 hover:text-white mb-8 transition-colors">
            <ArrowLeft className="w-4 h-4" />
            Back to Case Studies
          </Link>
          
          <div className="max-w-4xl">
            <span className="inline-block bg-white/20 px-4 py-2 rounded-full text-sm font-semibold mb-4">
              {study.category}
            </span>
            <h1 className="text-4xl md:text-5xl lg:text-6xl font-bold mb-6">
              {study.title}
            </h1>
            <p className="text-xl md:text-2xl text-white/90">
              {study.description}
            </p>
          </div>
        </div>
      </section>

      {/* Hero Image */}
      <section className="relative h-96 md:h-[500px] bg-gray-100 dark:bg-gray-800">
        <Image
          src={study.heroImage.startsWith('uploads/') ? `/api/file/${encodeURIComponent(study.heroImage)}` : study.heroImage}
          alt={study.title}
          fill
          className="object-cover"
          priority
        />
      </section>

      {/* Content */}
      <section className="py-20 bg-white dark:bg-gray-900">
        <div className="section-container max-w-4xl">
          <div className="grid md:grid-cols-2 gap-12 mb-16">
            {/* Challenge */}
            {study.challenge && (
              <div>
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                  The Challenge
                </h2>
                <p className="text-gray-600 dark:text-gray-300 leading-relaxed">
                  {study.challenge}
                </p>
              </div>
            )}

            {/* Solution */}
            {study.solution && (
              <div>
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                  Our Solution
                </h2>
                <p className="text-gray-600 dark:text-gray-300 leading-relaxed">
                  {study.solution}
                </p>
              </div>
            )}
          </div>

          {/* Results */}
          {results && results.length > 0 && (
            <div className="mb-16">
              <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-8 text-center">
                Results Achieved
              </h2>
              <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                {results.map((result: any, idx: number) => (
                  <div key={idx} className="bg-primary/5 dark:bg-primary/10 p-6 rounded-lg text-center">
                    <CheckCircle className="w-10 h-10 text-green-500 mx-auto mb-3" />
                    <p className="text-gray-700 dark:text-gray-300 font-medium">{result}</p>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Testimonial */}
          {study.testimonialQuote && (
            <div className="bg-gray-50 dark:bg-gray-800 p-8 md:p-12 rounded-lg mb-16">
              <Quote className="w-12 h-12 text-primary mb-6" />
              <blockquote className="text-lg md:text-xl text-gray-700 dark:text-gray-300 italic mb-6 leading-relaxed">
                "{study.testimonialQuote}"
              </blockquote>
              <div>
                <p className="font-semibold text-gray-900 dark:text-white">
                  {study.testimonialAuthor}
                </p>
                <p className="text-gray-600 dark:text-gray-400">
                  {study.testimonialCompany}
                </p>
              </div>
            </div>
          )}

          {/* Tags */}
          <div className="mb-12">
            <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">
              Services Provided:
            </h3>
            <div className="flex flex-wrap gap-3">
              {tags.map((tag: any, idx: number) => (
                <span key={idx} className="bg-primary text-white px-4 py-2 rounded-full text-sm font-medium">
                  {tag}
                </span>
              ))}
            </div>
          </div>

          {/* CTA */}
          <div className="border-t border-gray-200 dark:border-gray-700 pt-12 text-center">
            <h3 className="text-2xl font-bold text-gray-900 dark:text-white mb-4">
              Ready to Achieve Similar Results?
            </h3>
            <p className="text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">
              Let's discuss how we can help your business grow with our proven digital marketing strategies.
            </p>
            <div className="flex flex-col sm:flex-row gap-4 justify-center">
              <Link href="/contact">
                <Button size="lg">
                  Get Started Today
                </Button>
              </Link>
              <Link href="/pricing">
                <Button size="lg" variant="outline">
                  View Our Packages
                </Button>
              </Link>
            </div>
          </div>
        </div>
      </section>

      <Footer />
    </main>
  );
}

// ==========================================
// File: app/case-studies/_id_unused/page.tsx
// ==========================================


import { notFound } from 'next/navigation';
import Image from 'next/image';
import Link from 'next/link';
import { motion } from 'framer-motion';
import { ArrowLeft, CheckCircle, Quote } from 'lucide-react';
import { Button } from '@/components/ui/button';
import Navigation from '@/components/navigation';
import Footer from '@/components/footer';
import { getCaseStudyById } from '@/lib/case-studies';

export async function generateStaticParams() {
  const caseStudies = [
    'foqn-funny',
    'rapido-shipping',
    'sun-absorbed',
    'dreniefied-collection',
    'meta-ads-inflatables-1',
    'meta-ads-inflatables-2',
    'meta-ads-coaching'
  ];
  
  return caseStudies.map((id) => ({
    id,
  }));
}

export default function CaseStudyDetailPage({ params }: { params: { id: string } }) {
  const study = getCaseStudyById(params.id);

  if (!study) {
    notFound();
  }

  return (
    <main>
      <Navigation />
      
      {/* Hero Section */}
      <section className="pt-32 pb-16 bg-gradient-to-r from-primary to-primary/80 text-white">
        <div className="section-container">
          <Link href="/case-studies" className="inline-flex items-center gap-2 text-white/90 hover:text-white mb-8 transition-colors">
            <ArrowLeft className="w-4 h-4" />
            Back to Case Studies
          </Link>
          
          <div className="max-w-4xl">
            <span className="inline-block bg-white/20 px-4 py-2 rounded-full text-sm font-semibold mb-4">
              {study.category}
            </span>
            <h1 className="text-4xl md:text-5xl lg:text-6xl font-bold mb-6">
              {study.title}
            </h1>
            <p className="text-xl md:text-2xl text-white/90">
              {study.description}
            </p>
          </div>
        </div>
      </section>

      {/* Hero Image */}
      <section className="relative h-96 md:h-[500px] bg-gray-100 dark:bg-gray-800">
        <Image
          src={study.image}
          alt={study.title}
          fill
          className="object-cover"
          priority
        />
      </section>

      {/* Content */}
      <section className="py-20 bg-white dark:bg-gray-900">
        <div className="section-container max-w-4xl">
          <div className="grid md:grid-cols-2 gap-12 mb-16">
            {/* Challenge */}
            {study.challenge && (
              <div>
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                  The Challenge
                </h2>
                <p className="text-gray-600 dark:text-gray-300 leading-relaxed">
                  {study.challenge}
                </p>
              </div>
            )}

            {/* Solution */}
            {study.solution && (
              <div>
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-4">
                  Our Solution
                </h2>
                <p className="text-gray-600 dark:text-gray-300 leading-relaxed">
                  {study.solution}
                </p>
              </div>
            )}
          </div>

          {/* Results */}
          {study.results && study.results.length > 0 && (
            <div className="mb-16">
              <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-8 text-center">
                Results Achieved
              </h2>
              <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                {study.results.map((result, idx) => (
                  <div key={idx} className="bg-primary/5 dark:bg-primary/10 p-6 rounded-lg text-center">
                    <CheckCircle className="w-10 h-10 text-green-500 mx-auto mb-3" />
                    <p className="text-gray-700 dark:text-gray-300 font-medium">{result}</p>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Testimonial */}
          {study.testimonial && (
            <div className="bg-gray-50 dark:bg-gray-800 p-8 md:p-12 rounded-lg mb-16">
              <Quote className="w-12 h-12 text-primary mb-6" />
              <blockquote className="text-lg md:text-xl text-gray-700 dark:text-gray-300 italic mb-6 leading-relaxed">
                "{study.testimonial.quote}"
              </blockquote>
              <div>
                <p className="font-semibold text-gray-900 dark:text-white">
                  {study.testimonial.author}
                </p>
                <p className="text-gray-600 dark:text-gray-400">
                  {study.testimonial.company}
                </p>
              </div>
            </div>
          )}

          {/* Tags */}
          <div className="mb-12">
            <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">
              Services Provided:
            </h3>
            <div className="flex flex-wrap gap-3">
              {study.tags.map((tag, idx) => (
                <span key={idx} className="bg-primary text-white px-4 py-2 rounded-full text-sm font-medium">
                  {tag}
                </span>
              ))}
            </div>
          </div>

          {/* CTA */}
          <div className="border-t border-gray-200 dark:border-gray-700 pt-12 text-center">
            <h3 className="text-2xl font-bold text-gray-900 dark:text-white mb-4">
              Ready to Achieve Similar Results?
            </h3>
            <p className="text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">
              Let's discuss how we can help your business grow with our proven digital marketing strategies.
            </p>
            <div className="flex flex-col sm:flex-row gap-4 justify-center">
              <Link href="/contact">
                <Button size="lg">
                  Get Started Today
                </Button>
              </Link>
              <Link href="/pricing">
                <Button size="lg" variant="outline">
                  View Our Packages
                </Button>
              </Link>
            </div>
          </div>
        </div>
      </section>

      <Footer />
    </main>
  );
}

// ==========================================
// File: app/category/blog/page.tsx
// ==========================================

import { permanentRedirect } from 'next/navigation';

export default function BlogCategoryPage() {
  // Redirect to main blog page since we don't have category filtering yet
  permanentRedirect('/blog');
}

// ==========================================
// File: app/contact/page.tsx
// ==========================================


import Navigation from "@/components/navigation";
import Footer from "@/components/footer";
import ContactHero from "@/components/contact/contact-hero";
import ContactForm from "@/components/contact/contact-form";
import ContactInfo from "@/components/contact/contact-info";

export const metadata = {
  title: "Contact CDM Suite - Get Your Free Digital Marketing Consultation",
  description: "Ready to grow your business? Contact CDM Suite for a free consultation. Talk to our experts about web design, digital marketing, and AI implementation services.",
};

export default function ContactPage() {
  return (
    <main>
      <Navigation />
      <ContactHero />
      <ContactForm />
      <ContactInfo />
      <Footer />
    </main>
  );
}

// ==========================================
// File: app/dashboard/affiliate/page.tsx
// ==========================================



import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { AffiliateClient } from "@/components/dashboard/affiliate-client";

export const metadata = {
  title: "Affiliate Program | CDM Suite",
  description: "Earn commissions by referring customers to CDM Suite",
};

export default async function AffiliatePage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  return <AffiliateClient user={user} />;
}

// ==========================================
// File: app/dashboard/ai-agents/new/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import { AgentBuilder } from "@/components/agents/agent-builder";

export const metadata = {
  title: "Create AI Agent | CDM Suite",
  description: "Build a new AI agent",
};

export default async function NewAgentPage() {
  const session = await getServerSession(authOptions);
  
  if (!session) {
    redirect("/auth/login");
  }

  return <AgentBuilder user={session.user} />;
}

// ==========================================
// File: app/dashboard/ai-agents/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import { AgentsDashboard } from "@/components/agents/agents-dashboard";

export const metadata = {
  title: "AI Agent Builder | CDM Suite",
  description: "Build and deploy revenue-generating AI agents",
};

export default async function AIAgentsPage() {
  const session = await getServerSession(authOptions);
  
  if (!session) {
    redirect("/auth/login");
  }

  return <AgentsDashboard user={session.user} />;
}

// ==========================================
// File: app/dashboard/ai-agents/[agentId]/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import { AgentEditor } from "@/components/agents/agent-editor";
import { prisma } from "@/lib/db";

export const metadata = {
  title: "Edit AI Agent | CDM Suite",
  description: "Edit and manage your AI agent",
};

export default async function AgentEditorPage({ params }: { params: { agentId: string } }) {
  const session = await getServerSession(authOptions);
  
  if (!session) {
    redirect("/auth/login");
  }

  const agent = await prisma.aIAgent.findUnique({
    where: { id: params.agentId },
    include: {
      knowledgeSources: true,
      integrationConfigs: true,
      workflowRules: true,
    },
  });

  if (!agent || agent.userId !== session.user.id) {
    redirect("/dashboard/ai-agents");
  }

  return <AgentEditor agent={agent} user={session.user} />;
}

// ==========================================
// File: app/dashboard/analytics/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { AnalyticsDashboardClient } from "@/components/dashboard/analytics-dashboard-client";

export const metadata = {
  title: "Analytics | CDM Suite",
  description: "Track your performance and insights",
};

export default async function AnalyticsPage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  return <AnalyticsDashboardClient />;
}

// ==========================================
// File: app/dashboard/audits/audits-client.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  Search,
  TrendingUp,
  Calendar,
  BarChart3,
  Eye,
  RefreshCw,
  Download,
  ExternalLink,
  CheckCircle2,
  XCircle,
  AlertCircle,
  Smartphone,
  Shield,
  Zap,
  ArrowRight,
  Plus,
  Filter,
  Clock,
  Award
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { toast } from 'react-hot-toast';
import Link from 'next/link';
import { format } from 'date-fns';
import {
  LineChart,
  Line,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  RadarChart,
  PolarGrid,
  PolarAngleAxis,
  PolarRadiusAxis,
  Radar,
} from 'recharts';

interface Audit {
  id: string;
  websiteUrl: string;
  seoScore: number;
  performanceScore: number;
  mobileScore: number;
  securityScore: number;
  overallScore: number;
  issues: string;
  recommendations: string;
  createdAt: string;
}

interface User {
  id: string;
  email: string;
  name: string | null;
}

export function AuditsClient({ user }: { user: User }) {
  const [audits, setAudits] = useState<Audit[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedAudit, setSelectedAudit] = useState<Audit | null>(null);
  const [detailsOpen, setDetailsOpen] = useState(false);
  const [filterUrl, setFilterUrl] = useState<string>('all');

  useEffect(() => {
    fetchAudits();
  }, []);

  const fetchAudits = async () => {
    try {
      const response = await fetch('/api/auditor/history');
      if (!response.ok) throw new Error('Failed to fetch audits');
      const data = await response.json();
      setAudits(data.audits || []);
    } catch (error) {
      console.error('Error fetching audits:', error);
      toast.error('Failed to load audit history');
    } finally {
      setIsLoading(false);
    }
  };

  const handleRerun = async (websiteUrl: string) => {
    window.location.href = `/dashboard/audits/new?url=${encodeURIComponent(websiteUrl)}`;
  };

  const handleViewDetails = (audit: Audit) => {
    setSelectedAudit(audit);
    setDetailsOpen(true);
  };

  const getScoreColor = (score: number) => {
    if (score >= 80) return 'text-green-600';
    if (score >= 60) return 'text-yellow-600';
    return 'text-red-600';
  };

  const getScoreBgColor = (score: number) => {
    if (score >= 80) return 'bg-green-100 border-green-300';
    if (score >= 60) return 'bg-yellow-100 border-yellow-300';
    return 'bg-red-100 border-red-300';
  };

  const getScoreLabel = (score: number) => {
    if (score >= 80) return 'Excellent';
    if (score >= 60) return 'Good';
    if (score >= 40) return 'Needs Improvement';
    return 'Critical';
  };

  // Get unique website URLs for filtering
  const uniqueUrls = ['all', ...new Set(audits.map(a => a.websiteUrl))];

  // Filter audits by URL
  const filteredAudits = filterUrl === 'all' 
    ? audits 
    : audits.filter(a => a.websiteUrl === filterUrl);

  // Prepare chart data for score tracking over time
  const chartData = filteredAudits.map(audit => ({
    date: format(new Date(audit.createdAt), 'MMM d'),
    overall: audit.overallScore,
    seo: audit.seoScore,
    performance: audit.performanceScore,
    mobile: audit.mobileScore,
    security: audit.securityScore,
  })).reverse(); // Reverse to show oldest to newest

  // Calculate average scores
  const avgScores = {
    overall: Math.round(audits.reduce((sum, a) => sum + a.overallScore, 0) / (audits.length || 1)),
    seo: Math.round(audits.reduce((sum, a) => sum + a.seoScore, 0) / (audits.length || 1)),
    performance: Math.round(audits.reduce((sum, a) => sum + a.performanceScore, 0) / (audits.length || 1)),
    mobile: Math.round(audits.reduce((sum, a) => sum + a.mobileScore, 0) / (audits.length || 1)),
    security: Math.round(audits.reduce((sum, a) => sum + a.securityScore, 0) / (audits.length || 1)),
  };

  // Get latest audit for comparison
  const latestAudit = filteredAudits[0];
  const previousAudit = filteredAudits[1];

  // Calculate improvement
  const improvement = latestAudit && previousAudit 
    ? latestAudit.overallScore - previousAudit.overallScore 
    : 0;

  // Prepare radar chart data for latest audit
  const radarData = latestAudit ? [
    {
      category: 'SEO',
      score: latestAudit.seoScore,
      fullMark: 100,
    },
    {
      category: 'Performance',
      score: latestAudit.performanceScore,
      fullMark: 100,
    },
    {
      category: 'Mobile',
      score: latestAudit.mobileScore,
      fullMark: 100,
    },
    {
      category: 'Security',
      score: latestAudit.securityScore,
      fullMark: 100,
    },
  ] : [];

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <div className="text-center space-y-4">
          <RefreshCw className="w-12 h-12 animate-spin text-blue-600 mx-auto" />
          <p className="text-slate-600">Loading your audit history...</p>
        </div>
      </div>
    );
  }

  if (audits.length === 0) {
    return (
      <div className="max-w-4xl mx-auto">
        <Card className="shadow-lg border-2 border-dashed">
          <CardContent className="py-16 text-center">
            <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <Search className="w-10 h-10 text-blue-600" />
            </div>
            <h2 className="text-2xl font-bold mb-3">No Audits Yet</h2>
            <p className="text-slate-600 mb-6 max-w-md mx-auto">
              You haven't run any website audits yet. Start by analyzing your website to get actionable insights and recommendations.
            </p>
            <Button size="lg" asChild className="bg-gradient-to-r from-blue-600 to-blue-700">
              <Link href="/dashboard/audits/new">
                <Plus className="w-5 h-5 mr-2" />
                Run Your First Audit
              </Link>
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-8 pb-8">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div className="min-w-0">
          <h1 className="text-2xl sm:text-3xl font-bold mb-2 truncate">Website Audits</h1>
          <p className="text-sm sm:text-base text-slate-600">
            Track your website performance and improvements over time
          </p>
        </div>
        <Button size="sm" asChild className="w-full sm:w-auto bg-gradient-to-r from-blue-600 to-blue-700">
          <Link href="/dashboard/audits/new">
            <Plus className="w-4 h-4 sm:w-5 sm:h-5 mr-2" />
            New Audit
          </Link>
        </Button>
      </div>

      {/* Stats Overview */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6">
        <Card className="shadow-lg">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-medium text-slate-600">Total Audits</span>
              <BarChart3 className="w-5 h-5 text-blue-600" />
            </div>
            <p className="text-3xl font-bold">{audits.length}</p>
            <p className="text-xs text-slate-500 mt-1">All time</p>
          </CardContent>
        </Card>

        <Card className="shadow-lg">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-medium text-slate-600">Average Score</span>
              <Award className="w-5 h-5 text-blue-600" />
            </div>
            <p className={`text-3xl font-bold ${getScoreColor(avgScores.overall)}`}>
              {avgScores.overall}
            </p>
            <p className="text-xs text-slate-500 mt-1">Across all audits</p>
          </CardContent>
        </Card>

        <Card className="shadow-lg">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-medium text-slate-600">Latest Score</span>
              <TrendingUp className="w-5 h-5 text-blue-600" />
            </div>
            <p className={`text-3xl font-bold ${getScoreColor(latestAudit?.overallScore || 0)}`}>
              {latestAudit?.overallScore || 0}
            </p>
            {improvement !== 0 && (
              <p className={`text-xs mt-1 flex items-center gap-1 ${improvement > 0 ? 'text-green-600' : 'text-red-600'}`}>
                {improvement > 0 ? 'â†‘' : 'â†“'} {Math.abs(improvement)} from previous
              </p>
            )}
          </CardContent>
        </Card>

        <Card className="shadow-lg">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-medium text-slate-600">Websites Tracked</span>
              <ExternalLink className="w-5 h-5 text-blue-600" />
            </div>
            <p className="text-3xl font-bold">{uniqueUrls.length - 1}</p>
            <p className="text-xs text-slate-500 mt-1">Unique domains</p>
          </CardContent>
        </Card>
      </div>

      {/* Filter */}
      {uniqueUrls.length > 2 && (
        <Card className="shadow-lg">
          <CardContent className="py-4">
            <div className="flex items-center gap-3">
              <Filter className="w-5 h-5 text-slate-600" />
              <span className="font-medium text-sm">Filter by website:</span>
              <div className="flex flex-wrap gap-2">
                {uniqueUrls.map(url => (
                  <button
                    key={url}
                    onClick={() => setFilterUrl(url)}
                    className={`px-4 py-1.5 rounded-full text-sm font-medium transition-all ${
                      filterUrl === url
                        ? 'bg-blue-600 text-white'
                        : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
                    }`}
                  >
                    {url === 'all' ? 'All Websites' : url.replace('https://', '').replace('http://', '').split('/')[0]}
                  </button>
                ))}
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Charts Section */}
      <Tabs defaultValue="timeline" className="space-y-6">
        <TabsList className="grid w-full max-w-md grid-cols-2">
          <TabsTrigger value="timeline">Score Timeline</TabsTrigger>
          <TabsTrigger value="comparison">Category Comparison</TabsTrigger>
        </TabsList>

        <TabsContent value="timeline" className="space-y-6">
          <Card className="shadow-lg">
            <CardHeader>
              <CardTitle>Score Progress Over Time</CardTitle>
              <CardDescription>
                Track how your website scores have improved across all categories
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="h-80">
                <ResponsiveContainer width="100%" height="100%">
                  <LineChart data={chartData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="date" />
                    <YAxis domain={[0, 100]} />
                    <Tooltip />
                    <Legend />
                    <Line type="monotone" dataKey="overall" stroke="#2563eb" strokeWidth={3} name="Overall" />
                    <Line type="monotone" dataKey="seo" stroke="#10b981" strokeWidth={2} name="SEO" />
                    <Line type="monotone" dataKey="performance" stroke="#f59e0b" strokeWidth={2} name="Performance" />
                    <Line type="monotone" dataKey="mobile" stroke="#8b5cf6" strokeWidth={2} name="Mobile" />
                    <Line type="monotone" dataKey="security" stroke="#ef4444" strokeWidth={2} name="Security" />
                  </LineChart>
                </ResponsiveContainer>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="comparison" className="space-y-6">
          <div className="grid md:grid-cols-2 gap-6">
            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle>Latest Audit Breakdown</CardTitle>
                <CardDescription>
                  Scores across all categories from your most recent audit
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="h-80 flex items-center justify-center">
                  <ResponsiveContainer width="100%" height="100%">
                    <RadarChart data={radarData}>
                      <PolarGrid />
                      <PolarAngleAxis dataKey="category" />
                      <PolarRadiusAxis domain={[0, 100]} />
                      <Radar name="Score" dataKey="score" stroke="#2563eb" fill="#3b82f6" fillOpacity={0.6} />
                    </RadarChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>

            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle>Average Scores by Category</CardTitle>
                <CardDescription>
                  Your average performance across all audits
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="h-80">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart
                      data={[
                        { category: 'SEO', score: avgScores.seo },
                        { category: 'Performance', score: avgScores.performance },
                        { category: 'Mobile', score: avgScores.mobile },
                        { category: 'Security', score: avgScores.security },
                      ]}
                    >
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="category" />
                      <YAxis domain={[0, 100]} />
                      <Tooltip />
                      <Bar dataKey="score" fill="#3b82f6" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>
      </Tabs>

      {/* Audit History List */}
      <Card className="shadow-lg">
        <CardHeader>
          <CardTitle>Audit History</CardTitle>
          <CardDescription>
            All your website audits sorted by most recent
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {filteredAudits.map((audit, index) => (
              <motion.div
                key={audit.id}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: index * 0.05 }}
                className="p-6 rounded-lg border-2 border-slate-200 hover:border-blue-300 transition-all hover:shadow-md"
              >
                <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                  <div className="flex-1">
                    <div className="flex items-start gap-3 mb-3">
                      <div className={`w-16 h-16 rounded-lg border-2 flex items-center justify-center flex-shrink-0 ${getScoreBgColor(audit.overallScore)}`}>
                        <span className={`text-2xl font-bold ${getScoreColor(audit.overallScore)}`}>
                          {audit.overallScore}
                        </span>
                      </div>
                      <div className="flex-1 min-w-0">
                        <h3 className="font-semibold text-lg mb-1 truncate">{audit.websiteUrl}</h3>
                        <div className="flex items-center gap-2 text-sm text-slate-600">
                          <Clock className="w-4 h-4" />
                          <span>{format(new Date(audit.createdAt), 'MMM d, yyyy â€¢ h:mm a')}</span>
                        </div>
                        <Badge variant="outline" className="mt-2">
                          {getScoreLabel(audit.overallScore)}
                        </Badge>
                      </div>
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                      <div>
                        <div className="flex items-center gap-1 mb-1">
                          <Search className="w-4 h-4 text-slate-500" />
                          <span className="text-xs text-slate-600">SEO</span>
                        </div>
                        <p className={`text-xl font-bold ${getScoreColor(audit.seoScore)}`}>
                          {audit.seoScore}
                        </p>
                      </div>
                      <div>
                        <div className="flex items-center gap-1 mb-1">
                          <Zap className="w-4 h-4 text-slate-500" />
                          <span className="text-xs text-slate-600">Performance</span>
                        </div>
                        <p className={`text-xl font-bold ${getScoreColor(audit.performanceScore)}`}>
                          {audit.performanceScore}
                        </p>
                      </div>
                      <div>
                        <div className="flex items-center gap-1 mb-1">
                          <Smartphone className="w-4 h-4 text-slate-500" />
                          <span className="text-xs text-slate-600">Mobile</span>
                        </div>
                        <p className={`text-xl font-bold ${getScoreColor(audit.mobileScore)}`}>
                          {audit.mobileScore}
                        </p>
                      </div>
                      <div>
                        <div className="flex items-center gap-1 mb-1">
                          <Shield className="w-4 h-4 text-slate-500" />
                          <span className="text-xs text-slate-600">Security</span>
                        </div>
                        <p className={`text-xl font-bold ${getScoreColor(audit.securityScore)}`}>
                          {audit.securityScore}
                        </p>
                      </div>
                    </div>
                  </div>

                  <div className="flex lg:flex-col gap-2">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => handleViewDetails(audit)}
                      className="flex-1 lg:flex-none"
                    >
                      <Eye className="w-4 h-4 mr-2" />
                      View Details
                    </Button>
                    <Button
                      variant="default"
                      size="sm"
                      onClick={() => handleRerun(audit.websiteUrl)}
                      className="flex-1 lg:flex-none bg-blue-600 hover:bg-blue-700"
                    >
                      <RefreshCw className="w-4 h-4 mr-2" />
                      Re-run
                    </Button>
                  </div>
                </div>
              </motion.div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Details Dialog */}
      <Dialog open={detailsOpen} onOpenChange={setDetailsOpen}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="text-2xl">Audit Details</DialogTitle>
            <DialogDescription>
              {selectedAudit?.websiteUrl} â€¢ {selectedAudit && format(new Date(selectedAudit.createdAt), 'MMM d, yyyy â€¢ h:mm a')}
            </DialogDescription>
          </DialogHeader>

          {selectedAudit && (
            <div className="space-y-6 mt-4">
              {/* Overall Score */}
              <div className="text-center p-6 bg-gradient-to-br from-blue-50 to-purple-50 rounded-lg">
                <h3 className="text-sm font-medium text-slate-600 mb-2">Overall Score</h3>
                <p className={`text-5xl font-bold ${getScoreColor(selectedAudit.overallScore)}`}>
                  {selectedAudit.overallScore}
                </p>
                <Badge variant="outline" className="mt-2">
                  {getScoreLabel(selectedAudit.overallScore)}
                </Badge>
              </div>

              {/* Category Scores */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {[
                  { label: 'SEO', score: selectedAudit.seoScore, icon: Search },
                  { label: 'Performance', score: selectedAudit.performanceScore, icon: Zap },
                  { label: 'Mobile', score: selectedAudit.mobileScore, icon: Smartphone },
                  { label: 'Security', score: selectedAudit.securityScore, icon: Shield },
                ].map((category) => (
                  <div key={category.label} className="p-4 bg-slate-50 rounded-lg">
                    <div className="flex items-center gap-2 mb-2">
                      <category.icon className="w-4 h-4 text-slate-600" />
                      <span className="text-sm font-medium text-slate-600">{category.label}</span>
                    </div>
                    <p className={`text-3xl font-bold ${getScoreColor(category.score)}`}>
                      {category.score}
                    </p>
                    <Progress value={category.score} className="h-2 mt-2" />
                  </div>
                ))}
              </div>

              {/* Issues & Recommendations */}
              <Tabs defaultValue="issues" className="w-full">
                <TabsList className="grid w-full grid-cols-2">
                  <TabsTrigger value="issues">Issues Found</TabsTrigger>
                  <TabsTrigger value="recommendations">Recommendations</TabsTrigger>
                </TabsList>

                <TabsContent value="issues" className="space-y-3 mt-4">
                  {(() => {
                    try {
                      const issues = JSON.parse(selectedAudit.issues);
                      const allIssues = [
                        ...(issues.critical || []).map((i: string) => ({ type: 'critical', text: i })),
                        ...(issues.warnings || []).map((i: string) => ({ type: 'warning', text: i })),
                      ];

                      if (allIssues.length === 0) {
                        return (
                          <div className="text-center py-8 text-slate-600">
                            <CheckCircle2 className="w-12 h-12 mx-auto mb-2 text-green-600" />
                            <p>No critical issues found!</p>
                          </div>
                        );
                      }

                      return allIssues.map((issue, index) => (
                        <div
                          key={index}
                          className={`flex gap-3 p-4 rounded-lg border ${
                            issue.type === 'critical'
                              ? 'bg-red-50 border-red-200'
                              : 'bg-yellow-50 border-yellow-200'
                          }`}
                        >
                          {issue.type === 'critical' ? (
                            <XCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                          ) : (
                            <AlertCircle className="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" />
                          )}
                          <p className="text-sm text-slate-700">{issue.text}</p>
                        </div>
                      ));
                    } catch (e) {
                      return <p className="text-sm text-slate-600">No issues data available</p>;
                    }
                  })()}
                </TabsContent>

                <TabsContent value="recommendations" className="space-y-3 mt-4">
                  {(() => {
                    try {
                      const recommendations = JSON.parse(selectedAudit.recommendations);
                      
                      if (!recommendations || recommendations.length === 0) {
                        return (
                          <div className="text-center py-8 text-slate-600">
                            <p>No recommendations available</p>
                          </div>
                        );
                      }

                      return recommendations.map((rec: any, index: number) => (
                        <div key={index} className="p-4 rounded-lg border-2 border-slate-200">
                          <div className="flex items-start justify-between mb-2">
                            <Badge variant={
                              rec.priority === 'high' ? 'destructive' :
                              rec.priority === 'medium' ? 'default' :
                              'secondary'
                            }>
                              {rec.priority} priority
                            </Badge>
                            <span className="text-xs text-slate-600">{rec.category}</span>
                          </div>
                          <h4 className="font-semibold mb-1">{rec.issue}</h4>
                          <p className="text-sm text-slate-600">{rec.solution}</p>
                        </div>
                      ));
                    } catch (e) {
                      return <p className="text-sm text-slate-600">No recommendations data available</p>;
                    }
                  })()}
                </TabsContent>
              </Tabs>

              {/* Actions */}
              <div className="flex gap-3 pt-4 border-t">
                <Button
                  className="flex-1 bg-blue-600 hover:bg-blue-700"
                  onClick={() => {
                    setDetailsOpen(false);
                    handleRerun(selectedAudit.websiteUrl);
                  }}
                >
                  <RefreshCw className="w-4 h-4 mr-2" />
                  Run New Audit
                </Button>
                <Button
                  variant="outline"
                  className="flex-1"
                  onClick={() => window.open(selectedAudit.websiteUrl, '_blank')}
                >
                  <ExternalLink className="w-4 h-4 mr-2" />
                  Visit Website
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}

// ==========================================
// File: app/dashboard/audits/new/new-audit-client.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useRouter } from 'next/navigation';
import { 
  Search, 
  CheckCircle2, 
  XCircle, 
  AlertCircle, 
  TrendingUp, 
  Smartphone, 
  Shield, 
  Zap,
  Target,
  Globe,
  ArrowRight,
  Award,
  BarChart3,
  RefreshCw,
  Save,
  Sparkles,
  ArrowLeft
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { toast } from 'react-hot-toast';
import Link from 'next/link';

interface AuditResult {
  overall_score: number;
  seo_score: number;
  performance_score: number;
  mobile_score: number;
  security_score: number;
  findings: {
    critical: string[];
    warnings: string[];
    good: string[];
  };
  recommendations: {
    category: string;
    priority: 'high' | 'medium' | 'low';
    issue: string;
    solution: string;
    estimatedImpact: string;
  }[];
  suggestedServices: {
    name: string;
    reason: string;
    price: string;
    slug: string;
  }[];
}

export function NewAuditClient({ user }: { user: any }) {
  const router = useRouter();
  const [step, setStep] = useState<'input' | 'analyzing' | 'results'>('input');
  const [websiteUrl, setWebsiteUrl] = useState('');
  const [goals, setGoals] = useState<string[]>([]);
  const [auditResult, setAuditResult] = useState<AuditResult | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  // Pre-fill URL from query params if available
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const params = new URLSearchParams(window.location.search);
      const urlParam = params.get('url');
      if (urlParam) {
        setWebsiteUrl(decodeURIComponent(urlParam));
      }
    }
  }, []);

  const goalOptions = [
    { id: 'increase-traffic', label: 'Increase Website Traffic', icon: TrendingUp },
    { id: 'improve-seo', label: 'Improve SEO Ranking', icon: Search },
    { id: 'generate-leads', label: 'Generate More Leads', icon: Target },
    { id: 'boost-sales', label: 'Boost Online Sales', icon: BarChart3 },
    { id: 'mobile-optimization', label: 'Mobile Optimization', icon: Smartphone },
    { id: 'faster-loading', label: 'Faster Load Times', icon: Zap },
  ];

  const handleGoalToggle = (goalId: string) => {
    setGoals(prev =>
      prev.includes(goalId)
        ? prev.filter(g => g !== goalId)
        : [...prev, goalId]
    );
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!websiteUrl) {
      toast.error('Please enter a website URL');
      return;
    }

    setIsLoading(true);
    setStep('analyzing');

    try {
      const response = await fetch('/api/auditor/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          websiteUrl,
          email: user.email,
          name: user.name,
          goals,
          userId: user.id,
          isAuthenticated: true
        }),
      });

      if (!response.ok) throw new Error('Audit failed');

      const result = await response.json();
      setAuditResult(result.audit);
      setStep('results');
      toast.success('Audit complete! Results have been saved.');
    } catch (error) {
      console.error('Audit error:', error);
      toast.error('Failed to complete audit. Please try again.');
      setStep('input');
    } finally {
      setIsLoading(false);
    }
  };

  const getScoreColor = (score: number) => {
    if (score >= 80) return 'text-green-600';
    if (score >= 60) return 'text-yellow-600';
    return 'text-red-600';
  };

  const getScoreLabel = (score: number) => {
    if (score >= 80) return 'Excellent';
    if (score >= 60) return 'Good';
    if (score >= 40) return 'Needs Improvement';
    return 'Critical';
  };

  return (
    <div className="space-y-6 pb-8">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <div className="flex items-center gap-3 mb-2">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => router.push('/dashboard/audits')}
            >
              <ArrowLeft className="w-4 h-4 mr-2" />
              Back to Audits
            </Button>
          </div>
          <h1 className="text-3xl font-bold">New Website Audit</h1>
          <p className="text-slate-600 mt-1">
            Analyze your website's performance and get actionable insights
          </p>
        </div>
      </div>

      {/* Main Content */}
      <AnimatePresence mode="wait">
        {step === 'input' && (
          <motion.div
            key="input"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
          >
            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle className="text-xl">Website Information</CardTitle>
                <CardDescription>
                  Enter the website URL you want to audit
                </CardDescription>
              </CardHeader>
              
              <CardContent>
                <form onSubmit={handleSubmit} className="space-y-6">
                  {/* Website URL */}
                  <div className="space-y-2">
                    <Label htmlFor="websiteUrl" className="text-base font-semibold">
                      Website URL <span className="text-red-500">*</span>
                    </Label>
                    <div className="relative">
                      <Globe className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
                      <Input
                        id="websiteUrl"
                        type="url"
                        placeholder="https://yourwebsite.com"
                        value={websiteUrl}
                        onChange={(e) => setWebsiteUrl(e.target.value)}
                        className="pl-11 h-12 text-base"
                        required
                      />
                    </div>
                  </div>

                  {/* Goals */}
                  <div className="space-y-3">
                    <Label className="text-base font-semibold">
                      What are your main goals? (Optional)
                    </Label>
                    <div className="grid sm:grid-cols-2 gap-3">
                      {goalOptions.map((goal) => (
                        <button
                          key={goal.id}
                          type="button"
                          onClick={() => handleGoalToggle(goal.id)}
                          className={`flex items-center gap-3 p-4 rounded-lg border-2 transition-all ${
                            goals.includes(goal.id)
                              ? 'border-blue-600 bg-blue-50'
                              : 'border-slate-200 hover:border-slate-300 bg-white'
                          }`}
                        >
                          <goal.icon className={`w-5 h-5 ${
                            goals.includes(goal.id) ? 'text-blue-600' : 'text-slate-400'
                          }`} />
                          <span className={`text-sm font-medium ${
                            goals.includes(goal.id) ? 'text-blue-900' : 'text-slate-700'
                          }`}>
                            {goal.label}
                          </span>
                        </button>
                      ))}
                    </div>
                  </div>

                  <div className="flex gap-3">
                    <Button
                      type="button"
                      variant="outline"
                      onClick={() => router.push('/dashboard/audits')}
                      className="flex-1"
                    >
                      Cancel
                    </Button>
                    <Button 
                      type="submit" 
                      className="flex-1 bg-gradient-to-r from-blue-600 to-blue-700"
                      disabled={isLoading}
                    >
                      {isLoading ? (
                        <>
                          <RefreshCw className="w-5 h-5 mr-2 animate-spin" />
                          Analyzing...
                        </>
                      ) : (
                        <>
                          Start Audit
                          <ArrowRight className="w-5 h-5 ml-2" />
                        </>
                      )}
                    </Button>
                  </div>
                </form>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {step === 'analyzing' && (
          <motion.div
            key="analyzing"
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.95 }}
          >
            <Card className="shadow-lg">
              <CardContent className="py-16">
                <div className="text-center space-y-6">
                  <div className="relative w-24 h-24 mx-auto">
                    <div className="absolute inset-0 bg-blue-600 rounded-full animate-ping opacity-20"></div>
                    <div className="relative w-24 h-24 bg-gradient-to-br from-blue-600 to-blue-700 rounded-full flex items-center justify-center">
                      <Search className="w-12 h-12 text-white animate-pulse" />
                    </div>
                  </div>
                  
                  <div>
                    <h3 className="text-2xl font-bold mb-2">Analyzing Your Website...</h3>
                    <p className="text-slate-600">This will only take a moment</p>
                  </div>

                  <div className="max-w-md mx-auto space-y-3">
                    {[
                      'Checking SEO optimization',
                      'Testing page speed & performance',
                      'Analyzing mobile responsiveness',
                      'Scanning security vulnerabilities',
                      'Generating recommendations',
                    ].map((text, index) => (
                      <motion.div
                        key={index}
                        initial={{ opacity: 0, x: -20 }}
                        animate={{ opacity: 1, x: 0 }}
                        transition={{ delay: index * 0.3 }}
                        className="flex items-center gap-3 text-left"
                      >
                        <CheckCircle2 className="w-5 h-5 text-green-600 flex-shrink-0" />
                        <span className="text-slate-700">{text}</span>
                      </motion.div>
                    ))}
                  </div>
                </div>
              </CardContent>
            </Card>
          </motion.div>
        )}

        {step === 'results' && auditResult && (
          <motion.div
            key="results"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="space-y-6"
          >
            {/* Success Banner */}
            <Card className="shadow-lg border-2 border-green-400 bg-gradient-to-r from-green-50 to-emerald-50">
              <CardContent className="py-4">
                <div className="flex items-center gap-3">
                  <Save className="w-6 h-6 text-green-600" />
                  <div>
                    <p className="font-semibold text-green-900">
                      Audit Complete!
                    </p>
                    <p className="text-sm text-green-700">
                      Results have been saved to your audit history
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Overall Score */}
            <Card className="shadow-lg bg-gradient-to-br from-blue-600 to-blue-700 text-white">
              <CardContent className="pt-8 pb-8">
                <div className="text-center">
                  <h2 className="text-2xl font-bold mb-2">Overall Website Score</h2>
                  <div className="relative w-40 h-40 mx-auto mb-4">
                    <svg className="w-full h-full transform -rotate-90">
                      <circle
                        cx="80"
                        cy="80"
                        r="70"
                        stroke="rgba(255,255,255,0.2)"
                        strokeWidth="12"
                        fill="none"
                      />
                      <circle
                        cx="80"
                        cy="80"
                        r="70"
                        stroke="white"
                        strokeWidth="12"
                        fill="none"
                        strokeDasharray={`${2 * Math.PI * 70}`}
                        strokeDashoffset={`${2 * Math.PI * 70 * (1 - auditResult.overall_score / 100)}`}
                        strokeLinecap="round"
                      />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center">
                      <div>
                        <div className="text-5xl font-bold">{auditResult.overall_score}</div>
                        <div className="text-sm opacity-90">out of 100</div>
                      </div>
                    </div>
                  </div>
                  <p className="text-xl opacity-90">
                    {getScoreLabel(auditResult.overall_score)}
                  </p>
                </div>
              </CardContent>
            </Card>

            {/* Category Scores */}
            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle>Detailed Breakdown</CardTitle>
                <CardDescription>Performance across all categories</CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                {[
                  { label: 'SEO Optimization', score: auditResult.seo_score, icon: Search },
                  { label: 'Performance & Speed', score: auditResult.performance_score, icon: Zap },
                  { label: 'Mobile Experience', score: auditResult.mobile_score, icon: Smartphone },
                  { label: 'Security', score: auditResult.security_score, icon: Shield },
                ].map((category, index) => (
                  <div key={index} className="space-y-2">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <category.icon className="w-5 h-5 text-slate-600" />
                        <span className="font-medium">{category.label}</span>
                      </div>
                      <span className={`text-2xl font-bold ${getScoreColor(category.score)}`}>
                        {category.score}
                      </span>
                    </div>
                    <Progress value={category.score} className="h-3" />
                  </div>
                ))}
              </CardContent>
            </Card>

            {/* Findings */}
            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle>Key Findings</CardTitle>
              </CardHeader>
              <CardContent>
                <Tabs defaultValue="critical" className="w-full">
                  <TabsList className="grid w-full grid-cols-3">
                    <TabsTrigger value="critical" className="gap-2">
                      <XCircle className="w-4 h-4" />
                      Critical ({auditResult.findings.critical.length})
                    </TabsTrigger>
                    <TabsTrigger value="warnings" className="gap-2">
                      <AlertCircle className="w-4 h-4" />
                      Warnings ({auditResult.findings.warnings.length})
                    </TabsTrigger>
                    <TabsTrigger value="good" className="gap-2">
                      <CheckCircle2 className="w-4 h-4" />
                      Good ({auditResult.findings.good.length})
                    </TabsTrigger>
                  </TabsList>
                  
                  <TabsContent value="critical" className="space-y-3 mt-4">
                    {auditResult.findings.critical.length === 0 ? (
                      <p className="text-center text-slate-600 py-8">No critical issues found!</p>
                    ) : (
                      auditResult.findings.critical.map((finding, index) => (
                        <div key={index} className="flex gap-3 p-4 bg-red-50 rounded-lg border border-red-200">
                          <XCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                          <p className="text-sm text-slate-700">{finding}</p>
                        </div>
                      ))
                    )}
                  </TabsContent>
                  
                  <TabsContent value="warnings" className="space-y-3 mt-4">
                    {auditResult.findings.warnings.length === 0 ? (
                      <p className="text-center text-slate-600 py-8">No warnings found!</p>
                    ) : (
                      auditResult.findings.warnings.map((finding, index) => (
                        <div key={index} className="flex gap-3 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                          <AlertCircle className="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" />
                          <p className="text-sm text-slate-700">{finding}</p>
                        </div>
                      ))
                    )}
                  </TabsContent>
                  
                  <TabsContent value="good" className="space-y-3 mt-4">
                    {auditResult.findings.good.length === 0 ? (
                      <p className="text-center text-slate-600 py-8">No positive findings yet</p>
                    ) : (
                      auditResult.findings.good.map((finding, index) => (
                        <div key={index} className="flex gap-3 p-4 bg-green-50 rounded-lg border border-green-200">
                          <CheckCircle2 className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
                          <p className="text-sm text-slate-700">{finding}</p>
                        </div>
                      ))
                    )}
                  </TabsContent>
                </Tabs>
              </CardContent>
            </Card>

            {/* Recommendations */}
            <Card className="shadow-lg">
              <CardHeader>
                <CardTitle>Personalized Recommendations</CardTitle>
                <CardDescription>Action items to improve your website</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                {auditResult.recommendations.map((rec, index) => (
                  <div key={index} className="p-5 rounded-lg border-2 border-slate-200 hover:border-blue-300 transition-colors">
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center gap-2">
                        <Badge variant={
                          rec.priority === 'high' ? 'destructive' :
                          rec.priority === 'medium' ? 'default' :
                          'secondary'
                        }>
                          {rec.priority} priority
                        </Badge>
                        <span className="text-sm font-medium text-slate-600">{rec.category}</span>
                      </div>
                      <Badge variant="outline" className="text-green-700 border-green-300">
                        {rec.estimatedImpact} impact
                      </Badge>
                    </div>
                    <h4 className="font-semibold text-lg mb-2">{rec.issue}</h4>
                    <p className="text-slate-600">{rec.solution}</p>
                  </div>
                ))}
              </CardContent>
            </Card>

            {/* Actions */}
            <div className="flex gap-3">
              <Button
                onClick={() => {
                  setStep('input');
                  setWebsiteUrl('');
                  setGoals([]);
                  setAuditResult(null);
                }}
                variant="outline"
                className="flex-1"
              >
                <RefreshCw className="w-4 h-4 mr-2" />
                Run Another Audit
              </Button>
              <Button
                onClick={() => router.push('/dashboard/audits')}
                className="flex-1 bg-gradient-to-r from-blue-600 to-blue-700"
              >
                View All Audits
                <ArrowRight className="w-4 h-4 ml-2" />
              </Button>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

// ==========================================
// File: app/dashboard/audits/new/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { NewAuditClient } from "./new-audit-client";

export const metadata = {
  title: "New Website Audit | CDM Suite Dashboard",
  description: "Run a new website audit from your dashboard",
};

export default async function NewAuditPage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  return <NewAuditClient user={user} />;
}

// ==========================================
// File: app/dashboard/audits/page.tsx
// ==========================================



import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { AuditsClient } from "./audits-client";

export const metadata = {
  title: "Website Audits | CDM Suite",
  description: "View your website audit history and track improvements over time",
};

export default async function AuditsPage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  return <AuditsClient user={user} />;
}

// ==========================================
// File: app/dashboard/bid-proposals/new/page.tsx
// ==========================================


'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { ArrowLeft, Upload, File, X, Loader2, CheckCircle, FileText, Mail, FileSpreadsheet, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';
import Link from 'next/link';

export default function NewBidProposalPage() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [rfpFiles, setRfpFiles] = useState<File[]>([]);
  const [emailFiles, setEmailFiles] = useState<File[]>([]);
  const [processing, setProcessing] = useState(false);
  const [extractionStatus, setExtractionStatus] = useState<'idle' | 'uploading' | 'extracting' | 'generating' | 'complete'>('idle');


  const handleRfpFilesChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      const newFiles = Array.from(e.target.files);
      setRfpFiles((prev) => [...prev, ...newFiles]);
    }
  };

  const handleEmailFilesChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      const newFiles = Array.from(e.target.files);
      setEmailFiles((prev) => [...prev, ...newFiles]);
    }
  };

  const removeRfpFile = (index: number) => {
    setRfpFiles((prev) => prev.filter((_, i) => i !== index));
  };

  const removeEmailFile = (index: number) => {
    setEmailFiles((prev) => prev.filter((_, i) => i !== index));
  };

  const formatFileSize = (bytes: number): string => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  };

  const getFileIcon = (fileName: string) => {
    const lowerName = fileName.toLowerCase();
    if (lowerName.endsWith('.eml') || lowerName.endsWith('.msg') || lowerName.includes('email')) {
      return <Mail className="h-5 w-5 flex-shrink-0 text-blue-600" />;
    } else if (lowerName.endsWith('.pdf')) {
      return <FileText className="h-5 w-5 flex-shrink-0 text-red-600" />;
    } else if (lowerName.endsWith('.doc') || lowerName.endsWith('.docx')) {
      return <FileSpreadsheet className="h-5 w-5 flex-shrink-0 text-blue-500" />;
    }
    return <File className="h-5 w-5 flex-shrink-0 text-primary" />;
  };

  const getFileTypeLabel = (fileName: string): string => {
    const lowerName = fileName.toLowerCase();
    if (lowerName.endsWith('.eml') || lowerName.endsWith('.msg') || lowerName.includes('email')) {
      return 'Email';
    } else if (lowerName.endsWith('.pdf')) {
      return 'PDF Document';
    } else if (lowerName.endsWith('.doc') || lowerName.endsWith('.docx')) {
      return 'Word Document';
    }
    return 'Document';
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    const totalFiles = rfpFiles.length + emailFiles.length;
    if (totalFiles === 0) {
      toast.error('Please upload at least one document (RFP or email)');
      return;
    }

    if (rfpFiles.length === 0) {
      toast.error('Please upload at least one RFP document');
      return;
    }

    setLoading(true);
    setProcessing(true);
    setExtractionStatus('uploading');
    
    try {
      // Create FormData for file uploads
      const formDataToSend = new FormData();
      
      // Add RFP files with 'rfpFiles' key
      rfpFiles.forEach((file) => {
        formDataToSend.append('rfpFiles', file);
      });
      
      // Add email files with 'emailFiles' key
      emailFiles.forEach((file) => {
        formDataToSend.append('emailFiles', file);
      });

      setExtractionStatus('extracting');
      toast.info('AI is analyzing your documents... This may take a few minutes for large files.');

      // Create an abort controller with a 5-minute timeout
      const abortController = new AbortController();
      const timeoutId = setTimeout(() => {
        abortController.abort();
      }, 300000); // 5 minutes

      try {
        const res = await fetch('/api/bid-proposals/extract', {
          method: 'POST',
          body: formDataToSend,
          signal: abortController.signal,
        });

        clearTimeout(timeoutId);

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to create bid proposal');
        }

        const data = await res.json();
        
        setExtractionStatus('complete');
        toast.success('Bid proposal created successfully! Generating proposals...');
        
        // Redirect to the bid proposal detail page
        router.push(`/dashboard/bid-proposals/${data.id}`);
      } catch (fetchError) {
        clearTimeout(timeoutId);
        throw fetchError;
      }
    } catch (error) {
      console.error('Error creating bid proposal:', error);
      
      // Handle specific error types
      if (error instanceof Error) {
        if (error.name === 'AbortError') {
          toast.error('Request timed out. Please try uploading smaller files or fewer files at once.');
        } else {
          toast.error(error.message);
        }
      } else {
        toast.error('Failed to create bid proposal');
      }
      
      setExtractionStatus('idle');
    } finally {
      setLoading(false);
      setProcessing(false);
    }
  };

  return (
    <div className="container mx-auto py-6 max-w-4xl">
      {/* Header */}
      <div className="mb-6">
        <Link href="/dashboard/bid-proposals">
          <Button variant="ghost" size="sm">
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back to Bid Proposals
          </Button>
        </Link>
      </div>

      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold">Create New Bid Proposal</h1>
          <p className="text-muted-foreground mt-2">
            Upload your RFP documents, emails, and related files. Our AI will automatically extract all information and generate your proposals.
          </p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-6">
          {/* RFP Documents Upload */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <FileText className="h-5 w-5" />
                1. Upload RFP Documents
              </CardTitle>
              <CardDescription>
                Upload the main RFP documents, specifications, and requirements
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              {/* Upload Area */}
              <div className="relative border-2 border-dashed rounded-lg p-8 text-center hover:border-primary transition-colors">
                <Upload className="h-12 w-12 mx-auto mb-4 text-muted-foreground" />
                <div className="space-y-2">
                  <p className="text-sm font-medium">
                    Drag and drop RFP files here, or click to browse
                  </p>
                  <p className="text-xs text-muted-foreground">
                    PDF, Word docs, images
                  </p>
                </div>
                <input
                  type="file"
                  multiple
                  accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg"
                  onChange={handleRfpFilesChange}
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />
              </div>

              {/* Uploaded RFP Files */}
              {rfpFiles.length > 0 && (
                <div className="space-y-2">
                  <h4 className="text-sm font-medium">RFP Documents ({rfpFiles.length})</h4>
                  <div className="space-y-2">
                    {rfpFiles.map((file, index) => (
                      <div
                        key={index}
                        className="flex items-center justify-between p-3 rounded-lg border bg-muted"
                      >
                        <div className="flex items-center gap-3 flex-1 min-w-0">
                          {getFileIcon(file.name)}
                          <div className="flex-1 min-w-0">
                            <p className="text-sm font-medium truncate">{file.name}</p>
                            <p className="text-xs text-muted-foreground">
                              {getFileTypeLabel(file.name)} â€¢ {formatFileSize(file.size)}
                            </p>
                          </div>
                        </div>
                        <Button
                          type="button"
                          variant="ghost"
                          size="sm"
                          onClick={() => removeRfpFile(index)}
                          disabled={loading}
                        >
                          <X className="h-4 w-4" />
                        </Button>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Email Correspondence Upload - Prominent and Separate */}
          <Card className="border-2 border-blue-200 dark:border-blue-900 bg-gradient-to-br from-blue-50/50 to-transparent dark:from-blue-950/20">
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-blue-900 dark:text-blue-100">
                <Mail className="h-5 w-5" />
                2. Upload Email Correspondence (Optional but Recommended)
              </CardTitle>
              <CardDescription>
                Upload any preliminary emails, questions, or correspondence related to this bid. This helps the AI understand the context and match the tone of your proposal to previous communications.
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4 flex items-start gap-3">
                <AlertCircle className="h-5 w-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                <div className="text-sm text-blue-900 dark:text-blue-100 space-y-1">
                  <p className="font-semibold">Why upload emails?</p>
                  <ul className="text-xs space-y-1 ml-4 list-disc">
                    <li>AI learns the tone and style of previous communications</li>
                    <li>Better understanding of client expectations and concerns</li>
                    <li>More personalized and contextual proposals</li>
                  </ul>
                </div>
              </div>

              {/* Email Upload Area */}
              <div className="relative border-2 border-dashed border-blue-300 dark:border-blue-700 rounded-lg p-8 text-center hover:border-blue-500 transition-colors bg-white dark:bg-gray-950">
                <Mail className="h-12 w-12 mx-auto mb-4 text-blue-600 dark:text-blue-400" />
                <div className="space-y-2">
                  <p className="text-sm font-medium text-blue-900 dark:text-blue-100">
                    Drop email files here, or click to upload
                  </p>
                  <p className="text-xs text-muted-foreground">
                    Email files (.eml, .msg), PDFs of emails, or text files
                  </p>
                </div>
                <input
                  type="file"
                  multiple
                  accept=".eml,.msg,.pdf,.txt"
                  onChange={handleEmailFilesChange}
                  className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />
              </div>

              {/* Uploaded Email Files */}
              {emailFiles.length > 0 && (
                <div className="space-y-2">
                  <h4 className="text-sm font-medium text-blue-900 dark:text-blue-100">Email Files ({emailFiles.length})</h4>
                  <div className="space-y-2">
                    {emailFiles.map((file, index) => (
                      <div
                        key={index}
                        className="flex items-center justify-between p-3 rounded-lg border border-blue-200 dark:border-blue-800 bg-blue-50 dark:bg-blue-950/30"
                      >
                        <div className="flex items-center gap-3 flex-1 min-w-0">
                          <Mail className="h-5 w-5 flex-shrink-0 text-blue-600 dark:text-blue-400" />
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              <p className="text-sm font-medium truncate text-blue-900 dark:text-blue-100">{file.name}</p>
                              <span className="text-xs bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 px-2 py-0.5 rounded-full">
                                Email
                              </span>
                            </div>
                            <p className="text-xs text-muted-foreground">
                              {getFileTypeLabel(file.name)} â€¢ {formatFileSize(file.size)}
                            </p>
                          </div>
                        </div>
                        <Button
                          type="button"
                          variant="ghost"
                          size="sm"
                          onClick={() => removeEmailFile(index)}
                          disabled={loading}
                        >
                          <X className="h-4 w-4" />
                        </Button>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </CardContent>
          </Card>

          {/* Processing Status */}
          {processing && (
            <Card className="bg-primary/10 border-primary/20">
              <CardContent className="pt-6">
                <div className="flex items-center gap-3">
                  {extractionStatus === 'complete' ? (
                    <CheckCircle className="h-5 w-5 text-green-600" />
                  ) : (
                    <Loader2 className="h-5 w-5 animate-spin text-primary" />
                  )}
                  <div className="flex-1">
                    <p className="text-sm font-medium">
                      {extractionStatus === 'uploading' && 'Uploading files...'}
                      {extractionStatus === 'extracting' && 'AI is analyzing documents and extracting bid information...'}
                      {extractionStatus === 'generating' && 'Generating technical and cost proposals...'}
                      {extractionStatus === 'complete' && 'Complete! Redirecting...'}
                    </p>
                    <p className="text-xs text-muted-foreground mt-1">
                      This may take 30-60 seconds depending on document size
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Actions */}
          <div className="flex flex-col sm:flex-row justify-between items-center gap-3">
            <div className="text-sm text-muted-foreground">
              {rfpFiles.length > 0 || emailFiles.length > 0 ? (
                <span>
                  <strong>{rfpFiles.length}</strong> RFP document{rfpFiles.length !== 1 ? 's' : ''}
                  {emailFiles.length > 0 && <> â€¢ <strong>{emailFiles.length}</strong> email{emailFiles.length !== 1 ? 's' : ''}</>}
                </span>
              ) : (
                <span>No files uploaded yet</span>
              )}
            </div>
            <div className="flex gap-3">
              <Link href="/dashboard/bid-proposals">
                <Button type="button" variant="outline" disabled={loading}>
                  Cancel
                </Button>
              </Link>
              <Button type="submit" disabled={loading || rfpFiles.length === 0}>
                {loading ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Processing...
                  </>
                ) : (
                  <>
                    <FileText className="h-4 w-4 mr-2" />
                    Create Bid Proposal
                  </>
                )}
              </Button>
            </div>
          </div>
        </form>

        {/* Help Section */}
        <Card className="bg-muted/50">
          <CardHeader>
            <CardTitle className="text-lg">How it works</CardTitle>
          </CardHeader>
          <CardContent>
            <ol className="space-y-3 text-sm">
              <li className="flex gap-3">
                <span className="font-semibold text-primary">1.</span>
                <div>
                  <p className="font-medium">Upload RFP Documents</p>
                  <p className="text-xs text-muted-foreground">Add all RFP files, specifications, and requirements</p>
                </div>
              </li>
              <li className="flex gap-3">
                <span className="font-semibold text-primary">2.</span>
                <div>
                  <p className="font-medium">Upload Email Correspondence (Optional)</p>
                  <p className="text-xs text-muted-foreground">Include preliminary emails for better context and tone matching</p>
                </div>
              </li>
              <li className="flex gap-3">
                <span className="font-semibold text-primary">3.</span>
                <div>
                  <p className="font-medium">AI Analysis</p>
                  <p className="text-xs text-muted-foreground">Our AI extracts deadlines, requirements, contacts, and understands email context</p>
                </div>
              </li>
              <li className="flex gap-3">
                <span className="font-semibold text-primary">4.</span>
                <div>
                  <p className="font-medium">Proposals Generated</p>
                  <p className="text-xs text-muted-foreground">Technical and cost proposals are automatically created with professional PDFs and slides</p>
                </div>
              </li>
              <li className="flex gap-3">
                <span className="font-semibold text-primary">5.</span>
                <div>
                  <p className="font-medium">Review & Submit</p>
                  <p className="text-xs text-muted-foreground">Edit, refine, and download your proposals for submission</p>
                </div>
              </li>
            </ol>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
// ==========================================
// File: app/dashboard/bid-proposals/page.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Plus, Search, FileText, Calendar, ExternalLink, Clock, AlertCircle, Trash2, Loader2, Download, Edit } from 'lucide-react';
import { Checkbox } from '@/components/ui/checkbox';
import { toast } from 'sonner';
import { cn, formatDetailedTimestamp } from '@/lib/utils';
import { BidProposalData, getSubmissionStatusBadge, getEnvelopeStatusBadge } from '@/lib/bid-proposal-types';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';

export default function BidProposalsPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [bidProposals, setBidProposals] = useState<BidProposalData[]>([]);
  const [filteredProposals, setFilteredProposals] = useState<BidProposalData[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState<string>('all');
  const [selectedBids, setSelectedBids] = useState<Set<string>>(new Set());
  const [bulkActionLoading, setBulkActionLoading] = useState(false);

  useEffect(() => {
    if (status === 'authenticated') {
      fetchBidProposals();
    }
  }, [status]);

  useEffect(() => {
    let filtered = [...bidProposals];

    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(
        (bp) =>
          bp.title.toLowerCase().includes(query) ||
          bp.solicitationNumber.toLowerCase().includes(query) ||
          (bp.issuingOrg && bp.issuingOrg.toLowerCase().includes(query))
      );
    }

    if (statusFilter && statusFilter !== 'all') {
      filtered = filtered.filter((bp) => bp.submissionStatus === statusFilter);
    }

    // Sort by closing date (soonest first)
    filtered.sort((a, b) => {
      if (a.closingDate && b.closingDate) {
        return new Date(a.closingDate).getTime() - new Date(b.closingDate).getTime();
      }
      if (a.closingDate) return -1;
      if (b.closingDate) return 1;
      return 0;
    });

    setFilteredProposals(filtered);
  }, [searchQuery, statusFilter, bidProposals]);

  const fetchBidProposals = async () => {
    try {
      const res = await fetch('/api/bid-proposals');
      if (res.ok) {
        const data = await res.json();
        setBidProposals(data.bidProposals);
        setFilteredProposals(data.bidProposals);
      }
    } catch (error) {
      console.error('Error fetching bid proposals:', error);
      toast.error('Failed to load bid proposals');
    } finally {
      setLoading(false);
    }
  };

  const getDaysUntilClosing = (closingDate: string | Date | undefined | null) => {
    if (!closingDate) return null;
    const now = new Date();
    const closing = new Date(closingDate);
    const diff = closing.getTime() - now.getTime();
    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
    return days;
  };

  const toggleSelectBid = (bidId: string) => {
    const newSelected = new Set(selectedBids);
    if (newSelected.has(bidId)) {
      newSelected.delete(bidId);
    } else {
      newSelected.add(bidId);
    }
    setSelectedBids(newSelected);
  };

  const toggleSelectAll = () => {
    if (selectedBids.size === filteredProposals.length) {
      setSelectedBids(new Set());
    } else {
      setSelectedBids(new Set(filteredProposals.map(bp => bp.id)));
    }
  };

  const handleBulkAction = async (action: string, additionalData?: any) => {
    if (selectedBids.size === 0) return;

    // Confirm destructive actions
    if (action === 'delete') {
      const confirmed = window.confirm(
        `Are you sure you want to delete ${selectedBids.size} bid proposal(s)? This action cannot be undone.`
      );
      if (!confirmed) return;
    }

    setBulkActionLoading(true);
    try {
      const res = await fetch('/api/bid-proposals/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          action, 
          bidIds: Array.from(selectedBids),
          ...additionalData
        }),
      });

      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || 'Failed to perform bulk action');
      }

      const data = await res.json();

      // Handle export action differently
      if (action === 'export') {
        // Download as JSON file
        const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bid-proposals-export-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        toast.success(data.message);
      } else {
        toast.success(data.message);
        setSelectedBids(new Set());
        await fetchBidProposals();
      }
    } catch (error: any) {
      console.error('Error performing bulk action:', error);
      toast.error(error.message || 'Failed to perform bulk action');
    } finally {
      setBulkActionLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div className="min-w-0">
          <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 truncate">Bid Proposals</h1>
          <p className="text-sm sm:text-base text-gray-600 mt-1 truncate">
            Manage RFP responses with AI-powered proposal generation
          </p>
        </div>
        <Link href="/dashboard/bid-proposals/new" className="flex-shrink-0">
          <Button size="sm">
            <Plus className="h-4 w-4 mr-2" />
            New Bid
          </Button>
        </Link>
      </div>

      {/* Filters */}
      <div className="bg-white border border-gray-200 rounded-lg p-3 sm:p-4">
        <div className="flex flex-col sm:flex-row gap-3">
          <div className="flex-1 relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
            <Input
              placeholder="Search bids..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10"
            />
          </div>

          <Select value={statusFilter} onValueChange={setStatusFilter}>
            <SelectTrigger className="w-full sm:w-48">
              <SelectValue placeholder="Status" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Status</SelectItem>
              <SelectItem value="not_submitted">Not Submitted</SelectItem>
              <SelectItem value="envelope1_submitted">Tech Submitted</SelectItem>
              <SelectItem value="envelope2_submitted">Cost Submitted</SelectItem>
              <SelectItem value="fully_submitted">Fully Submitted</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </div>

      {/* Bulk Actions Toolbar */}
      {selectedBids.size > 0 && (
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4">
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
            <div className="flex items-center gap-2">
              <Checkbox
                checked={selectedBids.size === filteredProposals.length}
                onCheckedChange={toggleSelectAll}
              />
              <span className="text-sm font-medium text-blue-900">
                {selectedBids.size} bid{selectedBids.size !== 1 ? 's' : ''} selected
              </span>
            </div>
            <div className="flex flex-wrap gap-2">
              {/* Export Action */}
              <Button
                variant="outline"
                size="sm"
                onClick={() => handleBulkAction('export')}
                disabled={bulkActionLoading}
              >
                <Download className="h-4 w-4 mr-2" />
                Export
              </Button>

              {/* Update Status Dropdown */}
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button
                    variant="outline"
                    size="sm"
                    disabled={bulkActionLoading}
                  >
                    <Edit className="h-4 w-4 mr-2" />
                    Update Status
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent>
                  <DropdownMenuItem onClick={() => handleBulkAction('update_status', { status: 'not_submitted' })}>
                    Mark as Not Submitted
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={() => handleBulkAction('update_status', { status: 'envelope1_submitted' })}>
                    Mark as Tech Submitted
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={() => handleBulkAction('update_status', { status: 'envelope2_submitted' })}>
                    Mark as Cost Submitted
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={() => handleBulkAction('update_status', { status: 'fully_submitted' })}>
                    Mark as Fully Submitted
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>

              {/* Delete Action */}
              <Button
                variant="destructive"
                size="sm"
                onClick={() => handleBulkAction('delete')}
                disabled={bulkActionLoading}
              >
                {bulkActionLoading ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Processing...
                  </>
                ) : (
                  <>
                    <Trash2 className="h-4 w-4 mr-2" />
                    Delete
                  </>
                )}
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* Bid Proposals List */}
      <div className="bg-white border border-gray-200 rounded-lg overflow-hidden">
        {filteredProposals.length === 0 ? (
          <div className="text-center py-12 px-4">
            <FileText className="h-12 w-12 text-gray-400 mx-auto mb-3" />
            <h3 className="text-sm font-medium text-gray-900 mb-1">No bid proposals found</h3>
            <p className="text-sm text-gray-600 mb-4">
              {searchQuery || statusFilter !== 'all'
                ? 'Try adjusting your filters'
                : 'Create your first bid proposal to get started'}
            </p>
            {!searchQuery && statusFilter === 'all' && (
              <Link href="/dashboard/bid-proposals/new">
                <Button>
                  <Plus className="h-4 w-4 mr-2" />
                  Create Bid Proposal
                </Button>
              </Link>
            )}
          </div>
        ) : (
          <div className="divide-y divide-gray-200">
            {filteredProposals.map((bidProposal) => {
              const daysUntilClosing = getDaysUntilClosing(bidProposal.closingDate);
              const isUrgent = daysUntilClosing !== null && daysUntilClosing <= 7 && daysUntilClosing > 0;
              const isPastDue = daysUntilClosing !== null && daysUntilClosing < 0;
              const isSelected = selectedBids.has(bidProposal.id);

              return (
                <div
                  key={bidProposal.id}
                  className={cn(
                    "p-4 hover:bg-gray-50 transition-colors",
                    isSelected && "bg-blue-50"
                  )}
                >
                  <div className="flex items-start gap-3">
                    {/* Checkbox */}
                    <div className="pt-1">
                      <Checkbox
                        checked={isSelected}
                        onCheckedChange={() => toggleSelectBid(bidProposal.id)}
                        onClick={(e) => e.stopPropagation()}
                      />
                    </div>

                    {/* Clickable Content */}
                    <Link
                      href={`/dashboard/bid-proposals/${bidProposal.id}`}
                      className="flex-1 min-w-0"
                    >
                      <div className="space-y-3">
                        {/* Header */}
                        <div className="flex items-start justify-between gap-3">
                          <div className="min-w-0 flex-1">
                            <h3 className="text-sm font-semibold text-gray-900 line-clamp-1">
                              {bidProposal.title}
                            </h3>
                            <p className="text-xs text-gray-500 mt-0.5">
                              {bidProposal.solicitationNumber}
                            </p>
                        {bidProposal.issuingOrg && (
                          <p className="text-xs text-gray-600 mt-1">{bidProposal.issuingOrg}</p>
                        )}
                      </div>
                      <Badge
                        className={cn(
                          'flex-shrink-0',
                          getSubmissionStatusBadge(bidProposal.submissionStatus).className
                        )}
                      >
                        {getSubmissionStatusBadge(bidProposal.submissionStatus).label}
                      </Badge>
                    </div>

                    {/* Envelope Status */}
                    <div className="flex gap-2 text-xs">
                      <Badge
                        variant="outline"
                        className={cn(
                          'font-normal',
                          getEnvelopeStatusBadge(bidProposal.envelope1Status).className
                        )}
                      >
                        Tech: {getEnvelopeStatusBadge(bidProposal.envelope1Status).label}
                      </Badge>
                      <Badge
                        variant="outline"
                        className={cn(
                          'font-normal',
                          getEnvelopeStatusBadge(bidProposal.envelope2Status).className
                        )}
                      >
                        Cost: {getEnvelopeStatusBadge(bidProposal.envelope2Status).label}
                      </Badge>
                    </div>

                    {/* Footer */}
                    <div className="flex items-center justify-between text-xs text-gray-500">
                      <div className="flex items-center gap-4">
                        {bidProposal.closingDate && (
                          <div className={cn(
                            'flex items-center gap-1',
                            isPastDue && 'text-red-600',
                            isUrgent && 'text-orange-600 font-medium'
                          )}>
                            {isPastDue ? (
                              <AlertCircle className="h-3 w-3" />
                            ) : (
                              <Calendar className="h-3 w-3" />
                            )}
                            {isPastDue ? (
                              <span>Past Due</span>
                            ) : daysUntilClosing !== null ? (
                              <span>
                                {daysUntilClosing === 0
                                  ? 'Closes Today'
                                  : daysUntilClosing === 1
                                  ? 'Closes Tomorrow'
                                  : `${daysUntilClosing} days left`}
                              </span>
                            ) : (
                              <span>{new Date(bidProposal.closingDate).toLocaleDateString()}</span>
                            )}
                          </div>
                        )}
                        <div className="flex items-center gap-1">
                          <Clock className="h-3 w-3" />
                          {formatDetailedTimestamp(bidProposal.createdAt, { showTime: false }).relative}
                        </div>
                      </div>
                      <ExternalLink className="h-3 w-3" />
                    </div>
                      </div>
                    </Link>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}

// ==========================================
// File: app/dashboard/bid-proposals/[id]/page.tsx
// ==========================================

'use client';

import { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import {
  ArrowLeft,
  Calendar,
  MapPin,
  Building2,
  Download,
  RefreshCw,
  Send,
  FileText,
  DollarSign,
  CheckCircle2,
  Clock,
  Loader2,
  Upload,
  Edit,
  Save,
  X,
  ChevronDown,
  Package,
} from 'lucide-react';
import { toast } from 'sonner';
import { ProcessingStatusIndicator } from '@/components/bid-proposals/processing-status-indicator';

interface BidAttachment {
  id: string;
  name: string;
  cloudStoragePath: string;
  category?: string | null;
  fileSize: number;
  uploadedAt: string;
}

interface BidProposal {
  id: string;
  proposalTitle?: string | null;
  issuingOrg?: string | null;
  closingDate?: string | null;
  location?: string | null;
  envelope1Status: string;
  envelope2Status: string;
  envelope1Content?: string | null;
  envelope2Content?: string | null;
  proposedPrice?: number | null;
  bidAttachments?: BidAttachment[];
}

export default function BidProposalDetailPage() {
  const params = useParams();
  const router = useRouter();
  const bidProposalId = params.id as string;

  const [bidProposal, setBidProposal] = useState<BidProposal | null>(null);
  const [loading, setLoading] = useState(true);
  const [regenerateDialogOpen, setRegenerateDialogOpen] = useState(false);
  const [regenerateFiles, setRegenerateFiles] = useState<File[]>([]);
  const [regenerateNotes, setRegenerateNotes] = useState('');
  const [regenerating, setRegenerating] = useState(false);
  const [downloading, setDownloading] = useState<{pdf?: boolean; slides?: boolean}>({});
  
  // Editing states
  const [editingTitle, setEditingTitle] = useState(false);
  const [editedTitle, setEditedTitle] = useState('');
  const [savingTitle, setSavingTitle] = useState(false);
  
  const [editingTechnical, setEditingTechnical] = useState(false);
  const [editedTechnical, setEditedTechnical] = useState('');
  const [savingTechnical, setSavingTechnical] = useState(false);
  
  const [editingCost, setEditingCost] = useState(false);
  const [editedCost, setEditedCost] = useState('');
  const [savingCost, setSavingCost] = useState(false);

  useEffect(() => {
    fetchBidProposal();
    
    // Poll for updates if proposals are being generated
    const interval = setInterval(() => {
      if (bidProposal && (bidProposal.envelope1Status === 'in_progress' || bidProposal.envelope2Status === 'in_progress')) {
        fetchBidProposal();
      }
    }, 3000);

    return () => clearInterval(interval);
  }, [bidProposalId, bidProposal?.envelope1Status, bidProposal?.envelope2Status]);

  const fetchBidProposal = async () => {
    try {
      const response = await fetch(`/api/bid-proposals/${bidProposalId}`);
      if (!response.ok) throw new Error('Failed to fetch bid proposal');
      const data = await response.json();
      setBidProposal(data.bidProposal);
    } catch (error) {
      console.error('Error fetching bid proposal:', error);
      toast.error('Failed to load bid proposal');
    } finally {
      setLoading(false);
    }
  };

  const handleRegenerate = async () => {
    if (regenerateFiles.length === 0 && (!bidProposal?.bidAttachments || bidProposal.bidAttachments.length === 0)) {
      toast.error('Please upload at least one document');
      return;
    }

    setRegenerating(true);
    try {
      const formData = new FormData();
      regenerateFiles.forEach((file) => {
        formData.append('files', file);
      });
      
      // Add notes/instructions if provided
      if (regenerateNotes.trim()) {
        formData.append('notes', regenerateNotes.trim());
      }

      const response = await fetch(`/api/bid-proposals/${bidProposalId}/regenerate`, {
        method: 'POST',
        body: formData,
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to regenerate proposal');
      }

      toast.success('Regeneration started! This may take a few minutes...');
      setRegenerateDialogOpen(false);
      setRegenerateFiles([]);
      setRegenerateNotes('');
      
      // Poll for updates
      setTimeout(fetchBidProposal, 2000);
    } catch (error: any) {
      console.error('Error regenerating proposal:', error);
      toast.error(error.message || 'Failed to regenerate proposal');
    } finally {
      setRegenerating(false);
    }
  };

  const handleDownloadPDF = async (envelope: 1 | 2 | 'combined') => {
    const downloadType = envelope === 'combined' ? 'combined' : `envelope${envelope}`;
    setDownloading({ ...downloading, pdf: true });
    try {
      const url = envelope === 'combined' 
        ? `/api/bid-proposals/${bidProposalId}/download-combined-pdf`
        : `/api/bid-proposals/${bidProposalId}/download-pdf?envelope=${envelope}`;
      
      const response = await fetch(url);
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || 'Failed to download PDF');
      }
      
      const blob = await response.blob();
      const downloadUrl = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = downloadUrl;
      
      const envelopeName = envelope === 'combined' 
        ? 'Combined' 
        : envelope === 1 ? 'Technical' : 'Cost';
      a.download = `${bidProposal?.proposalTitle || 'Proposal'}_${envelopeName}.pdf`;
      
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(downloadUrl);
      document.body.removeChild(a);
      
      toast.success(`${envelopeName} PDF downloaded successfully`);
    } catch (error: any) {
      console.error('Error downloading PDF:', error);
      toast.error(error.message || 'Failed to download PDF');
    } finally {
      setDownloading({ ...downloading, pdf: false });
    }
  };

  const handleDownloadSlides = async (envelope: 1 | 2) => {
    setDownloading({ ...downloading, slides: true });
    try {
      const response = await fetch(
        `/api/bid-proposals/${bidProposalId}/download-slides?envelope=${envelope}`
      );
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || 'Failed to download slides');
      }
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      const envelopeName = envelope === 1 ? 'Technical' : 'Cost';
      a.download = `${bidProposal?.proposalTitle || 'Proposal'}_${envelopeName}_Slides.pptx`;
      
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      toast.success(`${envelopeName} Slides downloaded successfully`);
    } catch (error: any) {
      console.error('Error downloading slides:', error);
      toast.error(error.message || 'Failed to download slides');
    } finally {
      setDownloading({ ...downloading, slides: false });
    }
  };

  // Editing handlers
  const handleEditTitle = () => {
    setEditedTitle(bidProposal?.proposalTitle || '');
    setEditingTitle(true);
  };

  const handleSaveTitle = async () => {
    setSavingTitle(true);
    try {
      const response = await fetch(`/api/bid-proposals/${bidProposalId}/update-title`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: editedTitle }),
      });
      
      if (!response.ok) throw new Error('Failed to save title');
      
      setBidProposal(prev => prev ? { ...prev, proposalTitle: editedTitle } : null);
      setEditingTitle(false);
      toast.success('Title updated successfully');
    } catch (error) {
      console.error('Error saving title:', error);
      toast.error('Failed to save title');
    } finally {
      setSavingTitle(false);
    }
  };

  const handleEditTechnical = () => {
    setEditedTechnical(bidProposal?.envelope1Content || '');
    setEditingTechnical(true);
  };

  const handleSaveTechnical = async () => {
    setSavingTechnical(true);
    try {
      const response = await fetch(`/api/bid-proposals/${bidProposalId}/update-content`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ envelope: 1, content: editedTechnical }),
      });
      
      if (!response.ok) throw new Error('Failed to save technical proposal');
      
      setBidProposal(prev => prev ? { ...prev, envelope1Content: editedTechnical } : null);
      setEditingTechnical(false);
      toast.success('Technical proposal updated successfully');
    } catch (error) {
      console.error('Error saving technical proposal:', error);
      toast.error('Failed to save technical proposal');
    } finally {
      setSavingTechnical(false);
    }
  };

  const handleEditCost = () => {
    setEditedCost(bidProposal?.envelope2Content || '');
    setEditingCost(true);
  };

  const handleSaveCost = async () => {
    setSavingCost(true);
    try {
      const response = await fetch(`/api/bid-proposals/${bidProposalId}/update-content`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ envelope: 2, content: editedCost }),
      });
      
      if (!response.ok) throw new Error('Failed to save cost proposal');
      
      setBidProposal(prev => prev ? { ...prev, envelope2Content: editedCost } : null);
      setEditingCost(false);
      toast.success('Cost proposal updated successfully');
    } catch (error) {
      console.error('Error saving cost proposal:', error);
      toast.error('Failed to save cost proposal');
    } finally {
      setSavingCost(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-primary" />
      </div>
    );
  }

  if (!bidProposal) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen p-6">
        <p className="text-lg text-muted-foreground mb-4">Bid proposal not found</p>
        <Link href="/dashboard/bid-proposals">
          <Button variant="outline">
            <ArrowLeft className="w-4 h-4 mr-2" />
            Back to Bids
          </Button>
        </Link>
      </div>
    );
  }

  const isProcessing = bidProposal.envelope1Status === 'in_progress' || 
                       bidProposal.envelope2Status === 'in_progress';
  const isComplete = bidProposal.envelope1Status === 'completed';

  return (
    <div className="container mx-auto px-4 py-8 max-w-7xl">
      {/* Header */}
      <div className="mb-6">
        <div className="flex items-center gap-4 mb-4">
          <Link href="/dashboard/bid-proposals">
            <Button variant="ghost" size="icon">
              <ArrowLeft className="w-5 h-5" />
            </Button>
          </Link>
          <div className="flex-1">
            {editingTitle ? (
              <div className="flex items-center gap-2">
                <Input
                  value={editedTitle}
                  onChange={(e) => setEditedTitle(e.target.value)}
                  className="text-2xl font-bold h-auto py-2"
                  placeholder="Enter proposal title"
                />
                <Button
                  size="sm"
                  onClick={handleSaveTitle}
                  disabled={savingTitle}
                >
                  {savingTitle ? <Loader2 className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4" />}
                </Button>
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => setEditingTitle(false)}
                >
                  <X className="w-4 h-4" />
                </Button>
              </div>
            ) : (
              <div className="flex items-center gap-2">
                <h1 className="text-2xl font-bold">{bidProposal.proposalTitle || 'Untitled Proposal'}</h1>
                <Button variant="ghost" size="icon" onClick={handleEditTitle}>
                  <Edit className="w-4 h-4" />
                </Button>
              </div>
            )}
            <p className="text-sm text-muted-foreground">{bidProposal.issuingOrg}</p>
          </div>
        </div>
        
        <div className="flex flex-wrap items-center gap-2">
          {isComplete && (
            <>
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button
                    disabled={downloading.pdf}
                    variant="outline"
                    size="sm"
                  >
                    {downloading.pdf ? (
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    ) : (
                      <Download className="w-4 h-4 mr-2" />
                    )}
                    Download PDF
                    <ChevronDown className="w-4 h-4 ml-2" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuItem onClick={() => handleDownloadPDF(1)}>
                    <FileText className="w-4 h-4 mr-2" />
                    Technical Proposal
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={() => handleDownloadPDF(2)}>
                    <DollarSign className="w-4 h-4 mr-2" />
                    Cost Proposal
                  </DropdownMenuItem>
                  <DropdownMenuSeparator />
                  <DropdownMenuItem onClick={() => handleDownloadPDF('combined')}>
                    <Package className="w-4 h-4 mr-2" />
                    Combined (Both Envelopes)
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
              
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button
                    disabled={downloading.slides}
                    variant="outline"
                    size="sm"
                  >
                    {downloading.slides ? (
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    ) : (
                      <Download className="w-4 h-4 mr-2" />
                    )}
                    Download Slides
                    <ChevronDown className="w-4 h-4 ml-2" />
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuItem onClick={() => handleDownloadSlides(1)}>
                    <FileText className="w-4 h-4 mr-2" />
                    Technical Proposal
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={() => handleDownloadSlides(2)}>
                    <DollarSign className="w-4 h-4 mr-2" />
                    Cost Proposal
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </>
          )}
          
          <Dialog open={regenerateDialogOpen} onOpenChange={setRegenerateDialogOpen}>
            <DialogTrigger asChild>
              <Button variant="default" size="sm">
                <RefreshCw className="w-4 h-4 mr-2" />
                Regenerate
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
              <DialogHeader>
                <DialogTitle>Regenerate Proposal</DialogTitle>
                <DialogDescription>
                  Provide specific instructions and optionally upload new files to regenerate the proposal.
                </DialogDescription>
              </DialogHeader>
              <div className="py-4 space-y-4">
                {/* Notes/Instructions Field */}
                <div>
                  <label className="block text-sm font-medium mb-2">
                    Regeneration Notes & Instructions
                  </label>
                  <Textarea
                    value={regenerateNotes}
                    onChange={(e) => setRegenerateNotes(e.target.value)}
                    placeholder="Provide specific instructions for the AI to regenerate the proposal (e.g., 'Focus more on technical specifications', 'Add more details about timeline', 'Emphasize cost-effectiveness')..."
                    className="min-h-[120px] w-full resize-none"
                  />
                  <p className="text-xs text-muted-foreground mt-1">
                    These instructions will guide the AI in regenerating your proposal based on past files, new files, and your specific requirements.
                  </p>
                </div>

                {/* File Upload Field */}
                <div>
                  <label className="block text-sm font-medium mb-2">Upload New Files (Optional)</label>
                  <input
                    type="file"
                    multiple
                    onChange={(e) => setRegenerateFiles(Array.from(e.target.files || []))}
                    className="block w-full text-sm text-gray-500
                      file:mr-4 file:py-2 file:px-4
                      file:rounded-full file:border-0
                      file:text-sm file:font-semibold
                      file:bg-primary file:text-primary-foreground
                      hover:file:bg-primary/90"
                  />
                  {regenerateFiles.length > 0 && (
                    <p className="text-sm text-muted-foreground mt-2">
                      {regenerateFiles.length} new file(s) selected
                    </p>
                  )}
                  {bidProposal.bidAttachments && bidProposal.bidAttachments.length > 0 && regenerateFiles.length === 0 && (
                    <p className="text-sm text-muted-foreground mt-2">
                      Will use {bidProposal.bidAttachments.length} existing document(s)
                    </p>
                  )}
                </div>
              </div>
              <DialogFooter>
                <Button variant="outline" onClick={() => setRegenerateDialogOpen(false)}>
                  Cancel
                </Button>
                <Button onClick={handleRegenerate} disabled={regenerating}>
                  {regenerating ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      Regenerating...
                    </>
                  ) : (
                    'Regenerate'
                  )}
                </Button>
              </DialogFooter>
            </DialogContent>
          </Dialog>
        </div>
      </div>

      {/* Processing Status */}
      {isProcessing && (
        <div className="mb-6">
          <ProcessingStatusIndicator bidId={bidProposalId} />
        </div>
      )}

      {/* Info Cards */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        {bidProposal.closingDate && (
          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center gap-2 text-muted-foreground mb-1">
                <Calendar className="w-4 h-4" />
                <p className="text-xs font-medium">Closing Date</p>
              </div>
              <p className="text-sm font-semibold">{new Date(bidProposal.closingDate).toLocaleDateString()}</p>
            </CardContent>
          </Card>
        )}
        
        {bidProposal.location && (
          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center gap-2 text-muted-foreground mb-1">
                <MapPin className="w-4 h-4" />
                <p className="text-xs font-medium">Location</p>
              </div>
              <p className="text-sm font-semibold">{bidProposal.location}</p>
            </CardContent>
          </Card>
        )}
        
        <Card>
          <CardContent className="pt-6">
            <div className="flex items-center gap-2 text-muted-foreground mb-1">
              <Clock className="w-4 h-4" />
              <p className="text-xs font-medium">Status</p>
            </div>
            <div className="flex items-center gap-2 mt-1">
              {isProcessing && <Badge variant="secondary">Processing</Badge>}
              {isComplete && <Badge variant="default">Complete</Badge>}
              {!isProcessing && !isComplete && <Badge variant="outline">Pending</Badge>}
            </div>
          </CardContent>
        </Card>
        
        {bidProposal.proposedPrice && (
          <Card>
            <CardContent className="pt-6">
              <div className="flex items-center gap-2 text-muted-foreground mb-1">
                <DollarSign className="w-4 h-4" />
                <p className="text-xs font-medium">Budget</p>
              </div>
              <p className="text-sm font-semibold">${bidProposal.proposedPrice.toLocaleString()}</p>
            </CardContent>
          </Card>
        )}
      </div>

      {/* Tabs Content */}
      <Tabs defaultValue="technical" className="w-full">
        <TabsList className="grid w-full grid-cols-3">
          <TabsTrigger value="technical" className="flex items-center gap-2">
            <FileText className="w-4 h-4" />
            Technical
            {bidProposal.envelope1Status === 'completed' && (
              <CheckCircle2 className="w-3 h-3 text-green-600 ml-1" />
            )}
          </TabsTrigger>
          <TabsTrigger value="cost" className="flex items-center gap-2">
            <DollarSign className="w-4 h-4" />
            Cost
            {bidProposal.envelope2Status === 'completed' && (
              <CheckCircle2 className="w-3 h-3 text-green-600 ml-1" />
            )}
          </TabsTrigger>
          <TabsTrigger value="documents" className="flex items-center gap-2">
            <Upload className="w-4 h-4" />
            Documents
            {bidProposal.bidAttachments && bidProposal.bidAttachments.length > 0 && (
              <Badge variant="secondary" className="ml-1 text-xs">
                {bidProposal.bidAttachments.length}
              </Badge>
            )}
          </TabsTrigger>
        </TabsList>

        <TabsContent value="technical" className="mt-6">
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <CardTitle>Technical Proposal</CardTitle>
                {!editingTechnical && bidProposal.envelope1Content && (
                  <Button variant="outline" size="sm" onClick={handleEditTechnical}>
                    <Edit className="w-4 h-4 mr-2" />
                    Edit
                  </Button>
                )}
              </div>
            </CardHeader>
            <CardContent>
              {editingTechnical ? (
                <div className="space-y-4">
                  <Textarea
                    value={editedTechnical}
                    onChange={(e) => setEditedTechnical(e.target.value)}
                    className="min-h-[500px] font-mono text-sm"
                    placeholder="Enter technical proposal content (Markdown supported)"
                  />
                  <div className="flex items-center gap-2">
                    <Button onClick={handleSaveTechnical} disabled={savingTechnical}>
                      {savingTechnical ? (
                        <>
                          <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                          Saving...
                        </>
                      ) : (
                        <>
                          <Save className="w-4 h-4 mr-2" />
                          Save
                        </>
                      )}
                    </Button>
                    <Button variant="outline" onClick={() => setEditingTechnical(false)}>
                      <X className="w-4 h-4 mr-2" />
                      Cancel
                    </Button>
                  </div>
                </div>
              ) : bidProposal.envelope1Content ? (
                <div className="prose prose-sm max-w-none dark:prose-invert
                  prose-headings:font-bold prose-headings:text-foreground
                  prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg
                  prose-p:text-foreground prose-p:leading-relaxed
                  prose-a:text-primary prose-a:no-underline hover:prose-a:underline
                  prose-strong:text-foreground prose-strong:font-semibold
                  prose-ul:list-disc prose-ul:pl-6
                  prose-ol:list-decimal prose-ol:pl-6
                  prose-li:text-foreground prose-li:my-1
                  prose-table:border-collapse prose-table:w-full
                  prose-thead:bg-muted
                  prose-th:border prose-th:border-border prose-th:px-4 prose-th:py-2 prose-th:text-left prose-th:font-semibold
                  prose-td:border prose-td:border-border prose-td:px-4 prose-td:py-2
                  prose-hr:border-border prose-hr:my-6
                  prose-blockquote:border-l-4 prose-blockquote:border-primary prose-blockquote:pl-4 prose-blockquote:italic">
                  <ReactMarkdown remarkPlugins={[remarkGfm]}>
                    {bidProposal.envelope1Content}
                  </ReactMarkdown>
                </div>
              ) : (
                <p className="text-muted-foreground text-center py-8">No technical proposal generated yet.</p>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="cost" className="mt-6">
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <CardTitle>Cost Proposal</CardTitle>
                {!editingCost && bidProposal.envelope2Content && (
                  <Button variant="outline" size="sm" onClick={handleEditCost}>
                    <Edit className="w-4 h-4 mr-2" />
                    Edit
                  </Button>
                )}
              </div>
            </CardHeader>
            <CardContent>
              {editingCost ? (
                <div className="space-y-4">
                  <Textarea
                    value={editedCost}
                    onChange={(e) => setEditedCost(e.target.value)}
                    className="min-h-[500px] font-mono text-sm"
                    placeholder="Enter cost proposal content (Markdown supported)"
                  />
                  <div className="flex items-center gap-2">
                    <Button onClick={handleSaveCost} disabled={savingCost}>
                      {savingCost ? (
                        <>
                          <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                          Saving...
                        </>
                      ) : (
                        <>
                          <Save className="w-4 h-4 mr-2" />
                          Save
                        </>
                      )}
                    </Button>
                    <Button variant="outline" onClick={() => setEditingCost(false)}>
                      <X className="w-4 h-4 mr-2" />
                      Cancel
                    </Button>
                  </div>
                </div>
              ) : bidProposal.envelope2Content ? (
                <div className="prose prose-sm max-w-none dark:prose-invert
                  prose-headings:font-bold prose-headings:text-foreground
                  prose-h1:text-2xl prose-h2:text-xl prose-h3:text-lg
                  prose-p:text-foreground prose-p:leading-relaxed
                  prose-a:text-primary prose-a:no-underline hover:prose-a:underline
                  prose-strong:text-foreground prose-strong:font-semibold
                  prose-ul:list-disc prose-ul:pl-6
                  prose-ol:list-decimal prose-ol:pl-6
                  prose-li:text-foreground prose-li:my-1
                  prose-table:border-collapse prose-table:w-full
                  prose-thead:bg-muted
                  prose-th:border prose-th:border-border prose-th:px-4 prose-th:py-2 prose-th:text-left prose-th:font-semibold
                  prose-td:border prose-td:border-border prose-td:px-4 prose-td:py-2
                  prose-hr:border-border prose-hr:my-6
                  prose-blockquote:border-l-4 prose-blockquote:border-primary prose-blockquote:pl-4 prose-blockquote:italic">
                  <ReactMarkdown remarkPlugins={[remarkGfm]}>
                    {bidProposal.envelope2Content}
                  </ReactMarkdown>
                </div>
              ) : (
                <p className="text-muted-foreground text-center py-8">No cost proposal generated yet.</p>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="documents" className="mt-6">
          <Card>
            <CardHeader>
              <CardTitle>Uploaded Documents</CardTitle>
            </CardHeader>
            <CardContent>
              {bidProposal.bidAttachments && bidProposal.bidAttachments.length > 0 ? (
                <div className="space-y-2">
                  {bidProposal.bidAttachments.map((doc) => (
                    <div key={doc.id} className="flex items-center justify-between p-4 border rounded-lg hover:bg-muted/50 transition-colors">
                      <div className="flex items-center gap-3">
                        <FileText className="w-5 h-5 text-muted-foreground" />
                        <div>
                          <p className="text-sm font-medium">{doc.name}</p>
                          <div className="flex items-center gap-2 mt-1">
                            {doc.category && (
                              <Badge variant="outline" className="text-xs capitalize">
                                {doc.category}
                              </Badge>
                            )}
                            <p className="text-xs text-muted-foreground">
                              {new Date(doc.uploadedAt).toLocaleDateString()}
                            </p>
                          </div>
                        </div>
                      </div>
                      <Button variant="ghost" size="sm" asChild>
                        <a href={`/api/file/download?path=${doc.cloudStoragePath}`} target="_blank" rel="noopener noreferrer">
                          <Download className="w-4 h-4" />
                        </a>
                      </Button>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-muted-foreground text-center py-8">No documents uploaded yet.</p>
              )}
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}

// ==========================================
// File: app/dashboard/billing/page.tsx
// ==========================================


"use client";

import { useEffect, useState, Suspense } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { getTierConfig } from "@/lib/tier-config";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Check, CreditCard, Loader2, Coins, Zap, ArrowRight, Sparkles, TrendingUp } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

// SaaS subscriptions - premium DIY tools with professional features
const PRICING_TIERS = [
  {
    id: "starter",
    name: "Starter",
    price: 199,
    priceRange: "$199",
    description: "Professional DIY tools for serious entrepreneurs",
    trial: false,
    creditsPerMonth: 5,
  },
  {
    id: "growth",
    name: "Growth",
    price: 499,
    priceRange: "$499",
    description: "Advanced features for growing businesses",
    popular: true,
    creditsPerMonth: 15,
  },
  {
    id: "pro",
    name: "Pro",
    price: 999,
    priceRange: "$999",
    description: "Complete suite for established companies",
    creditsPerMonth: 40,
  },
];

const CREDIT_PACKAGES = [
  {
    id: "credits_5",
    credits: 5,
    price: 25,
    description: "Quick prototyping",
    popular: false,
  },
  {
    id: "credits_10",
    credits: 10,
    price: 45,
    description: "Most popular",
    popular: true,
    savings: "Save $5",
  },
  {
    id: "credits_25",
    credits: 25,
    price: 100,
    description: "Best value",
    popular: false,
    savings: "Save $25",
  },
];

function BillingPageContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { toast } = useToast();
  const [user, setUser] = useState<{
    id: string;
    email: string;
    name?: string | null;
    tier: string;
    credits?: number;
  } | null>(null);
  const [loading, setLoading] = useState(true);
  const [processingTier, setProcessingTier] = useState<string | null>(null);
  const [processingCredits, setProcessingCredits] = useState<string | null>(null);
  const [userCredits, setUserCredits] = useState<number>(0);

  useEffect(() => {
    fetchUser();
  }, []);

  useEffect(() => {
    const success = searchParams.get("success");
    const canceled = searchParams.get("canceled");
    const tier = searchParams.get("tier");

    if (success === "true" && tier) {
      toast({
        title: "Subscription Successful!",
        description: `Welcome to the ${tier} plan! Your account will be updated shortly.`,
      });
      // Refresh the page to update the user's tier
      setTimeout(() => {
        window.location.href = "/dashboard/billing";
      }, 2000);
    } else if (canceled === "true") {
      toast({
        title: "Checkout Canceled",
        description: "Your subscription was not completed. You can try again anytime.",
        variant: "destructive",
      });
    }
  }, [searchParams, toast]);

  const fetchUser = async () => {
    try {
      const response = await fetch("/api/auth/session");
      if (response.ok) {
        const data = await response.json();
        setUser(data.user);
        
        // Fetch credits
        const creditsResponse = await fetch("/api/credits");
        if (creditsResponse.ok) {
          const creditsData = await creditsResponse.json();
          setUserCredits(creditsData.credits || 0);
        }
      } else {
        router.push("/auth/login");
      }
    } catch (error) {
      console.error("Error fetching user:", error);
      router.push("/auth/login");
    } finally {
      setLoading(false);
    }
  };

  const handleSubscribe = async (tierId: string) => {
    setProcessingTier(tierId);
    try {
      const response = await fetch("/api/subscription/create-checkout", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ tierId }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Failed to create checkout session");
      }

      // Redirect to Stripe Checkout
      if (data.url) {
        window.location.href = data.url;
      }
    } catch (error: any) {
      console.error("Subscription error:", error);
      toast({
        title: "Error",
        description: error.message || "Failed to start subscription process. Please try again.",
        variant: "destructive",
      });
      setProcessingTier(null);
    }
  };

  const handleContactSales = (tierId: string) => {
    // Navigate to contact form with pre-filled information
    router.push(`/contact?subject=Upgrade to ${tierId} Plan`);
  };

  const handleBuyCredits = async (packageId: string, credits: number, price: number) => {
    setProcessingCredits(packageId);
    try {
      const response = await fetch("/api/credits/purchase", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ 
          packageId,
          credits,
          price
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Failed to purchase credits");
      }

      // Redirect to Stripe Checkout
      if (data.url) {
        window.location.href = data.url;
      }
    } catch (error: any) {
      console.error("Credit purchase error:", error);
      toast({
        title: "Error",
        description: error.message || "Failed to purchase credits. Please try again.",
        variant: "destructive",
      });
      setProcessingCredits(null);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <Loader2 className="w-8 h-8 animate-spin text-blue-600" />
      </div>
    );
  }

  const currentTierConfig = user ? getTierConfig(user.tier) : getTierConfig("free");

  return (
    <div className="space-y-6 sm:space-y-8">
        <div>
          <h1 className="text-2xl sm:text-3xl font-bold text-gray-900">
            Plans & Billing
          </h1>
          <p className="text-sm sm:text-base text-gray-600 mt-1">
            Manage your subscription and billing information
          </p>
        </div>

        {/* Current Plan */}
        <Card>
          <CardHeader>
            <CardTitle>Current Plan</CardTitle>
            <CardDescription>
              You're currently on the {currentTierConfig.name} plan
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-between">
              <div>
                <p className="text-2xl font-bold">
                  {currentTierConfig.name}
                </p>
                <p className="text-gray-600">
                  {("priceRange" in currentTierConfig ? (currentTierConfig as any).priceRange : "$0")}/mo
                </p>
              </div>
              {user?.tier !== "free" && user?.tier !== "enterprise" && (
                <Button 
                  variant="outline"
                  onClick={() => window.open("https://billing.stripe.com/p/login/test_aEU6qM5MK8fO1nG000", "_blank")}
                >
                  <CreditCard className="w-4 h-4 mr-2" />
                  Manage Billing
                </Button>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Professional Services Upgrade CTA */}
        <Card className="border-2 border-gradient-to-r from-blue-600 to-purple-600 bg-gradient-to-br from-blue-50 to-purple-50 relative overflow-hidden">
          <div className="absolute top-0 right-0 w-64 h-64 bg-blue-200 rounded-full blur-3xl opacity-20 -mr-32 -mt-32"></div>
          <div className="absolute bottom-0 left-0 w-64 h-64 bg-purple-200 rounded-full blur-3xl opacity-20 -ml-32 -mb-32"></div>
          <CardHeader className="relative z-10">
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <div className="flex items-center gap-2 mb-2">
                  <Sparkles className="w-6 h-6 text-blue-600" />
                  <CardTitle className="text-2xl">Ready for Professional Results?</CardTitle>
                </div>
                <CardDescription className="text-base">
                  DIY tools are great for prototyping, but our professional services deliver 
                  production-ready, custom solutions that drive real business results.
                </CardDescription>
              </div>
            </div>
          </CardHeader>
          <CardContent className="relative z-10">
            <div className="grid md:grid-cols-2 gap-6 mb-6">
              <div className="bg-white/60 backdrop-blur p-4 rounded-lg border border-gray-200">
                <h4 className="font-semibold mb-3 flex items-center gap-2">
                  <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                    <span className="text-sm">ðŸ› ï¸</span>
                  </div>
                  DIY Website Builder
                </h4>
                <ul className="space-y-2 text-sm text-gray-600">
                  <li className="flex items-start gap-2">
                    <Check className="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" />
                    AI-generated templates
                  </li>
                  <li className="flex items-start gap-2">
                    <Check className="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" />
                    Quick prototyping (15 mins)
                  </li>
                  <li className="flex items-start gap-2">
                    <Check className="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" />
                    Basic features only
                  </li>
                  <li className="flex items-start gap-2">
                    <Check className="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" />
                    Self-service support
                  </li>
                </ul>
                <div className="mt-4 pt-4 border-t border-gray-200">
                  <p className="text-sm text-gray-500">Starting at</p>
                  <p className="text-2xl font-bold text-blue-600">$5 per website</p>
                </div>
              </div>
              
              <div className="bg-gradient-to-br from-blue-600 to-purple-600 text-white p-4 rounded-lg relative overflow-hidden shadow-lg">
                <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                <div className="relative z-10">
                  <h4 className="font-semibold mb-3 flex items-center gap-2">
                    <div className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                      <TrendingUp className="w-4 h-4" />
                    </div>
                    Professional Website Creation
                  </h4>
                  <ul className="space-y-2 text-sm opacity-95">
                    <li className="flex items-start gap-2">
                      <Check className="w-4 h-4 mt-0.5 flex-shrink-0" />
                      100% custom design & development
                    </li>
                    <li className="flex items-start gap-2">
                      <Check className="w-4 h-4 mt-0.5 flex-shrink-0" />
                      Advanced features & integrations
                    </li>
                    <li className="flex items-start gap-2">
                      <Check className="w-4 h-4 mt-0.5 flex-shrink-0" />
                      SEO optimization included
                    </li>
                    <li className="flex items-start gap-2">
                      <Check className="w-4 h-4 mt-0.5 flex-shrink-0" />
                      Dedicated project manager
                    </li>
                    <li className="flex items-start gap-2">
                      <Check className="w-4 h-4 mt-0.5 flex-shrink-0" />
                      30-day support & maintenance
                    </li>
                    <li className="flex items-start gap-2">
                      <Check className="w-4 h-4 mt-0.5 flex-shrink-0" />
                      Professional copywriting
                    </li>
                  </ul>
                  <div className="mt-4 pt-4 border-t border-white/20">
                    <p className="text-sm opacity-75">Professional packages</p>
                    <p className="text-2xl font-bold">$420 - $3,750</p>
                  </div>
                </div>
              </div>
            </div>
            
            <div className="flex flex-col sm:flex-row gap-4">
              <Button 
                size="lg" 
                className="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white"
                onClick={() => router.push('/pricing')}
              >
                View Professional Services
                <ArrowRight className="ml-2 w-4 h-4" />
              </Button>
              <Button 
                size="lg" 
                variant="outline"
                className="flex-1 bg-white hover:bg-gray-50"
                onClick={() => router.push('/contact?subject=Website%20Development')}
              >
                Talk to Our Team
              </Button>
            </div>
            
            <p className="text-center text-sm text-gray-600 mt-4">
              ðŸ’¡ <strong>Pro Tip:</strong> Use the DIY builder to test your ideas, then let our team build the production version
            </p>
          </CardContent>
        </Card>

        {/* Purchase Credits Section */}
        {searchParams.get("credits") === "true" && (
          <Card className="border-blue-300 bg-blue-50">
            <CardHeader>
              <div className="flex items-center gap-2">
                <Zap className="w-6 h-6 text-blue-600" />
                <div>
                  <CardTitle>Need More Credits?</CardTitle>
                  <CardDescription>
                    You need credits to create more websites
                  </CardDescription>
                </div>
              </div>
            </CardHeader>
          </Card>
        )}

        {/* Buy Credits */}
        <div>
          <div className="flex items-center justify-between mb-4">
            <div>
              <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                <Coins className="w-6 h-6 text-blue-600" />
                Project Credits
              </h2>
              <p className="text-gray-600 mt-1">
                Your current balance: <span className="font-bold text-lg">{userCredits} credits</span>
              </p>
            </div>
          </div>
          
          <p className="text-sm text-gray-600 mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
            <strong>ðŸ’¡ First project is FREE!</strong> After that, each website creation costs 1 credit. 
            Purchase credit packages below for unlimited website building.
          </p>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {CREDIT_PACKAGES.map((pkg) => {
              const isProcessing = processingCredits === pkg.id;
              
              return (
                <Card
                  key={pkg.id}
                  className={pkg.popular ? "border-2 border-blue-600 relative" : ""}
                >
                  {pkg.popular && (
                    <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
                      <span className="bg-blue-600 text-white text-xs font-semibold px-3 py-1 rounded-full">
                        Best Value
                      </span>
                    </div>
                  )}
                  <CardHeader className="text-center">
                    <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                      <Coins className="w-8 h-8 text-blue-600" />
                    </div>
                    <CardTitle className="text-3xl font-bold">
                      {pkg.credits} Credits
                    </CardTitle>
                    <CardDescription>{pkg.description}</CardDescription>
                    <div className="mt-4">
                      <span className="text-4xl font-bold">${pkg.price}</span>
                      {pkg.savings && (
                        <div className="text-green-600 font-medium mt-2">
                          {pkg.savings}
                        </div>
                      )}
                    </div>
                  </CardHeader>
                  <CardContent>
                    <ul className="space-y-2 mb-4">
                      <li className="flex items-start gap-2">
                        <Check className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                        <span className="text-sm">Create {pkg.credits} websites</span>
                      </li>
                      <li className="flex items-start gap-2">
                        <Check className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                        <span className="text-sm">Credits never expire</span>
                      </li>
                      <li className="flex items-start gap-2">
                        <Check className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                        <span className="text-sm">Works with any plan</span>
                      </li>
                    </ul>
                    <Button 
                      className="w-full" 
                      variant={pkg.popular ? "default" : "outline"}
                      onClick={() => handleBuyCredits(pkg.id, pkg.credits, pkg.price)}
                      disabled={isProcessing}
                    >
                      {isProcessing ? (
                        <>
                          <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                          Processing...
                        </>
                      ) : (
                        <>
                          <Coins className="w-4 h-4 mr-2" />
                          Buy Now
                        </>
                      )}
                    </Button>
                  </CardContent>
                </Card>
              );
            })}
          </div>
        </div>

        {/* Pricing Tiers */}
        {user?.tier === "free" && (
          <>
            <div>
              <h2 className="text-2xl font-bold text-gray-900 mb-2">
                Upgrade Your Plan
              </h2>
              <p className="text-gray-600">
                Choose the plan that best fits your needs
              </p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              {PRICING_TIERS.map((tier) => {
                const config = getTierConfig(tier.id);
                const isProcessing = processingTier === tier.id;
                
                return (
                  <Card
                    key={tier.id}
                    className={tier.popular ? "border-2 border-blue-600" : ""}
                  >
                    {tier.popular && (
                      <div className="bg-blue-600 text-white text-center py-2 text-sm font-semibold rounded-t-lg">
                        Most Popular
                      </div>
                    )}
                    <CardHeader>
                      <CardTitle className="text-xl">{tier.name}</CardTitle>
                      <CardDescription>{tier.description}</CardDescription>
                      <div className="mt-4">
                        <span className="text-3xl font-bold">
                          {tier.priceRange}
                        </span>
                        <span className="text-gray-600">/month</span>
                      </div>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <ul className="space-y-2">
                        {config.features.map((feature, i) => (
                          <li key={i} className="flex items-start gap-2">
                            <Check className="w-4 h-4 text-green-600 mt-0.5 flex-shrink-0" />
                            <span className="text-sm">{feature}</span>
                          </li>
                        ))}
                      </ul>
                      <Button 
                        className="w-full" 
                        variant={tier.popular ? "default" : "outline"}
                        onClick={() => {
                          if (tier.id === "starter") {
                            handleSubscribe(tier.id);
                          } else {
                            handleContactSales(tier.id);
                          }
                        }}
                        disabled={isProcessing}
                      >
                        {isProcessing ? (
                          <>
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                            Processing...
                          </>
                        ) : tier.id === "starter" ? (
                          <>
                            {tier.trial ? "Start 7-Day Trial" : "Subscribe Now"}
                          </>
                        ) : (
                          "Contact Sales"
                        )}
                      </Button>
                    </CardContent>
                  </Card>
                );
              })}
            </div>
          </>
        )}

        {/* Success Message for Paid Plans */}
        {user?.tier !== "free" && (
          <Card>
            <CardHeader>
              <CardTitle>Thank You for Your Subscription!</CardTitle>
              <CardDescription>
                Your {currentTierConfig.name} plan is active
              </CardDescription>
            </CardHeader>
            <CardContent>
              <p className="text-gray-600">
                You now have access to all {currentTierConfig.name} features. If you need to upgrade or have any questions, 
                please contact our sales team.
              </p>
            </CardContent>
          </Card>
        )}
      </div>
  );
}

export default function BillingPage() {
  return (
    <Suspense fallback={
      <div className="flex items-center justify-center min-h-screen">
        <Loader2 className="w-8 h-8 animate-spin text-blue-600" />
      </div>
    }>
      <BillingPageContent />
    </Suspense>
  );
}

// ==========================================
// File: app/dashboard/builder/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Rocket, Sparkles, Layout, Zap, TrendingUp, ArrowRight } from "lucide-react";
import Link from "next/link";

export default async function BuilderPage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  if (user.tier === "free") {
    redirect("/dashboard/billing");
  }

  return (
    <div className="space-y-6">
        <div>
          <h1 className="text-2xl sm:text-3xl font-bold text-gray-900">AI Website Builder</h1>
          <p className="text-sm sm:text-base text-gray-600 mt-1">
            Build your website with AI assistance in minutes
          </p>
        </div>

        {/* Professional Services Banner */}
        <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-4 sm:p-6 text-white shadow-lg">
          <div className="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-2">
                <TrendingUp className="w-5 h-5 sm:w-6 sm:h-6" />
                <h3 className="text-lg sm:text-xl font-bold">Want a Professional Website?</h3>
              </div>
              <p className="text-sm sm:text-base opacity-90">
                DIY is great for testing, but our professional team delivers production-ready, 
                custom websites starting at just $420. No templates, no compromises.
              </p>
            </div>
            <div className="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
              <Button asChild variant="secondary" size="sm" className="w-full sm:w-auto">
                <Link href="/pricing">
                  View Services
                </Link>
              </Button>
              <Button asChild variant="outline" size="sm" className="w-full sm:w-auto bg-white/10 text-white border-white hover:bg-white/20">
                <Link href="/contact?subject=Professional%20Website">
                  <span className="truncate">Talk to Team</span>
                  <ArrowRight className="ml-2 w-4 h-4 flex-shrink-0" />
                </Link>
              </Button>
            </div>
          </div>
        </div>

        {/* Quick Start */}
        <Card className="bg-gradient-to-r from-blue-50 to-purple-50 border-blue-200">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Sparkles className="w-5 h-5 text-blue-600" />
              Build Your DIY Website Now
            </CardTitle>
            <CardDescription>
              Let our AI create a prototype website tailored to your business in minutes
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button asChild size="lg" className="bg-gradient-to-r from-blue-600 to-purple-600">
              <Link href="/builder">
                <Zap className="w-5 h-5 mr-2" />
                Start Building
              </Link>
            </Button>
          </CardContent>
        </Card>

        {/* Features */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <Card>
            <CardHeader>
              <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-4">
                <Sparkles className="w-6 h-6 text-blue-600" />
              </div>
              <CardTitle>AI-Powered Generation</CardTitle>
              <CardDescription>
                Describe your business in a few words and our AI creates a complete website
              </CardDescription>
            </CardHeader>
          </Card>

          <Card>
            <CardHeader>
              <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-4">
                <Layout className="w-6 h-6 text-purple-600" />
              </div>
              <CardTitle>Professional Templates</CardTitle>
              <CardDescription>
                Choose from various templates optimized for different industries
              </CardDescription>
            </CardHeader>
          </Card>

          <Card>
            <CardHeader>
              <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-4">
                <Zap className="w-6 h-6 text-green-600" />
              </div>
              <CardTitle>Instant Deployment</CardTitle>
              <CardDescription>
                Your website goes live instantly on a custom subdomain
              </CardDescription>
            </CardHeader>
          </Card>
        </div>

        {/* How It Works */}
        <Card>
          <CardHeader>
            <CardTitle>How It Works</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div className="flex gap-4">
                <div className="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold flex-shrink-0">
                  1
                </div>
                <div>
                  <h4 className="font-semibold mb-1">Choose a Template</h4>
                  <p className="text-sm text-muted-foreground">
                    Select a template that matches your business type
                  </p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="w-8 h-8 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold flex-shrink-0">
                  2
                </div>
                <div>
                  <h4 className="font-semibold mb-1">Describe Your Business</h4>
                  <p className="text-sm text-muted-foreground">
                    Tell us about your business - or use AI to auto-fill the form
                  </p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center font-bold flex-shrink-0">
                  3
                </div>
                <div>
                  <h4 className="font-semibold mb-1">AI Generates Your Site</h4>
                  <p className="text-sm text-muted-foreground">
                    Our AI creates professional content and designs your website
                  </p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="w-8 h-8 rounded-full bg-orange-600 text-white flex items-center justify-center font-bold flex-shrink-0">
                  4
                </div>
                <div>
                  <h4 className="font-semibold mb-1">Launch & Grow</h4>
                  <p className="text-sm text-muted-foreground">
                    Your website goes live instantly and you can keep improving it
                  </p>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
  );
}

// ==========================================
// File: app/dashboard/content/case-studies/page.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { Plus, Edit, Trash2, Eye, Search } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { Badge } from '@/components/ui/badge';
import Link from 'next/link';
import Image from 'next/image';
import { toast } from 'react-hot-toast';

interface CaseStudy {
  id: string;
  slug: string;
  title: string;
  category: string;
  client: string;
  description: string;
  heroImage: string;
  status: string;
  publishedAt: string | null;
  createdAt: string;
  updatedAt: string;
}

export default function CaseStudiesManagementPage() {
  const { data: session } = useSession();
  const [caseStudies, setCaseStudies] = useState<CaseStudy[]>([]);
  const [filteredStudies, setFilteredStudies] = useState<CaseStudy[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [categoryFilter, setCategoryFilter] = useState('all');
  const [deleteId, setDeleteId] = useState<string | null>(null);

  useEffect(() => {
    fetchCaseStudies();
  }, []);

  useEffect(() => {
    filterStudies();
  }, [caseStudies, searchQuery, statusFilter, categoryFilter]);

  const fetchCaseStudies = async () => {
    try {
      setLoading(true);
      const response = await fetch('/api/content/case-studies');
      const data = await response.json();
      
      if (response.ok) {
        setCaseStudies(data.caseStudies);
      } else {
        toast.error('Failed to fetch case studies');
      }
    } catch (error) {
      console.error('Error fetching case studies:', error);
      toast.error('Failed to fetch case studies');
    } finally {
      setLoading(false);
    }
  };

  const filterStudies = () => {
    let filtered = [...caseStudies];

    // Search filter
    if (searchQuery) {
      filtered = filtered.filter(study =>
        study.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
        study.client.toLowerCase().includes(searchQuery.toLowerCase()) ||
        study.category.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }

    // Status filter
    if (statusFilter !== 'all') {
      filtered = filtered.filter(study => study.status === statusFilter);
    }

    // Category filter
    if (categoryFilter !== 'all') {
      filtered = filtered.filter(study => study.category === categoryFilter);
    }

    setFilteredStudies(filtered);
  };

  const handleDelete = async () => {
    if (!deleteId) return;

    try {
      const response = await fetch(`/api/content/case-studies/${deleteId}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        toast.success('Case study deleted successfully');
        fetchCaseStudies();
      } else {
        toast.error('Failed to delete case study');
      }
    } catch (error) {
      console.error('Error deleting case study:', error);
      toast.error('Failed to delete case study');
    } finally {
      setDeleteId(null);
    }
  };

  const categories = Array.from(new Set(caseStudies.map(s => s.category)));

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900 dark:text-white">
            Case Studies
          </h1>
          <p className="text-gray-600 dark:text-gray-400 mt-1">
            Manage your case studies and success stories
          </p>
        </div>
        <Link href="/dashboard/content/case-studies/new">
          <Button>
            <Plus className="w-4 h-4 mr-2" />
            Add Case Study
          </Button>
        </Link>
      </div>

      {/* Filters */}
      <div className="flex flex-col sm:flex-row gap-4">
        <div className="flex-1">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
            <Input
              placeholder="Search case studies..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10"
            />
          </div>
        </div>
        <Select value={statusFilter} onValueChange={setStatusFilter}>
          <SelectTrigger className="w-full sm:w-[180px]">
            <SelectValue placeholder="Filter by status" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Status</SelectItem>
            <SelectItem value="published">Published</SelectItem>
            <SelectItem value="draft">Draft</SelectItem>
          </SelectContent>
        </Select>
        <Select value={categoryFilter} onValueChange={setCategoryFilter}>
          <SelectTrigger className="w-full sm:w-[200px]">
            <SelectValue placeholder="Filter by category" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Categories</SelectItem>
            {categories.map(cat => (
              <SelectItem key={cat} value={cat}>{cat}</SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* Table */}
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
        {loading ? (
          <div className="p-8 text-center">
            <p className="text-gray-500">Loading case studies...</p>
          </div>
        ) : filteredStudies.length === 0 ? (
          <div className="p-8 text-center">
            <p className="text-gray-500">No case studies found</p>
            <Link href="/dashboard/content/case-studies/new">
              <Button className="mt-4">
                <Plus className="w-4 h-4 mr-2" />
                Create your first case study
              </Button>
            </Link>
          </div>
        ) : (
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Image</TableHead>
                <TableHead>Title</TableHead>
                <TableHead>Client</TableHead>
                <TableHead>Category</TableHead>
                <TableHead>Status</TableHead>
                <TableHead>Updated</TableHead>
                <TableHead className="text-right">Actions</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {filteredStudies.map((study) => (
                <TableRow key={study.id}>
                  <TableCell>
                    <div className="relative w-16 h-16 rounded overflow-hidden bg-gray-100">
                      <Image
                        src={study.heroImage.startsWith('uploads/') ? `/api/file/${encodeURIComponent(study.heroImage)}` : study.heroImage}
                        alt={study.title}
                        fill
                        className="object-cover"
                      />
                    </div>
                  </TableCell>
                  <TableCell className="font-medium">{study.title}</TableCell>
                  <TableCell>{study.client}</TableCell>
                  <TableCell>{study.category}</TableCell>
                  <TableCell>
                    <Badge variant={study.status === 'published' ? 'default' : 'secondary'}>
                      {study.status}
                    </Badge>
                  </TableCell>
                  <TableCell>
                    {new Date(study.updatedAt).toLocaleDateString()}
                  </TableCell>
                  <TableCell className="text-right">
                    <div className="flex items-center justify-end gap-2">
                      <Link href={`/case-studies/${study.slug}`} target="_blank">
                        <Button variant="ghost" size="sm">
                          <Eye className="w-4 h-4" />
                        </Button>
                      </Link>
                      <Link href={`/dashboard/content/case-studies/${study.id}`}>
                        <Button variant="ghost" size="sm">
                          <Edit className="w-4 h-4" />
                        </Button>
                      </Link>
                      {session?.user?.email === 'fray@cdmsuite.com' && (
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => setDeleteId(study.id)}
                        >
                          <Trash2 className="w-4 h-4 text-red-500" />
                        </Button>
                      )}
                    </div>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        )}
      </div>

      {/* Delete Confirmation */}
      <AlertDialog open={!!deleteId} onOpenChange={() => setDeleteId(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Are you sure?</AlertDialogTitle>
            <AlertDialogDescription>
              This action cannot be undone. This will permanently delete the case study.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction onClick={handleDelete} className="bg-red-500 hover:bg-red-600">
              Delete
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}

// ==========================================
// File: app/dashboard/content/case-studies/[id]/page.tsx
// ==========================================

'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { ArrowLeft, Save, Eye, Plus, X, Upload } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import Link from 'next/link';
import Image from 'next/image';
import { toast } from 'react-hot-toast';
import { FileUpload } from '@/components/file-upload';

interface CaseStudyForm {
  slug: string;
  title: string;
  category: string;
  client: string;
  description: string;
  challenge: string;
  solution: string;
  results: string[];
  testimonialQuote: string;
  testimonialAuthor: string;
  testimonialCompany: string;
  heroImage: string;
  tags: string[];
  metaTitle: string;
  metaDescription: string;
  status: string;
}

export default function CaseStudyEditorPage({ params }: { params: { id: string } }) {
  const router = useRouter();
  const isNew = params.id === 'new';
  
  const [loading, setLoading] = useState(!isNew);
  const [saving, setSaving] = useState(false);
  const [newResult, setNewResult] = useState('');
  const [newTag, setNewTag] = useState('');
  
  const [formData, setFormData] = useState<CaseStudyForm>({
    slug: '',
    title: '',
    category: 'E-Commerce',
    client: '',
    description: '',
    challenge: '',
    solution: '',
    results: [],
    testimonialQuote: '',
    testimonialAuthor: '',
    testimonialCompany: '',
    heroImage: '',
    tags: [],
    metaTitle: '',
    metaDescription: '',
    status: 'draft',
  });

  useEffect(() => {
    if (!isNew) {
      fetchCaseStudy();
    }
  }, []);

  const fetchCaseStudy = async () => {
    try {
      setLoading(true);
      const response = await fetch(`/api/content/case-studies/${params.id}`);
      const data = await response.json();
      
      if (response.ok) {
        setFormData({
          ...data.caseStudy,
          results: Array.isArray(data.caseStudy.results) ? data.caseStudy.results : [],
          tags: Array.isArray(data.caseStudy.tags) ? data.caseStudy.tags : [],
        });
      } else {
        toast.error('Failed to fetch case study');
        router.push('/dashboard/content/case-studies');
      }
    } catch (error) {
      console.error('Error fetching case study:', error);
      toast.error('Failed to fetch case study');
      router.push('/dashboard/content/case-studies');
    } finally {
      setLoading(false);
    }
  };

  const handleSave = async (newStatus?: string) => {
    try {
      setSaving(true);
      
      // Validation
      if (!formData.title || !formData.slug || !formData.client) {
        toast.error('Please fill in all required fields');
        return;
      }
      
      const dataToSave = {
        ...formData,
        status: newStatus || formData.status,
      };
      
      const url = isNew 
        ? '/api/content/case-studies' 
        : `/api/content/case-studies/${params.id}`;
      
      const method = isNew ? 'POST' : 'PUT';
      
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSave),
      });
      
      if (response.ok) {
        toast.success(isNew ? 'Case study created successfully' : 'Case study updated successfully');
        
        if (isNew) {
          const data = await response.json();
          router.push(`/dashboard/content/case-studies/${data.caseStudy.id}`);
        } else {
          fetchCaseStudy();
        }
      } else {
        const data = await response.json();
        toast.error(data.error || 'Failed to save case study');
      }
    } catch (error) {
      console.error('Error saving case study:', error);
      toast.error('Failed to save case study');
    } finally {
      setSaving(false);
    }
  };

  const handleAddResult = () => {
    if (newResult.trim()) {
      setFormData({
        ...formData,
        results: [...formData.results, newResult.trim()],
      });
      setNewResult('');
    }
  };

  const handleRemoveResult = (index: number) => {
    setFormData({
      ...formData,
      results: formData.results.filter((_, i) => i !== index),
    });
  };

  const handleAddTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      setFormData({
        ...formData,
        tags: [...formData.tags, newTag.trim()],
      });
      setNewTag('');
    }
  };

  const handleRemoveTag = (tag: string) => {
    setFormData({
      ...formData,
      tags: formData.tags.filter(t => t !== tag),
    });
  };

  const generateSlug = (title: string) => {
    return title
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '');
  };

  const handleTitleChange = (title: string) => {
    setFormData({
      ...formData,
      title,
      slug: generateSlug(title),
    });
  };

  if (loading) {
    return (
      <div className="p-6">
        <div className="flex items-center justify-center min-h-screen">
          <p className="text-gray-500">Loading case study...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6 max-w-5xl mx-auto">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Link href="/dashboard/content/case-studies">
            <Button variant="ghost" size="sm">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Back
            </Button>
          </Link>
          <div>
            <h1 className="text-3xl font-bold text-gray-900 dark:text-white">
              {isNew ? 'New Case Study' : 'Edit Case Study'}
            </h1>
            <p className="text-gray-600 dark:text-gray-400 mt-1">
              {isNew ? 'Create a new case study' : 'Edit case study details'}
            </p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          {!isNew && (
            <Link href={`/case-studies/${formData.slug}`} target="_blank">
              <Button variant="outline">
                <Eye className="w-4 h-4 mr-2" />
                Preview
              </Button>
            </Link>
          )}
          <Button 
            onClick={() => handleSave('draft')} 
            disabled={saving}
            variant="outline"
          >
            Save Draft
          </Button>
          <Button 
            onClick={() => handleSave('published')} 
            disabled={saving}
          >
            <Save className="w-4 h-4 mr-2" />
            {formData.status === 'published' ? 'Update' : 'Publish'}
          </Button>
        </div>
      </div>

      {/* Status Badge */}
      <div>
        <Badge variant={formData.status === 'published' ? 'default' : 'secondary'}>
          {formData.status}
        </Badge>
      </div>

      {/* Basic Information */}
      <Card>
        <CardHeader>
          <CardTitle>Basic Information</CardTitle>
          <CardDescription>Essential details about the case study</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label htmlFor="title">Title *</Label>
            <Input
              id="title"
              value={formData.title}
              onChange={(e) => handleTitleChange(e.target.value)}
              placeholder="Enter case study title"
            />
          </div>
          
          <div>
            <Label htmlFor="slug">URL Slug *</Label>
            <Input
              id="slug"
              value={formData.slug}
              onChange={(e) => setFormData({ ...formData, slug: e.target.value })}
              placeholder="url-friendly-slug"
            />
            <p className="text-sm text-gray-500 mt-1">
              URL: /case-studies/{formData.slug || 'your-slug'}
            </p>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label htmlFor="client">Client Name *</Label>
              <Input
                id="client"
                value={formData.client}
                onChange={(e) => setFormData({ ...formData, client: e.target.value })}
                placeholder="Client name"
              />
            </div>
            
            <div>
              <Label htmlFor="category">Category</Label>
              <Select 
                value={formData.category} 
                onValueChange={(value) => setFormData({ ...formData, category: value })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="E-Commerce">E-Commerce</SelectItem>
                  <SelectItem value="Digital Advertising">Digital Advertising</SelectItem>
                  <SelectItem value="Logistics">Logistics</SelectItem>
                  <SelectItem value="Travel & Tourism">Travel & Tourism</SelectItem>
                  <SelectItem value="Professional Services">Professional Services</SelectItem>
                  <SelectItem value="Other">Other</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>

          <div>
            <Label htmlFor="description">Description</Label>
            <Textarea
              id="description"
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              placeholder="Brief description of the case study"
              rows={3}
            />
          </div>
        </CardContent>
      </Card>

      {/* Hero Image */}
      <Card>
        <CardHeader>
          <CardTitle>Hero Image</CardTitle>
          <CardDescription>Upload the main image for the case study</CardDescription>
        </CardHeader>
        <CardContent>
          <FileUpload
            value={formData.heroImage}
            onChange={(cloudStoragePath) => setFormData({ ...formData, heroImage: cloudStoragePath })}
            label="Hero Image"
            description="Click to upload or drag and drop (PNG, JPG, WEBP up to 10MB)"
          />
          <p className="text-sm text-gray-500 mt-2">
            Recommended size: 1200x630px for optimal display
          </p>
        </CardContent>
      </Card>

      {/* Challenge & Solution */}
      <Card>
        <CardHeader>
          <CardTitle>Challenge & Solution</CardTitle>
          <CardDescription>Describe the problem and how you solved it</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label htmlFor="challenge">The Challenge</Label>
            <Textarea
              id="challenge"
              value={formData.challenge}
              onChange={(e) => setFormData({ ...formData, challenge: e.target.value })}
              placeholder="What challenges did the client face?"
              rows={4}
            />
          </div>
          
          <div>
            <Label htmlFor="solution">Our Solution</Label>
            <Textarea
              id="solution"
              value={formData.solution}
              onChange={(e) => setFormData({ ...formData, solution: e.target.value })}
              placeholder="How did you solve the problem?"
              rows={4}
            />
          </div>
        </CardContent>
      </Card>

      {/* Results */}
      <Card>
        <CardHeader>
          <CardTitle>Results Achieved</CardTitle>
          <CardDescription>Key metrics and outcomes</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex flex-wrap gap-2">
            {formData.results.map((result, index) => (
              <Badge key={index} variant="secondary" className="gap-1 pr-1">
                {result}
                <Button
                  size="sm"
                  variant="ghost"
                  className="h-4 w-4 p-0 hover:bg-transparent"
                  onClick={() => handleRemoveResult(index)}
                >
                  <X className="w-3 h-3" />
                </Button>
              </Badge>
            ))}
          </div>
          
          <div className="flex gap-2">
            <Input
              value={newResult}
              onChange={(e) => setNewResult(e.target.value)}
              placeholder="Add a result (e.g., '150% increase in sales')"
              onKeyPress={(e) => e.key === 'Enter' && handleAddResult()}
            />
            <Button onClick={handleAddResult}>
              <Plus className="w-4 h-4 mr-2" />
              Add
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Testimonial */}
      <Card>
        <CardHeader>
          <CardTitle>Client Testimonial</CardTitle>
          <CardDescription>What the client said about your work</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label htmlFor="testimonialQuote">Quote</Label>
            <Textarea
              id="testimonialQuote"
              value={formData.testimonialQuote}
              onChange={(e) => setFormData({ ...formData, testimonialQuote: e.target.value })}
              placeholder="The client's testimonial"
              rows={4}
            />
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <Label htmlFor="testimonialAuthor">Author</Label>
              <Input
                id="testimonialAuthor"
                value={formData.testimonialAuthor}
                onChange={(e) => setFormData({ ...formData, testimonialAuthor: e.target.value })}
                placeholder="Author name"
              />
            </div>
            
            <div>
              <Label htmlFor="testimonialCompany">Company/Title</Label>
              <Input
                id="testimonialCompany"
                value={formData.testimonialCompany}
                onChange={(e) => setFormData({ ...formData, testimonialCompany: e.target.value })}
                placeholder="Company or title"
              />
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Tags */}
      <Card>
        <CardHeader>
          <CardTitle>Tags</CardTitle>
          <CardDescription>Services provided in this project</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex flex-wrap gap-2">
            {formData.tags.map((tag) => (
              <Badge key={tag} variant="default" className="gap-1 pr-1">
                {tag}
                <Button
                  size="sm"
                  variant="ghost"
                  className="h-4 w-4 p-0 hover:bg-transparent"
                  onClick={() => handleRemoveTag(tag)}
                >
                  <X className="w-3 h-3" />
                </Button>
              </Badge>
            ))}
          </div>
          
          <div className="flex gap-2">
            <Input
              value={newTag}
              onChange={(e) => setNewTag(e.target.value)}
              placeholder="Add a tag (e.g., 'Web Design')"
              onKeyPress={(e) => e.key === 'Enter' && handleAddTag()}
            />
            <Button onClick={handleAddTag}>
              <Plus className="w-4 h-4 mr-2" />
              Add
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* SEO */}
      <Card>
        <CardHeader>
          <CardTitle>SEO Settings</CardTitle>
          <CardDescription>Optimize for search engines</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label htmlFor="metaTitle">Meta Title</Label>
            <Input
              id="metaTitle"
              value={formData.metaTitle}
              onChange={(e) => setFormData({ ...formData, metaTitle: e.target.value })}
              placeholder="SEO title (leave empty to use case study title)"
            />
          </div>
          
          <div>
            <Label htmlFor="metaDescription">Meta Description</Label>
            <Textarea
              id="metaDescription"
              value={formData.metaDescription}
              onChange={(e) => setFormData({ ...formData, metaDescription: e.target.value })}
              placeholder="SEO description (leave empty to use case study description)"
              rows={3}
            />
          </div>
        </CardContent>
      </Card>

      {/* Action Buttons */}
      <div className="flex justify-end gap-2 pb-12">
        <Button 
          onClick={() => handleSave('draft')} 
          disabled={saving}
          variant="outline"
        >
          Save Draft
        </Button>
        <Button 
          onClick={() => handleSave('published')} 
          disabled={saving}
        >
          <Save className="w-4 h-4 mr-2" />
          {formData.status === 'published' ? 'Update Published' : 'Publish Now'}
        </Button>
      </div>
    </div>
  );
}

// ==========================================
// File: app/dashboard/crm/page.tsx
// ==========================================

'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { Lead, LeadStatus, LeadFilters } from '@/lib/crm-types';
import { KanbanBoard } from '@/components/crm/kanban-board';
import { LeadsTable } from '@/components/crm/leads-table';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ActivityTimeline } from '@/components/crm/activity-timeline';
import { LeadSequences } from '@/components/crm/lead-sequences';
import { BulkImportDialog } from '@/components/crm/bulk-import-dialog';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import {
  Search,
  Plus,
  Filter,
  Users,
  TrendingUp,
  Star,
  Calendar,
  Phone,
  Mail,
  Building2,
  DollarSign,
  Clock,
  Save,
  X,
  Upload,
  FileText,
  Loader2,
  Trash2,
  Download,
  LayoutGrid,
  Table as TableIcon,
  CheckSquare
} from 'lucide-react';
import { LEAD_PRIORITIES, LEAD_SOURCES, formatLeadSource, getPriorityColor } from '@/lib/crm-utils';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';

export default function CRMPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [leads, setLeads] = useState<Lead[]>([]);
  const [filteredLeads, setFilteredLeads] = useState<Lead[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedLead, setSelectedLead] = useState<Lead | null>(null);
  const [showLeadDialog, setShowLeadDialog] = useState(false);
  const [showNewActivityDialog, setShowNewActivityDialog] = useState(false);
  const [showNewLeadDialog, setShowNewLeadDialog] = useState(false);
  const [showBulkImportDialog, setShowBulkImportDialog] = useState(false);
  const [creatingLead, setCreatingLead] = useState(false);
  const [addingActivity, setAddingActivity] = useState(false);
  const [deletingLead, setDeletingLead] = useState(false);
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);
  
  // View mode and bulk operations
  const [viewMode, setViewMode] = useState<'kanban' | 'table'>('kanban');
  const [selectedLeads, setSelectedLeads] = useState<string[]>([]);
  const [bulkDeleting, setBulkDeleting] = useState(false);
  const [exporting, setExporting] = useState(false);
  const [showBulkDeleteDialog, setShowBulkDeleteDialog] = useState(false);
  
  // Filters
  const [filters, setFilters] = useState<LeadFilters>({
    search: '',
    status: undefined,
    priority: undefined,
    source: undefined
  });

  // New Activity Form
  const [newActivity, setNewActivity] = useState({
    type: 'note',
    title: '',
    description: ''
  });

  // New Lead Form
  const [newLeadForm, setNewLeadForm] = useState({
    email: '',
    name: '',
    phone: '',
    company: '',
    source: 'manual',
    interest: '',
    status: 'new',
    priority: 'medium',
    budget: '',
    timeline: '',
    notes: '',
  });

  // Fetch leads
  useEffect(() => {
    if (status === 'authenticated') {
      fetchLeads();
    }
  }, [status]);

  // Handle leadId query parameter for direct navigation from dashboard
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const leadId = params.get('leadId');
    
    if (leadId && leads.length > 0) {
      const lead = leads.find(l => l.id === leadId);
      if (lead) {
        handleLeadClick(lead);
        // Clear the URL parameter
        window.history.replaceState({}, '', '/dashboard/crm');
      }
    }
  }, [leads]);

  // Apply filters
  useEffect(() => {
    let filtered = [...leads];

    if (filters.search) {
      const search = filters.search.toLowerCase();
      filtered = filtered.filter(
        lead =>
          lead.email.toLowerCase().includes(search) ||
          lead.name?.toLowerCase().includes(search) ||
          lead.company?.toLowerCase().includes(search)
      );
    }

    if (filters.status) {
      filtered = filtered.filter(lead => lead.status === filters.status);
    }

    if (filters.priority) {
      filtered = filtered.filter(lead => lead.priority === filters.priority);
    }

    if (filters.source) {
      filtered = filtered.filter(lead => lead.source === filters.source);
    }

    setFilteredLeads(filtered);
  }, [leads, filters]);

  const fetchLeads = async () => {
    try {
      setLoading(true);
      const res = await fetch('/api/crm/leads');
      if (res.ok) {
        const data = await res.json();
        setLeads(data.leads);
      } else {
        toast.error('Failed to fetch leads');
      }
    } catch (error) {
      console.error('Error fetching leads:', error);
      toast.error('An error occurred');
    } finally {
      setLoading(false);
    }
  };

  const handleCreateLead = async () => {
    try {
      // Validate required fields
      if (!newLeadForm.name && !newLeadForm.email && !newLeadForm.phone) {
        toast.error('Please provide at least a name, email, or phone number');
        return;
      }

      // Ensure source is set
      if (!newLeadForm.source) {
        toast.error('Please select a source');
        return;
      }

      setCreatingLead(true);
      
      const res = await fetch('/api/crm/leads', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newLeadForm),
      });

      const data = await res.json();

      if (!res.ok) {
        // Handle error response
        toast.error(data.error || 'Failed to create lead');
        return;
      }

      // Success - update state and close dialog
      setLeads([data.lead, ...leads]);
      toast.success('Lead created successfully! ðŸŽ‰');
      
      // Reset form
      setNewLeadForm({
        email: '',
        name: '',
        phone: '',
        company: '',
        source: 'manual',
        interest: '',
        status: 'new',
        priority: 'medium',
        budget: '',
        timeline: '',
        notes: '',
      });
      
      // Close dialog
      setShowNewLeadDialog(false);
    } catch (error: any) {
      console.error('Error creating lead:', error);
      toast.error(error?.message || 'An unexpected error occurred');
    } finally {
      // Always reset loading state
      setCreatingLead(false);
    }
  };

  const handleLeadClick = async (lead: Lead) => {
    try {
      // Fetch full lead details
      const res = await fetch(`/api/crm/leads/${lead.id}`);
      if (res.ok) {
        const data = await res.json();
        setSelectedLead(data.lead);
        setShowLeadDialog(true);
      }
    } catch (error) {
      console.error('Error fetching lead details:', error);
      toast.error('Failed to load lead details');
    }
  };

  const handleStatusChange = async (leadId: string, newStatus: LeadStatus) => {
    try {
      const res = await fetch(`/api/crm/leads/${leadId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });

      if (res.ok) {
        const data = await res.json();
        setLeads(leads.map(l => (l.id === leadId ? data.lead : l)));
        toast.success('Lead status updated');
      } else {
        toast.error('Failed to update lead status');
      }
    } catch (error) {
      console.error('Error updating lead:', error);
      toast.error('An error occurred');
    }
  };

  const handleAddActivity = async () => {
    if (!selectedLead || !newActivity.title) {
      toast.error('Please fill in all required fields');
      return;
    }

    setAddingActivity(true);
    try {
      const res = await fetch(`/api/crm/leads/${selectedLead.id}/activities`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newActivity)
      });

      if (res.ok) {
        const data = await res.json();
        // Refresh lead details
        const leadRes = await fetch(`/api/crm/leads/${selectedLead.id}`);
        if (leadRes.ok) {
          const leadData = await leadRes.json();
          setSelectedLead(leadData.lead);
        }
        
        toast.success('Activity added successfully! ðŸ“');
        setNewActivity({ type: 'note', title: '', description: '' });
        setShowNewActivityDialog(false);
      } else {
        toast.error('Failed to add activity');
      }
    } catch (error) {
      console.error('Error adding activity:', error);
      toast.error('An error occurred while adding activity');
    } finally {
      setAddingActivity(false);
    }
  };

  const handleDeleteLead = async () => {
    if (!selectedLead) return;

    setDeletingLead(true);
    try {
      const res = await fetch(`/api/crm/leads/${selectedLead.id}`, {
        method: 'DELETE'
      });

      if (res.ok) {
        // Remove lead from list
        setLeads(leads.filter(l => l.id !== selectedLead.id));
        toast.success('Lead deleted successfully');
        setShowDeleteDialog(false);
        setShowLeadDialog(false);
        setSelectedLead(null);
      } else {
        const error = await res.json();
        toast.error(error.error || 'Failed to delete lead');
      }
    } catch (error) {
      console.error('Error deleting lead:', error);
      toast.error('An error occurred while deleting the lead');
    } finally {
      setDeletingLead(false);
    }
  };

  const handleBulkDelete = async () => {
    if (selectedLeads.length === 0) return;

    setBulkDeleting(true);
    try {
      const res = await fetch('/api/crm/leads/bulk-delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ leadIds: selectedLeads })
      });

      if (res.ok) {
        const data = await res.json();
        // Remove deleted leads from list
        setLeads(leads.filter(l => !selectedLeads.includes(l.id)));
        setSelectedLeads([]);
        toast.success(data.message || `Successfully deleted ${data.deleted} lead(s)`);
        setShowBulkDeleteDialog(false);
      } else {
        const error = await res.json();
        toast.error(error.error || 'Failed to delete leads');
      }
    } catch (error) {
      console.error('Error bulk deleting leads:', error);
      toast.error('An error occurred while deleting leads');
    } finally {
      setBulkDeleting(false);
    }
  };

  const handleExport = async (type: 'selected' | 'all') => {
    setExporting(true);
    try {
      const params = new URLSearchParams();
      
      if (type === 'selected' && selectedLeads.length > 0) {
        params.set('leadIds', selectedLeads.join(','));
      } else if (type === 'all') {
        // Export with current filters
        if (filters.status) params.set('status', filters.status);
        if (filters.priority) params.set('priority', filters.priority);
        if (filters.source) params.set('source', filters.source);
      }

      const res = await fetch(`/api/crm/leads/export?${params.toString()}`);
      
      if (res.ok) {
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `leads-export-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        toast.success(`Successfully exported ${type === 'selected' ? selectedLeads.length : filteredLeads.length} lead(s)`);
      } else {
        toast.error('Failed to export leads');
      }
    } catch (error) {
      console.error('Error exporting leads:', error);
      toast.error('An error occurred while exporting leads');
    } finally {
      setExporting(false);
    }
  };

  if (status === 'loading' || loading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600" />
      </div>
    );
  }

  if (status === 'unauthenticated') {
    router.push('/login');
    return null;
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-2xl sm:text-3xl font-bold text-gray-900">Lead CRM</h1>
        <p className="text-sm sm:text-base text-gray-600 mt-1">Manage and nurture your leads</p>
      </div>

      <div className="bg-white border border-gray-200 rounded-lg">
        <div className="px-3 sm:px-6 py-3 sm:py-4 border-b border-gray-200">
          <div className="flex items-center justify-between gap-3">
            {/* View Toggle */}
            <div className="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
              <Button
                variant={viewMode === 'kanban' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => {
                  setViewMode('kanban');
                  setSelectedLeads([]);
                }}
                className="h-8"
              >
                <LayoutGrid className="h-4 w-4 sm:mr-2" />
                <span className="hidden sm:inline">Kanban</span>
              </Button>
              <Button
                variant={viewMode === 'table' ? 'default' : 'ghost'}
                size="sm"
                onClick={() => setViewMode('table')}
                className="h-8"
              >
                <TableIcon className="h-4 w-4 sm:mr-2" />
                <span className="hidden sm:inline">Table</span>
              </Button>
            </div>

          <div className="flex items-center gap-2">
            <Button variant="outline" size="sm" onClick={() => setShowBulkImportDialog(true)} className="flex-shrink-0">
              <Upload className="h-4 w-4 sm:mr-2" />
              <span className="hidden sm:inline">Import</span>
            </Button>
            <Button 
              variant="outline" 
              size="sm" 
              onClick={() => handleExport('all')}
              disabled={exporting}
              className="flex-shrink-0"
            >
              {exporting ? (
                <Loader2 className="h-4 w-4 sm:mr-2 animate-spin" />
              ) : (
                <Download className="h-4 w-4 sm:mr-2" />
              )}
              <span className="hidden sm:inline">Export All</span>
            </Button>
            <Button size="sm" onClick={() => setShowNewLeadDialog(true)} className="flex-shrink-0">
              <Plus className="h-4 w-4 sm:mr-2" />
              <span className="hidden lg:inline">New Lead</span>
              <span className="lg:hidden">New</span>
            </Button>
          </div>
        </div>

          {/* Bulk Actions Toolbar */}
          {selectedLeads.length > 0 && (
            <div className="px-3 sm:px-6 py-3 border-b border-gray-200 bg-blue-50">
              <div className="flex items-center justify-between gap-3">
                <div className="flex items-center gap-2">
                  <CheckSquare className="h-4 w-4 text-blue-600" />
                  <span className="text-sm font-medium text-blue-900">
                    {selectedLeads.length} lead{selectedLeads.length !== 1 ? 's' : ''} selected
                  </span>
                </div>
                <div className="flex items-center gap-2">
                  <Button 
                    variant="outline" 
                    size="sm"
                    onClick={() => handleExport('selected')}
                    disabled={exporting}
                  >
                    {exporting ? (
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    ) : (
                      <Download className="h-4 w-4 mr-2" />
                    )}
                    Export Selected
                  </Button>
                  {session?.user?.email === 'fray@cdmsuite.com' && (
                    <Button 
                      variant="destructive" 
                      size="sm"
                      onClick={() => setShowBulkDeleteDialog(true)}
                    >
                      <Trash2 className="h-4 w-4 mr-2" />
                      Delete Selected
                    </Button>
                  )}
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => setSelectedLeads([])}
                  >
                    <X className="h-4 w-4" />
                  </Button>
                </div>
              </div>
            </div>
          )}

          {/* Filters */}
          <div className="flex flex-col sm:flex-row gap-3 mt-4 px-3 sm:px-6">
            <div className="flex-1">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                <Input
                  placeholder="Search leads..."
                  value={filters.search}
                  onChange={e => setFilters({ ...filters, search: e.target.value })}
                  className="pl-10 text-sm sm:text-base"
                />
              </div>
            </div>

            <div className="flex gap-2">
              <Select
                value={filters.priority || 'all'}
                onValueChange={value =>
                  setFilters({ ...filters, priority: value === 'all' ? undefined : value as any })
                }
              >
                <SelectTrigger className="flex-1 sm:w-40">
                  <SelectValue placeholder="Priority" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Priorities</SelectItem>
                  {LEAD_PRIORITIES.map(p => (
                    <SelectItem key={p.value} value={p.value}>
                      {p.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>

              <Select
                value={filters.source || 'all'}
                onValueChange={value =>
                  setFilters({ ...filters, source: value === 'all' ? undefined : value })
                }
              >
                <SelectTrigger className="flex-1 sm:w-48">
                  <SelectValue placeholder="Source" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Sources</SelectItem>
                  {LEAD_SOURCES.map(s => (
                    <SelectItem key={s.value} value={s.value}>
                      {s.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {(filters.priority || filters.source || filters.search) && (
              <Button
                variant="ghost"
                size="sm"
                onClick={() => setFilters({ search: '', status: undefined, priority: undefined, source: undefined })}
                className="flex-shrink-0"
              >
                <X className="h-4 w-4 sm:mr-2" />
                <span className="hidden sm:inline">Clear</span>
              </Button>
            )}
          </div>
        </div>

        {/* View Content */}
        <div className="p-3 sm:p-6">
          {viewMode === 'kanban' ? (
            <KanbanBoard
              leads={filteredLeads}
              onLeadClick={handleLeadClick}
              onStatusChange={handleStatusChange}
            />
          ) : (
            <LeadsTable
              leads={filteredLeads}
              selectedLeads={selectedLeads}
              onLeadClick={handleLeadClick}
              onSelectionChange={setSelectedLeads}
            />
          )}
        </div>
      </div>

      {/* Lead Detail Dialog */}
      <Dialog open={showLeadDialog} onOpenChange={setShowLeadDialog}>
        <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
          {selectedLead && (
            <>
              <DialogHeader>
                <div className="flex items-center justify-between">
                  <DialogTitle className="flex items-center gap-3">
                    <span>{selectedLead.name || selectedLead.email}</span>
                    <Badge className={cn(
                      selectedLead.score >= 80 ? "bg-green-100 text-green-700" :
                      selectedLead.score >= 50 ? "bg-yellow-100 text-yellow-700" :
                      "bg-gray-100 text-gray-700"
                    )}>
                      <Star className="h-3 w-3 mr-1" />
                      Score: {selectedLead.score}
                    </Badge>
                  </DialogTitle>
                  {session?.user?.email === 'fray@cdmsuite.com' && (
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => setShowDeleteDialog(true)}
                      className="text-red-600 hover:text-red-700 hover:bg-red-50"
                    >
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  )}
                </div>
                <DialogDescription>
                  Lead from {formatLeadSource(selectedLead.source)}
                </DialogDescription>
              </DialogHeader>

              {/* Action Buttons */}
              <div className="flex gap-2 mt-4">
                <Button
                  variant="default"
                  size="sm"
                  onClick={() => {
                    const params = new URLSearchParams({
                      leadId: selectedLead.id,
                      clientName: selectedLead.name || '',
                      clientEmail: selectedLead.email || '',
                      clientPhone: selectedLead.phone || '',
                      clientCompany: selectedLead.company || '',
                      interest: selectedLead.interest || '',
                    });
                    router.push(`/dashboard/proposals/new?${params.toString()}`);
                  }}
                >
                  <FileText className="h-4 w-4 mr-2" />
                  Create Proposal
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => router.push(`/dashboard/proposals?leadId=${selectedLead.id}`)}
                >
                  View Proposals
                </Button>
              </div>

              <Tabs defaultValue="details" className="mt-4">
                <TabsList>
                  <TabsTrigger value="details">Details</TabsTrigger>
                  <TabsTrigger value="activity">
                    Activity
                    {selectedLead.activities && selectedLead.activities.length > 0 && (
                      <Badge variant="secondary" className="ml-2">
                        {selectedLead.activities.length}
                      </Badge>
                    )}
                  </TabsTrigger>
                  <TabsTrigger value="sequences">Sequences</TabsTrigger>
                </TabsList>

                <TabsContent value="details" className="space-y-4">
                  {/* Contact Information */}
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label className="text-xs text-gray-500">Email</Label>
                      <div className="flex items-center gap-2 mt-1">
                        <Mail className="h-4 w-4 text-gray-400" />
                        <span className="text-sm">{selectedLead.email}</span>
                      </div>
                    </div>

                    {selectedLead.phone && (
                      <div>
                        <Label className="text-xs text-gray-500">Phone</Label>
                        <div className="flex items-center gap-2 mt-1">
                          <Phone className="h-4 w-4 text-gray-400" />
                          <span className="text-sm">{selectedLead.phone}</span>
                        </div>
                      </div>
                    )}

                    {selectedLead.company && (
                      <div>
                        <Label className="text-xs text-gray-500">Company</Label>
                        <div className="flex items-center gap-2 mt-1">
                          <Building2 className="h-4 w-4 text-gray-400" />
                          <span className="text-sm">{selectedLead.company}</span>
                        </div>
                      </div>
                    )}

                    <div>
                      <Label className="text-xs text-gray-500">Priority</Label>
                      <div className="flex items-center gap-2 mt-1">
                        <span className={cn("text-sm capitalize", getPriorityColor(selectedLead.priority))}>
                          {selectedLead.priority}
                        </span>
                      </div>
                    </div>

                    {selectedLead.budget && (
                      <div>
                        <Label className="text-xs text-gray-500">Budget</Label>
                        <div className="flex items-center gap-2 mt-1">
                          <DollarSign className="h-4 w-4 text-gray-400" />
                          <span className="text-sm">{selectedLead.budget}</span>
                        </div>
                      </div>
                    )}

                    {selectedLead.timeline && (
                      <div>
                        <Label className="text-xs text-gray-500">Timeline</Label>
                        <div className="flex items-center gap-2 mt-1">
                          <Clock className="h-4 w-4 text-gray-400" />
                          <span className="text-sm">{selectedLead.timeline}</span>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Interest */}
                  {selectedLead.interest && (
                    <div>
                      <Label className="text-xs text-gray-500">Interest</Label>
                      <p className="text-sm mt-1">{selectedLead.interest}</p>
                    </div>
                  )}

                  {/* Notes */}
                  {selectedLead.notes && (
                    <div>
                      <Label className="text-xs text-gray-500">Notes</Label>
                      <p className="text-sm mt-1 whitespace-pre-wrap">{selectedLead.notes}</p>
                    </div>
                  )}

                  {/* Tags */}
                  {selectedLead.tags && selectedLead.tags.length > 0 && (
                    <div>
                      <Label className="text-xs text-gray-500">Tags</Label>
                      <div className="flex flex-wrap gap-2 mt-1">
                        {selectedLead.tags.map(tag => (
                          <Badge key={tag} variant="secondary">{tag}</Badge>
                        ))}
                      </div>
                    </div>
                  )}
                </TabsContent>

                <TabsContent value="activity" className="space-y-4">
                  <div className="flex justify-between items-center">
                    <h3 className="font-semibold">Activity Timeline</h3>
                    <Button size="sm" onClick={() => setShowNewActivityDialog(true)}>
                      <Plus className="h-4 w-4 mr-2" />
                      Add Activity
                    </Button>
                  </div>
                  
                  <ActivityTimeline activities={selectedLead.activities || []} />
                </TabsContent>

                <TabsContent value="sequences">
                  <LeadSequences leadId={selectedLead.id} />
                </TabsContent>
              </Tabs>
            </>
          )}
        </DialogContent>
      </Dialog>

      {/* New Activity Dialog */}
      <Dialog open={showNewActivityDialog} onOpenChange={setShowNewActivityDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Add Activity</DialogTitle>
            <DialogDescription>Record an interaction with this lead</DialogDescription>
          </DialogHeader>

          <div className="space-y-4 mt-4">
            <div>
              <Label>Type</Label>
              <Select
                value={newActivity.type}
                onValueChange={value => setNewActivity({ ...newActivity, type: value })}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="note">Note</SelectItem>
                  <SelectItem value="email">Email</SelectItem>
                  <SelectItem value="call">Call</SelectItem>
                  <SelectItem value="meeting">Meeting</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label>Title</Label>
              <Input
                value={newActivity.title}
                onChange={e => setNewActivity({ ...newActivity, title: e.target.value })}
                placeholder="Brief summary"
              />
            </div>

            <div>
              <Label>Description</Label>
              <Textarea
                value={newActivity.description}
                onChange={e => setNewActivity({ ...newActivity, description: e.target.value })}
                placeholder="Additional details..."
                rows={4}
              />
            </div>

            <div className="flex justify-end gap-2">
              <Button 
                variant="outline" 
                onClick={() => setShowNewActivityDialog(false)}
                disabled={addingActivity}
              >
                Cancel
              </Button>
              <Button 
                onClick={handleAddActivity}
                disabled={addingActivity}
              >
                {addingActivity ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Saving...
                  </>
                ) : (
                  <>
                    <Save className="h-4 w-4 mr-2" />
                    Save Activity
                  </>
                )}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* New Lead Dialog */}
      <Dialog open={showNewLeadDialog} onOpenChange={setShowNewLeadDialog}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>Create New Lead</DialogTitle>
            <DialogDescription>Add a new lead to your CRM</DialogDescription>
          </DialogHeader>

          <div className="space-y-4 mt-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Name *</Label>
                <Input
                  value={newLeadForm.name}
                  onChange={e => setNewLeadForm({ ...newLeadForm, name: e.target.value })}
                  placeholder="John Doe"
                />
              </div>
              <div>
                <Label>Email</Label>
                <Input
                  type="email"
                  value={newLeadForm.email}
                  onChange={e => setNewLeadForm({ ...newLeadForm, email: e.target.value })}
                  placeholder="john@example.com (optional)"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Phone</Label>
                <Input
                  value={newLeadForm.phone}
                  onChange={e => setNewLeadForm({ ...newLeadForm, phone: e.target.value })}
                  placeholder="+1 (555) 000-0000"
                />
              </div>
              <div>
                <Label>Company</Label>
                <Input
                  value={newLeadForm.company}
                  onChange={e => setNewLeadForm({ ...newLeadForm, company: e.target.value })}
                  placeholder="Acme Inc."
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Priority</Label>
                <Select
                  value={newLeadForm.priority}
                  onValueChange={value => setNewLeadForm({ ...newLeadForm, priority: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {LEAD_PRIORITIES.map(p => (
                      <SelectItem key={p.value} value={p.value}>
                        {p.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Source</Label>
                <Select
                  value={newLeadForm.source}
                  onValueChange={value => setNewLeadForm({ ...newLeadForm, source: value })}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {LEAD_SOURCES.map(s => (
                      <SelectItem key={s.value} value={s.value}>
                        {s.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div>
              <Label>Interest / Services Needed</Label>
              <Input
                value={newLeadForm.interest}
                onChange={e => setNewLeadForm({ ...newLeadForm, interest: e.target.value })}
                placeholder="e.g., Website development, SEO services"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label>Budget Range</Label>
                <Input
                  value={newLeadForm.budget}
                  onChange={e => setNewLeadForm({ ...newLeadForm, budget: e.target.value })}
                  placeholder="e.g., $5,000 - $10,000"
                />
              </div>
              <div>
                <Label>Timeline</Label>
                <Input
                  value={newLeadForm.timeline}
                  onChange={e => setNewLeadForm({ ...newLeadForm, timeline: e.target.value })}
                  placeholder="e.g., 2-3 months"
                />
              </div>
            </div>

            <div>
              <Label>Notes</Label>
              <Textarea
                value={newLeadForm.notes}
                onChange={e => setNewLeadForm({ ...newLeadForm, notes: e.target.value })}
                placeholder="Additional notes about this lead..."
                rows={3}
              />
            </div>

            <div className="flex justify-end gap-2 pt-4 border-t">
              <Button 
                variant="outline" 
                onClick={() => setShowNewLeadDialog(false)}
                disabled={creatingLead}
              >
                Cancel
              </Button>
              <Button 
                onClick={handleCreateLead}
                disabled={creatingLead}
              >
                {creatingLead ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Creating...
                  </>
                ) : (
                  <>
                    <Plus className="h-4 w-4 mr-2" />
                    Create Lead
                  </>
                )}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Bulk Import Dialog */}
      <BulkImportDialog
        open={showBulkImportDialog}
        onOpenChange={setShowBulkImportDialog}
        onImportComplete={fetchLeads}
      />

      {/* Delete Confirmation Dialog */}
      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete Lead?</AlertDialogTitle>
            <AlertDialogDescription>
              Are you sure you want to delete this lead? This action cannot be undone.
              {selectedLead && (
                <div className="mt-3 p-3 bg-gray-50 rounded-lg">
                  <p className="font-medium text-gray-900">{selectedLead.name || 'No name'}</p>
                  <p className="text-sm text-gray-600">{selectedLead.email}</p>
                  {selectedLead.company && (
                    <p className="text-sm text-gray-600">{selectedLead.company}</p>
                  )}
                </div>
              )}
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={deletingLead}>Cancel</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDeleteLead}
              disabled={deletingLead}
              className="bg-red-600 hover:bg-red-700"
            >
              {deletingLead ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Deleting...
                </>
              ) : (
                <>
                  <Trash2 className="h-4 w-4 mr-2" />
                  Delete Lead
                </>
              )}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* Bulk Delete Confirmation Dialog */}
      <AlertDialog open={showBulkDeleteDialog} onOpenChange={setShowBulkDeleteDialog}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete Multiple Leads?</AlertDialogTitle>
            <AlertDialogDescription>
              Are you sure you want to delete {selectedLeads.length} lead{selectedLeads.length !== 1 ? 's' : ''}? This action cannot be undone.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={bulkDeleting}>Cancel</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleBulkDelete}
              disabled={bulkDeleting}
              className="bg-red-600 hover:bg-red-700"
            >
              {bulkDeleting ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Deleting...
                </>
              ) : (
                <>
                  <Trash2 className="h-4 w-4 mr-2" />
                  Delete {selectedLeads.length} Lead{selectedLeads.length !== 1 ? 's' : ''}
                </>
              )}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}

// ==========================================
// File: app/dashboard/crm/sequences/new/page.tsx
// ==========================================


'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { toast } from 'sonner';
import {
  ArrowLeft,
  Plus,
  Sparkles,
  Save,
  Trash2,
  GripVertical,
} from 'lucide-react';
import {
  SEQUENCE_TYPES,
  TARGET_AUDIENCES,
  STEP_TYPES,
  DELAY_UNITS,
  MERGE_TAGS,
  SequenceStep,
} from '@/lib/sequence-types';
import { validateSequenceSteps, estimateSequenceDuration } from '@/lib/sequence-utils';
import { WYSIWYGEmailEditor } from '@/components/crm/sequences/wysiwyg-email-editor';

export default function NewSequencePage() {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [aiGenerating, setAiGenerating] = useState(false);
  
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    type: 'email',
    targetAudience: 'new_lead',
  });
  
  const [steps, setSteps] = useState<SequenceStep[]>([
    {
      order: 1,
      stepType: 'email',
      title: '',
      content: '',
      subject: '',
      delayAmount: 0,
      delayUnit: 'hours',
      delayFrom: 'start',
    },
  ]);

  const handleAddStep = () => {
    const newStep: SequenceStep = {
      order: steps.length + 1,
      stepType: 'email',
      title: '',
      content: '',
      subject: '',
      delayAmount: 0,
      delayUnit: 'hours',
      delayFrom: 'previous',
    };
    setSteps([...steps, newStep]);
  };

  const handleRemoveStep = (index: number) => {
    const newSteps = steps.filter((_, i) => i !== index);
    // Reorder steps
    newSteps.forEach((step, i) => {
      step.order = i + 1;
    });
    setSteps(newSteps);
  };

  const handleStepChange = (index: number, field: string, value: any) => {
    const newSteps = [...steps];
    (newSteps[index] as any)[field] = value;
    setSteps(newSteps);
  };

  const handleAIGenerate = async () => {
    try {
      setAiGenerating(true);
      
      // Show a toast with the type being generated
      const typeLabel = SEQUENCE_TYPES.find(t => t.value === formData.type)?.label || 'Email';
      toast.info(`Generating ${typeLabel} sequence with AI...`);
      
      const response = await fetch('/api/ai/generate-sequence', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          leadContext: {
            interest: formData.targetAudience,
          },
          preferredType: formData.type, // Pass the selected type!
        }),
      });

      if (!response.ok) throw new Error('AI generation failed');

      const data = await response.json();
      
      setFormData({
        ...formData,
        name: data.name || formData.name,
        description: data.description || formData.description,
        type: data.type || formData.type,
        targetAudience: data.targetAudience || formData.targetAudience,
      });
      
      if (data.steps && data.steps.length > 0) {
        setSteps(data.steps);
      }

      toast.success(`ðŸŽ‰ ${typeLabel} sequence generated successfully!`);
    } catch (error) {
      console.error('Error generating sequence:', error);
      toast.error('Failed to generate sequence with AI');
    } finally {
      setAiGenerating(false);
    }
  };

  const handleSave = async (status: 'pending' | 'approved') => {
    try {
      // Validate
      if (!formData.name.trim()) {
        toast.error('Sequence name is required');
        return;
      }

      const validation = validateSequenceSteps(steps);
      if (!validation.valid) {
        toast.error(validation.errors[0]);
        return;
      }

      setLoading(true);

      const response = await fetch('/api/crm/sequences', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...formData,
          steps,
          status,
          aiGenerated: false,
        }),
      });

      if (!response.ok) throw new Error('Failed to create sequence');

      const data = await response.json();
      toast.success('Sequence created successfully!');
      router.push(`/dashboard/crm/sequences/${data.sequence.id}`);
    } catch (error) {
      console.error('Error saving sequence:', error);
      toast.error('Failed to save sequence');
    } finally {
      setLoading(false);
    }
  };

  const duration = estimateSequenceDuration(steps);

  return (
    <div className="space-y-6 max-w-5xl">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button
            variant="ghost"
            size="sm"
            onClick={() => router.back()}
          >
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back
          </Button>
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Create Sequence</h1>
            <p className="text-muted-foreground mt-1">
              Build an automated lead nurture sequence
            </p>
          </div>
        </div>
        <div className="flex flex-col items-end gap-1">
          <Button
            onClick={handleAIGenerate}
            variant="outline"
            disabled={aiGenerating}
          >
            <Sparkles className="h-4 w-4 mr-2" />
            {aiGenerating ? 'Generating...' : 'AI Generate'}
          </Button>
          <p className="text-xs text-muted-foreground">
            Select type below, then generate
          </p>
        </div>
      </div>

      {/* Basic Info */}
      <Card>
        <CardHeader>
          <CardTitle>Sequence Details</CardTitle>
          <CardDescription>
            Basic information about your sequence
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid gap-4 md:grid-cols-2">
            <div className="space-y-2">
              <Label htmlFor="name">Sequence Name*</Label>
              <Input
                id="name"
                placeholder="e.g., New Lead Welcome Sequence"
                value={formData.name}
                onChange={(e) =>
                  setFormData({ ...formData, name: e.target.value })
                }
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="type">Sequence Type* ðŸŽ¯</Label>
              <Select
                value={formData.type}
                onValueChange={(value) =>
                  setFormData({ ...formData, type: value })
                }
              >
                <SelectTrigger id="type">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {SEQUENCE_TYPES.map((type) => (
                    <SelectItem key={type.value} value={type.value}>
                      {type.label}
                      {type.value === 'email' && ' - Detailed messaging'}
                      {type.value === 'sms' && ' - Quick, direct messages'}
                      {type.value === 'mixed' && ' - Best of both worlds'}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <p className="text-xs text-muted-foreground">
                AI will generate steps based on your selected type
              </p>
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="targetAudience">Target Audience*</Label>
            <Select
              value={formData.targetAudience}
              onValueChange={(value) =>
                setFormData({ ...formData, targetAudience: value })
              }
            >
              <SelectTrigger id="targetAudience">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {TARGET_AUDIENCES.map((audience) => (
                  <SelectItem key={audience.value} value={audience.value}>
                    {audience.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            <Label htmlFor="description">Description</Label>
            <Textarea
              id="description"
              placeholder="Describe the purpose and strategy of this sequence..."
              value={formData.description}
              onChange={(e) =>
                setFormData({ ...formData, description: e.target.value })
              }
              rows={3}
            />
          </div>
        </CardContent>
      </Card>

      {/* Sequence Steps */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>Sequence Steps</CardTitle>
              <CardDescription>
                Build your sequence flow â€¢ Estimated duration: {duration.formatted}
              </CardDescription>
            </div>
            <Button onClick={handleAddStep} variant="outline" size="sm">
              <Plus className="h-4 w-4 mr-2" />
              Add Step
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-6">
          {steps.map((step, index) => (
            <div
              key={index}
              className="border rounded-lg p-4 space-y-4 bg-muted/30"
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <GripVertical className="h-5 w-5 text-muted-foreground cursor-move" />
                  <Badge variant="outline">Step {step.order}</Badge>
                </div>
                {steps.length > 1 && (
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => handleRemoveStep(index)}
                  >
                    <Trash2 className="h-4 w-4 text-destructive" />
                  </Button>
                )}
              </div>

              <div className="grid gap-4 md:grid-cols-2">
                <div className="space-y-2">
                  <Label>Step Type*</Label>
                  <Select
                    value={step.stepType}
                    onValueChange={(value) =>
                      handleStepChange(index, 'stepType', value)
                    }
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {STEP_TYPES.map((type) => (
                        <SelectItem key={type.value} value={type.value}>
                          {type.icon} {type.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Title*</Label>
                  <Input
                    placeholder="e.g., Welcome Email"
                    value={step.title}
                    onChange={(e) =>
                      handleStepChange(index, 'title', e.target.value)
                    }
                  />
                </div>
              </div>

              {/* Delay Configuration */}
              <div className="grid gap-4 md:grid-cols-3">
                <div className="space-y-2">
                  <Label>Delay Amount</Label>
                  <Input
                    type="number"
                    min="0"
                    value={step.delayAmount}
                    onChange={(e) =>
                      handleStepChange(index, 'delayAmount', parseInt(e.target.value) || 0)
                    }
                  />
                </div>

                <div className="space-y-2">
                  <Label>Delay Unit</Label>
                  <Select
                    value={step.delayUnit}
                    onValueChange={(value) =>
                      handleStepChange(index, 'delayUnit', value)
                    }
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {DELAY_UNITS.map((unit) => (
                        <SelectItem key={unit.value} value={unit.value}>
                          {unit.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Delay From</Label>
                  <Select
                    value={step.delayFrom}
                    onValueChange={(value) =>
                      handleStepChange(index, 'delayFrom', value)
                    }
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="start">Sequence Start</SelectItem>
                      <SelectItem value="previous">Previous Step</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Email-specific fields with WYSIWYG editor */}
              {step.stepType === 'email' && (
                <WYSIWYGEmailEditor
                  subject={step.subject || ''}
                  content={step.content || ''}
                  onSubjectChange={(value) => handleStepChange(index, 'subject', value)}
                  onContentChange={(value) => handleStepChange(index, 'content', value)}
                  stepIndex={index}
                />
              )}

              {/* SMS-specific fields */}
              {step.stepType === 'sms' && (
                <div className="space-y-2">
                  <div className="flex items-center justify-between">
                    <Label>SMS Message*</Label>
                    <Badge variant="outline" className="text-xs">
                      {(step.content || '').length}/160 chars
                    </Badge>
                  </div>
                  <Textarea
                    placeholder="Hi {{firstName}}! Thanks for reaching out. Ready to chat about growing your business? Reply YES to get started! - CDM Suite"
                    value={step.content || ''}
                    onChange={(e) =>
                      handleStepChange(index, 'content', e.target.value)
                    }
                    rows={3}
                    maxLength={320}
                  />
                  <p className="text-xs text-muted-foreground">
                    Keep it concise and conversational. Messages over 160 characters will be sent as multiple SMS.
                  </p>
                  <div className="flex flex-wrap gap-2 mt-2">
                    {MERGE_TAGS.slice(0, 5).map((tag) => (
                      <Badge
                        key={tag.value}
                        variant="secondary"
                        className="cursor-pointer"
                        onClick={() => {
                          const currentContent = step.content || '';
                          const newContent = currentContent + ' ' + tag.value;
                          if (newContent.length <= 320) {
                            handleStepChange(index, 'content', newContent);
                          } else {
                            toast.error('Message too long!');
                          }
                        }}
                      >
                        {tag.label}
                      </Badge>
                    ))}
                  </div>
                </div>
              )}

              {/* Task/Note content */}
              {(step.stepType === 'task' || step.stepType === 'note' || step.stepType === 'reminder') && (
                <div className="space-y-2">
                  <Label>Content*</Label>
                  <Textarea
                    placeholder={`Enter ${step.stepType} details...`}
                    value={step.content || ''}
                    onChange={(e) =>
                      handleStepChange(index, 'content', e.target.value)
                    }
                    rows={4}
                  />
                </div>
              )}
            </div>
          ))}
        </CardContent>
      </Card>

      {/* Actions */}
      <div className="flex items-center justify-end gap-3">
        <Button
          variant="outline"
          onClick={() => router.back()}
          disabled={loading}
        >
          Cancel
        </Button>
        <Button
          variant="secondary"
          onClick={() => handleSave('pending')}
          disabled={loading}
        >
          <Save className="h-4 w-4 mr-2" />
          Save as Draft
        </Button>
        <Button onClick={() => handleSave('approved')} disabled={loading}>
          {loading ? 'Creating...' : 'Create & Activate'}
        </Button>
      </div>
    </div>
  );
}


// ==========================================
// File: app/dashboard/crm/sequences/page.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Search,
  Plus,
  Filter,
  TrendingUp,
  Mail,
  MessageSquare,
  CheckCircle2,
  Clock,
  Sparkles,
  BarChart3,
  Edit,
  Eye,
  Play,
  Pause,
  Archive,
  Copy,
} from 'lucide-react';
import { toast } from 'sonner';
import { cn } from '@/lib/utils';
import {
  Sequence,
  SequenceFilters,
  SEQUENCE_STATUSES,
  SEQUENCE_TYPES,
} from '@/lib/sequence-types';
import {
  formatSequenceStatus,
  getSequenceStatusColor,
  calculateSequencePerformance,
} from '@/lib/sequence-utils';

export default function SequencesPage() {
  const { data: session } = useSession();
  const router = useRouter();
  const [sequences, setSequences] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [filters, setFilters] = useState<SequenceFilters>({
    status: undefined,
    type: undefined,
    aiGenerated: undefined,
  });

  useEffect(() => {
    fetchSequences();
  }, [filters]);

  const fetchSequences = async () => {
    try {
      setLoading(true);
      const params = new URLSearchParams();
      if (filters.status) params.append('status', filters.status);
      if (filters.type) params.append('type', filters.type);
      if (filters.aiGenerated !== undefined)
        params.append('aiGenerated', String(filters.aiGenerated));
      if (searchTerm) params.append('search', searchTerm);

      const response = await fetch(`/api/crm/sequences?${params}`);
      if (!response.ok) throw new Error('Failed to fetch sequences');

      const data = await response.json();
      setSequences(data.sequences || []);
    } catch (error) {
      console.error('Error fetching sequences:', error);
      toast.error('Failed to load sequences');
    } finally {
      setLoading(false);
    }
  };

  const handleSearch = () => {
    fetchSequences();
  };

  const handleCreateSequence = () => {
    router.push('/dashboard/crm/sequences/new');
  };

  const handleViewSequence = (id: string) => {
    router.push(`/dashboard/crm/sequences/${id}`);
  };

  const handleEditSequence = (id: string) => {
    router.push(`/dashboard/crm/sequences/${id}/edit`);
  };

  const handleDuplicateSequence = async (sequence: any) => {
    try {
      const response = await fetch('/api/crm/sequences', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...sequence,
          name: `${sequence.name} (Copy)`,
          status: 'pending',
          aiGenerated: false,
        }),
      });

      if (!response.ok) throw new Error('Failed to duplicate sequence');

      toast.success('Sequence duplicated successfully');
      fetchSequences();
    } catch (error) {
      console.error('Error duplicating sequence:', error);
      toast.error('Failed to duplicate sequence');
    }
  };

  const filteredSequences = sequences.filter((seq) => {
    if (searchTerm) {
      const search = searchTerm.toLowerCase();
      return (
        seq.name.toLowerCase().includes(search) ||
        seq.description?.toLowerCase().includes(search)
      );
    }
    return true;
  });

  // Calculate overall metrics
  const overallMetrics = {
    totalSequences: sequences.length,
    activeSequences: sequences.filter((s) => s.status === 'active').length,
    pendingApproval: sequences.filter((s) => s.status === 'pending').length,
    avgConversionRate:
      sequences.length > 0
        ? sequences.reduce((sum, s) => sum + (s.metrics?.conversionRate || 0), 0) /
          sequences.length
        : 0,
  };

  return (
    <div className="space-y-4 sm:space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4">
        <div className="min-w-0">
          <h1 className="text-2xl sm:text-3xl font-bold tracking-tight">Sequence Management</h1>
          <p className="text-sm sm:text-base text-muted-foreground mt-1">
            Create, manage, and optimize your lead nurture sequences
          </p>
        </div>
        <Button onClick={handleCreateSequence} size="lg" className="w-full sm:w-auto flex-shrink-0">
          <Plus className="mr-2 h-4 w-4" />
          Create Sequence
        </Button>
      </div>

      {/* Metrics Cards */}
      <div className="grid gap-4 md:grid-cols-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Total Sequences</CardTitle>
            <BarChart3 className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{overallMetrics.totalSequences}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Active Sequences</CardTitle>
            <Play className="h-4 w-4 text-green-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{overallMetrics.activeSequences}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Pending Approval</CardTitle>
            <Clock className="h-4 w-4 text-yellow-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{overallMetrics.pendingApproval}</div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Avg. Conversion</CardTitle>
            <TrendingUp className="h-4 w-4 text-blue-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {overallMetrics.avgConversionRate.toFixed(1)}%
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Filters */}
      <Card>
        <CardHeader className="p-4 sm:p-6">
          <div className="space-y-3">
            <div className="relative w-full">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
              <Input
                placeholder="Search sequences..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleSearch()}
                className="pl-10"
              />
            </div>

            <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3">
              <Select
                value={filters.status || 'all'}
                onValueChange={(value) =>
                  setFilters({ ...filters, status: value === 'all' ? undefined : value })
                }
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Status" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Statuses</SelectItem>
                  {SEQUENCE_STATUSES.map((status) => (
                    <SelectItem key={status.value} value={status.value}>
                      {status.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>

              <Select
                value={filters.type || 'all'}
                onValueChange={(value) =>
                  setFilters({ ...filters, type: value === 'all' ? undefined : value })
                }
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Type" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Types</SelectItem>
                  {SEQUENCE_TYPES.map((type) => (
                    <SelectItem key={type.value} value={type.value}>
                      {type.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>

              <Select
                value={
                  filters.aiGenerated === undefined
                    ? 'all'
                    : filters.aiGenerated
                    ? 'true'
                    : 'false'
                }
                onValueChange={(value) =>
                  setFilters({
                    ...filters,
                    aiGenerated:
                      value === 'all' ? undefined : value === 'true',
                  })
                }
              >
                <SelectTrigger className="w-full">
                  <SelectValue placeholder="Creator" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All</SelectItem>
                  <SelectItem value="true">AI-Generated</SelectItem>
                  <SelectItem value="false">Manual</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        </CardHeader>
        <CardContent className="p-0 sm:p-6">
          {loading ? (
            <div className="text-center py-8 text-muted-foreground">Loading sequences...</div>
          ) : filteredSequences.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground px-4">
              No sequences found. Create your first sequence to get started!
            </div>
          ) : (
            <div className="overflow-x-auto">
              <div className="rounded-md border">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead className="min-w-[200px]">Name</TableHead>
                      <TableHead className="min-w-[100px]">Type</TableHead>
                      <TableHead className="min-w-[100px]">Status</TableHead>
                      <TableHead className="min-w-[80px]">Steps</TableHead>
                      <TableHead className="min-w-[100px]">Assigned</TableHead>
                      <TableHead className="min-w-[120px]">Performance</TableHead>
                      <TableHead className="text-right min-w-[140px]">Actions</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {filteredSequences.map((sequence) => (
                      <TableRow key={sequence.id}>
                        <TableCell>
                          <div className="flex items-start gap-2">
                            <div className="min-w-0">
                              <div className="font-medium break-words">{sequence.name}</div>
                              {sequence.description && (
                                <div className="text-sm text-muted-foreground line-clamp-1">
                                  {sequence.description}
                                </div>
                              )}
                              {sequence.aiGenerated && (
                                <Badge variant="outline" className="mt-1 text-xs">
                                  <Sparkles className="h-3 w-3 mr-1" />
                                  AI
                                </Badge>
                              )}
                            </div>
                          </div>
                        </TableCell>
                        <TableCell>
                          <Badge variant="secondary" className="text-xs">
                            {sequence.type === 'email' && <Mail className="h-3 w-3 mr-1" />}
                            {sequence.type === 'sms' && <MessageSquare className="h-3 w-3 mr-1" />}
                            {sequence.type}
                          </Badge>
                        </TableCell>
                        <TableCell>
                          <Badge className={cn(getSequenceStatusColor(sequence.status), "text-xs whitespace-nowrap")}>
                            {formatSequenceStatus(sequence.status)}
                          </Badge>
                        </TableCell>
                        <TableCell className="text-sm">{sequence.steps?.length || 0}</TableCell>
                        <TableCell className="text-sm whitespace-nowrap">
                          {sequence._count?.assignments || 0} lead{sequence._count?.assignments !== 1 ? 's' : ''}
                        </TableCell>
                        <TableCell>
                          {sequence.metrics && (
                            <div className="text-xs">
                              <div>
                                Open: {sequence.metrics.openRate?.toFixed(1)}%
                              </div>
                              <div className="text-muted-foreground">
                                Conv: {sequence.metrics.conversionRate?.toFixed(1)}%
                              </div>
                            </div>
                          )}
                        </TableCell>
                        <TableCell className="text-right">
                          <div className="flex items-center justify-end gap-1">
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => handleViewSequence(sequence.id)}
                              title="View"
                            >
                              <Eye className="h-4 w-4" />
                            </Button>
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => handleEditSequence(sequence.id)}
                              title="Edit"
                            >
                              <Edit className="h-4 w-4" />
                            </Button>
                            <Button
                              variant="ghost"
                              size="sm"
                              onClick={() => handleDuplicateSequence(sequence)}
                              title="Duplicate"
                            >
                              <Copy className="h-4 w-4" />
                            </Button>
                          </div>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}


// ==========================================
// File: app/dashboard/crm/sequences/[id]/edit/page.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { toast } from 'sonner';
import {
  ArrowLeft,
  Plus,
  Save,
  Trash2,
  GripVertical,
} from 'lucide-react';
import {
  SEQUENCE_TYPES,
  TARGET_AUDIENCES,
  STEP_TYPES,
  DELAY_UNITS,
  SequenceStep,
} from '@/lib/sequence-types';
import { validateSequenceSteps, estimateSequenceDuration } from '@/lib/sequence-utils';
import { WYSIWYGEmailEditor } from '@/components/crm/sequences/wysiwyg-email-editor';

export default function EditSequencePage({ params }: { params: { id: string } }) {
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [sequence, setSequence] = useState<any>(null);
  
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    type: 'email',
    targetAudience: 'new_lead',
  });
  
  const [steps, setSteps] = useState<SequenceStep[]>([]);

  useEffect(() => {
    fetchSequence();
  }, [params.id]);

  const fetchSequence = async () => {
    try {
      setLoading(true);
      const response = await fetch(`/api/crm/sequences/${params.id}`);
      if (!response.ok) throw new Error('Failed to fetch sequence');

      const data = await response.json();
      setSequence(data.sequence);
      
      setFormData({
        name: data.sequence.name,
        description: data.sequence.description || '',
        type: data.sequence.type,
        targetAudience: data.sequence.targetAudience,
      });
      
      setSteps(data.sequence.steps || []);
    } catch (error) {
      console.error('Error fetching sequence:', error);
      toast.error('Failed to load sequence');
      router.push('/dashboard/crm/sequences');
    } finally {
      setLoading(false);
    }
  };

  const handleAddStep = () => {
    const newStep: SequenceStep = {
      order: steps.length + 1,
      stepType: 'email',
      title: '',
      content: '',
      subject: '',
      delayAmount: 0,
      delayUnit: 'hours',
      delayFrom: 'previous',
    };
    setSteps([...steps, newStep]);
  };

  const handleRemoveStep = (index: number) => {
    const newSteps = steps.filter((_, i) => i !== index);
    // Reorder steps
    newSteps.forEach((step, i) => {
      step.order = i + 1;
    });
    setSteps(newSteps);
  };

  const handleStepChange = (index: number, field: string, value: any) => {
    const newSteps = [...steps];
    (newSteps[index] as any)[field] = value;
    setSteps(newSteps);
  };

  const handleSave = async () => {
    try {
      // Validate
      if (!formData.name.trim()) {
        toast.error('Sequence name is required');
        return;
      }

      const validation = validateSequenceSteps(steps);
      if (!validation.valid) {
        toast.error(validation.errors[0]);
        return;
      }

      setSaving(true);

      const response = await fetch(`/api/crm/sequences/${params.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...formData,
          steps,
        }),
      });

      if (!response.ok) throw new Error('Failed to update sequence');

      toast.success('Sequence updated successfully!');
      router.push(`/dashboard/crm/sequences/${params.id}`);
    } catch (error) {
      console.error('Error saving sequence:', error);
      toast.error('Failed to save sequence');
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4" />
          <p className="text-muted-foreground">Loading sequence...</p>
        </div>
      </div>
    );
  }

  const duration = estimateSequenceDuration(steps);

  return (
    <div className="space-y-6 max-w-5xl">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button
            variant="ghost"
            size="sm"
            onClick={() => router.back()}
          >
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back
          </Button>
          <div>
            <h1 className="text-3xl font-bold tracking-tight">Edit Sequence</h1>
            <p className="text-muted-foreground mt-1">
              Update your automated lead nurture sequence
            </p>
          </div>
        </div>
      </div>

      {/* Basic Info */}
      <Card>
        <CardHeader>
          <CardTitle>Sequence Details</CardTitle>
          <CardDescription>
            Basic information about your sequence
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid gap-4 md:grid-cols-2">
            <div className="space-y-2">
              <Label htmlFor="name">Sequence Name*</Label>
              <Input
                id="name"
                placeholder="e.g., New Lead Welcome Sequence"
                value={formData.name}
                onChange={(e) =>
                  setFormData({ ...formData, name: e.target.value })
                }
              />
            </div>

            <div className="space-y-2">
              <Label htmlFor="type">Sequence Type*</Label>
              <Select
                value={formData.type}
                onValueChange={(value) =>
                  setFormData({ ...formData, type: value })
                }
              >
                <SelectTrigger id="type">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {SEQUENCE_TYPES.map((type) => (
                    <SelectItem key={type.value} value={type.value}>
                      {type.label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="targetAudience">Target Audience*</Label>
            <Select
              value={formData.targetAudience}
              onValueChange={(value) =>
                setFormData({ ...formData, targetAudience: value })
              }
            >
              <SelectTrigger id="targetAudience">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {TARGET_AUDIENCES.map((audience) => (
                  <SelectItem key={audience.value} value={audience.value}>
                    {audience.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            <Label htmlFor="description">Description</Label>
            <Textarea
              id="description"
              placeholder="Describe the purpose and strategy of this sequence..."
              value={formData.description}
              onChange={(e) =>
                setFormData({ ...formData, description: e.target.value })
              }
              rows={3}
            />
          </div>
        </CardContent>
      </Card>

      {/* Sequence Steps */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>Sequence Steps</CardTitle>
              <CardDescription>
                Build your sequence flow â€¢ Estimated duration: {duration.formatted}
              </CardDescription>
            </div>
            <Button onClick={handleAddStep} variant="outline" size="sm">
              <Plus className="h-4 w-4 mr-2" />
              Add Step
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-6">
          {steps.map((step, index) => (
            <div
              key={index}
              className="border rounded-lg p-6 space-y-4 bg-muted/30"
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <GripVertical className="h-5 w-5 text-muted-foreground cursor-move" />
                  <Badge variant="outline">Step {step.order}</Badge>
                </div>
                {steps.length > 1 && (
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => handleRemoveStep(index)}
                  >
                    <Trash2 className="h-4 w-4 text-destructive" />
                  </Button>
                )}
              </div>

              <div className="grid gap-4 md:grid-cols-2">
                <div className="space-y-2">
                  <Label>Step Type*</Label>
                  <Select
                    value={step.stepType}
                    onValueChange={(value) =>
                      handleStepChange(index, 'stepType', value)
                    }
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {STEP_TYPES.map((type) => (
                        <SelectItem key={type.value} value={type.value}>
                          {type.icon} {type.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Title*</Label>
                  <Input
                    placeholder="e.g., Welcome Email"
                    value={step.title}
                    onChange={(e) =>
                      handleStepChange(index, 'title', e.target.value)
                    }
                  />
                </div>
              </div>

              {/* Delay Configuration */}
              <div className="grid gap-4 md:grid-cols-3">
                <div className="space-y-2">
                  <Label>Delay Amount</Label>
                  <Input
                    type="number"
                    min="0"
                    value={step.delayAmount}
                    onChange={(e) =>
                      handleStepChange(index, 'delayAmount', parseInt(e.target.value) || 0)
                    }
                  />
                </div>

                <div className="space-y-2">
                  <Label>Delay Unit</Label>
                  <Select
                    value={step.delayUnit}
                    onValueChange={(value) =>
                      handleStepChange(index, 'delayUnit', value)
                    }
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {DELAY_UNITS.map((unit) => (
                        <SelectItem key={unit.value} value={unit.value}>
                          {unit.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Delay From</Label>
                  <Select
                    value={step.delayFrom}
                    onValueChange={(value) =>
                      handleStepChange(index, 'delayFrom', value)
                    }
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="start">Sequence Start</SelectItem>
                      <SelectItem value="previous">Previous Step</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Email-specific fields with WYSIWYG editor */}
              {step.stepType === 'email' && (
                <WYSIWYGEmailEditor
                  subject={step.subject || ''}
                  content={step.content || ''}
                  onSubjectChange={(value) => handleStepChange(index, 'subject', value)}
                  onContentChange={(value) => handleStepChange(index, 'content', value)}
                  stepIndex={index}
                />
              )}

              {/* SMS-specific fields */}
              {step.stepType === 'sms' && (
                <div className="space-y-2">
                  <div className="flex items-center justify-between">
                    <Label>SMS Message*</Label>
                    <Badge variant="outline" className="text-xs">
                      {(step.content || '').length}/160 chars
                    </Badge>
                  </div>
                  <Textarea
                    placeholder="Hi {{firstName}}! Thanks for reaching out. Ready to chat about growing your business? Reply YES to get started! - CDM Suite"
                    value={step.content || ''}
                    onChange={(e) =>
                      handleStepChange(index, 'content', e.target.value)
                    }
                    rows={3}
                    maxLength={320}
                  />
                  <p className="text-xs text-muted-foreground">
                    Keep it concise and conversational. Messages over 160 characters will be sent as multiple SMS.
                  </p>
                </div>
              )}

              {/* Task/Note content */}
              {(step.stepType === 'task' || step.stepType === 'note' || step.stepType === 'reminder') && (
                <div className="space-y-2">
                  <Label>Content*</Label>
                  <Textarea
                    placeholder={`Enter ${step.stepType} details...`}
                    value={step.content || ''}
                    onChange={(e) =>
                      handleStepChange(index, 'content', e.target.value)
                    }
                    rows={4}
                  />
                </div>
              )}
            </div>
          ))}
        </CardContent>
      </Card>

      {/* Actions */}
      <div className="flex items-center justify-end gap-3">
        <Button
          variant="outline"
          onClick={() => router.back()}
          disabled={saving}
        >
          Cancel
        </Button>
        <Button onClick={handleSave} disabled={saving}>
          <Save className="h-4 w-4 mr-2" />
          {saving ? 'Saving...' : 'Save Changes'}
        </Button>
      </div>
    </div>
  );
}

// ==========================================
// File: app/dashboard/crm/sequences/[id]/page.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { toast } from 'sonner';
import {
  ArrowLeft,
  Edit,
  Play,
  Pause,
  Archive,
  CheckCircle2,
  XCircle,
  Mail,
  Clock,
  TrendingUp,
  Users,
  Sparkles,
} from 'lucide-react';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import {
  formatSequenceStatus,
  getSequenceStatusColor,
  formatDelay,
  getStepTypeIcon,
} from '@/lib/sequence-utils';
import { format } from 'date-fns';

export default function SequenceDetailPage({ params }: { params: { id: string } }) {
  const router = useRouter();
  const [sequence, setSequence] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [approvalDialogOpen, setApprovalDialogOpen] = useState(false);
  const [feedback, setFeedback] = useState('');
  const [actionLoading, setActionLoading] = useState(false);

  useEffect(() => {
    fetchSequence();
  }, [params.id]);

  const fetchSequence = async () => {
    try {
      setLoading(true);
      const response = await fetch(`/api/crm/sequences/${params.id}`);
      if (!response.ok) throw new Error('Failed to fetch sequence');

      const data = await response.json();
      setSequence(data.sequence);
    } catch (error) {
      console.error('Error fetching sequence:', error);
      toast.error('Failed to load sequence');
    } finally {
      setLoading(false);
    }
  };

  const handleApprove = async (approved: boolean) => {
    try {
      setActionLoading(true);
      const response = await fetch(`/api/crm/sequences/${params.id}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ approved, feedback }),
      });

      if (!response.ok) throw new Error('Failed to update sequence');

      const data = await response.json();
      toast.success(data.message);
      setApprovalDialogOpen(false);
      fetchSequence();
    } catch (error) {
      console.error('Error updating sequence:', error);
      toast.error('Failed to update sequence');
    } finally {
      setActionLoading(false);
    }
  };

  const handleUpdateStatus = async (status: string) => {
    try {
      setActionLoading(true);
      const response = await fetch(`/api/crm/sequences/${params.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status }),
      });

      if (!response.ok) throw new Error('Failed to update status');

      toast.success('Status updated successfully');
      fetchSequence();
    } catch (error) {
      console.error('Error updating status:', error);
      toast.error('Failed to update status');
    } finally {
      setActionLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4" />
          <p className="text-muted-foreground">Loading sequence...</p>
        </div>
      </div>
    );
  }

  if (!sequence) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="text-center">
          <p className="text-lg font-semibold mb-2">Sequence not found</p>
          <Button onClick={() => router.back()}>Go Back</Button>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6 max-w-5xl">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button variant="ghost" size="sm" onClick={() => router.back()}>
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back
          </Button>
          <div>
            <div className="flex items-center gap-3">
              <h1 className="text-3xl font-bold tracking-tight">{sequence.name}</h1>
              {sequence.aiGenerated && (
                <Badge variant="outline">
                  <Sparkles className="h-3 w-3 mr-1" />
                  AI
                </Badge>
              )}
            </div>
            {sequence.description && (
              <p className="text-muted-foreground mt-1">{sequence.description}</p>
            )}
          </div>
        </div>
        <div className="flex items-center gap-2">
          {sequence.status === 'pending' && (
            <Button onClick={() => setApprovalDialogOpen(true)}>
              Review & Approve
            </Button>
          )}
          {sequence.status === 'active' && (
            <Button
              variant="outline"
              onClick={() => handleUpdateStatus('paused')}
              disabled={actionLoading}
            >
              <Pause className="h-4 w-4 mr-2" />
              Pause
            </Button>
          )}
          {sequence.status === 'paused' && (
            <Button
              variant="outline"
              onClick={() => handleUpdateStatus('active')}
              disabled={actionLoading}
            >
              <Play className="h-4 w-4 mr-2" />
              Resume
            </Button>
          )}
          <Button
            variant="outline"
            onClick={() => router.push(`/dashboard/crm/sequences/${params.id}/edit`)}
          >
            <Edit className="h-4 w-4 mr-2" />
            Edit
          </Button>
        </div>
      </div>

      {/* Status & Metrics */}
      <div className="grid gap-4 md:grid-cols-5">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Status</CardTitle>
          </CardHeader>
          <CardContent>
            <Badge className={getSequenceStatusColor(sequence.status)}>
              {formatSequenceStatus(sequence.status)}
            </Badge>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Assigned Leads</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {sequence.metrics?.totalAssignments || 0}
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Open Rate</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {sequence.metrics?.openRate?.toFixed(1) || 0}%
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Click Rate</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {sequence.metrics?.clickRate?.toFixed(1) || 0}%
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Conversion Rate</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {sequence.metrics?.conversionRate?.toFixed(1) || 0}%
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Tabs */}
      <Tabs defaultValue="steps" className="space-y-4">
        <TabsList>
          <TabsTrigger value="steps">Steps ({sequence.steps?.length || 0})</TabsTrigger>
          <TabsTrigger value="assignments">
            Assignments ({sequence.assignments?.length || 0})
          </TabsTrigger>
          <TabsTrigger value="performance">Performance</TabsTrigger>
        </TabsList>

        <TabsContent value="steps" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Sequence Steps</CardTitle>
              <CardDescription>
                The automated flow that leads will go through
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {sequence.steps?.map((step: any, index: number) => (
                  <div key={step.id} className="relative">
                    {index > 0 && (
                      <div className="absolute left-4 top-0 h-4 w-0.5 bg-border" />
                    )}
                    <div className="flex gap-4">
                      <div className="flex-shrink-0">
                        <div className="w-8 h-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-semibold">
                          {step.order}
                        </div>
                      </div>
                      <div className="flex-1 border rounded-lg p-4 bg-muted/30">
                        <div className="flex items-start justify-between mb-2">
                          <div>
                            <div className="flex items-center gap-2 mb-1">
                              <span className="text-lg">{getStepTypeIcon(step.stepType)}</span>
                              <h4 className="font-semibold">{step.title}</h4>
                              {step.aiSuggested && (
                                <Badge variant="secondary" className="ml-2">
                                  <Sparkles className="h-3 w-3 mr-1" />
                                  AI
                                </Badge>
                              )}
                            </div>
                            <p className="text-sm text-muted-foreground">
                              {formatDelay(step.delayAmount, step.delayUnit)} from{' '}
                              {step.delayFrom === 'start' ? 'sequence start' : 'previous step'}
                            </p>
                          </div>
                        </div>

                        {step.subject && (
                          <div className="mt-3">
                            <p className="text-sm font-medium text-muted-foreground">Subject:</p>
                            <p className="text-sm">{step.subject}</p>
                          </div>
                        )}

                        {step.content && (
                          <div className="mt-3">
                            <p className="text-sm font-medium text-muted-foreground">Content:</p>
                            <p className="text-sm whitespace-pre-wrap">{step.content}</p>
                          </div>
                        )}

                        {step.aiReasoning && (
                          <div className="mt-3 p-3 bg-blue-50 dark:bg-blue-950 rounded-md">
                            <p className="text-sm text-blue-900 dark:text-blue-100">
                              <Sparkles className="h-3 w-3 inline mr-1" />
                              AI Reasoning: {step.aiReasoning}
                            </p>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="assignments" className="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle>Lead Assignments</CardTitle>
              <CardDescription>Leads currently in this sequence</CardDescription>
            </CardHeader>
            <CardContent>
              {sequence.assignments?.length === 0 ? (
                <div className="text-center py-8 text-muted-foreground">
                  No leads assigned to this sequence yet
                </div>
              ) : (
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Lead</TableHead>
                      <TableHead>Company</TableHead>
                      <TableHead>Status</TableHead>
                      <TableHead>Current Step</TableHead>
                      <TableHead>Started</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {sequence.assignments?.map((assignment: any) => (
                      <TableRow key={assignment.id}>
                        <TableCell>
                          <div>
                            <div className="font-medium">{assignment.lead?.name || 'N/A'}</div>
                            <div className="text-sm text-muted-foreground">
                              {assignment.lead?.email}
                            </div>
                          </div>
                        </TableCell>
                        <TableCell>{assignment.lead?.company || '-'}</TableCell>
                        <TableCell>
                          <Badge variant="secondary">{assignment.status}</Badge>
                        </TableCell>
                        <TableCell>
                          Step {assignment.currentStep} / {sequence.steps?.length}
                        </TableCell>
                        <TableCell>
                          {assignment.startedAt
                            ? format(new Date(assignment.startedAt), 'MMM d, yyyy')
                            : 'Not started'}
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="performance" className="space-y-4">
          <div className="grid gap-4 md:grid-cols-2">
            <Card>
              <CardHeader>
                <CardTitle>Email Performance</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Emails Sent</span>
                  <span className="font-semibold">{sequence.metrics?.emailsSent || 0}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Opened</span>
                  <span className="font-semibold">{sequence.metrics?.emailsOpened || 0}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Clicked</span>
                  <span className="font-semibold">{sequence.metrics?.emailsClicked || 0}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Replied</span>
                  <span className="font-semibold">{sequence.metrics?.emailsReplied || 0}</span>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>Conversion Metrics</CardTitle>
              </CardHeader>
              <CardContent className="space-y-3">
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Total Assignments</span>
                  <span className="font-semibold">
                    {sequence.metrics?.totalAssignments || 0}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Active</span>
                  <span className="font-semibold">
                    {sequence.metrics?.activeAssignments || 0}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Completed</span>
                  <span className="font-semibold">
                    {sequence.metrics?.completedAssignments || 0}
                  </span>
                </div>
                <Separator />
                <div className="flex justify-between">
                  <span className="font-medium">Conversion Rate</span>
                  <span className="font-bold text-lg">
                    {sequence.metrics?.conversionRate?.toFixed(1) || 0}%
                  </span>
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>
      </Tabs>

      {/* Approval Dialog */}
      <Dialog open={approvalDialogOpen} onOpenChange={setApprovalDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Review Sequence</DialogTitle>
            <DialogDescription>
              Review this sequence and decide whether to approve or reject it.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label htmlFor="feedback">Feedback (optional)</Label>
              <Textarea
                id="feedback"
                placeholder="Add notes or feedback..."
                value={feedback}
                onChange={(e) => setFeedback(e.target.value)}
                rows={3}
              />
            </div>
          </div>
          <DialogFooter>
            <Button
              variant="outline"
              onClick={() => handleApprove(false)}
              disabled={actionLoading}
            >
              <XCircle className="h-4 w-4 mr-2" />
              Reject
            </Button>
            <Button onClick={() => handleApprove(true)} disabled={actionLoading}>
              <CheckCircle2 className="h-4 w-4 mr-2" />
              Approve & Activate
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}


// ==========================================
// File: app/dashboard/layout.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { DashboardLayout } from "@/components/dashboard/dashboard-layout";

export default async function Layout({ children }: { children: React.ReactNode }) {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  return <DashboardLayout user={user}>{children}</DashboardLayout>;
}

// ==========================================
// File: app/dashboard/my-services/page.tsx
// ==========================================


import { redirect } from 'next/navigation';
import { getCurrentUser } from '@/lib/auth-helpers';
import { prisma } from '@/lib/db';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Package, Clock, CheckCircle, AlertCircle } from 'lucide-react';
import { format } from 'date-fns';

export const metadata = {
  title: 'My Services | CDM Suite Dashboard',
  description: 'View your purchased services and orders',
};

async function getClientOrders(email: string) {
  const orders = await prisma.order.findMany({
    where: {
      customerEmail: email,
    },
    orderBy: {
      createdAt: 'desc',
    },
  });

  return orders;
}

export default async function MyServicesPage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect('/auth/login?callbackUrl=/dashboard/my-services');
  }

  const orders = await getClientOrders(user.email);

  const getStatusBadge = (status: string) => {
    switch (status) {
      case 'completed':
        return <Badge className="bg-green-500"><CheckCircle className="h-3 w-3 mr-1" />Completed</Badge>;
      case 'pending':
        return <Badge className="bg-yellow-500"><Clock className="h-3 w-3 mr-1" />Pending</Badge>;
      case 'failed':
        return <Badge variant="destructive"><AlertCircle className="h-3 w-3 mr-1" />Failed</Badge>;
      default:
        return <Badge>{status}</Badge>;
    }
  };

  return (
    <div className="space-y-4 sm:space-y-6">
      <div>
        <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-gray-100">My Services</h1>
        <p className="text-sm sm:text-base text-gray-600 dark:text-gray-400 mt-2">
          View and manage your purchased services and orders
        </p>
      </div>

      {orders.length === 0 ? (
        <Card>
          <CardContent className="flex flex-col items-center justify-center py-12 sm:py-16 px-4">
            <Package className="h-12 w-12 sm:h-16 sm:w-16 text-gray-400 mb-4" />
            <h3 className="text-lg sm:text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2 text-center">
              No Services Yet
            </h3>
            <p className="text-sm sm:text-base text-gray-600 dark:text-gray-400 text-center max-w-md">
              You haven't purchased any services yet. Browse our services and find the perfect solution for your business.
            </p>
          </CardContent>
        </Card>
      ) : (
        <div className="grid gap-4 sm:gap-6">
          {orders.map((order: any) => (
            <Card key={order.id} className="hover:shadow-lg transition-shadow">
              <CardHeader className="p-4 sm:p-6">
                <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 sm:gap-4">
                  <div className="flex-1 min-w-0">
                    <CardTitle className="text-lg sm:text-xl mb-2 break-words">{order.packageName}</CardTitle>
                    <CardDescription className="text-xs sm:text-sm">
                      Ordered on {format(new Date(order.createdAt), 'MMM dd, yyyy')}
                    </CardDescription>
                  </div>
                  <div className="flex flex-row sm:flex-col items-center sm:items-end gap-3 sm:gap-2">
                    {getStatusBadge(order.status)}
                    <div className="text-xl sm:text-2xl font-bold text-blue-600 whitespace-nowrap">
                      ${order.packagePrice.toFixed(2)}
                    </div>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="p-4 sm:p-6 pt-0">
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 sm:gap-4 text-xs sm:text-sm">
                  <div className="min-w-0">
                    <p className="text-gray-500 dark:text-gray-400 mb-1">Order ID</p>
                    <p className="font-mono text-[10px] sm:text-xs truncate">{order.stripeSessionId.substring(0, 24)}...</p>
                  </div>
                  <div className="min-w-0">
                    <p className="text-gray-500 dark:text-gray-400 mb-1">Customer</p>
                    <p className="font-medium truncate">{order.customerName || order.customerEmail}</p>
                  </div>
                  <div className="min-w-0">
                    <p className="text-gray-500 dark:text-gray-400 mb-1">Status</p>
                    <p className="font-medium capitalize truncate">{order.status}</p>
                  </div>
                </div>

                {order.status === 'completed' && (
                  <div className="mt-4 p-3 sm:p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                    <h4 className="text-sm sm:text-base font-semibold text-blue-900 dark:text-blue-100 mb-2">What's Next?</h4>
                    <ul className="text-xs sm:text-sm text-blue-800 dark:text-blue-200 space-y-1">
                      <li>âœ“ Our team will reach out to you within 24 hours</li>
                      <li>âœ“ We'll schedule a kickoff call to discuss your project</li>
                      <li>âœ“ You'll receive regular updates on progress</li>
                    </ul>
                  </div>
                )}
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}

// ==========================================
// File: app/dashboard/onboarding/page.tsx
// ==========================================


"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import { Rocket, Zap, TrendingUp, Globe } from "lucide-react";

const GOALS = [
  { id: "seo", label: "Improve SEO & Search Rankings", icon: TrendingUp },
  { id: "traffic", label: "Increase Website Traffic", icon: Globe },
  { id: "leads", label: "Generate More Leads", icon: Zap },
  { id: "conversions", label: "Boost Conversions & Sales", icon: Rocket },
];

export default function OnboardingPage() {
  const router = useRouter();
  const [step, setStep] = useState(1);
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    industry: "",
    goals: [] as string[],
  });

  const handleComplete = async () => {
    setLoading(true);
    try {
      const response = await fetch("/api/user/update-onboarding", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData),
      });

      if (response.ok) {
        router.push("/dashboard");
      }
    } catch (error) {
      console.error("Error completing onboarding:", error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-white to-purple-50 px-4">
      <Card className="w-full max-w-2xl">
        <CardHeader className="text-center">
          <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 text-white font-bold text-2xl mx-auto mb-4">
            {step}/2
          </div>
          <CardTitle className="text-2xl">Welcome to CDM Suite! ðŸš€</CardTitle>
          <CardDescription>
            Let's personalize your experience in just 2 quick steps
          </CardDescription>
        </CardHeader>
        <CardContent>
          {step === 1 && (
            <div className="space-y-6">
              <div>
                <Label htmlFor="industry">What industry are you in?</Label>
                <Input
                  id="industry"
                  placeholder="e.g., E-commerce, SaaS, Consulting, etc."
                  value={formData.industry}
                  onChange={(e) =>
                    setFormData({ ...formData, industry: e.target.value })
                  }
                  className="mt-2"
                />
              </div>
              <div className="flex justify-end">
                <Button
                  onClick={() => setStep(2)}
                  disabled={!formData.industry}
                >
                  Continue â†’
                </Button>
              </div>
            </div>
          )}

          {step === 2 && (
            <div className="space-y-6">
              <div>
                <Label>What are your primary goals?</Label>
                <p className="text-sm text-gray-500 mt-1 mb-4">
                  Select all that apply
                </p>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  {GOALS.map((goal) => {
                    const Icon = goal.icon;
                    return (
                      <div
                        key={goal.id}
                        className="flex items-start space-x-3 p-4 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors"
                        onClick={() => {
                          const newGoals = formData.goals.includes(goal.id)
                            ? formData.goals.filter((g) => g !== goal.id)
                            : [...formData.goals, goal.id];
                          setFormData({ ...formData, goals: newGoals });
                        }}
                      >
                        <Checkbox
                          checked={formData.goals.includes(goal.id)}
                          onCheckedChange={() => {}}
                        />
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            <Icon className="w-4 h-4 text-blue-600" />
                            <span className="font-medium">{goal.label}</span>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
              <div className="flex justify-between">
                <Button variant="outline" onClick={() => setStep(1)}>
                  â† Back
                </Button>
                <Button
                  onClick={handleComplete}
                  disabled={formData.goals.length === 0 || loading}
                >
                  {loading ? "Completing..." : "Complete Setup â†’"}
                </Button>
              </div>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

// ==========================================
// File: app/dashboard/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { FreeDashboard } from "@/components/dashboard/free-dashboard";
import { StarterDashboard } from "@/components/dashboard/starter-dashboard";
import { GrowthDashboard } from "@/components/dashboard/growth-dashboard";
import { ProDashboard } from "@/components/dashboard/pro-dashboard";
import { EmployeeDashboard } from "@/components/dashboard/employee-dashboard";

export const metadata = {
  title: "Dashboard | CDM Suite",
  description: "Manage your marketing campaigns and websites",
};

export default async function DashboardPage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  // Ensure user has a tier (default to free if not set)
  const userTier = user.tier || "free";
  const userRole = user.role?.toUpperCase();

  // Show employee dashboard for admin/employee roles
  if (userRole === "ADMIN" || userRole === "EMPLOYEE") {
    return <EmployeeDashboard user={user} />;
  }

  // Redirect to onboarding if not completed
  if (!user.onboardingCompleted && userTier !== "free") {
    redirect("/dashboard/onboarding");
  }

  return (
    <>
      {userTier === "free" && <FreeDashboard user={user} />}
      {userTier === "starter" && <StarterDashboard user={user} />}
      {(userTier === "growth" || userTier === "pro" || userTier === "enterprise") && (
        <GrowthDashboard user={user} />
      )}
    </>
  );
}

// ==========================================
// File: app/dashboard/pages/edit/[id]/page.tsx
// ==========================================


import { redirect } from 'next/navigation';
import { getCurrentUser } from '@/lib/session';
import { prisma } from '@/lib/db';
import { PageEditorClient } from '@/components/page-builder/page-editor-client';

export default async function EditPagePage({ params }: { params: { id: string } }) {
  const user = await getCurrentUser();

  if (!user || user.role !== 'admin') {
    redirect('/dashboard');
  }

  const page = await prisma.customPage.findUnique({
    where: { id: params.id },
  });

  if (!page) {
    redirect('/dashboard/pages');
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Edit Page</h1>
        <p className="text-muted-foreground">
          Use the simplified editor to customize your page
        </p>
      </div>

      <PageEditorClient page={page} />
    </div>
  );
}

// ==========================================
// File: app/dashboard/pages/new/page.tsx
// ==========================================


import { redirect } from 'next/navigation';
import { getCurrentUser } from '@/lib/session';
import { NewPageForm } from '@/components/page-builder/new-page-form';

export default async function NewPagePage() {
  const user = await getCurrentUser();

  if (!user || user.role !== 'admin') {
    redirect('/dashboard');
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Create New Page</h1>
        <p className="text-muted-foreground">
          Start building a new custom page
        </p>
      </div>

      <NewPageForm />
    </div>
  );
}

// ==========================================
// File: app/dashboard/pages/page.tsx
// ==========================================


import { redirect } from 'next/navigation';
import { getCurrentUser } from '@/lib/session';
import { prisma } from '@/lib/db';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import Link from 'next/link';
import { Plus, Edit, Eye, Trash2, Copy } from 'lucide-react';

export default async function PagesPage() {
  const user = await getCurrentUser();

  if (!user || user.role !== 'admin') {
    redirect('/dashboard');
  }

  const pages = await prisma.customPage.findMany({
    orderBy: { updatedAt: 'desc' },
  });

  return (
    <div className="space-y-6">
      <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div className="min-w-0">
          <h1 className="text-2xl sm:text-3xl font-bold truncate">Page Builder</h1>
          <p className="text-sm sm:text-base text-muted-foreground mt-1">
            Create and manage custom pages with the simplified visual editor
          </p>
        </div>
        <Link href="/dashboard/pages/new" className="w-full sm:w-auto">
          <Button size="sm" className="w-full sm:w-auto">
            <Plus className="w-4 h-4 mr-2" />
            New Page
          </Button>
        </Link>
      </div>

      {pages.length === 0 ? (
        <Card>
          <CardContent className="py-12 text-center">
            <h3 className="text-lg font-semibold mb-2">No pages yet</h3>
            <p className="text-muted-foreground mb-4">
              Create your first custom page with the visual page builder.
            </p>
            <Link href="/dashboard/pages/new">
              <Button>
                <Plus className="w-4 h-4 mr-2" />
                Create First Page
              </Button>
            </Link>
          </CardContent>
        </Card>
      ) : (
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {pages.map((page: any) => (
            <Card key={page.id}>
              <CardHeader>
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <CardTitle className="text-lg">{page.title}</CardTitle>
                    <CardDescription className="mt-1">
                      /{page.slug}
                    </CardDescription>
                  </div>
                  <Badge variant={page.status === 'published' ? 'default' : 'secondary'}>
                    {page.status}
                  </Badge>
                </div>
              </CardHeader>
              <CardContent className="space-y-3">
                {page.description && (
                  <p className="text-sm text-muted-foreground line-clamp-2">
                    {page.description}
                  </p>
                )}
                <div className="text-xs text-muted-foreground">
                  Updated {new Date(page.updatedAt).toLocaleDateString()}
                </div>
                <div className="flex gap-2">
                  <Link href={`/dashboard/pages/edit/${page.id}`} className="flex-1">
                    <Button variant="outline" size="sm" className="w-full">
                      <Edit className="w-3 h-3 mr-1" />
                      Edit
                    </Button>
                  </Link>
                  {page.status === 'published' && (
                    <Link href={`/${page.slug}`} target="_blank">
                      <Button variant="outline" size="sm">
                        <Eye className="w-3 h-3" />
                      </Button>
                    </Link>
                  )}
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      <Card>
        <CardHeader>
          <CardTitle>Getting Started</CardTitle>
          <CardDescription>
            Learn how to use the simplified page builder
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <h4 className="font-medium mb-2">1. Create a New Page</h4>
            <p className="text-sm text-muted-foreground">
              Click "New Page" to create a custom page. Set the title and URL slug.
            </p>
          </div>
          <div>
            <h4 className="font-medium mb-2">2. Add Sections</h4>
            <p className="text-sm text-muted-foreground">
              Choose from pre-built sections like Hero, Features, CTA, and more. Click the "+ Add Section" buttons.
            </p>
          </div>
          <div>
            <h4 className="font-medium mb-2">3. Customize Content</h4>
            <p className="text-sm text-muted-foreground">
              Each section has a simple form editor. Fill in the text, images, and links for your content.
            </p>
          </div>
          <div>
            <h4 className="font-medium mb-2">4. Preview & Publish</h4>
            <p className="text-sm text-muted-foreground">
              Use the Preview tab to see how your page looks, then click "Save & Publish" to make it live.
            </p>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

// ==========================================
// File: app/dashboard/projects/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { prisma } from "@/lib/db";
import { ProjectsList } from "@/components/dashboard/projects-list";

export const metadata = {
  title: "My Projects | CDM Suite",
  description: "Manage your websites and projects",
};

export default async function ProjectsPage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  // Fetch user's projects
  const projects = await prisma.project.findMany({
    where: { userId: user.id },
    orderBy: { createdAt: "desc" },
  });

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">My Projects</h1>
        <p className="text-muted-foreground mt-2">
          Manage your websites, campaigns, and digital assets
        </p>
      </div>

      <ProjectsList projects={projects} user={user} />
    </div>
  );
}

// ==========================================
// File: app/dashboard/projects/[projectId]/shopify/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { prisma } from "@/lib/db";
import { ShopifyIntegrationClient } from "@/components/builder/shopify-integration-client";

export default async function ShopifyIntegrationPage({
  params,
}: {
  params: { projectId: string };
}) {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  // Fetch project
  const project = await prisma.project.findFirst({
    where: {
      id: params.projectId,
      userId: user.id,
    },
  });

  if (!project) {
    redirect("/dashboard/projects");
  }

  return <ShopifyIntegrationClient project={project} />;
}

// ==========================================
// File: app/dashboard/proposals/new/page.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import { toast } from 'sonner';
import {
  Plus,
  Trash2,
  ArrowLeft,
  Save,
  DollarSign,
  Percent,
  Calendar,
  Edit2,
} from 'lucide-react';
import { ProposalItem, DEFAULT_TERMS, calculateProposalTotals } from '@/lib/proposal-types';
import { ALL_SERVICE_TIERS, getTierById } from '@/lib/pricing-tiers';
import { ClientSelector } from '@/components/proposals/client-selector';
import Link from 'next/link';

interface Lead {
  id: string;
  name: string;
  email: string;
  phone?: string;
  company?: string;
}

interface ServiceOption {
  id: string;
  name: string;
  price: number;
  category: string;
}

export default function NewProposalPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const searchParams = useSearchParams();

  // Lead selection
  const [selectedClient, setSelectedClient] = useState<Lead | null>(null);

  // Client info (populated from selected client)
  const [clientName, setClientName] = useState('');
  const [clientEmail, setClientEmail] = useState('');
  const [clientPhone, setClientPhone] = useState('');
  const [clientCompany, setClientCompany] = useState('');

  // Proposal info
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [items, setItems] = useState<ProposalItem[]>([]);
  const [tax, setTax] = useState(0);
  const [discount, setDiscount] = useState(0);
  const [terms, setTerms] = useState(DEFAULT_TERMS);
  const [notes, setNotes] = useState('');
  const [dueDate, setDueDate] = useState('');
  const [validUntil, setValidUntil] = useState('');

  // UI state
  const [loading, setLoading] = useState(false);
  const [serviceOptions, setServiceOptions] = useState<ServiceOption[]>([]);

  // Load service options
  useEffect(() => {
    if (status === 'authenticated') {
      prepareServiceOptions();
    }
  }, [status]);

  // Populate from URL params (from Lead CRM)
  useEffect(() => {
    if (searchParams) {
      const leadId = searchParams.get('leadId');
      const name = searchParams.get('clientName');
      const email = searchParams.get('clientEmail');
      const phone = searchParams.get('clientPhone');
      const company = searchParams.get('clientCompany');
      const interest = searchParams.get('interest');

      if (name) setClientName(name);
      if (email) setClientEmail(email);
      if (phone) setClientPhone(phone);
      if (company) setClientCompany(company);
      if (interest) {
        setTitle(`Proposal for ${name || 'Client'}`);
        setDescription(`Services requested: ${interest}`);
      }

      // If leadId is provided, set it as selected client
      if (leadId && name && email) {
        setSelectedClient({
          id: leadId,
          name: name,
          email: email,
          phone: phone || undefined,
          company: company || undefined,
        });
      }
    }
  }, [searchParams]);

  // Populate client info when client is selected
  useEffect(() => {
    if (selectedClient) {
      setClientName(selectedClient.name || '');
      setClientEmail(selectedClient.email || '');
      setClientPhone(selectedClient.phone || '');
      setClientCompany(selectedClient.company || '');
    }
  }, [selectedClient]);

  const prepareServiceOptions = () => {
    const options: ServiceOption[] = [];
    
    // Ad Management
    ALL_SERVICE_TIERS.adManagement.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `Ad Management - ${tier.name}`,
        price: tier.price,
        category: 'Ad Management',
      });
    });

    // SEO
    ALL_SERVICE_TIERS.seo.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `SEO - ${tier.name}`,
        price: tier.price,
        category: 'SEO',
      });
    });

    // Social Media
    ALL_SERVICE_TIERS.socialMedia.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `Social Media - ${tier.name}`,
        price: tier.price,
        category: 'Social Media',
      });
    });

    // Web Development
    ALL_SERVICE_TIERS.webDevelopment.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `Web Development - ${tier.name}`,
        price: tier.price,
        category: 'Web Development',
      });
    });

    // App Creation
    ALL_SERVICE_TIERS.appCreation.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `App Creation - ${tier.name}`,
        price: tier.price,
        category: 'App Creation',
      });
    });

    // Website Maintenance
    ALL_SERVICE_TIERS.websiteMaintenance.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `Website Maintenance - ${tier.name}`,
        price: tier.price,
        category: 'Website Maintenance',
      });
    });

    // App Maintenance
    ALL_SERVICE_TIERS.appMaintenance.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `App Maintenance - ${tier.name}`,
        price: tier.price,
        category: 'App Maintenance',
      });
    });

    setServiceOptions(options);
  };

  const addServiceItem = (serviceId: string) => {
    if (!serviceId) return;

    const service = serviceOptions.find((s) => s.id === serviceId);
    const tier = getTierById(serviceId);
    
    if (service && tier) {
      const newItem: ProposalItem = {
        id: Math.random().toString(36).substr(2, 9),
        type: 'service',
        name: service.name,
        description: tier.features.join('\nâ€¢ '),
        quantity: 1,
        unitPrice: service.price,
        total: service.price,
        serviceId: serviceId,
      };

      setItems([...items, newItem]);
    }
  };

  const addCustomItem = () => {
    const newItem: ProposalItem = {
      id: Math.random().toString(36).substr(2, 9),
      type: 'custom',
      name: '',
      description: '',
      quantity: 1,
      unitPrice: 0,
      total: 0,
    };

    setItems([...items, newItem]);
  };

  const updateItem = (index: number, field: keyof ProposalItem, value: any) => {
    const updatedItems = [...items];
    const item = updatedItems[index];
    
    (item as any)[field] = value;

    // Recalculate total
    if (field === 'quantity' || field === 'unitPrice') {
      item.total = item.quantity * item.unitPrice;
    }

    setItems(updatedItems);
  };

  const removeItem = (index: number) => {
    setItems(items.filter((_, i) => i !== index));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validation - require at least name
    if (!clientName) {
      toast.error('Please provide client name');
      return;
    }

    // At least one contact method should be provided
    if (!clientEmail && !clientPhone) {
      toast.error('Please provide at least an email or phone number');
      return;
    }

    if (!title) {
      toast.error('Please provide a proposal title');
      return;
    }

    if (items.length === 0) {
      toast.error('Please add at least one item to the proposal');
      return;
    }

    // Check for incomplete custom items
    const incompleteItem = items.find(
      (item) => item.type === 'custom' && (!item.name || item.unitPrice <= 0)
    );
    if (incompleteItem) {
      toast.error('Please complete all custom items with name and price');
      return;
    }

    setLoading(true);

    try {
      const res = await fetch('/api/proposals', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          leadId: selectedClient?.id || undefined,
          clientName,
          clientEmail,
          clientPhone,
          clientCompany,
          title,
          description,
          items,
          tax,
          discount,
          terms,
          notes,
          dueDate: dueDate || undefined,
          validUntil: validUntil || undefined,
        }),
      });

      if (res.ok) {
        const data = await res.json();
        toast.success('Proposal created successfully!');
        router.push(`/dashboard/proposals/${data.proposal.id}`);
      } else {
        const error = await res.json();
        toast.error(error.error || 'Failed to create proposal');
      }
    } catch (error) {
      console.error('Error creating proposal:', error);
      toast.error('An error occurred while creating the proposal');
    } finally {
      setLoading(false);
    }
  };

  const totals = calculateProposalTotals(items, tax, discount);

  if (status === 'loading') {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
      </div>
    );
  }

  return (
    <div className="space-y-6 max-w-5xl">
      {/* Header */}
      <div className="flex items-center gap-4">
        <Link href="/dashboard/proposals">
          <Button variant="ghost" size="sm">
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back
          </Button>
        </Link>
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Create New Proposal</h1>
          <p className="text-gray-600 mt-1">Build a proposal for your client</p>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Client Selection */}
        <Card>
          <CardHeader>
            <CardTitle>Client Information</CardTitle>
            <CardDescription>Select an existing customer or create a new one</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="clientSelector">
                Customer <span className="text-red-500">*</span>
              </Label>
              <ClientSelector
                selectedClient={selectedClient}
                onClientSelect={setSelectedClient}
              />
            </div>

            <Separator />

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label htmlFor="clientName">
                  Client Name <span className="text-red-500">*</span>
                </Label>
                <Input
                  id="clientName"
                  value={clientName}
                  onChange={(e) => setClientName(e.target.value)}
                  placeholder="John Doe"
                  required
                />
              </div>
              <div>
                <Label htmlFor="clientEmail">
                  Client Email
                </Label>
                <Input
                  id="clientEmail"
                  type="email"
                  value={clientEmail}
                  onChange={(e) => setClientEmail(e.target.value)}
                  placeholder="john@example.com (optional)"
                />
              </div>
              <div>
                <Label htmlFor="clientPhone">Client Phone</Label>
                <Input
                  id="clientPhone"
                  value={clientPhone}
                  onChange={(e) => setClientPhone(e.target.value)}
                  placeholder="+1 (555) 123-4567"
                />
              </div>
              <div>
                <Label htmlFor="clientCompany">Company</Label>
                <Input
                  id="clientCompany"
                  value={clientCompany}
                  onChange={(e) => setClientCompany(e.target.value)}
                  placeholder="Acme Corp"
                />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Proposal Details */}
        <Card>
          <CardHeader>
            <CardTitle>Proposal Details</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="title">
                Proposal Title <span className="text-red-500">*</span>
              </Label>
              <Input
                id="title"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                placeholder="Website Development & SEO Package"
                required
              />
            </div>
            <div>
              <Label htmlFor="description">Description</Label>
              <Textarea
                id="description"
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                placeholder="Brief overview of what this proposal includes..."
                rows={3}
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="dueDate">Due Date</Label>
                <Input
                  id="dueDate"
                  type="date"
                  value={dueDate}
                  onChange={(e) => setDueDate(e.target.value)}
                />
              </div>
              <div>
                <Label htmlFor="validUntil">Valid Until</Label>
                <Input
                  id="validUntil"
                  type="date"
                  value={validUntil}
                  onChange={(e) => setValidUntil(e.target.value)}
                />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Items */}
        <Card>
          <CardHeader>
            <CardTitle>Proposal Items</CardTitle>
            <CardDescription>Add services or custom items to the proposal</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Add Service */}
            <div className="flex gap-2">
              <Select onValueChange={addServiceItem}>
                <SelectTrigger className="flex-1">
                  <SelectValue placeholder="Add a service..." />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="placeholder" disabled>
                    Select a service
                  </SelectItem>
                  {serviceOptions.map((service) => (
                    <SelectItem key={service.id} value={service.id}>
                      {service.name} - ${service.price}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <Button type="button" onClick={addCustomItem} variant="outline">
                <Plus className="h-4 w-4 mr-2" />
                Custom Item
              </Button>
            </div>

            <Separator />

            {/* Items List */}
            <div className="space-y-4">
              {items.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  No items added yet. Add a service or custom item to get started.
                </div>
              ) : (
                items.map((item, index) => (
                  <Card key={item.id} className="border-dashed">
                    <CardContent className="pt-6">
                      <div className="space-y-3">
                        <div className="flex justify-between items-start">
                          <div className="flex-1 grid grid-cols-2 gap-3">
                            <div>
                              <Label>Item Name</Label>
                              <Input
                                value={item.name}
                                onChange={(e) => updateItem(index, 'name', e.target.value)}
                                placeholder="Service or item name"
                                disabled={item.type === 'service'}
                              />
                            </div>
                            <div>
                              <Label>Description</Label>
                              <Textarea
                                value={item.description}
                                onChange={(e) => updateItem(index, 'description', e.target.value)}
                                placeholder="Brief description"
                                rows={2}
                                disabled={item.type === 'service'}
                              />
                            </div>
                          </div>
                          <Button
                            type="button"
                            variant="ghost"
                            size="sm"
                            onClick={() => removeItem(index)}
                            className="ml-2"
                          >
                            <Trash2 className="h-4 w-4 text-red-500" />
                          </Button>
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                          <div>
                            <Label>Quantity</Label>
                            <Input
                              type="number"
                              min="1"
                              value={item.quantity}
                              onChange={(e) =>
                                updateItem(index, 'quantity', parseInt(e.target.value) || 1)
                              }
                            />
                          </div>
                          <div>
                            <Label className="flex items-center gap-2">
                              Unit Price
                              {item.type === 'service' && (
                                <span title="Editable">
                                  <Edit2 className="h-3 w-3 text-blue-500" />
                                </span>
                              )}
                            </Label>
                            <div className="relative">
                              <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                              <Input
                                type="number"
                                min="0"
                                step="0.01"
                                value={item.unitPrice}
                                onChange={(e) =>
                                  updateItem(index, 'unitPrice', parseFloat(e.target.value) || 0)
                                }
                                className="pl-9"
                              />
                            </div>
                          </div>
                          <div>
                            <Label>Total</Label>
                            <div className="flex items-center h-10 px-3 bg-gray-50 border border-gray-200 rounded-md text-sm font-medium">
                              ${item.total.toFixed(2)}
                            </div>
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))
              )}
            </div>

            {/* Totals */}
            {items.length > 0 && (
              <>
                <Separator />
                <div className="space-y-3">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label>Tax (%)</Label>
                      <div className="relative">
                        <Percent className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                          type="number"
                          min="0"
                          max="100"
                          step="0.01"
                          value={tax}
                          onChange={(e) => setTax(parseFloat(e.target.value) || 0)}
                          className="pl-9"
                        />
                      </div>
                    </div>
                    <div>
                      <Label>Discount ($)</Label>
                      <div className="relative">
                        <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                          type="number"
                          min="0"
                          step="0.01"
                          value={discount}
                          onChange={(e) => setDiscount(parseFloat(e.target.value) || 0)}
                          className="pl-9"
                        />
                      </div>
                    </div>
                  </div>

                  <div className="bg-gray-50 p-4 rounded-lg space-y-2">
                    <div className="flex justify-between text-sm">
                      <span>Subtotal:</span>
                      <span className="font-medium">${totals.subtotal.toFixed(2)}</span>
                    </div>
                    {discount > 0 && (
                      <div className="flex justify-between text-sm text-green-600">
                        <span>Discount:</span>
                        <span className="font-medium">-${discount.toFixed(2)}</span>
                      </div>
                    )}
                    {tax > 0 && (
                      <div className="flex justify-between text-sm">
                        <span>Tax ({tax}%):</span>
                        <span className="font-medium">${totals.taxAmount.toFixed(2)}</span>
                      </div>
                    )}
                    <Separator />
                    <div className="flex justify-between text-lg font-bold">
                      <span>Total:</span>
                      <span className="text-blue-600">${totals.total.toFixed(2)}</span>
                    </div>
                  </div>
                </div>
              </>
            )}
          </CardContent>
        </Card>

        {/* Terms & Notes */}
        <Card>
          <CardHeader>
            <CardTitle>Terms & Additional Notes</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="terms">Terms & Conditions</Label>
              <Textarea
                id="terms"
                value={terms}
                onChange={(e) => setTerms(e.target.value)}
                rows={8}
                className="font-mono text-xs"
              />
            </div>
            <div>
              <Label htmlFor="notes">Internal Notes (Not visible to client)</Label>
              <Textarea
                id="notes"
                value={notes}
                onChange={(e) => setNotes(e.target.value)}
                placeholder="Add any internal notes about this proposal..."
                rows={3}
              />
            </div>
          </CardContent>
        </Card>

        {/* Actions */}
        <div className="flex justify-end gap-3">
          <Link href="/dashboard/proposals">
            <Button type="button" variant="outline">
              Cancel
            </Button>
          </Link>
          <Button type="submit" disabled={loading}>
            {loading ? (
              <>
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2" />
                Creating...
              </>
            ) : (
              <>
                <Save className="h-4 w-4 mr-2" />
                Create Proposal
              </>
            )}
          </Button>
        </div>
      </form>
    </div>
  );
}

// ==========================================
// File: app/dashboard/proposals/page.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import {
  Plus,
  Search,
  FileText,
  DollarSign,
  Calendar,
  ExternalLink,
  Eye,
  CheckCircle2,
  XCircle,
  Clock,
  Send,
  Upload,
  Trash2,
} from 'lucide-react';
import { toast } from 'sonner';
import { cn, formatDetailedTimestamp } from '@/lib/utils';
import { Proposal } from '@/lib/proposal-types';
import { BulkProposalImportDialog } from '@/components/proposals/bulk-proposal-import-dialog';
import Link from 'next/link';

export default function ProposalsPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [proposals, setProposals] = useState<Proposal[]>([]);
  const [filteredProposals, setFilteredProposals] = useState<Proposal[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState<string>('all');
  const [showBulkImportDialog, setShowBulkImportDialog] = useState(false);
  const [proposalToDelete, setProposalToDelete] = useState<string | null>(null);
  const [deleting, setDeleting] = useState(false);

  // Check if user is master user
  const isMasterUser = session?.user?.email === 'fray@cdmsuite.com';

  useEffect(() => {
    if (status === 'authenticated') {
      fetchProposals();
    }
  }, [status]);

  useEffect(() => {
    let filtered = [...proposals];

    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(
        (p) =>
          p.clientName.toLowerCase().includes(query) ||
          p.clientEmail.toLowerCase().includes(query) ||
          p.proposalNumber.toLowerCase().includes(query) ||
          p.title.toLowerCase().includes(query)
      );
    }

    if (statusFilter && statusFilter !== 'all') {
      filtered = filtered.filter((p) => p.status === statusFilter);
    }

    setFilteredProposals(filtered);
  }, [searchQuery, statusFilter, proposals]);

  const fetchProposals = async () => {
    try {
      const res = await fetch('/api/proposals');
      if (res.ok) {
        const data = await res.json();
        setProposals(data.proposals);
        setFilteredProposals(data.proposals);
      }
    } catch (error) {
      console.error('Error fetching proposals:', error);
      toast.error('Failed to load proposals');
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteProposal = async () => {
    if (!proposalToDelete) return;

    setDeleting(true);
    try {
      const res = await fetch(`/api/proposals/${proposalToDelete}`, {
        method: 'DELETE',
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || 'Failed to delete proposal');
      }

      toast.success('Proposal deleted successfully');
      fetchProposals();
    } catch (error: any) {
      console.error('Error deleting proposal:', error);
      toast.error(error.message || 'Failed to delete proposal');
    } finally {
      setDeleting(false);
      setProposalToDelete(null);
    }
  };

  const getStatusBadge = (status: string) => {
    const styles = {
      draft: 'bg-gray-100 text-gray-700',
      sent: 'bg-blue-100 text-blue-700',
      viewed: 'bg-purple-100 text-purple-700',
      accepted: 'bg-green-100 text-green-700',
      declined: 'bg-red-100 text-red-700',
      expired: 'bg-orange-100 text-orange-700',
    };

    const icons = {
      draft: FileText,
      sent: Send,
      viewed: Eye,
      accepted: CheckCircle2,
      declined: XCircle,
      expired: Clock,
    };

    const Icon = icons[status as keyof typeof icons] || FileText;

    return (
      <Badge className={cn('flex items-center gap-1', styles[status as keyof typeof styles] || '')}>
        <Icon className="h-3 w-3" />
        {status.charAt(0).toUpperCase() + status.slice(1)}
      </Badge>
    );
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div className="min-w-0">
          <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 truncate">Proposals</h1>
          <p className="text-sm sm:text-base text-gray-600 mt-1 truncate">Create and manage client proposals</p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" size="sm" onClick={() => setShowBulkImportDialog(true)} className="flex-1 sm:flex-none">
            <Upload className="h-4 w-4 sm:mr-2" />
            <span className="hidden sm:inline">Bulk Import</span>
          </Button>
          <Link href="/dashboard/proposals/new" className="flex-1 sm:flex-none">
            <Button size="sm" className="w-full">
              <Plus className="h-4 w-4 sm:mr-2" />
              <span className="hidden sm:inline">New Proposal</span>
              <span className="sm:hidden">New</span>
            </Button>
          </Link>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white border border-gray-200 rounded-lg p-3 sm:p-4">
        <div className="flex flex-col sm:flex-row gap-3">
          <div className="flex-1 relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
            <Input
              placeholder="Search proposals..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10 text-sm sm:text-base"
            />
          </div>

          <Select value={statusFilter} onValueChange={setStatusFilter}>
            <SelectTrigger className="w-full sm:w-48">
              <SelectValue placeholder="Status" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Status</SelectItem>
              <SelectItem value="draft">Draft</SelectItem>
              <SelectItem value="sent">Sent</SelectItem>
              <SelectItem value="viewed">Viewed</SelectItem>
              <SelectItem value="accepted">Accepted</SelectItem>
              <SelectItem value="declined">Declined</SelectItem>
              <SelectItem value="expired">Expired</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </div>

      {/* Proposals List */}
      <div className="bg-white border border-gray-200 rounded-lg overflow-hidden">
        {filteredProposals.length === 0 ? (
          <div className="text-center py-12 px-4">
            <FileText className="h-12 w-12 text-gray-400 mx-auto mb-3" />
            <h3 className="text-sm font-medium text-gray-900 mb-1">No proposals found</h3>
            <p className="text-sm text-gray-600 mb-4">
              {searchQuery || statusFilter !== 'all'
                ? 'Try adjusting your filters'
                : 'Create your first proposal to get started'}
            </p>
            {!searchQuery && statusFilter === 'all' && (
              <Link href="/dashboard/proposals/new">
                <Button>
                  <Plus className="h-4 w-4 mr-2" />
                  Create Proposal
                </Button>
              </Link>
            )}
          </div>
        ) : (
          <>
            {/* Desktop Table View */}
            <div className="hidden lg:block overflow-x-auto">
              <table className="w-full table-fixed">
                <thead className="bg-gray-50 border-b border-gray-200">
                  <tr>
                    <th className="w-[28%] px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Proposal
                    </th>
                    <th className="w-[28%] px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Client
                    </th>
                    <th className="w-[12%] px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Total
                    </th>
                    <th className="w-[14%] px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Status
                    </th>
                    <th className="w-[18%] px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {filteredProposals.map((proposal) => (
                    <tr key={proposal.id} className="hover:bg-gray-50">
                      <td className="px-4 py-3">
                        <div className="min-w-0">
                          <div className="text-sm font-medium text-gray-900 truncate" title={proposal.title}>
                            {proposal.title}
                          </div>
                          <div className="text-xs text-gray-500 truncate">{proposal.proposalNumber}</div>
                        </div>
                      </td>
                      <td className="px-4 py-3">
                        <div className="min-w-0">
                          <div className="text-sm font-medium text-gray-900 truncate" title={proposal.clientName}>
                            {proposal.clientName}
                          </div>
                          <div className="text-xs text-gray-500 truncate" title={proposal.clientEmail}>
                            {proposal.clientEmail}
                          </div>
                        </div>
                      </td>
                      <td className="px-4 py-3">
                        <div className="text-sm font-bold text-gray-900 truncate">
                          ${proposal.total.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2,
                          })}
                        </div>
                      </td>
                      <td className="px-4 py-3">{getStatusBadge(proposal.status)}</td>
                      <td className="px-4 py-3 text-right">
                        <div className="flex items-center justify-end gap-2">
                          <TooltipProvider>
                            <Tooltip>
                              <TooltipTrigger asChild>
                                <div className="text-xs text-gray-500 cursor-help">
                                  {formatDetailedTimestamp(proposal.createdAt, { showTime: true }).relative}
                                </div>
                              </TooltipTrigger>
                              <TooltipContent>
                                <p>{formatDetailedTimestamp(proposal.createdAt, { showTime: true }).full}</p>
                              </TooltipContent>
                            </Tooltip>
                          </TooltipProvider>
                          <Link href={`/dashboard/proposals/${proposal.id}`}>
                            <Button variant="ghost" size="sm" className="h-8 w-8 p-0">
                              <ExternalLink className="h-4 w-4" />
                            </Button>
                          </Link>
                          {isMasterUser && (
                            <Button
                              variant="ghost"
                              size="sm"
                              className="h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50"
                              onClick={(e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                setProposalToDelete(proposal.id);
                              }}
                            >
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          )}
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Mobile Card View */}
            <div className="lg:hidden divide-y divide-gray-200">
              {filteredProposals.map((proposal) => (
                <Link
                  key={proposal.id}
                  href={`/dashboard/proposals/${proposal.id}`}
                  className="block p-4 hover:bg-gray-50 transition-colors"
                >
                  <div className="space-y-3">
                    <div className="flex items-start justify-between gap-3">
                      <div className="min-w-0 flex-1">
                        <h3 className="text-sm font-semibold text-gray-900 line-clamp-1">
                          {proposal.title}
                        </h3>
                        <p className="text-xs text-gray-500 mt-0.5">{proposal.proposalNumber}</p>
                      </div>
                      {getStatusBadge(proposal.status)}
                    </div>

                    <div className="flex items-center justify-between text-sm">
                      <div className="min-w-0 flex-1">
                        <p className="font-medium text-gray-900 truncate">{proposal.clientName}</p>
                        <p className="text-xs text-gray-500 truncate">{proposal.clientEmail}</p>
                      </div>
                      <div className="text-right shrink-0 ml-3">
                        <p className="text-lg font-bold text-blue-600">
                          ${proposal.total.toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2,
                          })}
                        </p>
                      </div>
                    </div>

                    <div className="flex items-center justify-between text-xs text-gray-500">
                      <TooltipProvider>
                        <Tooltip>
                          <TooltipTrigger asChild>
                            <div className="flex items-center cursor-help">
                              <Calendar className="h-3 w-3 mr-1" />
                              {formatDetailedTimestamp(proposal.createdAt, { showTime: true }).relative}
                            </div>
                          </TooltipTrigger>
                          <TooltipContent>
                            <p>{formatDetailedTimestamp(proposal.createdAt, { showTime: true }).full}</p>
                          </TooltipContent>
                        </Tooltip>
                      </TooltipProvider>
                      {isMasterUser && (
                        <Button
                          variant="ghost"
                          size="sm"
                          className="h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50"
                          onClick={(e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            setProposalToDelete(proposal.id);
                          }}
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      )}
                    </div>
                  </div>
                </Link>
              ))}
            </div>
          </>
        )}
      </div>

      {/* Bulk Import Dialog */}
      <BulkProposalImportDialog
        open={showBulkImportDialog}
        onOpenChange={setShowBulkImportDialog}
        onImportComplete={fetchProposals}
      />

      {/* Delete Confirmation Dialog */}
      <AlertDialog open={!!proposalToDelete} onOpenChange={(open) => !open && setProposalToDelete(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete Proposal</AlertDialogTitle>
            <AlertDialogDescription>
              Are you sure you want to delete this proposal? This action cannot be undone and will permanently delete the proposal.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={deleting}>Cancel</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDeleteProposal}
              disabled={deleting}
              className="bg-red-600 hover:bg-red-700"
            >
              {deleting ? 'Deleting...' : 'Delete'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}

// ==========================================
// File: app/dashboard/proposals/[id]/edit/page.tsx
// ==========================================

'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter, useParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import { toast } from 'sonner';
import {
  Plus,
  Trash2,
  ArrowLeft,
  Save,
  DollarSign,
  Percent,
  Edit2,
} from 'lucide-react';
import { ProposalItem, calculateProposalTotals, Proposal } from '@/lib/proposal-types';
import { ALL_SERVICE_TIERS, getTierById } from '@/lib/pricing-tiers';
import Link from 'next/link';

interface ServiceOption {
  id: string;
  name: string;
  price: number;
  category: string;
}

export default function EditProposalPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const params = useParams();
  const proposalId = params.id as string;

  // Client info
  const [clientName, setClientName] = useState('');
  const [clientEmail, setClientEmail] = useState('');
  const [clientPhone, setClientPhone] = useState('');
  const [clientCompany, setClientCompany] = useState('');

  // Proposal info
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [items, setItems] = useState<ProposalItem[]>([]);
  const [taxPercent, setTaxPercent] = useState(0);
  const [discount, setDiscount] = useState(0);
  const [terms, setTerms] = useState('');
  const [notes, setNotes] = useState('');
  const [dueDate, setDueDate] = useState('');
  const [validUntil, setValidUntil] = useState('');

  // UI state
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [serviceOptions, setServiceOptions] = useState<ServiceOption[]>([]);

  useEffect(() => {
    if (status === 'authenticated' && proposalId) {
      fetchProposal();
      prepareServiceOptions();
    }
  }, [status, proposalId]);

  const fetchProposal = async () => {
    try {
      const res = await fetch(`/api/proposals/${proposalId}`);
      if (res.ok) {
        const data = await res.json();
        const proposal: Proposal = data.proposal;

        // Populate form fields
        setClientName(proposal.clientName);
        setClientEmail(proposal.clientEmail);
        setClientPhone(proposal.clientPhone || '');
        setClientCompany(proposal.clientCompany || '');
        setTitle(proposal.title);
        setDescription(proposal.description || '');
        setItems(proposal.items);
        
        // Calculate tax percentage from tax amount
        const subtotal = proposal.items.reduce((sum, item) => sum + item.total, 0);
        const taxPercent = subtotal > 0 ? (proposal.tax / (subtotal - proposal.discount)) * 100 : 0;
        setTaxPercent(Math.round(taxPercent * 100) / 100);
        
        setDiscount(proposal.discount);
        setTerms(proposal.terms || '');
        setNotes(proposal.notes || '');
        setDueDate(proposal.dueDate ? new Date(proposal.dueDate).toISOString().split('T')[0] : '');
        setValidUntil(proposal.validUntil ? new Date(proposal.validUntil).toISOString().split('T')[0] : '');
      } else {
        toast.error('Proposal not found');
        router.push('/dashboard/proposals');
      }
    } catch (error) {
      console.error('Error fetching proposal:', error);
      toast.error('Failed to load proposal');
    } finally {
      setLoading(false);
    }
  };

  const prepareServiceOptions = () => {
    const options: ServiceOption[] = [];
    
    // Ad Management
    ALL_SERVICE_TIERS.adManagement.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `Ad Management - ${tier.name}`,
        price: tier.price,
        category: 'Ad Management',
      });
    });

    // SEO
    ALL_SERVICE_TIERS.seo.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `SEO - ${tier.name}`,
        price: tier.price,
        category: 'SEO',
      });
    });

    // Social Media
    ALL_SERVICE_TIERS.socialMedia.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `Social Media - ${tier.name}`,
        price: tier.price,
        category: 'Social Media',
      });
    });

    // Web Development
    ALL_SERVICE_TIERS.webDevelopment.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `Web Development - ${tier.name}`,
        price: tier.price,
        category: 'Web Development',
      });
    });

    // App Creation
    ALL_SERVICE_TIERS.appCreation.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `App Creation - ${tier.name}`,
        price: tier.price,
        category: 'App Creation',
      });
    });

    // Website Maintenance
    ALL_SERVICE_TIERS.websiteMaintenance.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `Website Maintenance - ${tier.name}`,
        price: tier.price,
        category: 'Website Maintenance',
      });
    });

    // App Maintenance
    ALL_SERVICE_TIERS.appMaintenance.forEach((tier) => {
      options.push({
        id: tier.id,
        name: `App Maintenance - ${tier.name}`,
        price: tier.price,
        category: 'App Maintenance',
      });
    });

    setServiceOptions(options);
  };

  const addServiceItem = (serviceId: string) => {
    if (!serviceId) return;

    const service = serviceOptions.find((s) => s.id === serviceId);
    const tier = getTierById(serviceId);
    
    if (service && tier) {
      const newItem: ProposalItem = {
        id: Math.random().toString(36).substr(2, 9),
        type: 'service',
        name: service.name,
        description: tier.features.join('\nâ€¢ '),
        quantity: 1,
        unitPrice: service.price,
        total: service.price,
        serviceId: serviceId,
      };

      setItems([...items, newItem]);
    }
  };

  const addCustomItem = () => {
    const newItem: ProposalItem = {
      id: Math.random().toString(36).substr(2, 9),
      type: 'custom',
      name: '',
      description: '',
      quantity: 1,
      unitPrice: 0,
      total: 0,
    };

    setItems([...items, newItem]);
  };

  const updateItem = (index: number, field: keyof ProposalItem, value: any) => {
    const updatedItems = [...items];
    const item = updatedItems[index];
    
    (item as any)[field] = value;

    // Recalculate total
    if (field === 'quantity' || field === 'unitPrice') {
      item.total = item.quantity * item.unitPrice;
    }

    setItems(updatedItems);
  };

  const removeItem = (index: number) => {
    setItems(items.filter((_, i) => i !== index));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validation
    if (!clientName || !clientEmail) {
      toast.error('Please provide client name and email');
      return;
    }

    if (!title) {
      toast.error('Please provide a proposal title');
      return;
    }

    if (items.length === 0) {
      toast.error('Please add at least one item to the proposal');
      return;
    }

    // Check for incomplete custom items
    const incompleteItem = items.find(
      (item) => item.type === 'custom' && (!item.name || item.unitPrice <= 0)
    );
    if (incompleteItem) {
      toast.error('Please complete all custom items with name and price');
      return;
    }

    setSaving(true);

    try {
      const res = await fetch(`/api/proposals/${proposalId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          clientName,
          clientEmail,
          clientPhone,
          clientCompany,
          title,
          description,
          items,
          tax: taxPercent,
          discount,
          terms,
          notes,
          dueDate: dueDate || undefined,
          validUntil: validUntil || undefined,
        }),
      });

      if (res.ok) {
        toast.success('Proposal updated successfully!');
        router.push(`/dashboard/proposals/${proposalId}`);
      } else {
        const error = await res.json();
        toast.error(error.error || 'Failed to update proposal');
      }
    } catch (error) {
      console.error('Error updating proposal:', error);
      toast.error('An error occurred while updating the proposal');
    } finally {
      setSaving(false);
    }
  };

  const totals = calculateProposalTotals(items, taxPercent, discount);

  if (loading || status === 'loading') {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
      </div>
    );
  }

  return (
    <div className="space-y-6 max-w-5xl">
      {/* Header */}
      <div className="flex items-center gap-4">
        <Link href={`/dashboard/proposals/${proposalId}`}>
          <Button variant="ghost" size="sm">
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back
          </Button>
        </Link>
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Edit Proposal</h1>
          <p className="text-gray-600 mt-1">Make changes to your proposal</p>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6">
        {/* Client Info */}
        <Card>
          <CardHeader>
            <CardTitle>Client Information</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label htmlFor="clientName">
                  Client Name <span className="text-red-500">*</span>
                </Label>
                <Input
                  id="clientName"
                  value={clientName}
                  onChange={(e) => setClientName(e.target.value)}
                  placeholder="John Doe"
                  required
                />
              </div>
              <div>
                <Label htmlFor="clientEmail">
                  Client Email <span className="text-red-500">*</span>
                </Label>
                <Input
                  id="clientEmail"
                  type="email"
                  value={clientEmail}
                  onChange={(e) => setClientEmail(e.target.value)}
                  placeholder="john@example.com"
                  required
                />
              </div>
              <div>
                <Label htmlFor="clientPhone">Client Phone</Label>
                <Input
                  id="clientPhone"
                  value={clientPhone}
                  onChange={(e) => setClientPhone(e.target.value)}
                  placeholder="+1 (555) 123-4567"
                />
              </div>
              <div>
                <Label htmlFor="clientCompany">Company</Label>
                <Input
                  id="clientCompany"
                  value={clientCompany}
                  onChange={(e) => setClientCompany(e.target.value)}
                  placeholder="Acme Corp"
                />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Proposal Details */}
        <Card>
          <CardHeader>
            <CardTitle>Proposal Details</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="title">
                Proposal Title <span className="text-red-500">*</span>
              </Label>
              <Input
                id="title"
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                placeholder="Website Development & SEO Package"
                required
              />
            </div>
            <div>
              <Label htmlFor="description">Description</Label>
              <Textarea
                id="description"
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                placeholder="Brief overview of what this proposal includes..."
                rows={3}
              />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="dueDate">Due Date</Label>
                <Input
                  id="dueDate"
                  type="date"
                  value={dueDate}
                  onChange={(e) => setDueDate(e.target.value)}
                />
              </div>
              <div>
                <Label htmlFor="validUntil">Valid Until</Label>
                <Input
                  id="validUntil"
                  type="date"
                  value={validUntil}
                  onChange={(e) => setValidUntil(e.target.value)}
                />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Items */}
        <Card>
          <CardHeader>
            <CardTitle>Proposal Items</CardTitle>
            <CardDescription>Add or modify services and custom items</CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            {/* Add Service */}
            <div className="flex gap-2">
              <Select onValueChange={addServiceItem}>
                <SelectTrigger className="flex-1">
                  <SelectValue placeholder="Add a service..." />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="placeholder" disabled>
                    Select a service
                  </SelectItem>
                  {serviceOptions.map((service) => (
                    <SelectItem key={service.id} value={service.id}>
                      {service.name} - ${service.price}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <Button type="button" onClick={addCustomItem} variant="outline">
                <Plus className="h-4 w-4 mr-2" />
                Custom Item
              </Button>
            </div>

            <Separator />

            {/* Items List */}
            <div className="space-y-4">
              {items.length === 0 ? (
                <div className="text-center py-8 text-gray-500">
                  No items added yet. Add a service or custom item to get started.
                </div>
              ) : (
                items.map((item, index) => (
                  <Card key={item.id} className="border-dashed">
                    <CardContent className="pt-6">
                      <div className="space-y-3">
                        <div className="flex justify-between items-start">
                          <div className="flex-1 grid grid-cols-2 gap-3">
                            <div>
                              <Label>Item Name</Label>
                              <Input
                                value={item.name}
                                onChange={(e) => updateItem(index, 'name', e.target.value)}
                                placeholder="Service or item name"
                                disabled={item.type === 'service'}
                              />
                            </div>
                            <div>
                              <Label>Description</Label>
                              <Textarea
                                value={item.description}
                                onChange={(e) => updateItem(index, 'description', e.target.value)}
                                placeholder="Brief description"
                                rows={2}
                              />
                            </div>
                          </div>
                          <Button
                            type="button"
                            variant="ghost"
                            size="sm"
                            onClick={() => removeItem(index)}
                            className="ml-2"
                          >
                            <Trash2 className="h-4 w-4 text-red-500" />
                          </Button>
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                          <div>
                            <Label>Quantity</Label>
                            <Input
                              type="number"
                              min="1"
                              value={item.quantity}
                              onChange={(e) =>
                                updateItem(index, 'quantity', parseInt(e.target.value) || 1)
                              }
                            />
                          </div>
                          <div>
                            <Label className="flex items-center gap-2">
                              Unit Price
                              <span title="Editable">
                                <Edit2 className="h-3 w-3 text-blue-500" />
                              </span>
                            </Label>
                            <div className="relative">
                              <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                              <Input
                                type="number"
                                min="0"
                                step="0.01"
                                value={item.unitPrice}
                                onChange={(e) =>
                                  updateItem(index, 'unitPrice', parseFloat(e.target.value) || 0)
                                }
                                className="pl-9"
                              />
                            </div>
                          </div>
                          <div>
                            <Label>Total</Label>
                            <div className="flex items-center h-10 px-3 bg-gray-50 border border-gray-200 rounded-md text-sm font-medium">
                              ${item.total.toFixed(2)}
                            </div>
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))
              )}
            </div>

            {/* Totals */}
            {items.length > 0 && (
              <>
                <Separator />
                <div className="space-y-3">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label>Tax (%)</Label>
                      <div className="relative">
                        <Percent className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                          type="number"
                          min="0"
                          max="100"
                          step="0.01"
                          value={taxPercent}
                          onChange={(e) => setTaxPercent(parseFloat(e.target.value) || 0)}
                          className="pl-9"
                        />
                      </div>
                    </div>
                    <div>
                      <Label>Discount ($)</Label>
                      <div className="relative">
                        <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                          type="number"
                          min="0"
                          step="0.01"
                          value={discount}
                          onChange={(e) => setDiscount(parseFloat(e.target.value) || 0)}
                          className="pl-9"
                        />
                      </div>
                    </div>
                  </div>

                  <div className="bg-gray-50 p-4 rounded-lg space-y-2">
                    <div className="flex justify-between text-sm">
                      <span>Subtotal:</span>
                      <span className="font-medium">${totals.subtotal.toFixed(2)}</span>
                    </div>
                    {discount > 0 && (
                      <div className="flex justify-between text-sm text-green-600">
                        <span>Discount:</span>
                        <span className="font-medium">-${discount.toFixed(2)}</span>
                      </div>
                    )}
                    {taxPercent > 0 && (
                      <div className="flex justify-between text-sm">
                        <span>Tax ({taxPercent}%):</span>
                        <span className="font-medium">${totals.taxAmount.toFixed(2)}</span>
                      </div>
                    )}
                    <Separator />
                    <div className="flex justify-between text-lg font-bold">
                      <span>Total:</span>
                      <span className="text-blue-600">${totals.total.toFixed(2)}</span>
                    </div>
                  </div>
                </div>
              </>
            )}
          </CardContent>
        </Card>

        {/* Terms & Notes */}
        <Card>
          <CardHeader>
            <CardTitle>Terms & Additional Notes</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <Label htmlFor="terms">Terms & Conditions</Label>
              <Textarea
                id="terms"
                value={terms}
                onChange={(e) => setTerms(e.target.value)}
                rows={8}
                className="font-mono text-xs"
              />
            </div>
            <div>
              <Label htmlFor="notes">Internal Notes (Not visible to client)</Label>
              <Textarea
                id="notes"
                value={notes}
                onChange={(e) => setNotes(e.target.value)}
                placeholder="Add any internal notes about this proposal..."
                rows={3}
              />
            </div>
          </CardContent>
        </Card>

        {/* Actions */}
        <div className="flex justify-end gap-3">
          <Link href={`/dashboard/proposals/${proposalId}`}>
            <Button type="button" variant="outline">
              Cancel
            </Button>
          </Link>
          <Button type="submit" disabled={saving}>
            {saving ? (
              <>
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2" />
                Saving...
              </>
            ) : (
              <>
                <Save className="h-4 w-4 mr-2" />
                Save Changes
              </>
            )}
          </Button>
        </div>
      </form>
    </div>
  );
}

// ==========================================
// File: app/dashboard/proposals/[id]/page.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter, useParams } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { toast } from 'sonner';
import {
  ArrowLeft,
  Send,
  FileText,
  Trash2,
  Edit,
  DollarSign,
  Calendar,
  Mail,
  Phone,
  Building,
  CheckCircle2,
  XCircle,
  Clock,
  Eye,
  Download,
  CreditCard,
  Copy,
  ExternalLink,
} from 'lucide-react';
import { Proposal } from '@/lib/proposal-types';
import Link from 'next/link';
import { cn } from '@/lib/utils';
import { WYSIWYGEmailEditor } from '@/components/crm/sequences/wysiwyg-email-editor';

export default function ProposalDetailPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const params = useParams();
  const proposalId = params.id as string;

  const [proposal, setProposal] = useState<Proposal | null>(null);
  const [loading, setLoading] = useState(true);
  const [deleting, setDeleting] = useState(false);
  const [generatingPaymentLink, setGeneratingPaymentLink] = useState(false);
  const [sendingProposal, setSendingProposal] = useState(false);
  const [showEmailPreview, setShowEmailPreview] = useState(false);
  const [emailTemplate, setEmailTemplate] = useState<{ subject: string; body: string } | null>(null);
  const [editableSubject, setEditableSubject] = useState('');
  const [editableBody, setEditableBody] = useState('');

  useEffect(() => {
    if (status === 'authenticated' && proposalId) {
      fetchProposal();
    }
  }, [status, proposalId]);

  const fetchProposal = async () => {
    try {
      const res = await fetch(`/api/proposals/${proposalId}`);
      if (res.ok) {
        const data = await res.json();
        setProposal(data.proposal);
      } else {
        toast.error('Proposal not found');
        router.push('/dashboard/proposals');
      }
    } catch (error) {
      console.error('Error fetching proposal:', error);
      toast.error('Failed to load proposal');
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async () => {
    setDeleting(true);
    try {
      const res = await fetch(`/api/proposals/${proposalId}`, {
        method: 'DELETE',
      });

      if (res.ok) {
        toast.success('Proposal deleted successfully');
        router.push('/dashboard/proposals');
      } else {
        toast.error('Failed to delete proposal');
      }
    } catch (error) {
      console.error('Error deleting proposal:', error);
      toast.error('An error occurred while deleting the proposal');
    } finally {
      setDeleting(false);
    }
  };

  const handleGeneratePaymentLink = async () => {
    setGeneratingPaymentLink(true);
    try {
      const res = await fetch(`/api/proposals/${proposalId}/payment-link`, {
        method: 'POST',
      });

      if (res.ok) {
        const data = await res.json();
        
        // Update proposal with payment link
        if (proposal) {
          setProposal({
            ...proposal,
            stripePaymentUrl: data.paymentUrl,
            stripePaymentLinkId: data.paymentLinkId,
          });
        }
        
        toast.success('Payment link created successfully!');
      } else {
        const error = await res.json();
        toast.error(error.error || 'Failed to create payment link');
      }
    } catch (error) {
      console.error('Error creating payment link:', error);
      toast.error('An error occurred while creating payment link');
    } finally {
      setGeneratingPaymentLink(false);
    }
  };

  const handleCopyPaymentLink = async () => {
    if (!proposal?.stripePaymentUrl) return;
    
    const urlToCopy = proposal.stripePaymentUrl;
    let copySuccessful = false;
    
    // Method 1: Try modern Clipboard API
    try {
      if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
        await navigator.clipboard.writeText(urlToCopy);
        copySuccessful = true;
        toast.success('âœ“ Payment link copied to clipboard!');
        return;
      }
    } catch (clipboardError) {
      console.warn('Clipboard API failed:', clipboardError);
    }
    
    // Method 2: Try textarea with execCommand (works on most mobile devices)
    if (!copySuccessful) {
      try {
        const textarea = document.createElement('textarea');
        textarea.value = urlToCopy;
        textarea.setAttribute('readonly', '');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        textarea.style.fontSize = '12pt'; // Prevent zooming on iOS
        
        document.body.appendChild(textarea);
        
        // iOS specific handling
        if (navigator.userAgent.match(/ipad|iphone/i)) {
          const range = document.createRange();
          range.selectNodeContents(textarea);
          const selection = window.getSelection();
          selection?.removeAllRanges();
          selection?.addRange(range);
          textarea.setSelectionRange(0, urlToCopy.length);
        } else {
          textarea.select();
        }
        
        copySuccessful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (copySuccessful) {
          toast.success('âœ“ Payment link copied to clipboard!');
          return;
        }
      } catch (execError) {
        console.warn('execCommand failed:', execError);
      }
    }
    
    // If all methods failed
    if (!copySuccessful) {
      toast.error('âŒ Could not copy automatically. Please copy the link manually from above.');
    }
  };

  const handleDownloadPDF = () => {
    window.open(`/api/proposals/${proposalId}/pdf`, '_blank');
    toast.success('PDF download started');
  };

  const handleSendProposal = async () => {
    setSendingProposal(true);
    try {
      const res = await fetch(`/api/proposals/${proposalId}/send`, {
        method: 'POST',
      });

      if (res.ok) {
        const data = await res.json();
        setEmailTemplate(data.emailTemplate);
        setEditableSubject(data.emailTemplate.subject);
        setEditableBody(data.emailTemplate.body);
        setShowEmailPreview(true);
      } else {
        toast.error('Failed to prepare proposal email');
      }
    } catch (error) {
      console.error('Error preparing proposal:', error);
      toast.error('An error occurred while preparing proposal');
    } finally {
      setSendingProposal(false);
    }
  };

  const handleConfirmSend = async () => {
    try {
      // Here you would actually send the email with the edited subject and body
      // For now, we'll just update the proposal status and show success
      await fetch(`/api/proposals/${proposalId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'sent', sentAt: new Date() }),
      });
      
      toast.success('Proposal marked as sent! Email content is ready to copy.');
      setShowEmailPreview(false);
      fetchProposal();
    } catch (error) {
      console.error('Error confirming send:', error);
      toast.error('An error occurred');
    }
  };

  const getStatusBadge = (status: string) => {
    const styles = {
      draft: 'bg-gray-100 text-gray-700',
      sent: 'bg-blue-100 text-blue-700',
      viewed: 'bg-purple-100 text-purple-700',
      accepted: 'bg-green-100 text-green-700',
      declined: 'bg-red-100 text-red-700',
      expired: 'bg-orange-100 text-orange-700',
    };

    const icons = {
      draft: FileText,
      sent: Send,
      viewed: Eye,
      accepted: CheckCircle2,
      declined: XCircle,
      expired: Clock,
    };

    const Icon = icons[status as keyof typeof icons] || FileText;

    return (
      <Badge className={cn('flex items-center gap-1', styles[status as keyof typeof styles] || '')}>
        <Icon className="h-3 w-3" />
        {status.charAt(0).toUpperCase() + status.slice(1)}
      </Badge>
    );
  };

  if (loading || status === 'loading') {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
      </div>
    );
  }

  if (!proposal) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[400px]">
        <FileText className="h-16 w-16 text-gray-400 mb-4" />
        <h2 className="text-xl font-semibold text-gray-900 mb-2">Proposal not found</h2>
        <p className="text-gray-600 mb-4">The proposal you're looking for doesn't exist.</p>
        <Link href="/dashboard/proposals">
          <Button>
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back to Proposals
          </Button>
        </Link>
      </div>
    );
  }

  return (
    <div className="space-y-4 sm:space-y-6 max-w-5xl pb-6">
      {/* Header */}
      <div className="space-y-4">
        <div className="flex items-center gap-2 sm:gap-4">
          <Link href="/dashboard/proposals">
            <Button variant="ghost" size="sm">
              <ArrowLeft className="h-4 w-4 mr-2" />
              <span className="hidden sm:inline">Back</span>
            </Button>
          </Link>
          <div className="min-w-0 flex-1">
            <div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3">
              <h1 className="text-xl sm:text-3xl font-bold text-gray-900 truncate">{proposal.title}</h1>
              {getStatusBadge(proposal.status)}
            </div>
            <p className="text-sm sm:text-base text-gray-600 mt-1">{proposal.proposalNumber}</p>
          </div>
        </div>

        {/* Action Buttons - Mobile Optimized */}
        <div className="flex flex-wrap gap-2">
          {/* Edit */}
          {proposal.status === 'draft' && (
            <Link href={`/dashboard/proposals/${proposal.id}/edit`} className="flex-1 sm:flex-none">
              <Button variant="outline" size="sm" className="w-full">
                <Edit className="h-4 w-4 sm:mr-2" />
                <span className="hidden sm:inline">Edit</span>
              </Button>
            </Link>
          )}

          {/* Download PDF */}
          <Button variant="outline" size="sm" onClick={handleDownloadPDF} className="flex-1 sm:flex-none">
            <Download className="h-4 w-4 sm:mr-2" />
            <span className="sm:hidden">PDF</span>
            <span className="hidden sm:inline">Download PDF</span>
          </Button>

          {/* Send to Client */}
          {proposal.status === 'draft' && (
            <Button onClick={handleSendProposal} disabled={sendingProposal} size="sm" className="flex-1 sm:flex-none">
              {sendingProposal ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white sm:mr-2" />
                  <span className="hidden sm:inline">Sending...</span>
                </>
              ) : (
                <>
                  <Send className="h-4 w-4 sm:mr-2" />
                  <span className="sm:hidden">Send</span>
                  <span className="hidden sm:inline">Send to Client</span>
                </>
              )}
            </Button>
          )}

          {/* Delete - Only for master user */}
          {session?.user?.email === 'fray@cdmsuite.com' && (
            <AlertDialog>
              <AlertDialogTrigger asChild>
                <Button variant="outline" size="sm" className="text-red-600 hover:text-red-700 flex-1 sm:flex-none">
                  <Trash2 className="h-4 w-4 sm:mr-2" />
                  <span className="hidden sm:inline">Delete</span>
                </Button>
              </AlertDialogTrigger>
              <AlertDialogContent className="max-w-[90vw] sm:max-w-md">
                <AlertDialogHeader>
                  <AlertDialogTitle>Delete Proposal</AlertDialogTitle>
                  <AlertDialogDescription>
                    Are you sure you want to delete this proposal? This action cannot be undone.
                  </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                  <AlertDialogCancel>Cancel</AlertDialogCancel>
                  <AlertDialogAction onClick={handleDelete} disabled={deleting}>
                    {deleting ? 'Deleting...' : 'Delete'}
                  </AlertDialogAction>
                </AlertDialogFooter>
              </AlertDialogContent>
            </AlertDialog>
          )}
        </div>
      </div>

      {/* Payment Link Card - Prominent Display */}
      <Card className="border-2 border-blue-500 bg-blue-50">
        <CardHeader className="pb-3">
          <CardTitle className="text-lg flex items-center gap-2">
            <CreditCard className="h-5 w-5 text-blue-600" />
            Payment Link
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          {proposal.stripePaymentUrl ? (
            <>
              <p className="text-sm text-gray-700">
                Share this payment link with your client for secure online payment:
              </p>
              <div className="flex flex-col sm:flex-row gap-2">
                <div className="flex-1 p-3 bg-white border border-gray-200 rounded-md">
                  <p className="text-xs sm:text-sm text-gray-600 truncate font-mono">
                    {proposal.stripePaymentUrl}
                  </p>
                </div>
                <div className="flex gap-2">
                  <Button
                    variant="default"
                    size="sm"
                    onClick={() => window.open(proposal.stripePaymentUrl, '_blank')}
                    className="flex-1 sm:flex-none"
                  >
                    <ExternalLink className="h-4 w-4 mr-2" />
                    Open Link
                  </Button>
                  <Button variant="outline" size="sm" onClick={handleCopyPaymentLink} className="flex-1 sm:flex-none">
                    <Copy className="h-4 w-4 mr-2" />
                    Copy
                  </Button>
                </div>
              </div>
            </>
          ) : (
            <>
              <p className="text-sm text-gray-700">
                Generate a secure Stripe payment link to accept online payments for this proposal.
              </p>
              <Button
                onClick={handleGeneratePaymentLink}
                disabled={generatingPaymentLink}
                size="sm"
                className="w-full sm:w-auto"
              >
                {generatingPaymentLink ? (
                  <>
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2" />
                    Generating Payment Link...
                  </>
                ) : (
                  <>
                    <CreditCard className="h-4 w-4 mr-2" />
                    Generate Payment Link
                  </>
                )}
              </Button>
            </>
          )}
        </CardContent>
      </Card>

      {/* Email Preview & Edit Dialog with Professional Editor */}
      {emailTemplate && (
        <Dialog open={showEmailPreview} onOpenChange={setShowEmailPreview}>
          <DialogContent className="max-w-[95vw] sm:max-w-4xl max-h-[90vh] overflow-y-auto">
            <DialogHeader>
              <DialogTitle className="text-lg sm:text-xl">Review & Edit Proposal Email</DialogTitle>
              <DialogDescription className="text-sm">
                Review and edit the email before copying or sending to {proposal.clientEmail}. 
                Use the formatting toolbar and preview tab to create a professional HTML email.
              </DialogDescription>
            </DialogHeader>
            
            <div className="py-4">
              <WYSIWYGEmailEditor
                subject={editableSubject}
                content={editableBody}
                onSubjectChange={setEditableSubject}
                onContentChange={setEditableBody}
                proposalContext={proposal ? {
                  title: proposal.title,
                  clientName: proposal.clientName,
                  clientCompany: proposal.clientCompany,
                  total: proposal.total,
                  items: proposal.items,
                } : undefined}
              />
            </div>

            <DialogFooter className="flex-col sm:flex-row gap-2">
              <Button 
                variant="outline" 
                onClick={() => setShowEmailPreview(false)} 
                className="w-full sm:w-auto"
              >
                Cancel
              </Button>
              <Button onClick={handleConfirmSend} className="w-full sm:w-auto">
                <Send className="h-4 w-4 mr-2" />
                Mark as Sent
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      )}

      {/* Client Info */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base sm:text-lg">Client Information</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
            <div className="space-y-3">
              <div className="flex items-center gap-2 text-sm">
                <Mail className="h-4 w-4 text-gray-400 shrink-0" />
                <span className="font-medium truncate">{proposal.clientName}</span>
              </div>
              <div className="flex items-center gap-2 text-sm text-gray-600">
                <Mail className="h-4 w-4 text-gray-400 shrink-0" />
                <a href={`mailto:${proposal.clientEmail}`} className="hover:text-blue-600 truncate">
                  {proposal.clientEmail}
                </a>
              </div>
              {proposal.clientPhone && (
                <div className="flex items-center gap-2 text-sm text-gray-600">
                  <Phone className="h-4 w-4 text-gray-400 shrink-0" />
                  <a href={`tel:${proposal.clientPhone}`} className="hover:text-blue-600">
                    {proposal.clientPhone}
                  </a>
                </div>
              )}
              {proposal.clientCompany && (
                <div className="flex items-center gap-2 text-sm text-gray-600">
                  <Building className="h-4 w-4 text-gray-400 shrink-0" />
                  <span className="truncate">{proposal.clientCompany}</span>
                </div>
              )}
            </div>
            <div className="space-y-3">
              <div className="flex items-center gap-2 text-sm">
                <Calendar className="h-4 w-4 text-gray-400 shrink-0" />
                <span className="text-gray-600">
                  Created: {new Date(proposal.createdAt).toLocaleDateString()}
                </span>
              </div>
              {proposal.dueDate && (
                <div className="flex items-center gap-2 text-sm">
                  <Calendar className="h-4 w-4 text-gray-400 shrink-0" />
                  <span className="text-gray-600">
                    Due: {new Date(proposal.dueDate).toLocaleDateString()}
                  </span>
                </div>
              )}
              {proposal.validUntil && (
                <div className="flex items-center gap-2 text-sm">
                  <Clock className="h-4 w-4 text-gray-400 shrink-0" />
                  <span className="text-gray-600">
                    Valid Until: {new Date(proposal.validUntil).toLocaleDateString()}
                  </span>
                </div>
              )}
            </div>
          </div>
          {proposal.description && (
            <>
              <Separator className="my-4" />
              <div>
                <p className="text-sm font-medium text-gray-700 mb-1">Description</p>
                <p className="text-sm text-gray-600 break-words">{proposal.description}</p>
              </div>
            </>
          )}
        </CardContent>
      </Card>

      {/* Items */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base sm:text-lg">Proposal Items</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3 sm:space-y-4">
            {proposal.items.map((item, index) => (
              <div key={item.id} className="border border-gray-200 rounded-lg p-3 sm:p-4">
                <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2">
                  <div className="flex-1 min-w-0">
                    <h3 className="font-semibold text-gray-900 text-sm sm:text-base break-words">{item.name}</h3>
                    {item.description && (
                      <p className="text-xs sm:text-sm text-gray-600 mt-1 whitespace-pre-line break-words">
                        {item.description}
                      </p>
                    )}
                  </div>
                  <div className="text-left sm:text-right shrink-0 sm:ml-4">
                    <p className="font-semibold text-gray-900 text-base sm:text-lg">${item.total.toFixed(2)}</p>
                    <p className="text-xs text-gray-500">
                      {item.quantity} Ã— ${item.unitPrice.toFixed(2)}
                    </p>
                  </div>
                </div>
              </div>
            ))}
          </div>

          <Separator className="my-4 sm:my-6" />

          {/* Totals */}
          <div className="space-y-2">
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">Subtotal:</span>
              <span className="font-medium">${proposal.subtotal.toFixed(2)}</span>
            </div>
            {proposal.discount > 0 && (
              <div className="flex justify-between text-sm text-green-600">
                <span>Discount:</span>
                <span className="font-medium">-${proposal.discount.toFixed(2)}</span>
              </div>
            )}
            {proposal.tax > 0 && (
              <div className="flex justify-between text-sm">
                <span className="text-gray-600">Tax:</span>
                <span className="font-medium">${proposal.tax.toFixed(2)}</span>
              </div>
            )}
            <Separator />
            <div className="flex justify-between text-base sm:text-lg font-bold">
              <span>Total:</span>
              <span className="text-blue-600">${proposal.total.toFixed(2)}</span>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Terms & Notes */}
      {(proposal.terms || proposal.notes) && (
        <Card>
          <CardHeader>
            <CardTitle>Additional Information</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {proposal.terms && (
              <div>
                <h3 className="font-semibold text-gray-900 mb-2">Terms & Conditions</h3>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <p className="text-sm text-gray-700 whitespace-pre-line">{proposal.terms}</p>
                </div>
              </div>
            )}
            {proposal.notes && (
              <div>
                <h3 className="font-semibold text-gray-900 mb-2">Internal Notes</h3>
                <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                  <p className="text-sm text-gray-700 whitespace-pre-line">{proposal.notes}</p>
                </div>
              </div>
            )}
          </CardContent>
        </Card>
      )}
    </div>
  );
}

// ==========================================
// File: app/dashboard/self-service/page.tsx
// ==========================================


'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { 
  Search, 
  FileText, 
  Calculator, 
  TrendingUp, 
  Mail, 
  DollarSign,
  Lock,
  CheckCircle2,
  ArrowRight
} from 'lucide-react';

interface ServiceAccess {
  tier: string;
  toolsAccess: Record<string, boolean>;
  limits: Record<string, number>;
  usageThisMonth: Record<string, number>;
  features: Record<string, boolean>;
}

export default function SelfServicePortalPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [access, setAccess] = useState<ServiceAccess | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/');
    }
  }, [status, router]);

  useEffect(() => {
    if (session) {
      fetchAccess();
    }
  }, [session]);

  const fetchAccess = async () => {
    try {
      const res = await fetch('/api/self-service/access');
      if (res.ok) {
        const data = await res.json();
        setAccess(data.access);
      }
    } catch (error) {
      console.error('Error fetching access:', error);
    } finally {
      setLoading(false);
    }
  };

  const tools = [
    {
      id: 'seoChecker',
      name: 'SEO Checker',
      description: 'Analyze website SEO and get improvement recommendations',
      icon: Search,
      url: '/tools/seo-checker',
      usageKey: 'seoChecksUsed',
      limitKey: 'seoChecksPerMonth',
    },
    {
      id: 'auditTool',
      name: 'Website Auditor',
      description: 'Comprehensive website audit with performance analysis',
      icon: FileText,
      url: '/auditor',
      usageKey: 'auditsUsed',
      limitKey: 'auditsPerMonth',
    },
    {
      id: 'roiCalculator',
      name: 'ROI Calculator',
      description: 'Calculate potential return on marketing investment',
      icon: Calculator,
      url: '/tools/roi-calculator',
      usageKey: null,
      limitKey: null,
    },
    {
      id: 'budgetPlanner',
      name: 'Budget Calculator',
      description: 'Plan your marketing budget allocation',
      icon: DollarSign,
      url: '/tools/budget-calculator',
      usageKey: null,
      limitKey: null,
    },
    {
      id: 'conversionAnalyzer',
      name: 'Conversion Analyzer',
      description: 'Analyze and improve conversion rates',
      icon: TrendingUp,
      url: '/tools/conversion-analyzer',
      usageKey: null,
      limitKey: null,
    },
    {
      id: 'emailTester',
      name: 'Email Tester',
      description: 'Test and optimize email deliverability',
      icon: Mail,
      url: '/tools/email-tester',
      usageKey: null,
      limitKey: null,
    },
  ];

  if (loading) {
    return (
      <div className="container mx-auto p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-1/4"></div>
          <div className="h-64 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  if (!access) {
    return (
      <div className="container mx-auto p-6">
        <Card>
          <CardContent className="flex flex-col items-center justify-center py-12">
            <p className="text-muted-foreground">Unable to load access information</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-4 sm:space-y-6">
      <div>
        <h1 className="text-2xl sm:text-3xl font-bold">Self-Service Tools</h1>
        <p className="text-sm sm:text-base text-muted-foreground mt-1">
          Access powerful marketing tools based on your plan
        </p>
      </div>

      {/* Current Plan */}
      <Card className="bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200">
        <CardHeader className="p-4 sm:p-6">
          <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2 sm:gap-0">
            <div>
              <CardTitle className="text-lg sm:text-xl capitalize">{access.tier} Plan</CardTitle>
              <CardDescription className="text-xs sm:text-sm">Your current subscription tier</CardDescription>
            </div>
            <Badge className="bg-blue-600 text-white w-fit">
              Active
            </Badge>
          </div>
        </CardHeader>
        <CardContent className="p-4 sm:p-6 pt-0">
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 sm:gap-4">
            <div>
              <div className="text-xs sm:text-sm text-muted-foreground mb-1">Audits This Month</div>
              <div className="flex items-baseline gap-1 sm:gap-2">
                <span className="text-xl sm:text-2xl font-bold">
                  {access.usageThisMonth.auditsUsed || 0}
                </span>
                <span className="text-xs sm:text-sm text-muted-foreground">
                  / {access.limits.auditsPerMonth}
                </span>
              </div>
              <Progress 
                value={(access.usageThisMonth.auditsUsed || 0) / access.limits.auditsPerMonth * 100} 
                className="h-2 mt-2" 
              />
            </div>
            <div>
              <div className="text-xs sm:text-sm text-muted-foreground mb-1">SEO Checks</div>
              <div className="flex items-baseline gap-1 sm:gap-2">
                <span className="text-xl sm:text-2xl font-bold">
                  {access.usageThisMonth.seoChecksUsed || 0}
                </span>
                <span className="text-xs sm:text-sm text-muted-foreground">
                  / {access.limits.seoChecksPerMonth}
                </span>
              </div>
              <Progress 
                value={(access.usageThisMonth.seoChecksUsed || 0) / access.limits.seoChecksPerMonth * 100} 
                className="h-2 mt-2" 
              />
            </div>
            <div className="sm:col-span-2 md:col-span-1">
              <div className="text-xs sm:text-sm text-muted-foreground mb-1">Projects</div>
              <div className="flex items-baseline gap-1 sm:gap-2">
                <span className="text-xl sm:text-2xl font-bold">
                  {access.usageThisMonth.projectsUsed || 0}
                </span>
                <span className="text-xs sm:text-sm text-muted-foreground">
                  / {access.limits.projectsLimit}
                </span>
              </div>
              <Progress 
                value={(access.usageThisMonth.projectsUsed || 0) / access.limits.projectsLimit * 100} 
                className="h-2 mt-2" 
              />
            </div>
          </div>

          {access.tier === 'free' && (
            <div className="mt-4 p-3 sm:p-4 bg-white rounded-lg border">
              <p className="text-xs sm:text-sm text-muted-foreground mb-2 sm:mb-3">
                Upgrade to unlock more tools and higher limits
              </p>
              <Link href="/pricing">
                <Button size="sm" className="w-full sm:w-auto">
                  View Plans
                  <ArrowRight className="ml-2 h-4 w-4" />
                </Button>
              </Link>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Available Tools */}
      <div className="space-y-3 sm:space-y-4">
        <h2 className="text-lg sm:text-xl font-semibold">Available Tools</h2>
        
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
          {tools.map((tool) => {
            const hasAccess = access.toolsAccess[tool.id];
            const Icon = tool.icon;
            const usage = tool.usageKey ? access.usageThisMonth[tool.usageKey] || 0 : null;
            const limit = tool.limitKey ? access.limits[tool.limitKey] : null;
            const isLimitReached = limit !== null && usage !== null && usage >= limit;

            return (
              <Card 
                key={tool.id} 
                className={`hover:shadow-lg transition-shadow ${!hasAccess ? 'opacity-60' : ''}`}
              >
                <CardHeader className="p-4 sm:p-6">
                  <div className="flex justify-between items-start mb-2">
                    <Icon className="h-6 w-6 sm:h-8 sm:w-8 text-blue-600 flex-shrink-0" />
                    {hasAccess ? (
                      <CheckCircle2 className="h-4 w-4 sm:h-5 sm:w-5 text-green-600 flex-shrink-0" />
                    ) : (
                      <Lock className="h-4 w-4 sm:h-5 sm:w-5 text-gray-400 flex-shrink-0" />
                    )}
                  </div>
                  <CardTitle className="text-base sm:text-lg">{tool.name}</CardTitle>
                  <CardDescription className="text-xs sm:text-sm">
                    {tool.description}
                  </CardDescription>
                </CardHeader>
                <CardContent className="p-4 sm:p-6 pt-0">
                  {usage !== null && limit !== null && (
                    <div className="mb-3 text-xs sm:text-sm">
                      <div className="flex justify-between text-muted-foreground mb-1">
                        <span className="truncate mr-2">Usage this month</span>
                        <span className="flex-shrink-0">{usage} / {limit}</span>
                      </div>
                      <Progress value={(usage / limit) * 100} className="h-1" />
                    </div>
                  )}

                  {hasAccess ? (
                    isLimitReached ? (
                      <Button variant="outline" disabled className="w-full text-sm">
                        Limit Reached
                      </Button>
                    ) : (
                      <Link href={tool.url} className="block">
                        <Button className="w-full group text-sm">
                          Use Tool
                          <ArrowRight className="ml-2 h-3 w-3 sm:h-4 sm:w-4 group-hover:translate-x-1 transition-transform" />
                        </Button>
                      </Link>
                    )
                  ) : (
                    <Link href="/pricing" className="block">
                      <Button variant="outline" className="w-full text-sm">
                        <Lock className="mr-2 h-3 w-3 sm:h-4 sm:w-4" />
                        Upgrade to Unlock
                      </Button>
                    </Link>
                  )}
                </CardContent>
              </Card>
            );
          })}
        </div>
      </div>

      {/* Features */}
      {access.features && Object.keys(access.features).length > 0 && (
        <Card>
          <CardHeader className="p-4 sm:p-6">
            <CardTitle className="text-lg sm:text-xl">Plan Features</CardTitle>
            <CardDescription className="text-xs sm:text-sm">Additional features included in your plan</CardDescription>
          </CardHeader>
          <CardContent className="p-4 sm:p-6 pt-0">
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
              {Object.entries(access.features).map(([key, enabled]) => (
                <div key={key} className="flex items-center gap-2">
                  {enabled ? (
                    <CheckCircle2 className="h-4 w-4 sm:h-5 sm:w-5 text-green-600 flex-shrink-0" />
                  ) : (
                    <Lock className="h-4 w-4 sm:h-5 sm:w-5 text-gray-400 flex-shrink-0" />
                  )}
                  <span className={`text-xs sm:text-sm ${enabled ? '' : 'text-muted-foreground'}`}>
                    {key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}
                  </span>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}

// ==========================================
// File: app/dashboard/sequences/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";

export const metadata = {
  title: "Sequences | CDM Suite Dashboard",
  description: "Manage your marketing automation sequences",
};

export default async function SequencesPage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  return (
    <div className="space-y-6 pb-8">
      <div>
        <h1 className="text-3xl font-bold mb-2">Sequences</h1>
        <p className="text-slate-600">
          Manage your marketing automation sequences and email campaigns
        </p>
      </div>

      <div className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-12 text-center border-2 border-dashed border-blue-200">
        <div className="max-w-md mx-auto">
          <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              strokeWidth="2"
              strokeLinecap="round"
              strokeLinejoin="round"
              className="text-blue-600"
            >
              <line x1="22" y1="2" x2="11" y2="13" />
              <polygon points="22 2 15 22 11 13 2 9 22 2" />
            </svg>
          </div>
          <h2 className="text-2xl font-bold mb-3 text-gray-900">
            Sequences Coming Soon
          </h2>
          <p className="text-gray-600 mb-6">
            Automated marketing sequences and email campaigns are currently under development. 
            This feature will allow you to create and manage multi-step email sequences to nurture your leads automatically.
          </p>
          <div className="bg-white rounded-lg p-4 text-left space-y-2">
            <p className="font-semibold text-sm text-gray-900">What's Coming:</p>
            <ul className="text-sm text-gray-600 space-y-1">
              <li>â€¢ Create multi-step email sequences</li>
              <li>â€¢ Track engagement and open rates</li>
              <li>â€¢ A/B test your campaigns</li>
              <li>â€¢ Automated follow-ups</li>
              <li>â€¢ Performance analytics</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
}

// ==========================================
// File: app/dashboard/services/page.tsx
// ==========================================


import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import ServicesClient from "./services-client";

export const metadata = {
  title: "Services | CDM Suite",
  description: "Browse and purchase our digital marketing services",
};

export default async function DashboardServicesPage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  return <ServicesClient user={user} />;
}

// ==========================================
// File: app/dashboard/services/services-client.tsx
// ==========================================


"use client";

import { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { CheckCircle, TrendingUp, Search, Share2, Smartphone, Globe, Star, Wrench } from "lucide-react";
import { toast } from "react-hot-toast";
import { 
  AD_MANAGEMENT_TIERS, 
  SEO_TIERS, 
  SOCIAL_MEDIA_TIERS, 
  WEB_DEVELOPMENT_TIERS,
  APP_CREATION_TIERS,
  WEBSITE_MAINTENANCE_TIERS,
  APP_MAINTENANCE_TIERS
} from "@/lib/pricing-tiers";

interface User {
  id: string;
  email: string;
  name: string | null;
  tier: string;
}

interface ServicesClientProps {
  user: User;
}

const services = {
  adManagement: AD_MANAGEMENT_TIERS,
  seo: SEO_TIERS,
  socialMedia: SOCIAL_MEDIA_TIERS,
  webDevelopment: WEB_DEVELOPMENT_TIERS,
  appCreation: APP_CREATION_TIERS,
  websiteMaintenance: WEBSITE_MAINTENANCE_TIERS,
  appMaintenance: APP_MAINTENANCE_TIERS,
};

export default function ServicesClient({ user }: ServicesClientProps) {
  const [loading, setLoading] = useState<string | null>(null);

  const handlePurchase = async (serviceId: string, serviceName: string, price: number) => {
    setLoading(serviceId);
    
    try {
      // Create checkout session
      const response = await fetch("/api/create-checkout-session", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          serviceId,
          serviceName,
          price,
          userId: user.id,
        }),
      });

      if (!response.ok) {
        throw new Error("Failed to create checkout session");
      }

      const { url } = await response.json();
      
      // Redirect to Stripe checkout
      window.location.href = url;
    } catch (error) {
      console.error("Purchase error:", error);
      toast.error("Failed to start checkout. Please try again.");
      setLoading(null);
    }
  };

  const renderServiceCard = (service: any, category: string) => (
    <Card key={service.id} className={`relative ${service.popular ? 'border-primary shadow-lg' : ''}`}>
      {service.popular && (
        <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
          <Badge className="bg-primary text-white">
            <Star className="w-3 h-3 mr-1" />
            Most Popular
          </Badge>
        </div>
      )}
      <CardHeader>
        <CardTitle className="text-2xl">{service.name}</CardTitle>
        <CardDescription>{service.description}</CardDescription>
        <div className="mt-4">
          <span className="text-4xl font-bold text-primary">${service.price.toLocaleString()}</span>
          <span className="text-gray-600">/month</span>
        </div>
      </CardHeader>
      <CardContent>
        <ul className="space-y-3 mb-6">
          {service.features.map((feature: string, index: number) => (
            <li key={index} className="flex items-start gap-2">
              <CheckCircle className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
              <span className="text-sm text-gray-700">{feature}</span>
            </li>
          ))}
        </ul>
        <Button
          className="w-full"
          variant={service.popular ? "default" : "outline"}
          onClick={() => handlePurchase(service.id, `${category} - ${service.name}`, service.price)}
          disabled={loading === service.id}
        >
          {loading === service.id ? "Processing..." : "Purchase Now"}
        </Button>
      </CardContent>
    </Card>
  );

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl sm:text-3xl font-bold mb-2">Our Services</h1>
        <p className="text-sm sm:text-base text-gray-600">
          Choose from our comprehensive digital marketing services to grow your business
        </p>
      </div>

      <Tabs defaultValue="ad-management" className="w-full">
        <div className="overflow-x-auto -mx-3 px-3 sm:mx-0 sm:px-0">
          <TabsList className="inline-flex w-max min-w-full sm:grid sm:w-full grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-1">
            <TabsTrigger value="ad-management" className="whitespace-nowrap">
              <TrendingUp className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">Ad Management</span>
              <span className="sm:hidden ml-1">Ads</span>
            </TabsTrigger>
            <TabsTrigger value="seo" className="whitespace-nowrap">
              <Search className="w-4 h-4 sm:mr-2" />
              <span className="ml-1">SEO</span>
            </TabsTrigger>
            <TabsTrigger value="social-media" className="whitespace-nowrap">
              <Share2 className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">Social Media</span>
              <span className="sm:hidden ml-1">Social</span>
            </TabsTrigger>
            <TabsTrigger value="web-development" className="whitespace-nowrap">
              <Globe className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">Web Dev</span>
              <span className="sm:hidden ml-1">Web</span>
            </TabsTrigger>
            <TabsTrigger value="app-creation" className="whitespace-nowrap">
              <Smartphone className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">App Creation</span>
              <span className="sm:hidden ml-1">Apps</span>
            </TabsTrigger>
            <TabsTrigger value="website-maintenance" className="whitespace-nowrap">
              <Wrench className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">Web Maintenance</span>
              <span className="sm:hidden ml-1">Web Maint</span>
            </TabsTrigger>
            <TabsTrigger value="app-maintenance" className="whitespace-nowrap">
              <Wrench className="w-4 h-4 sm:mr-2" />
              <span className="hidden sm:inline">App Maintenance</span>
              <span className="sm:hidden ml-1">App Maint</span>
            </TabsTrigger>
          </TabsList>
        </div>

        <TabsContent value="ad-management" className="space-y-6">
          <div>
            <h2 className="text-2xl font-bold mb-2">Advertising Management</h2>
            <p className="text-gray-600">
              Turn ad spend into revenue with our expert campaign management
            </p>
          </div>
          <div className="grid md:grid-cols-3 gap-6">
            {services.adManagement.map((service) => renderServiceCard(service, "Ad Management"))}
          </div>
        </TabsContent>

        <TabsContent value="seo" className="space-y-6">
          <div>
            <h2 className="text-2xl font-bold mb-2">SEO Services</h2>
            <p className="text-gray-600">
              Get found by customers searching for your products and services
            </p>
          </div>
          <div className="grid md:grid-cols-3 gap-6">
            {services.seo.map((service) => renderServiceCard(service, "SEO"))}
          </div>
        </TabsContent>

        <TabsContent value="social-media" className="space-y-6">
          <div>
            <h2 className="text-2xl font-bold mb-2">Social Media Marketing</h2>
            <p className="text-gray-600">
              Build your brand and engage your audience on social platforms
            </p>
          </div>
          <div className="grid md:grid-cols-3 gap-6">
            {services.socialMedia.map((service) => renderServiceCard(service, "Social Media"))}
          </div>
        </TabsContent>

        <TabsContent value="web-development" className="space-y-6">
          <div>
            <h2 className="text-2xl font-bold mb-2">Web Development</h2>
            <p className="text-gray-600">
              Beautiful, high-performing websites that convert visitors into customers
            </p>
          </div>
          <div className="grid md:grid-cols-3 gap-6">
            {services.webDevelopment.map((service) => renderServiceCard(service, "Web Development"))}
          </div>
        </TabsContent>

        <TabsContent value="app-creation" className="space-y-6">
          <div>
            <h2 className="text-2xl font-bold mb-2">App Creation</h2>
            <p className="text-gray-600">
              Transform your vision into a powerful mobile app that users love
            </p>
          </div>
          <div className="grid md:grid-cols-3 gap-6">
            {services.appCreation.map((service) => renderServiceCard(service, "App Creation"))}
          </div>
        </TabsContent>

        <TabsContent value="website-maintenance" className="space-y-6">
          <div>
            <h2 className="text-2xl font-bold mb-2">Website Maintenance</h2>
            <p className="text-gray-600">
              Keep your website secure, updated, and running smoothly 24/7
            </p>
          </div>
          <div className="grid md:grid-cols-3 gap-6">
            {services.websiteMaintenance.map((service) => renderServiceCard(service, "Website Maintenance"))}
          </div>
        </TabsContent>

        <TabsContent value="app-maintenance" className="space-y-6">
          <div>
            <h2 className="text-2xl font-bold mb-2">App Maintenance</h2>
            <p className="text-gray-600">
              Ongoing support to keep your mobile app updated and performing at its best
            </p>
          </div>
          <div className="grid md:grid-cols-3 gap-6">
            {services.appMaintenance.map((service) => renderServiceCard(service, "App Maintenance"))}
          </div>
        </TabsContent>
      </Tabs>

      <Card>
        <CardHeader>
          <CardTitle>Need Help Choosing?</CardTitle>
          <CardDescription>
            Not sure which service is right for you? Our team is here to help!
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Button onClick={() => window.location.href = '/contact'}>
            Schedule a Free Consultation
          </Button>
        </CardContent>
      </Card>
    </div>
  );
}

// ==========================================
// File: app/dashboard/settings/page.tsx
// ==========================================



import { redirect } from "next/navigation";
import { getCurrentUser } from "@/lib/session";
import { SettingsClient } from "@/components/dashboard/settings-client";

export const metadata = {
  title: "Settings | CDM Suite",
  description: "Manage your account settings and preferences",
};

export default async function SettingsPage() {
  const user = await getCurrentUser();

  if (!user) {
    redirect("/auth/login");
  }

  return <SettingsClient user={user} />;
}

// ==========================================
// File: app/dashboard/team/page.tsx
// ==========================================


'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import { Users, TrendingUp, AlertTriangle, CheckCircle2 } from 'lucide-react';

interface EmployeeWorkload {
  id: string;
  name: string;
  email: string;
  role: string;
  department?: string;
  capacity: {
    weekly: number;
    current: number;
    available: number;
    utilizationRate: number;
  };
  projects: {
    current: number;
    max: number;
  };
  tasks: number;
  assignments: number;
  status: string;
}

export default function TeamWorkloadPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [employees, setEmployees] = useState<EmployeeWorkload[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/');
    }
  }, [status, router]);

  useEffect(() => {
    // @ts-ignore
    if (session?.user?.role === 'admin' || session?.user?.role === 'employee') {
      fetchTeamWorkload();
    }
  }, [session]);

  const fetchTeamWorkload = async () => {
    try {
      const res = await fetch('/api/team/workload');
      if (res.ok) {
        const data = await res.json();
        setEmployees(data.employees || []);
      }
    } catch (error) {
      console.error('Error fetching team workload:', error);
    } finally {
      setLoading(false);
    }
  };

  const getUtilizationColor = (rate: number) => {
    if (rate >= 90) return 'text-red-600';
    if (rate >= 75) return 'text-yellow-600';
    return 'text-green-600';
  };

  const getUtilizationBadge = (rate: number) => {
    if (rate >= 90) return { variant: 'destructive' as const, label: 'Overloaded' };
    if (rate >= 75) return { variant: 'outline' as const, label: 'High' };
    if (rate >= 50) return { variant: 'secondary' as const, label: 'Optimal' };
    return { variant: 'outline' as const, label: 'Available' };
  };

  const teamStats = {
    total: employees.length,
    available: employees.filter(e => e.status === 'available' && e.capacity.utilizationRate < 75).length,
    busy: employees.filter(e => e.capacity.utilizationRate >= 75).length,
    avgUtilization: employees.length > 0
      ? Math.round(employees.reduce((sum, e) => sum + e.capacity.utilizationRate, 0) / employees.length)
      : 0,
  };

  if (loading) {
    return (
      <div className="container mx-auto p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-1/4"></div>
          <div className="h-64 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-4 sm:space-y-6">
      <div>
        <h1 className="text-2xl sm:text-3xl font-bold">Team Workload Dashboard</h1>
        <p className="text-sm sm:text-base text-muted-foreground mt-1">
          Monitor team capacity and project assignments
        </p>
      </div>

      {/* Team Stats */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
        <Card>
          <CardHeader className="pb-2 p-4 sm:p-6">
            <CardTitle className="text-xs sm:text-sm font-medium text-muted-foreground flex items-center gap-1 sm:gap-2">
              <Users className="h-3 w-3 sm:h-4 sm:w-4 flex-shrink-0" />
              <span className="truncate">Total Team</span>
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4 sm:p-6 pt-0">
            <div className="text-xl sm:text-2xl font-bold">{teamStats.total}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2 p-4 sm:p-6">
            <CardTitle className="text-xs sm:text-sm font-medium text-muted-foreground flex items-center gap-1 sm:gap-2">
              <CheckCircle2 className="h-3 w-3 sm:h-4 sm:w-4 flex-shrink-0" />
              <span className="truncate">Available</span>
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4 sm:p-6 pt-0">
            <div className="text-xl sm:text-2xl font-bold text-green-600">{teamStats.available}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2 p-4 sm:p-6">
            <CardTitle className="text-xs sm:text-sm font-medium text-muted-foreground flex items-center gap-1 sm:gap-2">
              <AlertTriangle className="h-3 w-3 sm:h-4 sm:w-4 flex-shrink-0" />
              <span className="truncate">High Load</span>
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4 sm:p-6 pt-0">
            <div className="text-xl sm:text-2xl font-bold text-yellow-600">{teamStats.busy}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2 p-4 sm:p-6">
            <CardTitle className="text-xs sm:text-sm font-medium text-muted-foreground flex items-center gap-1 sm:gap-2">
              <TrendingUp className="h-3 w-3 sm:h-4 sm:w-4 flex-shrink-0" />
              <span className="truncate">Avg Usage</span>
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4 sm:p-6 pt-0">
            <div className={`text-xl sm:text-2xl font-bold ${getUtilizationColor(teamStats.avgUtilization)}`}>
              {teamStats.avgUtilization}%
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Team Members */}
      <div className="space-y-3 sm:space-y-4">
        <h2 className="text-lg sm:text-xl font-semibold">Team Members</h2>
        
        {employees.length === 0 ? (
          <Card>
            <CardContent className="flex flex-col items-center justify-center py-12 px-4">
              <Users className="h-10 w-10 sm:h-12 sm:w-12 text-muted-foreground mb-4" />
              <p className="text-sm sm:text-base text-muted-foreground">No team members found</p>
            </CardContent>
          </Card>
        ) : (
          employees.map((employee) => {
            const utilizationBadge = getUtilizationBadge(employee.capacity.utilizationRate);
            
            return (
              <Card key={employee.id} className="hover:shadow-lg transition-shadow">
                <CardHeader className="p-4 sm:p-6">
                  <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2">
                    <div className="min-w-0 flex-1">
                      <CardTitle className="text-base sm:text-lg truncate">{employee.name || employee.email}</CardTitle>
                      <CardDescription className="text-xs sm:text-sm truncate">
                        {employee.role}
                        {employee.department && ` â€¢ ${employee.department}`}
                      </CardDescription>
                    </div>
                    <Badge variant={utilizationBadge.variant} className="w-fit">
                      {utilizationBadge.label}
                    </Badge>
                  </div>
                </CardHeader>
                <CardContent className="space-y-3 sm:space-y-4 p-4 sm:p-6 pt-0">
                  {/* Capacity */}
                  <div>
                    <div className="flex flex-col sm:flex-row sm:justify-between text-xs sm:text-sm mb-2 gap-1">
                      <span className="text-muted-foreground">Weekly Capacity</span>
                      <span className={`font-medium ${getUtilizationColor(employee.capacity.utilizationRate)}`}>
                        {employee.capacity.current}h / {employee.capacity.weekly}h ({employee.capacity.utilizationRate}%)
                      </span>
                    </div>
                    <Progress value={employee.capacity.utilizationRate} className="h-2" />
                    <div className="text-xs sm:text-sm text-muted-foreground mt-1">
                      {employee.capacity.available}h available this week
                    </div>
                  </div>

                  {/* Projects and Tasks */}
                  <div className="grid grid-cols-3 gap-2 sm:gap-4 pt-2 border-t">
                    <div>
                      <div className="text-xs sm:text-sm text-muted-foreground truncate">Projects</div>
                      <div className="text-base sm:text-lg font-semibold">
                        {employee.projects.current} / {employee.projects.max}
                      </div>
                    </div>
                    <div>
                      <div className="text-xs sm:text-sm text-muted-foreground truncate">Tasks</div>
                      <div className="text-base sm:text-lg font-semibold">{employee.tasks}</div>
                    </div>
                    <div>
                      <div className="text-xs sm:text-sm text-muted-foreground truncate">Assigns</div>
                      <div className="text-base sm:text-lg font-semibold">{employee.assignments}</div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })
        )}
      </div>
    </div>
  );
}

// ==========================================
// File: app/dashboard/workflows/create/page.tsx
// ==========================================



'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { toast } from 'sonner';
import { 
  ArrowLeft, 
  ClipboardList, 
  CheckCircle2, 
  Clock,
  Sparkles,
  Users
} from 'lucide-react';
import Link from 'next/link';
import { getWorkflowTemplate, WORKFLOW_TEMPLATES } from '@/lib/workflow-templates';

interface ServiceInfo {
  id: string;
  name: string;
  type: string;
  tier?: string;
  amount?: number;
}

export default function CreateWorkflowPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [services, setServices] = useState<ServiceInfo[]>([]);
  const [loadingServices, setLoadingServices] = useState(true);
  
  // Form state
  const [selectedService, setSelectedService] = useState<string>('');
  const [customServiceName, setCustomServiceName] = useState('');
  const [serviceType, setServiceType] = useState<string>('');
  const [serviceTier, setServiceTier] = useState<string>('');
  const [serviceAmount, setServiceAmount] = useState<string>('');
  const [clientId, setClientId] = useState<string>('');
  const [clientNotes, setClientNotes] = useState('');
  const [clients, setClients] = useState<any[]>([]);
  const [loadingClients, setLoadingClients] = useState(true);
  
  // Template preview state
  const [templatePreview, setTemplatePreview] = useState<any>(null);

  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/');
    }
  }, [status, router]);

  useEffect(() => {
    // @ts-ignore
    if (session?.user?.role === 'admin' || session?.user?.role === 'employee') {
      fetchServices();
      fetchClients();
    }
  }, [session]);

  useEffect(() => {
    // Update template preview when service type or tier changes
    if (serviceType) {
      const template = getWorkflowTemplate(serviceType, serviceTier || 'growth');
      setTemplatePreview(template);
    } else {
      setTemplatePreview(null);
    }
  }, [serviceType, serviceTier]);

  const fetchServices = async () => {
    try {
      const res = await fetch('/api/services');
      if (res.ok) {
        const data = await res.json();
        // Transform services data
        const formattedServices = data.services?.map((s: any) => ({
          id: s.id,
          name: s.name,
          type: s.type || 'web-development',
          tier: s.tier,
          amount: s.amount,
        })) || [];
        setServices(formattedServices);
      }
    } catch (error) {
      console.error('Error fetching services:', error);
    } finally {
      setLoadingServices(false);
    }
  };

  const fetchClients = async () => {
    try {
      const res = await fetch('/api/user?role=client');
      if (res.ok) {
        const data = await res.json();
        setClients(data.users || []);
      }
    } catch (error) {
      console.error('Error fetching clients:', error);
    } finally {
      setLoadingClients(false);
    }
  };

  const handleServiceSelect = (serviceId: string) => {
    setSelectedService(serviceId);
    if (serviceId === 'custom') {
      setServiceType('');
      setServiceTier('');
      setServiceAmount('');
      setCustomServiceName('');
    } else {
      const service = services.find(s => s.id === serviceId);
      if (service) {
        setCustomServiceName(service.name);
        setServiceType(service.type);
        setServiceTier(service.tier || 'growth');
        setServiceAmount(service.amount?.toString() || '');
      }
    }
  };

  const handleCreateWorkflow = async () => {
    // Validation
    if (!clientId) {
      toast.error('Please select a client');
      return;
    }
    if (!customServiceName.trim()) {
      toast.error('Please enter a service name');
      return;
    }
    if (!serviceType) {
      toast.error('Please select a service type');
      return;
    }
    if (!serviceAmount || parseFloat(serviceAmount) <= 0) {
      toast.error('Please enter a valid service amount');
      return;
    }

    setLoading(true);

    try {
      // First, create or find workflow template
      const templateRes = await fetch('/api/workflows/templates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          serviceType,
          serviceTier: serviceTier || 'growth',
        }),
      });

      if (!templateRes.ok) {
        throw new Error('Failed to create workflow template');
      }

      const templateData = await templateRes.json();

      // Create workflow instance
      const workflowRes = await fetch('/api/workflows', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          templateId: templateData.template.id,
          userId: clientId,
          serviceName: customServiceName,
          serviceTier: serviceTier || undefined,
          serviceAmount: parseFloat(serviceAmount),
          clientNotes,
        }),
      });

      if (!workflowRes.ok) {
        const error = await workflowRes.json();
        throw new Error(error.error || 'Failed to create workflow');
      }

      const workflowData = await workflowRes.json();

      toast.success('Workflow created successfully!');
      router.push(`/dashboard/workflows/${workflowData.workflow.id}`);
    } catch (error: any) {
      console.error('Error creating workflow:', error);
      toast.error(error.message || 'Failed to create workflow');
    } finally {
      setLoading(false);
    }
  };

  if (status === 'loading') {
    return (
      <div className="container mx-auto p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-1/4"></div>
          <div className="h-64 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-4">
        <Link href="/dashboard/workflows">
          <Button variant="ghost" size="sm">
            <ArrowLeft className="h-4 w-4 mr-2" />
            Back to Workflows
          </Button>
        </Link>
      </div>

      <div>
        <h1 className="text-3xl font-bold">Create New Workflow</h1>
        <p className="text-muted-foreground mt-1">
          Set up a service fulfillment workflow for your client
        </p>
      </div>

      <div className="grid gap-6 lg:grid-cols-2">
        {/* Form Section */}
        <div className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Workflow Details</CardTitle>
              <CardDescription>
                Configure the basic information for this workflow
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              {/* Client Selection */}
              <div className="space-y-2">
                <Label htmlFor="client">Client *</Label>
                <Select value={clientId} onValueChange={setClientId} disabled={loadingClients}>
                  <SelectTrigger>
                    <SelectValue placeholder={loadingClients ? "Loading clients..." : "Select a client"} />
                  </SelectTrigger>
                  <SelectContent>
                    {clients.map((client) => (
                      <SelectItem key={client.id} value={client.id}>
                        {client.name || client.email}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Service Selection */}
              <div className="space-y-2">
                <Label htmlFor="service">Service</Label>
                <Select value={selectedService} onValueChange={handleServiceSelect} disabled={loadingServices}>
                  <SelectTrigger>
                    <SelectValue placeholder={loadingServices ? "Loading services..." : "Select from active services or create custom"} />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="custom">Create Custom Service</SelectItem>
                    <Separator className="my-2" />
                    {services.map((service) => (
                      <SelectItem key={service.id} value={service.id}>
                        {service.name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Service Name */}
              <div className="space-y-2">
                <Label htmlFor="serviceName">Service Name *</Label>
                <Input
                  id="serviceName"
                  value={customServiceName}
                  onChange={(e) => setCustomServiceName(e.target.value)}
                  placeholder="e.g., Website Redesign, SEO Optimization"
                />
              </div>

              {/* Service Type */}
              <div className="space-y-2">
                <Label htmlFor="serviceType">Service Type *</Label>
                <Select value={serviceType} onValueChange={setServiceType}>
                  <SelectTrigger>
                    <SelectValue placeholder="Select service type" />
                  </SelectTrigger>
                  <SelectContent>
                    {Object.keys(WORKFLOW_TEMPLATES).map((type) => (
                      <SelectItem key={type} value={type}>
                        {type.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Service Tier */}
              <div className="space-y-2">
                <Label htmlFor="serviceTier">Service Tier</Label>
                <Select value={serviceTier} onValueChange={setServiceTier}>
                  <SelectTrigger>
                    <SelectValue placeholder="Select tier (optional)" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="starter">Starter</SelectItem>
                    <SelectItem value="growth">Growth</SelectItem>
                    <SelectItem value="premium">Premium</SelectItem>
                    <SelectItem value="enterprise">Enterprise</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* Service Amount */}
              <div className="space-y-2">
                <Label htmlFor="amount">Service Amount ($) *</Label>
                <Input
                  id="amount"
                  type="number"
                  value={serviceAmount}
                  onChange={(e) => setServiceAmount(e.target.value)}
                  placeholder="0.00"
                  min="0"
                  step="0.01"
                />
              </div>

              {/* Client Notes */}
              <div className="space-y-2">
                <Label htmlFor="notes">Client Notes</Label>
                <Textarea
                  id="notes"
                  value={clientNotes}
                  onChange={(e) => setClientNotes(e.target.value)}
                  placeholder="Any special requirements or notes for this workflow..."
                  rows={4}
                />
              </div>
            </CardContent>
          </Card>

          <Button 
            onClick={handleCreateWorkflow} 
            disabled={loading || !clientId || !customServiceName || !serviceType || !serviceAmount}
            className="w-full"
            size="lg"
          >
            {loading ? (
              <>Creating Workflow...</>
            ) : (
              <>
                <CheckCircle2 className="mr-2 h-4 w-4" />
                Create Workflow
              </>
            )}
          </Button>
        </div>

        {/* Template Preview Section */}
        <div className="space-y-6">
          {templatePreview ? (
            <Card>
              <CardHeader>
                <div className="flex items-center justify-between">
                  <div>
                    <CardTitle>Workflow Template Preview</CardTitle>
                    <CardDescription>
                      {templatePreview.name}
                    </CardDescription>
                  </div>
                  <Badge variant="secondary">
                    <Sparkles className="h-3 w-3 mr-1" />
                    AI-Powered
                  </Badge>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                {/* Estimated Info */}
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-1">
                    <div className="flex items-center gap-2 text-sm text-muted-foreground">
                      <Clock className="h-4 w-4" />
                      Duration
                    </div>
                    <div className="text-2xl font-bold">
                      {templatePreview.estimatedDuration} days
                    </div>
                  </div>
                  <div className="space-y-1">
                    <div className="flex items-center gap-2 text-sm text-muted-foreground">
                      <ClipboardList className="h-4 w-4" />
                      Tasks
                    </div>
                    <div className="text-2xl font-bold">
                      {templatePreview.tasks.length}
                    </div>
                  </div>
                </div>

                <Separator />

                {/* Tasks List */}
                <div className="space-y-3">
                  <h4 className="font-semibold text-sm">Workflow Tasks</h4>
                  <div className="space-y-2 max-h-[400px] overflow-y-auto">
                    {templatePreview.tasks.map((task: any, index: number) => (
                      <div 
                        key={index} 
                        className="p-3 border rounded-lg space-y-1 hover:bg-muted/50 transition-colors"
                      >
                        <div className="flex items-start justify-between gap-2">
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                              <span className="text-xs font-medium text-muted-foreground">
                                #{task.order}
                              </span>
                              <h5 className="font-medium text-sm truncate">
                                {task.title}
                              </h5>
                            </div>
                            <p className="text-xs text-muted-foreground mt-1 line-clamp-2">
                              {task.description}
                            </p>
                          </div>
                          <Badge variant="outline" className="text-xs flex-shrink-0">
                            {task.estimatedHours}h
                          </Badge>
                        </div>
                        {task.visibleToClient && (
                          <Badge variant="secondary" className="text-xs">
                            <Users className="h-3 w-3 mr-1" />
                            Client Visible
                          </Badge>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {/* Milestones */}
                {templatePreview.milestones && templatePreview.milestones.length > 0 && (
                  <>
                    <Separator />
                    <div className="space-y-3">
                      <h4 className="font-semibold text-sm">Key Milestones</h4>
                      <div className="space-y-2">
                        {templatePreview.milestones.map((milestone: any, index: number) => (
                          <div key={index} className="flex items-center gap-2">
                            <CheckCircle2 className="h-4 w-4 text-green-600" />
                            <span className="text-sm">{milestone.name}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </>
                )}
              </CardContent>
            </Card>
          ) : (
            <Card>
              <CardContent className="flex flex-col items-center justify-center py-12">
                <ClipboardList className="h-12 w-12 text-muted-foreground mb-4" />
                <p className="text-muted-foreground text-center">
                  Select a service type to preview the workflow template
                </p>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </div>
  );
}


// ==========================================
// File: app/dashboard/workflows/page.tsx
// ==========================================


'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { 
  ClipboardList, 
  Play, 
  Pause, 
  CheckCircle2, 
  XCircle,
  Clock,
  Users,
  ArrowRight
} from 'lucide-react';

interface Workflow {
  id: string;
  serviceName: string;
  serviceTier?: string;
  status: string;
  progress: number;
  createdAt: string;
  startedAt?: string;
  expectedCompletionDate?: string;
  completedAt?: string;
  tasks: any[];
  teamAssignments: any[];
}

export default function WorkflowsPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const [workflows, setWorkflows] = useState<Workflow[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('all');

  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/');
    }
  }, [status, router]);

  useEffect(() => {
    fetchWorkflows();
  }, []);

  const fetchWorkflows = async () => {
    try {
      const res = await fetch('/api/workflows');
      if (res.ok) {
        const data = await res.json();
        setWorkflows(data.workflows || []);
      }
    } catch (error) {
      console.error('Error fetching workflows:', error);
    } finally {
      setLoading(false);
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed':
        return 'bg-green-500';
      case 'in_progress':
        return 'bg-blue-500';
      case 'on_hold':
        return 'bg-yellow-500';
      case 'cancelled':
        return 'bg-red-500';
      default:
        return 'bg-gray-500';
    }
  };

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'completed':
        return <CheckCircle2 className="h-4 w-4" />;
      case 'in_progress':
        return <Play className="h-4 w-4" />;
      case 'on_hold':
        return <Pause className="h-4 w-4" />;
      case 'cancelled':
        return <XCircle className="h-4 w-4" />;
      default:
        return <Clock className="h-4 w-4" />;
    }
  };

  const filteredWorkflows = workflows.filter(w => {
    if (activeTab === 'all') return true;
    return w.status === activeTab;
  });

  const stats = {
    total: workflows.length,
    pending: workflows.filter(w => w.status === 'pending').length,
    in_progress: workflows.filter(w => w.status === 'in_progress').length,
    completed: workflows.filter(w => w.status === 'completed').length,
  };

  if (loading) {
    return (
      <div className="container mx-auto p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-1/4"></div>
          <div className="h-64 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-4 sm:space-y-6">
      <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 sm:gap-4">
        <div className="min-w-0">
          <h1 className="text-2xl sm:text-3xl font-bold">Service Fulfillment Workflows</h1>
          <p className="text-sm sm:text-base text-muted-foreground mt-1">
            Track progress of all service deliveries
          </p>
        </div>
        {/* @ts-ignore */}
        {(session?.user?.role === 'admin' || session?.user?.role === 'employee') && (
          <Link href="/dashboard/workflows/create" className="w-full sm:w-auto">
            <Button className="w-full sm:w-auto">
              <ClipboardList className="mr-2 h-4 w-4" />
              Create Workflow
            </Button>
          </Link>
        )}
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
        <Card>
          <CardHeader className="pb-2 p-4 sm:p-6">
            <CardTitle className="text-xs sm:text-sm font-medium text-muted-foreground truncate">
              Total Workflows
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4 sm:p-6 pt-0">
            <div className="text-xl sm:text-2xl font-bold">{stats.total}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2 p-4 sm:p-6">
            <CardTitle className="text-xs sm:text-sm font-medium text-muted-foreground truncate">
              Pending
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4 sm:p-6 pt-0">
            <div className="text-xl sm:text-2xl font-bold">{stats.pending}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2 p-4 sm:p-6">
            <CardTitle className="text-xs sm:text-sm font-medium text-muted-foreground truncate">
              In Progress
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4 sm:p-6 pt-0">
            <div className="text-xl sm:text-2xl font-bold text-blue-600">{stats.in_progress}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-2 p-4 sm:p-6">
            <CardTitle className="text-xs sm:text-sm font-medium text-muted-foreground truncate">
              Completed
            </CardTitle>
          </CardHeader>
          <CardContent className="p-4 sm:p-6 pt-0">
            <div className="text-xl sm:text-2xl font-bold text-green-600">{stats.completed}</div>
          </CardContent>
        </Card>
      </div>

      {/* Workflows List */}
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="w-full flex-wrap h-auto gap-1">
          <TabsTrigger value="all" className="text-xs sm:text-sm">All</TabsTrigger>
          <TabsTrigger value="pending" className="text-xs sm:text-sm">Pending</TabsTrigger>
          <TabsTrigger value="in_progress" className="text-xs sm:text-sm">In Progress</TabsTrigger>
          <TabsTrigger value="on_hold" className="text-xs sm:text-sm">On Hold</TabsTrigger>
          <TabsTrigger value="completed" className="text-xs sm:text-sm">Completed</TabsTrigger>
        </TabsList>

        <TabsContent value={activeTab} className="space-y-3 sm:space-y-4 mt-4">
          {filteredWorkflows.length === 0 ? (
            <Card>
              <CardContent className="flex flex-col items-center justify-center py-12 px-4">
                <ClipboardList className="h-10 w-10 sm:h-12 sm:w-12 text-muted-foreground mb-4" />
                <p className="text-sm sm:text-base text-muted-foreground">
                  No workflows found
                </p>
              </CardContent>
            </Card>
          ) : (
            filteredWorkflows.map((workflow) => (
              <Card key={workflow.id} className="hover:shadow-lg transition-shadow">
                <CardHeader className="p-4 sm:p-6">
                  <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2 sm:gap-4">
                    <div className="space-y-1 min-w-0 flex-1">
                      <CardTitle className="text-base sm:text-xl break-words">
                        {workflow.serviceName}
                        {workflow.serviceTier && (
                          <span className="text-xs sm:text-sm font-normal text-muted-foreground ml-2">
                            ({workflow.serviceTier})
                          </span>
                        )}
                      </CardTitle>
                      <CardDescription className="text-xs sm:text-sm">
                        Started: {workflow.startedAt 
                          ? new Date(workflow.startedAt).toLocaleDateString()
                          : 'Not started'}
                        {workflow.expectedCompletionDate && (
                          <>
                            <br className="sm:hidden" />
                            <span className="hidden sm:inline"> â€¢ </span>Expected: {new Date(workflow.expectedCompletionDate).toLocaleDateString()}
                          </>
                        )}
                      </CardDescription>
                    </div>
                    <Badge className={`${getStatusColor(workflow.status)} text-white flex items-center gap-1 w-fit flex-shrink-0 text-xs sm:text-sm`}>
                      {getStatusIcon(workflow.status)}
                      <span className="hidden sm:inline">{workflow.status.replace('_', ' ')}</span>
                    </Badge>
                  </div>
                </CardHeader>
                <CardContent className="space-y-3 sm:space-y-4 p-4 sm:p-6 pt-0">
                  {/* Progress Bar */}
                  <div className="space-y-2">
                    <div className="flex justify-between text-xs sm:text-sm">
                      <span className="text-muted-foreground">Progress</span>
                      <span className="font-medium">{workflow.progress}%</span>
                    </div>
                    <Progress value={workflow.progress} className="h-2" />
                  </div>

                  {/* Tasks and Team Info */}
                  <div className="flex flex-col sm:flex-row gap-3 sm:gap-6 text-xs sm:text-sm text-muted-foreground">
                    <div className="flex items-center gap-2">
                      <ClipboardList className="h-3 w-3 sm:h-4 sm:w-4 flex-shrink-0" />
                      <span className="truncate">
                        {workflow.tasks.filter((t: any) => t.status === 'completed').length} / {workflow.tasks.length} tasks
                      </span>
                    </div>
                    <div className="flex items-center gap-2">
                      <Users className="h-3 w-3 sm:h-4 sm:w-4 flex-shrink-0" />
                      <span className="truncate">{workflow.teamAssignments.length} team members</span>
                    </div>
                  </div>

                  {/* Action Button */}
                  <Link href={`/dashboard/workflows/${workflow.id}`} className="block">
                    <Button variant="outline" className="w-full group text-sm">
                      View Details
                      <ArrowRight className="ml-2 h-3 w-3 sm:h-4 sm:w-4 group-hover:translate-x-1 transition-transform" />
                    </Button>
                  </Link>
                </CardContent>
              </Card>
            ))
          )}
        </TabsContent>
      </Tabs>
    </div>
  );
}

// ==========================================
// File: app/dashboard/workflows/[id]/page.tsx
// ==========================================


'use client';

import { useEffect, useState } from 'react';
import { useSession } from 'next-auth/react';
import { useRouter, useParams } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { Separator } from '@/components/ui/separator';
import { 
  CheckCircle2, 
  Circle, 
  Clock, 
  User, 
  Calendar,
  Users,
  ArrowLeft,
  Play,
  Pause
} from 'lucide-react';

export default function WorkflowDetailPage() {
  const { data: session, status } = useSession();
  const router = useRouter();
  const params = useParams();
  const workflowId = params?.id as string;

  const [workflow, setWorkflow] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/');
    }
  }, [status, router]);

  useEffect(() => {
    if (workflowId) {
      fetchWorkflow();
    }
  }, [workflowId]);

  const fetchWorkflow = async () => {
    try {
      const res = await fetch(`/api/workflows/${workflowId}`);
      if (res.ok) {
        const data = await res.json();
        setWorkflow(data.workflow);
      }
    } catch (error) {
      console.error('Error fetching workflow:', error);
    } finally {
      setLoading(false);
    }
  };

  const assignTeam = async () => {
    if (!confirm('Automatically assign team members to this workflow?')) return;

    try {
      const res = await fetch(`/api/workflows/${workflowId}/assign-team`, {
        method: 'POST',
      });

      if (res.ok) {
        alert('Team assigned successfully!');
        fetchWorkflow();
      } else {
        const data = await res.json();
        alert(data.error || 'Failed to assign team');
      }
    } catch (error) {
      console.error('Error assigning team:', error);
      alert('Failed to assign team');
    }
  };

  const updateStatus = async (newStatus: string) => {
    try {
      const res = await fetch(`/api/workflows/${workflowId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus }),
      });

      if (res.ok) {
        fetchWorkflow();
      }
    } catch (error) {
      console.error('Error updating status:', error);
    }
  };

  const getTaskStatusColor = (status: string) => {
    switch (status) {
      case 'completed':
        return 'text-green-600 bg-green-50 border-green-200';
      case 'in_progress':
        return 'text-blue-600 bg-blue-50 border-blue-200';
      case 'assigned':
        return 'text-purple-600 bg-purple-50 border-purple-200';
      case 'blocked':
        return 'text-red-600 bg-red-50 border-red-200';
      default:
        return 'text-gray-600 bg-gray-50 border-gray-200';
    }
  };

  if (loading) {
    return (
      <div className="container mx-auto p-6">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-1/4"></div>
          <div className="h-64 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  if (!workflow) {
    return (
      <div className="container mx-auto p-6">
        <Card>
          <CardContent className="flex flex-col items-center justify-center py-12">
            <p className="text-muted-foreground">Workflow not found</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  const isAdmin = session?.user && 
    // @ts-ignore
    (session.user.role === 'admin' || session.user.role === 'employee');

  return (
    <div className="container mx-auto p-6 space-y-6">
      <Button variant="ghost" onClick={() => router.back()} className="mb-4">
        <ArrowLeft className="mr-2 h-4 w-4" />
        Back
      </Button>

      {/* Workflow Header */}
      <Card>
        <CardHeader>
          <div className="flex justify-between items-start">
            <div className="space-y-2">
              <CardTitle className="text-2xl">
                {workflow.serviceName}
                {workflow.serviceTier && (
                  <span className="text-lg font-normal text-muted-foreground ml-2">
                    ({workflow.serviceTier})
                  </span>
                )}
              </CardTitle>
              <CardDescription>
                Created: {new Date(workflow.createdAt).toLocaleDateString()}
              </CardDescription>
            </div>
            <div className="flex gap-2">
              <Badge variant="outline" className="text-base">
                {workflow.status.replace('_', ' ')}
              </Badge>
            </div>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="space-y-2">
            <div className="flex justify-between text-sm">
              <span className="text-muted-foreground">Overall Progress</span>
              <span className="font-medium">{workflow.progress}%</span>
            </div>
            <Progress value={workflow.progress} className="h-3" />
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4">
            <div className="flex items-center gap-2 text-sm">
              <Calendar className="h-4 w-4 text-muted-foreground" />
              <div>
                <div className="text-muted-foreground">Expected Completion</div>
                <div className="font-medium">
                  {workflow.expectedCompletionDate 
                    ? new Date(workflow.expectedCompletionDate).toLocaleDateString()
                    : 'TBD'}
                </div>
              </div>
            </div>
            <div className="flex items-center gap-2 text-sm">
              <Users className="h-4 w-4 text-muted-foreground" />
              <div>
                <div className="text-muted-foreground">Team Members</div>
                <div className="font-medium">{workflow.teamAssignments.length}</div>
              </div>
            </div>
            <div className="flex items-center gap-2 text-sm">
              <Clock className="h-4 w-4 text-muted-foreground" />
              <div>
                <div className="text-muted-foreground">Tasks</div>
                <div className="font-medium">
                  {workflow.tasks.filter((t: any) => t.status === 'completed').length} / {workflow.tasks.length}
                </div>
              </div>
            </div>
          </div>

          {isAdmin && (
            <div className="flex gap-2 pt-4">
              {workflow.status === 'pending' && !workflow.teamAssigned && (
                <Button onClick={assignTeam}>
                  <Users className="mr-2 h-4 w-4" />
                  Auto-Assign Team
                </Button>
              )}
              {workflow.status === 'pending' && workflow.teamAssigned && (
                <Button onClick={() => updateStatus('in_progress')}>
                  <Play className="mr-2 h-4 w-4" />
                  Start Workflow
                </Button>
              )}
              {workflow.status === 'in_progress' && (
                <Button variant="outline" onClick={() => updateStatus('on_hold')}>
                  <Pause className="mr-2 h-4 w-4" />
                  Put On Hold
                </Button>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Team Assignments */}
      {workflow.teamAssignments.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Team Members</CardTitle>
            <CardDescription>Assigned team for this project</CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {workflow.teamAssignments.map((assignment: any) => (
                <div key={assignment.id} className="flex items-center justify-between p-3 border rounded-lg">
                  <div className="flex items-center gap-3">
                    <User className="h-8 w-8 text-muted-foreground" />
                    <div>
                      <div className="font-medium">
                        {assignment.employee.user.name || assignment.employee.user.email}
                      </div>
                      <div className="text-sm text-muted-foreground capitalize">
                        {assignment.role}
                      </div>
                    </div>
                  </div>
                  <div className="text-right text-sm">
                    <div className="text-muted-foreground">Hours</div>
                    <div className="font-medium">
                      {assignment.actualHours} / {assignment.allocatedHours}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Tasks Timeline */}
      <Card>
        <CardHeader>
          <CardTitle>Tasks</CardTitle>
          <CardDescription>Project milestones and deliverables</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {workflow.tasks.map((task: any, index: number) => (
              <div key={task.id}>
                <div className={`p-4 border rounded-lg ${getTaskStatusColor(task.status)}`}>
                  <div className="flex items-start gap-3">
                    <div className="mt-1">
                      {task.status === 'completed' ? (
                        <CheckCircle2 className="h-5 w-5" />
                      ) : (
                        <Circle className="h-5 w-5" />
                      )}
                    </div>
                    <div className="flex-1">
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <div className="font-medium">{task.title}</div>
                          {task.description && (
                            <div className="text-sm mt-1 opacity-80">
                              {task.description}
                            </div>
                          )}
                        </div>
                        <Badge variant="outline" className="ml-4">
                          {task.status.replace('_', ' ')}
                        </Badge>
                      </div>

                      <div className="flex flex-wrap gap-4 text-sm mt-3">
                        {task.assignedTo && (
                          <div className="flex items-center gap-1">
                            <User className="h-3 w-3" />
                            {task.assignedTo.user.name || task.assignedTo.user.email}
                          </div>
                        )}
                        {task.estimatedHours && (
                          <div className="flex items-center gap-1">
                            <Clock className="h-3 w-3" />
                            {task.estimatedHours}h estimated
                          </div>
                        )}
                        {task.dueDate && (
                          <div className="flex items-center gap-1">
                            <Calendar className="h-3 w-3" />
                            Due: {new Date(task.dueDate).toLocaleDateString()}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
                {index < workflow.tasks.length - 1 && (
                  <div className="h-4 w-0.5 bg-gray-200 ml-6"></div>
                )}
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Client Notes */}
      {workflow.clientNotes && (
        <Card>
          <CardHeader>
            <CardTitle>Client Notes</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm">{workflow.clientNotes}</p>
          </CardContent>
        </Card>
      )}
    </div>
  );
}

// ==========================================
// File: app/free-3-minute-marketing-assessment-get-a-custom-growth-plan/page.tsx
// ==========================================

import { permanentRedirect } from 'next/navigation';

export default function MarketingAssessmentRedirect() {
  permanentRedirect('/marketing-assessment');
}

// ==========================================
// File: app/gallery/ai-agents/page.tsx
// ==========================================


import { prisma } from "@/lib/db";
import { AgentGalleryClient } from "@/components/gallery/agent-gallery-client";

export const metadata = {
  title: "AI Agent Gallery | CDM Suite",
  description: "Explore AI agents built with CDM Suite AI Agent Builder",
};

export default async function AgentGalleryPage() {
  try {
    const agents = await prisma.aIAgent.findMany({
      where: {
        isPublic: true,
        status: "active",
      },
      orderBy: [
        { galleryOrder: "asc" },
        { galleryViews: "desc" },
      ],
      select: {
        id: true,
        name: true,
        slug: true,
        galleryTitle: true,
        galleryDescription: true,
        galleryThumbnail: true,
        galleryCategory: true,
        galleryTags: true,
        agentType: true,
        totalConversations: true,
        totalLeadsCaptured: true,
        satisfactionRating: true,
      },
      take: 50,
    });

    return <AgentGalleryClient agents={agents} />;
  } catch (error) {
    console.error('Error fetching AI agent gallery:', error);
    // During local builds or when the database is unavailable, render an empty gallery
    return <AgentGalleryClient agents={[]} />;
  }
}

// ==========================================
// File: app/gallery/websites/page.tsx
// ==========================================


import { prisma } from "@/lib/db";
import { WebsiteGalleryClient } from "@/components/gallery/website-gallery-client";

export const metadata = {
  title: "Website Gallery | CDM Suite",
  description: "Explore websites built with CDM Suite AI Website Builder",
};

export default async function WebsiteGalleryPage() {
  try {
    const websites = await prisma.websiteGallery.findMany({
      where: {
        status: "published",
        isPublic: true,
      },
      orderBy: [
        { isFeatured: "desc" },
        { sortOrder: "asc" },
        { views: "desc" },
      ],
      take: 50,
    });

    return <WebsiteGalleryClient websites={websites} />;
  } catch (error) {
    console.error('Error fetching website gallery:', error);
    // During local builds or when the database is unavailable, render an empty gallery
    return <WebsiteGalleryClient websites={[]} />;
  }
}

// ==========================================
// File: app/globals.css
// ==========================================


@tailwind base;
@tailwind components;
@tailwind utilities;

/* Mobile Optimization - Prevent Oversized Elements */
@layer base {
  html {
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
  }
  
  @media (max-width: 640px) {
    * {
      max-width: 100vw;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    
    body {
      font-size: 16px;
      line-height: 1.5;
    }
    
    h1 {
      font-size: 1.75rem !important;
      line-height: 1.2 !important;
    }
    
    h2 {
      font-size: 1.5rem !important;
      line-height: 1.3 !important;
    }
    
    h3 {
      font-size: 1.25rem !important;
      line-height: 1.3 !important;
    }
    
    .section-container {
      padding-left: 1rem;
      padding-right: 1rem;
    }
  }
}

/* Blog Post Formatting */
.prose {
  @apply text-foreground;
}

.prose h1:first-child {
  @apply mt-0;
}

.prose ul > li::marker {
  @apply text-primary;
}

.prose ol > li::marker {
  @apply text-primary font-semibold;
}

.prose a {
  @apply transition-colors duration-200;
}

.prose img {
  @apply mx-auto;
}

.prose blockquote p:first-of-type::before {
  content: none;
}

.prose blockquote p:last-of-type::after {
  content: none;
}

/* Better code block styling */
.prose pre {
  @apply shadow-sm;
}

.prose pre code {
  @apply bg-transparent text-sm;
}

/* Numbered list improvements */
.prose ol > li {
  @apply pl-2;
}

.prose ul > li {
  @apply pl-2;
}

/* Nested lists */
.prose ul ul,
.prose ol ul,
.prose ul ol,
.prose ol ol {
  @apply my-2;
}

/* Table improvements */
.prose table {
  @apply w-full shadow-sm rounded-lg overflow-hidden;
}

.prose thead {
  @apply bg-muted/70;
}

.prose tbody tr:hover {
  @apply bg-muted/30 transition-colors;
}

/* Link improvements */
.prose a[href^="http"]::after {
  content: " â†—";
  @apply text-xs align-super opacity-60;
}

.prose a[href^="#"]::after {
  content: none;
}

/* Footnotes */
.prose sup a {
  @apply text-primary no-underline;
}

.prose sup a::after {
  content: none;
}

/* Better spacing for consecutive elements */
.prose h2 + h3,
.prose h3 + h4 {
  @apply mt-4;
}

.prose > * + * {
  @apply mt-4;
}

/* Enhanced Blog Formatting Classes */
.prose .section-break {
  @apply h-8;
}

.prose .feature-list {
  @apply space-y-3 my-6;
}

.prose .feature-list li {
  @apply relative pl-8;
}

.prose .feature-list li::before {
  content: "âœ“";
  @apply absolute left-0 text-primary font-bold text-lg;
}

.prose .numbered-list {
  @apply space-y-3 my-6;
}

.prose .numbered-list li {
  @apply pl-4;
}

.prose .highlight {
  @apply text-primary;
}

.prose .inline-link {
  @apply text-primary hover:text-primary/80 underline decoration-2 decoration-primary/30 hover:decoration-primary/60 transition-all;
}

.prose .callout {
  @apply my-6 p-4 rounded-lg border-l-4;
}

.prose .callout-info {
  @apply bg-blue-50 dark:bg-blue-950/20 border-blue-500;
}

.prose .callout-info strong {
  @apply text-blue-700 dark:text-blue-400;
}

.prose .citation {
  @apply text-primary no-underline;
}

.prose .citation a {
  @apply no-underline hover:underline;
}

.prose .lead-paragraph {
  @apply text-lg text-muted-foreground italic border-l-4 border-primary/30 pl-4 my-6;
}

.prose .blog-section {
  @apply mb-12;
}

.prose .code-block {
  @apply font-mono text-sm;
}

/* Enhanced list styling */
.prose ul li::marker {
  content: none;
}

/* Better image captions */
.prose figure {
  @apply my-8;
}

.prose figcaption {
  @apply text-center text-sm text-muted-foreground mt-2 italic;
}

/* Enhanced emphasis */
.prose em {
  @apply not-italic text-primary/90 font-medium;
}

/* Better hr styling */
.prose hr {
  @apply my-12 border-t-2 border-primary/20;
}

/* Quote styling improvements */
.prose blockquote {
  @apply not-italic font-normal;
}

.prose blockquote p {
  @apply text-lg leading-relaxed;
}

/* Responsive images */
.prose img {
  @apply w-full h-auto;
}

/* Definition lists */
.prose dl {
  @apply my-6;
}

.prose dt {
  @apply font-bold text-foreground mt-4;
}

.prose dd {
  @apply ml-6 text-muted-foreground;
}

@layer base {
  :root {
    /* Modern Tech & Trust Color Scheme */
    --background: 0 0% 100%;
    --foreground: 220 27% 8%; /* Charcoal #111827 */
    --card: 0 0% 100%;
    --card-foreground: 220 27% 8%;
    --popover: 0 0% 100%;
    --popover-foreground: 220 27% 8%;
    --primary: 219 78% 33%; /* Royal Blue #1E3A8A */
    --primary-foreground: 0 0% 100%;
    --secondary: 187 96% 43%; /* Electric Cyan #06B6D4 */
    --secondary-foreground: 0 0% 100%;
    --muted: 210 20% 96%; /* Cool Gray #F3F4F6 */
    --muted-foreground: 215 16% 47%;
    --accent: 84 81% 56%; /* Bright Lime #A3E635 */
    --accent-foreground: 220 27% 8%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 100%;
    --border: 214 32% 91%;
    --input: 214 32% 91%;
    --ring: 219 78% 33%;
    --radius: 0.5rem;
  }

  .dark {
    --background: 220 27% 8%; /* Charcoal #111827 */
    --foreground: 210 20% 96%;
    --card: 220 27% 8%;
    --card-foreground: 210 20% 96%;
    --popover: 220 27% 8%;
    --popover-foreground: 210 20% 96%;
    --primary: 219 78% 45%; /* Lighter Royal Blue for dark mode */
    --primary-foreground: 0 0% 100%;
    --secondary: 187 96% 43%; /* Electric Cyan */
    --secondary-foreground: 0 0% 100%;
    --muted: 220 27% 15%;
    --muted-foreground: 215 16% 65%;
    --accent: 84 81% 56%; /* Bright Lime */
    --accent-foreground: 220 27% 8%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 210 20% 96%;
    --border: 220 27% 20%;
    --input: 220 27% 20%;
    --ring: 219 78% 45%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
    font-feature-settings: "rlig" 1, "calt" 1;
  }
}

@layer utilities {
  .section-container {
    @apply container mx-auto px-4 sm:px-6 lg:px-8;
  }

  .btn-primary {
    @apply bg-primary text-primary-foreground hover:bg-primary/90 transition-all duration-300 shadow-lg hover:shadow-xl;
  }
  
  .fade-in {
    animation: fadeIn 0.5s ease-in-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
}

/* Smooth scrolling */
html {
  scroll-behavior: smooth;
}

/* Custom scrollbar styling */
::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: hsl(var(--primary));
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: hsl(var(--primary) / 0.8);
}

/* CRO-focused animations */
@keyframes pulse-subtle {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.9;
  }
}

.pulse-subtle {
  animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* Breathing button animation - organic feel */
@keyframes breathe {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  }
  50% {
    transform: scale(1.05);
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.15), 0 4px 6px -4px rgb(0 0 0 / 0.15);
  }
}

.btn-breathe {
  animation: breathe 2.5s ease-in-out infinite;
}

.btn-breathe:hover {
  animation: none;
}

/* Gradient shift animation for more organic feel */
@keyframes gradientShift {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

.bg-gradient-animate {
  background-size: 200% 200%;
  animation: gradientShift 4s ease infinite;
}

/* Floating animation for icons */
@keyframes float {
  0%, 100% {
    transform: translateY(0px);
  }
  50% {
    transform: translateY(-10px);
  }
}

.float-animation {
  animation: float 3s ease-in-out infinite;
}

/* Subtle glow effect */
@keyframes glow {
  0%, 100% {
    box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
  }
  50% {
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 30px rgba(147, 51, 234, 0.6);
  }
}

.btn-glow {
  animation: glow 2s ease-in-out infinite;
}

/* Custom Scrollbar Styles */
.scrollbar-thin {
  scrollbar-width: thin;
  scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
}

.scrollbar-thin::-webkit-scrollbar {
  width: 4px;
  height: 4px;
}

.scrollbar-thin::-webkit-scrollbar-track {
  background: transparent;
}

.scrollbar-thin::-webkit-scrollbar-thumb {
  background-color: rgba(59, 130, 246, 0.3);
  border-radius: 10px;
}

.scrollbar-thin::-webkit-scrollbar-thumb:hover {
  background-color: rgba(59, 130, 246, 0.5);
}

/* Touch targets for mobile accessibility - minimum 44x44px */
.touch-target {
  min-height: 44px;
  min-width: 44px;
}

/* Improve touch responsiveness on mobile */
@media (max-width: 640px) {
  button:not(.icon-only), 
  a:not(.icon-only) {
    min-height: 44px;
  }
  
  input, 
  select, 
  textarea {
    min-height: 44px;
    font-size: 16px; /* Prevents iOS zoom on focus */
  }
  
  /* Ensure sliders are easy to interact with on touch devices */
  input[type="range"] {
    min-height: 44px;
    -webkit-appearance: none;
    appearance: none;
  }
  
  input[type="range"]::-webkit-slider-thumb {
    width: 24px;
    height: 24px;
  }
  
  input[type="range"]::-moz-range-thumb {
    width: 24px;
    height: 24px;
  }
}

/* React Quill WYSIWYG Editor Customization */
.ql-toolbar.ql-snow {
  border: 1px solid hsl(var(--border));
  border-bottom: none;
  border-radius: 0.5rem 0.5rem 0 0;
  background: hsl(var(--muted) / 0.3);
}

.ql-container.ql-snow {
  border: 1px solid hsl(var(--border));
  border-radius: 0 0 0.5rem 0.5rem;
  font-family: inherit;
}

.ql-editor {
  min-height: 300px;
  font-size: 15px;
  line-height: 1.6;
  color: hsl(var(--foreground));
}

.ql-editor.ql-blank::before {
  color: hsl(var(--muted-foreground));
  font-style: normal;
}

.ql-editor p {
  margin-bottom: 1em;
}

.ql-editor strong {
  font-weight: 600;
}

.ql-snow .ql-stroke {
  stroke: hsl(var(--foreground));
}

.ql-snow .ql-fill {
  fill: hsl(var(--foreground));
}

.ql-snow .ql-picker-label {
  color: hsl(var(--foreground));
}

/* Dark mode adjustments */
.dark .ql-toolbar.ql-snow {
  background: hsl(var(--muted) / 0.2);
}

.dark .ql-editor {
  background: hsl(var(--background));
  color: hsl(var(--foreground));
}

// ==========================================
// File: app/layout.tsx
// ==========================================


import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { Toaster } from 'react-hot-toast';
import { MarketingAutomation } from '@/components/marketing-automation';
import { Providers } from '@/components/providers';
import ClarityInit from '@/components/analytics/clarity-init';
import RedditPixel from '@/components/analytics/reddit-pixel';
import { PostHogProvider } from '@/components/analytics/posthog-provider';
import { PostHogPageView } from '@/components/analytics/posthog-pageview';
import GoogleAnalytics from '@/components/analytics/google-analytics';
import { Suspense } from 'react';

export const dynamic = 'force-dynamic';
export const runtime = 'edge';

const inter = Inter({ subsets: ["latin"] });

// Base URL for metadata (resolves social OG/Twitter image URLs)
const BASE_URL = process.env.NEXT_PUBLIC_SITE_URL || 'https://cdmsuite.com';

export const metadata: Metadata = {
  metadataBase: new URL(BASE_URL),
  title: "CDM Suite - Full Service Digital Marketing Agency",
  description: "Data-driven digital marketing strategies that deliver measurable results. Web design, digital advertising, mobile apps, and AI implementation services.",
  icons: {
    icon: [
      { url: '/favicon.svg', type: 'image/svg+xml' },
    ],
    apple: [
      { url: '/favicon.svg', type: 'image/svg+xml' },
    ],
  },
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const gaId = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID || '';

  return (
    <html lang="en">
      <body className={inter.className}>
        <PostHogProvider>
          <Providers>
            <Suspense fallback={null}>
              <PostHogPageView />
            </Suspense>
            <GoogleAnalytics gaId={gaId} />
            <ClarityInit />
            <RedditPixel />
            {children}
            <Toaster position="top-right" />
            <MarketingAutomation />
          </Providers>
        </PostHogProvider>
      </body>
    </html>
  );
}

// ==========================================
// File: app/marketing-assessment/page.tsx
// ==========================================


import { Metadata } from 'next';
import Navigation from '@/components/navigation';
import Footer from '@/components/footer';
import { MarketingAssessmentClient } from '@/components/marketing-assessment-client';

export const metadata: Metadata = {
  title: '3-Minute Marketing Assessment | CDM Suite',
  description: 'Get a personalized marketing strategy analysis in just 3 minutes. Discover what\'s working, what\'s not, and how to grow your business faster.',
};

export default function MarketingAssessmentPage() {
  return (
    <main>
      <Navigation />
      <div className="min-h-screen bg-gradient-to-b from-background to-muted/20">
        <MarketingAssessmentClient />
      </div>
      <Footer />
    </main>
  );
}

// ==========================================
// File: app/not-found.tsx
// ==========================================


'use client';

import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Home, ArrowLeft, Search, FileQuestion } from 'lucide-react';
import Navigation from '@/components/navigation';
import Footer from '@/components/footer';

export default function NotFound() {
  return (
    <main>
      <Navigation />
      <div className="min-h-screen bg-gradient-to-b from-background to-muted/20 flex items-center justify-center px-4">
        <div className="max-w-2xl mx-auto text-center">
          {/* 404 Animation/Icon */}
          <div className="mb-8 relative">
            <div className="text-9xl font-bold text-primary/10 select-none">
              404
            </div>
            <div className="absolute inset-0 flex items-center justify-center">
              <FileQuestion className="h-24 w-24 text-primary animate-bounce" />
            </div>
          </div>

          {/* Error Message */}
          <h1 className="text-4xl md:text-5xl font-bold mb-4">
            Page Not Found
          </h1>
          <p className="text-xl text-muted-foreground mb-8">
            Oops! The page you&apos;re looking for seems to have wandered off. It might have been moved, deleted, or perhaps it never existed.
          </p>

          {/* Helpful Suggestions */}
          <div className="bg-muted/50 rounded-lg p-6 mb-8 text-left">
            <h2 className="text-lg font-semibold mb-3">Here&apos;s what you can do:</h2>
            <ul className="space-y-2 text-muted-foreground">
              <li className="flex items-start gap-2">
                <span className="text-primary mt-1">â€¢</span>
                <span>Double-check the URL for typos or errors</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary mt-1">â€¢</span>
                <span>Use the navigation menu to find what you need</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary mt-1">â€¢</span>
                <span>Return to our homepage and start fresh</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary mt-1">â€¢</span>
                <span>Contact us if you believe this is an error</span>
              </li>
            </ul>
          </div>

          {/* Action Buttons */}
          <div className="flex flex-col sm:flex-row gap-4 justify-center">
            <Button size="lg" asChild>
              <Link href="/">
                <Home className="mr-2 h-5 w-5" />
                Go to Homepage
              </Link>
            </Button>
            <Button size="lg" variant="outline" onClick={() => window.history.back()}>
              <ArrowLeft className="mr-2 h-5 w-5" />
              Go Back
            </Button>
            <Button size="lg" variant="outline" asChild>
              <Link href="/contact">
                <Search className="mr-2 h-5 w-5" />
                Contact Us
              </Link>
            </Button>
          </div>

          {/* Popular Links */}
          <div className="mt-12 pt-8 border-t">
            <h3 className="text-sm font-semibold text-muted-foreground mb-4">
              POPULAR PAGES
            </h3>
            <div className="flex flex-wrap gap-3 justify-center">
              <Link href="/services" className="text-sm text-primary hover:underline">
                Our Services
              </Link>
              <Link href="/blog" className="text-sm text-primary hover:underline">
                Blog
              </Link>
              <Link href="/case-studies" className="text-sm text-primary hover:underline">
                Case Studies
              </Link>
              <Link href="/about" className="text-sm text-primary hover:underline">
                About Us
              </Link>
              <Link href="/pricing" className="text-sm text-primary hover:underline">
                Pricing
              </Link>
              <Link href="/marketing-assessment" className="text-sm text-primary hover:underline">
                Free Assessment
              </Link>
            </div>
          </div>
        </div>
      </div>
      <Footer />
    </main>
  );
}

// ==========================================
// File: app/page.tsx
// ==========================================


import Navigation from "@/components/navigation";
import HeroSection from "@/components/hero-section";
import MiniOffer from "@/components/mini-offer";
import TrustIndicators from "@/components/trust-indicators";
import ServicesSection from "@/components/services-section";
import ClientSuccessStories from "@/components/client-success-stories";
import ROICalculator from "@/components/roi-calculator";
import ToolsSection from "@/components/tools-section";
import ProcessSection from "@/components/process-section";
import FAQSection from "@/components/faq-section";
import Footer from "@/components/footer";

export default function HomePage() {
  return (
    <main>
      <Navigation />
      <HeroSection />
      <MiniOffer />
      <TrustIndicators />
      <ServicesSection />
      <ClientSuccessStories />
      <ROICalculator />
      <ToolsSection />
      <ProcessSection />
      <FAQSection />
      <Footer />
    </main>
  );
}

// ==========================================
// File: app/pricing/page.tsx
// ==========================================


import { redirect } from "next/navigation";

export const metadata = {
  title: "Services & Pricing | CDM Suite",
  description: "Explore our complete digital marketing services including website maintenance, SEO, social media management, and more.",
};

export default function PricingPage() {
  redirect('/services');
}

// ==========================================
// File: app/privacy/page.tsx
// ==========================================


import { Metadata } from "next";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";
import { Shield, Lock, Eye, Database, Bell } from "lucide-react";

export const metadata: Metadata = {
  title: "Privacy Policy | CDM Suite",
  description: "Read CDM Suite's Privacy Policy and learn how we protect your data",
};

export default function PrivacyPage() {
  return (
    <>
      <Navigation />
      <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
        <div className="section-container py-20">
          <div className="max-w-4xl mx-auto">
            {/* Header */}
            <div className="text-center mb-12">
              <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-secondary to-accent rounded-2xl mb-6">
                <Shield className="w-8 h-8 text-white" />
              </div>
              <h1 className="text-4xl lg:text-5xl font-bold text-gray-900 mb-4">
                Privacy Policy
              </h1>
              <p className="text-lg text-gray-600">
                Last updated: October 13, 2025
              </p>
            </div>

            {/* Content */}
            <div className="bg-white rounded-2xl shadow-xl p-8 lg:p-12 space-y-8">
              <section>
                <div className="flex items-start gap-4 mb-4">
                  <div className="flex-shrink-0">
                    <div className="w-12 h-12 bg-gradient-to-br from-secondary to-accent rounded-xl flex items-center justify-center">
                      <Eye className="w-6 h-6 text-white" />
                    </div>
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">
                      1. Information We Collect
                    </h2>
                    <p className="text-gray-600 leading-relaxed">
                      We collect information that you provide directly to us, including:
                    </p>
                  </div>
                </div>
                <ul className="list-disc list-inside space-y-2 text-gray-600 ml-16">
                  <li>Name, email address, phone number, and company information</li>
                  <li>Account credentials and profile information</li>
                  <li>Payment and billing information</li>
                  <li>Communications with us, including support inquiries</li>
                  <li>Marketing preferences and survey responses</li>
                  <li>Website analytics and usage data</li>
                </ul>
              </section>

              <section>
                <div className="flex items-start gap-4 mb-4">
                  <div className="flex-shrink-0">
                    <div className="w-12 h-12 bg-gradient-to-br from-secondary to-accent rounded-xl flex items-center justify-center">
                      <Database className="w-6 h-6 text-white" />
                    </div>
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">
                      2. How We Use Your Information
                    </h2>
                    <p className="text-gray-600 leading-relaxed">
                      We use the information we collect to:
                    </p>
                  </div>
                </div>
                <ul className="list-disc list-inside space-y-2 text-gray-600 ml-16">
                  <li>Provide, maintain, and improve our services</li>
                  <li>Process your transactions and send related information</li>
                  <li>Send you technical notices, updates, and support messages</li>
                  <li>Respond to your comments, questions, and requests</li>
                  <li>Send you marketing communications (with your consent)</li>
                  <li>Monitor and analyze trends, usage, and activities</li>
                  <li>Detect, prevent, and address technical issues and fraud</li>
                  <li>Personalize your experience and deliver relevant content</li>
                </ul>
              </section>

              <section>
                <div className="flex items-start gap-4 mb-4">
                  <div className="flex-shrink-0">
                    <div className="w-12 h-12 bg-gradient-to-br from-secondary to-accent rounded-xl flex items-center justify-center">
                      <Lock className="w-6 h-6 text-white" />
                    </div>
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">
                      3. Information Sharing
                    </h2>
                    <p className="text-gray-600 leading-relaxed mb-4">
                      We may share your information in the following situations:
                    </p>
                  </div>
                </div>
                <ul className="list-disc list-inside space-y-2 text-gray-600 ml-16">
                  <li>With service providers who perform services on our behalf</li>
                  <li>With analytics partners to improve our services</li>
                  <li>When required by law or to protect our rights</li>
                  <li>In connection with a merger, sale, or acquisition</li>
                  <li>With your consent or at your direction</li>
                </ul>
                <p className="text-gray-600 leading-relaxed mt-4 ml-16">
                  We do not sell your personal information to third parties.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  4. Data Security
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  We implement appropriate technical and organizational measures to protect your personal information 
                  against unauthorized access, alteration, disclosure, or destruction. This includes:
                </p>
                <ul className="list-disc list-inside space-y-2 text-gray-600 ml-4 mt-4">
                  <li>Encryption of data in transit and at rest</li>
                  <li>Regular security assessments and updates</li>
                  <li>Access controls and authentication requirements</li>
                  <li>Employee training on data protection</li>
                  <li>Secure payment processing through trusted providers</li>
                </ul>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  5. Cookies and Tracking Technologies
                </h2>
                <p className="text-gray-600 leading-relaxed mb-4">
                  We use cookies and similar tracking technologies to:
                </p>
                <ul className="list-disc list-inside space-y-2 text-gray-600 ml-4">
                  <li>Remember your preferences and settings</li>
                  <li>Understand how you use our services</li>
                  <li>Improve our website performance</li>
                  <li>Deliver personalized content and advertisements</li>
                </ul>
                <p className="text-gray-600 leading-relaxed mt-4">
                  You can control cookies through your browser settings. However, disabling cookies may limit your 
                  ability to use certain features of our services.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  6. Your Privacy Rights
                </h2>
                <p className="text-gray-600 leading-relaxed mb-4">
                  Depending on your location, you may have the following rights:
                </p>
                <ul className="list-disc list-inside space-y-2 text-gray-600 ml-4">
                  <li>Access and receive a copy of your personal information</li>
                  <li>Correct inaccurate or incomplete information</li>
                  <li>Request deletion of your personal information</li>
                  <li>Object to or restrict certain processing activities</li>
                  <li>Data portability (receive your data in a usable format)</li>
                  <li>Withdraw consent at any time</li>
                  <li>Opt-out of marketing communications</li>
                </ul>
                <p className="text-gray-600 leading-relaxed mt-4">
                  To exercise these rights, please contact us using the information provided below.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  7. Data Retention
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  We retain your personal information for as long as necessary to fulfill the purposes outlined in 
                  this Privacy Policy, unless a longer retention period is required or permitted by law. When we no 
                  longer need your information, we will securely delete or anonymize it.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  8. Children's Privacy
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  Our services are not directed to individuals under the age of 18. We do not knowingly collect 
                  personal information from children. If you believe we have collected information from a child, 
                  please contact us immediately.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  9. International Data Transfers
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  Your information may be transferred to and processed in countries other than your own. We ensure 
                  appropriate safeguards are in place to protect your information in accordance with this Privacy 
                  Policy and applicable law.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  10. Changes to This Policy
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  We may update this Privacy Policy from time to time. We will notify you of any material changes by 
                  posting the new policy on this page and updating the "Last updated" date. We encourage you to 
                  review this policy periodically.
                </p>
              </section>

              <section>
                <div className="flex items-start gap-4">
                  <div className="flex-shrink-0">
                    <div className="w-12 h-12 bg-gradient-to-br from-secondary to-accent rounded-xl flex items-center justify-center">
                      <Bell className="w-6 h-6 text-white" />
                    </div>
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold text-gray-900 mb-4">
                      11. Contact Us
                    </h2>
                    <p className="text-gray-600 leading-relaxed mb-4">
                      If you have any questions, concerns, or requests regarding this Privacy Policy or our data 
                      practices, please contact us:
                    </p>
                    <div className="p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
                      <p className="text-gray-700 font-medium mb-2">CDM Suite</p>
                      <p className="text-gray-600">Phone: (862) 272-7623</p>
                      <p className="text-gray-600">Email: privacy@cdmsuite.com</p>
                      <p className="text-gray-600 mt-3 text-sm">
                        Response time: We aim to respond to all privacy inquiries within 48 hours
                      </p>
                    </div>
                  </div>
                </div>
              </section>
            </div>
          </div>
        </div>
      </div>
      <Footer />
    </>
  );
}

// ==========================================
// File: app/proposal-success/page.tsx
// ==========================================


'use client';

import { useEffect, useState, Suspense } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { CheckCircle2, ArrowRight, Home } from 'lucide-react';
import Link from 'next/link';

function ProposalSuccessContent() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const proposalId = searchParams?.get('proposal');
  const [countdown, setCountdown] = useState(10);

  useEffect(() => {
    if (countdown > 0) {
      const timer = setTimeout(() => setCountdown(countdown - 1), 1000);
      return () => clearTimeout(timer);
    } else {
      router.push('/');
    }
  }, [countdown, router]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 flex items-center justify-center p-4">
      <Card className="max-w-2xl w-full">
        <CardHeader className="text-center">
          <div className="flex justify-center mb-4">
            <div className="rounded-full bg-green-100 p-3">
              <CheckCircle2 className="h-16 w-16 text-green-600" />
            </div>
          </div>
          <CardTitle className="text-3xl font-bold text-gray-900">
            Payment Successful! ðŸŽ‰
          </CardTitle>
          <CardDescription className="text-lg">
            Thank you for your payment. Your proposal has been marked as paid.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 className="font-semibold text-blue-900 mb-2">What happens next?</h3>
            <ul className="space-y-2 text-blue-800">
              <li className="flex items-start gap-2">
                <CheckCircle2 className="h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5" />
                <span>Our team has been notified and will begin work immediately</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5" />
                <span>You'll receive a confirmation email with project details</span>
              </li>
              <li className="flex items-start gap-2">
                <CheckCircle2 className="h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5" />
                <span>Your dedicated account manager will contact you within 24 hours</span>
              </li>
            </ul>
          </div>

          <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
            <p className="text-sm text-gray-600 mb-2">
              Questions? Contact us at
            </p>
            <div className="flex flex-col sm:flex-row items-center justify-center gap-3">
              <a
                href="tel:8622727623"
                className="text-blue-600 hover:text-blue-700 font-medium"
              >
                (862) 272-7623
              </a>
              <span className="hidden sm:inline text-gray-400">â€¢</span>
              <a
                href="mailto:info@cdmsuite.com"
                className="text-blue-600 hover:text-blue-700 font-medium"
              >
                info@cdmsuite.com
              </a>
            </div>
          </div>

          <div className="text-center space-y-4">
            <p className="text-sm text-gray-500">
              Redirecting to homepage in {countdown} seconds...
            </p>
            <div className="flex justify-center gap-3">
              <Link href="/">
                <Button>
                  <Home className="h-4 w-4 mr-2" />
                  Go to Homepage
                </Button>
              </Link>
              <Link href="/contact">
                <Button variant="outline">
                  Contact Support
                  <ArrowRight className="h-4 w-4 ml-2" />
                </Button>
              </Link>
            </div>
          </div>

          {proposalId && (
            <p className="text-xs text-center text-gray-400">
              Proposal ID: {proposalId}
            </p>
          )}
        </CardContent>
      </Card>
    </div>
  );
}

export default function ProposalSuccessPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600" />
      </div>
    }>
      <ProposalSuccessContent />
    </Suspense>
  );
}

// ==========================================
// File: app/services/ad-management/page.tsx
// ==========================================


"use client";

import { useState } from "react";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";
import CalendlyScheduler from "@/components/calendly-scheduler";
import { ServiceCTAButtons } from "@/components/service-cta-buttons";
import { StickyCTAButton } from "@/components/sticky-cta-button";
import { Button } from "@/components/ui/button";
import { CheckCircle, TrendingUp, Target, BarChart3, Zap } from "lucide-react";
import Image from "next/image";
import { AD_MANAGEMENT_TIERS } from "@/lib/pricing-tiers";

export default function AdManagementPage() {
  const [showScheduler, setShowScheduler] = useState(false);

  const handleScheduleClick = () => {
    setShowScheduler(true);
    // Scroll to the CTA section smoothly
    setTimeout(() => {
      document.getElementById('ctaSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  };

  return (
    <>
      <Navigation />
      <StickyCTAButton 
        onScheduleClick={handleScheduleClick}
        serviceName="Ad Management"
      />
      
      {/* Hero Section with Header Image */}
      <div className="relative bg-gray-900 overflow-hidden">
        <div className="absolute inset-0">
          <div className="relative w-full h-full">
            <Image
              src="https://cdn.abacus.ai/images/c5dbf003-c21d-46d9-bde2-ea94af97ab30.png"
              alt="Team collaborating on ad campaigns"
              fill
              className="object-cover object-center"
              priority
            />
            <div className="absolute inset-0 bg-gradient-to-b from-gray-900/70 via-gray-900/60 to-gray-900/80"></div>
          </div>
        </div>
        
        <div className="relative container mx-auto px-4 py-24 md:py-32 z-10">
          <header className="text-center max-w-3xl mx-auto">
            <div className="inline-block bg-primary/20 backdrop-blur-sm border border-primary/30 rounded-full px-4 py-2 mb-6">
              <span className="text-primary font-semibold">ðŸ’° Results-Driven Advertising</span>
            </div>
            <h1 className="text-4xl md:text-5xl font-extrabold text-white mb-4 tracking-tight">
              Tired of Wasting Money on Ads? 
              <br />
              <span className="text-primary">Let's Turn Clicks Into Customers.</span>
            </h1>
            <p className="text-lg md:text-xl text-gray-200 mb-8 leading-relaxed">
              Think of us as your co-pilot for digital advertising. We handle the complex stuff, from the data and targeting to the constant tweaks, to make sure your budget finds real people who actually want what you sell. No more shouting into the void; just smart ads that work.
            </p>
            <ServiceCTAButtons
              serviceId={AD_MANAGEMENT_TIERS[1].id}
              price={AD_MANAGEMENT_TIERS[1].price}
              serviceName="Ad Management"
              onScheduleClick={handleScheduleClick}
            />
          </header>
        </div>
      </div>

      {/* Main Content */}
      <div className="bg-gray-50">
        <div className="container mx-auto px-4 pb-12 md:pb-20">
          
          {/* Why Us Section with Overlap - CRO Optimized */}
          <section className="relative z-10 -mt-24 max-w-4xl mx-auto mb-12 md:mb-20 bg-white p-8 md:p-10 rounded-2xl shadow-xl">
            <div className="text-center mb-8">
              <h2 className="text-3xl font-bold text-gray-900 mb-3">More Than an Agency, We're Your Growth Team.</h2>
              <div className="w-20 h-1 bg-primary mx-auto rounded-full"></div>
            </div>
            <p className="text-center text-gray-600 mb-10 text-lg">
              Look, anyone can boost a post. The real magic is in the day-to-day work of testing, learning, and optimizing. That's where we come in. We genuinely plug into your business, acting like an in-house team that's obsessed with one thing: helping you grow.
            </p>
            <div className="grid md:grid-cols-2 gap-8 text-gray-700">
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Target className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">We Speak Every Platform's Language</h3>
                  <p className="text-gray-600">Whether your customers are scrolling Instagram, searching on Google, or discovering trends on TikTok, we're there. We craft ads that feel native and engaging, not intrusive.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <TrendingUp className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">We Focus on Real Results (ROAS)</h3>
                  <p className="text-gray-600">Vanity metrics like 'likes' are nice, but we chase the numbers that actually matter: leads, sales, and a healthy Return on Ad Spend. Every dollar is tracked, tested, and put to work for your bottom line.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <BarChart3 className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">No-Jargon, Honest Reporting</h3>
                  <p className="text-gray-600">You'll never be in the dark. We provide simple, clear reports that show you what's working and what we're doing about it. You'll always know exactly how your campaigns are performing.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Zap className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">We See the Bigger Picture</h3>
                  <p className="text-gray-600">A click is just the beginning. We look at the whole customer journey, from the ad to your landing page, to make sure the experience is seamless. It's how we turn curious clicks into happy customers.</p>
                </div>
              </div>
            </div>

            {/* Trust Badges - CRO */}
            <div className="mt-10 pt-8 border-t border-gray-200">
              <div className="flex flex-wrap justify-center gap-6 text-sm">
                <div className="flex items-center gap-2">
                  <CheckCircle className="h-5 w-5 text-green-500" />
                  <span className="font-medium text-gray-700">Meta Business Partner</span>
                </div>
                <div className="flex items-center gap-2">
                  <CheckCircle className="h-5 w-5 text-green-500" />
                  <span className="font-medium text-gray-700">Google Ads Certified</span>
                </div>
                <div className="flex items-center gap-2">
                  <CheckCircle className="h-5 w-5 text-green-500" />
                  <span className="font-medium text-gray-700">TikTok Marketing Partner</span>
                </div>
              </div>
            </div>
          </section>

          {/* Pricing Section - CRO Optimized */}
          <section className="text-center max-w-3xl mx-auto mb-12 md:mb-16">
            <h2 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
              Investment Plans That Scale With You
            </h2>
            <p className="text-lg text-gray-600 mb-6">
              Whether you're just starting out or ready to dominate your market, we have a plan designed for your stage of growth.
            </p>
            <div className="inline-block bg-blue-50 border border-blue-200 rounded-lg px-6 py-3 mb-8">
              <p className="text-sm text-blue-800">
                <strong>ðŸ’¡ Pro Tip:</strong> Ad spend budget is separate from management fees
              </p>
            </div>

            {/* Simple Pricing Display */}
            <div className="grid md:grid-cols-3 gap-6 max-w-5xl mx-auto mt-12">
              {AD_MANAGEMENT_TIERS.map((tier) => (
                <div 
                  key={tier.id}
                  className={`bg-white rounded-xl shadow-lg p-8 border-2 flex flex-col h-full ${
                    tier.popular ? 'border-primary' : 'border-gray-200 hover:border-primary'
                  } transition-all relative`}
                >
                  {tier.popular && (
                    <div className="absolute -top-4 left-1/2 transform -translate-x-1/2">
                      <span className="bg-primary text-white px-4 py-1 rounded-full text-sm font-semibold">Most Popular</span>
                    </div>
                  )}
                  <h3 className="text-2xl font-bold text-gray-900 mb-2">{tier.name}</h3>
                  <div className="mb-4">
                    <span className="text-4xl font-bold text-primary">${tier.price.toLocaleString()}</span>
                    <span className="text-gray-600">/month</span>
                  </div>
                  <ul className="text-left space-y-3 mb-6 flex-1">
                    {tier.features.map((feature, idx) => (
                      <li key={idx} className="flex items-start gap-2">
                        <CheckCircle className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                        <span className="text-gray-600">{feature}</span>
                      </li>
                    ))}
                  </ul>
                  <ServiceCTAButtons
                    serviceId={tier.id}
                    price={tier.price}
                    serviceName={`Ad Management - ${tier.name}`}
                    onScheduleClick={handleScheduleClick}
                    variant="stacked"
                    className="mt-auto"
                  />
                </div>
              ))}
            </div>
          </section>

          {/* Call to Action Section */}
          <section id="ctaSection" className="text-center mt-16 md:mt-24 max-w-3xl mx-auto bg-white rounded-2xl p-8 md:p-12 shadow-lg">
            {!showScheduler ? (
              <div id="ctaContent">
                <div className="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-6">
                  <span className="text-4xl">ðŸš€</span>
                </div>
                <h2 className="text-3xl font-bold text-gray-900 mb-4">
                  Ready to See What Your Ads Can *Really* Do?
                </h2>
                <p className="text-gray-600 mb-8 text-lg leading-relaxed">
                  Hop on a free, no-strings-attached strategy call with us. We'll take a look at what you're doing now, listen to your goals, and give you some honest, actionable advice. It's a chat, not a sales pitch. Let's figure this out together.
                </p>
                <ServiceCTAButtons
                  serviceId={AD_MANAGEMENT_TIERS[1].id}
                  price={AD_MANAGEMENT_TIERS[1].price}
                  serviceName="Ad Management"
                  onScheduleClick={handleScheduleClick}
                />
                <p className="mt-6 text-sm text-gray-500">
                  â±ï¸ 30-minute call â€¢ ðŸ“… Choose your time â€¢ ðŸŽ Free audit included
                </p>
              </div>
            ) : (
              <div id="scheduler">
                <CalendlyScheduler url="https://calendly.com/cdm-creativemedia/digital-marketing-power-session" />
              </div>
            )}
          </section>

          {/* FAQ Section - CRO Optimized */}
          <section className="max-w-3xl mx-auto mt-16 md:mt-24 border-t pt-12">
            <h2 className="text-3xl font-bold text-center text-gray-900 mb-8">Common Questions</h2>
            <div className="space-y-6">
              <div className="bg-white rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                <h3 className="font-semibold text-lg text-gray-800 mb-2 flex items-start gap-2">
                  <span className="text-primary">Q:</span>
                  Is the monthly ad spend included in your price?
                </h3>
                <p className="text-gray-600 pl-6">Great question! Our pricing is for our team's expertiseâ€”the strategy, management, and optimization. Your ad spend (the money that goes directly to Google, Meta, etc.) is a separate budget. We'll help you determine the right starting budget for your goals during our strategy call.</p>
              </div>
              <div className="bg-white rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                <h3 className="font-semibold text-lg text-gray-800 mb-2 flex items-start gap-2">
                  <span className="text-primary">Q:</span>
                  How long until I see results?
                </h3>
                <p className="text-gray-600 pl-6">We get it, you're excited to see a return! While you can start seeing traffic and data within days, it usually takes about 2-3 months to fully optimize campaigns for consistent, profitable results. The first month is all about gathering data and learning, then we scale what works.</p>
              </div>
              <div className="bg-white rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                <h3 className="font-semibold text-lg text-gray-800 mb-2 flex items-start gap-2">
                  <span className="text-primary">Q:</span>
                  How do you get access to my accounts?
                </h3>
                <p className="text-gray-600 pl-6">Your security and ownership are top priorities. We use a secure, professional process and will request partner-level access to your ad accounts (like Facebook Business Manager and Google Ads). This way, you always remain the owner of your accounts and data. We'll never ask for your personal login details.</p>
              </div>
            </div>
          </section>
        </div>
      </div>

      <Footer />
    </>
  );
}

// ==========================================
// File: app/services/ai-solutions/page.tsx
// ==========================================


"use client";

import { useState } from "react";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";
import CalendlyScheduler from "@/components/calendly-scheduler";
import { StickyCTAButton } from "@/components/sticky-cta-button";
import { Button } from "@/components/ui/button";
import { CheckCircle, Brain, Zap, TrendingUp, Bot } from "lucide-react";
import Image from "next/image";

export default function AISolutionsPage() {
  const [showScheduler, setShowScheduler] = useState(false);

  const handleScheduleClick = () => {
    setShowScheduler(true);
    setTimeout(() => {
      document.getElementById('ctaSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  };

  return (
    <>
      <Navigation />
      <StickyCTAButton 
        onScheduleClick={handleScheduleClick}
        serviceName="AI Solutions"
      />
      
      {/* Hero Section with Header Image */}
      <div className="relative bg-gray-900 overflow-hidden">
        <div className="absolute inset-0">
          <div className="relative w-full h-full">
            <Image
              src="https://cdn.abacus.ai/images/ced69fa8-5742-4173-aafb-2e0f52e13d6a.png"
              alt="AI implementation services"
              fill
              className="object-cover object-center"
              priority
            />
            <div className="absolute inset-0 bg-gradient-to-b from-gray-900/70 via-gray-900/60 to-gray-900/80"></div>
          </div>
        </div>
        
        <div className="relative container mx-auto px-4 py-24 md:py-32 z-10">
          <header className="text-center max-w-3xl mx-auto">
            <div className="inline-block bg-primary/20 backdrop-blur-sm border border-primary/30 rounded-full px-4 py-2 mb-6">
              <span className="text-primary font-semibold">ðŸ¤– AI Implementation Services</span>
            </div>
            <h1 className="text-4xl md:text-5xl font-extrabold text-white mb-4 tracking-tight">
              Put AI to Work
              <br />
              <span className="text-primary">in Your Business.</span>
            </h1>
            <p className="text-lg md:text-xl text-gray-200 mb-8 leading-relaxed">
              From chatbots to predictive analytics, we help businesses leverage AI to automate processes, 
              gain insights, and make smarter decisions. No hype, just practical AI solutions that drive results.
            </p>
            <div className="flex flex-wrap gap-4 justify-center">
              <Button
                size="lg"
                onClick={handleScheduleClick}
                className="bg-primary hover:bg-primary/90 text-white text-lg px-8 py-6"
              >
                Schedule Free Consultation
              </Button>
              <Button
                size="lg"
                variant="outline"
                onClick={() => window.location.href = '/contact'}
                className="border-white text-white hover:bg-white/10 text-lg px-8 py-6"
              >
                Get Custom Quote
              </Button>
            </div>
          </header>
        </div>
      </div>

      {/* Main Content */}
      <div className="bg-gray-50">
        <div className="container mx-auto px-4 pb-12 md:pb-20">
          
          {/* Why AI Section with Overlap */}
          <section className="relative z-10 -mt-24 max-w-4xl mx-auto mb-12 md:mb-20 bg-white p-8 md:p-10 rounded-2xl shadow-xl">
            <div className="text-center mb-8">
              <h2 className="text-3xl font-bold text-gray-900 mb-3">AI That Makes Sense for Your Business.</h2>
              <div className="w-20 h-1 bg-primary mx-auto rounded-full"></div>
            </div>
            <p className="text-center text-gray-600 mb-10 text-lg">
              AI isn't just for tech giants. We help businesses of all sizes implement practical AI solutions 
              that automate repetitive tasks, improve customer experiences, and unlock insights from data.
            </p>
            <div className="grid md:grid-cols-2 gap-8 text-gray-700">
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Bot className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Chatbots & Virtual Assistants</h3>
                  <p className="text-gray-600">24/7 customer support, lead qualification, and automated responses that feel human.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <TrendingUp className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Predictive Analytics</h3>
                  <p className="text-gray-600">Forecast trends, identify opportunities, and make data-driven decisions with confidence.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Zap className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Process Automation</h3>
                  <p className="text-gray-600">Free up your team by automating repetitive tasks and workflows.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Brain className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Custom AI Solutions</h3>
                  <p className="text-gray-600">Tailored machine learning models trained on your specific business data and needs.</p>
                </div>
              </div>
            </div>
          </section>

          {/* Use Cases Section */}
          <section className="mb-16 md:mb-24">
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold text-gray-900 mb-4">Common AI Use Cases</h2>
              <p className="text-lg text-gray-600 max-w-2xl mx-auto">
                Real-world applications of AI that businesses are using today
              </p>
            </div>
            
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
              {[
                { title: "Customer Service Chatbots", desc: "Instant responses to common questions, 24/7 availability" },
                { title: "Lead Scoring & Qualification", desc: "Automatically identify and prioritize your best leads" },
                { title: "Content Personalization", desc: "Show each visitor the most relevant content and offers" },
                { title: "Sales Forecasting", desc: "Predict future revenue and identify growth opportunities" },
                { title: "Inventory Optimization", desc: "Reduce costs by predicting demand and optimizing stock" },
                { title: "Sentiment Analysis", desc: "Monitor customer feedback and brand reputation at scale" },
              ].map((item, idx) => (
                <div key={idx} className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow">
                  <div className="flex items-start gap-3">
                    <CheckCircle className="h-6 w-6 text-primary flex-shrink-0 mt-1" />
                    <div>
                      <h3 className="font-semibold text-lg text-gray-900 mb-2">{item.title}</h3>
                      <p className="text-gray-600 text-sm">{item.desc}</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </section>

          {/* Process Section */}
          <section className="mb-16 md:mb-24 max-w-4xl mx-auto">
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold text-gray-900 mb-4">Our AI Implementation Process</h2>
            </div>
            
            <div className="space-y-6">
              {[
                { num: "1", title: "Discovery", desc: "We analyze your business processes and identify opportunities for AI" },
                { num: "2", title: "Strategy", desc: "Develop a roadmap with clear goals, timeline, and success metrics" },
                { num: "3", title: "Development", desc: "Build and train AI models using your data and requirements" },
                { num: "4", title: "Testing", desc: "Rigorous testing to ensure accuracy and reliability" },
                { num: "5", title: "Deployment", desc: "Launch and integrate with your existing systems" },
                { num: "6", title: "Optimization", desc: "Continuous monitoring and improvement as we gather more data" },
              ].map((step, idx) => (
                <div key={idx} className="flex gap-6 items-start bg-white p-6 rounded-xl shadow-lg">
                  <div className="flex-shrink-0 w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white text-xl font-bold">
                    {step.num}
                  </div>
                  <div>
                    <h3 className="text-xl font-semibold text-gray-900 mb-2">{step.title}</h3>
                    <p className="text-gray-600">{step.desc}</p>
                  </div>
                </div>
              ))}
            </div>
          </section>

          {/* Final CTA Section */}
          <section id="ctaSection" className="bg-gradient-to-r from-primary to-purple-600 rounded-2xl p-12 text-center text-white">
            <h2 className="text-3xl md:text-4xl font-bold mb-4">Ready to Explore AI for Your Business?</h2>
            <p className="text-lg md:text-xl mb-8 opacity-90 max-w-2xl mx-auto">
              Let's discuss how AI can help you work smarter, not harder. Every project is custom-priced based on complexity and scope.
            </p>
            {showScheduler ? (
              <div className="max-w-4xl mx-auto bg-white rounded-lg p-4">
                <CalendlyScheduler url="https://calendly.com/cdmsuite/consultation" />
              </div>
            ) : (
              <Button
                size="lg"
                onClick={handleScheduleClick}
                className="bg-white text-primary hover:bg-gray-100 text-lg px-8 py-6"
              >
                Schedule Free Consultation
              </Button>
            )}
          </section>
        </div>
      </div>

      <Footer />
    </>
  );
}

// ==========================================
// File: app/services/app-development/page.tsx
// ==========================================


"use client";

import { useState } from "react";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";
import CalendlyScheduler from "@/components/calendly-scheduler";
import { ServiceCTAButtons } from "@/components/service-cta-buttons";
import { StickyCTAButton } from "@/components/sticky-cta-button";
import { Button } from "@/components/ui/button";
import { CheckCircle, Smartphone, Tablet, Code, Zap } from "lucide-react";
import Image from "next/image";
import { APP_CREATION_TIERS, APP_MAINTENANCE_TIERS } from "@/lib/pricing-tiers";

export default function AppDevelopmentPage() {
  const [showScheduler, setShowScheduler] = useState(false);

  const handleScheduleClick = () => {
    setShowScheduler(true);
    setTimeout(() => {
      document.getElementById('ctaSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  };

  return (
    <>
      <Navigation />
      <StickyCTAButton 
        onScheduleClick={handleScheduleClick}
        serviceName="App Development"
      />
      
      {/* Hero Section with Header Image */}
      <div className="relative bg-gray-900 overflow-hidden">
        <div className="absolute inset-0">
          <div className="relative w-full h-full">
            <Image
              src="https://cdn.abacus.ai/images/9f04f5ba-a634-414a-8344-b68ce3c2adf0.png"
              alt="Mobile app development"
              fill
              className="object-cover object-center"
              priority
            />
            <div className="absolute inset-0 bg-gradient-to-b from-gray-900/70 via-gray-900/60 to-gray-900/80"></div>
          </div>
        </div>
        
        <div className="relative container mx-auto px-4 py-24 md:py-32 z-10">
          <header className="text-center max-w-3xl mx-auto">
            <div className="inline-block bg-primary/20 backdrop-blur-sm border border-primary/30 rounded-full px-4 py-2 mb-6">
              <span className="text-primary font-semibold">ðŸ“± Mobile App Development</span>
            </div>
            <h1 className="text-4xl md:text-5xl font-extrabold text-white mb-4 tracking-tight">
              Bring Your App Idea
              <br />
              <span className="text-primary">to Life.</span>
            </h1>
            <p className="text-lg md:text-xl text-gray-200 mb-8 leading-relaxed">
              From concept to launch, we build native and cross-platform mobile apps that engage users 
              and drive business growth. iOS, Android, or both - we've got you covered.
            </p>
            <ServiceCTAButtons
              serviceId={APP_CREATION_TIERS[1].id}
              price={APP_CREATION_TIERS[1].price}
              serviceName="App Development Services"
              onScheduleClick={handleScheduleClick}
            />
          </header>
        </div>
      </div>

      {/* Main Content */}
      <div className="bg-gray-50">
        <div className="container mx-auto px-4 pb-12 md:pb-20">
          
          {/* Why Us Section with Overlap */}
          <section className="relative z-10 -mt-24 max-w-4xl mx-auto mb-12 md:mb-20 bg-white p-8 md:p-10 rounded-2xl shadow-xl">
            <div className="text-center mb-8">
              <h2 className="text-3xl font-bold text-gray-900 mb-3">Built for Performance and User Experience.</h2>
              <div className="w-20 h-1 bg-primary mx-auto rounded-full"></div>
            </div>
            <p className="text-center text-gray-600 mb-10 text-lg">
              A great app is more than just code - it's about solving problems and creating experiences 
              that users love. We combine technical expertise with user-centered design.
            </p>
            <div className="grid md:grid-cols-2 gap-8 text-gray-700">
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Smartphone className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Native & Cross-Platform</h3>
                  <p className="text-gray-600">Build for iOS, Android, or both using the best technology for your needs and budget.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Zap className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Fast & Responsive</h3>
                  <p className="text-gray-600">Optimized performance that keeps users engaged without draining battery or data.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Code className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Clean Architecture</h3>
                  <p className="text-gray-600">Scalable code built with best practices for easy maintenance and future updates.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Tablet className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Beautiful UI/UX</h3>
                  <p className="text-gray-600">Intuitive interfaces designed following platform guidelines and modern best practices.</p>
                </div>
              </div>
            </div>
          </section>

          {/* What's Included Section */}
          <section className="mb-16 md:mb-24">
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold text-gray-900 mb-4">Complete App Development</h2>
              <p className="text-lg text-gray-600 max-w-2xl mx-auto">
                Everything you need from idea to app store launch
              </p>
            </div>
            
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
              {[
                { title: "Discovery & Planning", desc: "Define features, user flows, and technical requirements" },
                { title: "UI/UX Design", desc: "Beautiful, intuitive interfaces that users love" },
                { title: "Development", desc: "Clean, maintainable code built with modern frameworks" },
                { title: "Testing & QA", desc: "Rigorous testing across devices and scenarios" },
                { title: "App Store Launch", desc: "Submission and optimization for both iOS and Android" },
                { title: "Support & Updates", desc: "Ongoing maintenance to keep your app running smoothly" },
              ].map((item, idx) => (
                <div key={idx} className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow">
                  <div className="flex items-start gap-3">
                    <CheckCircle className="h-6 w-6 text-primary flex-shrink-0 mt-1" />
                    <div>
                      <h3 className="font-semibold text-lg text-gray-900 mb-2">{item.title}</h3>
                      <p className="text-gray-600 text-sm">{item.desc}</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </section>

          {/* Pricing Section */}
          <section id="pricing" className="mb-16 md:mb-24">
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold text-gray-900 mb-4">App Development Packages</h2>
              <p className="text-lg text-gray-600 max-w-2xl mx-auto">
                Choose the package that matches your app complexity
              </p>
            </div>
            
            <div className="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto">
              {APP_CREATION_TIERS.map((tier) => (
                <div
                  key={tier.id}
                  className={`bg-white rounded-2xl shadow-xl p-8 flex flex-col h-full ${
                    tier.popular ? 'ring-2 ring-primary scale-105' : ''
                  }`}
                >
                  {tier.popular && (
                    <div className="bg-primary text-white text-sm font-semibold px-3 py-1 rounded-full inline-block mb-4">
                      Most Popular
                    </div>
                  )}
                  <h3 className="text-2xl font-bold text-gray-900 mb-2">{tier.name}</h3>
                  <p className="text-gray-600 text-sm mb-6 min-h-[48px]">{tier.description}</p>
                  <div className="mb-6">
                    <div className="flex items-baseline gap-1">
                      <span className="text-4xl font-bold text-gray-900">${tier.price.toLocaleString()}</span>
                      <span className="text-gray-500 text-sm">starting</span>
                    </div>
                  </div>
                  <ul className="space-y-3 mb-8 flex-1">
                    {tier.features.map((feature, idx) => (
                      <li key={idx} className="flex items-start gap-2">
                        <CheckCircle className="h-5 w-5 text-primary flex-shrink-0 mt-0.5" />
                        <span className="text-sm text-gray-700">{feature}</span>
                      </li>
                    ))}
                  </ul>
                  <ServiceCTAButtons
                    serviceId={tier.id}
                    price={tier.price}
                    serviceName={`App Development - ${tier.name}`}
                    onScheduleClick={handleScheduleClick}
                    className="w-full mt-auto"
                  />
                </div>
              ))}
            </div>
          </section>

          {/* App Maintenance Section */}
          <section className="mb-16 md:mb-24">
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold text-gray-900 mb-4">Keep Your App Running Smoothly</h2>
              <p className="text-lg text-gray-600 max-w-2xl mx-auto">
                Monthly maintenance packages to keep your app secure, updated, and performing at its best
              </p>
            </div>
            
            <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-7xl mx-auto">
              {APP_MAINTENANCE_TIERS.map((tier) => (
                <div
                  key={tier.id}
                  className={`bg-white rounded-2xl shadow-xl p-6 flex flex-col h-full ${
                    tier.popular ? 'ring-2 ring-primary scale-105' : ''
                  }`}
                >
                  {tier.popular && (
                    <div className="bg-primary text-white text-xs font-semibold px-2 py-1 rounded-full inline-block mb-3">
                      Popular
                    </div>
                  )}
                  <h3 className="text-xl font-bold text-gray-900 mb-2">{tier.name}</h3>
                  <p className="text-gray-600 text-xs mb-4 min-h-[40px]">{tier.description}</p>
                  <div className="mb-4">
                    <div className="flex items-baseline gap-1">
                      <span className="text-3xl font-bold text-gray-900">${tier.price.toLocaleString()}</span>
                      <span className="text-gray-500 text-xs">/month</span>
                    </div>
                  </div>
                  <ul className="space-y-2 mb-6 flex-1">
                    {tier.features.map((feature, idx) => (
                      <li key={idx} className="flex items-start gap-2">
                        <CheckCircle className="h-4 w-4 text-primary flex-shrink-0 mt-0.5" />
                        <span className="text-xs text-gray-700">{feature}</span>
                      </li>
                    ))}
                  </ul>
                  <ServiceCTAButtons
                    serviceId={tier.id}
                    price={tier.price}
                    serviceName={`App Maintenance - ${tier.name}`}
                    onScheduleClick={handleScheduleClick}
                    className="w-full mt-auto"
                  />
                </div>
              ))}
            </div>
          </section>

          {/* Final CTA Section */}
          <section id="ctaSection" className="bg-gradient-to-r from-primary to-purple-600 rounded-2xl p-12 text-center text-white">
            <h2 className="text-3xl md:text-4xl font-bold mb-4">Ready to Build Your App?</h2>
            <p className="text-lg md:text-xl mb-8 opacity-90 max-w-2xl mx-auto">
              Let's turn your app idea into reality. Schedule a free consultation to discuss your project.
            </p>
            {showScheduler ? (
              <div className="max-w-4xl mx-auto bg-white rounded-lg p-4">
                <CalendlyScheduler url="https://calendly.com/cdmsuite/consultation" />
              </div>
            ) : (
              <Button
                size="lg"
                onClick={handleScheduleClick}
                className="bg-white text-primary hover:bg-gray-100 text-lg px-8 py-6"
              >
                Schedule Free Consultation
              </Button>
            )}
          </section>
        </div>
      </div>

      <Footer />
    </>
  );
}

// ==========================================
// File: app/services/page.tsx
// ==========================================


'use client';

import { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { ArrowRight, Loader2, Monitor, Search, Megaphone, Smartphone, Package, RefreshCw, Info } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';
import { toast } from 'react-hot-toast';
import Navigation from '@/components/navigation';
import Footer from '@/components/footer';
import Link from 'next/link';
import { ServiceModal } from '@/components/service-modal';
import { getTierById } from '@/lib/pricing-tiers';

interface Service {
  id: string;
  slug: string;
  name: string;
  description: string;
  category?: string;
  priceRange?: string;
  features?: string[];
  popular?: boolean;
}

// Service category icons and descriptions
const categoryInfo: Record<string, { icon: any, title: string, description: string, detailPageSlug: string }> = {
  'website-creation': {
    icon: Monitor,
    title: 'Website Design & Development',
    description: 'Custom, responsive websites built to convert visitors into customers',
    detailPageSlug: 'web-design'
  },
  'website-maintenance': {
    icon: RefreshCw,
    title: 'Website Maintenance',
    description: 'Keep your site secure, updated, and running smoothly',
    detailPageSlug: 'web-design'
  },
  'seo': {
    icon: Search,
    title: 'Search Engine Optimization',
    description: 'Get found by customers searching for your services',
    detailPageSlug: 'seo'
  },
  'social-media': {
    icon: Megaphone,
    title: 'Social Media Management',
    description: 'Build your brand and engage your audience',
    detailPageSlug: 'social-media'
  },
  'ad-management': {
    icon: Megaphone,
    title: 'Digital Advertising',
    description: 'Targeted ad campaigns that deliver measurable ROI',
    detailPageSlug: 'ad-management'
  },
  'app-creation': {
    icon: Smartphone,
    title: 'Mobile App Development',
    description: 'Native and cross-platform apps for iOS and Android',
    detailPageSlug: 'app-development'
  },
  'app-maintenance': {
    icon: RefreshCw,
    title: 'App Maintenance & Support',
    description: 'Keep your mobile app updated and bug-free',
    detailPageSlug: 'app-development'
  },
  'bundle': {
    icon: Package,
    title: 'Service Bundles',
    description: 'Complete digital marketing packages at bundled pricing',
    detailPageSlug: 'pricing'
  },
};

export default function ServicesPage() {
  const [services, setServices] = useState<Service[]>([]);
  const [pageLoading, setPageLoading] = useState(true);
  const [selectedService, setSelectedService] = useState<Service | null>(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [currentDetailPageSlug, setCurrentDetailPageSlug] = useState<string>('');

  useEffect(() => {
    fetchServices();
  }, []);

  const fetchServices = async () => {
    try {
      const res = await fetch('/api/services');
      const data = await res.json();
      
      // Enrich services with pricing tier data
      const enrichedServices = data.map((service: Service) => {
        const tier = getTierById(service.slug);
        if (tier) {
          return {
            ...service,
            priceRange: tier.priceRange,
            features: tier.features,
            popular: tier.popular,
          };
        }
        return service;
      });
      
      setServices(enrichedServices);
    } catch (error) {
      toast.error('Failed to load services');
    } finally {
      setPageLoading(false);
    }
  };

  const categorizeServices = () => {
    const categories: Record<string, Service[]> = {
      'website-creation': [],
      'website-maintenance': [],
      'seo': [],
      'social-media': [],
      'ad-management': [],
      'app-creation': [],
      'app-maintenance': [],
      'bundle': [],
    };

    services.forEach(service => {
      // Check more specific patterns first to avoid miscategorization
      if (service.slug.startsWith('website-creation')) {
        categories['website-creation'].push(service);
      } else if (service.slug.startsWith('website-maintenance')) {
        categories['website-maintenance'].push(service);
      } else if (service.slug.startsWith('app-maintenance')) {
        categories['app-maintenance'].push(service);
      } else if (service.slug.startsWith('app-')) {
        categories['app-creation'].push(service);
      } else if (service.slug.startsWith('seo-')) {
        categories['seo'].push(service);
      } else if (service.slug.startsWith('social-')) {
        categories['social-media'].push(service);
      } else if (service.slug.startsWith('ad-')) {
        categories['ad-management'].push(service);
      } else if (service.slug.startsWith('bundle')) {
        categories['bundle'].push(service);
      }
    });

    return categories;
  };

  const handleServiceClick = (service: Service, detailPageSlug: string) => {
    setSelectedService(service);
    setCurrentDetailPageSlug(detailPageSlug);
    setIsModalOpen(true);
  };

  if (pageLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin" />
      </div>
    );
  }

  const categorizedServices = categorizeServices();

  return (
    <>
      <Navigation />
      <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white dark:from-gray-900 dark:to-gray-800">
        <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-12 sm:py-16 lg:py-20">
          {/* Header */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.6 }}
            className="text-center mb-12 lg:mb-16"
          >
            <h1 className="text-4xl sm:text-5xl lg:text-6xl font-bold mb-4 lg:mb-6 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">
              Our Services
            </h1>
            <p className="text-lg sm:text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto leading-relaxed">
              From websites to mobile apps, SEO to social media - we offer a complete suite of digital marketing services 
              designed to help your business grow online.
            </p>
          </motion.div>

          {/* Service Categories */}
          <div className="space-y-12 lg:space-y-16">
            {Object.entries(categorizedServices).map(([categoryKey, categoryServices]) => {
              if (categoryServices.length === 0) return null;
              
              const info = categoryInfo[categoryKey];
              const IconComponent = info.icon;

              return (
                <motion.div
                  key={categoryKey}
                  initial={{ opacity: 0, y: 20 }}
                  whileInView={{ opacity: 1, y: 0 }}
                  viewport={{ once: true }}
                  transition={{ duration: 0.6 }}
                  className="scroll-mt-24"
                >
                  <Card className="border-2 bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900">
                    <CardHeader className="pb-4 lg:pb-6">
                      <div className="flex items-start gap-4">
                        <div className="p-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg">
                          <IconComponent className="w-6 h-6 text-white" />
                        </div>
                        <div className="flex-1">
                          <CardTitle className="text-2xl lg:text-3xl mb-2">{info.title}</CardTitle>
                          <CardDescription className="text-base lg:text-lg">{info.description}</CardDescription>
                        </div>
                      </div>
                    </CardHeader>
                    <CardContent>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {categoryServices.map((service) => (
                          <motion.div
                            key={service.id}
                            whileHover={{ scale: 1.02 }}
                            className="group relative p-4 bg-white dark:bg-gray-800 rounded-lg border hover:border-blue-400 hover:shadow-lg transition-all cursor-pointer"
                            onClick={() => handleServiceClick(service, info.detailPageSlug)}
                          >
                            <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
                              <Info className="w-5 h-5 text-blue-500" />
                            </div>
                            {service.popular && (
                              <div className="absolute -top-2 -right-2">
                                <span className="inline-flex items-center gap-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white text-xs font-semibold px-2 py-1 rounded-full">
                                  â­ Popular
                                </span>
                              </div>
                            )}
                            <h4 className="font-bold text-gray-900 dark:text-white mb-2 pr-6 line-clamp-1">
                              {service.name.replace(/^.*?\s-\s/, '')}
                            </h4>
                            {service.priceRange && (
                              <div className="text-sm font-bold text-blue-900 dark:text-blue-300 mb-2">
                                {service.priceRange}
                              </div>
                            )}
                            <p className="text-sm text-gray-700 dark:text-gray-300 line-clamp-2 mb-3">
                              {service.description}
                            </p>
                            <div className="flex items-center text-xs text-blue-900 dark:text-blue-300 font-semibold group-hover:text-blue-950 dark:group-hover:text-blue-200">
                              Click for details
                              <ArrowRight className="ml-1 w-3 h-3 group-hover:translate-x-1 transition-transform" />
                            </div>
                          </motion.div>
                        ))}
                      </div>
                    </CardContent>
                    <CardFooter className="pt-2 lg:pt-4">
                      <Link href={info.detailPageSlug === 'pricing' ? '/pricing' : `/services/${info.detailPageSlug}`} className="w-full">
                        <Button className="w-full" variant="default">
                          View {info.title} Details
                          <ArrowRight className="ml-2 w-4 h-4" />
                        </Button>
                      </Link>
                    </CardFooter>
                  </Card>
                </motion.div>
              );
            })}
          </div>

          {/* CTA Section */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.6, delay: 0.8 }}
            className="mt-12 lg:mt-16 text-center"
          >
            <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl lg:rounded-2xl p-8 lg:p-12 text-white">
              <h2 className="text-2xl lg:text-3xl font-bold mb-3 lg:mb-4">Not sure which service is right for you?</h2>
              <p className="text-base lg:text-xl mb-6 lg:mb-8 opacity-90">
                Let's talk! We'll help you choose the perfect solution for your business.
              </p>
              <Button
                size="lg"
                className="bg-white text-blue-600 hover:bg-gray-100 text-sm lg:text-base font-semibold hover:text-blue-700"
                onClick={() => window.location.href = '/contact'}
              >
                Schedule a Free Consultation
                <ArrowRight className="ml-2 w-4 h-4 lg:w-5 lg:h-5" />
              </Button>
            </div>
          </motion.div>
        </div>
      </div>

      {/* Service Modal */}
      <ServiceModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        service={selectedService}
        detailPageSlug={currentDetailPageSlug}
      />

      <Footer />
    </>
  );
}

// ==========================================
// File: app/services/seo/page.tsx
// ==========================================


"use client";

import { useState } from "react";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";
import CalendlyScheduler from "@/components/calendly-scheduler";
import { ServiceCTAButtons } from "@/components/service-cta-buttons";
import { StickyCTAButton } from "@/components/sticky-cta-button";
import { Button } from "@/components/ui/button";
import { CheckCircle, Search, LineChart, Globe, TrendingUp } from "lucide-react";
import Image from "next/image";
import { SEO_TIERS } from "@/lib/pricing-tiers";

export default function SEOServicesPage() {
  const [showScheduler, setShowScheduler] = useState(false);

  const handleScheduleClick = () => {
    setShowScheduler(true);
    setTimeout(() => {
      document.getElementById('ctaSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  };

  return (
    <>
      <Navigation />
      <StickyCTAButton 
        onScheduleClick={handleScheduleClick}
        serviceName="SEO Services"
      />
      
      {/* Hero Section with Header Image */}
      <div className="relative bg-gray-900 overflow-hidden">
        <div className="absolute inset-0">
          <div className="relative w-full h-full">
            <Image
              src="https://cdn.abacus.ai/images/b30c1045-5d17-4203-a2d3-3079b2f34779.png"
              alt="Team working on SEO strategy"
              fill
              className="object-cover object-center"
              priority
            />
            <div className="absolute inset-0 bg-gradient-to-b from-gray-900/70 via-gray-900/60 to-gray-900/80"></div>
          </div>
        </div>
        
        <div className="relative container mx-auto px-4 py-24 md:py-32 z-10">
          <header className="text-center max-w-3xl mx-auto">
            <div className="inline-block bg-primary/20 backdrop-blur-sm border border-primary/30 rounded-full px-4 py-2 mb-6">
              <span className="text-primary font-semibold">ðŸ” Strategic SEO Services</span>
            </div>
            <h1 className="text-4xl md:text-5xl font-extrabold text-white mb-4 tracking-tight">
              Get Found by the Customers
              <br />
              <span className="text-primary">Looking for You.</span>
            </h1>
            <p className="text-lg md:text-xl text-gray-200 mb-8 leading-relaxed">
              Good SEO isn't about tricking Google. It's about making your website the best possible answer for your future customers. We handle the technical details and strategic content so you can connect with the people who need you most.
            </p>
            <ServiceCTAButtons
              serviceId={SEO_TIERS[1].id}
              price={SEO_TIERS[1].price}
              serviceName="SEO Services"
              onScheduleClick={handleScheduleClick}
            />
          </header>
        </div>
      </div>

      {/* Main Content */}
      <div className="bg-gray-50">
        <div className="container mx-auto px-4 pb-12 md:pb-20">
          
          {/* Why Us Section with Overlap - CRO Optimized */}
          <section className="relative z-10 -mt-24 max-w-4xl mx-auto mb-12 md:mb-20 bg-white p-8 md:p-10 rounded-2xl shadow-xl">
            <div className="text-center mb-8">
              <h2 className="text-3xl font-bold text-gray-900 mb-3">We Play the Long Game.</h2>
              <div className="w-20 h-1 bg-primary mx-auto rounded-full"></div>
            </div>
            <p className="text-center text-gray-600 mb-10 text-lg">
              SEO is a marathon, not a sprint. While others might promise instant #1 rankings with risky tactics, we focus on building a powerful, sustainable foundation for your website. We build your authority, earn trust with search engines, and create a lasting asset that brings in qualified traffic month after month.
            </p>
            <div className="grid md:grid-cols-2 gap-8 text-gray-700">
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <TrendingUp className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Focused on Your Bottom Line</h3>
                  <p className="text-gray-600">Ranking for a keyword is useless if it doesn't bring in business. We start by understanding your goals and target the keywords that your ideal customers are actually using.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Globe className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">A Holistic Approach</h3>
                  <p className="text-gray-600">Great SEO doesn't live in a bubble. It works hand-in-hand with a well-designed website, quality content, and a smart user experience. We look at the whole picture to ensure success.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <LineChart className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">No-Nonsense Reporting</h3>
                  <p className="text-gray-600">We believe in total transparency. Our reports are clear, easy to understand, and focus on the metrics that matter most: your traffic, your leads, and your growth.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Search className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Always Learning, Always Adapting</h3>
                  <p className="text-gray-600">Google's algorithm is always changing. Part of our job is to stay on top of the latest trends and updates to keep your strategy effective and ahead of the curve.</p>
                </div>
              </div>
            </div>

            {/* Trust Badges - CRO */}
            <div className="mt-10 pt-8 border-t border-gray-200">
              <div className="flex flex-wrap justify-center gap-6 text-sm">
                <div className="flex items-center gap-2">
                  <CheckCircle className="h-5 w-5 text-green-500" />
                  <span className="font-medium text-gray-700">Google Analytics Certified</span>
                </div>
                <div className="flex items-center gap-2">
                  <CheckCircle className="h-5 w-5 text-green-500" />
                  <span className="font-medium text-gray-700">SEMrush Agency Partner</span>
                </div>
                <div className="flex items-center gap-2">
                  <CheckCircle className="h-5 w-5 text-green-500" />
                  <span className="font-medium text-gray-700">Proven Track Record</span>
                </div>
              </div>
            </div>
          </section>

          {/* Pricing Section - CRO Optimized */}
          <section className="text-center max-w-3xl mx-auto mb-12 md:mb-16">
            <h2 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
              Find the Perfect SEO Plan for Your Business
            </h2>
            <p className="text-lg text-gray-600 mb-6">
              Whether you're just starting out or ready to scale, we have a plan designed for your stage of growth.
            </p>
            <div className="inline-block bg-green-50 border border-green-200 rounded-lg px-6 py-3 mb-8">
              <p className="text-sm text-green-800">
                <strong>ðŸ’¡ Pro Tip:</strong> SEO is a long-term investment with compounding returns
              </p>
            </div>

            {/* Simple Pricing Display */}
            <div className="grid md:grid-cols-3 gap-6 max-w-5xl mx-auto mt-12">
              {SEO_TIERS.map((tier) => (
                <div 
                  key={tier.id}
                  className={`bg-white rounded-xl shadow-lg p-8 border-2 flex flex-col h-full ${
                    tier.popular ? 'border-primary' : 'border-gray-200 hover:border-primary'
                  } transition-all relative`}
                >
                  {tier.popular && (
                    <div className="absolute -top-4 left-1/2 transform -translate-x-1/2">
                      <span className="bg-primary text-white px-4 py-1 rounded-full text-sm font-semibold">Most Popular</span>
                    </div>
                  )}
                  <h3 className="text-2xl font-bold text-gray-900 mb-2">{tier.name}</h3>
                  <div className="mb-4">
                    <span className="text-4xl font-bold text-primary">${tier.price.toLocaleString()}</span>
                    <span className="text-gray-600">/month</span>
                  </div>
                  <ul className="text-left space-y-3 mb-6 flex-1">
                    {tier.features.map((feature, idx) => (
                      <li key={idx} className="flex items-start gap-2">
                        <CheckCircle className="h-5 w-5 text-green-500 flex-shrink-0 mt-0.5" />
                        <span className="text-gray-600">{feature}</span>
                      </li>
                    ))}
                  </ul>
                  <ServiceCTAButtons
                    serviceId={tier.id}
                    price={tier.price}
                    serviceName={`SEO - ${tier.name}`}
                    onScheduleClick={handleScheduleClick}
                    variant="stacked"
                    className="mt-auto"
                  />
                </div>
              ))}
            </div>
          </section>

          {/* Call to Action Section */}
          <section id="ctaSection" className="text-center mt-16 md:mt-24 max-w-3xl mx-auto bg-white rounded-2xl p-8 md:p-12 shadow-lg">
            {!showScheduler ? (
              <div id="ctaContent">
                <div className="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-6">
                  <span className="text-4xl">ðŸ“ˆ</span>
                </div>
                <h2 className="text-3xl font-bold text-gray-900 mb-4">Ready to Climb the Ranks?</h2>
                <p className="text-gray-600 mb-8 text-lg leading-relaxed">
                  Let's start with a free, no-obligation SEO audit. We'll analyze your website, identify your biggest opportunities, and give you a clear, actionable roadmap for growth. No hard sell, just honest advice.
                </p>
                <ServiceCTAButtons
                  serviceId={SEO_TIERS[1].id}
                  price={SEO_TIERS[1].price}
                  serviceName="SEO Services"
                  onScheduleClick={handleScheduleClick}
                />
                <p className="mt-6 text-sm text-gray-500">
                  â±ï¸ 30-minute call â€¢ ðŸ” Comprehensive audit â€¢ ðŸ“Š Action plan included
                </p>
              </div>
            ) : (
              <div id="scheduler">
                <CalendlyScheduler url="https://calendly.com/cdm-creativemedia/digital-marketing-power-session" />
              </div>
            )}
          </section>

          {/* FAQ Section - CRO Optimized */}
          <section className="max-w-3xl mx-auto mt-16 md:mt-24 border-t pt-12">
            <h2 className="text-3xl font-bold text-center text-gray-900 mb-8">Your SEO Questions, Answered</h2>
            <div className="space-y-6">
              <div className="bg-white rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                <h3 className="font-semibold text-lg text-gray-800 mb-2 flex items-start gap-2">
                  <span className="text-primary">Q:</span>
                  How long does it take to see results from SEO?
                </h3>
                <p className="text-gray-600 pl-6">This is the most common and important question! SEO is a long-term strategy. While you might see some positive movement in the first 2-3 months, significant, lasting results typically take 6-12 months to build. It's an investment that pays off with steady, "free" traffic over time.</p>
              </div>
              <div className="bg-white rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                <h3 className="font-semibold text-lg text-gray-800 mb-2 flex items-start gap-2">
                  <span className="text-primary">Q:</span>
                  Can you guarantee a #1 ranking on Google?
                </h3>
                <p className="text-gray-600 pl-6">No reputable SEO professional can or should guarantee a #1 spot. Google's algorithm is complex and constantly changing. What we can guarantee is that we will use the best, most up-to-date strategies to significantly improve your visibility, traffic, and rankings for the keywords that matter to your business.</p>
              </div>
              <div className="bg-white rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow">
                <h3 className="font-semibold text-lg text-gray-800 mb-2 flex items-start gap-2">
                  <span className="text-primary">Q:</span>
                  What's the difference between on-page and off-page SEO?
                </h3>
                <p className="text-gray-600 pl-6">Think of it like this: On-page SEO is everything you control directly on your website (like content, keywords, site speed). Off-page SEO is about building your site's authority and reputation around the web (mostly through getting high-quality backlinks from other reputable sites).</p>
              </div>
            </div>
          </section>
        </div>
      </div>

      <Footer />
    </>
  );
}

// ==========================================
// File: app/services/social-media/page.tsx
// ==========================================


"use client";

import { useState } from "react";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";
import CalendlyScheduler from "@/components/calendly-scheduler";
import { ServiceCTAButtons } from "@/components/service-cta-buttons";
import { StickyCTAButton } from "@/components/sticky-cta-button";
import { Button } from "@/components/ui/button";
import { CheckCircle, Share2, TrendingUp, Users, Heart } from "lucide-react";
import Image from "next/image";
import { SOCIAL_MEDIA_TIERS } from "@/lib/pricing-tiers";

export default function SocialMediaPage() {
  const [showScheduler, setShowScheduler] = useState(false);

  const handleScheduleClick = () => {
    setShowScheduler(true);
    setTimeout(() => {
      document.getElementById('ctaSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  };

  return (
    <>
      <Navigation />
      <StickyCTAButton 
        onScheduleClick={handleScheduleClick}
        serviceName="Social Media Management"
      />
      
      {/* Hero Section with Header Image */}
      <div className="relative bg-gray-900 overflow-hidden">
        <div className="absolute inset-0">
          <div className="relative w-full h-full">
            <Image
              src="https://cdn.abacus.ai/images/c0201920-f2b3-4da8-b5e5-08cf4c08e5b5.png"
              alt="Social media management"
              fill
              className="object-cover object-center"
              priority
            />
            <div className="absolute inset-0 bg-gradient-to-b from-gray-900/70 via-gray-900/60 to-gray-900/80"></div>
          </div>
        </div>
        
        <div className="relative container mx-auto px-4 py-24 md:py-32 z-10">
          <header className="text-center max-w-3xl mx-auto">
            <div className="inline-block bg-primary/20 backdrop-blur-sm border border-primary/30 rounded-full px-4 py-2 mb-6">
              <span className="text-primary font-semibold">ðŸ“± Social Media Management</span>
            </div>
            <h1 className="text-4xl md:text-5xl font-extrabold text-white mb-4 tracking-tight">
              Build Your Brand Where
              <br />
              <span className="text-primary">Your Customers Are.</span>
            </h1>
            <p className="text-lg md:text-xl text-gray-200 mb-8 leading-relaxed">
              Social media done right means more than just posting. We create content that resonates, 
              build engaged communities, and turn followers into customers.
            </p>
            <ServiceCTAButtons
              serviceId={SOCIAL_MEDIA_TIERS[1].id}
              price={SOCIAL_MEDIA_TIERS[1].price}
              serviceName="Social Media Management"
              onScheduleClick={handleScheduleClick}
            />
          </header>
        </div>
      </div>

      {/* Main Content */}
      <div className="bg-gray-50">
        <div className="container mx-auto px-4 pb-12 md:pb-20">
          
          {/* Why Us Section with Overlap */}
          <section className="relative z-10 -mt-24 max-w-4xl mx-auto mb-12 md:mb-20 bg-white p-8 md:p-10 rounded-2xl shadow-xl">
            <div className="text-center mb-8">
              <h2 className="text-3xl font-bold text-gray-900 mb-3">Strategy First, Posting Second.</h2>
              <div className="w-20 h-1 bg-primary mx-auto rounded-full"></div>
            </div>
            <p className="text-center text-gray-600 mb-10 text-lg">
              Anyone can post on social media. But creating content that actually drives business results? 
              That takes strategy, creativity, and consistent execution.
            </p>
            <div className="grid md:grid-cols-2 gap-8 text-gray-700">
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Users className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Audience-Focused Content</h3>
                  <p className="text-gray-600">We create content that speaks to your audience's needs, not just what you want to say.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <TrendingUp className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Consistent Growth</h3>
                  <p className="text-gray-600">Strategic posting schedules and engagement tactics that steadily grow your following.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Heart className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Community Building</h3>
                  <p className="text-gray-600">We don't just broadcast - we engage, respond, and build real relationships with your audience.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Share2 className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Multi-Platform Expertise</h3>
                  <p className="text-gray-600">From Instagram to LinkedIn, we understand what works on each platform.</p>
                </div>
              </div>
            </div>
          </section>

          {/* What's Included Section */}
          <section className="mb-16 md:mb-24">
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold text-gray-900 mb-4">What's Included</h2>
              <p className="text-lg text-gray-600 max-w-2xl mx-auto">
                Complete social media management so you can focus on running your business
              </p>
            </div>
            
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
              {[
                { title: "Content Strategy", desc: "Custom content calendar aligned with your business goals" },
                { title: "Content Creation", desc: "Professional graphics, captions, and hashtag research" },
                { title: "Scheduling & Posting", desc: "Optimal timing for maximum reach and engagement" },
                { title: "Community Management", desc: "Responding to comments and messages promptly" },
                { title: "Analytics & Reporting", desc: "Monthly insights on what's working and what's not" },
                { title: "Platform Management", desc: "Facebook, Instagram, LinkedIn, Twitter, and more" },
              ].map((item, idx) => (
                <div key={idx} className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow">
                  <div className="flex items-start gap-3">
                    <CheckCircle className="h-6 w-6 text-primary flex-shrink-0 mt-1" />
                    <div>
                      <h3 className="font-semibold text-lg text-gray-900 mb-2">{item.title}</h3>
                      <p className="text-gray-600 text-sm">{item.desc}</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </section>

          {/* Pricing Section */}
          <section id="pricing" className="mb-16 md:mb-24">
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold text-gray-900 mb-4">Social Media Packages</h2>
              <p className="text-lg text-gray-600 max-w-2xl mx-auto">
                Choose the right level of support for your business
              </p>
            </div>
            
            <div className="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto">
              {SOCIAL_MEDIA_TIERS.map((tier) => (
                <div
                  key={tier.id}
                  className={`bg-white rounded-2xl shadow-xl p-8 flex flex-col h-full ${
                    tier.popular ? 'ring-2 ring-primary scale-105' : ''
                  }`}
                >
                  {tier.popular && (
                    <div className="bg-primary text-white text-sm font-semibold px-3 py-1 rounded-full inline-block mb-4">
                      Most Popular
                    </div>
                  )}
                  <h3 className="text-2xl font-bold text-gray-900 mb-2">{tier.name}</h3>
                  <p className="text-gray-600 text-sm mb-6 min-h-[48px]">{tier.description}</p>
                  <div className="mb-6">
                    <div className="flex items-baseline gap-1">
                      <span className="text-4xl font-bold text-gray-900">${tier.price}</span>
                      <span className="text-gray-500 text-sm">/month</span>
                    </div>
                  </div>
                  <ul className="space-y-3 mb-8 flex-1">
                    {tier.features.map((feature, idx) => (
                      <li key={idx} className="flex items-start gap-2">
                        <CheckCircle className="h-5 w-5 text-primary flex-shrink-0 mt-0.5" />
                        <span className="text-sm text-gray-700">{feature}</span>
                      </li>
                    ))}
                  </ul>
                  <ServiceCTAButtons
                    serviceId={tier.id}
                    price={tier.price}
                    serviceName={`Social Media - ${tier.name}`}
                    onScheduleClick={handleScheduleClick}
                    className="w-full mt-auto"
                  />
                </div>
              ))}
            </div>
          </section>

          {/* Final CTA Section */}
          <section id="ctaSection" className="bg-gradient-to-r from-primary to-purple-600 rounded-2xl p-12 text-center text-white">
            <h2 className="text-3xl md:text-4xl font-bold mb-4">Ready to Grow Your Social Presence?</h2>
            <p className="text-lg md:text-xl mb-8 opacity-90 max-w-2xl mx-auto">
              Let's build a social media strategy that drives real business results. Schedule your free consultation today.
            </p>
            {showScheduler ? (
              <div className="max-w-4xl mx-auto bg-white rounded-lg p-4">
                <CalendlyScheduler url="https://calendly.com/cdmsuite/consultation" />
              </div>
            ) : (
              <Button
                size="lg"
                onClick={handleScheduleClick}
                className="bg-white text-primary hover:bg-gray-100 text-lg px-8 py-6"
              >
                Schedule Free Consultation
              </Button>
            )}
          </section>
        </div>
      </div>

      <Footer />
    </>
  );
}

// ==========================================
// File: app/services/web-design/page.tsx
// ==========================================


"use client";

import { useState } from "react";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";
import CalendlyScheduler from "@/components/calendly-scheduler";
import { ServiceCTAButtons } from "@/components/service-cta-buttons";
import { StickyCTAButton } from "@/components/sticky-cta-button";
import { Button } from "@/components/ui/button";
import { CheckCircle, Monitor, Smartphone, Zap, Code, Palette } from "lucide-react";
import Image from "next/image";
import { WEB_DEVELOPMENT_TIERS, WEBSITE_MAINTENANCE_TIERS } from "@/lib/pricing-tiers";

export default function WebDesignPage() {
  const [showScheduler, setShowScheduler] = useState(false);

  const handleScheduleClick = () => {
    setShowScheduler(true);
    setTimeout(() => {
      document.getElementById('ctaSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  };

  return (
    <>
      <Navigation />
      <StickyCTAButton 
        onScheduleClick={handleScheduleClick}
        serviceName="Web Design"
      />
      
      {/* Hero Section with Header Image */}
      <div className="relative bg-gray-900 overflow-hidden">
        <div className="absolute inset-0">
          <div className="relative w-full h-full">
            <Image
              src="https://cdn.abacus.ai/images/be17cb63-d612-45d4-a305-c4454951de60.png"
              alt="Modern web design workspace"
              fill
              className="object-cover object-center"
              priority
            />
            <div className="absolute inset-0 bg-gradient-to-b from-gray-900/70 via-gray-900/60 to-gray-900/80"></div>
          </div>
        </div>
        
        <div className="relative container mx-auto px-4 py-24 md:py-32 z-10">
          <header className="text-center max-w-3xl mx-auto">
            <div className="inline-block bg-primary/20 backdrop-blur-sm border border-primary/30 rounded-full px-4 py-2 mb-6">
              <span className="text-primary font-semibold">ðŸŽ¨ Professional Web Design</span>
            </div>
            <h1 className="text-4xl md:text-5xl font-extrabold text-white mb-4 tracking-tight">
              Websites That Work as Hard
              <br />
              <span className="text-primary">as Your Business.</span>
            </h1>
            <p className="text-lg md:text-xl text-gray-200 mb-8 leading-relaxed">
              Your website is often the first impression potential customers have of your business. We create custom, 
              responsive websites that not only look stunning but also convert visitors into customers.
            </p>
            <ServiceCTAButtons
              serviceId={WEB_DEVELOPMENT_TIERS[1].id}
              price={WEB_DEVELOPMENT_TIERS[1].price}
              serviceName="Web Design Services"
              onScheduleClick={handleScheduleClick}
            />
          </header>
        </div>
      </div>

      {/* Main Content */}
      <div className="bg-gray-50">
        <div className="container mx-auto px-4 pb-12 md:pb-20">
          
          {/* Why Us Section with Overlap - CRO Optimized */}
          <section className="relative z-10 -mt-24 max-w-4xl mx-auto mb-12 md:mb-20 bg-white p-8 md:p-10 rounded-2xl shadow-xl">
            <div className="text-center mb-8">
              <h2 className="text-3xl font-bold text-gray-900 mb-3">More Than Just Pretty Pages.</h2>
              <div className="w-20 h-1 bg-primary mx-auto rounded-full"></div>
            </div>
            <p className="text-center text-gray-600 mb-10 text-lg">
              A beautiful website is useless if it doesn't bring you business. We design and develop websites with 
              a clear focus on user experience, conversion optimization, and your specific business goals.
            </p>
            <div className="grid md:grid-cols-2 gap-8 text-gray-700">
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Smartphone className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Mobile-First Design</h3>
                  <p className="text-gray-600">More people browse on phones than desktops. We build every site to look and function beautifully on any device.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Zap className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Lightning Fast Performance</h3>
                  <p className="text-gray-600">Slow sites lose customers. We optimize every element for speed, keeping visitors engaged and improving your SEO.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Code className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Clean, Modern Code</h3>
                  <p className="text-gray-600">Built with the latest technologies and best practices, your website will be secure, scalable, and easy to maintain.</p>
                </div>
              </div>
              <div className="flex gap-4">
                <div className="flex-shrink-0">
                  <div className="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center">
                    <Palette className="h-6 w-6 text-primary" />
                  </div>
                </div>
                <div>
                  <h3 className="font-semibold text-lg text-gray-800 mb-2">Your Brand, Amplified</h3>
                  <p className="text-gray-600">We don't use cookie-cutter templates. Every design is custom-crafted to reflect your unique brand identity.</p>
                </div>
              </div>
            </div>
          </section>

          {/* What's Included Section */}
          <section className="mb-16 md:mb-24">
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold text-gray-900 mb-4">What's Included</h2>
              <p className="text-lg text-gray-600 max-w-2xl mx-auto">
                A complete web design package from discovery to launch
              </p>
            </div>
            
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
              {[
                { title: "Strategy & Planning", desc: "We start by understanding your business, goals, and target audience" },
                { title: "Custom Design", desc: "Unique, on-brand visuals that set you apart from competitors" },
                { title: "Responsive Development", desc: "Works flawlessly on desktop, tablet, and mobile devices" },
                { title: "SEO Foundation", desc: "Built-in optimization to help you rank in search results" },
                { title: "Content Integration", desc: "Your text, images, and media professionally placed and formatted" },
                { title: "Training & Support", desc: "Learn how to update your site with our easy-to-use tools" },
              ].map((item, idx) => (
                <div key={idx} className="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow">
                  <div className="flex items-start gap-3">
                    <CheckCircle className="h-6 w-6 text-primary flex-shrink-0 mt-1" />
                    <div>
                      <h3 className="font-semibold text-lg text-gray-900 mb-2">{item.title}</h3>
                      <p className="text-gray-600 text-sm">{item.desc}</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </section>

          {/* Pricing Section */}
          <section id="pricing" className="mb-16 md:mb-24">
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold text-gray-900 mb-4">Website Design Packages</h2>
              <p className="text-lg text-gray-600 max-w-2xl mx-auto">
                Choose the package that fits your business needs
              </p>
            </div>
            
            <div className="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto">
              {WEB_DEVELOPMENT_TIERS.map((tier) => (
                <div
                  key={tier.id}
                  className={`bg-white rounded-2xl shadow-xl p-8 flex flex-col h-full ${
                    tier.popular ? 'ring-2 ring-primary scale-105' : ''
                  }`}
                >
                  {tier.popular && (
                    <div className="bg-primary text-white text-sm font-semibold px-3 py-1 rounded-full inline-block mb-4">
                      Most Popular
                    </div>
                  )}
                  <h3 className="text-2xl font-bold text-gray-900 mb-2">{tier.name}</h3>
                  <p className="text-gray-600 text-sm mb-6 min-h-[48px]">{tier.description}</p>
                  <div className="mb-6">
                    <div className="flex items-baseline gap-1">
                      <span className="text-4xl font-bold text-gray-900">${tier.price.toLocaleString()}</span>
                      <span className="text-gray-500 text-sm">one-time</span>
                    </div>
                  </div>
                  <ul className="space-y-3 mb-8 flex-1">
                    {tier.features.map((feature, idx) => (
                      <li key={idx} className="flex items-start gap-2">
                        <CheckCircle className="h-5 w-5 text-primary flex-shrink-0 mt-0.5" />
                        <span className="text-sm text-gray-700">{feature}</span>
                      </li>
                    ))}
                  </ul>
                  <ServiceCTAButtons
                    serviceId={tier.id}
                    price={tier.price}
                    serviceName={`Web Design - ${tier.name}`}
                    onScheduleClick={handleScheduleClick}
                    className="w-full mt-auto"
                  />
                </div>
              ))}
            </div>
          </section>

          {/* Website Maintenance Section */}
          <section className="mb-16 md:mb-24">
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold text-gray-900 mb-4">Keep Your Site Running Smoothly</h2>
              <p className="text-lg text-gray-600 max-w-2xl mx-auto">
                Monthly maintenance packages to keep your website secure, updated, and performing at its best
              </p>
            </div>
            
            <div className="grid md:grid-cols-4 gap-6 max-w-7xl mx-auto">
              {WEBSITE_MAINTENANCE_TIERS.map((tier) => (
                <div
                  key={tier.id}
                  className={`bg-white rounded-2xl shadow-xl p-6 flex flex-col h-full ${
                    tier.popular ? 'ring-2 ring-primary scale-105' : ''
                  }`}
                >
                  {tier.popular && (
                    <div className="bg-primary text-white text-xs font-semibold px-2 py-1 rounded-full inline-block mb-3">
                      Popular
                    </div>
                  )}
                  <h3 className="text-xl font-bold text-gray-900 mb-2">{tier.name}</h3>
                  <p className="text-gray-600 text-xs mb-4 min-h-[40px]">{tier.description}</p>
                  <div className="mb-4">
                    <div className="flex items-baseline gap-1">
                      <span className="text-3xl font-bold text-gray-900">${tier.price}</span>
                      <span className="text-gray-500 text-xs">/month</span>
                    </div>
                  </div>
                  <ul className="space-y-2 mb-6 flex-1">
                    {tier.features.map((feature, idx) => (
                      <li key={idx} className="flex items-start gap-2">
                        <CheckCircle className="h-4 w-4 text-primary flex-shrink-0 mt-0.5" />
                        <span className="text-xs text-gray-700">{feature}</span>
                      </li>
                    ))}
                  </ul>
                  <ServiceCTAButtons
                    serviceId={tier.id}
                    price={tier.price}
                    serviceName={`Website Maintenance - ${tier.name}`}
                    onScheduleClick={handleScheduleClick}
                    className="w-full mt-auto"
                  />
                </div>
              ))}
            </div>
          </section>

          {/* Final CTA Section */}
          <section id="ctaSection" className="bg-gradient-to-r from-primary to-purple-600 rounded-2xl p-12 text-center text-white">
            <h2 className="text-3xl md:text-4xl font-bold mb-4">Ready to Build Your Dream Website?</h2>
            <p className="text-lg md:text-xl mb-8 opacity-90 max-w-2xl mx-auto">
              Let's create a website that drives real results for your business. Schedule your free consultation today.
            </p>
            {showScheduler ? (
              <div className="max-w-4xl mx-auto bg-white rounded-lg p-4">
                <CalendlyScheduler url="https://calendly.com/cdmsuite/consultation" />
              </div>
            ) : (
              <Button
                size="lg"
                onClick={handleScheduleClick}
                className="bg-white text-primary hover:bg-gray-100 text-lg px-8 py-6"
              >
                Schedule Free Consultation
              </Button>
            )}
          </section>
        </div>
      </div>

      <Footer />
    </>
  );
}

// ==========================================
// File: app/services/website-fix/page.tsx
// ==========================================


import { Metadata } from 'next';
import Navigation from '@/components/navigation';
import Footer from '@/components/footer';
import WebsiteFixCheckout from '@/components/services/website-fix-checkout';

export const metadata: Metadata = {
  title: 'Website Performance Fix - $100/month | CDM Suite',
  description: 'Fix all critical website issues with our affordable $100/month service. Guaranteed 20+ point score improvement in 7 days.',
  keywords: 'website fix, website performance, website optimization, website improvement',
};

export default function WebsiteFixPage() {
  return (
    <main>
      <Navigation />
      <WebsiteFixCheckout />
      <Footer />
    </main>
  );
}

// ==========================================
// File: app/services/website-fix/success/page.tsx
// ==========================================


import { Metadata } from 'next';
import Navigation from '@/components/navigation';
import Footer from '@/components/footer';
import WebsiteFixSuccess from '@/components/services/website-fix-success';

export const metadata: Metadata = {
  title: 'Thank You! | CDM Suite',
  description: 'Your website fix service subscription is confirmed.',
};

export default function WebsiteFixSuccessPage() {
  return (
    <main>
      <Navigation />
      <WebsiteFixSuccess />
      <Footer />
    </main>
  );
}

// ==========================================
// File: app/services/[slug]/page.tsx
// ==========================================


import { notFound } from "next/navigation";
import { prisma } from "@/lib/db";
import ServicePageClient from "@/components/service-page-client";

// Generate static paths for all services
export async function generateStaticParams() {
  // Avoid hitting the database during static generation to keep builds independent
  // of database availability. Service pages will be generated on-demand.
  return [];
}

// Fetch service data
async function getService(slug: string) {
  const service = await prisma.service.findUnique({
    where: { slug },
  });

  if (!service) {
    notFound();
  }

  return service;
}

export async function generateMetadata({ params }: { params: { slug: string } }) {
  const service = await getService(params.slug);

  return {
    title: `${service.name} | CDM Suite`,
    description: service.description,
  };
}

export default async function ServicePage({ params }: { params: { slug: string } }) {
  const service = await getService(params.slug);

  // Determine which hero image to use based on service slug
  const getHeroImage = (slug: string) => {
    if (slug.includes('website-maintenance')) return '/images/services/website-maintenance.png';
    if (slug.includes('website-creation')) return '/images/services/website-creation.png';
    if (slug.includes('seo')) return '/images/services/seo-services.png';
    if (slug.includes('social-media')) return '/images/services/social-media.png';
    if (slug.includes('ad-management')) return 'https://cdn.abacus.ai/images/c5dbf003-c21d-46d9-bde2-ea94af97ab30.png';
    if (slug.includes('app-creation')) return '/images/services/app-creation.png';
    if (slug.includes('app-maintenance')) return '/images/services/app-maintenance.png';
    if (slug.includes('bundle')) return '/images/services/bundles.png';
    return '/images/services/website-creation.png'; // default
  };

  // Determine service category for customized content
  const getServiceCategory = (slug: string) => {
    if (slug.includes('website-maintenance')) return 'website-maintenance';
    if (slug.includes('website-creation')) return 'website-creation';
    if (slug.includes('seo')) return 'seo';
    if (slug.includes('social-media')) return 'social-media';
    if (slug.includes('ad-management')) return 'ad-management';
    if (slug.includes('app-creation')) return 'app-creation';
    if (slug.includes('app-maintenance')) return 'app-maintenance';
    if (slug.includes('bundle')) return 'bundle';
    return 'general';
  };

  const heroImage = getHeroImage(service.slug);
  const category = getServiceCategory(service.slug);

  return (
    <ServicePageClient
      service={{
        ...service,
        features: JSON.parse(service.features) // Parse JSON string to string[]
      }}
      heroImage={heroImage}
      category={category}
    />
  );
}

// ==========================================
// File: app/site/[subdomain]/page.tsx
// ==========================================


import { notFound } from "next/navigation";
import { prisma } from "@/lib/db";
import { WebsiteRenderer } from "@/components/builder/website-renderer";

interface SitePageProps {
  params: {
    subdomain: string;
  };
  searchParams: {
    page?: string;
  };
}

export async function generateMetadata({ params, searchParams }: SitePageProps) {
  const project = await prisma.project.findFirst({
    where: { subdomain: params.subdomain },
  });

  if (!project) {
    return {
      title: "Website Not Found",
    };
  }

  const siteConfig = project.siteConfig ? JSON.parse(project.siteConfig) : {};
  const pages = project.pages ? JSON.parse(project.pages) : [];
  const currentPageSlug = searchParams.page || "home";
  const currentPage = pages.find((p: any) => p.slug === currentPageSlug);

  return {
    title: currentPage?.metaTitle || siteConfig.siteName || "Website",
    description: currentPage?.metaDescription || siteConfig.seo?.metaDescription || "",
  };
}

export default async function SitePage({ params, searchParams }: SitePageProps) {
  const project = await prisma.project.findFirst({
    where: { subdomain: params.subdomain },
  });

  if (!project) {
    notFound();
  }

  const pages = project.pages ? JSON.parse(project.pages) : [];
  const siteConfig = project.siteConfig ? JSON.parse(project.siteConfig) : {};
  const navigationConfig = project.navigationConfig ? JSON.parse(project.navigationConfig) : null;
  const globalStyles = project.globalStyles ? JSON.parse(project.globalStyles) : null;
  
  const currentPageSlug = searchParams.page || "home";
  const currentPage = pages.find((p: any) => p.slug === currentPageSlug);

  if (!currentPage) {
    notFound();
  }

  return (
    <WebsiteRenderer
      page={currentPage}
      pages={pages}
      siteConfig={siteConfig}
      subdomain={params.subdomain}
      navigationConfig={navigationConfig}
      globalStyles={globalStyles}
    />
  );
}

// ==========================================
// File: app/site/[subdomain]/robots.txt/route.ts
// ==========================================


import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/db";
import { generateRobotsTxt } from "@/lib/builder/sitemap-generator";

export const dynamic = 'force-dynamic';

export async function GET(
  request: NextRequest,
  { params }: { params: { subdomain: string } }
) {
  try {
    const { subdomain } = params;

    const project = await prisma.project.findFirst({
      where: { subdomain },
      select: { 
        subdomain: true, 
        customDomain: true,
      },
    });

    if (!project || !project.subdomain) {
      return new NextResponse("Website not found", { status: 404 });
    }

    const baseUrl = project.customDomain 
      ? `https://${project.customDomain}`
      : undefined;
    
    const robotsTxt = generateRobotsTxt(project.subdomain, baseUrl);

    return new NextResponse(robotsTxt, {
      headers: {
        'Content-Type': 'text/plain',
        'Cache-Control': 'public, max-age=86400', // Cache for 24 hours
      },
    });
  } catch (error) {
    console.error("Robots.txt error:", error);
    return new NextResponse("Error generating robots.txt", { status: 500 });
  }
}

// ==========================================
// File: app/site/[subdomain]/sitemap.xml/route.ts
// ==========================================


import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/db";
import { generateSitemap } from "@/lib/builder/sitemap-generator";

export const dynamic = 'force-dynamic';

export async function GET(
  request: NextRequest,
  { params }: { params: { subdomain: string } }
) {
  try {
    const { subdomain } = params;

    const project = await prisma.project.findFirst({
      where: { subdomain },
      select: { 
        subdomain: true, 
        customDomain: true,
        pages: true,
        navigationConfig: true,
      },
    });

    if (!project || !project.subdomain) {
      return new NextResponse("Website not found", { status: 404 });
    }

    const pages = project.pages ? JSON.parse(project.pages) : [];
    const navigationConfig = project.navigationConfig 
      ? JSON.parse(project.navigationConfig)
      : null;

    // Filter hidden pages
    const visiblePages = pages.filter((page: any) => {
      if (navigationConfig && navigationConfig.hiddenPages) {
        return !navigationConfig.hiddenPages.includes(page.slug);
      }
      return !page.hidden; // Fallback to page-level hidden flag
    });

    const baseUrl = project.customDomain 
      ? `https://${project.customDomain}`
      : undefined;
    
    const sitemapXml = generateSitemap(
      project.subdomain, 
      visiblePages,
      baseUrl
    );

    return new NextResponse(sitemapXml, {
      headers: {
        'Content-Type': 'application/xml',
        'Cache-Control': 'public, max-age=86400', // Cache for 24 hours
      },
    });
  } catch (error) {
    console.error("Sitemap error:", error);
    return new NextResponse("Error generating sitemap", { status: 500 });
  }
}

// ==========================================
// File: app/sitemap.ts
// ==========================================


import { MetadataRoute } from 'next';
import { prisma } from '@/lib/db';

export const revalidate = 3600; // Revalidate every hour

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const baseUrl = 'https://cdmsuite.com';
  
  // Static pages with high priority
  const staticPages = [
    {
      url: baseUrl,
      lastModified: new Date(),
      changeFrequency: 'daily' as const,
      priority: 1,
    },
    {
      url: `${baseUrl}/about`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.8,
    },
    {
      url: `${baseUrl}/contact`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.8,
    },
    {
      url: `${baseUrl}/services`,
      lastModified: new Date(),
      changeFrequency: 'weekly' as const,
      priority: 0.9,
    },
    {
      url: `${baseUrl}/pricing`,
      lastModified: new Date(),
      changeFrequency: 'weekly' as const,
      priority: 0.9,
    },
    {
      url: `${baseUrl}/blog`,
      lastModified: new Date(),
      changeFrequency: 'daily' as const,
      priority: 0.9,
    },
    {
      url: `${baseUrl}/case-studies`,
      lastModified: new Date(),
      changeFrequency: 'weekly' as const,
      priority: 0.8,
    },
    {
      url: `${baseUrl}/tools`,
      lastModified: new Date(),
      changeFrequency: 'weekly' as const,
      priority: 0.8,
    },
    // Auth pages (lower priority)
    {
      url: `${baseUrl}/auth/login`,
      lastModified: new Date(),
      changeFrequency: 'yearly' as const,
      priority: 0.3,
    },
    {
      url: `${baseUrl}/auth/signup`,
      lastModified: new Date(),
      changeFrequency: 'yearly' as const,
      priority: 0.3,
    },
    // Marketing assessment
    {
      url: `${baseUrl}/marketing-assessment`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.9,
    },
    // Free tools
    {
      url: `${baseUrl}/tools/seo-checker`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.7,
    },
    {
      url: `${baseUrl}/tools/roi-calculator`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.7,
    },
    {
      url: `${baseUrl}/tools/budget-calculator`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.7,
    },
    {
      url: `${baseUrl}/tools/website-auditor`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.8,
    },
    {
      url: `${baseUrl}/tools/conversion-analyzer`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.7,
    },
    {
      url: `${baseUrl}/tools/email-tester`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.7,
    },
    {
      url: `${baseUrl}/tools/website-need-checker`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.8,
    },
    // Auditor
    {
      url: `${baseUrl}/auditor`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.8,
    },
    // Builder
    {
      url: `${baseUrl}/builder`,
      lastModified: new Date(),
      changeFrequency: 'monthly' as const,
      priority: 0.8,
    },
    // Legal pages
    {
      url: `${baseUrl}/privacy`,
      lastModified: new Date(),
      changeFrequency: 'yearly' as const,
      priority: 0.3,
    },
    {
      url: `${baseUrl}/terms`,
      lastModified: new Date(),
      changeFrequency: 'yearly' as const,
      priority: 0.3,
    },
  ];

  // Get all published blog posts
  const blogPosts = await prisma.blogPost.findMany({
    where: {
      status: 'published',
    },
    select: {
      slug: true,
      updatedAt: true,
    },
    orderBy: {
      updatedAt: 'desc',
    },
  }).catch(() => []);

  const blogPages = blogPosts.map((post: { slug: string; updatedAt: Date }) => ({
    url: `${baseUrl}/blog/${post.slug}`,
    lastModified: post.updatedAt,
    changeFrequency: 'monthly' as const,
    priority: 0.7,
  }));

  // Get all case studies
  const caseStudies = await prisma.caseStudy.findMany({
    where: {
      status: 'published',
    },
    select: {
      slug: true,
      updatedAt: true,
    },
    orderBy: {
      updatedAt: 'desc',
    },
  }).catch(() => []);

  const caseStudyPages = caseStudies.map((study: { slug: string; updatedAt: Date }) => ({
    url: `${baseUrl}/case-studies/${study.slug}`,
    lastModified: study.updatedAt,
    changeFrequency: 'monthly' as const,
    priority: 0.7,
  }));

  // Get all services
  const services = await prisma.service.findMany({
    where: {
      active: true,
    },
    select: {
      slug: true,
      updatedAt: true,
    },
  }).catch(() => []);

  const servicePages = services.map((service: { slug: string; updatedAt: Date }) => ({
    url: `${baseUrl}/services/${service.slug}`,
    lastModified: service.updatedAt,
    changeFrequency: 'monthly' as const,
    priority: 0.8,
  }));

  // Get all custom pages from page builder
  const customPages = await prisma.customPage.findMany({
    where: {
      status: 'published',
    },
    select: {
      slug: true,
      updatedAt: true,
    },
  }).catch(() => []);

  const customPageEntries = customPages.map((page: { slug: string; updatedAt: Date }) => ({
    url: `${baseUrl}/${page.slug}`,
    lastModified: page.updatedAt,
    changeFrequency: 'monthly' as const,
    priority: 0.6,
  }));

  // Combine all pages
  return [
    ...staticPages,
    ...blogPages,
    ...caseStudyPages,
    ...servicePages,
    ...customPageEntries,
  ];
}

// ==========================================
// File: app/success/page.tsx
// ==========================================


'use client';

import { useEffect, useState, Suspense } from 'react';
import { useSearchParams } from 'next/navigation';
import { motion } from 'framer-motion';
import { CheckCircle, ArrowRight, LogIn, Mail } from 'lucide-react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { trackRedditPurchase } from '@/lib/reddit-tracking';
import { trackConversion } from '@/lib/analytics';

function SuccessContent() {
  const searchParams = useSearchParams();
  const sessionId = searchParams.get('session_id');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (sessionId) {
      // Track purchase conversion - dual tracking (client-side + server-side)
      // Value should be fetched from Stripe session in production
      trackRedditPurchase(0, 'USD');
      
      trackConversion('purchase', undefined, 'USD', {
        transactionId: sessionId,
      });
      
      // Verify session and update order status if needed
      setLoading(false);
    }
  }, [sessionId]);

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white dark:from-gray-900 dark:to-gray-800 flex items-center justify-center px-4">
      <motion.div
        initial={{ opacity: 0, scale: 0.9 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{ duration: 0.5 }}
        className="max-w-2xl w-full text-center"
      >
        <motion.div
          initial={{ scale: 0 }}
          animate={{ scale: 1 }}
          transition={{ delay: 0.2, type: 'spring', stiffness: 200 }}
          className="mb-8"
        >
          <CheckCircle className="w-24 h-24 text-green-500 mx-auto" />
        </motion.div>

        <h1 className="text-4xl sm:text-5xl font-bold mb-4">Payment Successful!</h1>
        <p className="text-xl text-gray-600 dark:text-gray-300 mb-8">
          Thank you for choosing CDM Suite. Your account has been created and you can now access your dashboard.
        </p>

        {/* Account Created Notice */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.4 }}
          className="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-6 mb-8 border border-blue-200 dark:border-blue-800"
        >
          <div className="flex items-center justify-center gap-2 mb-3">
            <Mail className="h-5 w-5 text-blue-600" />
            <h2 className="text-lg font-semibold text-blue-900 dark:text-blue-100">
              Your Account is Ready!
            </h2>
          </div>
          <p className="text-gray-700 dark:text-gray-300 mb-4">
            We've created your client account and sent your login credentials to your email. 
            Check your inbox (and spam folder) for your temporary password.
          </p>
          <Link href="/auth/login">
            <Button className="bg-blue-600 hover:bg-blue-700 gap-2">
              <LogIn className="h-4 w-4" />
              Log In to Dashboard
            </Button>
          </Link>
        </motion.div>

        <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6 mb-8">
          <h2 className="text-lg font-semibold mb-2">What happens next?</h2>
          <ul className="text-left space-y-2 text-gray-700 dark:text-gray-300">
            <li>âœ… Check your email for login credentials</li>
            <li>âœ… Log in to view your order status and service details</li>
            <li>âœ… Our team will reach out within 24 hours to schedule a kickoff call</li>
            <li>âœ… We'll begin the discovery phase and start bringing your vision to life</li>
          </ul>
        </div>

        <div className="flex gap-4 justify-center flex-wrap">
          <Link href="/">
            <Button variant="outline" size="lg">
              Back to Home
            </Button>
          </Link>
          <Link href="/dashboard/my-services">
            <Button size="lg" className="gap-2">
              View My Services
              <ArrowRight className="w-4 h-4" />
            </Button>
          </Link>
          <Link href="/contact">
            <Button variant="outline" size="lg" className="gap-2">
              Contact Us
            </Button>
          </Link>
        </div>

        {sessionId && (
          <p className="text-sm text-gray-500 dark:text-gray-400 mt-8">
            Order ID: {sessionId}
          </p>
        )}
      </motion.div>
    </div>
  );
}

export default function SuccessPage() {
  return (
    <Suspense fallback={
      <div className="flex items-center justify-center min-h-screen">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    }>
      <SuccessContent />
    </Suspense>
  );
}

// ==========================================
// File: app/terms/page.tsx
// ==========================================


import { Metadata } from "next";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";
import { Shield, FileText, CheckCircle } from "lucide-react";

export const metadata: Metadata = {
  title: "Terms of Service | CDM Suite",
  description: "Read CDM Suite's Terms of Service and understand our policies",
};

export default function TermsPage() {
  return (
    <>
      <Navigation />
      <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
        <div className="section-container py-20">
          <div className="max-w-4xl mx-auto">
            {/* Header */}
            <div className="text-center mb-12">
              <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-secondary to-accent rounded-2xl mb-6">
                <FileText className="w-8 h-8 text-white" />
              </div>
              <h1 className="text-4xl lg:text-5xl font-bold text-gray-900 mb-4">
                Terms of Service
              </h1>
              <p className="text-lg text-gray-600">
                Last updated: October 13, 2025
              </p>
            </div>

            {/* Content */}
            <div className="bg-white rounded-2xl shadow-xl p-8 lg:p-12 space-y-8">
              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <CheckCircle className="w-6 h-6 text-accent" />
                  1. Agreement to Terms
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  By accessing and using CDM Suite's services, you agree to be bound by these Terms of Service 
                  and all applicable laws and regulations. If you do not agree with any of these terms, you are 
                  prohibited from using or accessing this site and our services.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  2. Services Description
                </h2>
                <p className="text-gray-600 leading-relaxed mb-4">
                  CDM Suite provides digital marketing services including but not limited to:
                </p>
                <ul className="list-disc list-inside space-y-2 text-gray-600 ml-4">
                  <li>Website design and development</li>
                  <li>Mobile app development</li>
                  <li>Search Engine Optimization (SEO)</li>
                  <li>Social media marketing and management</li>
                  <li>Digital advertising campaigns</li>
                  <li>Content creation and strategy</li>
                  <li>Marketing automation and analytics</li>
                </ul>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  3. User Accounts
                </h2>
                <p className="text-gray-600 leading-relaxed mb-4">
                  When you create an account with us, you must provide accurate, complete, and current information. 
                  You are responsible for:
                </p>
                <ul className="list-disc list-inside space-y-2 text-gray-600 ml-4">
                  <li>Maintaining the confidentiality of your account credentials</li>
                  <li>All activities that occur under your account</li>
                  <li>Notifying us immediately of any unauthorized access</li>
                  <li>Ensuring your contact information is current</li>
                </ul>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  4. Payment Terms
                </h2>
                <p className="text-gray-600 leading-relaxed mb-4">
                  Payment for services is due according to your selected subscription plan:
                </p>
                <ul className="list-disc list-inside space-y-2 text-gray-600 ml-4">
                  <li>Monthly subscriptions are billed on a recurring basis</li>
                  <li>All payments are final and non-refundable</li>
                  <li>Prices may change with 30 days notice</li>
                  <li>Payment must be made through our approved payment processors</li>
                  <li>Failed payments may result in service suspension</li>
                </ul>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  5. Cancellation and Payment Policy
                </h2>
                <p className="text-gray-600 leading-relaxed mb-4">
                  You may cancel your subscription at any time. Cancellations take effect at the end of the current 
                  billing period. All payments are final and non-refundable. For services with a trial period, you may 
                  cancel during the trial period without charge.
                </p>
                <p className="text-gray-600 leading-relaxed">
                  We are committed to your satisfaction and will work with you to ensure you achieve the results you're 
                  looking for. If you have concerns about our services, please contact us so we can address them directly.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  6. Intellectual Property
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  All content, features, and functionality of CDM Suite's services are owned by CDM Suite and 
                  protected by international copyright, trademark, and other intellectual property laws. Work 
                  products created for you become your property upon full payment, unless otherwise specified in 
                  your service agreement.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  7. Limitation of Liability
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  CDM Suite shall not be liable for any indirect, incidental, special, consequential, or punitive 
                  damages resulting from your use of or inability to use the service. Our total liability shall not 
                  exceed the amount you paid for the service in the past 12 months.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  8. Service Modifications
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  We reserve the right to modify or discontinue, temporarily or permanently, the service with or 
                  without notice. We shall not be liable to you or any third party for any modification, suspension, 
                  or discontinuance of the service.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  9. Acceptable Use Policy
                </h2>
                <p className="text-gray-600 leading-relaxed mb-4">
                  You agree not to use our services to:
                </p>
                <ul className="list-disc list-inside space-y-2 text-gray-600 ml-4">
                  <li>Violate any laws or regulations</li>
                  <li>Infringe on intellectual property rights</li>
                  <li>Transmit harmful or malicious code</li>
                  <li>Engage in spam or unsolicited communications</li>
                  <li>Impersonate others or misrepresent your affiliation</li>
                </ul>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  10. Privacy
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  Your use of our services is also governed by our Privacy Policy. Please review our Privacy Policy 
                  to understand our practices regarding the collection and use of your personal information.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  11. Governing Law
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  These Terms shall be governed by and construed in accordance with the laws of the State of 
                  New Jersey, United States, without regard to its conflict of law provisions.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  12. Changes to Terms
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  We reserve the right to update these Terms of Service at any time. We will notify you of any 
                  changes by posting the new Terms on this page and updating the "Last updated" date. Your continued 
                  use of the service after changes become effective constitutes acceptance of the updated terms.
                </p>
              </section>

              <section>
                <h2 className="text-2xl font-bold text-gray-900 mb-4">
                  13. Contact Information
                </h2>
                <p className="text-gray-600 leading-relaxed">
                  If you have any questions about these Terms of Service, please contact us:
                </p>
                <div className="mt-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg">
                  <p className="text-gray-700 font-medium">CDM Suite</p>
                  <p className="text-gray-600">Phone: (862) 272-7623</p>
                  <p className="text-gray-600">Email: support@cdmsuite.com</p>
                </div>
              </section>
            </div>
          </div>
        </div>
      </div>
      <Footer />
    </>
  );
}

// ==========================================
// File: app/tools/budget-calculator/page.tsx
// ==========================================


import { Metadata } from "next";
import BudgetCalculatorLanding from "@/components/tools/budget-calculator-landing";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";

export const metadata: Metadata = {
  title: "Free Marketing Budget Calculator | Plan Your Marketing Spend | CDM Suite",
  description: "Calculate your ideal marketing budget based on revenue and growth goals. Get channel allocation recommendations and ROI projections. Free professional tool.",
  keywords: "marketing budget calculator, budget planning, marketing spend, roi calculator, channel allocation",
};

export default function BudgetCalculatorPage() {
  return (
    <>
      <Navigation />
      <BudgetCalculatorLanding />
      <Footer />
    </>
  );
}

// ==========================================
// File: app/tools/conversion-analyzer/page.tsx
// ==========================================


import { Metadata } from "next";
import ConversionAnalyzerLanding from "@/components/tools/conversion-analyzer-landing";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";

export const metadata: Metadata = {
  title: "Free Conversion Rate Analyzer | Optimize Your Funnel | CDM Suite",
  description: "Analyze your conversion funnel and identify drop-off points. Get actionable insights to increase conversions and revenue. Free professional analysis tool.",
  keywords: "conversion rate analyzer, funnel analysis, conversion optimization, cro tool, funnel optimizer",
};

export default function ConversionAnalyzerPage() {
  return (
    <>
      <Navigation />
      <ConversionAnalyzerLanding />
      <Footer />
    </>
  );
}

// ==========================================
// File: app/tools/email-tester/page.tsx
// ==========================================


import { Metadata } from "next";
import EmailTesterLanding from "@/components/tools/email-tester-landing";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";

export const metadata: Metadata = {
  title: "Free Email Subject Line Tester | Predict Open Rates | CDM Suite",
  description: "Test your email subject lines before sending. Get open rate predictions, spam scores, and best practice recommendations. Optimize your email marketing.",
  keywords: "email subject line tester, email marketing tool, open rate predictor, spam score checker, email optimizer",
};

export default function EmailTesterPage() {
  return (
    <>
      <Navigation />
      <EmailTesterLanding />
      <Footer />
    </>
  );
}

// ==========================================
// File: app/tools/page.tsx
// ==========================================


import { Metadata } from "next";
import FreeToolsHub from "@/components/tools/free-tools-hub";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";

export const metadata: Metadata = {
  title: "Free Digital Marketing Tools | CDM Suite",
  description: "Access powerful free tools to grow your business. ROI calculators, website auditors, SEO checkers, and more professional marketing tools at no cost.",
  keywords: "free marketing tools, roi calculator, website audit, seo checker, digital marketing tools",
};

export default function FreeToolsPage() {
  return (
    <>
      <Navigation />
      <FreeToolsHub />
      <Footer />
    </>
  );
}

// ==========================================
// File: app/tools/roi-calculator/page.tsx
// ==========================================


import { Metadata } from "next";
import ROICalculatorLanding from "@/components/tools/roi-calculator-landing";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";

export const metadata: Metadata = {
  title: "Free ROI Calculator | Predict Your Marketing Revenue | CDM Suite",
  description: "Calculate your potential return on investment with professional digital marketing. Get instant revenue projections based on conservative industry benchmarks. Free tool, no signup required.",
  keywords: "roi calculator, marketing roi, revenue calculator, digital marketing roi, business growth calculator",
};

export default function ROICalculatorPage() {
  return (
    <>
      <Navigation />
      <ROICalculatorLanding />
      <Footer />
    </>
  );
}

// ==========================================
// File: app/tools/seo-checker/page.tsx
// ==========================================


import { Metadata } from "next";
import SEOCheckerLanding from "@/components/tools/seo-checker-landing";
import Navigation from "@/components/navigation";
import Footer from "@/components/footer";

export const metadata: Metadata = {
  title: "Free SEO Checker Tool | Analyze & Improve Your Rankings | CDM Suite",
  description: "Check your website's SEO health in seconds. Get actionable insights on keywords, meta tags, backlinks, and technical SEO. Free professional analysis.",
  keywords: "seo checker, seo analysis, seo audit, keyword checker, meta tags analyzer, seo tool",
};

export default function SEOCheckerPage() {
  return (
    <>
      <Navigation />
      <SEOCheckerLanding />
      <Footer />
    </>
  );
}

// ==========================================
// File: app/tools/website-auditor/page.tsx
// ==========================================


import { redirect } from 'next/navigation';

export const metadata = {
  title: "Redirecting to Website Auditor | CDM Suite",
};

export default function WebsiteAuditorRedirect() {
  // Redirect to the main auditor page
  redirect('/auditor');
}

// ==========================================
// File: app/tools/website-need-checker/page.tsx
// ==========================================


import { Metadata } from 'next';
import WebsiteNeedCheckerLanding from '@/components/tools/website-need-checker-landing';

export const metadata: Metadata = {
  title: 'Free Website Need Checker | Does Your Business Need a Website? | CDM Suite',
  description: 'Discover if your business needs a website with our free assessment tool. Calculate the ROI and business value of having an online presence. Get personalized recommendations and instant website solutions.',
  keywords: 'website need assessment, business website calculator, website ROI calculator, do I need a website, website value calculator, online presence assessment',
  openGraph: {
    title: 'Free Website Need Checker - Calculate Your Website ROI',
    description: 'Find out if your business needs a website and calculate the potential ROI. Get instant recommendations and solutions.',
    type: 'website',
  },
};

export default function WebsiteNeedCheckerPage() {
  return <WebsiteNeedCheckerLanding />;
}

// ==========================================
// File: app/[slug]/page.tsx
// ==========================================


import { prisma } from '@/lib/db';
import { notFound } from 'next/navigation';
import { SectionPreview } from '@/components/page-builder/section-preview';
import { Section } from '@/lib/page-templates';
import type { Metadata } from 'next';

interface PageProps {
  params: { slug: string };
}

export async function generateMetadata({ params }: PageProps): Promise<Metadata> {
  const page = await prisma.customPage.findUnique({
    where: {
      slug: params.slug,
      status: 'published',
    },
  });

  if (!page) {
    return {
      title: 'Page Not Found',
    };
  }

  return {
    title: page.metaTitle || page.title,
    description: page.metaDescription || page.description || undefined,
    openGraph: {
      title: page.metaTitle || page.title,
      description: page.metaDescription || page.description || undefined,
      ...(page.ogImage && { images: [page.ogImage] }),
    },
  };
}

export default async function CustomPage({ params }: PageProps) {
  const page = await prisma.customPage.findUnique({
    where: {
      slug: params.slug,
      status: 'published',
    },
  });

  if (!page) {
    notFound();
  }

  let sections: Section[] = [];

  try {
    const content = JSON.parse(page.content);
    sections = content.sections || [];
  } catch (error) {
    console.error('Error parsing page content:', error);
  }

  return (
    <div className="min-h-screen">
      {sections.map((section) => (
        <SectionPreview key={section.id} section={section} />
      ))}
      
      {sections.length === 0 && (
        <div className="container mx-auto py-20 text-center">
          <h1 className="text-4xl font-bold mb-4">{page.title}</h1>
          {page.description && (
            <p className="text-lg text-muted-foreground">{page.description}</p>
          )}
        </div>
      )}
    </div>
  );
}
