
// ==========================================
// File: lib/ai-sequence-generator.ts
// ==========================================


// AI-powered sequence generation using Abacus AI

interface LeadContext {
  name?: string;
  email: string;
  company?: string;
  interest?: string;
  budget?: string;
  timeline?: string;
  source?: string;
  score?: number;
  preferredChannels?: string; // User's preference for communication
}

interface GeneratedSequence {
  name: string;
  description: string;
  type: 'email' | 'sms' | 'task' | 'mixed';
  targetAudience: string;
  steps: any[];
  aiPrompt: string;
  reasoning: string;
}

export async function generateSequenceForLead(
  leadContext: LeadContext,
  preferredType?: 'email' | 'sms' | 'task' | 'mixed'
): Promise<GeneratedSequence> {
  try {
    const prompt = buildSequencePrompt(leadContext, preferredType);

    const response = await fetch('/api/ai/generate-sequence', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ leadContext, prompt, preferredType }),
    });

    if (!response.ok) {
      throw new Error('Failed to generate sequence');
    }

    return await response.json();
  } catch (error) {
    console.error('AI sequence generation error:', error);
    throw error;
  }
}

export async function suggestNextStep(
  sequenceId: string,
  currentSteps: any[],
  leadContext: LeadContext
): Promise<any> {
  try {
    const response = await fetch('/api/ai/suggest-step', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sequenceId, currentSteps, leadContext }),
    });

    if (!response.ok) {
      throw new Error('Failed to suggest step');
    }

    return await response.json();
  } catch (error) {
    console.error('AI step suggestion error:', error);
    throw error;
  }
}

export async function optimizeSequenceTiming(
  sequenceId: string,
  performanceData: any
): Promise<any> {
  try {
    const response = await fetch('/api/ai/optimize-sequence', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sequenceId, performanceData }),
    });

    if (!response.ok) {
      throw new Error('Failed to optimize sequence');
    }

    return await response.json();
  } catch (error) {
    console.error('AI sequence optimization error:', error);
    throw error;
  }
}

function buildSequencePrompt(
  leadContext: LeadContext,
  preferredType?: 'email' | 'sms' | 'task' | 'mixed'
): string {
  const type = preferredType || 'email';
  
  // Build channel-specific instructions
  let channelInstructions = '';
  let stepExample: any = {};
  
  if (type === 'email') {
    channelInstructions = `Create a multi-step EMAIL sequence that:
1. Welcomes the lead and acknowledges their interest
2. Provides value through relevant content or insights
3. Addresses potential concerns or questions
4. Encourages engagement with a clear call-to-action
5. Follows up appropriately based on response (or lack thereof)

Each email step should include:
- Compelling subject line (70 characters or less)
- Personalized email content (professional yet approachable tone)
- Appropriate delay timing (consider business hours and response patterns)
- Clear next action`;

    stepExample = {
      order: 1,
      stepType: 'email',
      title: 'Step title',
      subject: 'Email subject line (max 70 chars)',
      content: 'Email body with personalization tokens like {{firstName}}',
      delayAmount: 0,
      delayUnit: 'hours',
      delayFrom: 'start',
      aiReasoning: 'Why this step is included'
    };
  } else if (type === 'sms') {
    channelInstructions = `Create a multi-step SMS sequence that:
1. Welcomes the lead with a brief, friendly message
2. Provides immediate value or quick tips
3. Encourages engagement with simple CTAs
4. Follows up with timely, concise messages

Each SMS step should include:
- Brief, conversational content (160 characters or less for single SMS)
- Direct and clear call-to-action
- Appropriate delay timing (avoid late nights/early mornings)
- Personalization where possible
- Consider SMS best practices (no spam, clear opt-out)`;

    stepExample = {
      order: 1,
      stepType: 'sms',
      title: 'Step title',
      content: 'SMS content - keep it under 160 characters, personalized like: Hi {{firstName}}! Thanks for reaching out. Ready to chat? Reply YES',
      delayAmount: 0,
      delayUnit: 'hours',
      delayFrom: 'start',
      aiReasoning: 'Why this SMS is included'
    };
  } else if (type === 'mixed') {
    channelInstructions = `Create a multi-channel MIXED sequence that combines EMAIL and SMS for maximum engagement:
1. Start with the most appropriate channel based on urgency and content length
2. Mix channels strategically (e.g., email for detailed info, SMS for quick reminders)
3. Use SMS for time-sensitive or action-oriented messages
4. Use email for value-driven, detailed content
5. Create a cohesive journey across all channels

Guidelines:
- EMAIL: Detailed content, value propositions, case studies, long-form
- SMS: Quick check-ins, reminders, urgent CTAs, appointment confirmations
- Alternate channels thoughtfully (don't overwhelm with same channel)
- Consider the lead's response pattern and preferences`;

    stepExample = {
      order: 1,
      stepType: 'email', // or 'sms'
      title: 'Step title',
      subject: 'Email subject (only for email steps)',
      content: 'Content appropriate for the channel type',
      delayAmount: 0,
      delayUnit: 'hours',
      delayFrom: 'start',
      aiReasoning: 'Why this channel and message at this point'
    };
  }

  return `
Generate a personalized lead nurture sequence for the following lead:

Name: ${leadContext.name || 'Unknown'}
Email: ${leadContext.email}
Company: ${leadContext.company || 'Not provided'}
Interest: ${leadContext.interest || 'General services'}
Budget: ${leadContext.budget || 'Not specified'}
Timeline: ${leadContext.timeline || 'Not specified'}
Source: ${leadContext.source || 'Unknown'}
Lead Score: ${leadContext.score || 0}/100
Preferred Channels: ${leadContext.preferredChannels || 'No preference'}

${channelInstructions}

IMPORTANT: The sequence type MUST be "${type}". All steps must align with this type.
${type === 'mixed' ? 'For mixed sequences, strategically combine email and sms steps.' : ''}

Make the tone professional yet approachable, and ensure the content aligns with CDM Suite's services in digital marketing, web development, and business growth.

Return the sequence in JSON format with the following structure:
{
  "name": "Sequence name",
  "description": "Brief description of the sequence strategy",
  "type": "${type}",
  "targetAudience": "new_lead",
  "steps": [
    ${JSON.stringify(stepExample, null, 2)}
  ],
  "reasoning": "Overall strategy explanation - why this channel mix/type and approach"
}

Create 3-5 highly effective steps that will convert this lead.
  `.trim();
}

export function getDefaultSequenceTemplate(type: string): any[] {
  const templates: Record<string, any[]> = {
    new_lead: [
      {
        order: 1,
        stepType: 'email',
        title: 'Welcome Email',
        subject: 'Thanks for your interest, {{firstName}}!',
        content: `Hi {{firstName}},\n\nThank you for reaching out to CDM Suite! We're excited to help you achieve your digital marketing goals.\n\nI wanted to personally introduce myself and let you know that we've received your inquiry about {{serviceType}}.\n\nTo better understand your needs, I'd love to schedule a quick 15-minute call this week. What day works best for you?\n\nLooking forward to connecting!\n\nBest regards,\n{{assignedTo}}`,
        delayAmount: 0,
        delayUnit: 'hours',
        delayFrom: 'start',
        aiSuggested: false,
      },
      {
        order: 2,
        stepType: 'email',
        title: 'Value Email',
        subject: 'Quick tip for {{company}}',
        content: `Hi {{firstName}},\n\nI wanted to share a quick insight that could help {{company}} right away.\n\n[Personalized tip based on their interest]\n\nHave you had a chance to think about that call we discussed? I have a few slots open this week if you'd like to chat.\n\nBest,\n{{assignedTo}}`,
        delayAmount: 2,
        delayUnit: 'days',
        delayFrom: 'previous',
        aiSuggested: false,
      },
      {
        order: 3,
        stepType: 'email',
        title: 'Last Follow-up',
        subject: 'Checking in one last time',
        content: `Hi {{firstName}},\n\nI wanted to reach out one more time to see if you're still interested in improving your digital presence.\n\nIf now isn't the right time, no worries at all! Feel free to reach out whenever you're ready.\n\nIf you are interested, just reply to this email and we'll get started.\n\nBest,\n{{assignedTo}}`,
        delayAmount: 3,
        delayUnit: 'days',
        delayFrom: 'previous',
        aiSuggested: false,
      },
    ],
    consultation_scheduled: [
      {
        order: 1,
        stepType: 'email',
        title: 'Consultation Confirmation',
        subject: 'Your consultation is confirmed',
        content: `Hi {{firstName}},\n\nGreat! Your consultation is confirmed for [DATE/TIME].\n\nTo make the most of our time together, please review:\n1. Your current digital marketing challenges\n2. Your goals for the next 6-12 months\n3. Any specific questions you have\n\nI'll send you a calendar invite shortly.\n\nSee you soon!\n{{assignedTo}}`,
        delayAmount: 0,
        delayUnit: 'hours',
        delayFrom: 'start',
        aiSuggested: false,
      },
      {
        order: 2,
        stepType: 'task',
        title: 'Send calendar invite',
        content: 'Send calendar invite with Zoom/meeting link',
        delayAmount: 15,
        delayUnit: 'minutes',
        delayFrom: 'previous',
        aiSuggested: false,
      },
      {
        order: 3,
        stepType: 'email',
        title: 'Pre-consultation reminder',
        subject: 'Looking forward to our call tomorrow!',
        content: `Hi {{firstName}},\n\nJust a quick reminder that we're meeting tomorrow at [TIME].\n\nThe meeting link: [LINK]\n\nSee you then!\n{{assignedTo}}`,
        delayAmount: 1,
        delayUnit: 'days',
        delayFrom: 'start',
        aiSuggested: false,
      },
    ],
  };

  return templates[type] || templates.new_lead;
}


// ==========================================
// File: lib/analytics.ts
// ==========================================


/**
 * Analytics tracking utilities
 * Centralized functions for tracking events across all analytics platforms
 * Includes both client-side and server-side tracking for Reddit Conversions API
 */

import posthog from 'posthog-js';
import { 
  trackRedditEvent, 
  trackRedditSignup,
  trackRedditLead,
  trackRedditPurchase,
  trackRedditPageView,
  generateConversionId 
} from './reddit-tracking';

/**
 * Track a custom event across all analytics platforms
 */
export function trackEvent(eventName: string, properties?: Record<string, any>) {
  // PostHog
  const posthogKey = process.env.NEXT_PUBLIC_POSTHOG_KEY;
  if (posthogKey && !posthogKey.startsWith('phc_XXXX')) {
    posthog.capture(eventName, properties);
  }

  // Google Analytics
  const gaId = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID;
  if (gaId && gaId !== 'G-XXXXXXXXXX' && typeof window !== 'undefined' && (window as any).gtag) {
    (window as any).gtag('event', eventName, properties);
  }

  // Reddit Pixel - track as custom event (client-side only for non-conversion events)
  const redditPixelId = process.env.NEXT_PUBLIC_REDDIT_PIXEL_ID;
  if (redditPixelId && typeof window !== 'undefined' && (window as any).rdt) {
    (window as any).rdt('track', 'Custom', {
      customEventName: eventName,
      ...properties,
    });
  }
}

/**
 * Track a page view (manual tracking)
 */
export function trackPageView(url: string, title?: string) {
  const properties = { url, title };

  // PostHog
  const posthogKey = process.env.NEXT_PUBLIC_POSTHOG_KEY;
  if (posthogKey && !posthogKey.startsWith('phc_XXXX')) {
    posthog.capture('$pageview', properties);
  }

  // Google Analytics
  const gaId = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID;
  if (gaId && gaId !== 'G-XXXXXXXXXX' && typeof window !== 'undefined' && (window as any).gtag) {
    (window as any).gtag('config', gaId, {
      page_path: url,
      page_title: title,
    });
  }
}

/**
 * Identify a user across analytics platforms
 */
export function identifyUser(userId: string, properties?: Record<string, any>) {
  // PostHog
  const posthogKey = process.env.NEXT_PUBLIC_POSTHOG_KEY;
  if (posthogKey && !posthogKey.startsWith('phc_XXXX')) {
    posthog.identify(userId, properties);
  }

  // Google Analytics
  const gaId = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID;
  if (gaId && gaId !== 'G-XXXXXXXXXX' && typeof window !== 'undefined' && (window as any).gtag) {
    (window as any).gtag('config', gaId, {
      user_id: userId,
    });
  }
}

/**
 * Track a conversion/goal
 * Includes both client-side and server-side tracking
 */
export async function trackConversion(
  conversionName: string, 
  value?: number, 
  currency?: string,
  additionalProperties?: Record<string, any>
) {
  const properties: Record<string, any> = { 
    conversion: conversionName,
    ...additionalProperties 
  };
  
  if (value !== undefined) {
    properties.value = value;
  }
  
  if (currency) {
    properties.currency = currency || 'USD';
  }

  // Track in PostHog & GA
  trackEvent('conversion', properties);

  // Track specific Reddit events based on conversion type with deduplication
  // Now includes both client-side and server-side tracking via Conversions API
  const redditPixelId = process.env.NEXT_PUBLIC_REDDIT_PIXEL_ID;
  if (redditPixelId) {
    if (conversionName.toLowerCase().includes('purchase') || conversionName.toLowerCase().includes('payment')) {
      await trackRedditPurchase(
        value || 0,
        currency || 'USD',
        additionalProperties?.email
      );
    } else if (conversionName.toLowerCase().includes('lead') || conversionName.toLowerCase().includes('contact')) {
      await trackRedditLead(additionalProperties?.email);
    } else if (conversionName.toLowerCase().includes('signup') || conversionName.toLowerCase().includes('register')) {
      await trackRedditSignup(additionalProperties?.email);
    }
  }
}

/**
 * Reset user identity (logout)
 */
export function resetUser() {
  // PostHog
  const posthogKey = process.env.NEXT_PUBLIC_POSTHOG_KEY;
  if (posthogKey && !posthogKey.startsWith('phc_XXXX')) {
    posthog.reset();
  }
}

// ==========================================
// File: lib/auth-helpers.ts
// ==========================================


// Server-side authentication helpers for role-based access control

import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { prisma } from '@/lib/db';
import { isAdmin, isEmployee, getUserCapabilities } from '@/lib/roles';
import type { EmployeeCapabilities } from '@/lib/roles';

export interface SessionUser {
  id: string;
  email: string;
  name?: string | null;
  role: string;
  employeeProfile?: {
    employeeRole: string;
    capabilities: EmployeeCapabilities;
  } | null;
}

// Get current user session with role and capabilities
export async function getCurrentUser(): Promise<SessionUser | null> {
  const session = await getServerSession(authOptions);
  
  if (!session?.user?.email) {
    return null;
  }

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: {
      id: true,
      email: true,
      name: true,
      role: true,
      employeeProfile: {
        select: {
          employeeRole: true,
          capabilities: true,
        },
      },
    },
  });

  if (!user) {
    return null;
  }

  return {
    id: user.id,
    email: user.email,
    name: user.name,
    role: user.role,
    employeeProfile: user.employeeProfile
      ? {
          employeeRole: user.employeeProfile.employeeRole,
          capabilities: JSON.parse(user.employeeProfile.capabilities),
        }
      : null,
  };
}

// Check if current user is admin
export async function requireAdmin() {
  const user = await getCurrentUser();
  
  if (!user || !isAdmin(user.role)) {
    throw new Error('Unauthorized: Admin access required');
  }
  
  return user;
}

// Check if current user is admin or employee
export async function requireEmployee() {
  const user = await getCurrentUser();
  
  if (!user || (!isAdmin(user.role) && !isEmployee(user.role))) {
    throw new Error('Unauthorized: Employee access required');
  }
  
  return user;
}

// Check if user has specific capability
export async function requireCapability(capability: keyof EmployeeCapabilities) {
  const user = await getCurrentUser();
  
  if (!user) {
    throw new Error('Unauthorized');
  }

  // Admins have all capabilities
  if (isAdmin(user.role)) {
    return user;
  }

  // Check employee capabilities
  if (isEmployee(user.role) && user.employeeProfile) {
    const capabilities = user.employeeProfile.capabilities;
    
    if (!capabilities[capability]) {
      throw new Error(`Unauthorized: Missing capability '${capability}'`);
    }
    
    return user;
  }

  throw new Error('Unauthorized');
}

// Get user capabilities
export async function getUserCapabilitiesForUser(userId: string): Promise<EmployeeCapabilities> {
  const user = await prisma.user.findUnique({
    where: { id: userId },
    select: {
      role: true,
      employeeProfile: {
        select: {
          employeeRole: true,
          capabilities: true,
        },
      },
    },
  });

  if (!user) {
    throw new Error('User not found');
  }

  if (isAdmin(user.role)) {
    return getUserCapabilities(user.role);
  }

  if (isEmployee(user.role) && user.employeeProfile) {
    const customCaps = JSON.parse(user.employeeProfile.capabilities);
    return getUserCapabilities(
      user.role,
      user.employeeProfile.employeeRole,
      customCaps
    );
  }

  return getUserCapabilities(user.role);
}

// Helper to check if an employee object has a specific permission
export function hasPermission(
  employee: { capabilities: string } | null | undefined,
  permission: keyof EmployeeCapabilities
): boolean {
  if (!employee) return false;
  
  try {
    const capabilities = JSON.parse(employee.capabilities);
    return capabilities[permission] === true;
  } catch (error) {
    console.error('Error parsing employee capabilities:', error);
    return false;
  }
}

// ==========================================
// File: lib/auth.ts
// ==========================================


import { NextAuthOptions } from "next-auth";
import CredentialsProvider from "next-auth/providers/credentials";
import { PrismaAdapter } from "@next-auth/prisma-adapter";
import { PrismaClient } from "@prisma/client";
import bcrypt from "bcryptjs";

const prisma = new PrismaClient();

export const authOptions: NextAuthOptions = {
  adapter: PrismaAdapter(prisma),
  providers: [
    CredentialsProvider({
      name: "credentials",
      credentials: {
        email: { label: "Email", type: "email" },
        password: { label: "Password", type: "password" },
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          throw new Error("Invalid credentials");
        }

        const user = await prisma.user.findUnique({
          where: { email: credentials.email },
        });

        if (!user || !user.password) {
          throw new Error("Invalid credentials");
        }

        const isCorrectPassword = await bcrypt.compare(
          credentials.password,
          user.password
        );

        if (!isCorrectPassword) {
          throw new Error("Invalid credentials");
        }

        // Automatically upgrade @cdmsuite.com emails to employee if not already
        const shouldBeEmployee = user.email.endsWith('@cdmsuite.com') && user.role === 'client';
        
        // Update last login and role if needed
        await prisma.user.update({
          where: { id: user.id },
          data: { 
            lastLoginAt: new Date(),
            ...(shouldBeEmployee && { role: 'employee' }),
          },
        });

        // Update role in the user object if changed
        const finalRole = shouldBeEmployee ? 'employee' : user.role;

        return {
          id: user.id,
          email: user.email,
          name: user.name,
          image: user.image,
          tier: user.tier,
          subscriptionStatus: user.subscriptionStatus,
          role: finalRole,
        };
      },
    }),
  ],
  callbacks: {
    async jwt({ token, user, trigger, session }) {
      if (user) {
        token.id = user.id;
        token.tier = user.tier;
        token.subscriptionStatus = user.subscriptionStatus;
        token.role = user.role;
      }

      // Handle session updates
      if (trigger === "update" && session) {
        token = { ...token, ...session.user };
      }

      return token;
    },
    async session({ session, token }) {
      if (token && session.user) {
        session.user.id = token.id as string;
        session.user.tier = token.tier as string;
        session.user.subscriptionStatus = token.subscriptionStatus as string;
        session.user.role = token.role as string;
      }
      return session;
    },
  },
  pages: {
    signIn: "/auth/login",
    error: "/auth/error",
  },
  session: {
    strategy: "jwt",
  },
  secret: process.env.NEXTAUTH_SECRET,
};

// ==========================================
// File: lib/aws-config.ts
// ==========================================

import { S3Client } from '@aws-sdk/client-s3';

export function getBucketConfig() {
  return {
    bucketName: process.env.AWS_BUCKET_NAME,
    folderPrefix: process.env.AWS_FOLDER_PREFIX || ''
  };
}

export function createS3Client() {
  const config: any = {
    region: process.env.AWS_REGION || 'auto',
  };

  if (process.env.AWS_ENDPOINT) {
    config.endpoint = process.env.AWS_ENDPOINT;
  }

  if (process.env.AWS_ACCESS_KEY_ID && process.env.AWS_SECRET_ACCESS_KEY) {
    config.credentials = {
      accessKeyId: process.env.AWS_ACCESS_KEY_ID,
      secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
    };
  }

  return new S3Client(config);
}

// ==========================================
// File: lib/bid-ai-generator.ts
// ==========================================


// AI-Powered Bid Proposal Generator using Abacus AI

import { AIGenerationRequest, AIGenerationResponse, BidProposalData, AdoptedBudgetData } from './bid-proposal-types';
import { 
  CDM_SUITE_KNOWLEDGE,
  getCompanyOverview, 
  getServiceDetails, 
  getIndustryExpertise, 
  getRelevantCaseStudies,
  getMethodologyOverview,
  getTechnologyStack,
  getTeamOverview,
  getQualityAssurance,
  getSupportOptions,
  getPricingPhilosophy,
  generatePricingJustification
} from './cdm-suite-knowledge';

const ABACUS_API_KEY = process.env.ABACUSAI_API_KEY;
const ABACUS_API_URL = 'https://apps.abacus.ai/v1/chat/completions';
const AI_REQUEST_TIMEOUT = 60000; // 60 seconds timeout for generation tasks (increased from 45s)
const MAX_RETRIES = 3; // Maximum retry attempts for proposal generation
const INITIAL_RETRY_DELAY = 2000; // Initial delay before retry (2 seconds)

/**
 * Fetch with timeout to prevent hanging requests
 */
async function fetchWithTimeout(url: string, options: RequestInit, timeoutMs: number = AI_REQUEST_TIMEOUT): Promise<Response> {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
  
  try {
    const response = await fetch(url, {
      ...options,
      signal: controller.signal,
    });
    clearTimeout(timeoutId);
    return response;
  } catch (error: any) {
    clearTimeout(timeoutId);
    if (error.name === 'AbortError') {
      throw new Error('Request timeout - AI API took too long to respond');
    }
    throw error;
  }
}

/**
 * Retry wrapper with exponential backoff for proposal generation
 * Ensures we get complete results even under high API load
 */
async function retryWithBackoff<T>(
  fn: () => Promise<T>,
  operationName: string,
  maxRetries: number = MAX_RETRIES,
  retryDelay: number = INITIAL_RETRY_DELAY
): Promise<T> {
  let lastError: Error | null = null;
  
  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      console.log(`[${operationName}] Attempt ${attempt + 1}/${maxRetries + 1}...`);
      const result = await fn();
      console.log(`[${operationName}] ✓ Success on attempt ${attempt + 1}`);
      return result;
    } catch (error: any) {
      lastError = error;
      console.warn(`[${operationName}] Attempt ${attempt + 1} failed:`, error.message);
      
      // Don't wait after the last attempt
      if (attempt < maxRetries) {
        const delayMs = retryDelay * Math.pow(2, attempt); // Exponential backoff: 2s, 4s, 8s
        console.log(`[${operationName}] Retrying in ${delayMs}ms...`);
        await new Promise(resolve => setTimeout(resolve, delayMs));
      }
    }
  }
  
  // All retries exhausted
  console.error(`[${operationName}] All ${maxRetries + 1} attempts failed`);
  throw lastError || new Error(`All retry attempts failed for ${operationName}`);
}

/**
 * Detect if the client is a government or large enterprise organization
 */
function detectClientType(bidDetails: BidProposalData): 'government' | 'enterprise' | 'commercial' {
  const issuingOrg = (bidDetails.issuingOrg || '').toLowerCase();
  const description = (bidDetails.description || '').toLowerCase();
  const title = (bidDetails.title || '').toLowerCase();
  const combined = `${issuingOrg} ${description} ${title}`;
  
  // Government indicators
  const govKeywords = [
    'city of', 'county of', 'state of', 'federal', 'government', 'municipal',
    'department of', 'agency', 'public works', 'transportation authority',
    'school district', 'university', 'college', 'public safety', 'police',
    'fire department', 'water district', 'port authority', 'transit authority'
  ];
  
  for (const keyword of govKeywords) {
    if (combined.includes(keyword)) {
      return 'government';
    }
  }
  
  // Large enterprise indicators (Fortune 1000 type companies)
  const enterpriseKeywords = [
    'corporation', 'international', 'global', 'fortune', 'inc.', 'corp.',
    'limited', 'holdings', 'group', 'enterprises'
  ];
  
  // Check for enterprise indicators and high complexity/value signals
  let enterpriseScore = 0;
  for (const keyword of enterpriseKeywords) {
    if (combined.includes(keyword)) {
      enterpriseScore++;
    }
  }
  
  // Additional enterprise signals
  if (description.length > 3000 || title.length > 200) enterpriseScore++;
  if (combined.includes('multi-year') || combined.includes('multi-million')) enterpriseScore++;
  
  if (enterpriseScore >= 2) {
    return 'enterprise';
  }
  
  return 'commercial';
}

/**
 * Fetch and analyze client's adopted budget data for government/enterprise clients
 * Looks for official budget documents, fiscal year allocations, and funding priorities
 */
async function fetchAdoptedBudgetData(
  bidDetails: BidProposalData,
  clientType: 'government' | 'enterprise' | 'commercial'
): Promise<AdoptedBudgetData | null> {
  // Only fetch budget data for government and enterprise clients
  if (clientType === 'commercial') {
    return null;
  }
  
  try {
    console.log(`[Budget Analysis] Fetching adopted budget data for ${clientType} client: ${bidDetails.issuingOrg}`);
    
    const currentYear = new Date().getFullYear();
    const fiscalYears = [currentYear.toString(), (currentYear + 1).toString(), (currentYear + 2).toString()];
    
    const prompt = `You are a financial research analyst specializing in government and enterprise budgets.

Analyze this ${clientType} client and provide budget intelligence:

CLIENT: ${bidDetails.issuingOrg || 'Unknown'}
LOCATION: ${bidDetails.location || 'Unknown'}
PROJECT TITLE: ${bidDetails.title}
PROJECT DESCRIPTION: ${bidDetails.description || 'Not provided'}
SOLICITATION TYPE: ${bidDetails.solicitationType || 'Unknown'}

Your task:
1. Research the client's official adopted budget for fiscal years ${fiscalYears.join(', ')}
2. Identify total annual budget, relevant department budgets, and capital program allocations
3. Identify key funding priorities and strategic initiatives
4. Provide budget source references (URLs or document names)

Provide budget intelligence in this EXACT JSON format:
{
  "totalAnnualBudget": <number or null if not found>,
  "relevantDepartmentBudget": <number or null if not found>,
  "capitalProgramBudget": <number or null if not found>,
  "fiscalYear": "<most recent fiscal year found>",
  "budgetSource": "<URL or document reference, or null>",
  "fundingPriorities": ["<list of 3-5 key funding priorities if found>"],
  "notes": "<2-3 sentences about budget context and strategic alignment opportunities>"
}

Guidelines:
1. For government clients: Look for Adopted Budget documents, CAFR (Comprehensive Annual Financial Reports), Capital Improvement Programs
2. For enterprise clients: Look for annual reports, SEC filings, investor relations data
3. Focus on fiscal years 2025-2027
4. If specific budget data is not available, set numeric fields to null
5. fundingPriorities should reflect actual stated priorities from budget documents
6. Be specific and factual - cite real budget line items when possible

Respond with ONLY the JSON object, no markdown formatting.`;

    const response = await retryWithBackoff(
      async () => {
        const res = await fetchWithTimeout(
          ABACUS_API_URL,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${ABACUS_API_KEY}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: 'gpt-4o',
              messages: [
                {
                  role: 'system',
                  content: 'You are a financial research analyst with access to public budget data. Always respond with valid JSON without markdown formatting.'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              temperature: 0.2, // Lower temperature for factual research
              max_tokens: 800
            })
          },
          AI_REQUEST_TIMEOUT
        );

        if (!res.ok) {
          throw new Error(`Budget research API error: ${res.status}`);
        }

        return res;
      },
      'Adopted Budget Research'
    );

    const data = await response.json();
    const content = data.choices?.[0]?.message?.content;
    
    if (!content) {
      throw new Error('No budget data received');
    }

    // Parse JSON response
    const budgetData = JSON.parse(content.trim());
    const notes = budgetData.notes || '';
    
    // Construct adopted budget data
    const adoptedBudgetData: AdoptedBudgetData = {
      clientType,
      totalAnnualBudget: budgetData.totalAnnualBudget,
      relevantDepartmentBudget: budgetData.relevantDepartmentBudget,
      capitalProgramBudget: budgetData.capitalProgramBudget,
      fiscalYear: budgetData.fiscalYear || currentYear.toString(),
      budgetSource: budgetData.budgetSource,
      fundingPriorities: budgetData.fundingPriorities || [],
      budgetAlignment: notes,
      proportionalityAnalysis: null, // Will be filled in later with pricing context
      strategicAlignment: null // Will be filled in later with pricing context
    };
    
    console.log(`[Budget Analysis] ✓ Found budget data for FY ${adoptedBudgetData.fiscalYear}`);
    if (adoptedBudgetData.totalAnnualBudget) {
      console.log(`[Budget Analysis] Total annual budget: $${adoptedBudgetData.totalAnnualBudget.toLocaleString()}`);
    }
    if (adoptedBudgetData.fundingPriorities && adoptedBudgetData.fundingPriorities.length > 0) {
      console.log(`[Budget Analysis] Key priorities: ${adoptedBudgetData.fundingPriorities.slice(0, 2).join(', ')}`);
    }
    
    return adoptedBudgetData;
  } catch (error: any) {
    console.warn('[Budget Analysis] Could not fetch adopted budget data:', error.message);
    return null;
  }
}

/**
 * Analyze project complexity based on requirements
 */
function analyzeProjectComplexity(
  bidDetails: BidProposalData,
  bidDocumentsContent?: string,
  selectedServices?: string[]
): 'low' | 'medium' | 'high' {
  let complexityScore = 0;
  
  // Analyze description length and keywords
  const description = (bidDetails.description || '') + (bidDocumentsContent || '');
  const descriptionLength = description.length;
  
  // Length-based scoring
  if (descriptionLength > 5000) complexityScore += 3;
  else if (descriptionLength > 2000) complexityScore += 2;
  else complexityScore += 1;
  
  // Keyword-based scoring
  const highComplexityKeywords = ['enterprise', 'integration', 'api', 'database', 'authentication', 'complex', 'advanced', 'custom', 'scalable', 'microservices', 'migration'];
  const mediumComplexityKeywords = ['responsive', 'cms', 'e-commerce', 'payment', 'booking', 'dashboard', 'analytics', 'reporting'];
  
  highComplexityKeywords.forEach(keyword => {
    if (description.toLowerCase().includes(keyword)) complexityScore += 0.5;
  });
  
  mediumComplexityKeywords.forEach(keyword => {
    if (description.toLowerCase().includes(keyword)) complexityScore += 0.3;
  });
  
  // Service-based scoring
  if (selectedServices && selectedServices.length > 3) complexityScore += 1;
  
  // Budget indicators
  const budgetIndicators = ['million', 'large scale', 'multi-phase', 'multi-year'];
  budgetIndicators.forEach(indicator => {
    if (description.toLowerCase().includes(indicator)) complexityScore += 1;
  });
  
  // Determine complexity level
  if (complexityScore >= 6) return 'high';
  if (complexityScore >= 3) return 'medium';
  return 'low';
}

/**
 * Generate proportionality analysis comparing proposed price to client's budget
 */
function generateProportionalityAnalysis(
  proposedPrice: number,
  budgetData: AdoptedBudgetData,
  bidDetails: BidProposalData
): string {
  const analyses: string[] = [];
  
  // Calculate percentages relative to various budget levels
  if (budgetData.totalAnnualBudget && budgetData.totalAnnualBudget > 0) {
    const percentOfTotal = (proposedPrice / budgetData.totalAnnualBudget * 100).toFixed(3);
    analyses.push(`The proposed investment of $${proposedPrice.toLocaleString()} represents ${percentOfTotal}% of ${bidDetails.issuingOrg}'s total annual budget of $${budgetData.totalAnnualBudget.toLocaleString()} (FY ${budgetData.fiscalYear}). This demonstrates the project's proportional scale relative to the organization's overall financial capacity.`);
  }
  
  if (budgetData.relevantDepartmentBudget && budgetData.relevantDepartmentBudget > 0) {
    const percentOfDept = (proposedPrice / budgetData.relevantDepartmentBudget * 100).toFixed(2);
    analyses.push(`As a percentage of the relevant department budget ($${budgetData.relevantDepartmentBudget.toLocaleString()}), this investment represents ${percentOfDept}%, indicating a manageable allocation within the department's fiscal envelope.`);
  }
  
  if (budgetData.capitalProgramBudget && budgetData.capitalProgramBudget > 0) {
    const percentOfCapital = (proposedPrice / budgetData.capitalProgramBudget * 100).toFixed(2);
    analyses.push(`Within the context of the capital program budget ($${budgetData.capitalProgramBudget.toLocaleString()}), this project comprises ${percentOfCapital}% of capital allocations, aligning with typical capital project sizing for organizations of this scale.`);
  }
  
  // Add context about budget alignment
  if (analyses.length > 0) {
    analyses.push('This proportionality analysis demonstrates that our pricing is calibrated to your organization\'s financial scale and aligns with typical budget allocations for technology modernization initiatives of this scope.');
  } else {
    analyses.push('Our pricing is structured to align with your organization\'s budget planning processes and represents fair market value for the proposed scope of work.');
  }
  
  return analyses.join('\n\n');
}

/**
 * Generate strategic alignment analysis linking project to client's funding priorities
 */
function generateStrategicAlignment(
  bidDetails: BidProposalData,
  budgetData: AdoptedBudgetData
): string {
  const alignments: string[] = [];
  
  if (budgetData.fundingPriorities && budgetData.fundingPriorities.length > 0) {
    alignments.push(`${bidDetails.issuingOrg}'s FY ${budgetData.fiscalYear} Adopted Budget identifies the following strategic funding priorities:`);
    
    budgetData.fundingPriorities.forEach((priority, index) => {
      alignments.push(`${index + 1}. ${priority}`);
    });
    
    alignments.push('');
    alignments.push(`This project directly supports these organizational priorities by delivering technology capabilities that enable ${bidDetails.issuingOrg} to achieve its strategic objectives. Our solution is designed to maximize return on investment within the context of your stated funding priorities and fiscal year planning.`);
  } else {
    alignments.push(`This project aligns with ${bidDetails.issuingOrg}'s strategic objectives and fiscal year planning, delivering technology capabilities that support organizational mission and goals.`);
  }
  
  // Add budgetAlignment context if available
  if (budgetData.budgetAlignment) {
    alignments.push('');
    alignments.push(budgetData.budgetAlignment);
  }
  
  return alignments.join('\n');
}

/**
 * Calculate internal budget cap based on adopted budget data (CONFIDENTIAL)
 * This function is used ONLY for internal pricing validation and is NEVER exposed to clients
 */
function calculateInternalBudgetCap(
  budgetData: AdoptedBudgetData,
  bidDetails: BidProposalData
): number | null {
  // Determine reasonable maximum project cost based on budget context
  const potentialCaps: number[] = [];
  
  // For capital program budgets, use a percentage (typically 5-15% for single projects)
  if (budgetData.capitalProgramBudget && budgetData.capitalProgramBudget > 0) {
    // Use 10% of capital program budget as reasonable cap
    potentialCaps.push(Math.round(budgetData.capitalProgramBudget * 0.10));
  }
  
  // For department budgets, use a smaller percentage (typically 2-5%)
  if (budgetData.relevantDepartmentBudget && budgetData.relevantDepartmentBudget > 0) {
    // Use 3% of department budget as reasonable cap
    potentialCaps.push(Math.round(budgetData.relevantDepartmentBudget * 0.03));
  }
  
  // For total annual budget, use even smaller percentage (typically 0.1-1%)
  if (budgetData.totalAnnualBudget && budgetData.totalAnnualBudget > 0) {
    // Use 0.5% of total budget as reasonable cap
    potentialCaps.push(Math.round(budgetData.totalAnnualBudget * 0.005));
  }
  
  // Return the minimum of all calculated caps (most conservative approach)
  if (potentialCaps.length > 0) {
    const minCap = Math.min(...potentialCaps);
    console.log(`[Budget Cap] Calculated internal cap: $${minCap.toLocaleString()} (from ${potentialCaps.length} budget references)`);
    return minCap;
  }
  
  console.log('[Budget Cap] No budget data available for cap calculation');
  return null;
}

/**
 * Fetch locality-specific market rate data using AI
 */
async function fetchLocalityMarketRates(
  location: string,
  serviceType: string,
  complexity: 'low' | 'medium' | 'high',
  projectDescription: string
): Promise<{
  localityFactor: number;
  marketInsights: string;
  averageRate: number | null;
}> {
  try {
    console.log(`[Market Research] Fetching market rates for ${location}...`);
    
    const prompt = `You are a market research analyst specializing in technology services pricing. Research and provide current market rates for the following:

LOCATION: ${location}
SERVICE TYPE: ${serviceType}
COMPLEXITY: ${complexity}
PROJECT DESCRIPTION: ${projectDescription}

Provide market intelligence in this EXACT JSON format:
{
  "averageRate": <number or null if cannot determine>,
  "localityFactor": <number between 0.7 and 1.5>,
  "marketInsights": "<2-3 sentences about local market conditions, competition, and pricing trends for this specific location and service type>"
}

Guidelines:
1. localityFactor represents cost adjustment for this location (1.0 = baseline, 1.3 = 30% higher than baseline, 0.8 = 20% lower)
2. Consider: local cost of living, competition density, demand levels, government vs commercial rates
3. For US locations: NYC/SF/Boston typically 1.2-1.5x, smaller cities 0.8-0.9x, mid-tier cities 1.0-1.1x
4. For government projects: typically 10-20% lower than commercial due to budget constraints
5. If specific rate data available, provide averageRate, otherwise set to null
6. Base insights on current 2025 market conditions

Respond with ONLY the JSON object, no markdown formatting.`;

    const response = await retryWithBackoff(
      async () => {
        const res = await fetchWithTimeout(
          ABACUS_API_URL,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${ABACUS_API_KEY}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              model: 'gpt-4o',
              messages: [
                {
                  role: 'system',
                  content: 'You are a market research analyst. Always respond with valid JSON without markdown formatting.'
                },
                {
                  role: 'user',
                  content: prompt
                }
              ],
              temperature: 0.3,
              max_tokens: 500
            })
          },
          AI_REQUEST_TIMEOUT
        );

        if (!res.ok) {
          throw new Error(`Market research API error: ${res.status}`);
        }

        return res;
      },
      'Locality Market Research'
    );

    const data = await response.json();
    const content = data.choices?.[0]?.message?.content;
    
    if (!content) {
      throw new Error('No market data received');
    }

    // Parse JSON response
    const marketData = JSON.parse(content.trim());
    
    // Validate and sanitize data
    const localityFactor = Math.max(0.7, Math.min(1.5, marketData.localityFactor || 1.0));
    const averageRate = marketData.averageRate && marketData.averageRate >= 5000 ? marketData.averageRate : null;
    const marketInsights = marketData.marketInsights || 'Market research data not available for this location.';
    
    console.log(`[Market Research] Locality factor: ${localityFactor}x`);
    if (averageRate) {
      console.log(`[Market Research] Average market rate: $${averageRate.toLocaleString()}`);
    }
    
    return {
      localityFactor,
      marketInsights,
      averageRate
    };
  } catch (error: any) {
    console.warn('[Market Research] Could not fetch locality data:', error.message);
    // Return conservative defaults on failure
    return {
      localityFactor: 1.0,
      marketInsights: 'Market research data not available. Using baseline national rates.',
      averageRate: null
    };
  }
}

/**
 * Conduct market research and calculate competitive pricing with locality-specific adjustments
 */
async function conductMarketResearch(
  bidDetails: BidProposalData,
  selectedServices?: string[],
  bidDocumentsContent?: string
): Promise<{
  proposedPrice: number;
  priceRange: { min: number; max: number };
  complexity: 'low' | 'medium' | 'high';
  justification: string;
  adoptedBudgetData?: AdoptedBudgetData | null;
}> {
  console.log('[Market Research] Analyzing project requirements...');
  
  // Analyze complexity
  const complexity = analyzeProjectComplexity(bidDetails, bidDocumentsContent, selectedServices);
  console.log(`[Market Research] Complexity level: ${complexity}`);
  
  // Detect client type and fetch adopted budget data if applicable
  const clientType = detectClientType(bidDetails);
  console.log(`[Market Research] Client type: ${clientType}`);
  
  let adoptedBudgetData: AdoptedBudgetData | null = null;
  if (clientType === 'government' || clientType === 'enterprise') {
    adoptedBudgetData = await fetchAdoptedBudgetData(bidDetails, clientType);
  }
  
  // Base pricing ranges by service type and complexity (national baseline)
  const pricingMatrix: { [key: string]: { [key in 'low' | 'medium' | 'high']: { min: number; max: number } } } = {
    'web design': {
      low: { min: 15000, max: 35000 },
      medium: { min: 35000, max: 75000 },
      high: { min: 75000, max: 150000 }
    },
    'web development': {
      low: { min: 20000, max: 45000 },
      medium: { min: 45000, max: 95000 },
      high: { min: 95000, max: 200000 }
    },
    'mobile app': {
      low: { min: 30000, max: 60000 },
      medium: { min: 60000, max: 120000 },
      high: { min: 120000, max: 200000 }
    },
    'e-commerce': {
      low: { min: 40000, max: 80000 },
      medium: { min: 80000, max: 150000 },
      high: { min: 150000, max: 250000 }
    },
    'ai solutions': {
      low: { min: 25000, max: 50000 },
      medium: { min: 50000, max: 100000 },
      high: { min: 100000, max: 200000 }
    },
    'consulting': {
      low: { min: 15000, max: 30000 },
      medium: { min: 30000, max: 70000 },
      high: { min: 70000, max: 150000 }
    },
    'marketing': {
      low: { min: 10000, max: 25000 },
      medium: { min: 25000, max: 60000 },
      high: { min: 60000, max: 120000 }
    },
    'default': {
      low: { min: 20000, max: 40000 },
      medium: { min: 40000, max: 85000 },
      high: { min: 85000, max: 175000 }
    }
  };
  
  // Determine primary service type
  let primaryService = 'default';
  if (selectedServices && selectedServices.length > 0) {
    const serviceKey = selectedServices[0].toLowerCase();
    for (const key in pricingMatrix) {
      if (serviceKey.includes(key) || key.includes(serviceKey)) {
        primaryService = key;
        break;
      }
    }
  }
  
  // Get base price range for this service and complexity
  const basePriceRange = pricingMatrix[primaryService][complexity];
  
  // Fetch locality-specific market data
  const location = bidDetails.location || 'United States';
  const projectDescription = bidDetails.description || bidDetails.title || '';
  const marketData = await fetchLocalityMarketRates(
    location,
    primaryService,
    complexity,
    projectDescription
  );
  
  // Apply locality factor to price range
  const adjustedMin = Math.round(basePriceRange.min * marketData.localityFactor);
  const adjustedMax = Math.round(basePriceRange.max * marketData.localityFactor);
  const priceRange = { min: adjustedMin, max: adjustedMax };
  
  // Calculate proposed price
  let proposedPrice: number;
  
  if (marketData.averageRate) {
    // If we have specific market rate data, use it as primary reference
    console.log(`[Market Research] Using market average rate: $${marketData.averageRate.toLocaleString()}`);
    proposedPrice = Math.round(marketData.averageRate * 1.05); // 5% above market average for our expertise
    
    // Ensure proposed price is within adjusted range
    proposedPrice = Math.max(adjustedMin, Math.min(adjustedMax, proposedPrice));
  } else {
    // Use midpoint with locality adjustment
    const midPoint = (adjustedMin + adjustedMax) / 2;
    proposedPrice = Math.round(midPoint * 1.08); // 8% above midpoint
  }
  
  // Estimate timeline
  const timelineEstimates = {
    low: '4-8 weeks',
    medium: '8-16 weeks',
    high: '16-24 weeks'
  };
  const timeline = timelineEstimates[complexity];
  
  // Generate enhanced justification with market insights
  const projectScope = bidDetails.description || 'Based on the requirements outlined';
  const baseJustification = generatePricingJustification(proposedPrice, projectScope, complexity, timeline);
  
  // Apply budget cap internally for government/enterprise clients (CONFIDENTIAL - NOT included in proposal)
  let budgetAdjustedPrice = proposedPrice;
  if (adoptedBudgetData) {
    // Internal validation: ensure proposed price doesn't exceed reasonable budget limits
    const budgetCap = calculateInternalBudgetCap(adoptedBudgetData, bidDetails);
    
    if (budgetCap && proposedPrice > budgetCap) {
      console.log(`[Budget Validation] Adjusting price from $${proposedPrice.toLocaleString()} to fit within budget constraints: $${budgetCap.toLocaleString()}`);
      budgetAdjustedPrice = budgetCap;
    } else {
      console.log(`[Budget Validation] ✓ Proposed price $${proposedPrice.toLocaleString()} is within budget constraints`);
    }
    
    // Fill in internal analysis (for database storage only, NOT for proposal output)
    const proportionalityAnalysis = generateProportionalityAnalysis(
      budgetAdjustedPrice,
      adoptedBudgetData,
      bidDetails
    );
    const strategicAlignment = generateStrategicAlignment(
      bidDetails,
      adoptedBudgetData
    );
    
    adoptedBudgetData.proportionalityAnalysis = proportionalityAnalysis;
    adoptedBudgetData.strategicAlignment = strategicAlignment;
  }
  
  // Update proposed price after budget validation
  proposedPrice = budgetAdjustedPrice;
  
  // Build client-facing justification (NO BUDGET DATA - CONFIDENTIAL)
  let enhancedJustification = `${baseJustification}

**Market Research & Locality Analysis**

Location: ${location}
${marketData.marketInsights}

${marketData.averageRate ? `Current market average for similar projects in this location: $${marketData.averageRate.toLocaleString()}` : 'Market research indicates local cost adjustment factor applied.'}

Our proposed price of $${proposedPrice.toLocaleString()} is positioned competitively within the ${location} market for ${primaryService} projects of ${complexity} complexity, reflecting both current market rates and the value of our proven track record.`;

  // Add prudent budget management language for government/enterprise clients (NO SPECIFIC FIGURES)
  if (adoptedBudgetData && clientType === 'government') {
    enhancedJustification += `

**Budgetary Prudence & Project Controls**

CDM Suite LLC's pricing reflects a commitment to fiscal responsibility and budget adherence. Our cost analysis incorporates:

• **Internal Cost Controls**: Rigorous cost analysis and earned value methodologies ensure pricing aligns with typical funding constraints for projects of this nature
• **Budget Optimization**: Strategic resource allocation to deliver maximum value within prudent budget parameters
• **Fiscal Year Alignment**: Project planning and payment schedules designed to align with standard fiscal year requirements
• **Project Controls Framework**: Proven methodologies from infrastructure program management ensuring cost discipline throughout execution

This pricing approach reflects our deep understanding of public sector budgetary processes and our commitment to delivering exceptional value while maintaining strict fiscal accountability. Our project controls guarantee that all work will be managed using proven cost management techniques, providing confidence that the investment will be delivered on-time and within the committed budget envelope.`;
  } else if (adoptedBudgetData && clientType === 'enterprise') {
    enhancedJustification += `

**Financial Discipline & Value Delivery**

CDM Suite LLC's pricing is developed through rigorous internal cost analysis and strategic budget planning:

• **Cost Optimization**: Our pricing reflects comprehensive cost modeling to ensure optimal resource allocation
• **Budget Adherence**: Commitment to delivering within agreed-upon budget parameters using proven project controls
• **Value Engineering**: Strategic approach to maximizing ROI while maintaining fiscal discipline
• **Financial Transparency**: Clear milestone-based payment schedules aligned with deliverable completion

This approach ensures that our pricing delivers maximum strategic value while respecting typical funding constraints for enterprise technology initiatives of this scope and complexity.`;
  }
  
  console.log(`[Market Research] Proposed price: $${proposedPrice.toLocaleString()}`);
  console.log(`[Market Research] Locality-adjusted range: $${priceRange.min.toLocaleString()} - $${priceRange.max.toLocaleString()}`);
  console.log(`[Market Research] Locality factor: ${marketData.localityFactor}x`);
  if (adoptedBudgetData) {
    console.log(`[Market Research] ✓ Budgetary alignment analysis included for ${clientType} client`);
  }
  
  return {
    proposedPrice,
    priceRange,
    complexity,
    justification: enhancedJustification,
    adoptedBudgetData
  };
}

/**
 * Extract pricing from generated cost proposal content with comprehensive pattern matching
 */
function extractPricingFromContent(content: string): number | null {
  console.log('[Price Extraction] Analyzing generated content...');
  console.log('[Price Extraction] Content preview:', content.substring(0, 500));
  
  // Look for total project cost patterns (comprehensive list)
  const patterns = [
    /\*\*Total\s+Project\s+Cost\*\*[:\s]*\$?([\d,]+)/i,
    /Total\s+Project\s+Cost[:\s]*\$?([\d,]+)/i,
    /\*\*Total\s+Investment\*\*[:\s]*\$?([\d,]+)/i,
    /Total\s+Investment[:\s]*\$?([\d,]+)/i,
    /\*\*Grand\s+Total\*\*[:\s]*\$?([\d,]+)/i,
    /Grand\s+Total[:\s]*\$?([\d,]+)/i,
    /\*\*Total\s+Cost\*\*[:\s]*\$?([\d,]+)/i,
    /Total\s+Cost[:\s]*\$?([\d,]+)/i,
    /\*\*Total\*\*[:\s]*\$?([\d,]+)/i,
    /Total[:\s]+\$?([\d,]+)/i,
    /\|\s*\*\*Total[^|]*\|\s*\*\*\$?([\d,]+)\*\*/i, // Table total row
    /\|\s*Total[^|]*\|\s*\$?([\d,]+)/i, // Table total row without bold
    /^Total[:\s]*\$?([\d,]+)/im, // Line starting with Total
    /Investment[:\s]+\$?([\d,]+)/i,
  ];
  
  for (const pattern of patterns) {
    const match = content.match(pattern);
    if (match && match[1]) {
      const priceStr = match[1].replace(/,/g, '');
      const price = parseInt(priceStr, 10);
      
      console.log(`[Price Extraction] Pattern matched: ${pattern}, extracted: ${priceStr}, parsed: ${price}`);
      
      // Validate price is reasonable (between $5K and $5M)
      if (price >= 5000 && price <= 5000000) {
        console.log(`[Price Extraction] ✓ Found valid price: $${price.toLocaleString()}`);
        return price;
      } else {
        console.log(`[Price Extraction] ✗ Price ${price} outside valid range (5K-5M)`);
      }
    }
  }
  
  console.log('[Price Extraction] No valid price found in content');
  console.log('[Price Extraction] Full content:', content);
  return null;
}

/**
 * Export market research function for direct use
 */
export { conductMarketResearch };

export async function generateTechnicalProposal(request: AIGenerationRequest): Promise<AIGenerationResponse> {
  try {
    const { bidDetails, bidDocumentsContent, selectedServices, baseEmailProposal, customInstructions } = request.context;

    const prompt = buildTechnicalProposalPrompt(bidDetails, bidDocumentsContent, selectedServices, baseEmailProposal, customInstructions);

    const response = await fetchWithTimeout(ABACUS_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ABACUS_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: `You are an expert proposal writer specializing in government and corporate RFPs for CDM Suite LLC. 

CRITICAL RULE #1 - USE ONLY PROVIDED CDM SUITE INFORMATION:
You MUST EXCLUSIVELY use information from the CDM Suite knowledge base sections provided in the prompt. Every single detail about company capabilities, experience, technology, team qualifications, and methodologies MUST come directly from the sections titled:
- "Company Information"
- "Relevant Services & Expertise" 
- "Relevant Case Studies & Success Stories"
- "Our Team & Qualifications"
- "Methodology Overview"
- "Technology Stack"
- "Quality Assurance & Security"

DO NOT:
- Invent capabilities, technologies, or experience not listed in the provided sections
- Use generic phrases like "our experienced team" without citing specific qualifications from the knowledge base
- Create fictional metrics, testimonials, or case study results
- Add technologies not explicitly listed in the "Technology Stack" section
- Reference certifications or credentials not mentioned in the provided information

EVERY claim you make must be traceable to the provided knowledge base. If CDM Suite doesn't offer a specific service or use a specific technology according to the provided info, DO NOT include it.

CRITICAL RULE #2 - NO INVENTED PERSONNEL:
NEVER create or mention individual team member names (NO "John Carter", "Sarah Lopez", "Michael Tan", etc.). When describing Team Qualifications & Experience, reference ONLY the verifiable leadership background provided (infrastructure programs, Primavera certification, project controls, etc.) WITHOUT naming individuals. Use collective language like "our leadership team", "our certified professionals", "our project managers".

CRITICAL RULE #3 - SPECIFIC OVER GENERIC:
Replace ALL generic statements with specific CDM Suite details:
- Instead of "experienced team" → reference "$5.1B LaGuardia Terminal B and $4.2B JFK Terminal 6 program experience"
- Instead of "proven methodology" → reference "Critical Path Method (CPM) scheduling from multi-billion dollar infrastructure programs"  
- Instead of "modern technologies" → list exact stack: "React, Next.js, TypeScript, Tailwind CSS, Node.js, PostgreSQL, AWS"
- Instead of "successful projects" → cite "120%+ profit growth through operational efficiency" or "$368K+ in documented sales generation"

Your proposals must be professional, persuasive, and tailored to requirements while strictly adhering to CDM Suite's actual capabilities and experience.`
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 4000,
      }),
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`AI API error: ${error}`);
    }

    const data = await response.json();
    const content = data.choices[0]?.message?.content;

    if (!content) {
      throw new Error('No content generated by AI');
    }

    return {
      success: true,
      content,
      metadata: {
        model: data.model || 'gpt-4o',
        promptTokens: data.usage?.prompt_tokens || 0,
        completionTokens: data.usage?.completion_tokens || 0,
        totalTokens: data.usage?.total_tokens || 0,
        generatedAt: new Date().toISOString(),
      },
    };
  } catch (error: any) {
    console.error('Error generating technical proposal:', error);
    return {
      success: false,
      error: error.message || 'Failed to generate technical proposal',
    };
  }
}

export async function generateCostProposal(request: AIGenerationRequest): Promise<AIGenerationResponse> {
  try {
    const { bidDetails, bidDocumentsContent, selectedServices, baseEmailProposal, customInstructions } = request.context;

    // Conduct market research and cost analysis (now includes adopted budget data for gov/enterprise clients)
    const marketResearch = await conductMarketResearch(bidDetails, selectedServices, bidDocumentsContent);
    
    const prompt = buildCostProposalPrompt(bidDetails, bidDocumentsContent, selectedServices, baseEmailProposal, customInstructions, marketResearch);

    const response = await fetchWithTimeout(ABACUS_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ABACUS_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: `You are an expert pricing strategist and cost proposal writer for CDM Suite LLC.

CRITICAL RULE #1 - USE ONLY PROVIDED CDM SUITE INFORMATION:
You MUST EXCLUSIVELY use CDM Suite's actual track record and capabilities from the provided knowledge base. DO NOT invent metrics, testimonials, or value propositions. Use ONLY these verified CDM Suite credentials:
- Infrastructure experience: $5.1B LaGuardia Terminal B, $4.2B JFK Terminal 6 program management
- Operational track record: 120%+ profit growth, $250M+ in assets managed
- Sales performance: $368K+ in documented sales generation
- Technical certifications: Oracle Primavera Specialist, BIM certified
- Team leadership: 50+ professionals managed across infrastructure and operations
- Education: Airport/Airline Management, Project Management, BIM certifications

Every value statement must reference specific CDM Suite achievements from the knowledge base.

CRITICAL RULE #2 - STRICT CONFIDENTIALITY:
NEVER include or reference any client budget figures (annual budget, department budget, capital program budget, fiscal year allocations, percentages, or budget document sources). Pricing must be justified ONLY through:
- Market research data provided in the prompt
- Project complexity analysis
- CDM Suite's demonstrated expertise and value
- Industry standard rates for the service type and location

You may use general terms like "budget adherence" and "fiscal responsibility" but NEVER specific client budget data.

CRITICAL RULE #3 - TRANSPARENT VALUE JUSTIFICATION:
Clearly explain pricing based on:
- Market rates for the specific location and service type (from provided market research)
- Project complexity level (provided in prompt)
- CDM Suite's infrastructure-grade project management approach
- Specific deliverables and scope
- Support tiers with clear feature breakdowns
- ROI potential based on CDM Suite's operational efficiency track record

Your cost proposals must be detailed, transparent, and competitive while demonstrating exceptional value through CDM Suite's unique combination of infrastructure experience and digital expertise.`
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.6,
        max_tokens: 3000,
      }),
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`AI API error: ${error}`);
    }

    const data = await response.json();
    const content = data.choices[0]?.message?.content;

    if (!content) {
      throw new Error('No content generated by AI');
    }

    // Try to extract price from content, fallback to market research price
    const extractedPrice = extractPricingFromContent(content);
    const finalPrice = extractedPrice || marketResearch.proposedPrice;

    return {
      success: true,
      content,
      pricing: {
        proposedPrice: finalPrice,
        priceSource: extractedPrice ? 'extracted' : 'market_research',
        pricingNotes: marketResearch.justification,
        complexity: marketResearch.complexity,
        priceRange: marketResearch.priceRange
      },
      adoptedBudgetData: marketResearch.adoptedBudgetData,
      metadata: {
        model: data.model || 'gpt-4o',
        promptTokens: data.usage?.prompt_tokens || 0,
        completionTokens: data.usage?.completion_tokens || 0,
        totalTokens: data.usage?.total_tokens || 0,
        generatedAt: new Date().toISOString(),
      },
    };
  } catch (error: any) {
    console.error('Error generating cost proposal:', error);
    return {
      success: false,
      error: error.message || 'Failed to generate cost proposal',
    };
  }
}

function buildTechnicalProposalPrompt(
  bidDetails: BidProposalData,
  bidDocumentsContent?: string,
  selectedServices?: string[],
  baseEmailProposal?: string,
  customInstructions?: string
): string {
  // Extract industry from bid details
  const industry = bidDetails.issuingOrg || bidDetails.title || '';
  const services = selectedServices && selectedServices.length > 0 ? selectedServices : ['web design', 'digital marketing'];
  
  const sections = [
    `# Generate a Comprehensive Technical Proposal`,
    ``,
    `## Bid Information`,
    `- **Solicitation Number:** ${bidDetails.solicitationNumber}`,
    `- **Title:** ${bidDetails.title}`,
    `- **Issuing Organization:** ${bidDetails.issuingOrg || 'N/A'}`,
    `- **Location:** ${bidDetails.location || 'N/A'}`,
    `- **Closing Date:** ${bidDetails.closingDate ? new Date(bidDetails.closingDate).toLocaleDateString() : 'N/A'}`,
    ``,
    `## Company Information`,
    getCompanyOverview(),
    ``,
    `## Relevant Services & Expertise`,
    getServiceDetails(services),
    ``,
    getIndustryExpertise(industry),
    ``,
    `## Relevant Case Studies & Success Stories`,
    getRelevantCaseStudies(industry, services),
    ``,
    `## Our Team & Qualifications`,
    getTeamOverview(),
    ``
  ];

  // Add General Proposal Comment if provided
  if (bidDetails.generalProposalComment && bidDetails.generalProposalComment.trim()) {
    sections.push(`## IMPORTANT: General Proposal Message`);
    sections.push(`**CRITICAL:** This message MUST be prominently included in the Executive Summary or as a standalone section at the beginning of the proposal:`);
    sections.push(``);
    sections.push(bidDetails.generalProposalComment);
    sections.push(``);
  }

  if (bidDetails.description) {
    sections.push(`## Bid Description & Requirements`);
    sections.push(bidDetails.description);
    sections.push(``);
  }

  if (bidDocumentsContent) {
    sections.push(`## Additional Bid Documents Content`);
    sections.push(bidDocumentsContent);
    sections.push(``);
  }

  if (selectedServices && selectedServices.length > 0) {
    sections.push(`## Services to Emphasize`);
    sections.push(`Please highlight our expertise in: ${selectedServices.join(', ')}`);
    sections.push(``);
  }

  if (customInstructions) {
    sections.push(`## Custom Instructions`);
    sections.push(customInstructions);
    sections.push(``);
  }

  // Check if we have a substantial email proposal to organize vs creating from scratch
  const hasSubstantialEmail = baseEmailProposal && baseEmailProposal.trim().length > 200;

  if (hasSubstantialEmail) {
    sections.push(`## EXISTING PROPOSAL TO ORGANIZE`);
    sections.push(`IMPORTANT: You already sent the client the following proposal via email. Your task is to ORGANIZE and REFORMAT this existing proposal into the official structure - DO NOT create a brand new proposal from scratch.`);
    sections.push(``);
    sections.push(`Existing Email Proposal:`);
    sections.push(baseEmailProposal);
    sections.push(``);
    sections.push(`## Your Task`);
    sections.push(`**ORGANIZE the existing email proposal above** into a professional, structured technical proposal (Envelope 1) with these sections:`);
    sections.push(`1. **Executive Summary** - Extract and refine the key points from the email`);
    sections.push(`2. **Understanding of Requirements** - Organize the requirements discussion from the email`);
    sections.push(`3. **Technical Approach & Methodology** - Structure the approach described in the email`);
    sections.push(`4. **Project Timeline & Milestones** - Extract and format any timeline mentioned`);
    sections.push(`5. **Team Qualifications & Experience** - Organize team/expertise info from the email`);
    sections.push(`6. **Technology Stack & Tools** - List technologies mentioned in the email`);
    sections.push(`7. **Quality Assurance & Testing** - Extract QA processes mentioned`);
    sections.push(`8. **Risk Management** - Organize any risks/mitigation discussed`);
    sections.push(`9. **Post-Launch Support & Maintenance** - Extract support commitments`);
    sections.push(`10. **Why Choose CDM Suite** - Organize value propositions from the email`);
    sections.push(``);
    sections.push(`**CRITICAL Requirements:**`);
    sections.push(`- PRESERVE all key commitments, timelines, and deliverables from the email`);
    sections.push(`- MAINTAIN the same overall scope and approach - do NOT change the fundamental proposal`);
    sections.push(`- ORGANIZE and STRUCTURE the existing content professionally`);
    sections.push(`- ADD professional polish and formatting but keep the substance identical`);
    sections.push(`- If the email is missing a section, add brief professional content for completeness using the "Our Team & Qualifications" section above`);
    sections.push(`- NEVER INVENT individual team member names - reference only the verifiable qualifications provided (infrastructure experience, certifications, etc.)`);
    sections.push(`- Use collective language: "our team", "our leadership", "our certified professionals" (NOT individual names)`);
    sections.push(`- Use professional business writing style with clear section headings`);
    sections.push(`- NO PRICING INFORMATION (this is for the technical proposal only)`);
  } else {
    if (baseEmailProposal) {
      sections.push(`## Reference Notes`);
      sections.push(`Previous communication with client:`);
      sections.push(baseEmailProposal);
      sections.push(``);
    }
    
    sections.push(`## Methodology Overview`);
    sections.push(getMethodologyOverview());
    sections.push(``);
    sections.push(`## Technology Stack`);
    sections.push(getTechnologyStack());
    sections.push(``);
    sections.push(`## Quality Assurance & Security`);
    sections.push(getQualityAssurance());
    sections.push(``);
    
    sections.push(`## Your Task`);
    sections.push(`Generate a professional, compelling technical proposal (Envelope 1) that:`);
    sections.push(`1. **Executive Summary** - Compelling overview of our approach and qualifications, referencing specific CDM Suite strengths`);
    sections.push(`2. **Understanding of Requirements** - Demonstrate deep understanding of the project needs using specific examples from our case studies`);
    sections.push(`3. **Technical Approach & Methodology** - Detailed explanation of how we'll execute using our proven methodology (discovery, design, development, testing, launch)`);
    sections.push(`4. **Project Timeline & Milestones** - Realistic timeline with key deliverables based on project complexity`);
    sections.push(`5. **Team Qualifications & Experience** - Showcase our team expertise, certifications, and relevant case study results`);
    sections.push(`6. **Technology Stack & Tools** - Specific technologies from our stack that are relevant to this project`);
    sections.push(`7. **Quality Assurance & Testing** - Our comprehensive QA process including accessibility, security, and performance testing`);
    sections.push(`8. **Risk Management** - Potential risks and mitigation strategies based on our experience`);
    sections.push(`9. **Post-Launch Support & Maintenance** - Specific support tiers and what they include`);
    sections.push(`10. **Why Choose CDM Suite** - Unique value propositions with specific metrics (98% client satisfaction, 3.5x ROI, etc.)`);
    sections.push(``);
    sections.push(`**CRITICAL Requirements:**`);
    sections.push(`- MANDATORY: EVERY capability, technology, qualification, and achievement you mention MUST come directly from the sections above`);
    sections.push(`- PULL ACTUAL INFORMATION from the company overview, case studies, and expertise sections - DO NOT add anything not explicitly stated`);
    sections.push(`- Include SPECIFIC METRICS: "$5.1B LaGuardia Terminal B", "$4.2B JFK Terminal 6", "120%+ profit growth", "$368K+ sales", "$250M+ assets managed"`);
    sections.push(`- Reference EXACT TECHNOLOGIES from the Technology Stack section: React, Next.js, TypeScript, Tailwind CSS, Node.js, PostgreSQL, AWS - DO NOT add other tech`);
    sections.push(`- Reference SPECIFIC TEAM QUALIFICATIONS: Oracle Primavera Specialist, BIM certified, Airport/Airline Management degree, 50+ team leadership - NO INVENTED DETAILS`);
    sections.push(`- NEVER INVENT individual team member names - use collective language: "our leadership team", "our certified professionals", "our project managers"`);
    sections.push(`- NO GENERIC LANGUAGE: Replace "experienced team" with "$5.1B infrastructure program experience", "proven methodology" with "Critical Path Method (CPM) from multi-billion dollar programs"`);
    sections.push(`- Make it UNIQUE to this bid's requirements while using ONLY CDM Suite's actual capabilities from the knowledge base`);
    sections.push(`- Use professional business writing style with clear section headings and bullet points`);
    sections.push(`- Highlight measurable outcomes: "120%+ profit growth", "$368K+ sales generation", "50+ team leadership"`);
    sections.push(`- NO PRICING INFORMATION (this is for the technical proposal only)`);
    sections.push(``);
    sections.push(`**VERIFICATION CHECK BEFORE GENERATING:**`);
    sections.push(`Before you write each section, verify that every claim can be traced to the knowledge base sections above. If you cannot find a specific detail in the provided information, DO NOT include it. Use only what is explicitly stated in:`);
    sections.push(`✓ Company Information section`);
    sections.push(`✓ Relevant Services & Expertise section`);
    sections.push(`✓ Relevant Case Studies & Success Stories section`);
    sections.push(`✓ Our Team & Qualifications section`);
    sections.push(`✓ Methodology Overview section`);
    sections.push(`✓ Technology Stack section`);
    sections.push(`✓ Quality Assurance & Security section`);
  }
  
  sections.push(``);
  sections.push(`NOW generate the complete technical proposal, ensuring every detail comes directly from CDM Suite's actual capabilities and experience documented above:`);

  return sections.join('\n');
}

function buildCostProposalPrompt(
  bidDetails: BidProposalData,
  bidDocumentsContent?: string,
  selectedServices?: string[],
  baseEmailProposal?: string,
  customInstructions?: string,
  marketResearch?: {
    proposedPrice: number;
    priceRange: { min: number; max: number };
    complexity: 'low' | 'medium' | 'high';
    justification: string;
    adoptedBudgetData?: AdoptedBudgetData | null;
  }
): string {
  // Extract industry and services for context
  const industry = bidDetails.issuingOrg || bidDetails.title || '';
  const services = selectedServices && selectedServices.length > 0 ? selectedServices : ['web design', 'digital marketing'];
  
  const sections = [
    `# Generate a Comprehensive Cost Proposal`,
    ``,
    `## Bid Information`,
    `- **Solicitation Number:** ${bidDetails.solicitationNumber}`,
    `- **Title:** ${bidDetails.title}`,
    `- **Issuing Organization:** ${bidDetails.issuingOrg || 'N/A'}`,
    `- **Project Scope:** ${bidDetails.description || 'See bid documents'}`,
    ``,
    `## Company Overview & Track Record`,
    getCompanyOverview(),
    ``,
  ];

  // Add General Proposal Comment if provided
  if (bidDetails.generalProposalComment && bidDetails.generalProposalComment.trim()) {
    sections.push(`## IMPORTANT: General Proposal Message`);
    sections.push(`**CRITICAL:** This message MUST be prominently included in the Executive Summary or as a standalone section at the beginning of the proposal:`);
    sections.push(``);
    sections.push(bidDetails.generalProposalComment);
    sections.push(``);
  }

  sections.push(
    `## Market Research & Cost Analysis`,
    getPricingPhilosophy(),
    ``,
    `### Locality-Specific Market Research`,
    marketResearch ? `
**Location:** ${bidDetails.location || 'United States'}

**Project Complexity:** ${marketResearch.complexity.charAt(0).toUpperCase() + marketResearch.complexity.slice(1)}

${marketResearch.justification}

**Price Range for Similar Projects in ${bidDetails.location || 'This Market'}:** $${marketResearch.priceRange.min.toLocaleString()} - $${marketResearch.priceRange.max.toLocaleString()}

**Proposed Total Project Cost:** $${marketResearch.proposedPrice.toLocaleString()}

This pricing reflects:
- Current ${bidDetails.location || 'local'} market rates for ${marketResearch.complexity}-complexity projects
- Comprehensive competitive analysis for this specific location
- Assessment of project requirements and scope
- Our enterprise-grade quality standards (98% satisfaction, 3.5x ROI, 95% on-time delivery)
- Fair market value that is competitive yet reflects our proven expertise
` : '',
    ``,
    `## Pricing Context - Our Track Record`,
    `CDM Suite provides competitive, transparent pricing that reflects the value and expertise we bring. Our pricing is based on:`,
    `- Project complexity and scope`,
    `- Timeline and urgency`,
    `- Technology stack requirements`,
    `- Level of customization needed`,
    `- Ongoing support and maintenance`,
    ``,
    `**Our Value Proposition:**`,
    `- Average 3.5x ROI within first year`,
    `- 95% of projects delivered on-time and within budget`,
    `- 98% client satisfaction rate`,
    `- 87% client retention year-over-year`,
    ``,
    `## Support & Maintenance Options`,
    getSupportOptions(),
    ``
  );

  if (bidDocumentsContent) {
    sections.push(`## Bid Requirements`);
    sections.push(bidDocumentsContent);
    sections.push(``);
  }

  if (selectedServices && selectedServices.length > 0) {
    sections.push(`## Services Included`);
    sections.push(`Focus on pricing for: ${selectedServices.join(', ')}`);
    sections.push(``);
  }

  if (customInstructions) {
    sections.push(`## Custom Instructions`);
    sections.push(customInstructions);
    sections.push(``);
  }

  // Check if we have a substantial email proposal with pricing to organize
  const hasSubstantialEmail = baseEmailProposal && baseEmailProposal.trim().length > 200;

  if (hasSubstantialEmail) {
    sections.push(`## EXISTING PRICING PROPOSAL TO ORGANIZE`);
    sections.push(`IMPORTANT: You already sent the client the following pricing proposal via email. Your task is to ORGANIZE and REFORMAT this existing pricing into the official structure - DO NOT create brand new pricing from scratch.`);
    sections.push(``);
    sections.push(`Existing Email Pricing Proposal:`);
    sections.push(baseEmailProposal);
    sections.push(``);
    sections.push(`## Your Task`);
    sections.push(`**ORGANIZE the existing email pricing proposal above** into a professional, detailed cost proposal (Envelope 2) that includes:`);
  } else {
    if (baseEmailProposal) {
      sections.push(`## Reference Information`);
      sections.push(`Previous communication with client:`);
      sections.push(baseEmailProposal);
      sections.push(``);
    }
    
    sections.push(`## Your Task`);
    sections.push(`Generate a professional, detailed cost proposal (Envelope 2) that includes:`);
  }
  sections.push(``);
  sections.push(`1. **Executive Summary** - Brief overview of pricing approach, total cost, and value proposition (reference 3.5x average ROI)`);
  sections.push(`2. **Total Project Cost** - MUST include as a standalone section with clear format: "## Total Project Cost: $XXX,XXX" or "**Total Project Cost:** $XXX,XXX"`);
  sections.push(`3. **Detailed Pricing Breakdown** - Use a markdown table format with these columns:`);
  sections.push(`   - Phase/Deliverable`);
  sections.push(`   - Description`);
  sections.push(`   - Cost`);
  sections.push(``);
  sections.push(`   Example table format:`);
  sections.push(`   | Phase/Deliverable | Description | Cost |`);
  sections.push(`   |-------------------|-------------|------|`);
  sections.push(`   | Discovery & Planning | Requirements gathering, wireframes, project plan | $15,000 |`);
  sections.push(`   | Design & Branding | UI/UX design, brand guidelines, mockups | $25,000 |`);
  sections.push(`   | Development | Frontend and backend development, integrations | $60,000 |`);
  sections.push(`   | Testing & QA | Comprehensive testing, bug fixes, optimization | $12,000 |`);
  sections.push(`   | Training & Documentation | User training, technical documentation | $8,000 |`);
  sections.push(`   | Deployment & Launch | Production deployment, monitoring setup | $5,000 |`);
  sections.push(`   | **Total Project Cost** | | **$125,000** |`);
  sections.push(``);
  sections.push(`4. **Payment Schedule** - Milestone-based payments in table format:`);
  sections.push(`   | Milestone | Deliverables | Payment | Timeline |`);
  sections.push(`   |-----------|--------------|---------|----------|`);
  sections.push(`   | Contract Signing | Kickoff meeting, project plan | 30% | Week 1 |`);
  sections.push(`   | Design Approval | Approved designs, prototypes | 25% | Week 4 |`);
  sections.push(`   | Development Complete | Functional application | 25% | Week 10 |`);
  sections.push(`   | Launch & Final Delivery | Live deployment, training | 20% | Week 12 |`);
  sections.push(``);
  sections.push(`5. **Optional Services/Add-ons** (table format if applicable)`);
  sections.push(`6. **Post-Launch Support & Maintenance** - Reference the SPECIFIC support tiers from the "Support & Maintenance Options" section above (Basic, Priority, or Enterprise) with their actual pricing ranges and included services`);
  sections.push(`7. **Assumptions & Exclusions** - What's included and what's not`);
  sections.push(`8. **Pricing Validity** - How long the pricing remains valid`);
  sections.push(`9. **Value Proposition** - Why this represents excellent value (reference our 98% client satisfaction, 95% on-time delivery, and 3.5x average ROI)`);
  sections.push(``);
  sections.push(`**Pricing Guidelines:**`);
  sections.push(`- For enterprise website redesigns: $50K - $150K range`);
  sections.push(`- For complex web applications: $75K - $200K range`);
  sections.push(`- For healthcare/medical websites: $60K - $175K range`);
  sections.push(`- For e-commerce platforms: $80K - $250K range`);
  sections.push(`- For SEO services: $3K - $10K/month (ongoing)`);
  sections.push(`- For advertising management: $5K - $20K/month + ad spend`);
  sections.push(`- For mobile app development: $60K - $200K range`);
  sections.push(`- For AI/automation solutions: $40K - $150K range`);
  sections.push(`- Adjust based on project scope and complexity`);
  sections.push(``);
  sections.push(`**CRITICAL Format Requirements:**`);
  sections.push(`- Use markdown tables for ALL pricing information (use | pipes for columns)`);
  sections.push(`- Tables must be properly formatted with header row and separator row`);
  sections.push(`- Include a total row in bold at the bottom of pricing tables: | **Total Project Cost** | | **$XXX,XXX** |`);
  sections.push(`- MUST include "**Total Project Cost**" or "**Total Investment**" label followed by the dollar amount for automated extraction`);
  sections.push(`- The total MUST be clearly visible both in the table AND as a standalone section header like "## Total Project Cost: $XXX,XXX"`);
  sections.push(`- Use clear section headings with ##`);
  sections.push(`- Professional business writing style`);
  sections.push(`- Transparent and justified pricing with descriptions`);
  sections.push(`- Competitive but not underpriced`);
  sections.push(`- Emphasize value and ROI throughout`);
  sections.push(``);
  sections.push(`**CRITICAL Content Requirements:**`);
  sections.push(`- MANDATORY: Use ONLY CDM Suite's actual track record from the "Company Overview & Track Record" section above`);
  sections.push(`- Reference SPECIFIC CDM Suite credentials: $5.1B LaGuardia Terminal B, $4.2B JFK Terminal 6, 120%+ profit growth, $368K+ sales, $250M+ assets, 50+ team leadership`);
  sections.push(`- Include EXACT support tier options from the "Support & Maintenance Options" section (Basic: $2.5K-$5K, Priority: $5K-$10K, Enterprise: $15K+)`);
  sections.push(`- Reference ACTUAL qualifications: Oracle Primavera Specialist, BIM certified, Airport/Airline Management degree, Project Management certified`);
  sections.push(`- Justify pricing with CDM Suite's infrastructure program experience, operational efficiency, and proven market performance`);
  sections.push(`- Make the value proposition compelling by citing REAL metrics: 120%+ profit growth, $368K+ sales generation, 50+ professionals managed`);
  sections.push(`- DO NOT invent case studies, testimonials, or performance metrics not provided in the knowledge base sections above`);
  sections.push(`- Every value statement must trace back to actual CDM Suite achievements documented in the prompt`);
  sections.push(``);
  sections.push(`**CRITICAL CONFIDENTIALITY REQUIREMENT:**`);
  sections.push(`- NEVER include or reference the client's Adopted Budget figures, totals, allocations, percentages, fund names, or budget document URLs`);
  sections.push(`- NEVER mention specific dollar amounts from the client's annual budget, department budget, or capital program budget`);
  sections.push(`- NEVER reference the client's fiscal year budget documents, CAFR reports, or similar financial documents`);
  sections.push(`- The pricing must be presented ONLY as a figure derived from CDM Suite's own cost analysis and market research`);
  sections.push(`- You may reference "budget adherence," "fiscal responsibility," and "typical funding constraints" in GENERAL terms only`);
  sections.push(`- Focus justification on market rates, project complexity, our track record, and competitive value - NOT on client's budget capacity`);
  
  if (hasSubstantialEmail) {
    sections.push(``);
    sections.push(`**CRITICAL - PRESERVE EXISTING PRICING:**`);
    sections.push(`- Extract the EXACT pricing from the email proposal above`);
    sections.push(`- DO NOT change the total price or major line items`);
    sections.push(`- ONLY reformat and structure the existing pricing professionally`);
    sections.push(`- If pricing tables exist in the email, preserve those values exactly`);
    sections.push(`- You are organizing what was already proposed, not creating new pricing`);
  }
  
  sections.push(``);
  sections.push(`Generate the complete cost proposal now with properly formatted markdown tables:`);

  return sections.join('\n');
}

// AI-Powered Bid Information Extraction from Documents
export interface ExtractedBidInfo {
  title: string;
  solicitationNumber: string;
  description: string;
  organizationName: string;
  organizationType: string;
  address: string;
  city: string;
  state: string;
  zipCode: string;
  issueDate?: string;
  closingDate?: string;
  technicalOpeningDate?: string;
  costOpeningDate?: string;
  contactName: string;
  contactEmail: string;
  contactPhone: string;
  requirements: string[];
  estimatedBudget?: string;
  budgetDetails?: string;
  scope: string;
}

// Helper function to clean JSON from markdown code blocks
function cleanJsonResponse(content: string): string {
  let cleaned = content.trim();
  
  // Remove markdown code block markers
  if (cleaned.startsWith('```json')) {
    cleaned = cleaned.replace(/^```json\s*/, '');
  } else if (cleaned.startsWith('```')) {
    cleaned = cleaned.replace(/^```\s*/, '');
  }
  
  if (cleaned.endsWith('```')) {
    cleaned = cleaned.replace(/\s*```$/, '');
  }
  
  return cleaned.trim();
}

export async function extractBidInformationFromDocuments(
  documents: { name: string; content: string }[]
): Promise<ExtractedBidInfo> {
  try {
    // Combine all document contents
    const combinedContent = documents.map(doc => 
      `=== Document: ${doc.name} ===\n${doc.content}\n\n`
    ).join('');

    const prompt = `You are an expert at analyzing RFP (Request for Proposal) and bid documents. Your job is to extract as much information as possible from the documents, using context clues and reasonable inferences when explicit information is not available.

Documents to analyze:
${combinedContent}

Extract and provide ALL of the following information in JSON format:
{
  "title": "Brief, clear title for this bid opportunity",
  "solicitationNumber": "The solicitation/RFP number (look in headers, footers, reference numbers, ITN numbers, RFP numbers, etc.)",
  "description": "Comprehensive 2-3 sentence description of what this bid is for",
  "organizationName": "Name of the organization issuing the bid (check headers, contact sections, addressee, sender info)",
  "organizationType": "Type (e.g., 'Federal Agency', 'State Government', 'Local Government', 'Private Corporation', 'Healthcare', 'Education') - infer from context if not explicitly stated",
  "address": "Street address of the organization (check letterhead, contact sections, mailing address)",
  "city": "City name (extract from address or contact information)",
  "state": "State/Province (extract from address or contact information)",
  "zipCode": "ZIP/Postal code (extract from address or contact information)",
  "issueDate": "Date when the RFP was issued (YYYY-MM-DD format) - check document date, publication date, or 'issued on' dates",
  "closingDate": "Deadline for bid submission (YYYY-MM-DD format) - look for 'due date', 'submission deadline', 'closing date', 'proposals must be received by'",
  "technicalOpeningDate": "Date for technical proposal opening (YYYY-MM-DD format) if mentioned separately",
  "costOpeningDate": "Date for cost proposal opening (YYYY-MM-DD format) if mentioned separately",
  "contactName": "Primary contact person for questions (check contact sections, 'questions to', procurement officer name)",
  "contactEmail": "Contact email address (any email mentioned for questions or submissions)",
  "contactPhone": "Contact phone number (any phone number for inquiries)",
  "requirements": ["Extract ALL key requirements, qualifications, deliverables, and evaluation criteria - be comprehensive"],
  "estimatedBudget": "Extract ONLY if explicit dollar amounts are mentioned (e.g., '$50,000', 'budget of $100,000', 'not to exceed $150,000'). DO NOT extract year references. Return null if no explicit budget found.",
  "budgetDetails": "Any budget notes, payment terms, funding source, payment schedules, or financial requirements",
  "scope": "Detailed description of the project scope and objectives - extract from scope of work, project description, or purpose sections",
  "keyDeliverables": ["List ALL specific deliverables, milestones, reports, or outputs expected"],
  "timeline": "Expected project duration, start date, completion date, or phased timeline",
  "technicalRequirements": "Specific technical requirements, platforms, technologies, standards, certifications, or compliance requirements"
}

CRITICAL EXTRACTION RULES:
1. **ALWAYS fill every field** - use context clues and reasonable inferences
2. **Organization Details**: Look in letterheads, headers, footers, contact sections, return addresses
3. **Dates**: Parse from various formats (e.g., "December 15, 2024", "12/15/2024", "2024-12-15")
4. **Contact Info**: Check "Questions" sections, "Contact" sections, email signatures, headers
5. **Solicitation Number**: Can be RFP #, ITN #, Solicitation #, Project #, Reference #, Contract #
6. **Timeline**: Look for start dates, duration (e.g., "12 months", "2 years"), completion dates
7. **Requirements**: Be exhaustive - include minimum qualifications, mandatory requirements, evaluation criteria
8. **Only use null/empty for**: dates that truly aren't mentioned, and budgetDetails/estimatedBudget if no financial info exists
9. **Inference allowed for**: organizationType (based on name/context), address components if partial info available
10. **Budget**: Only extract explicit amounts like "$50,000" or "budget not to exceed $100,000" - ignore year mentions

EXAMPLE INFERENCES:
- If you see "Grand Traverse County" → city: "Traverse City", state: "Michigan"
- If you see "Department of Education" → organizationType: "Government"
- If closing date is Jan 15 → issueDate is likely within past 30 days
- If you see "procurement@agency.gov" and "John Smith, Procurement Officer" → contactEmail and contactName

Respond with raw JSON only. Do not wrap in markdown code blocks.`;

    const response = await fetchWithTimeout(ABACUS_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ABACUS_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: 'You are an expert at extracting structured information from RFP and bid documents. You always respond with valid JSON without markdown formatting.'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.3,
        max_tokens: 2000,
      }),
    });

    if (!response.ok) {
      const error = await response.text();
      throw new Error(`AI API error: ${error}`);
    }

    const data = await response.json();
    const content = data.choices[0]?.message?.content;

    if (!content) {
      throw new Error('No content generated by AI');
    }

    // Clean the response to remove any markdown formatting
    const cleanedContent = cleanJsonResponse(content);
    
    // Parse the JSON response
    const extractedInfo = JSON.parse(cleanedContent);
    
    return extractedInfo;
  } catch (error) {
    console.error('Error extracting bid information:', error);
    throw new Error(`Failed to extract bid information: ${error instanceof Error ? error.message : 'Unknown error'}`);
  }
}

/**
 * Extract pricing information from a preliminary email
 */
export async function extractPricingFromEmail(
  emailContent: string
): Promise<{ price: number | null; notes: string | null }> {
  try {
    const prompt = `You are an expert at extracting pricing information from emails and correspondence. Analyze the following email and extract any pricing or budget information mentioned.

Email content:
${emailContent}

Extract and provide the following information in JSON format:
{
  "price": <number or null if not found>,
  "notes": "Any additional context about the pricing, payment terms, or budget constraints"
}

Look for:
- Direct price quotes (e.g., "$50,000", "fifty thousand dollars")
- Budget ranges (extract the midpoint or maximum)
- Hourly rates × estimated hours
- Line item totals
- "Not to exceed" amounts

Important:
- Return only the numeric value for price (without $, commas, or text)
- If no price is found, return null
- Be conservative - only extract prices if clearly stated

Respond with raw JSON only. Do not wrap the response in markdown code blocks.`;

    const response = await fetchWithTimeout(ABACUS_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ABACUS_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: 'You are an expert at extracting pricing information from text. You always respond with valid JSON without markdown formatting.'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.2,
        max_tokens: 500,
      }),
    });

    if (!response.ok) {
      console.warn('Failed to extract pricing from email:', await response.text());
      return { price: null, notes: null };
    }

    const data = await response.json();
    const content = data.choices[0]?.message?.content;

    if (!content) {
      return { price: null, notes: null };
    }

    const cleanedContent = cleanJsonResponse(content);
    const result = JSON.parse(cleanedContent);
    
    // Validate extracted price is realistic for business proposals
    const extractedPrice = typeof result.price === 'number' ? result.price : null;
    
    if (extractedPrice !== null && extractedPrice < 10000) {
      console.log(`Rejected unrealistic email price: $${extractedPrice.toLocaleString()} (minimum $10,000 required)`);
      return { price: null, notes: result.notes || 'Price mentioned but below minimum threshold' };
    }
    
    return {
      price: extractedPrice,
      notes: result.notes || null,
    };
  } catch (error) {
    console.error('Error extracting pricing from email:', error);
    return { price: null, notes: null };
  }
}

/**
 * Calculate realistic pricing based on bid requirements and scope
 */
export async function calculateRealisticPricing(
  bidDetails: any,
  requirements: string,
  scope: string
): Promise<{ price: number | null; breakdown: string; notes: string }> {
  try {
    const prompt = `You are an expert pricing analyst specializing in government and commercial bids. Calculate a realistic price estimate for this bid opportunity.

BID INFORMATION:
Title: ${bidDetails.title || 'Not specified'}
Issuing Organization: ${bidDetails.issuingOrg || 'Not specified'}
Type: ${bidDetails.solicitationType || 'Not specified'}
Location: ${bidDetails.location || 'Not specified'}
Description: ${bidDetails.description || 'Not specified'}

REQUIREMENTS:
${requirements}

SCOPE OF WORK:
${scope}

Provide a realistic pricing estimate in this EXACT JSON format:
{
  "price": <total numeric value>,
  "breakdown": "<detailed breakdown of cost components>",
  "notes": "<justification and market considerations>",
  "confidence": "<low|medium|high>"
}

Guidelines for realistic pricing:
1. Consider labor costs based on location and complexity
2. Include materials, equipment, and overhead (20-30%)
3. Add profit margin (10-15% for competitive bids, 15-25% for specialized work)
4. Research typical industry rates for similar projects
5. Factor in project duration, team size, and expertise level required
6. Consider travel, training, and other ancillary costs
7. Adjust for government vs commercial pricing expectations

Pricing ranges by project type:
- Small consulting/services: $15,000 - $75,000
- Medium projects: $75,000 - $250,000
- Large projects: $250,000 - $1,000,000+
- Enterprise/multi-year: $1M+

Respond with raw JSON only. Do not wrap in markdown code blocks.`;

    const response = await fetchWithTimeout(ABACUS_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ABACUS_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: 'You are an expert pricing analyst. Always respond with valid JSON without markdown formatting. Base your estimates on realistic industry standards and market research.'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.3,
        max_tokens: 800,
      }),
    });

    if (!response.ok) {
      console.warn('Failed to calculate realistic pricing:', await response.text());
      return { price: null, breakdown: '', notes: 'Unable to calculate pricing estimate' };
    }

    const data = await response.json();
    const content = data.choices[0]?.message?.content;

    if (!content) {
      return { price: null, breakdown: '', notes: 'Unable to calculate pricing estimate' };
    }

    const cleanedContent = cleanJsonResponse(content);
    const result = JSON.parse(cleanedContent);
    
    // Validate calculated price is realistic for business proposals
    const calculatedPrice = typeof result.price === 'number' ? result.price : null;
    
    if (calculatedPrice !== null && calculatedPrice < 10000) {
      console.log(`Rejected unrealistic calculated price: $${calculatedPrice.toLocaleString()} (minimum $10,000 required)`);
      return { 
        price: null, 
        breakdown: result.breakdown || '', 
        notes: `Calculated price below minimum threshold. ${result.notes || ''} (Confidence: ${result.confidence || 'low'})` 
      };
    }
    
    return {
      price: calculatedPrice,
      breakdown: result.breakdown || '',
      notes: `${result.notes || ''} (Confidence: ${result.confidence || 'medium'})`,
    };
  } catch (error) {
    console.error('Error calculating realistic pricing:', error);
    return { price: null, breakdown: '', notes: 'Error calculating pricing estimate' };
  }
}


/**
 * Generate a follow-up email template based on the bid proposal
 */
export async function generateFollowUpEmail(bidProposal: any): Promise<string> {
  try {
    const prompt = `Generate a professional follow-up email to send to the bid issuing organization after submitting a proposal.

Bid Details:
- Title: ${bidProposal.title}
- Solicitation Number: ${bidProposal.solicitationNumber}
- Issuing Organization: ${bidProposal.issuingOrg || 'N/A'}
- Contact Name: ${bidProposal.contactName || 'N/A'}
- Closing Date: ${bidProposal.closingDate ? new Date(bidProposal.closingDate).toLocaleDateString() : 'N/A'}

Generate a brief, professional email (3-4 sentences) that:
1. Confirms submission of the proposal
2. Expresses enthusiasm about the opportunity
3. Offers to answer any questions
4. Provides a clear call-to-action for next steps

Keep it concise, professional, and warm. Do not include subject line or signature - just the body text.`;

    const response = await fetchWithTimeout(ABACUS_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ABACUS_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: 'You are a professional business email writer. Generate concise, professional follow-up emails.'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 300,
      }),
    });

    if (!response.ok) {
      console.warn('Failed to generate follow-up email:', await response.text());
      return `Thank you for considering our proposal for ${bidProposal.title}. We look forward to the opportunity to work with you and are available to answer any questions you may have.`;
    }

    const data = await response.json();
    const content = data.choices[0]?.message?.content;

    return content || `Thank you for considering our proposal for ${bidProposal.title}. We look forward to the opportunity to work with you and are available to answer any questions you may have.`;
  } catch (error) {
    console.error('Error generating follow-up email:', error);
    return `Thank you for considering our proposal for ${bidProposal.title}. We look forward to the opportunity to work with you and are available to answer any questions you may have.`;
  }
}

/**
 * Generate a professional proposal title
 */
export async function generateProposalTitle(bidProposal: any): Promise<string> {
  try {
    const prompt = `Generate a concise, professional proposal title based on the following bid information. 
The title should be clear, descriptive, and suitable for a government/enterprise contract proposal.
Keep it under 120 characters.

Bid Information:
- Solicitation: ${bidProposal.title || 'Not specified'}
- Solicitation Number: ${bidProposal.solicitationNumber || 'N/A'}
- Organization: ${bidProposal.issuingOrg || 'Not specified'}
- Description: ${bidProposal.description || 'Not specified'}
- Location: ${bidProposal.location || 'Not specified'}

Generate ONLY the title text, nothing else. No quotes, no prefixes, just the title.`;

    const response = await fetchWithTimeout(ABACUS_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ABACUS_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: 'You are a professional proposal writer. Generate clear, concise proposal titles.'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 100,
      }),
    });

    if (!response.ok) {
      console.warn('Failed to generate proposal title:', await response.text());
      return `Proposal for ${bidProposal.title}`;
    }

    const data = await response.json();
    let content = data.choices[0]?.message?.content?.trim();
    
    // Remove quotes if present
    if (content) {
      content = content.replace(/^["']|["']$/g, '');
    }

    return content || `Proposal for ${bidProposal.title}`;
  } catch (error) {
    console.error('Error generating proposal title:', error);
    return `Proposal for ${bidProposal.title}`;
  }
}

/**
 * Generate a professional cover page for the proposal
 */
export async function generateCoverPage(bidProposal: any): Promise<string> {
  try {
    const companyInfo = getCompanyOverview();
    const proposalTitle = bidProposal.proposalTitle || bidProposal.title;
    
    const prompt = `Generate professional cover page content for a government/enterprise contract proposal.
The content should be formatted as clean HTML (div elements with appropriate classes).

Bid Information:
- Title: ${proposalTitle}
- Solicitation Number: ${bidProposal.solicitationNumber || 'N/A'}
- Organization: ${bidProposal.issuingOrg || 'Not specified'}
- Location: ${bidProposal.location || 'Not specified'}
- Closing Date: ${bidProposal.closingDate ? new Date(bidProposal.closingDate).toLocaleDateString() : 'Not specified'}

Company Information:
${companyInfo}

Generate the cover page content with:
1. Proposal title (prominent heading)
2. Submitted to: [Organization name]
3. Solicitation number
4. Submitted by: CDM Suite
5. Date
6. Brief value proposition (2-3 sentences highlighting our $9.3B+ infrastructure experience)

Return ONLY the HTML content (using div, h1, h2, h3, p tags), no markdown, no code blocks.`;

    const response = await fetchWithTimeout(ABACUS_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ABACUS_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: 'You are a professional proposal writer. Generate clean HTML content for proposal cover pages.'
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 600,
      }),
    });

    if (!response.ok) {
      console.warn('Failed to generate cover page:', await response.text());
      return getDefaultCoverPage(bidProposal);
    }

    const data = await response.json();
    let content = data.choices[0]?.message?.content?.trim();
    
    // Remove markdown code blocks if present
    if (content) {
      content = content.replace(/```html\n?/g, '').replace(/```\n?/g, '');
    }

    return content || getDefaultCoverPage(bidProposal);
  } catch (error) {
    console.error('Error generating cover page:', error);
    return getDefaultCoverPage(bidProposal);
  }
}

/**
 * Get default cover page HTML
 */
function getDefaultCoverPage(bidProposal: any): string {
  const proposalTitle = bidProposal.proposalTitle || bidProposal.title;
  const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  
  return `
<div class="cover-page">
  <h1 style="font-size: 2.5rem; font-weight: bold; color: #1a56db; margin-bottom: 2rem; text-align: center;">
    ${proposalTitle}
  </h1>
  
  <div style="margin: 3rem 0;">
    <h2 style="font-size: 1.5rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">
      Submitted To:
    </h2>
    <p style="font-size: 1.25rem; color: #6b7280;">
      ${bidProposal.issuingOrg || 'Issuing Organization'}
    </p>
  </div>
  
  <div style="margin: 2rem 0;">
    <h3 style="font-size: 1.25rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
      Solicitation Number:
    </h3>
    <p style="font-size: 1.125rem; color: #6b7280;">
      ${bidProposal.solicitationNumber}
    </p>
  </div>
  
  <div style="margin: 3rem 0;">
    <h2 style="font-size: 1.5rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">
      Submitted By:
    </h2>
    <p style="font-size: 1.25rem; font-weight: 600; color: #1a56db;">
      CDM Suite
    </p>
    <p style="font-size: 1rem; color: #6b7280; margin-top: 0.5rem;">
      Infrastructure Excellence Since 2020
    </p>
  </div>
  
  <div style="margin: 2rem 0;">
    <h3 style="font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
      Date:
    </h3>
    <p style="font-size: 1rem; color: #6b7280;">
      ${today}
    </p>
  </div>
  
  <div style="margin: 3rem 0; padding: 1.5rem; background: #f3f4f6; border-left: 4px solid #1a56db;">
    <p style="font-size: 1rem; color: #374151; line-height: 1.6;">
      CDM Suite brings proven expertise from $9.3B+ in infrastructure programs, delivering 120%+ profit growth and exceptional project outcomes. We combine advanced project controls, technical excellence, and client-focused partnership to ensure your project's success.
    </p>
  </div>
</div>`;
}


/**
 * Regenerates content for a specific section of a bid proposal
 */
export async function generateSectionContent(
  bidProposal: any,
  section: string
): Promise<string> {
  const companyKnowledge = CDM_SUITE_KNOWLEDGE;
  
  let prompt = "";
  let systemMessage = "You are an expert proposal writer specializing in government contracting and infrastructure projects.";

  switch (section) {
    case "envelope1Content":
      // Technical Proposal
      prompt = `Generate a comprehensive technical proposal for this bid:
      
Title: ${bidProposal.title}
Description: ${bidProposal.description || "Not provided"}
Issuing Organization: ${bidProposal.issuingOrg || "Not specified"}
Solicitation Type: ${bidProposal.solicitationType || "Not specified"}

Include:
1. Executive Summary
2. Understanding of Requirements
3. Technical Approach
4. Methodology
5. Quality Control
6. Risk Management
7. Deliverables and Timeline
8. Team Qualifications

Use the following company information:
${JSON.stringify(companyKnowledge, null, 2)}

Make it professional, detailed, and winning. Focus on our $9.3B+ infrastructure experience and 120%+ profit growth track record.`;
      break;

    case "envelope2Content":
      // Cost Proposal
      prompt = `Generate a detailed cost proposal for this bid:
      
Title: ${bidProposal.title}
Description: ${bidProposal.description || "Not provided"}
Proposed Price: ${bidProposal.proposedPrice ? `$${bidProposal.proposedPrice.toLocaleString()}` : "To be determined"}

Include:
1. Cost Summary
2. Labor Costs
3. Materials and Equipment
4. Overhead and Indirect Costs
5. Profit/Fee
6. Payment Schedule
7. Cost Breakdown by Phase
8. Value Justification

Use the following company information:
${JSON.stringify(companyKnowledge, null, 2)}

Make it transparent, justified, and competitive. Highlight our value proposition and ROI benefits.`;
      break;

    case "envelope1Notes":
      // Technical Notes
      prompt = `Generate internal technical notes for this proposal:
      
Title: ${bidProposal.title}
Description: ${bidProposal.description || "Not provided"}

Include:
1. Key technical considerations
2. Potential challenges and mitigation strategies
3. Required resources and expertise
4. Timeline considerations
5. Quality control checkpoints
6. Recommended approach variations

Make it actionable for the proposal team.`;
      break;

    case "envelope2Notes":
      // Cost Notes
      prompt = `Generate internal cost notes for this proposal:
      
Title: ${bidProposal.title}
Proposed Price: ${bidProposal.proposedPrice ? `$${bidProposal.proposedPrice.toLocaleString()}` : "To be determined"}

Include:
1. Pricing strategy rationale
2. Cost assumptions and dependencies
3. Risk contingencies
4. Negotiation points
5. Profit margin justification
6. Competitive positioning

Make it useful for pricing decisions and negotiations.`;
      break;

    case "generalProposalComment":
      // General Comment
      prompt = `Generate a general proposal comment that will be included in all documents:
      
Title: ${bidProposal.title}
Description: ${bidProposal.description || "Not provided"}

This should be a compelling 2-3 paragraph statement that:
1. Demonstrates our understanding of the project
2. Highlights our unique qualifications
3. Emphasizes our commitment to excellence
4. References our $9.3B+ infrastructure experience

Make it professional and persuasive.`;
      break;

    default:
      throw new Error(`Invalid section: ${section}`);
  }

  try {
    const response = await fetch("https://apis.abacus.ai/chatllm/chat/complete", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${process.env.ABACUSAI_API_KEY}`,
      },
      body: JSON.stringify({
        messages: [
          { role: "system", content: systemMessage },
          { role: "user", content: prompt },
        ],
        model: "gpt-4o-2024-11-20",
        temperature: 0.7,
        max_tokens: 4000,
      }),
    });

    if (!response.ok) {
      throw new Error(`API request failed: ${response.statusText}`);
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content || "";
  } catch (error) {
    console.error("Error generating section content:", error);
    throw error;
  }
}
// ==========================================
// File: lib/bid-document-generator.ts
// ==========================================


/**
 * Bid Document Generator
 * Generates different types of bid documents based on RFP content and company knowledge
 */

import { 
  getCompanyOverview, 
  getServiceDetails, 
  getRelevantCaseStudies,
  getLeadershipBackground,
  getCompetitiveAdvantages,
  getTechnologyStack,
  getMethodologyOverview
} from './cdm-suite-knowledge';

interface DocumentGenerationContext {
  bidProposal: any;
  extractedContent?: string;
  adoptedBudgetData?: any;
  competitiveIntelligence?: string;
}

/**
 * Generate Technical Proposal
 */
export async function generateTechnicalProposal(context: DocumentGenerationContext): Promise<string> {
  const { bidProposal, extractedContent } = context;
  const companyOverview = getCompanyOverview();
  const methodology = getMethodologyOverview();
  const techStack = getTechnologyStack();

  const systemPrompt = `You are an expert proposal writer for CDM Suite, a digital marketing agency with extensive infrastructure project experience.

Company Background:
${companyOverview}

Technology & Methodology:
${methodology}

Create a comprehensive technical proposal that includes:
1. Executive Summary
2. Understanding of Requirements
3. Technical Approach and Methodology
4. Project Management Plan
5. Quality Assurance Procedures
6. Team Qualifications
7. Technology Stack and Tools
8. Risk Management
9. Timeline and Deliverables

Use specific examples from our infrastructure portfolio where relevant. Be professional, detailed, and demonstrate technical expertise.`;

  const userPrompt = `Generate a technical proposal for this opportunity:

Title: ${bidProposal.title}
Organization: ${bidProposal.issuingOrg || 'Government Agency'}
Location: ${bidProposal.location || 'Not specified'}

${extractedContent ? `RFP Content:\n${extractedContent.substring(0, 3000)}` : ''}

Description: ${bidProposal.description || 'Not provided'}

Generate a comprehensive technical proposal that showcases our infrastructure expertise and addresses all requirements.`;

  try {
    const response = await fetch(`https://apps.abacus.ai/v1/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.ABACUSAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt },
        ],
        temperature: 0.7,
        max_tokens: 4000,
      }),
    });

    if (!response.ok) {
      throw new Error(`AI API error: ${response.statusText}`);
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content || 'Error generating technical proposal';
  } catch (error) {
    console.error('Error generating technical proposal:', error);
    throw error;
  }
}

/**
 * Generate Cost Proposal
 */
export async function generateCostProposal(context: DocumentGenerationContext): Promise<string> {
  const { bidProposal, adoptedBudgetData } = context;
  const companyOverview = getCompanyOverview();

  const systemPrompt = `You are a pricing expert for CDM Suite with experience in infrastructure project budgeting.

Company Context:
${companyOverview}

Pricing Context:
- Starter tier: $5,000-$25,000/month
- Professional tier: $25,000-$100,000/month  
- Enterprise tier: $100,000-$500,000/month
- Infrastructure program management: Custom pricing based on scope

Create a detailed cost proposal that includes:
1. Cost Summary
2. Detailed Breakdown by Phase
3. Labor Costs and Rates
4. Equipment and Materials
5. Overhead and Administrative Costs
6. Payment Schedule
7. Budget Justification
8. Value Proposition

${adoptedBudgetData ? 'Consider budget context but do not reveal specific budget figures.' : ''}`;

  const userPrompt = `Generate a cost proposal for this opportunity:

Title: ${bidProposal.title}
Organization: ${bidProposal.issuingOrg || 'Government Agency'}
${bidProposal.proposedPrice ? `Proposed Price: $${bidProposal.proposedPrice.toLocaleString()}` : ''}

Description: ${bidProposal.description || 'Not provided'}

Generate a professional cost proposal with detailed pricing breakdown and justification.`;

  try {
    const response = await fetch(`https://apps.abacus.ai/v1/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.ABACUSAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt },
        ],
        temperature: 0.7,
        max_tokens: 3000,
      }),
    });

    if (!response.ok) {
      throw new Error(`AI API error: ${response.statusText}`);
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content || 'Error generating cost proposal';
  } catch (error) {
    console.error('Error generating cost proposal:', error);
    throw error;
  }
}

/**
 * Generate HUB Subcontracting Plan
 */
export async function generateHUBSubcontractingPlan(context: DocumentGenerationContext): Promise<string> {
  const { bidProposal } = context;
  const companyOverview = getCompanyOverview();

  const systemPrompt = `You are an expert in HUB (Historically Underutilized Business) subcontracting plans for government contracts.

Create a comprehensive HUB Subcontracting Plan that includes:
1. Company Commitment to HUB Program
2. Subcontracting Goals and Percentages
3. Good Faith Effort Methods
4. Identification of HUB Subcontractors
5. Scope of Work for Each HUB
6. Monitoring and Compliance Procedures
7. Past Performance with HUBs

Guidelines:
- Demonstrate genuine commitment to HUB utilization
- Set realistic percentage goals (typically 20-30% for construction/services)
- Detail specific outreach and recruitment efforts
- Include monitoring and reporting procedures`;

  const userPrompt = `Generate a HUB Subcontracting Plan for this opportunity:

Title: ${bidProposal.title}
Organization: ${bidProposal.issuingOrg || 'Government Agency'}
Location: ${bidProposal.location || 'Not specified'}

Generate a comprehensive HUB Subcontracting Plan that demonstrates our commitment to supporting historically underutilized businesses.`;

  try {
    const response = await fetch(`https://apps.abacus.ai/v1/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.ABACUSAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt },
        ],
        temperature: 0.7,
        max_tokens: 3000,
      }),
    });

    if (!response.ok) {
      throw new Error(`AI API error: ${response.statusText}`);
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content || 'Error generating HUB plan';
  } catch (error) {
    console.error('Error generating HUB plan:', error);
    throw error;
  }
}

/**
 * Generate Past Performance Document
 */
export async function generatePastPerformance(context: DocumentGenerationContext): Promise<string> {
  const { bidProposal } = context;
  const companyOverview = getCompanyOverview();
  const leadership = getLeadershipBackground();

  const systemPrompt = `You are an expert at showcasing company past performance for government proposals.

Company Background:
${companyOverview}

Leadership Experience:
${leadership}

Create a comprehensive Past Performance document that includes:
1. Company Overview and Capabilities
2. Relevant Project Experience
3. Project Details (scope, value, timeline, outcomes)
4. Client References
5. Performance Metrics and Achievements
6. Lessons Learned and Continuous Improvement

Use specific examples from our infrastructure portfolio.`;

  const userPrompt = `Generate a Past Performance document for this opportunity:

Title: ${bidProposal.title}
Organization: ${bidProposal.issuingOrg || 'Government Agency'}
Description: ${bidProposal.description || 'Not provided'}

Generate a compelling past performance narrative that demonstrates our proven track record in similar work.`;

  try {
    const response = await fetch(`https://apps.abacus.ai/v1/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.ABACUSAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt },
        ],
        temperature: 0.7,
        max_tokens: 3000,
      }),
    });

    if (!response.ok) {
      throw new Error(`AI API error: ${response.statusText}`);
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content || 'Error generating past performance';
  } catch (error) {
    console.error('Error generating past performance:', error);
    throw error;
  }
}

/**
 * Generate document based on type
 */
export async function generateDocument(
  documentType: string,
  context: DocumentGenerationContext
): Promise<string> {
  switch (documentType) {
    case 'technical':
      return await generateTechnicalProposal(context);
    case 'cost':
      return await generateCostProposal(context);
    case 'hub_subcontracting':
      return await generateHUBSubcontractingPlan(context);
    case 'past_performance':
      return await generatePastPerformance(context);
    case 'organizational_chart':
    case 'quality_assurance':
    case 'safety_plan':
    case 'schedule':
    case 'references':
    case 'certifications':
      return await generateGenericDocument(documentType, context);
    default:
      throw new Error(`Unknown document type: ${documentType}`);
  }
}

/**
 * Generate generic document (for other document types)
 */
async function generateGenericDocument(
  documentType: string,
  context: DocumentGenerationContext
): Promise<string> {
  const { bidProposal } = context;
  const companyOverview = getCompanyOverview();

  const documentTitles: Record<string, string> = {
    organizational_chart: 'Project Organizational Chart',
    quality_assurance: 'Quality Assurance Plan',
    safety_plan: 'Safety Plan',
    schedule: 'Project Schedule',
    references: 'Client References',
    certifications: 'Certifications and Licenses',
  };

  const systemPrompt = `You are an expert proposal writer creating a ${documentTitles[documentType]} for CDM Suite.

Company Background:
- Managed $9.3B+ infrastructure programs
- 120%+ profit growth with project controls
- Expert in Oracle Primavera P6, BIM, and infrastructure analytics
- 98% client satisfaction, 95% on-time delivery

Create a comprehensive ${documentTitles[documentType]} that is professional, detailed, and demonstrates our expertise.`;

  const userPrompt = `Generate a ${documentTitles[documentType]} for this opportunity:

Title: ${bidProposal.title}
Organization: ${bidProposal.issuingOrg || 'Government Agency'}
Description: ${bidProposal.description || 'Not provided'}

Generate a professional document that showcases our capabilities and addresses the requirements.`;

  try {
    const response = await fetch(`https://apps.abacus.ai/v1/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.ABACUSAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt },
        ],
        temperature: 0.7,
        max_tokens: 3000,
      }),
    });

    if (!response.ok) {
      throw new Error(`AI API error: ${response.statusText}`);
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content || `Error generating ${documentTitles[documentType]}`;
  } catch (error) {
    console.error(`Error generating ${documentTitles[documentType]}:`, error);
    throw error;
  }
}

// ==========================================
// File: lib/bid-document-types.ts
// ==========================================


/**
 * Bid Document Type Definitions
 * Defines all available document types and their properties
 */

export interface DocumentTypeDefinition {
  type: string;
  title: string;
  description: string;
  category: 'required' | 'optional' | 'custom';
  order: number;
  icon: string;
}

export const DOCUMENT_TYPES: Record<string, DocumentTypeDefinition> = {
  technical: {
    type: 'technical',
    title: 'Technical Proposal',
    description: 'Comprehensive technical approach and methodology',
    category: 'required',
    order: 1,
    icon: 'FileText',
  },
  cost: {
    type: 'cost',
    title: 'Cost Proposal',
    description: 'Detailed pricing breakdown and budget justification',
    category: 'required',
    order: 2,
    icon: 'DollarSign',
  },
  hub_subcontracting: {
    type: 'hub_subcontracting',
    title: 'HUB Subcontracting Plan',
    description: 'Historically Underutilized Business subcontracting plan',
    category: 'optional',
    order: 3,
    icon: 'Users',
  },
  past_performance: {
    type: 'past_performance',
    title: 'Past Performance',
    description: 'Relevant project experience and references',
    category: 'optional',
    order: 4,
    icon: 'Award',
  },
  organizational_chart: {
    type: 'organizational_chart',
    title: 'Organizational Chart',
    description: 'Project team structure and key personnel',
    category: 'optional',
    order: 5,
    icon: 'Sitemap',
  },
  quality_assurance: {
    type: 'quality_assurance',
    title: 'Quality Assurance Plan',
    description: 'QA/QC procedures and quality management approach',
    category: 'optional',
    order: 6,
    icon: 'CheckCircle',
  },
  safety_plan: {
    type: 'safety_plan',
    title: 'Safety Plan',
    description: 'Safety procedures and risk mitigation strategies',
    category: 'optional',
    order: 7,
    icon: 'Shield',
  },
  schedule: {
    type: 'schedule',
    title: 'Project Schedule',
    description: 'Timeline, milestones, and deliverables',
    category: 'optional',
    order: 8,
    icon: 'Calendar',
  },
  references: {
    type: 'references',
    title: 'References',
    description: 'Client references and contact information',
    category: 'optional',
    order: 9,
    icon: 'Phone',
  },
  certifications: {
    type: 'certifications',
    title: 'Certifications & Licenses',
    description: 'Company certifications, licenses, and qualifications',
    category: 'optional',
    order: 10,
    icon: 'Certificate',
  },
};

export const getDocumentType = (type: string): DocumentTypeDefinition | undefined => {
  return DOCUMENT_TYPES[type];
};

export const getRequiredDocuments = (): DocumentTypeDefinition[] => {
  return Object.values(DOCUMENT_TYPES)
    .filter(doc => doc.category === 'required')
    .sort((a, b) => a.order - b.order);
};

export const getOptionalDocuments = (): DocumentTypeDefinition[] => {
  return Object.values(DOCUMENT_TYPES)
    .filter(doc => doc.category === 'optional')
    .sort((a, b) => a.order - b.order);
};

export const getAllDocuments = (): DocumentTypeDefinition[] => {
  return Object.values(DOCUMENT_TYPES).sort((a, b) => a.order - b.order);
};

// ==========================================
// File: lib/bid-intelligence-generator.ts
// ==========================================


/**
 * Bid Intelligence Generator
 * 
 * Generates AI-powered insights for bid proposals including:
 * - Competitive Intelligence
 * - Win Probability Score
 * - Risk Assessment
 * - Outreach Recommendations
 */

import { BidProposalData, CompetitiveIntelligence, WinProbabilityFactors, RiskAssessment, OutreachRecommendations } from './bid-proposal-types';

// Use the same API endpoint as bid-ai-generator.ts for consistency
const ABACUS_AI_ENDPOINT = 'https://apps.abacus.ai/v1/chat/completions';
const ABACUS_AI_KEY = process.env.ABACUSAI_API_KEY || '';
const AI_REQUEST_TIMEOUT = 30000; // 30 seconds timeout
const MAX_RETRIES = 3; // Maximum retry attempts
const INITIAL_RETRY_DELAY = 1000; // Initial delay before retry (1 second)

/**
 * Fetch with timeout to prevent hanging requests
 */
async function fetchWithTimeout(url: string, options: RequestInit, timeoutMs: number = AI_REQUEST_TIMEOUT): Promise<Response> {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
  
  try {
    const response = await fetch(url, {
      ...options,
      signal: controller.signal,
    });
    clearTimeout(timeoutId);
    return response;
  } catch (error: any) {
    clearTimeout(timeoutId);
    if (error.name === 'AbortError') {
      throw new Error('Request timeout - AI API took too long to respond');
    }
    throw error;
  }
}

/**
 * Retry wrapper with exponential backoff
 * Ensures we get complete results instead of placeholders
 */
async function retryWithBackoff<T>(
  fn: () => Promise<T>,
  maxRetries: number = MAX_RETRIES,
  retryDelay: number = INITIAL_RETRY_DELAY
): Promise<T> {
  let lastError: Error | null = null;
  
  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      console.log(`Attempt ${attempt + 1}/${maxRetries + 1} for intelligence generation...`);
      const result = await fn();
      console.log(`✓ Success on attempt ${attempt + 1}`);
      return result;
    } catch (error: any) {
      lastError = error;
      console.warn(`Attempt ${attempt + 1} failed:`, error.message);
      
      // Don't wait after the last attempt
      if (attempt < maxRetries) {
        const delayMs = retryDelay * Math.pow(2, attempt); // Exponential backoff
        console.log(`Retrying in ${delayMs}ms...`);
        await new Promise(resolve => setTimeout(resolve, delayMs));
      }
    }
  }
  
  // All retries exhausted
  console.error(`All ${maxRetries + 1} attempts failed for intelligence generation`);
  throw lastError || new Error('All retry attempts failed');
}

/**
 * Generate competitive intelligence analysis (internal implementation)
 */
async function _generateCompetitiveIntelligence(
  bidProposal: BidProposalData
): Promise<CompetitiveIntelligence> {
  const prompt = `You are a competitive intelligence analyst specializing in government and commercial bids.

Analyze this bid proposal and provide competitive intelligence:

TITLE: ${bidProposal.title}
ISSUING ORG: ${bidProposal.issuingOrg || 'Unknown'}
TYPE: ${bidProposal.solicitationType || 'Unknown'}
DESCRIPTION: ${bidProposal.description || 'Not provided'}
LOCATION: ${bidProposal.location || 'Unknown'}
PROPOSED PRICE: ${bidProposal.proposedPrice ? `$${bidProposal.proposedPrice.toLocaleString()}` : 'Not set'}

Provide a competitive intelligence analysis in this EXACT JSON format:
{
  "strengths": ["List 3-5 key strengths we have for this bid"],
  "opportunities": ["List 3-5 opportunities to capitalize on"],
  "differentiators": ["List 3-5 unique differentiators that set us apart"],
  "recommendations": ["List 3-5 strategic recommendations to increase win probability"]
}

Focus on actionable insights. Be specific and strategic.`;

  const response = await fetchWithTimeout(ABACUS_AI_ENDPOINT, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${ABACUS_AI_KEY}`,
    },
    body: JSON.stringify({
      model: 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: 'You are an expert competitive intelligence analyst. Always respond with valid JSON only, no additional text.',
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      temperature: 0.7,
      max_tokens: 1500,
    }),
  });

  if (!response.ok) {
    throw new Error(`AI API error: ${response.statusText}`);
  }

  const data = await response.json();
  const content = data.choices[0].message.content.trim();
  
  // Parse JSON response
  const jsonMatch = content.match(/\{[\s\S]*\}/);
  if (!jsonMatch) {
    throw new Error('Invalid JSON response from AI');
  }
  
  return JSON.parse(jsonMatch[0]);
}

/**
 * Generate competitive intelligence analysis with automatic retry
 */
export async function generateCompetitiveIntelligence(
  bidProposal: BidProposalData
): Promise<CompetitiveIntelligence> {
  return retryWithBackoff(() => _generateCompetitiveIntelligence(bidProposal));
}

/**
 * Calculate win probability and contributing factors (internal implementation)
 */
async function _calculateWinProbability(
  bidProposal: BidProposalData
): Promise<WinProbabilityFactors> {
  const daysUntilClosing = bidProposal.closingDate
    ? Math.ceil((new Date(bidProposal.closingDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24))
    : null;

  const prompt = `You are a bid success prediction analyst with expertise in government and commercial contracts.

Analyze this bid and calculate the win probability:

TITLE: ${bidProposal.title}
ISSUING ORG: ${bidProposal.issuingOrg || 'Unknown'}
TYPE: ${bidProposal.solicitationType || 'Unknown'}
DESCRIPTION: ${bidProposal.description || 'Not provided'}
DAYS UNTIL CLOSING: ${daysUntilClosing !== null ? daysUntilClosing : 'Unknown'}
PROPOSED PRICE: ${bidProposal.proposedPrice ? `$${bidProposal.proposedPrice.toLocaleString()}` : 'Not set'}
WORKFLOW STAGE: ${bidProposal.workflowStage || 'initial'}
HAS TECHNICAL PROPOSAL: ${bidProposal.envelope1Content ? 'Yes' : 'No'}
HAS COST PROPOSAL: ${bidProposal.envelope2Content ? 'Yes' : 'No'}

Provide a win probability analysis in this EXACT JSON format:
{
  "score": <number between 0-100>,
  "factors": [
    {
      "name": "<factor name>",
      "impact": "<positive|negative|neutral>",
      "weight": <number 1-10>,
      "description": "<brief explanation>"
    }
  ],
  "summary": "<2-3 sentence summary of overall assessment>"
}

Consider factors like: timeline readiness, pricing competitiveness, proposal completeness, organizational fit, and technical complexity.`;

  const response = await fetchWithTimeout(ABACUS_AI_ENDPOINT, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${ABACUS_AI_KEY}`,
    },
    body: JSON.stringify({
      model: 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: 'You are an expert bid success analyst. Always respond with valid JSON only, no additional text.',
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      temperature: 0.5,
      max_tokens: 1200,
    }),
  });

  if (!response.ok) {
    throw new Error(`AI API error: ${response.statusText}`);
  }

  const data = await response.json();
  const content = data.choices[0].message.content.trim();
  
  // Parse JSON response
  const jsonMatch = content.match(/\{[\s\S]*\}/);
  if (!jsonMatch) {
    throw new Error('Invalid JSON response from AI');
  }
  
  return JSON.parse(jsonMatch[0]);
}

/**
 * Calculate win probability and contributing factors with automatic retry
 */
export async function calculateWinProbability(
  bidProposal: BidProposalData
): Promise<WinProbabilityFactors> {
  return retryWithBackoff(() => _calculateWinProbability(bidProposal));
}

/**
 * Generate risk assessment with mitigation strategies (internal implementation)
 */
async function _generateRiskAssessment(
  bidProposal: BidProposalData
): Promise<RiskAssessment> {
  const daysUntilClosing = bidProposal.closingDate
    ? Math.ceil((new Date(bidProposal.closingDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24))
    : null;

  const prompt = `You are a risk management specialist for bid proposals.

Analyze this bid for potential risks:

TITLE: ${bidProposal.title}
ISSUING ORG: ${bidProposal.issuingOrg || 'Unknown'}
TYPE: ${bidProposal.solicitationType || 'Unknown'}
DESCRIPTION: ${bidProposal.description || 'Not provided'}
DAYS UNTIL CLOSING: ${daysUntilClosing !== null ? daysUntilClosing : 'Unknown'}
PROPOSED PRICE: ${bidProposal.proposedPrice ? `$${bidProposal.proposedPrice.toLocaleString()}` : 'Not set'}
LOCATION: ${bidProposal.location || 'Unknown'}

Provide a comprehensive risk assessment in this EXACT JSON format:
{
  "risks": [
    {
      "id": "<unique-id>",
      "category": "<timeline|budget|technical|competitive|compliance>",
      "severity": "<low|medium|high|critical>",
      "title": "<risk title>",
      "description": "<detailed description>",
      "mitigation": "<specific mitigation strategy>",
      "probability": <number 0-100>
    }
  ],
  "overallRiskLevel": "<low|medium|high>"
}

Identify 4-6 key risks across different categories with practical mitigation strategies.`;

  const response = await fetchWithTimeout(ABACUS_AI_ENDPOINT, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${ABACUS_AI_KEY}`,
    },
    body: JSON.stringify({
      model: 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: 'You are an expert risk management analyst. Always respond with valid JSON only, no additional text.',
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      temperature: 0.6,
      max_tokens: 1800,
    }),
  });

  if (!response.ok) {
    throw new Error(`AI API error: ${response.statusText}`);
  }

  const data = await response.json();
  const content = data.choices[0].message.content.trim();
  
  // Parse JSON response
  const jsonMatch = content.match(/\{[\s\S]*\}/);
  if (!jsonMatch) {
    throw new Error('Invalid JSON response from AI');
  }
  
  return JSON.parse(jsonMatch[0]);
}

/**
 * Generate risk assessment with mitigation strategies and automatic retry
 */
export async function generateRiskAssessment(
  bidProposal: BidProposalData
): Promise<RiskAssessment> {
  return retryWithBackoff(() => _generateRiskAssessment(bidProposal));
}

/**
 * Generate strategic outreach recommendations
 */
export async function generateOutreachRecommendations(
  bidProposal: BidProposalData
): Promise<OutreachRecommendations> {
  const daysUntilClosing = bidProposal.closingDate
    ? Math.ceil((new Date(bidProposal.closingDate).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24))
    : null;

  const prompt = `You are a strategic outreach advisor specializing in government and commercial procurement.

Develop outreach recommendations for this bid:

TITLE: ${bidProposal.title}
ISSUING ORG: ${bidProposal.issuingOrg || 'Unknown'}
TYPE: ${bidProposal.solicitationType || 'Unknown'}
CONTACT NAME: ${bidProposal.contactName || 'Unknown'}
CONTACT EMAIL: ${bidProposal.contactEmail || 'Unknown'}
DAYS UNTIL CLOSING: ${daysUntilClosing !== null ? daysUntilClosing : 'Unknown'}

Provide strategic outreach guidance in this EXACT JSON format:
{
  "timing": {
    "bestDays": ["List best days for contact"],
    "bestTimes": ["List optimal time windows"],
    "frequencyGuidance": "<guidance on contact frequency>"
  },
  "messaging": {
    "keyPoints": ["List 3-5 key points to emphasize"],
    "tone": "<recommended communication tone>",
    "approach": "<recommended approach strategy>"
  },
  "followUp": {
    "schedule": [
      {"when": "<timing>", "purpose": "<purpose>"}
    ],
    "templates": [
      {"name": "<template name>", "content": "<brief template>"}
    ]
  },
  "strategicTips": ["List 4-6 strategic tips for engagement"]
}

Be specific and practical with actionable guidance.`;

  try {
    const response = await fetchWithTimeout(ABACUS_AI_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${ABACUS_AI_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: 'You are an expert strategic outreach advisor. Always respond with valid JSON only, no additional text.',
          },
          {
            role: 'user',
            content: prompt,
          },
        ],
        temperature: 0.7,
        max_tokens: 1500,
      }),
    });

    if (!response.ok) {
      throw new Error(`AI API error: ${response.statusText}`);
    }

    const data = await response.json();
    const content = data.choices[0].message.content.trim();
    
    // Parse JSON response
    const jsonMatch = content.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      throw new Error('Invalid JSON response from AI');
    }
    
    return JSON.parse(jsonMatch[0]);
  } catch (error) {
    console.error('Error generating outreach recommendations:', error);
    // Return default recommendations
    return {
      timing: {
        bestDays: ['Tuesday', 'Wednesday', 'Thursday'],
        bestTimes: ['9:00-11:00 AM', '2:00-4:00 PM'],
        frequencyGuidance: 'Contact once per week leading up to question deadline, then increase to twice per week as submission deadline approaches.',
      },
      messaging: {
        keyPoints: [
          'Emphasize relevant past performance and expertise',
          'Highlight unique technical capabilities',
          'Demonstrate understanding of requirements',
          'Show commitment to quality and timeline',
          'Build relationship and establish trust',
        ],
        tone: 'Professional, confident, and solution-oriented',
        approach: 'Consultative approach focusing on value and partnership rather than just pricing',
      },
      followUp: {
        schedule: [
          { when: 'Initial contact within 48 hours', purpose: 'Introduce capabilities and express interest' },
          { when: 'Before question deadline', purpose: 'Ask clarifying questions about requirements' },
          { when: 'Mid-point to deadline', purpose: 'Share preliminary thoughts and confirm understanding' },
          { when: 'One week before closing', purpose: 'Confirm submission plans and final details' },
        ],
        templates: [
          {
            name: 'Initial Introduction',
            content: 'Subject: Re: [Solicitation Number] - Our Interest and Capabilities\n\nDear [Contact Name],\n\nWe are writing to express our strong interest in [Bid Title]. Our team has extensive experience in [relevant area] and we believe we can deliver exceptional value. We would welcome the opportunity to discuss your requirements in more detail.\n\nBest regards,\n[Your Name]',
          },
        ],
      },
      strategicTips: [
        'Research the issuing organization\'s past awards and priorities',
        'Attend any pre-bid conferences or site visits',
        'Ask thoughtful questions that demonstrate expertise',
        'Follow up on all communications promptly',
        'Build relationships beyond just the procurement contact',
        'Document all interactions for future reference',
      ],
    };
  }
}

/**
 * Generate all intelligence insights at once
 */
export async function generateAllIntelligence(
  bidProposal: BidProposalData
): Promise<{
  competitiveIntelligence: CompetitiveIntelligence;
  winProbability: WinProbabilityFactors;
  riskAssessment: RiskAssessment;
  outreachRecommendations: OutreachRecommendations;
}> {
  // Generate all insights in parallel for efficiency
  const [competitiveIntelligence, winProbability, riskAssessment, outreachRecommendations] = await Promise.all([
    generateCompetitiveIntelligence(bidProposal),
    calculateWinProbability(bidProposal),
    generateRiskAssessment(bidProposal),
    generateOutreachRecommendations(bidProposal),
  ]);

  return {
    competitiveIntelligence,
    winProbability,
    riskAssessment,
    outreachRecommendations,
  };
}

// ==========================================
// File: lib/bid-proposal-types.ts
// ==========================================


// Types for Bid Proposal System

export interface BidDocument {
  id: string;
  name: string;
  url: string; // S3 URL or cloud storage path
  size: number;
  type: string; // MIME type
  uploadedAt: Date | string;
}

export interface BidProposalData {
  id: string;
  proposalId?: string | null;
  bidSource: string;
  solicitationNumber: string;
  referenceNumber?: string | null;
  bidUrl?: string | null;
  title: string;
  description?: string | null;
  issuingOrg?: string | null;
  solicitationType?: string | null;
  location?: string | null;
  publicationDate?: Date | string | null;
  bidIntentDeadline?: Date | string | null;
  questionDeadline?: Date | string | null;
  closingDate?: Date | string | null;
  contactName?: string | null;
  contactEmail?: string | null;
  contactPhone?: string | null;
  bidDocuments?: BidDocument[];
  envelope1Status: EnvelopeStatus;
  envelope1Content?: string | null;
  envelope1Documents?: BidDocument[];
  envelope1Notes?: string | null;
  envelope1GeneratedAt?: Date | string | null;
  envelope1GenerationPrompt?: string | null;
  envelope2Status: EnvelopeStatus;
  envelope2Content?: string | null;
  envelope2Pricing?: PricingStructure;
  envelope2Documents?: BidDocument[];
  envelope2Notes?: string | null;
  envelope2GeneratedAt?: Date | string | null;
  envelope2GenerationPrompt?: string | null;
  submissionStatus: SubmissionStatus;
  envelope1SubmittedAt?: Date | string | null;
  envelope2SubmittedAt?: Date | string | null;
  fullySubmittedAt?: Date | string | null;
  baseEmailProposal?: string | null;
  selectedServices?: string[];
  aiModel?: string | null;
  generationMetadata?: any;
  proposedPrice?: number | null;
  priceSource?: string | null;
  pricingNotes?: string | null;
  workflowStage?: string;
  nextSteps?: string | null;
  suggestedFollowUp?: string | null;
  competitiveIntelligence?: string | null;
  winProbabilityScore?: number | null;
  winProbabilityFactors?: string | null;
  riskAssessment?: string | null;
  outreachRecommendations?: string | null;
  intelligenceGeneratedAt?: Date | string | null;
  adoptedBudgetData?: AdoptedBudgetData | null;
  adoptedBudgetAnalyzedAt?: Date | string | null;
  processingStatus?: ProcessingStatus;
  processingStage?: ProcessingStage | null;
  processingProgress?: number;
  processingMessage?: string | null;
  processingError?: string | null;
  processingStartedAt?: Date | string | null;
  processingCompletedAt?: Date | string | null;
  
  // Phase 1 Enhancements
  generalProposalComment?: string | null;
  
  // HUB/Subcontracting Plan Logic
  hubPlanRequired?: boolean;
  hubFeeThreshold?: number | null;
  hubIntentWaiverGenerated?: boolean;
  hubIntentWaiverContent?: string | null;
  
  // Business Listing Verification
  businessListings?: BusinessListing[] | null;
  businessVerificationStatus?: BusinessVerificationStatus;
  businessVerificationResults?: BusinessVerificationResult[] | null;
  businessVerificationNote?: string | null;
  
  // Title and Cover Page Management
  proposalTitle?: string | null;
  coverPageContent?: string | null;
  
  createdById: string;
  lastEditedById?: string | null;
  lastEditedAt?: Date | string | null;
  createdAt: Date | string;
  updatedAt: Date | string;
}

// Business Listing Types
export interface BusinessListing {
  id: string;
  businessName: string;
  contactPerson?: string | null;
  email?: string | null;
  phone?: string | null;
  address?: string | null;
  certifications?: string[];
  role: 'subcontractor' | 'helper' | 'partner' | 'consultant';
  proposedScope?: string | null;
  estimatedValue?: number | null;
}

export interface BusinessVerificationResult {
  businessId: string;
  businessName: string;
  exists: boolean;
  status?: 'active' | 'inactive' | 'suspended' | 'unknown';
  verificationDate: string;
  verificationSource?: string;
  notes?: string;
  requiresPartnershipConfirmation?: boolean;
}

export type BusinessVerificationStatus = 'not_verified' | 'verifying' | 'verified' | 'failed';

// Processing Status Types
export type ProcessingStatus = 'idle' | 'extracting' | 'generating' | 'completed' | 'error';

export type ProcessingStage = 
  | 'uploading_files'
  | 'extracting_pdf'
  | 'extracting_email'
  | 'analyzing_content'
  | 'detecting_client_type'
  | 'researching_budget'
  | 'generating_proposal'
  | 'generating_intelligence'
  | 'finalizing';

export interface ProcessingStatusInfo {
  status: ProcessingStatus;
  stage: ProcessingStage | null;
  progress: number;
  message: string | null;
  error: string | null;
  startedAt: Date | string | null;
  completedAt: Date | string | null;
}

// Adopted Budget Data for Government/Enterprise Clients
export interface AdoptedBudgetData {
  clientType: 'government' | 'enterprise' | 'commercial';
  totalAnnualBudget?: number | null;
  relevantDepartmentBudget?: number | null;
  capitalProgramBudget?: number | null;
  fiscalYear: string;
  budgetSource?: string | null; // URL or document reference
  fundingPriorities?: string[];
  budgetAlignment?: string | null; // AI analysis of alignment
  proportionalityAnalysis?: string | null; // How our price compares to their budget
  strategicAlignment?: string | null; // How project aligns with their priorities
}

// Intelligence Types
export interface CompetitiveIntelligence {
  strengths: string[];
  opportunities: string[];
  differentiators: string[];
  recommendations: string[];
}

export interface WinProbabilityFactors {
  score: number; // 0-100
  factors: {
    name: string;
    impact: 'positive' | 'negative' | 'neutral';
    weight: number;
    description: string;
  }[];
  summary: string;
}

export interface RiskAssessment {
  risks: {
    id: string;
    category: 'timeline' | 'budget' | 'technical' | 'competitive' | 'compliance';
    severity: 'low' | 'medium' | 'high' | 'critical';
    title: string;
    description: string;
    mitigation: string;
    probability: number; // 0-100
  }[];
  overallRiskLevel: 'low' | 'medium' | 'high';
}

export interface OutreachRecommendations {
  timing: {
    bestDays: string[];
    bestTimes: string[];
    frequencyGuidance: string;
  };
  messaging: {
    keyPoints: string[];
    tone: string;
    approach: string;
  };
  followUp: {
    schedule: { when: string; purpose: string; }[];
    templates: { name: string; content: string; }[];
  };
  strategicTips: string[];
}

export type EnvelopeStatus = 'draft' | 'in_progress' | 'completed' | 'submitted';
export type SubmissionStatus = 'not_submitted' | 'envelope1_submitted' | 'envelope2_submitted' | 'fully_submitted';

export interface PricingStructure {
  totalBidPrice: number;
  breakdown?: PricingBreakdownItem[];
  taxes?: number;
  notes?: string;
}

export interface PricingBreakdownItem {
  id: string;
  description: string;
  quantity: number;
  unitPrice: number;
  total: number;
  category?: string;
}

export interface BidProposalFormData {
  solicitationNumber: string;
  referenceNumber?: string;
  bidUrl?: string;
  title: string;
  description?: string;
  issuingOrg?: string;
  solicitationType?: string;
  location?: string;
  publicationDate?: string;
  bidIntentDeadline?: string;
  questionDeadline?: string;
  closingDate?: string;
  contactName?: string;
  contactEmail?: string;
  contactPhone?: string;
  bidSource?: string;
}

export interface AIGenerationRequest {
  bidProposalId: string;
  envelopeType: 1 | 2; // 1 = Technical, 2 = Cost
  context: {
    bidDetails: BidProposalData;
    bidDocumentsContent?: string; // Extracted text from bid documents
    selectedServices?: string[]; // CDM Suite services to include
    baseEmailProposal?: string; // Previous email proposal as reference
    customInstructions?: string; // User's custom generation instructions
  };
}

export interface AIGenerationResponse {
  success: boolean;
  content?: string;
  pricing?: {
    proposedPrice: number;
    priceSource: 'extracted' | 'market_research' | 'manual';
    pricingNotes?: string;
    complexity?: 'low' | 'medium' | 'high';
    priceRange?: { min: number; max: number };
  };
  adoptedBudgetData?: AdoptedBudgetData | null;
  metadata?: {
    model: string;
    promptTokens: number;
    completionTokens: number;
    totalTokens: number;
    generatedAt: string;
  };
  error?: string;
}

// Helper functions
export function generateBidProposalNumber(): string {
  const year = new Date().getFullYear();
  const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  return `BID-${year}-${random}`;
}

export function getEnvelopeStatusBadge(status: EnvelopeStatus): {
  label: string;
  className: string;
} {
  const badges = {
    draft: { label: 'Draft', className: 'bg-gray-100 text-gray-700' },
    in_progress: { label: 'In Progress', className: 'bg-blue-100 text-blue-700' },
    completed: { label: 'Completed', className: 'bg-green-100 text-green-700' },
    submitted: { label: 'Submitted', className: 'bg-purple-100 text-purple-700' },
  };
  return badges[status];
}

export function getSubmissionStatusBadge(status: SubmissionStatus): {
  label: string;
  className: string;
} {
  const badges = {
    not_submitted: { label: 'Not Submitted', className: 'bg-gray-100 text-gray-700' },
    envelope1_submitted: { label: 'Tech Proposal Submitted', className: 'bg-blue-100 text-blue-700' },
    envelope2_submitted: { label: 'Cost Proposal Submitted', className: 'bg-blue-100 text-blue-700' },
    fully_submitted: { label: 'Fully Submitted', className: 'bg-green-100 text-green-700' },
  };
  return badges[status];
}

// ==========================================
// File: lib/blog-formatter.ts
// ==========================================

/**
 * Enhanced blog post content formatter
 * Transforms plain HTML into beautifully formatted content
 */

export function enhanceBlogContent(content: string): string {
  let enhanced = content;

  // FIRST: Add proper spacing between HTML elements
  // Add newlines before and after major block elements
  enhanced = enhanced.replace(/<\/p><p>/gi, '</p>\n\n<p>');
  enhanced = enhanced.replace(/<\/p><h/gi, '</p>\n\n<h');
  enhanced = enhanced.replace(/<\/h([1-6])><p>/gi, '</h$1>\n\n<p>');
  enhanced = enhanced.replace(/<\/h([1-6])><h/gi, '</h$1>\n\n<h');
  enhanced = enhanced.replace(/<\/ul><p>/gi, '</ul>\n\n<p>');
  enhanced = enhanced.replace(/<\/p><ul>/gi, '</p>\n\n<ul>');
  enhanced = enhanced.replace(/<\/ol><p>/gi, '</ol>\n\n<p>');
  enhanced = enhanced.replace(/<\/p><ol>/gi, '</p>\n\n<ol>');
  enhanced = enhanced.replace(/<li>/gi, '\n  <li>');
  enhanced = enhanced.replace(/<\/li>/gi, '</li>\n');
  enhanced = enhanced.replace(/<ul>/gi, '<ul>\n');
  enhanced = enhanced.replace(/<\/ul>/gi, '\n</ul>');
  enhanced = enhanced.replace(/<ol>/gi, '<ol>\n');
  enhanced = enhanced.replace(/<\/ol>/gi, '\n</ol>');

  // Add wrapper divs for better styling control
  enhanced = enhanced.replace(/<h2>(.*?)<\/h2>/gi, (match, text) => {
    return `\n\n<div class="section-break"></div>\n<h2>${text}</h2>`;
  });

  // Enhance lists with better spacing and icons
  enhanced = enhanced.replace(/<ul>(.*?)<\/ul>/gis, (match, items) => {
    return `<ul class="feature-list">${items}</ul>`;
  });

  enhanced = enhanced.replace(/<ol>(.*?)<\/ol>/gis, (match, items) => {
    return `<ol class="numbered-list">${items}</ol>`;
  });

  // Add styling to emphasis and strong tags
  enhanced = enhanced.replace(/<strong>(.*?)<\/strong>/gi, '<strong class="highlight">$1</strong>');
  
  // Enhance links
  enhanced = enhanced.replace(/<a href="([^"]*)">(.*?)<\/a>/gi, '<a href="$1" class="inline-link" target="_blank" rel="noopener noreferrer">$2</a>');

  // Add call-out boxes for important paragraphs (those starting with Note:, Important:, etc.)
  enhanced = enhanced.replace(/<p>(Note:|Important:|Warning:|Tip:|Pro Tip:)(.*?)<\/p>/gi, '<div class="callout callout-info"><p><strong>$1</strong>$2</p></div>');

  // Format citations/references better [1], [2], etc.
  enhanced = enhanced.replace(/\[(\d+)\]/g, '<sup class="citation"><a href="#ref-$1">[$1]</a></sup>');

  // Enhance paragraphs after headings
  enhanced = enhanced.replace(/<\/h[23]>\s*<p>/gi, (match) => {
    return match.replace('<p>', '\n<p class="lead-paragraph">');
  });

  return enhanced;
}

/**
 * Clean up and sanitize blog content
 */
export function sanitizeBlogContent(content: string): string {
  // Remove any potentially harmful scripts
  let sanitized = content.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
  
  // Remove inline styles that might break our design
  sanitized = sanitized.replace(/style="[^"]*"/gi, '');
  
  // Ensure all images have alt text
  sanitized = sanitized.replace(/<img([^>]*)>/gi, (match, attrs) => {
    if (!attrs.includes('alt=')) {
      return `<img${attrs} alt="Blog post image">`;
    }
    return match;
  });

  return sanitized;
}

/**
 * Add reading progress indicators
 */
export function wrapContentInSections(content: string): string {
  // Split content by h2 tags to create sections
  const sections = content.split(/(<h2[^>]*>.*?<\/h2>)/gi);
  
  let wrapped = '';
  for (let i = 0; i < sections.length; i++) {
    if (sections[i].match(/<h2/)) {
      // Start new section
      if (i > 0) wrapped += '</section>';
      wrapped += '<section class="blog-section">' + sections[i];
    } else {
      wrapped += sections[i];
    }
  }
  
  if (wrapped.includes('<section')) {
    wrapped += '</section>';
  }
  
  return wrapped;
}

/**
 * Format code blocks with syntax highlighting classes
 */
export function enhanceCodeBlocks(content: string): string {
  return content.replace(/<pre><code>(.*?)<\/code><\/pre>/gis, (match, code) => {
    return `<pre class="code-block"><code>${code}</code></pre>`;
  });
}

/**
 * Master function to apply all enhancements
 */
export function formatBlogPost(content: string): string {
  let formatted = sanitizeBlogContent(content);
  formatted = enhanceBlogContent(formatted);
  formatted = enhanceCodeBlocks(formatted);
  
  return formatted;
}

// ==========================================
// File: lib/blog-knowledge.ts
// ==========================================


import { prisma } from './db';

export async function searchBlogPosts(query: string, limit: number = 5) {
  try {
    // Simple search - in production, use full-text search or Algolia
    const posts = await prisma.blogPost.findMany({
      where: {
        status: 'published',
        OR: [
          { title: { contains: query } },
          { content: { contains: query } },
          { excerpt: { contains: query } },
          { tags: { contains: query } },
          { categories: { contains: query } },
        ],
      },
      take: limit,
      select: {
        title: true,
        slug: true,
        excerpt: true,
        categories: true,
        publishedAt: true,
      },
      orderBy: {
        views: 'desc',
      },
    });

    return posts;
  } catch (error) {
    console.error('Error searching blog posts:', error);
    return [];
  }
}

export async function getRelevantBlogContext(query: string): Promise<string> {
  const posts = await searchBlogPosts(query, 3);

  if (posts.length === 0) {
    return '';
  }

  const context = posts.map(
    (post: { title: string; slug: string; excerpt: string | null }, idx: number) =>
      `[${idx + 1}] "${post.title}" - ${post.excerpt || 'Read more at'} https://cdmsuite.com/blog/${post.slug}`
  ).join('\n\n');

  return `\n\nRelevant blog articles from our knowledge base:\n${context}\n\n`;
}

export async function getPopularPosts(limit: number = 10) {
  return await prisma.blogPost.findMany({
    where: { status: 'published' },
    take: limit,
    orderBy: { views: 'desc' },
    select: {
      title: true,
      slug: true,
      categories: true,
      views: true,
    },
  });
}

// ==========================================
// File: lib/blog-seo.ts
// ==========================================


import { BlogPost } from '@prisma/client';

export type FormattedBlogPost = Omit<BlogPost, 'tags' | 'categories'> & {
  tags: string[];
  categories: string[];
};

export function generateStructuredData(post: FormattedBlogPost) {
  const structuredData = {
    '@context': 'https://schema.org',
    '@type': 'BlogPosting',
    headline: post.title,
    description: post.excerpt || post.content.substring(0, 160),
    author: {
      '@type': 'Organization',
      name: post.author,
      url: 'https://cdmsuite.com',
    },
    publisher: {
      '@type': 'Organization',
      name: 'CDM Suite',
      logo: {
        '@type': 'ImageObject',
        url: 'https://yt3.googleusercontent.com/EXz-YSeplAFRB88g3pd_EqiywVymmsnMpfYB-FbGxiZgtVvwYQ7Y0dWTaONuxSPmfgWh1_q9=s900-c-k-c0x00ffffff-no-rj',
      },
    },
    datePublished: post.publishedAt?.toISOString(),
    dateModified: post.updatedAt.toISOString(),
    image: post.featuredImage || 'https://i.ytimg.com/vi/_SW66S-1x08/maxresdefault.jpg',
    mainEntityOfPage: {
      '@type': 'WebPage',
      '@id': `https://cdmsuite.com/blog/${post.slug}`,
    },
    keywords: post.tags.join(', '),
    articleSection: post.categories.join(', '),
    wordCount: post.content.replace(/<[^>]*>/g, '').split(/\s+/).length,
    inLanguage: 'en-US',
  };

  return structuredData;
}

export function calculateReadTime(content: string): number {
  const wordsPerMinute = 200;
  const wordCount = content.replace(/<[^>]*>/g, '').split(/\s+/).length;
  return Math.ceil(wordCount / wordsPerMinute);
}

export function generateMetaDescription(post: BlogPost): string {
  if (post.excerpt) return post.excerpt.substring(0, 160);

  const cleanContent = post.content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
  return cleanContent.length > 157
    ? cleanContent.substring(0, 157) + '...'
    : cleanContent;
}

export function extractHeadings(content: string): { level: number; text: string; id: string }[] {
  const headingRegex = /<h([1-6])[^>]*>(.*?)<\/h\1>/gi;
  const headings: { level: number; text: string; id: string }[] = [];

  let match;
  while ((match = headingRegex.exec(content)) !== null) {
    const level = parseInt(match[1]);
    const text = match[2].replace(/<[^>]*>/g, '');
    const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-');
    headings.push({ level, text, id });
  }

  return headings;
}

export function addIdsToHeadings(content: string): string {
  return content.replace(/<h([1-6])[^>]*>(.*?)<\/h\1>/gi, (match, level, text) => {
    const cleanText = text.replace(/<[^>]*>/g, '');
    const id = cleanText.toLowerCase().replace(/[^a-z0-9]+/g, '-');
    return `<h${level} id="${id}">${text}</h${level}>`;
  });
}

// ==========================================
// File: lib/builder/content-improver.ts
// ==========================================


// AI-powered content improvement utilities

export interface ContentImprovementRequest {
  content: string;
  action: 'shorten' | 'professional' | 'casual' | 'formal' | 'friendly' | 'authoritative' | 'grammar' | 'expand' | 'simplify';
  context?: string;
}

export async function improveContent(request: ContentImprovementRequest): Promise<string> {
  const { content, action, context } = request;

  const prompts: Record<string, string> = {
    shorten: `Make this text shorter and more concise while keeping the key message:\n\n"${content}"`,
    professional: `Rewrite this text in a more professional tone:\n\n"${content}"`,
    casual: `Rewrite this text in a more casual, friendly tone:\n\n"${content}"`,
    formal: `Rewrite this text in a formal, authoritative tone:\n\n"${content}"`,
    friendly: `Rewrite this text in a warm, friendly, approachable tone:\n\n"${content}"`,
    authoritative: `Rewrite this text to sound more authoritative and confident:\n\n"${content}"`,
    grammar: `Fix any grammar, spelling, and punctuation errors in this text:\n\n"${content}"`,
    expand: `Expand this text with more details and examples:\n\n"${content}"`,
    simplify: `Simplify this text to make it easier to understand:\n\n"${content}"`,
  };

  const prompt = prompts[action] || prompts.professional;
  const fullPrompt = context 
    ? `${context}\n\n${prompt}\n\nRespond with ONLY the improved text, no explanations.`
    : `${prompt}\n\nRespond with ONLY the improved text, no explanations.`;

  try {
    const response = await fetch('https://apps.abacus.ai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.ABACUSAI_API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-4.1-mini',
        messages: [
          {
            role: 'system',
            content: 'You are an expert content editor. Improve the given text according to the specified action. Return only the improved text without any explanations or additional commentary.'
          },
          {
            role: 'user',
            content: fullPrompt
          }
        ],
        max_tokens: 500,
        temperature: 0.7
      }),
    });

    if (!response.ok) {
      throw new Error(`AI API error: ${response.statusText}`);
    }

    const data = await response.json();
    const improvedText = data.choices?.[0]?.message?.content || content;
    
    // Clean up response - remove quotes if AI added them
    return improvedText.replace(/^["']|["']$/g, '').trim();
  } catch (error) {
    console.error('Content improvement error:', error);
    return content; // Return original on error
  }
}

// Batch improve multiple content pieces
export async function batchImproveContent(
  requests: ContentImprovementRequest[]
): Promise<string[]> {
  const results = await Promise.all(
    requests.map(request => improveContent(request))
  );
  return results;
}

// ==========================================
// File: lib/builder/image-generator.ts
// ==========================================


// Image generation and download utilities for AI website builder

export async function findAndDownloadImage(description: string): Promise<string | null> {
  try {
    // Call asset retrieval API to find and download image
    const response = await fetch("/api/builder/download-image", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ description }),
    });

    if (!response.ok) {
      console.error("Failed to download image:", await response.text());
      return null;
    }

    const data = await response.json();
    return data.imageUrl || null;
  } catch (error) {
    console.error("Image download error:", error);
    return null;
  }
}

export async function downloadImagesForContent(content: any): Promise<any> {
  // This function will process the generated content and download all images
  const processedContent = { ...content };

  // Process each page
  if (processedContent.pages && Array.isArray(processedContent.pages)) {
    for (let pageIndex = 0; pageIndex < processedContent.pages.length; pageIndex++) {
      const page = processedContent.pages[pageIndex];

      // Download hero image
      if (page.hero?.imageDescription) {
        const imageUrl = await findAndDownloadImage(page.hero.imageDescription);
        if (imageUrl) {
          page.hero.image = imageUrl;
        }
      }

      // Download section images
      if (page.sections && Array.isArray(page.sections)) {
        for (let sectionIndex = 0; sectionIndex < page.sections.length; sectionIndex++) {
          const section = page.sections[sectionIndex];

          // Section image
          if (section.imageDescription) {
            const imageUrl = await findAndDownloadImage(section.imageDescription);
            if (imageUrl) {
              section.image = imageUrl;
            }
          }

          // Item images
          if (section.items && Array.isArray(section.items)) {
            for (let itemIndex = 0; itemIndex < section.items.length; itemIndex++) {
              const item = section.items[itemIndex];
              if (item.imageDescription) {
                const imageUrl = await findAndDownloadImage(item.imageDescription);
                if (imageUrl) {
                  item.image = imageUrl;
                }
              }
            }
          }
        }
      }
    }
  }

  return processedContent;
}

// ==========================================
// File: lib/builder/prompts.ts
// ==========================================

// AI Prompts for Website Generation

export function buildWebsiteGenerationPrompt(data: {
  businessName: string;
  industry: string;
  services: string[];
  targetAudience: string;
  goals: string[];
  template: string;
  existingWebsite?: string;
  auditInsights?: any;
}): string {
  const { businessName, industry, services, targetAudience, goals, template, existingWebsite, auditInsights } = data;

  // Check if it's an e-commerce template
  const isEcommerce = template.toLowerCase().includes('ecommerce') || 
                     template.toLowerCase().includes('store') || 
                     template.toLowerCase().includes('shop');

  let prompt = `You are an expert website content generator. Create a COMPLETE, FULL-FEATURED, MULTI-PAGE professional website with ALL necessary content for the following business:

**Business Details:**
- Name: ${businessName}
- Industry: ${industry}
- Services: ${services.join(", ")}
- Target Audience: ${targetAudience}
- Goals: ${goals.join(", ")}
- Template Style: ${template}

`;

  if (existingWebsite) {
    prompt += `**Existing Website:** ${existingWebsite}\n\n`;
  }

  if (auditInsights) {
    prompt += `**Website Audit Insights:**
- SEO Score: ${auditInsights.seoScore}/100
- Performance Score: ${auditInsights.performanceScore}/100
- Key Issues: ${auditInsights.issues?.slice(0, 3).join(", ") || "None"}
- Recommendations: ${auditInsights.recommendations?.slice(0, 3).join(", ") || "None"}

Use these insights to create improved content that addresses the identified issues.

`;
  }

  prompt += `**CRITICAL REQUIREMENTS:**
1. Create a COMPLETE MULTI-PAGE WEBSITE (minimum ${isEcommerce ? '7-8' : '6-7'} pages) - NOT just a landing page
2. Include ALL standard pages: Home, About, ${isEcommerce ? 'Shop/Products,' : 'Services,'} Portfolio/Work, Blog, Contact
3. Each page must have MULTIPLE sections with rich, detailed content
4. Include image requirements and descriptions for EVERY section
5. Write 300-500 words of content per page minimum
6. Include realistic placeholder data for portfolios, team members, testimonials${isEcommerce ? ', products with prices' : ''}, etc.
7. Make content HIGHLY SPECIFIC to the industry and business type - NO generic business language
8. Use a UNIQUE voice and personality that matches the ${targetAudience} audience
9. Add industry-specific jargon, terminology, and insider knowledge
10. Create DISTINCTIVE section titles that stand out (avoid "Our Services", "About Us" - be creative!)
`;

  if (isEcommerce) {
    prompt += `11. FOR E-COMMERCE: Include a Shop/Products page with AT LEAST 8-12 products, each with title, description, price (as string like "29.99"), and imageDescription\n`;
  }

  prompt += `
**Task:**
Generate complete website content in JSON format following this structure (adapt field names as needed but keep this overall structure).
`;

  // Add shop page example for ecommerce
  if (isEcommerce) {
    prompt += `
For e-commerce sites, include a shop/products page like this example:
{
  "slug": "shop",
  "title": "Shop",
  "metaTitle": "${businessName} Shop - Browse Our Products",
  "metaDescription": "Shop our collection of quality products",
  "hero": {
    "headline": "Shop Our Collection",
    "subheadline": "Discover quality products designed for your needs",
    "imageDescription": "Product showcase"
  },
  "sections": [
    {
      "type": "products",
      "title": "Featured Products",
      "content": "Browse our selection",
      "items": [
        {
          "title": "Product Name",
          "description": "Product description with features and benefits",
          "price": "29.99",
          "imageDescription": "High-quality product photo"
        }
        // Include 8-12 products minimum
      ]
    }
  ]
}
`;
  }

  prompt += `
Generate a complete JSON object with these required fields:
{
  "siteName": "${businessName}",
  "tagline": "Compelling brand tagline (10-15 words)",
  "pages": [
    // Array of page objects, each with:
    // - slug: URL-friendly page identifier (e.g., "home", "about", "services")
    // - title: FULL descriptive title for page content (can be long and specific)
    // - navLabel: SHORT 1-2 word label for navigation menu (CRITICAL: Must be concise!)
    // - metaTitle: SEO title (50-60 chars)
    // - metaDescription: SEO description
    // - hero object with headline, subheadline, cta, ctaSecondary, imageDescription
    // - sections array with type, title, content, items (if applicable)
    // Minimum 6-7 pages (${isEcommerce ? '7-8 for ecommerce with shop page' : 'including home, about, services, portfolio, blog, contact'})
  ],
  "contact": {
    "email": "Generated email",
    "phone": "Generated phone",
    "address": "Generated address",
    "hours": "Business hours"
  },
  "seo": {
    "metaTitle": "Main site SEO title (50-60 chars)",
    "metaDescription": "Main site description (150-160 chars)",
    "keywords": ["keyword1", "keyword2", "keyword3"]
  }
}

**CRITICAL: Navigation Label Requirements**
The 'navLabel' field is displayed in the website's navigation menu. It MUST be:
- Maximum 1-2 words (e.g., "Home", "About", "Services", "Contact")
- Simple and clear (NOT "Our Services" or "About Us" - just "Services", "About")
- Professional standard web navigation terms
- Never use full sentences or descriptive phrases

**Examples of CORRECT navLabel values:**
✓ "Home" (not "Welcome to Our Business")
✓ "About" (not "Our Story and Mission")
✓ "Services" (not "What We Offer")
✓ "Portfolio" or "Work" (not "Our Amazing Projects")
✓ "Team" (not "Meet Our Experts")
✓ "Blog" or "Resources" (not "Latest News and Insights")
✓ "Contact" (not "Get In Touch Today")
✓ "Shop" or "Products" (not "Browse Our Collection")

**Page Types to Include:**
1. **Home** - navLabel: "Home" | Hero, services/products preview, about snippet, testimonials, CTA
2. **About** - navLabel: "About" | Company story, team profiles (3+ members), stats/achievements
3. **${isEcommerce ? 'Shop/Products' : 'Services'}** - navLabel: "${isEcommerce ? 'Shop' : 'Services'}" | ${isEcommerce ? '8-12 products with prices and descriptions' : 'Detailed service offerings'}, process/benefits
4. **Portfolio/Work** - navLabel: "Portfolio" or "Work" | 3+ project examples with descriptions and images
5. **Blog** - navLabel: "Blog" or "Resources" | 3+ article previews with summaries
6. **Contact** - navLabel: "Contact" | Contact methods, FAQ section (3+ questions), location info

**Content Requirements:**
- Use industry-specific terminology and ${targetAudience}-focused language
- Include appropriate Lucide React icon names for all icons (e.g., "check-circle", "zap", "users", "mail", "phone", "map-pin")
- Make CTAs specific and action-oriented (e.g., "Get Your Free Audit" not "Learn More")
- Add realistic business details (properly formatted)
- Write detailed, realistic content - NO "Lorem ipsum" placeholders
- Every section and item MUST include imageDescription field
- For ${isEcommerce ? 'products' : 'services'}, write 100+ words per item describing features and benefits

**Personality & Voice Guidelines for ${industry} targeting ${targetAudience}:**
- ${getIndustryVoiceGuidelines(industry, targetAudience)}
- Headlines should be POWERFUL and SPECIFIC (e.g., "${getHeadlineExample(industry)}" instead of generic "Welcome to Our Business")
- Use numbers, statistics, and data points where relevant
- Include social proof elements (client names, specific results, awards)
- Add urgency and value propositions throughout
- Write in a conversational yet professional tone
- Use power words and emotional triggers appropriate for the audience

**Design & Structure:**
- Hero sections should have compelling, benefit-driven headlines
- Services/products should focus on outcomes and transformations, not just features
- About section should tell a compelling story with the team's expertise
- Portfolio should showcase real results with before/after or case study format
- Blog posts should address specific pain points of ${targetAudience}
- Contact page should have strong reasons to reach out now

Respond with ONLY the raw JSON object. No markdown, no code blocks, no additional text.`;

  return prompt;
}

function getIndustryVoiceGuidelines(industry: string, audience: string): string {
  const industryLower = industry.toLowerCase();
  
  if (industryLower.includes('tech') || industryLower.includes('software') || industryLower.includes('saas')) {
    return `Use innovative, forward-thinking language. Focus on efficiency, automation, and ROI. Be data-driven and highlight scalability.`;
  }
  
  if (industryLower.includes('health') || industryLower.includes('medical') || industryLower.includes('fitness')) {
    return `Use empathetic, caring language. Focus on transformation, wellness, and life improvement. Be trustworthy and evidence-based.`;
  }
  
  if (industryLower.includes('legal') || industryLower.includes('law')) {
    return `Use authoritative, confident language. Focus on protection, peace of mind, and expertise. Be professional and results-oriented.`;
  }
  
  if (industryLower.includes('real estate') || industryLower.includes('property')) {
    return `Use aspirational, dream-focused language. Emphasize lifestyle, investment, and opportunity. Be personable yet professional.`;
  }
  
  if (industryLower.includes('food') || industryLower.includes('restaurant') || industryLower.includes('cafe')) {
    return `Use sensory, experiential language. Focus on taste, quality, and experience. Be warm, inviting, and community-focused.`;
  }
  
  if (industryLower.includes('fashion') || industryLower.includes('retail') || industryLower.includes('ecommerce')) {
    return `Use trendy, aspirational language. Focus on style, uniqueness, and self-expression. Be bold and visually descriptive.`;
  }
  
  if (industryLower.includes('agency') || industryLower.includes('marketing') || industryLower.includes('creative')) {
    return `Use bold, creative language. Focus on innovation, results, and partnerships. Be confident and showcase thought leadership.`;
  }
  
  if (industryLower.includes('consulting') || industryLower.includes('professional services')) {
    return `Use expert, strategic language. Focus on problem-solving, insights, and transformation. Be authoritative yet approachable.`;
  }
  
  if (industryLower.includes('education') || industryLower.includes('training') || industryLower.includes('course')) {
    return `Use empowering, growth-focused language. Focus on learning, transformation, and achievement. Be encouraging and results-driven.`;
  }
  
  return `Use professional, benefit-focused language. Emphasize value, quality, and customer success. Be authentic and trustworthy.`;
}

function getHeadlineExample(industry: string): string {
  const industryLower = industry.toLowerCase();
  
  if (industryLower.includes('tech') || industryLower.includes('software')) {
    return "Scale Your Business 10X with AI-Powered Automation";
  }
  if (industryLower.includes('health') || industryLower.includes('fitness')) {
    return "Transform Your Body in 90 Days - Guaranteed Results";
  }
  if (industryLower.includes('legal') || industryLower.includes('law')) {
    return "Protecting Your Rights with 20+ Years of Trial Experience";
  }
  if (industryLower.includes('real estate')) {
    return "Find Your Dream Home in [City] - Expert Local Guidance";
  }
  if (industryLower.includes('food') || industryLower.includes('restaurant')) {
    return "Farm-to-Table Cuisine That Tells a Story";
  }
  if (industryLower.includes('fashion') || industryLower.includes('retail')) {
    return "Sustainable Fashion That Doesn't Compromise on Style";
  }
  if (industryLower.includes('agency') || industryLower.includes('marketing')) {
    return "Grow Your Revenue 300% with Data-Driven Marketing";
  }
  if (industryLower.includes('consulting')) {
    return "Strategic Consulting That Drives Measurable Business Growth";
  }
  if (industryLower.includes('education')) {
    return "Master [Skill] in 12 Weeks - Career Transformation Guaranteed";
  }
  
  return "Exceptional Results Through Professional Excellence";
}

export function buildChatResponsePrompt(
  userMessage: string,
  conversationHistory: Array<{ role: string; content: string }>,
  businessData?: any
): string {
  let context = "You are an AI website builder assistant helping users create their perfect website. ";
  
  if (businessData) {
    context += `Current business details: ${JSON.stringify(businessData)}. `;
  }
  
  context += "Ask clarifying questions about their business, services, target audience, and design preferences. Keep responses concise and friendly.";
  
  return context;
}

// ==========================================
// File: lib/builder/sitemap-generator.ts
// ==========================================


// Sitemap generation utilities

export interface SitemapPage {
  url: string;
  lastModified: Date;
  changeFrequency: 'always' | 'hourly' | 'daily' | 'weekly' | 'monthly' | 'yearly' | 'never';
  priority: number;
}

export function generateSitemap(subdomain: string, pages: any[], baseUrl?: string): string {
  const domain = baseUrl || `https://${subdomain}.cdmsuite.com`;
  
  // Filter out hidden pages and add URLs
  const sitemapPages: SitemapPage[] = pages
    .filter((page: any) => !page.hidden && page.slug)
    .map((page: any) => ({
      url: page.slug === 'home' 
        ? domain 
        : `${domain}?page=${page.slug}`,
      lastModified: new Date(),
      changeFrequency: getChangeFrequency(page.slug),
      priority: getPriority(page.slug),
    }));

  // Generate XML
  const xml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
${sitemapPages.map(page => `  <url>
    <loc>${escapeXml(page.url)}</loc>
    <lastmod>${page.lastModified.toISOString()}</lastmod>
    <changefreq>${page.changeFrequency}</changefreq>
    <priority>${page.priority}</priority>
  </url>`).join('\n')}
</urlset>`;

  return xml;
}

function getChangeFrequency(slug: string): SitemapPage['changeFrequency'] {
  // Home page changes more frequently
  if (slug === 'home') return 'daily';
  
  // Blog/news pages change frequently
  if (slug === 'blog' || slug === 'news') return 'daily';
  
  // Products/shop pages change regularly
  if (slug === 'shop' || slug === 'products' || slug === 'store') return 'weekly';
  
  // Most other pages are monthly
  return 'monthly';
}

function getPriority(slug: string): number {
  // Home page highest priority
  if (slug === 'home') return 1.0;
  
  // Important pages
  if (['about', 'services', 'contact', 'products', 'shop'].includes(slug)) {
    return 0.8;
  }
  
  // Secondary pages
  if (['blog', 'portfolio', 'team'].includes(slug)) {
    return 0.6;
  }
  
  // Other pages
  return 0.5;
}

function escapeXml(str: string): string {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&apos;');
}

// Generate robots.txt content
export function generateRobotsTxt(subdomain: string, baseUrl?: string): string {
  const domain = baseUrl || `https://${subdomain}.cdmsuite.com`;
  
  return `# robots.txt for ${domain}
User-agent: *
Allow: /
Sitemap: ${domain}/sitemap.xml

# Disallow admin and private pages
Disallow: /admin/
Disallow: /api/
Disallow: /_next/
`;
}

// ==========================================
// File: lib/builder/templates.ts
// ==========================================


// Website Templates for AI Builder
export interface Template {
  id: string;
  name: string;
  description: string;
  category: string;
  thumbnail: string;
  features: string[];
  ideal_for: string[];
  pages: string[]; // Default pages for this template
  colors: {
    primary: string;
    secondary: string;
    accent: string;
  };
}

export const WEBSITE_TEMPLATES: Template[] = [
  {
    id: "business",
    name: "Professional Business",
    description: "Clean, corporate design perfect for service businesses and consulting firms",
    category: "Business",
    thumbnail: "/templates/business.jpg",
    features: ["Service showcase", "Team profiles", "Contact forms", "Testimonials"],
    ideal_for: ["Consulting firms", "Professional services", "B2B companies", "Agencies"],
    pages: ["Home", "Services", "About", "Team", "Contact"],
    colors: {
      primary: "#1E3A8A",
      secondary: "#3B82F6",
      accent: "#F59E0B"
    }
  },
  {
    id: "agency",
    name: "Creative Agency",
    description: "Bold, modern design with portfolio showcase and dynamic animations",
    category: "Creative",
    thumbnail: "/templates/agency.jpg",
    features: ["Portfolio grid", "Case studies", "Creative animations", "Client logos"],
    ideal_for: ["Design agencies", "Marketing firms", "Creative studios", "Freelancers"],
    pages: ["Home", "Work", "Services", "About", "Contact"],
    colors: {
      primary: "#7C3AED",
      secondary: "#EC4899",
      accent: "#F59E0B"
    }
  },
  {
    id: "portfolio",
    name: "Portfolio Showcase",
    description: "Minimalist design to highlight your work and achievements",
    category: "Personal",
    thumbnail: "/templates/portfolio.jpg",
    features: ["Project gallery", "Case studies", "Skills showcase", "Blog integration"],
    ideal_for: ["Designers", "Developers", "Photographers", "Artists"],
    pages: ["Home", "Projects", "About", "Blog", "Contact"],
    colors: {
      primary: "#0F172A",
      secondary: "#64748B",
      accent: "#06B6D4"
    }
  },
  {
    id: "ecommerce",
    name: "Online Store",
    description: "Product-focused design with shopping cart and checkout integration",
    category: "E-commerce",
    thumbnail: "/templates/ecommerce.jpg",
    features: ["Product catalog", "Shopping cart", "Checkout flow", "Payment integration"],
    ideal_for: ["Retail stores", "Product sellers", "Boutiques", "Online shops"],
    pages: ["Home", "Shop", "Product", "Cart", "Checkout", "Contact"],
    colors: {
      primary: "#DC2626",
      secondary: "#EF4444",
      accent: "#FBBF24"
    }
  },
  {
    id: "saas",
    name: "SaaS Product",
    description: "Conversion-focused design for software and digital products",
    category: "Technology",
    thumbnail: "/templates/saas.jpg",
    features: ["Feature showcase", "Pricing tables", "Dashboard preview", "Integration logos"],
    ideal_for: ["SaaS companies", "Software products", "Tech startups", "Apps"],
    pages: ["Home", "Features", "Pricing", "About", "Contact"],
    colors: {
      primary: "#0EA5E9",
      secondary: "#6366F1",
      accent: "#10B981"
    }
  },
  {
    id: "blog",
    name: "Content Blog",
    description: "Content-first design for bloggers, writers, and content creators",
    category: "Publishing",
    thumbnail: "/templates/blog.jpg",
    features: ["Article layouts", "Categories", "Author profiles", "Newsletter signup"],
    ideal_for: ["Bloggers", "Writers", "Content creators", "Publishers"],
    pages: ["Home", "Blog", "About", "Contact"],
    colors: {
      primary: "#059669",
      secondary: "#10B981",
      accent: "#F59E0B"
    }
  }
];

export function getTemplate(id: string): Template | undefined {
  return WEBSITE_TEMPLATES.find(t => t.id === id);
}

export function getTemplatesByCategory(category: string): Template[] {
  return WEBSITE_TEMPLATES.filter(t => t.category === category);
}

// ==========================================
// File: lib/builder/validation.ts
// ==========================================


// Content validation utilities for AI Builder

import * as LucideIcons from "lucide-react";

export interface ValidationResult {
  valid: boolean;
  errors: string[];
  warnings: string[];
}

// Get list of valid Lucide icon names
export function getValidIconNames(): string[] {
  return Object.keys(LucideIcons);
}

// Validate icon name exists in Lucide
export function isValidIcon(iconName: string): boolean {
  if (!iconName) return true; // Empty is ok
  const validIcons = getValidIconNames();
  return validIcons.includes(iconName);
}

// Validate a single page object
export function validatePage(page: any): ValidationResult {
  const errors: string[] = [];
  const warnings: string[] = [];

  // Required fields
  if (!page.slug) errors.push("Page must have a slug");
  if (!page.title) errors.push("Page must have a title");
  
  // Navigation label validation
  if (page.navLabel && page.navLabel.split(' ').length > 3) {
    warnings.push(`Navigation label "${page.navLabel}" is too long. Should be 1-2 words.`);
  }

  // Hero validation
  if (page.hero) {
    if (!page.hero.headline) warnings.push("Hero section missing headline");
    if (!page.hero.subheadline) warnings.push("Hero section missing subheadline");
  }

  // Sections validation
  if (page.sections) {
    page.sections.forEach((section: any, idx: number) => {
      // Validate section type
      const validTypes = [
        "services", "features", "benefits", "portfolio", "work",
        "team", "testimonials", "stats", "process", "faq",
        "products", "shop", "pricing", "content"
      ];
      
      if (section.type && !validTypes.includes(section.type)) {
        warnings.push(`Section ${idx} has invalid type: ${section.type}`);
      }

      // Validate icons in section items
      if (section.items) {
        section.items.forEach((item: any, itemIdx: number) => {
          if (item.icon && !isValidIcon(item.icon)) {
            errors.push(`Section ${idx}, item ${itemIdx}: Invalid icon name "${item.icon}"`);
            // Auto-fix by removing invalid icon
            item.icon = "Circle";
          }
        });
      }
    });
  }

  return {
    valid: errors.length === 0,
    errors,
    warnings
  };
}

// Validate entire website content
export function validateWebsiteContent(content: any): ValidationResult {
  const errors: string[] = [];
  const warnings: string[] = [];

  // Validate site config
  if (!content.siteName) errors.push("Site must have a name");
  if (!content.tagline) warnings.push("Site missing tagline");

  // Validate pages array
  if (!content.pages || !Array.isArray(content.pages)) {
    errors.push("Site must have pages array");
    return { valid: false, errors, warnings };
  }

  if (content.pages.length === 0) {
    errors.push("Site must have at least one page");
  }

  // Validate each page
  content.pages.forEach((page: any, idx: number) => {
    const pageResult = validatePage(page);
    errors.push(...pageResult.errors.map(e => `Page ${idx} (${page.slug || 'unknown'}): ${e}`));
    warnings.push(...pageResult.warnings.map(w => `Page ${idx} (${page.slug || 'unknown'}): ${w}`));
  });

  // Check for duplicate slugs
  const slugs = content.pages.map((p: any) => p.slug).filter(Boolean);
  const duplicates = slugs.filter((slug: string, idx: number) => slugs.indexOf(slug) !== idx);
  if (duplicates.length > 0) {
    errors.push(`Duplicate page slugs found: ${duplicates.join(", ")}`);
  }

  return {
    valid: errors.length === 0,
    errors,
    warnings
  };
}

// Auto-fix common issues
export function autoFixContent(content: any): any {
  const fixed = JSON.parse(JSON.stringify(content)); // Deep clone

  // Ensure required fields
  if (!fixed.siteName) fixed.siteName = "My Business";
  if (!fixed.tagline) fixed.tagline = "Professional services";
  if (!fixed.pages) fixed.pages = [];

  // Fix each page
  fixed.pages = fixed.pages.map((page: any) => {
    // Ensure required fields
    if (!page.slug) page.slug = "page";
    if (!page.title) page.title = "Page";
    
    // Fix nav label if too long
    if (!page.navLabel || page.navLabel.split(' ').length > 3) {
      page.navLabel = formatSlugToNavLabel(page.slug);
    }

    // Ensure hero object
    if (!page.hero) {
      page.hero = {
        headline: page.title,
        subheadline: "Professional services and solutions",
        cta: "Get Started",
      };
    }

    // Ensure sections array
    if (!page.sections) page.sections = [];

    // Fix icons in sections
    page.sections = page.sections.map((section: any) => {
      if (section.items) {
        section.items = section.items.map((item: any) => {
          if (item.icon && !isValidIcon(item.icon)) {
            item.icon = "Circle"; // Default fallback icon
          }
          return item;
        });
      }
      return section;
    });

    // Add meta fields if missing
    if (!page.metaTitle) {
      page.metaTitle = `${page.title} | ${fixed.siteName}`;
    }
    if (!page.metaDescription) {
      page.metaDescription = page.hero?.subheadline || `${page.title} page`;
    }

    return page;
  });

  return fixed;
}

// Helper to format slug into nav label
function formatSlugToNavLabel(slug: string): string {
  const standardLabels: Record<string, string> = {
    'home': 'Home',
    'about': 'About',
    'about-us': 'About',
    'services': 'Services',
    'our-services': 'Services',
    'products': 'Products',
    'shop': 'Shop',
    'store': 'Store',
    'portfolio': 'Portfolio',
    'work': 'Work',
    'projects': 'Projects',
    'team': 'Team',
    'blog': 'Blog',
    'news': 'News',
    'contact': 'Contact',
    'contact-us': 'Contact',
    'pricing': 'Pricing',
  };

  if (standardLabels[slug]) {
    return standardLabels[slug];
  }

  // Capitalize first letter of each word, max 2 words
  const words = slug.split('-');
  const label = words
    .slice(0, 2)
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
  
  return label;
}

// Check if content has e-commerce features
export function isEcommerceContent(content: any): boolean {
  if (!content.pages) return false;
  
  return content.pages.some((page: any) => 
    page.slug === "shop" || 
    page.slug === "products" || 
    page.slug === "store" ||
    page.sections?.some((section: any) => 
      section.type === "products" || section.type === "shop"
    )
  );
}

// ==========================================
// File: lib/bulk-import-parser.ts
// ==========================================



// Bulk import parser for lead data

interface ParsedLead {
  name: string;
  email: string | null;
  phone: string | null;
  company: string | null;
  interest: string;
  serviceKeywords: string[];
  rawText: string;
}

// Keywords to service mapping - Enhanced with more variations
export const SERVICE_KEYWORDS_MAP: { [key: string]: { services: string[], tier: string } } = {
  // Website keywords
  'website': { services: ['Web Development'], tier: 'web-starter' },
  'web': { services: ['Web Development'], tier: 'web-starter' },
  'site': { services: ['Web Development'], tier: 'web-starter' },
  'basic website': { services: ['Web Development'], tier: 'web-starter' },
  'custom website': { services: ['Web Development'], tier: 'web-growth' },
  'ecommerce': { services: ['Web Development'], tier: 'web-growth' },
  'online store': { services: ['Web Development'], tier: 'web-growth' },
  'domain': { services: ['Web Development', 'Website Maintenance'], tier: 'web-starter' },
  
  // SEO keywords
  'seo': { services: ['SEO'], tier: 'seo-local-basic' },
  'search engine': { services: ['SEO'], tier: 'seo-local-basic' },
  'google ranking': { services: ['SEO'], tier: 'seo-growth' },
  'optimization': { services: ['SEO'], tier: 'seo-local-basic' },
  
  // Ad Management keywords
  'google ads': { services: ['Ad Management'], tier: 'ad-starter' },
  'facebook ads': { services: ['Ad Management'], tier: 'ad-starter' },
  'advertising': { services: ['Ad Management'], tier: 'ad-growth' },
  'ppc': { services: ['Ad Management'], tier: 'ad-growth' },
  'ads': { services: ['Ad Management'], tier: 'ad-starter' },
  
  // Social Media keywords
  'social media': { services: ['Social Media Management'], tier: 'social-basic' },
  'social': { services: ['Social Media Management'], tier: 'social-basic' },
  'instagram': { services: ['Social Media Management'], tier: 'social-basic' },
  'facebook': { services: ['Social Media Management'], tier: 'social-basic' },
  'twitter': { services: ['Social Media Management'], tier: 'social-basic' },
  'tiktok': { services: ['Social Media Management'], tier: 'social-basic' },
  'social management': { services: ['Social Media Management'], tier: 'social-growth' },
  
  // Marketing keywords
  'marketing': { services: ['Ad Management', 'Social Media Management'], tier: 'ad-starter' },
  'digital marketing': { services: ['Ad Management', 'Social Media Management', 'SEO'], tier: 'ad-growth' },
  'marketing needs': { services: ['Ad Management', 'Social Media Management'], tier: 'ad-growth' },
  'online marketing': { services: ['Ad Management', 'SEO'], tier: 'ad-growth' },
  
  // Lead Generation keywords
  'lead gen': { services: ['Ad Management', 'SEO'], tier: 'ad-growth' },
  'lead generation': { services: ['Ad Management', 'SEO'], tier: 'ad-growth' },
  'leads': { services: ['Ad Management', 'SEO'], tier: 'ad-growth' },
  
  // AI & App keywords
  'ai integration': { services: ['App Creation', 'Web Development'], tier: 'app-growth' },
  'ai': { services: ['App Creation'], tier: 'app-mvp' },
  'app': { services: ['App Creation'], tier: 'app-mvp' },
  'mobile app': { services: ['App Creation'], tier: 'app-growth' },
  'application': { services: ['App Creation'], tier: 'app-mvp' },
  
  // Branding & Design
  'design': { services: ['Web Development'], tier: 'web-growth' },
  'branding': { services: ['Web Development', 'Social Media Management'], tier: 'web-growth' },
  'logo': { services: ['Web Development'], tier: 'web-starter' },
  
  // Content
  'content': { services: ['Social Media Management', 'SEO'], tier: 'social-growth' },
  'copywriting': { services: ['Web Development', 'SEO'], tier: 'web-growth' },
  'blog': { services: ['Web Development', 'SEO'], tier: 'web-growth' },
};

export function parseBulkLeadData(text: string): ParsedLead[] {
  const lines = text.split('\n').filter(line => line.trim());
  const leads: ParsedLead[] = [];

  for (const line of lines) {
    const parsed = parseSingleLine(line);
    if (parsed) {
      leads.push(parsed);
    }
  }

  return leads;
}

function parseSingleLine(line: string): ParsedLead | null {
  // Remove extra whitespace
  line = line.trim();
  if (!line) return null;

  // Extract email using regex
  const emailRegex = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/;
  const emailMatch = line.match(emailRegex);
  const email = emailMatch ? emailMatch[1] : null;

  // Extract phone numbers (various formats)
  // Support formats: 876-541-3595, 876 541 3595, (876) 541-3595, +1-876-541-3595
  const phoneRegex = /(?:\+?1[-.\s]?)?\(?(\d{3})\)?[-.\s]?(\d{3})[-.\s]?(\d{4})/g;
  const phoneMatches = [...line.matchAll(phoneRegex)];
  const phones = phoneMatches.map(m => m[0]);
  const phone = phones.length > 0 ? phones.join(', ') : null;

  // Extract name (usually at the start before dash or comma)
  let name = '';
  const nameParts = line.split(/[-,]/);
  if (nameParts.length > 0) {
    name = nameParts[0].trim();
    // Remove phone and email from name if they were included
    if (phone) {
      name = name.replace(new RegExp(phones.join('|'), 'g'), '').trim();
    }
    if (email) {
      name = name.replace(email, '').trim();
    }
  }

  // Extract company name (usually capitalized words or contains "ltd", "inc", etc.)
  const companyRegex = /\b([A-Z][a-zA-Z0-9\s&]+(?:ltd|inc|corp|llc|limited|company|co\.|group|enterprises|services)\b\.?)/i;
  const companyMatch = line.match(companyRegex);
  let company = companyMatch ? companyMatch[1].trim() : null;

  // If no company found with keywords, try to find capitalized business-like names
  if (!company) {
    const businessNameRegex = /\b([A-Z][a-zA-Z]+(?:\s+[A-Z][a-zA-Z]+){1,4})\b/g;
    const businessMatches = [...line.matchAll(businessNameRegex)];
    // Get the longest match that's not the person's name
    const businessNames = businessMatches
      .map(m => m[1])
      .filter(b => b !== name && b.length > name.length);
    if (businessNames.length > 0) {
      company = businessNames[0];
    }
  }

  // Extract service keywords and interests - IMPROVED DETECTION
  const lowerLine = line.toLowerCase();
  const serviceKeywords: string[] = [];
  let interest = '';

  // Check for each keyword - sort by length (longest first) to match more specific terms first
  const sortedKeywords = Object.entries(SERVICE_KEYWORDS_MAP).sort((a, b) => b[0].length - a[0].length);
  
  for (const [keyword, mapping] of sortedKeywords) {
    if (lowerLine.includes(keyword.toLowerCase())) {
      // Avoid duplicates
      if (!serviceKeywords.includes(keyword)) {
        serviceKeywords.push(keyword);
        if (!interest) {
          interest = keyword;
        } else if (!interest.includes(keyword)) {
          interest += `, ${keyword}`;
        }
      }
    }
  }

  // If no specific keywords found, extract everything after the last comma or dash as interest
  if (!interest) {
    const interestParts = line.split(/[-,]/);
    if (interestParts.length > 1) {
      interest = interestParts[interestParts.length - 1].trim();
      // Remove phone and email
      if (phone) {
        interest = interest.replace(new RegExp(phones.join('|'), 'g'), '').trim();
      }
      if (email) {
        interest = interest.replace(email, '').trim();
      }
      
      // Try to match keywords in the interest text again
      const interestLower = interest.toLowerCase();
      for (const [keyword] of sortedKeywords) {
        if (interestLower.includes(keyword.toLowerCase()) && !serviceKeywords.includes(keyword)) {
          serviceKeywords.push(keyword);
        }
      }
    }
  }

  // Validate we have at least a name
  if (!name) {
    return null;
  }

  return {
    name,
    email,
    phone,
    company,
    interest: interest || 'General inquiry',
    serviceKeywords,
    rawText: line,
  };
}

export function mapServicesToProposalItems(serviceKeywords: string[]) {
  const items: any[] = [];
  const addedServices = new Set<string>();

  for (const keyword of serviceKeywords) {
    const mapping = SERVICE_KEYWORDS_MAP[keyword];
    if (mapping) {
      for (const service of mapping.services) {
        if (!addedServices.has(service)) {
          addedServices.add(service);
          
          // Map to pricing tiers
          let price = 500;
          let description = service;
          
          if (mapping.tier.startsWith('web-')) {
            if (mapping.tier === 'web-starter') {
              price = 420;
              description = 'Basic Website (up to 5 pages)';
            } else if (mapping.tier === 'web-growth') {
              price = 975;
              description = 'Custom Business Website (10-15 pages)';
            }
          } else if (mapping.tier.startsWith('seo-')) {
            if (mapping.tier === 'seo-local-basic') {
              price = 175;
              description = 'Local SEO Package (monthly)';
            } else if (mapping.tier === 'seo-growth') {
              price = 600;
              description = 'Growth SEO Package (monthly)';
            }
          } else if (mapping.tier.startsWith('ad-')) {
            if (mapping.tier === 'ad-starter') {
              price = 250;
              description = 'Starter Ad Management (monthly)';
            } else if (mapping.tier === 'ad-growth') {
              price = 550;
              description = 'Growth Ad Management (monthly)';
            }
          } else if (mapping.tier.startsWith('social-')) {
            if (mapping.tier === 'social-basic') {
              price = 200;
              description = 'Basic Social Media Management (monthly)';
            } else if (mapping.tier === 'social-growth') {
              price = 490;
              description = 'Growth Social Media Management (monthly)';
            }
          } else if (mapping.tier.startsWith('app-')) {
            if (mapping.tier === 'app-mvp') {
              price = 1225;
              description = 'MVP Mobile App Development';
            } else if (mapping.tier === 'app-growth') {
              price = 3750;
              description = 'Feature-Rich Mobile App Development';
            }
          }

          items.push({
            id: `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            type: 'service',
            name: service,
            description,
            quantity: 1,
            unitPrice: price,
            total: price,
            serviceId: mapping.tier,
          });
        }
      }
    }
  }

  // If no services mapped, add a generic consultation
  if (items.length === 0) {
    items.push({
      id: `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      type: 'custom',
      name: 'Initial Consultation',
      description: 'Discovery call to understand your needs',
      quantity: 1,
      unitPrice: 0,
      total: 0,
    });
  }

  return items;
}

// ==========================================
// File: lib/case-studies.ts
// ==========================================


export const caseStudies = [
  {
    id: 'foqn-funny',
    title: 'FOQN Funny',
    category: 'E-Commerce',
    client: 'FOQN Funny',
    description: 'E-commerce website with unfiltered energy',
    challenge: 'Creating a digital experience that perfectly captures the FOQN Funny vibe and makes the brand look as good online as it sounds on stage.',
    solution: 'We designed and developed a complete e-commerce platform with custom product pages, FAQ section, customer reviews, and an intuitive shopping experience.',
    results: [
      'Seamless user experience',
      'Smooth community engagement',
      'Easy-to-use platform',
      'Professional brand presence'
    ],
    testimonial: {
      quote: "We needed a website with the same edgy, unfiltered energy as our brand. CDM Suite didn't just give us a generic e-commerce site; they created a whole digital experience that perfectly captures the FOQN Funny vibe. The design is killer, the user experience is smooth, and our community loves how easy it is to use. The team was fantastic to collaborate with and completely understood the look and feel we were going for. They made our brand look as good online as it sounds on stage.",
      author: "The Founder",
      company: "FOQN Funny"
    },
    image: '/images/case-studies/foqn-funny.jpg',
    tags: ['E-Commerce', 'Web Design', 'Branding']
  },
  {
    id: 'rapido-shipping',
    title: 'Rapido Shipping Jamaica',
    category: 'Logistics',
    client: 'Rapido Shipping Jamaica',
    description: 'Professional shipping and logistics website',
    challenge: 'Creating a professional website that makes the shipping process clear and delivers a seamless experience for customers.',
    solution: 'We developed a comprehensive website with clear service information, contact forms, shipping calculator integration, and detailed about section highlighting their expertise.',
    results: [
      'Clear shipping process',
      'Flawless user experience',
      'Steady business growth',
      'Zero customer confusion'
    ],
    testimonial: {
      quote: "I can't say enough good things about the CDM Suite team. We needed a professional website that made our shipping process super clear, and they delivered, plain and simple. They listened, they were fast, and the final site works flawlessly. Since launching, our business has seen steady growth, and we've had zero confusion from customers. If you want a team that will build you something that actually works for your business, look no further.",
      author: "The Management",
      company: "Rapido Shipping Jamaica"
    },
    image: '/images/case-studies/rapido-shipping.jpg',
    tags: ['Web Design', 'Logistics', 'Professional Services']
  },
  {
    id: 'sun-absorbed',
    title: 'Sun Absorbed LLC',
    category: 'Travel & Tourism',
    client: 'Sun Absorbed LLC',
    description: 'Custom vacation packages website',
    challenge: 'Creating a website for dream vacations that feels like the start of a vacation itself, with seamless booking and beautiful design.',
    solution: 'We built a stunning travel website with custom vacation package displays, inquiry forms, detailed destination information, and an immersive visual experience.',
    results: [
      'Beautiful, immersive design',
      'Easy-to-use booking system',
      'Great customer feedback',
      'Professional brand presence'
    ],
    testimonial: {
      quote: "I'm honestly blown away. We came to CDM Suite with a big idea for Sun Absorbed Travel, and they just completely nailed it. It felt like they read our minds! The whole process was so easy—it felt like we were brainstorming with friends who just happen to be amazing designers. They took our vibe and turned it into a website that's not only beautiful but also super simple for our customers to use. We've already gotten so much great feedback. People are telling us the site itself feels like the start of a vacation! We couldn't be happier. Seriously, if you need a team that will pour their heart into your project and deliver something special, CDM Suite is it.",
      author: "The Team",
      company: "Sun Absorbed LLC"
    },
    image: '/images/case-studies/sun-absorbed.jpg',
    tags: ['Travel', 'Web Design', 'Booking System']
  },
  {
    id: 'dreniefied-collection',
    title: 'Dreniefied Collection',
    category: 'E-Commerce',
    client: 'Dreniefied Collection',
    description: 'Premium wig e-commerce store',
    challenge: 'Building a digital home for a personal brand that goes beyond selling wigs—creating a community and sharing a story.',
    solution: 'We created a stunning e-commerce platform with custom product displays, detailed product pages, checkout system, and a design that captures the brand\'s essence.',
    results: [
      'Stunning, on-brand design',
      'Seamless shopping experience',
      'Perfect vibe capture',
      'Strong community building'
    ],
    testimonial: {
      quote: "My brand, Dreniefied Collection, is incredibly personal to me, and I needed a website that felt just as special. I'm not just selling wigs; I'm building a community and sharing a piece of my story. From the very beginning, the team at CDM Suite understood that. They dove deep into my vision and created a digital home for my brand that is beyond what I hoped for. The design is stunning, it captures our vibe perfectly, and most importantly, it gives my customers a seamless, beautiful shopping experience. They didn't just build a store; they brought a vision to life.",
      author: "A.S., Founder",
      company: "Dreniefied Collection"
    },
    image: '/images/case-studies/dreniefied.jpg',
    tags: ['E-Commerce', 'Fashion', 'Branding']
  },
  {
    id: 'meta-ads-inflatables-1',
    title: '70 Leads from $130 Facebook Ads',
    category: 'Digital Advertising',
    client: 'Inflatables Business',
    description: 'Facebook Ads campaign for inflatable rental business',
    challenge: 'Generate high-quality leads for a new inflatable rental business with a limited budget.',
    solution: 'Strategic Facebook Ads campaign with targeted audience, compelling creative, and optimized landing page.',
    results: [
      '70 high-quality leads',
      '$130 total ad spend',
      '$1.86 cost per lead',
      '2-week campaign duration'
    ],
    image: '/images/case-studies/meta-ads-1.jpg',
    tags: ['Facebook Ads', 'Lead Generation', 'Meta Advertising']
  },
  {
    id: 'meta-ads-inflatables-2',
    title: 'Bachelor Party Inflatable Rentals',
    category: 'Digital Advertising',
    client: 'Luxury Inflatable Rentals',
    description: 'Targeted Facebook campaign for bachelorette parties',
    challenge: 'Target specific event type (bachelorette parties) for luxury inflatable rentals.',
    solution: 'Highly targeted Facebook Ads with event-specific creative and messaging.',
    results: [
      '70 leads in 2 weeks',
      '$130 ad budget',
      'High conversion rate',
      'Premium event bookings'
    ],
    image: '/images/case-studies/meta-ads-2.jpg',
    tags: ['Facebook Ads', 'Event Marketing', 'Targeted Advertising']
  },
  {
    id: 'meta-ads-coaching',
    title: 'Cut Lead Costs in Half with Facebook Ads',
    category: 'Digital Advertising',
    client: 'Business Coaching Company',
    description: 'Facebook Ads optimization for coaching business',
    challenge: 'Reduce lead acquisition costs while maintaining lead quality for a business coaching company.',
    solution: 'Advanced targeting, creative optimization, and conversion tracking.',
    results: [
      'Lead costs slashed to $8.43',
      'Over 30 days campaign',
      'Consistent lead quality',
      '50% cost reduction'
    ],
    image: '/images/case-studies/meta-ads-3.jpg',
    tags: ['Facebook Ads', 'Cost Optimization', 'B2B Marketing']
  }
];

export function getCaseStudyById(id: string) {
  return caseStudies.find(study => study.id === id);
}

export function getCaseStudiesByCategory(category: string) {
  return caseStudies.filter(study => study.category === category);
}

// ==========================================
// File: lib/cdm-suite-knowledge.ts
// ==========================================


/**
 * CDM Suite Company Knowledge Base
 * 
 * This file contains accurate information about CDM Suite LLC
 * to be used in bid proposals, ensuring every proposal is unique
 * and pulls actual company information.
 * 
 * IMPORTANT: All information in this file is accurate and verifiable.
 * Do not add fabricated case studies, fake team sizes, or unverifiable metrics.
 * 
 * Last Updated: November 11, 2025
 */

export const CDM_SUITE_KNOWLEDGE = {
  company: {
    name: "CDM Suite LLC",
    tagline: "Professional Digital Solutions Backed by Complex Infrastructure Experience",
    founded: "2020",
    description: "CDM Suite is a digital solutions provider bringing expertise from complex, multi-billion dollar infrastructure programs to deliver enterprise-grade web development, branding, and digital services. Our leadership has navigated high-stakes environments in landmark projects across aviation, logistics, and public infrastructure sectors, including experience with $5.1 billion and $4.2 billion terminal development programs. We apply this same level of rigor, planning, and execution excellence to every digital project we undertake.",
    website: "https://cdmsuite.com",
    contactEmail: "contracts@cdmsuite.com",
    contactPhone: "(862) 272-7623",
    authorizedSignees: ["Fray", "Everoy"],
    locations: [
      "Based in Queens, New York, United States",
      "Serving clients nationwide"
    ],
    leadershipBackground: {
      infrastructureExperience: [
        "Multi-billion dollar infrastructure program management",
        "Complex airport terminal development ($5.1B LaGuardia Terminal B, $4.2B JFK Terminal 6)",
        "Public sector capital construction portfolio oversight (DASNY - Dormitory Authority of NY)",
        "Critical Path Method (CPM) scheduling and project controls",
        "Design and construction phasing for operational integration",
        "Cross-functional coordination across government agencies, airlines, and private partners"
      ],
      operationsManagement: [
        "Logistics operations management ($250M+ in assets)",
        "Team leadership of 50+ professionals including managers, contractors, and staff",
        "120%+ profit growth through operational efficiency improvements",
        "Supply chain and freight coordination across North America",
        "Process improvement and system development for multi-phase operations"
      ],
      salesAndGrowth: [
        "Sales and marketing management with proven track record",
        "$368,000+ in documented sales generation",
        "Team leadership of 8-10 sales professionals",
        "Client relationship management and retention strategies",
        "Data-driven decision making and strategic market alignment",
        "Wealth management solutions and financial planning expertise"
      ],
      technicalExpertise: [
        "Primavera P6 and Microsoft Project scheduling",
        "BIM (Building Information Modeling) certified",
        "ProCore project management platform",
        "Database development and space management systems",
        "Risk identification, assessment, and mitigation",
        "Forensic schedule analysis and dispute resolution"
      ],
      education: [
        "Bachelor's Degree in Airport and Airline Management",
        "Oracle Certified Specialist - Primavera",
        "Professional Certificate in Building Information Modeling",
        "Foundations of Project Management certification",
        "Airport Planning Design and Development certification"
      ]
    }
  },

  coreServices: {
    webDesignDevelopment: {
      name: "Web Design & Development",
      description: "Custom, responsive websites and web applications built with modern frameworks",
      capabilities: [
        "Responsive web design with mobile-first approach",
        "Custom website development",
        "E-commerce solutions (Shopify and custom platforms)",
        "Content Management Systems (CMS)",
        "Web application development",
        "Website redesign and modernization",
        "Accessibility standards compliance",
        "Performance optimization",
        "Secure coding practices"
      ],
      technologies: [
        "Frontend: React, Next.js, TypeScript, Tailwind CSS",
        "Backend: Node.js, Python",
        "Databases: PostgreSQL, MongoDB",
        "Cloud: AWS, Vercel",
        "Version Control: Git, GitHub"
      ],
      pricing: "Project-based pricing - Contact for quote"
    },

    brandingDesign: {
      name: "Branding & Logo Design",
      description: "Professional logo and brand identity design services",
      capabilities: [
        "Custom logo design",
        "Brand identity development",
        "Visual identity systems",
        "Multiple design concepts and revisions",
        "Delivery in multiple formats for print and digital use",
        "Brand guideline documentation"
      ],
      pricing: "Project-based pricing - Contact for quote"
    },

    digitalServices: {
      name: "Digital Services",
      description: "Additional digital services to support your online presence",
      capabilities: [
        "Website maintenance and updates",
        "Technical support",
        "Website hosting consultation",
        "Domain management assistance",
        "Analytics setup and reporting",
        "Search engine optimization basics",
        "Social media integration"
      ],
      pricing: "Service-based pricing - Contact for quote"
    }
  },

  differentiators: [
    "**Infrastructure-Grade Project Management:** Our leadership brings experience from complex, multi-billion dollar infrastructure programs. The same rigorous planning, scheduling, and execution standards used in landmark aviation projects now power every digital project we deliver.",
    
    "**Proven Operational Excellence:** Track record of managing operations with $250M+ in assets and achieving 120%+ profit growth through process optimization. We apply this operational discipline to deliver projects on time and on budget.",
    
    "**Risk Mitigation Expertise:** Trained in Critical Path Method (CPM) scheduling, forensic analysis, and systematic risk identification. We proactively identify and address potential issues before they impact your project.",
    
    "**Cross-Functional Coordination:** Experience unifying diverse stakeholders including government agencies, private partners, airlines, and technical teams. We excel at bringing together all parties to drive projects forward.",
    
    "**Modern Technology Stack:** We use current, industry-standard technologies like React, Next.js, and TypeScript to build fast, secure, and maintainable websites.",
    
    "**Data-Driven Decision Making:** Sales and marketing background with proven results ($368K+ in documented sales). We make strategic recommendations based on market research, competitive analysis, and clear metrics.",
    
    "**Professional Certifications:** Oracle Certified Primavera Specialist, BIM certified, and formally trained in project management. Our technical expertise is backed by recognized industry credentials.",
    
    "**Public & Private Sector Experience:** Successfully delivered projects for public agencies (DASNY), aviation authorities (LaGuardia, JFK), logistics operations, and private sector clients. We understand compliance requirements and stakeholder management across diverse environments."
  ],

  methodology: {
    discovery: {
      phase: "Discovery & Planning",
      activities: [
        "Initial consultation to understand your goals and requirements",
        "Review of existing materials and brand guidelines",
        "Technical requirements assessment",
        "Project scope and timeline definition",
        "Clear communication of deliverables and expectations"
      ]
    },

    design: {
      phase: "Design & Development",
      activities: [
        "Creation of design concepts or mockups",
        "Client review and feedback incorporation",
        "Development using modern frameworks and best practices",
        "Regular progress updates",
        "Iterative refinement based on feedback"
      ]
    },

    testing: {
      phase: "Testing & Quality Assurance",
      activities: [
        "Thorough testing across different devices and browsers",
        "Performance optimization",
        "Security best practices implementation",
        "Final client review and approval",
        "Bug fixes and adjustments as needed"
      ]
    },

    launch: {
      phase: "Launch & Delivery",
      activities: [
        "Deployment to production environment",
        "Final validation and testing",
        "Delivery of all project files and assets",
        "Basic training or documentation as needed",
        "Post-launch support availability"
      ]
    }
  },

  technologyStack: {
    frontend: [
      "React and Next.js",
      "TypeScript",
      "Tailwind CSS",
      "Modern JavaScript (ES6+)"
    ],
    backend: [
      "Node.js",
      "Python",
      "RESTful APIs"
    ],
    databases: [
      "PostgreSQL",
      "MongoDB"
    ],
    cloud: [
      "AWS (S3, EC2, RDS)",
      "Vercel"
    ],
    tools: [
      "Git and GitHub",
      "Visual Studio Code",
      "Chrome DevTools",
      "Figma for design collaboration"
    ]
  },

  portfolioProjects: [
    {
      name: "Rapido Shipping (rapidoshippinja.com)",
      description: "Logistics and shipping website",
      scope: "Complete website design and development for a logistics company, featuring service information, quote requests, and tracking capabilities.",
      technologies: ["Modern web technologies", "Responsive design", "Custom functionality"]
    },
    {
      name: "Melissa Subdomain (melissa.cdmsuite.com)",
      description: "Custom web application",
      scope: "Specialized web application with custom functionality and design.",
      technologies: ["Web application framework", "Custom backend"]
    },
    {
      name: "Logo Design Portfolio",
      description: "Brand identity design for multiple clients",
      scope: "Professional logo design and brand identity development for various businesses across different industries.",
      technologies: ["Professional design software", "Vector graphics", "Multiple format deliverables"]
    }
  ],

  approach: {
    principles: [
      "Clear, honest communication throughout the project",
      "Focus on understanding client needs and goals",
      "Commitment to quality and professional standards",
      "Timely delivery and responsive support",
      "Clean, maintainable code for long-term success"
    ],
    qualityFocus: [
      "Testing across multiple devices and browsers",
      "Performance optimization",
      "Security best practices",
      "Accessible design considerations",
      "Clean, documented code"
    ]
  }
};

/**
 * Get formatted company overview for proposals
 */
export function getCompanyOverview(): string {
  const { company, differentiators } = CDM_SUITE_KNOWLEDGE;
  
  return `
**Company Name:** ${company.name}
**Tagline:** ${company.tagline}
**Founded:** ${company.founded}
**Website:** ${company.website}

${company.description}

**Why Choose CDM Suite:**

${differentiators.map((diff, i) => `${i + 1}. ${diff}`).join('\n\n')}
`.trim();
}

/**
 * Get relevant service details based on project requirements
 */
export function getServiceDetails(serviceNames: string[]): string {
  const { coreServices } = CDM_SUITE_KNOWLEDGE;
  const serviceMap: { [key: string]: any } = {
    'web design': coreServices.webDesignDevelopment,
    'website': coreServices.webDesignDevelopment,
    'web': coreServices.webDesignDevelopment,
    'logo': coreServices.brandingDesign,
    'branding': coreServices.brandingDesign,
    'brand': coreServices.brandingDesign,
    'design': coreServices.brandingDesign,
    'digital': coreServices.digitalServices,
    'maintenance': coreServices.digitalServices,
    'support': coreServices.digitalServices,
  };

  const relevantServices: any[] = [];
  
  serviceNames.forEach(name => {
    const lowerName = name.toLowerCase();
    Object.keys(serviceMap).forEach(key => {
      if (lowerName.includes(key) && !relevantServices.includes(serviceMap[key])) {
        relevantServices.push(serviceMap[key]);
      }
    });
  });

  if (relevantServices.length === 0) {
    // If no specific match, include web design as default
    relevantServices.push(coreServices.webDesignDevelopment);
  }

  return relevantServices.map(service => `
**${service.name}**

${service.description}

**Capabilities:**
${service.capabilities.map((cap: string) => `- ${cap}`).join('\n')}

${service.technologies ? `**Technologies:**\n${service.technologies.map((tech: string) => `- ${tech}`).join('\n')}` : ''}

${service.pricing ? `**Pricing:** ${service.pricing}` : ''}
`).join('\n\n---\n\n');
}

/**
 * Get relevant industry expertise
 */
export function getIndustryExpertise(industry: string): string {
  // Return general approach since we don't have specific industry specializations
  return `
**Our Approach**

We work with clients across various industries, adapting our services to meet specific business needs and requirements. Our focus is on understanding your unique goals and delivering solutions that work for your business.
`.trim();
}

/**
 * Get relevant portfolio projects
 */
export function getRelevantCaseStudies(industry: string, services: string[]): string {
  const { portfolioProjects } = CDM_SUITE_KNOWLEDGE;
  
  return `
**Portfolio Examples**

${portfolioProjects.map(project => `
**${project.name}**
${project.description}

*Scope:* ${project.scope}
*Technologies:* ${project.technologies.join(', ')}
`).join('\n---\n\n')}
`.trim();
}

/**
 * Get methodology overview
 */
export function getMethodologyOverview(): string {
  const { methodology } = CDM_SUITE_KNOWLEDGE;

  return `
**Our Project Methodology**

We follow a structured approach that ensures quality and clear communication:

**${methodology.discovery.phase}**
${methodology.discovery.activities.map((a: string) => `- ${a}`).join('\n')}

**${methodology.design.phase}**
${methodology.design.activities.map((a: string) => `- ${a}`).join('\n')}

**${methodology.testing.phase}**
${methodology.testing.activities.map((a: string) => `- ${a}`).join('\n')}

**${methodology.launch.phase}**
${methodology.launch.activities.map((a: string) => `- ${a}`).join('\n')}
`.trim();
}

/**
 * Get technology stack details
 */
export function getTechnologyStack(): string {
  const { technologyStack } = CDM_SUITE_KNOWLEDGE;

  return `
**Our Technology Stack**

**Frontend Development:**
${technologyStack.frontend.map((tech: string) => `- ${tech}`).join('\n')}

**Backend Development:**
${technologyStack.backend.map((tech: string) => `- ${tech}`).join('\n')}

**Databases:**
${technologyStack.databases.map((tech: string) => `- ${tech}`).join('\n')}

**Cloud & Hosting:**
${technologyStack.cloud.map((tech: string) => `- ${tech}`).join('\n')}

**Tools:**
${technologyStack.tools.map((tech: string) => `- ${tech}`).join('\n')}
`.trim();
}

/**
 * Get team overview with leadership background (no individual names)
 */
export function getTeamOverview(): string {
  const { leadershipBackground } = CDM_SUITE_KNOWLEDGE.company;

  return `
**Team Qualifications & Experience**

Our team brings verifiable, high-credibility experience from complex, mission-critical environments:

**Infrastructure Program Experience:**
${leadershipBackground.infrastructureExperience.map((item: string) => `- ${item}`).join('\n')}

**Operations Management:**
${leadershipBackground.operationsManagement.map((item: string) => `- ${item}`).join('\n')}

**Technical Expertise:**
${leadershipBackground.technicalExpertise.map((item: string) => `- ${item}`).join('\n')}

**Professional Certifications:**
${leadershipBackground.education.map((item: string) => `- ${item}`).join('\n')}

**Sales & Business Development:**
${leadershipBackground.salesAndGrowth.map((item: string) => `- ${item}`).join('\n')}

This background ensures we have the expertise, certifications, and proven track record required for demanding projects including those with SOC 2/GDPR compliance requirements, project controls, scheduling expertise, and rigorous quality standards.
`.trim();
}

/**
 * Get quality assurance details
 */
export function getQualityAssurance(): string {
  const { approach } = CDM_SUITE_KNOWLEDGE;

  return `
**Quality Assurance**

${approach.qualityFocus.map((focus: string) => `- ${focus}`).join('\n')}
`.trim();
}

/**
 * Get support options
 */
export function getSupportOptions(): string {
  return `
**Post-Launch Support**

We offer post-launch support to ensure your project continues to run smoothly. Support options and pricing can be discussed based on your specific needs and requirements.
`.trim();
}

/**
 * Get company contact information
 */
export function getContactInfo(): {
  email: string;
  phone: string;
  signees: string[];
} {
  const { company } = CDM_SUITE_KNOWLEDGE;
  return {
    email: company.contactEmail,
    phone: company.contactPhone,
    signees: company.authorizedSignees
  };
}

/**
 * Get leadership background for proposals
 */
export function getLeadershipBackground(): string {
  const { leadershipBackground } = CDM_SUITE_KNOWLEDGE.company;
  
  return `
**Leadership & Expertise**

Our leadership team brings extensive experience from complex, high-stakes environments:

**Infrastructure Program Experience:**
${leadershipBackground.infrastructureExperience.map((item: string) => `- ${item}`).join('\n')}

**Operations Management:**
${leadershipBackground.operationsManagement.map((item: string) => `- ${item}`).join('\n')}

**Sales & Business Growth:**
${leadershipBackground.salesAndGrowth.map((item: string) => `- ${item}`).join('\n')}

**Technical Expertise:**
${leadershipBackground.technicalExpertise.map((item: string) => `- ${item}`).join('\n')}

**Education & Certifications:**
${leadershipBackground.education.map((item: string) => `- ${item}`).join('\n')}
`.trim();
}

/**
 * Get competitive advantages for specific project types
 */
export function getCompetitiveAdvantages(projectType: string): string[] {
  const advantages = [
    "Experience managing multi-billion dollar programs ensures we can handle projects of any scale",
    "Proven track record of on-time, on-budget delivery in high-stakes environments",
    "Risk mitigation strategies developed through complex infrastructure work",
    "Clear communication and stakeholder management across diverse groups",
    "Data-driven approach to project planning and execution",
    "Professional certifications and industry-recognized expertise",
    "Public and private sector experience with compliance requirements"
  ];
  
  return advantages;
}

/**
 * Get pricing philosophy and approach
 */
export function getPricingPhilosophy(): string {
  return `
**Our Pricing Approach**

CDM Suite's pricing philosophy is rooted in our background managing complex, high-value programs. We conduct thorough cost analysis and market research for every proposal to ensure:

1. **Competitive Positioning:** Our prices reflect current market rates while accounting for the enterprise-grade quality we deliver.

2. **Value-Based Pricing:** We consider the scope, complexity, timeline, and long-term value of each project.

3. **Transparent Breakdown:** Every price includes clear justification of resources, time allocation, and deliverables.

4. **Risk Assessment:** Our infrastructure background ensures we account for potential challenges and contingencies.

5. **Market Research:** We analyze comparable projects and industry standards to ensure fair, competitive pricing.

All pricing recommendations are based on objective analysis rather than arbitrary estimates.
`.trim();
}

/**
 * Generate market research-based pricing justification
 */
export function generatePricingJustification(
  proposedPrice: number,
  projectScope: string,
  complexity: 'low' | 'medium' | 'high',
  timeline: string
): string {
  const complexityFactors = {
    low: "straightforward implementation with minimal custom requirements",
    medium: "moderate complexity with custom features and integrations",
    high: "complex architecture requiring advanced technical expertise and extensive customization"
  };
  
  return `
**Pricing Justification**

**Proposed Price:** $${proposedPrice.toLocaleString()}

**Analysis Basis:**

1. **Scope Assessment:** ${projectScope}

2. **Complexity Level:** ${complexity.charAt(0).toUpperCase() + complexity.slice(1)} - ${complexityFactors[complexity]}

3. **Timeline Consideration:** ${timeline}

4. **Market Positioning:** Based on current market research for similar projects, our pricing is competitive and reflects:
   - Industry-standard rates for enterprise-grade development
   - Professional project management and coordination
   - Quality assurance and testing protocols
   - Post-launch support and documentation

5. **Resource Allocation:** Price accounts for:
   - Development team time and expertise
   - Project management and coordination
   - Quality assurance and testing
   - Revisions and client feedback incorporation
   - Documentation and knowledge transfer

6. **Value Proposition:** Our infrastructure-program background ensures:
   - Rigorous planning and execution
   - Proactive risk mitigation
   - On-time, on-budget delivery
   - Enterprise-grade quality standards

This pricing reflects a thorough cost analysis and represents fair market value for the deliverables and expertise provided.
`.trim();
}

// ==========================================
// File: lib/credits.ts
// ==========================================



import { prisma } from "./db";

// Credit allocation by tier
export const TIER_CREDITS = {
  free: 1,
  starter: 5,
  growth: 20,
  pro: 50,
  enterprise: 999, // Effectively unlimited
};

// Get credits for a tier
export function getCreditsForTier(tier: string): number {
  return TIER_CREDITS[tier as keyof typeof TIER_CREDITS] || TIER_CREDITS.free;
}

// Check if user has admin or employee role
export function isAdminOrEmployee(userRole?: string | null): boolean {
  return userRole === "admin" || userRole === "employee";
}

// Check if user has enough credits (admins and employees bypass this check)
export function hasEnoughCredits(userCredits: number, required: number = 1, userRole?: string | null): boolean {
  // Admins and employees have unlimited access
  if (isAdminOrEmployee(userRole)) {
    return true;
  }
  return userCredits >= required;
}

// Calculate credits to add when upgrading
export function getCreditsOnUpgrade(fromTier: string, toTier: string): number {
  const fromCredits = getCreditsForTier(fromTier);
  const toCredits = getCreditsForTier(toTier);
  return Math.max(0, toCredits - fromCredits);
}

// Deduct credits from user (admins and employees bypass deduction)
export async function deductCredits(userId: string, amount: number = 1, userRole?: string | null): Promise<boolean> {
  try {
    // Skip credit deduction for admins and employees
    if (isAdminOrEmployee(userRole)) {
      return true;
    }

    await prisma.user.update({
      where: { id: userId },
      data: {
        credits: {
          decrement: amount,
        },
      },
    });
    return true;
  } catch (error) {
    console.error("Failed to deduct credits:", error);
    return false;
  }
}

// Add credits to user
export async function addCredits(userId: string, amount: number): Promise<boolean> {
  try {
    await prisma.user.update({
      where: { id: userId },
      data: {
        credits: {
          increment: amount,
        },
      },
    });
    return true;
  } catch (error) {
    console.error("Failed to add credits:", error);
    return false;
  }
}

// ==========================================
// File: lib/crm-types.ts
// ==========================================


// Lead CRM Type Definitions

export type LeadStatus = 'new' | 'qualified' | 'proposal' | 'closed-won' | 'closed-lost';
export type LeadPriority = 'low' | 'medium' | 'high';
export type ActivityType = 'note' | 'email' | 'call' | 'meeting' | 'status_change' | 'assignment';

export interface Lead {
  id: string;
  email: string;
  name?: string | null;
  phone?: string | null;
  company?: string | null;
  source: string;
  interest?: string | null;
  chatHistory?: string | null;
  assessmentResults?: string | null;
  
  // CRM Fields
  status: LeadStatus;
  priority: LeadPriority;
  assignedToId?: string | null;
  
  // Lead scoring
  score: number;
  budget?: string | null;
  timeline?: string | null;
  lastContactedAt?: Date | null;
  nextFollowUpAt?: Date | null;
  
  // Notes and metadata
  notes?: string | null;
  tags: string[];
  customFields?: string | null;
  
  createdAt: Date;
  updatedAt: Date;
  
  // Relations
  assignedTo?: {
    id: string;
    user: {
      name: string | null;
      email: string;
    };
  };
  activities?: LeadActivity[];
  sequences?: LeadSequence[];
}

export interface LeadActivity {
  id: string;
  leadId: string;
  type: ActivityType;
  title: string;
  description?: string | null;
  metadata?: string | null;
  createdById?: string | null;
  createdBy?: {
    id: string;
    user: {
      name: string | null;
      email: string;
    };
  };
  createdAt: Date;
}

export interface LeadSequence {
  id: string;
  leadId: string;
  name: string;
  description?: string | null;
  steps: SequenceStep[];
  currentStep: number;
  status: 'pending' | 'active' | 'paused' | 'completed' | 'cancelled';
  aiGenerated: boolean;
  aiRecommendedBy?: string | null;
  approvedBy?: string | null;
  approvedAt?: Date | null;
  startedAt?: Date | null;
  completedAt?: Date | null;
  createdAt: Date;
  updatedAt: Date;
}

export interface SequenceStep {
  stepNumber: number;
  action: 'email' | 'call' | 'task' | 'wait';
  title: string;
  description: string;
  delayDays?: number;
  emailTemplate?: string;
  completed: boolean;
  completedAt?: Date;
}

export interface LeadFilters {
  status?: LeadStatus;
  priority?: LeadPriority;
  assignedToId?: string;
  source?: string;
  search?: string;
  tags?: string[];
}

export interface LeadStats {
  total: number;
  byStatus: Record<LeadStatus, number>;
  byPriority: Record<LeadPriority, number>;
  bySource: Record<string, number>;
  avgScore: number;
  conversionRate: number;
}

// ==========================================
// File: lib/crm-utils.ts
// ==========================================


import { LeadStatus, LeadPriority, Lead } from './crm-types';

export const LEAD_STATUSES: { value: LeadStatus; label: string; color: string }[] = [
  { value: 'new', label: 'New', color: 'bg-blue-500' },
  { value: 'qualified', label: 'Qualified', color: 'bg-purple-500' },
  { value: 'proposal', label: 'Proposal', color: 'bg-yellow-500' },
  { value: 'closed-won', label: 'Closed Won', color: 'bg-green-500' },
  { value: 'closed-lost', label: 'Closed Lost', color: 'bg-red-500' },
];

export const LEAD_PRIORITIES: { value: LeadPriority; label: string; color: string }[] = [
  { value: 'low', label: 'Low', color: 'text-gray-500' },
  { value: 'medium', label: 'Medium', color: 'text-yellow-500' },
  { value: 'high', label: 'High', color: 'text-red-500' },
];

export const LEAD_SOURCES = [
  { value: 'chat', label: 'AI Chatbot' },
  { value: 'welcome-popup', label: 'Welcome Popup' },
  { value: 'exit-intent', label: 'Exit Intent' },
  { value: 'newsletter', label: 'Newsletter' },
  { value: 'assessment', label: 'Marketing Assessment' },
  { value: 'contact-form', label: 'Contact Form' },
  { value: 'referral', label: 'Referral' },
  { value: 'bulk-import', label: 'Bulk Import' },
  { value: 'manual', label: 'Manual Entry' },
  { value: 'other', label: 'Other' },
];

export function getStatusColor(status: LeadStatus): string {
  return LEAD_STATUSES.find(s => s.value === status)?.color || 'bg-gray-500';
}

export function getPriorityColor(priority: LeadPriority): string {
  return LEAD_PRIORITIES.find(p => p.value === priority)?.color || 'text-gray-500';
}

export function calculateLeadScore(lead: Lead): number {
  let score = 0;

  // Source scoring
  const sourceScores: Record<string, number> = {
    'assessment': 30,
    'chat': 25,
    'contact-form': 20,
    'referral': 20,
    'bulk-import': 15,
    'welcome-popup': 15,
    'manual': 15,
    'exit-intent': 10,
    'newsletter': 10,
  };
  score += sourceScores[lead.source] || 10;

  // Interest scoring
  if (lead.interest) score += 15;

  // Contact info completeness
  if (lead.phone) score += 10;
  if (lead.company) score += 10;

  // Budget and timeline
  if (lead.budget) score += 15;
  if (lead.timeline) score += 10;

  // Engagement scoring
  if (lead.chatHistory) {
    try {
      const history = JSON.parse(lead.chatHistory);
      score += Math.min(history.length * 2, 10); // Up to 10 points
    } catch (e) {
      // Invalid JSON, skip
    }
  }

  return Math.min(score, 100);
}

export function formatLeadSource(source: string): string {
  return LEAD_SOURCES.find(s => s.value === source)?.label || source;
}

export function getLeadTimeframe(createdAt: Date): string {
  const now = new Date();
  const diff = now.getTime() - new Date(createdAt).getTime();
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  
  if (days === 0) return 'Today';
  if (days === 1) return 'Yesterday';
  if (days < 7) return `${days} days ago`;
  if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
  return `${Math.floor(days / 30)} months ago`;
}

export function isLeadOverdue(nextFollowUpAt?: Date | null): boolean {
  if (!nextFollowUpAt) return false;
  return new Date(nextFollowUpAt) < new Date();
}

// ==========================================
// File: lib/db.ts
// ==========================================

import { PrismaClient } from '@prisma/client'
import { PrismaD1 } from '@prisma/adapter-d1'
import { D1Database } from '@cloudflare/workers-types'

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined
}

const createPrismaClient = () => {
  // Check if we are running in Cloudflare Workers/Pages
  if (process.env.NODE_ENV === 'production' && typeof process.env.DB !== 'undefined') {
    const adapter = new PrismaD1(process.env.DB as unknown as D1Database)
    return new PrismaClient({ adapter: adapter as any })
  }

  // Fallback for local development (standard SQLite)
  return new PrismaClient({
    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
  })
}

export const prisma = globalForPrisma.prisma ?? createPrismaClient()

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma
}

// ==========================================
// File: lib/document-extractor.ts
// ==========================================


import mammoth from 'mammoth';
import PDFParser from 'pdf2json';
import * as v8 from 'v8';

export interface ExtractedDocument {
  name: string;
  content: string;
  type: 'pdf' | 'word' | 'text' | 'email' | 'unknown';
}

/**
 * Extract text content from PDF using pdf2json (pure JavaScript, serverless-compatible)
 * Implements aggressive warning suppression and memory management with dynamic timeout
 */
async function extractPdfText(arrayBuffer: ArrayBuffer, fileSizeMB: number = 0): Promise<string> {
  // Store original stream methods
  const originalStderrWrite = process.stderr.write;
  const originalStdoutWrite = process.stdout.write;
  const originalWarn = console.warn;
  const originalError = console.error;
  
  // Calculate dynamic timeout based on file size
  // Base: 60s, add 15s per MB, max 240s (4 minutes)
  const baseTimeout = 60000; // 60 seconds
  const perMBTimeout = 15000; // 15 seconds per MB
  const maxTimeout = 240000; // 4 minutes max
  const calculatedTimeout = Math.min(baseTimeout + (fileSizeMB * perMBTimeout), maxTimeout);
  const timeoutSeconds = Math.round(calculatedTimeout / 1000);
  
  console.log(`PDF timeout: ${timeoutSeconds}s for ${fileSizeMB.toFixed(1)}MB file`);
  
  return new Promise((resolve, reject) => {
    try {
      // Suppress benign pdf2json warnings that go directly to stderr/stdout
      const suppressedPatterns = [
        /TT: undefined function/i,
        /TT: invalid function id/i,
        /TT: complementing a missing function/i,
        /Unsupported: field\.type of/i,
        /NOT valid form element/i,
        /Setting up fake worker/i,
        /Warning: TODO: graphic state operator SMask/i,
        /Warning: to be implemented: contextPrototype\.clearRect/i,
      ];
      
      const shouldSuppress = (message: string): boolean => {
        return suppressedPatterns.some(pattern => pattern.test(message));
      };
      
      // Intercept stderr writes (pdf2json writes warnings directly to stderr)
      process.stderr.write = function(chunk: any, encoding?: any, callback?: any): boolean {
        const message = chunk?.toString ? chunk.toString() : String(chunk);
        if (!shouldSuppress(message)) {
          return originalStderrWrite.call(process.stderr, chunk, encoding, callback);
        }
        // Suppress the warning by returning true without writing
        if (typeof callback === 'function') callback();
        return true;
      } as any;
      
      // Intercept stdout writes
      process.stdout.write = function(chunk: any, encoding?: any, callback?: any): boolean {
        const message = chunk?.toString ? chunk.toString() : String(chunk);
        if (!shouldSuppress(message)) {
          return originalStdoutWrite.call(process.stdout, chunk, encoding, callback);
        }
        if (typeof callback === 'function') callback();
        return true;
      } as any;
      
      // Also suppress console methods
      console.warn = (...args: any[]) => {
        const message = args.join(' ');
        if (!shouldSuppress(message)) {
          originalWarn.apply(console, args);
        }
      };
      
      console.error = (...args: any[]) => {
        const message = args.join(' ');
        if (!shouldSuppress(message)) {
          originalError.apply(console, args);
        }
      };
      
      const pdfParser = new PDFParser();
      const buffer = Buffer.from(arrayBuffer);
      
      let fullText = '';
      let cleanupTimer: NodeJS.Timeout;
      let pdfDataRef: any = null; // Keep reference for explicit cleanup
      
      pdfParser.on('pdfParser_dataReady', (pdfData: any) => {
        // Store reference for cleanup
        pdfDataRef = pdfData;
        
        // Restore all intercepted methods
        process.stderr.write = originalStderrWrite;
        process.stdout.write = originalStdoutWrite;
        console.warn = originalWarn;
        console.error = originalError;
        
        try {
          // Extract text from all pages with memory-efficient processing
          if (pdfData && pdfData.Pages) {
            const totalPages = pdfData.Pages.length;
            let processedPages = 0;
            
            for (const page of pdfData.Pages) {
              if (page.Texts) {
                for (const text of page.Texts) {
                  if (text.R) {
                    for (const run of text.R) {
                      if (run.T) {
                        try {
                          // Decode URI-encoded text, skip if malformed
                          fullText += decodeURIComponent(run.T) + ' ';
                        } catch (decodeError) {
                          // If URI is malformed, use raw text
                          fullText += (run.T || '').replace(/%[0-9A-F]{2}/g, '') + ' ';
                        }
                      }
                    }
                  }
                }
                fullText += '\n\n';
              }
              
              // Null out page data immediately after processing to free memory
              page.Texts = null;
              
              processedPages++;
              // Log progress for large PDFs
              if (totalPages > 50 && processedPages % 50 === 0) {
                console.log(`Progress: ${processedPages}/${totalPages} pages extracted...`);
              }
            }
          }
          
          console.log(`✓ Extracted ${pdfData.Pages?.length || 0} pages, ${fullText.length} characters from PDF`);
          
          // Clear cleanup timer
          if (cleanupTimer) clearTimeout(cleanupTimer);
          
          // Clean up parser reference
          pdfParser.removeAllListeners();
          
          // Aggressive memory cleanup - null out all references
          if (pdfData) {
            if (pdfData.Pages) {
              pdfData.Pages.length = 0;
              pdfData.Pages = null;
            }
            if (pdfData.Meta) pdfData.Meta = null;
            if (pdfData.FormFill) pdfData.FormFill = null;
          }
          pdfDataRef = null;
          
          resolve(fullText.trim());
        } catch (err) {
          // Restore all intercepted methods
          process.stderr.write = originalStderrWrite;
          process.stdout.write = originalStdoutWrite;
          console.warn = originalWarn;
          console.error = originalError;
          
          originalError('Error processing PDF data:', err);
          if (cleanupTimer) clearTimeout(cleanupTimer);
          pdfParser.removeAllListeners();
          reject(err);
        }
      });
      
      pdfParser.on('pdfParser_dataError', (err: any) => {
        // Restore all intercepted methods
        process.stderr.write = originalStderrWrite;
        process.stdout.write = originalStdoutWrite;
        console.warn = originalWarn;
        console.error = originalError;
        
        originalError('PDF parsing error:', err);
        if (cleanupTimer) clearTimeout(cleanupTimer);
        pdfParser.removeAllListeners();
        reject(err instanceof Error ? err : new Error(JSON.stringify(err)));
      });
      
      // Set dynamic timeout to prevent hanging
      cleanupTimer = setTimeout(() => {
        // Restore all intercepted methods
        process.stderr.write = originalStderrWrite;
        process.stdout.write = originalStdoutWrite;
        console.warn = originalWarn;
        console.error = originalError;
        
        pdfParser.removeAllListeners();
        reject(new Error(`PDF parsing timeout after ${timeoutSeconds} seconds`));
      }, calculatedTimeout);
      
      // Parse the buffer
      pdfParser.parseBuffer(buffer);
    } catch (error) {
      // Restore all intercepted methods
      process.stderr.write = originalStderrWrite;
      process.stdout.write = originalStdoutWrite;
      console.warn = originalWarn;
      console.error = originalError;
      
      originalError('PDF extraction failed:', error);
      reject(error);
    }
  });
}

/**
 * Extract text content from various document types
 */
export async function extractTextFromFile(file: File): Promise<ExtractedDocument> {
  const fileName = file.name.toLowerCase();
  
  try {
    // PDF files
    if (fileName.endsWith('.pdf')) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const fileSizeMB = file.size / (1024 * 1024); // Convert to MB
        const text = await extractPdfText(arrayBuffer, fileSizeMB);
        
        console.log(`✓ Successfully extracted ${text.length} characters from ${file.name}`);
        
        return {
          name: file.name,
          content: text || '',
          type: 'pdf',
        };
      } catch (pdfError) {
        // PDF parsing failed - log error and return empty content
        console.error(`❌ PDF extraction failed for ${file.name}:`, pdfError);
        
        // Return empty content so AI can proceed based on filename and context
        return {
          name: file.name,
          content: '',
          type: 'pdf',
        };
      }
    }
    
    // Word documents
    if (fileName.endsWith('.docx') || fileName.endsWith('.doc')) {
      const arrayBuffer = await file.arrayBuffer();
      const buffer = Buffer.from(arrayBuffer);
      const result = await mammoth.extractRawText({ buffer });
      return {
        name: file.name,
        content: result.value,
        type: 'word',
      };
    }
    
    // Email files
    if (fileName.endsWith('.eml') || fileName.endsWith('.msg')) {
      const arrayBuffer = await file.arrayBuffer();
      const text = new TextDecoder().decode(arrayBuffer);
      return {
        name: file.name,
        content: text,
        type: 'email',
      };
    }
    
    // Text files
    if (fileName.endsWith('.txt')) {
      const arrayBuffer = await file.arrayBuffer();
      const text = new TextDecoder().decode(arrayBuffer);
      return {
        name: file.name,
        content: text,
        type: 'text',
      };
    }
    
    // Fallback for unknown types
    const arrayBuffer = await file.arrayBuffer();
    const text = new TextDecoder().decode(arrayBuffer);
    return {
      name: file.name,
      content: text.substring(0, 5000), // Limit unknown types
      type: 'unknown',
    };
  } catch (error) {
    console.error(`Error extracting text from ${file.name}:`, error);
    return {
      name: file.name,
      content: '',
      type: 'unknown',
    };
  }
}

/**
 * Process files sequentially to avoid memory exhaustion
 * This is critical for large PDF files that can overwhelm the heap
 */
export async function extractTextFromFilesSequentially(files: File[]): Promise<ExtractedDocument[]> {
  const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB limit for non-PDF files
  const MAX_PDF_SIZE = 15 * 1024 * 1024; // 15MB limit for PDFs (conservative to prevent OOM)
  const LARGE_PDF_THRESHOLD = 5 * 1024 * 1024; // 5MB - PDFs larger than this require extended processing
  const MEMORY_THRESHOLD = 0.70; // Halt processing if heap usage exceeds 70% of limit (conservative to prevent OOM)
  const MIN_MEMORY_REQUIRED_MB = 2048; // Require at least 2GB free before processing each PDF
  const results: ExtractedDocument[] = [];
  
  // Get actual heap limit (not just currently allocated heap)
  const heapStats = v8.getHeapStatistics();
  const heapLimitMB = Math.round(heapStats.heap_size_limit / 1024 / 1024);
  
  console.log(`Starting sequential extraction of ${files.length} files...`);
  console.log(`Heap limit: ${heapLimitMB}MB, Memory usage at start: ${Math.round(process.memoryUsage().heapUsed / 1024 / 1024)}MB`);
  
  // Pre-flight check: Ensure we have enough heap configured
  if (heapLimitMB < 8000) {
    console.error(`❌ CRITICAL: Heap limit is only ${heapLimitMB}MB. Need at least 8GB for PDF processing.`);
    return files.map(file => ({
      name: file.name,
      content: '[System Configuration Error: Insufficient memory allocated for PDF processing. Please contact support.]',
      type: 'pdf',
    }));
  }
  
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    const isPdf = file.name.toLowerCase().endsWith('.pdf');
    
    // Check memory before processing each file (use actual heap limit, not heapTotal)
    const memStatus = process.memoryUsage();
    const heapUsedMB = memStatus.heapUsed / 1024 / 1024;
    const heapAvailableMB = heapLimitMB - heapUsedMB;
    const heapUsedPercent = memStatus.heapUsed / heapStats.heap_size_limit;
    
    console.log(`[File ${i + 1}/${files.length}] Memory check: ${Math.round(heapUsedMB)}MB used, ${Math.round(heapAvailableMB)}MB available, ${Math.round(heapUsedPercent * 100)}% of limit`);
    
    // Stop if memory threshold exceeded
    if (heapUsedPercent > MEMORY_THRESHOLD) {
      console.error(`❌ Memory threshold exceeded: ${Math.round(heapUsedMB)}MB / ${heapLimitMB}MB (${Math.round(heapUsedPercent * 100)}% of heap limit). Halting extraction to prevent crash.`);
      results.push({
        name: file.name,
        content: `[Extraction halted: Memory limit reached at ${Math.round(heapUsedPercent * 100)}%. Please process files in smaller batches or reduce file sizes. Current usage: ${Math.round(heapUsedMB)}MB / ${heapLimitMB}MB]`,
        type: isPdf ? 'pdf' : 'unknown',
      });
      
      // Skip remaining files
      for (let j = i + 1; j < files.length; j++) {
        results.push({
          name: files[j].name,
          content: '[Extraction skipped: Memory limit reached for batch]',
          type: 'unknown',
        });
      }
      break;
    }
    
    // For PDFs, ensure we have enough free memory before attempting extraction
    if (isPdf && heapAvailableMB < MIN_MEMORY_REQUIRED_MB) {
      console.error(`❌ Insufficient free memory for PDF: ${Math.round(heapAvailableMB)}MB available, need ${MIN_MEMORY_REQUIRED_MB}MB minimum`);
      
      // Run aggressive GC to try to free memory
      if (global.gc) {
        console.log(`Running emergency garbage collection...`);
        for (let gc_i = 0; gc_i < 5; gc_i++) {
          global.gc();
          await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        const memAfterGC = process.memoryUsage();
        const heapAvailableAfterGC = heapLimitMB - (memAfterGC.heapUsed / 1024 / 1024);
        console.log(`Memory after emergency GC: ${Math.round(memAfterGC.heapUsed / 1024 / 1024)}MB used, ${Math.round(heapAvailableAfterGC)}MB available`);
        
        // If still not enough memory, skip this file
        if (heapAvailableAfterGC < MIN_MEMORY_REQUIRED_MB) {
          console.error(`❌ Still insufficient memory after GC. Skipping ${file.name}`);
          results.push({
            name: file.name,
            content: `[Extraction skipped: Insufficient memory available (${Math.round(heapAvailableAfterGC)}MB free, need ${MIN_MEMORY_REQUIRED_MB}MB). Please process this file separately or restart the system.]`,
            type: 'pdf',
          });
          continue;
        }
      } else {
        // GC not available, skip file
        console.error(`❌ GC not available and insufficient memory. Skipping ${file.name}`);
        results.push({
          name: file.name,
          content: `[Extraction skipped: Insufficient memory available and garbage collection unavailable. Please process this file separately or restart the system.]`,
          type: 'pdf',
        });
        continue;
      }
    }
    
    // Apply stricter size limit for PDFs
    const effectiveLimit = isPdf ? MAX_PDF_SIZE : MAX_FILE_SIZE;
    
    // Validate file size
    if (file.size > effectiveLimit) {
      const limitMB = Math.round(effectiveLimit / 1024 / 1024);
      const fileMB = Math.round(file.size / 1024 / 1024);
      console.warn(`⚠ Skipping ${file.name} - exceeds ${limitMB}MB limit (${fileMB}MB)`);
      results.push({
        name: file.name,
        content: `[File too large: ${fileMB}MB. Maximum size for ${isPdf ? 'PDFs' : 'files'} is ${limitMB}MB to prevent memory exhaustion. Please split into smaller files, reduce file complexity, or compress the PDF.]`,
        type: isPdf ? 'pdf' : 'unknown',
      });
      continue;
    }
    
    // Warn about potentially problematic PDFs
    if (isPdf && file.size > LARGE_PDF_THRESHOLD) {
      const fileMB = (file.size / 1024 / 1024).toFixed(1);
      console.warn(`⚠ Large PDF detected: ${file.name} (${fileMB}MB) - may require extended processing time and significant memory`);
    }
    
    console.log(`[${i + 1}/${files.length}] Extracting ${file.name} (${Math.round(file.size / 1024)}KB)...`);
    
    // Check memory before processing
    const memBefore = process.memoryUsage();
    console.log(`Memory before: ${Math.round(memBefore.heapUsed / 1024 / 1024)}MB / ${Math.round(memBefore.heapTotal / 1024 / 1024)}MB`);
    
    try {
      const extracted = await extractTextFromFile(file);
      results.push(extracted);
      
      // Aggressive memory cleanup after each file
      if (global.gc) {
        console.log(`Running garbage collection...`);
        
        // Run GC multiple times for large PDFs
        const gcRuns = (isPdf && file.size > LARGE_PDF_THRESHOLD) ? 3 : 1;
        for (let gc_i = 0; gc_i < gcRuns; gc_i++) {
          global.gc();
          await new Promise(resolve => setTimeout(resolve, 150));
        }
        
        const memAfterGC = process.memoryUsage();
        console.log(`Memory after GC: ${Math.round(memAfterGC.heapUsed / 1024 / 1024)}MB / ${Math.round(memAfterGC.heapTotal / 1024 / 1024)}MB`);
      }
      
      // Longer delay for large PDFs to allow thorough memory cleanup
      const delayMs = (isPdf && file.size > LARGE_PDF_THRESHOLD) ? 2000 : 500;
      await new Promise(resolve => setTimeout(resolve, delayMs));
      
      console.log(`✓ [${i + 1}/${files.length}] Completed ${file.name}`);
    } catch (error: any) {
      console.error(`❌ [${i + 1}/${files.length}] Failed to extract ${file.name}:`, error);
      
      // Check if it's a memory error
      if (error.message && (error.message.includes('heap') || error.message.includes('memory'))) {
        console.error(`💥 Memory exhaustion detected for ${file.name}. Skipping remaining files to prevent crash.`);
        results.push({
          name: file.name,
          content: `[Extraction failed: File too complex and caused memory exhaustion. Please try uploading a smaller or simpler PDF.]`,
          type: 'pdf',
        });
        
        // Skip remaining files to prevent cascade failures
        for (let j = i + 1; j < files.length; j++) {
          results.push({
            name: files[j].name,
            content: '[Extraction skipped: Previous file caused memory exhaustion]',
            type: 'unknown',
          });
        }
        break;
      }
      
      results.push({
        name: file.name,
        content: `[Extraction failed: ${error.message || 'Unknown error'}]`,
        type: 'unknown',
      });
      
      // Force GC even on error
      if (global.gc) {
        global.gc();
        await new Promise(resolve => setTimeout(resolve, 100));
      }
    }
  }
  
  const finalMemUsage = Math.round(process.memoryUsage().heapUsed / 1024 / 1024);
  const finalMemPercent = Math.round((process.memoryUsage().heapUsed / heapStats.heap_size_limit) * 100);
  
  console.log(`Sequential extraction complete: ${results.length} files processed`);
  console.log(`Memory usage at end: ${finalMemUsage}MB / ${heapLimitMB}MB (${finalMemPercent}%)`);
  return results;
}

/**
 * Categorize documents into RFP docs vs preliminary emails
 */
export function categorizeDocuments(extractedDocs: ExtractedDocument[]): {
  rfpDocuments: ExtractedDocument[];
  emailDocuments: ExtractedDocument[];
} {
  const rfpDocuments: ExtractedDocument[] = [];
  const emailDocuments: ExtractedDocument[] = [];
  
  for (const doc of extractedDocs) {
    if (doc.type === 'email' || doc.name.toLowerCase().includes('email')) {
      emailDocuments.push(doc);
    } else {
      rfpDocuments.push(doc);
    }
  }
  
  return { rfpDocuments, emailDocuments };
}
// ==========================================
// File: lib/docx-generator.ts
// ==========================================


import { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, UnderlineType, Table, TableRow, TableCell, WidthType, BorderStyle } from 'docx';

/**
 * Strip all markdown formatting from text
 * Comprehensive removal of markdown syntax
 */
function stripMarkdown(text: string): string {
  if (!text) return '';
  
  return text
    // Remove horizontal rules (---, ___, ***)
    .replace(/^[\s]*[-_*]{3,}[\s]*$/gm, '')
    // Remove headers (# ## ### etc)
    .replace(/^#{1,6}\s+/gm, '')
    // Remove bold (**text** or __text__)
    .replace(/\*\*(.+?)\*\*/g, '$1')
    .replace(/__(.+?)__/g, '$1')
    // Remove italic (*text* or _text_)
    .replace(/\*(.+?)\*/g, '$1')
    .replace(/_(.+?)_/g, '$1')
    // Remove strikethrough (~~text~~)
    .replace(/~~(.+?)~~/g, '$1')
    // Remove inline code (`code`)
    .replace(/`([^`]+)`/g, '$1')
    // Remove code blocks (```code```)
    .replace(/```[\s\S]*?```/g, '')
    // Remove links [text](url)
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')
    // Remove images ![alt](url)
    .replace(/!\[([^\]]*)\]\([^\)]+\)/g, '$1')
    // Remove blockquotes (> text)
    .replace(/^>\s+/gm, '')
    // Clean up multiple newlines
    .replace(/\n{3,}/g, '\n\n')
    .trim();
}

/**
 * Generate a Word document from proposal content with enhanced formatting
 */
export async function generateWordDocument(
  proposalContent: string,
  bidTitle: string,
  solicitationNumber: string,
  envelopeType: 1 | 2
): Promise<Buffer> {
  const envelopeTitle = envelopeType === 1 ? 'Technical Proposal' : 'Cost Proposal';
  
  // Strip markdown and parse content into sections
  const cleanContent = stripMarkdown(proposalContent);
  const sections = parseMarkdownContent(cleanContent);
  
  // Create document sections
  const docSections: Paragraph[] = [];

  // Title page with professional formatting
  docSections.push(
    new Paragraph({
      text: stripMarkdown(bidTitle),
      heading: HeadingLevel.TITLE,
      alignment: AlignmentType.CENTER,
      spacing: { after: 300 },
    }),
    new Paragraph({
      text: envelopeTitle,
      heading: HeadingLevel.HEADING_1,
      alignment: AlignmentType.CENTER,
      spacing: { after: 300 },
    }),
    new Paragraph({
      text: `Solicitation: ${stripMarkdown(solicitationNumber)}`,
      alignment: AlignmentType.CENTER,
      spacing: { after: 200 },
    }),
    new Paragraph({
      text: 'Prepared by CDM Suite LLC',
      alignment: AlignmentType.CENTER,
      spacing: { after: 200 },
    }),
    new Paragraph({
      text: `Date: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`,
      alignment: AlignmentType.CENTER,
      spacing: { after: 400 },
    }),
    new Paragraph({
      children: [
        new TextRun({
          text: 'Confidential & Proprietary',
          italics: true,
          size: 22, // 11pt
        }),
      ],
      alignment: AlignmentType.CENTER,
      spacing: { after: 800 },
    }),
    // Page break after title page
    new Paragraph({
      text: '',
      pageBreakBefore: true,
    })
  );

  // Content sections with enhanced formatting
  sections.forEach((section, sectionIndex) => {
    // Section header with consistent styling
    docSections.push(
      new Paragraph({
        text: section.title,
        heading: HeadingLevel.HEADING_1,
        spacing: { before: 400, after: 240 },
      })
    );

    // Section content with improved paragraph handling
    section.paragraphs.forEach((para) => {
      if (para.isBullet) {
        docSections.push(
          new Paragraph({
            text: para.text,
            bullet: { level: 0 },
            spacing: { after: 100 },
          })
        );
      } else if (para.isSubHeading) {
        docSections.push(
          new Paragraph({
            text: para.text,
            heading: HeadingLevel.HEADING_2,
            spacing: { before: 240, after: 120 },
          })
        );
      } else if (para.text.length > 0) {
        // Regular paragraph with proper spacing
        docSections.push(
          new Paragraph({
            text: para.text,
            spacing: { after: 140, line: 360 }, // 1.5 line spacing
          })
        );
      }
    });
    
    // Add extra space between major sections
    if (sectionIndex < sections.length - 1) {
      docSections.push(
        new Paragraph({
          text: '',
          spacing: { after: 200 },
        })
      );
    }
  });

  // Create document with professional styling
  const doc = new Document({
    sections: [
      {
        properties: {
          page: {
            margin: {
              top: 1440,    // 1 inch
              right: 1440,  // 1 inch
              bottom: 1440, // 1 inch
              left: 1440,   // 1 inch
            },
          },
        },
        children: docSections,
      },
    ],
  });

  // Generate buffer
  const buffer = await Packer.toBuffer(doc);
  return buffer;
}

interface ParsedSection {
  title: string;
  paragraphs: Array<{
    text: string;
    isBullet: boolean;
    isSubHeading: boolean;
  }>;
}

function parseMarkdownContent(content: string): ParsedSection[] {
  const sections: ParsedSection[] = [];
  const lines = content.split('\n');
  
  let currentSection: ParsedSection | null = null;

  for (const line of lines) {
    const trimmed = line.trim();
    
    if (!trimmed) continue;

    // Main heading (##)
    if (trimmed.startsWith('## ')) {
      if (currentSection) {
        sections.push(currentSection);
      }
      currentSection = {
        title: trimmed.replace(/^##\s*/, ''),
        paragraphs: [],
      };
    }
    // Sub-heading (###)
    else if (trimmed.startsWith('### ')) {
      if (currentSection) {
        currentSection.paragraphs.push({
          text: trimmed.replace(/^###\s*/, ''),
          isBullet: false,
          isSubHeading: true,
        });
      }
    }
    // Bullet point
    else if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
      if (currentSection) {
        currentSection.paragraphs.push({
          text: trimmed.replace(/^[-*]\s*/, ''),
          isBullet: true,
          isSubHeading: false,
        });
      }
    }
    // Regular paragraph
    else if (currentSection && trimmed.length > 0 && !trimmed.startsWith('#')) {
      currentSection.paragraphs.push({
        text: trimmed,
        isBullet: false,
        isSubHeading: false,
      });
    }
  }

  if (currentSection) {
    sections.push(currentSection);
  }

  return sections;
}

// ==========================================
// File: lib/email-templates.ts
// ==========================================


// Email templates for audit results and sales

interface AuditEmailData {
  name: string;
  websiteUrl: string;
  overallScore: number;
  seoScore: number;
  performanceScore: number;
  mobileScore: number;
  securityScore: number;
  criticalIssues: string[];
  recommendations: any[];
  suggestedServices: any[];
}

export function generateAuditResultEmail(data: AuditEmailData): string {
  const { name, websiteUrl, overallScore, seoScore, performanceScore, mobileScore, securityScore, criticalIssues, recommendations, suggestedServices } = data;
  
  const scoreColor = overallScore >= 80 ? '#10b981' : overallScore >= 60 ? '#f59e0b' : '#ef4444';
  const urgencyLevel = overallScore < 60 ? 'CRITICAL' : overallScore < 75 ? 'IMPORTANT' : 'GOOD';
  
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Website Audit Results</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f7fafc;">
  <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f7fafc; padding: 40px 20px;">
    <tr>
      <td align="center">
        <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden;">
          
          <!-- Header -->
          <tr>
            <td style="background: linear-gradient(135deg, #001F3F 0%, #003A70 100%); padding: 40px 30px; text-align: center;">
              <h1 style="margin: 0; color: #ffffff; font-size: 28px; font-weight: bold;">Your Website Audit Results</h1>
              <p style="margin: 10px 0 0 0; color: #93C5FD; font-size: 16px;">${websiteUrl}</p>
            </td>
          </tr>

          <!-- Overall Score -->
          <tr>
            <td style="padding: 40px 30px; text-align: center; background-color: #F8FAFC;">
              <div style="display: inline-block; width: 140px; height: 140px; border-radius: 50%; background: ${scoreColor}; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                <div>
                  <div style="color: #ffffff; font-size: 48px; font-weight: bold; line-height: 1;">${overallScore}</div>
                  <div style="color: #ffffff; font-size: 14px; font-weight: 600;">/100</div>
                </div>
              </div>
              <h2 style="margin: 0 0 10px 0; color: #1E293B; font-size: 24px;">Overall Health Score</h2>
              <p style="margin: 0; color: #64748B; font-size: 18px; font-weight: 600;">${urgencyLevel} - Action ${overallScore < 75 ? 'Required' : 'Recommended'}</p>
            </td>
          </tr>

          <!-- Detailed Scores -->
          <tr>
            <td style="padding: 30px;">
              <h3 style="margin: 0 0 20px 0; color: #1E293B; font-size: 20px; text-align: center;">Detailed Analysis</h3>
              
              ${generateScoreBar('SEO Optimization', seoScore)}
              ${generateScoreBar('Performance', performanceScore)}
              ${generateScoreBar('Mobile Experience', mobileScore)}
              ${generateScoreBar('Security', securityScore)}
            </td>
          </tr>

          <!-- Critical Issues -->
          ${criticalIssues.length > 0 ? `
          <tr>
            <td style="padding: 30px; background-color: #FEF2F2;">
              <h3 style="margin: 0 0 15px 0; color: #DC2626; font-size: 18px;">⚠️ Critical Issues Found</h3>
              ${criticalIssues.map(issue => `
                <div style="margin-bottom: 10px; padding: 12px; background-color: #ffffff; border-left: 4px solid #DC2626; border-radius: 4px;">
                  <p style="margin: 0; color: #1E293B; font-size: 14px;">${issue}</p>
                </div>
              `).join('')}
            </td>
          </tr>
          ` : ''}

          <!-- The Hook - What This Means for Your Business -->
          <tr>
            <td style="padding: 40px 30px; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);">
              <h3 style="margin: 0 0 15px 0; color: #92400E; font-size: 22px; text-align: center;">💰 What This Means for Your Business</h3>
              <p style="margin: 0 0 15px 0; color: #451A03; font-size: 16px; line-height: 1.6;">
                Hi ${name},
              </p>
              <p style="margin: 0 0 15px 0; color: #451A03; font-size: 16px; line-height: 1.6;">
                ${overallScore < 60 
                  ? `Your website is currently <strong>losing you money</strong>. With a score of ${overallScore}/100, you're likely losing 60-80% of potential customers before they even contact you.`
                  : overallScore < 75
                  ? `Your website has solid foundations, but there are <strong>hidden opportunities</strong> being missed. Small improvements could increase your leads by 40-60%.`
                  : `Your website performs well, but even <strong>small optimizations</strong> at this level can translate to significant revenue increases.`
                }
              </p>
              <p style="margin: 0; color: #451A03; font-size: 16px; line-height: 1.6;">
                <strong>The good news?</strong> Every issue we found is fixable, and we've helped hundreds of businesses just like yours turn these problems into profit.
              </p>
            </td>
          </tr>

          <!-- Social Proof -->
          <tr>
            <td style="padding: 30px; text-align: center; background-color: #F8FAFC;">
              <p style="margin: 0 0 10px 0; color: #64748B; font-size: 14px; font-style: italic;">"We increased our leads by 347% in just 90 days after CDM Suite fixed our website issues."</p>
              <p style="margin: 0; color: #94A3B8; font-size: 12px;">— Sarah Johnson, TechStart Solutions</p>
            </td>
          </tr>

          <!-- Main CTA - Limited Time Offer -->
          <tr>
            <td style="padding: 40px 30px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); text-align: center;">
              <h3 style="margin: 0 0 15px 0; color: #ffffff; font-size: 24px;">🎯 Limited Time: Free Strategy Session</h3>
              <p style="margin: 0 0 25px 0; color: #D1FAE5; font-size: 16px; line-height: 1.6;">
                Book a <strong>FREE 30-minute strategy call</strong> in the next 48 hours and receive:<br>
                ✅ Personalized action plan (Value: $500)<br>
                ✅ Priority implementation timeline<br>
                ✅ ROI projections for your specific website
              </p>
              <a href="https://cdmsuite.abacusai.app/contact?source=audit&score=${overallScore}" style="display: inline-block; padding: 18px 40px; background-color: #FBBF24; color: #1E293B; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                Claim Your Free Strategy Session →
              </a>
              <p style="margin: 15px 0 0 0; color: #D1FAE5; font-size: 13px;">⏰ Only 3 spots left this week</p>
            </td>
          </tr>

          <!-- Recommended Services -->
          ${suggestedServices.length > 0 ? `
          <tr>
            <td style="padding: 40px 30px;">
              <h3 style="margin: 0 0 25px 0; color: #1E293B; font-size: 22px; text-align: center;">Recommended Solutions for ${websiteUrl}</h3>
              
              ${suggestedServices.map((service, index) => `
                <div style="margin-bottom: 20px; padding: 20px; border: 2px solid ${index === 0 ? '#10B981' : '#E2E8F0'}; border-radius: 8px; ${index === 0 ? 'background-color: #ECFDF5;' : ''}">
                  ${index === 0 ? '<div style="display: inline-block; background-color: #10B981; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-bottom: 10px;">MOST POPULAR</div>' : ''}
                  <h4 style="margin: 0 0 10px 0; color: #1E293B; font-size: 18px;">${service.name}</h4>
                  <p style="margin: 0 0 15px 0; color: #64748B; font-size: 14px; line-height: 1.5;">${service.reason}</p>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #059669; font-size: 20px; font-weight: bold;">${service.price}</span>
                    <a href="https://cdmsuite.abacusai.app/services/${service.slug}?ref=audit" style="padding: 10px 20px; background-color: #3B82F6; color: white; text-decoration: none; border-radius: 6px; font-size: 14px; font-weight: 600;">Learn More →</a>
                  </div>
                </div>
              `).join('')}
            </td>
          </tr>
          ` : ''}

          <!-- Urgency & Scarcity -->
          <tr>
            <td style="padding: 30px; background-color: #FEF2F2; text-align: center;">
              <h3 style="margin: 0 0 15px 0; color: #DC2626; font-size: 20px;">⚡ Don't Wait - Every Day Costs You Money</h3>
              <p style="margin: 0 0 20px 0; color: #991B1B; font-size: 15px; line-height: 1.6;">
                ${overallScore < 60 
                  ? 'Your competitors are capturing the customers you\'re losing. The longer you wait, the more market share they gain.'
                  : 'Your competitors are constantly improving. Staying ahead means taking action today, not tomorrow.'
                }
              </p>
              <p style="margin: 0; color: #DC2626; font-size: 16px; font-weight: bold;">
                📞 Call us now: <a href="tel:8622727623" style="color: #DC2626; text-decoration: none;">(862) 272-7623</a>
              </p>
            </td>
          </tr>

          <!-- Footer -->
          <tr>
            <td style="padding: 30px; background-color: #F8FAFC; text-align: center; border-top: 1px solid #E2E8F0;">
              <p style="margin: 0 0 10px 0; color: #1E293B; font-size: 16px; font-weight: 600;">CDM Suite</p>
              <p style="margin: 0 0 5px 0; color: #64748B; font-size: 14px;">Helping businesses grow since 2010</p>
              <p style="margin: 0; color: #64748B; font-size: 14px;">
                <a href="https://cdmsuite.abacusai.app" style="color: #3B82F6; text-decoration: none;">Visit Our Website</a> | 
                <a href="tel:8622727623" style="color: #3B82F6; text-decoration: none;">(862) 272-7623</a>
              </p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>
</body>
</html>
  `;
}

function generateScoreBar(label: string, score: number): string {
  const color = score >= 80 ? '#10b981' : score >= 60 ? '#f59e0b' : '#ef4444';
  const width = Math.max(score, 5); // Minimum 5% width for visibility
  
  return `
    <div style="margin-bottom: 20px;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span style="color: #1E293B; font-size: 14px; font-weight: 600;">${label}</span>
        <span style="color: ${color}; font-size: 14px; font-weight: bold;">${score}/100</span>
      </div>
      <div style="width: 100%; height: 12px; background-color: #E2E8F0; border-radius: 6px; overflow: hidden;">
        <div style="width: ${width}%; height: 100%; background-color: ${color}; border-radius: 6px; transition: width 0.3s ease;"></div>
      </div>
    </div>
  `;
}

export function generateLeadNotificationEmail(data: any): string {
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>New Lead from Website Audit</title>
</head>
<body style="font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5;">
  <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 8px;">
    <h2 style="color: #1E293B; margin-bottom: 20px;">🎯 New Lead: Website Audit</h2>
    
    <div style="background-color: #F8FAFC; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
      <p style="margin: 5px 0;"><strong>Name:</strong> ${data.name || 'Not provided'}</p>
      <p style="margin: 5px 0;"><strong>Email:</strong> ${data.email}</p>
      <p style="margin: 5px 0;"><strong>Phone:</strong> ${data.phone || 'Not provided'}</p>
      <p style="margin: 5px 0;"><strong>Company:</strong> ${data.company || 'Not provided'}</p>
      <p style="margin: 5px 0;"><strong>Website:</strong> ${data.websiteUrl}</p>
      <p style="margin: 5px 0;"><strong>Overall Score:</strong> <span style="color: ${data.score >= 75 ? '#10b981' : data.score >= 60 ? '#f59e0b' : '#ef4444'}; font-weight: bold;">${data.score}/100</span></p>
    </div>

    <div style="background-color: ${data.score < 60 ? '#FEE2E2' : data.score < 75 ? '#FEF3C7' : '#D1FAE5'}; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
      <p style="margin: 0; font-weight: bold; color: #1E293B;">
        ${data.score < 60 ? '🔥 HIGH PRIORITY - Critical issues found' : data.score < 75 ? '⚡ GOOD OPPORTUNITY - Multiple improvement areas' : '✅ QUALITY LEAD - Website performing well, upsell potential'}
      </p>
    </div>

    ${data.goals && data.goals.length > 0 ? `
    <div style="margin-bottom: 20px;">
      <p style="font-weight: bold; margin-bottom: 10px;">Goals:</p>
      <ul style="margin: 0; padding-left: 20px;">
        ${data.goals.map((goal: string) => `<li>${goal}</li>`).join('')}
      </ul>
    </div>
    ` : ''}

    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #E2E8F0;">
      <p style="margin: 0; color: #64748B; font-size: 14px;">
        <strong>Action Required:</strong> Follow up within 1 hour for best conversion rates.
      </p>
    </div>
  </div>
</body>
</html>
  `;
}

// ROI Calculator Email Template
export function generateROICalculatorEmail(data: any): string {
  const { name, monthlyVisitors, conversionRate, averageOrderValue, yearlyAdditionalRevenue, additionalRevenue } = data;
  
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your ROI Projection</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f7fafc;">
  <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f7fafc; padding: 40px 20px;">
    <tr>
      <td align="center">
        <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden;">
          
          <!-- Header -->
          <tr>
            <td style="background: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%); padding: 40px 30px; text-align: center;">
              <h1 style="margin: 0; color: #1E293B; font-size: 28px; font-weight: bold;">Your Revenue Potential</h1>
              <p style="margin: 10px 0 0 0; color: #422006; font-size: 16px;">Based on Conservative Industry Estimates</p>
            </td>
          </tr>

          <!-- Big Number -->
          <tr>
            <td style="padding: 40px 30px; text-align: center; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);">
              <p style="margin: 0 0 10px 0; color: #78350F; font-size: 18px; font-weight: 600;">Hi ${name},</p>
              <p style="margin: 0 0 20px 0; color: #92400E; font-size: 16px;">You Could Generate An Additional</p>
              <div style="margin: 20px 0;">
                <p style="margin: 0; font-size: 56px; font-weight: bold; color: #059669; line-height: 1;">${formatCurrency(yearlyAdditionalRevenue)}</p>
                <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: 600; color: #065F46;">Per Year</p>
              </div>
              <p style="margin: 20px 0 0 0; color: #92400E; font-size: 15px;">That's ${formatCurrency(additionalRevenue)} extra per month!</p>
            </td>
          </tr>

          <!-- Your Current Metrics -->
          <tr>
            <td style="padding: 30px;">
              <h3 style="margin: 0 0 20px 0; color: #1E293B; font-size: 20px; text-align: center;">Your Current Metrics</h3>
              <table width="100%" cellpadding="10">
                <tr>
                  <td style="padding: 15px; background-color: #F8FAFC; border-radius: 6px; text-align: center;">
                    <p style="margin: 0 0 5px 0; color: #64748B; font-size: 14px;">Monthly Visitors</p>
                    <p style="margin: 0; color: #1E293B; font-size: 24px; font-weight: bold;">${formatNumber(monthlyVisitors)}</p>
                  </td>
                  <td style="padding: 15px; background-color: #F8FAFC; border-radius: 6px; text-align: center;">
                    <p style="margin: 0 0 5px 0; color: #64748B; font-size: 14px;">Conversion Rate</p>
                    <p style="margin: 0; color: #1E293B; font-size: 24px; font-weight: bold;">${conversionRate}%</p>
                  </td>
                </tr>
                <tr>
                  <td colspan="2" style="padding: 15px; background-color: #F8FAFC; border-radius: 6px; text-align: center;">
                    <p style="margin: 0 0 5px 0; color: #64748B; font-size: 14px;">Average Order Value</p>
                    <p style="margin: 0; color: #1E293B; font-size: 24px; font-weight: bold;">${formatCurrency(averageOrderValue)}</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>

          <!-- The Hook -->
          <tr>
            <td style="padding: 40px 30px; background-color: #FEF2F2;">
              <h3 style="margin: 0 0 15px 0; color: #DC2626; font-size: 22px; text-align: center;">⚡ But Here's the Problem...</h3>
              <p style="margin: 0 0 15px 0; color: #991B1B; font-size: 16px; line-height: 1.6;">
                Right now, you're leaving <strong>${formatCurrency(yearlyAdditionalRevenue)}</strong> on the table every single year.
              </p>
              <p style="margin: 0 0 15px 0; color: #991B1B; font-size: 16px; line-height: 1.6;">
                While your competitors are capturing these customers, you're losing them to:
              </p>
              <ul style="margin: 0 0 15px 20px; color: #991B1B; font-size: 15px; line-height: 1.8;">
                <li>Poor website design that doesn't convert</li>
                <li>Weak SEO that keeps you invisible on Google</li>
                <li>No follow-up system to nurture leads</li>
                <li>Missing trust signals and social proof</li>
              </ul>
              <p style="margin: 0; color: #DC2626; font-size: 16px; font-weight: bold;">
                Every day you wait costs you ${formatCurrency(additionalRevenue / 30)}.
              </p>
            </td>
          </tr>

          <!-- Social Proof -->
          <tr>
            <td style="padding: 30px; background-color: #F0FDF4;">
              <p style="margin: 0 0 10px 0; color: #166534; font-size: 15px; font-style: italic; text-align: center;">"We used CDM Suite's strategy and increased our monthly revenue by $94K in just 4 months. The calculator was actually conservative!"</p>
              <p style="margin: 0; color: #15803D; font-size: 13px; text-align: center;">— Jennifer L., Service Business Owner</p>
            </td>
          </tr>

          <!-- Main CTA -->
          <tr>
            <td style="padding: 40px 30px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); text-align: center;">
              <h3 style="margin: 0 0 15px 0; color: #ffffff; font-size: 24px;">🎯 Let's Turn This Into Reality</h3>
              <p style="margin: 0 0 25px 0; color: #D1FAE5; font-size: 16px; line-height: 1.6;">
                Book a <strong>FREE 30-minute strategy call</strong> this week and get:<br>
                ✅ Custom action plan to reach your revenue goals (Value: $500)<br>
                ✅ ROI projections specific to your business<br>
                ✅ Priority implementation timeline
              </p>
              <a href="https://cdmsuite.abacusai.app/contact?source=roi-calculator" style="display: inline-block; padding: 18px 40px; background-color: #FBBF24; color: #1E293B; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                Claim Your Free Strategy Session →
              </a>
              <p style="margin: 15px 0 0 0; color: #D1FAE5; font-size: 13px;">⏰ Limited spots available - First come, first served</p>
            </td>
          </tr>

          <!-- Tripwire Offer -->
          <tr>
            <td style="padding: 40px 30px; background-color: #EFF6FF; border: 3px solid #3B82F6;">
              <h3 style="margin: 0 0 15px 0; color: #1E40AF; font-size: 22px; text-align: center;">🚀 Want Results FASTER?</h3>
              <p style="margin: 0 0 20px 0; color: #1E3A8A; font-size: 16px; line-height: 1.6; text-align: center;">
                Get our <strong>"Quick Win Marketing Package"</strong> - specifically designed to help businesses like yours start generating additional revenue within 30 days.
              </p>
              <div style="background-color: #ffffff; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0 0 15px 0; color: #1E293B; font-size: 18px; font-weight: bold;">Includes:</p>
                <ul style="margin: 0 0 20px 20px; color: #334155; font-size: 15px; line-height: 1.8;">
                  <li>Conversion-optimized landing page</li>
                  <li>30-day email nurture sequence</li>
                  <li>Google Ads setup ($500 ad credit included)</li>
                  <li>Weekly performance reports</li>
                </ul>
                <div style="text-align: center;">
                  <p style="margin: 0 0 10px 0;"><span style="color: #94A3B8; font-size: 16px; text-decoration: line-through;">Regular Price: $2,997</span></p>
                  <p style="margin: 0 0 20px 0; color: #059669; font-size: 36px; font-weight: bold;">Today Only: $997</p>
                  <a href="https://cdmsuite.abacusai.app/services/quick-win?source=roi-calculator" style="display: inline-block; padding: 16px 36px; background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: #ffffff; text-decoration: none; border-radius: 8px; font-size: 17px; font-weight: bold;">
                    Get Started Now →
                  </a>
                  <p style="margin: 15px 0 0 0; color: #64748B; font-size: 12px;">💰 30-day money-back guarantee • ⚡ Setup starts immediately</p>
                </div>
              </div>
            </td>
          </tr>

          <!-- Urgency -->
          <tr>
            <td style="padding: 20px 30px; background-color: #FEF2F2; text-align: center; border-top: 2px solid #DC2626;">
              <p style="margin: 0; color: #991B1B; font-size: 14px; font-weight: bold;">
                ⏰ Time is money. Every week you delay costs you ${formatCurrency((additionalRevenue * 12) / 52)}.
              </p>
            </td>
          </tr>

          <!-- Footer -->
          <tr>
            <td style="padding: 30px; background-color: #F8FAFC; text-align: center; border-top: 1px solid #E2E8F0;">
              <p style="margin: 0 0 10px 0; color: #1E293B; font-size: 16px; font-weight: 600;">CDM Suite</p>
              <p style="margin: 0 0 5px 0; color: #64748B; font-size: 14px;">Helping businesses grow since 2010</p>
              <p style="margin: 0; color: #64748B; font-size: 14px;">
                <a href="https://cdmsuite.abacusai.app" style="color: #3B82F6; text-decoration: none;">Visit Our Website</a> | 
                <a href="tel:8622727623" style="color: #3B82F6; text-decoration: none;">(862) 272-7623</a>
              </p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>
</body>
</html>
  `;
}

function formatCurrency(value: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(value);
}

function formatNumber(value: number): string {
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(value);
}

// ==========================================
// File: lib/email.ts
// ==========================================


import type { Resend } from 'resend';
import { getResendClient } from '@/lib/resend-client';

/**
 * Email Service Utility
 * Uses Resend for email delivery
 */

interface EmailOptions {
  to: string;
  subject: string;
  html?: string;
  text?: string;
  template?: string;
  data?: any;
  tags?: { name: string; value: string }[];
}

interface EmailResult {
  success: boolean;
  messageId?: string;
  error?: string;
}

/**
 * Email service class for sequence execution
 */
class EmailService {
  private resend: Resend | null;

  constructor() {
    this.resend = getResendClient();
  }

  /**
   * Send an email
   */
  async sendEmail(options: EmailOptions): Promise<EmailResult> {
    try {
      // If Resend is not configured, log to console (development mode)
      if (!this.resend) {
        console.log('📧 Email (Development Mode):');
        console.log('To:', options.to);
        console.log('Subject:', options.subject);
        console.log('Content:', options.html || options.text);
        return { success: true, messageId: `dev-${Date.now()}` };
      }

      // Send email via Resend
      const fromEmail = process.env.EMAIL_FROM || 'CDM Suite <onboarding@resend.dev>';
      
      const emailData: any = {
        from: fromEmail,
        to: options.to,
        subject: options.subject,
      };

      // Resend requires either html or text
      if (options.html) {
        emailData.html = options.html;
      } else if (options.text) {
        emailData.text = options.text;
      } else {
        emailData.text = 'This is a test email from CDM Suite.';
      }

      // Add tags for tracking
      if (options.tags && options.tags.length > 0) {
        emailData.tags = options.tags;
      }
      
      const result = await this.resend.emails.send(emailData);

      if (result.error) {
        console.error('❌ Resend API error:', result.error);
        return { success: false, error: result.error.message };
      }

      console.log('✅ Email sent successfully via Resend:', result.data?.id);
      return { success: true, messageId: result.data?.id };
    } catch (error) {
      console.error('❌ Failed to send email:', error);
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error',
      };
    }
  }
}

// Export singleton instance
export const emailService = new EmailService();

/**
 * Legacy send email function (for backward compatibility)
 */
export async function sendEmail(options: EmailOptions): Promise<boolean> {
  // Add reply-to header and ensure from email is set correctly
  const fromEmail = process.env.EMAIL_FROM || 'CDM Suite <hello@cdmsuite.com>';
  const replyTo = 'hello@cdmsuite.com';
  
  const emailData: any = {
    from: fromEmail,
    to: options.to,
    subject: options.subject,
    reply_to: replyTo, // Add reply-to header
  };

  // Ensure HTML content
  if (options.html) {
    emailData.html = options.html;
  } else if (options.text) {
    // Convert text to basic HTML if HTML not provided
    emailData.html = `<div style="font-family: Arial, sans-serif; line-height: 1.6;">${options.text.replace(/\n/g, '<br>')}</div>`;
  } else {
    emailData.text = 'This is a test email from CDM Suite.';
  }

  // Add tags for tracking
  if (options.tags && options.tags.length > 0) {
    emailData.tags = options.tags;
  }

  try {
    const resend = getResendClient();
    if (!resend) {
      console.log('📧 Email (Development Mode):', emailData);
      return true;
    }

    const result = await resend.emails.send(emailData);

    if (result.error) {
      console.error('❌ Resend API error:', result.error);
      return false;
    }

    console.log('✅ Email sent successfully via Resend:', result.data?.id);
    return true;
  } catch (error) {
    console.error('❌ Failed to send email:', error);
    return false;
  }
}

/**
 * Email Templates
 */

export function getPasswordResetEmail(name: string, resetUrl: string): string {
  const firstName = getFirstName(name);
  
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Reset Your Password</title>
      </head>
      <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;">
        <table role="presentation" style="width: 100%; border-collapse: collapse;">
          <tr>
            <td align="center" style="padding: 40px 0;">
              <table role="presentation" style="width: 600px; border-collapse: collapse; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <!-- Header -->
                <tr>
                  <td style="padding: 40px 40px 20px; text-align: center;">
                    <div style="background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%); color: white; padding: 12px 24px; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 20px;">
                      CDM Suite
                    </div>
                  </td>
                </tr>
                
                <!-- Content -->
                <tr>
                  <td style="padding: 0 40px 40px;">
                    <h1 style="margin: 0 0 20px; font-size: 24px; color: #111827;">Reset Your Password</h1>
                    <p style="margin: 0 0 20px; font-size: 16px; line-height: 1.5; color: #4b5563;">
                      Hi ${firstName},
                    </p>
                    <p style="margin: 0 0 20px; font-size: 16px; line-height: 1.5; color: #4b5563;">
                      We received a request to reset your password for your CDM Suite account. Click the button below to create a new password:
                    </p>
                    
                    <!-- CTA Button -->
                    <table role="presentation" style="margin: 30px 0;">
                      <tr>
                        <td style="border-radius: 6px; background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%);">
                          <a href="${resetUrl}" target="_blank" style="display: inline-block; padding: 14px 40px; color: #ffffff; text-decoration: none; font-weight: 600; font-size: 16px;">
                            Reset Password
                          </a>
                        </td>
                      </tr>
                    </table>
                    
                    <p style="margin: 0 0 20px; font-size: 14px; line-height: 1.5; color: #6b7280;">
                      Or copy and paste this link into your browser:
                    </p>
                    <p style="margin: 0 0 20px; font-size: 14px; line-height: 1.5; color: #2563eb; word-break: break-all;">
                      ${resetUrl}
                    </p>
                    
                    <p style="margin: 20px 0 0; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 14px; line-height: 1.5; color: #6b7280;">
                      This link will expire in 1 hour for security reasons.
                    </p>
                    <p style="margin: 10px 0 0; font-size: 14px; line-height: 1.5; color: #6b7280;">
                      If you didn't request a password reset, you can safely ignore this email.
                    </p>
                  </td>
                </tr>
                
                <!-- Footer -->
                <tr>
                  <td style="padding: 20px 40px; background-color: #f9fafb; border-radius: 0 0 8px 8px;">
                    <p style="margin: 0; font-size: 12px; color: #6b7280; text-align: center;">
                      © 2025 CDM Suite. All rights reserved.
                    </p>
                    <p style="margin: 10px 0 0; font-size: 12px; color: #6b7280; text-align: center;">
                      Questions? Call us at <a href="tel:+18622727623" style="color: #2563eb; text-decoration: none;">(862) 272-7623</a> or email <a href="mailto:hello@cdmsuite.com" style="color: #2563eb; text-decoration: none;">hello@cdmsuite.com</a>
                    </p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </body>
    </html>
  `;
}

/**
 * Helper function to extract first name from full name
 */
function getFirstName(fullName: string | null | undefined): string {
  if (!fullName || fullName.trim() === '') {
    return 'there';
  }
  
  // Extract first word/name before any space
  const firstName = fullName.trim().split(/\s+/)[0];
  return firstName || 'there';
}

export function getWelcomeEmail(name: string, loginUrl: string): string {
  const firstName = getFirstName(name);
  
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Welcome to CDM Suite</title>
      </head>
      <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;">
        <table role="presentation" style="width: 100%; border-collapse: collapse;">
          <tr>
            <td align="center" style="padding: 40px 0;">
              <table role="presentation" style="width: 600px; border-collapse: collapse; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <tr>
                  <td style="padding: 40px 40px 20px; text-align: center;">
                    <div style="background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%); color: white; padding: 12px 24px; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 20px;">
                      CDM Suite
                    </div>
                  </td>
                </tr>
                
                <tr>
                  <td style="padding: 0 40px 40px;">
                    <h1 style="margin: 0 0 20px; font-size: 24px; color: #111827;">Welcome to CDM Suite! 🎉</h1>
                    <p style="margin: 0 0 20px; font-size: 16px; line-height: 1.5; color: #4b5563;">
                      Hi ${firstName},
                    </p>
                    <p style="margin: 0 0 20px; font-size: 16px; line-height: 1.5; color: #4b5563;">
                      Thank you for joining CDM Suite! We're excited to help you grow your business with our digital marketing tools and services.
                    </p>
                    
                    <div style="background-color: #f0f9ff; border-left: 4px solid #2563eb; padding: 16px; margin: 20px 0;">
                      <p style="margin: 0 0 10px; font-weight: 600; color: #1e40af;">🚀 Ready to Get Started?</p>
                      <p style="margin: 0; font-size: 14px; color: #1e3a8a;">
                        Explore our powerful tools and services to grow your business.
                      </p>
                    </div>
                    
                    <table role="presentation" style="margin: 30px 0;">
                      <tr>
                        <td style="border-radius: 6px; background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%);">
                          <a href="${loginUrl}" target="_blank" style="display: inline-block; padding: 14px 40px; color: #ffffff; text-decoration: none; font-weight: 600; font-size: 16px;">
                            Get Started
                          </a>
                        </td>
                      </tr>
                    </table>
                    
                    <p style="margin: 20px 0 0; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 14px; line-height: 1.5; color: #6b7280;">
                      Need help? Our support team is here for you at <a href="mailto:hello@cdmsuite.com" style="color: #2563eb; text-decoration: none;">hello@cdmsuite.com</a>
                    </p>
                  </td>
                </tr>
                
                <tr>
                  <td style="padding: 20px 40px; background-color: #f9fafb; border-radius: 0 0 8px 8px;">
                    <p style="margin: 0; font-size: 12px; color: #6b7280; text-align: center;">
                      © 2025 CDM Suite. All rights reserved.
                    </p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </body>
    </html>
  `;
}

export function getAuditReportEmail(
  name: string,
  websiteUrl: string,
  overallScore: number,
  reportUrl: string
): string {
  const firstName = getFirstName(name);
  const scoreColor = overallScore >= 80 ? '#10b981' : overallScore >= 60 ? '#f59e0b' : '#ef4444';
  
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Your Website Audit Report</title>
      </head>
      <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;">
        <table role="presentation" style="width: 100%; border-collapse: collapse;">
          <tr>
            <td align="center" style="padding: 40px 0;">
              <table role="presentation" style="width: 600px; border-collapse: collapse; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <tr>
                  <td style="padding: 40px 40px 20px; text-align: center;">
                    <div style="background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%); color: white; padding: 12px 24px; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 20px;">
                      CDM Suite
                    </div>
                  </td>
                </tr>
                
                <tr>
                  <td style="padding: 0 40px 40px;">
                    <h1 style="margin: 0 0 20px; font-size: 24px; color: #111827;">Your Website Audit is Ready! 📊</h1>
                    <p style="margin: 0 0 20px; font-size: 16px; line-height: 1.5; color: #4b5563;">
                      Hi ${firstName},
                    </p>
                    <p style="margin: 0 0 20px; font-size: 16px; line-height: 1.5; color: #4b5563;">
                      We've completed the audit for <strong>${websiteUrl}</strong>. Here's your overall score:
                    </p>
                    
                    <div style="text-align: center; padding: 30px; background-color: #f9fafb; border-radius: 8px; margin: 20px 0;">
                      <div style="font-size: 48px; font-weight: bold; color: ${scoreColor};">
                        ${overallScore}/100
                      </div>
                      <div style="font-size: 14px; color: #6b7280; margin-top: 8px;">
                        Overall Website Score
                      </div>
                    </div>
                    
                    <table role="presentation" style="margin: 30px 0;">
                      <tr>
                        <td style="border-radius: 6px; background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%);">
                          <a href="${reportUrl}" target="_blank" style="display: inline-block; padding: 14px 40px; color: #ffffff; text-decoration: none; font-weight: 600; font-size: 16px;">
                            View Full Report
                          </a>
                        </td>
                      </tr>
                    </table>
                    
                    <p style="margin: 20px 0 0; padding-top: 20px; border-top: 1px solid #e5e7eb; font-size: 14px; line-height: 1.5; color: #6b7280;">
                      Want to improve your score? Our team can help optimize your website for better performance, SEO, and user experience.
                    </p>
                  </td>
                </tr>
                
                <tr>
                  <td style="padding: 20px 40px; background-color: #f9fafb; border-radius: 0 0 8px 8px;">
                    <p style="margin: 0; font-size: 12px; color: #6b7280; text-align: center;">
                      © 2025 CDM Suite. All rights reserved.
                    </p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </body>
    </html>
  `;
}

// Additional email helper functions for existing features
export async function sendWelcomeEmail(data: { 
  email: string; 
  name: string; 
  tier?: string;
  isFromAudit?: boolean;
  auditScore?: number;
  temporaryPassword?: string;
}, token?: string): Promise<boolean> {
  const loginUrl = `${process.env.NEXTAUTH_URL || 'https://cdmsuite.abacusai.app'}/auth/login`;
  let html = getWelcomeEmail(data.name, loginUrl);
  
  // If from audit, include additional info
  if (data.isFromAudit && data.temporaryPassword) {
    const firstName = getFirstName(data.name);
    html = `
      <h2>Welcome to CDM Suite!</h2>
      <p>Hi ${firstName},</p>
      <p>Thank you for completing your website audit! Your audit score: <strong>${data.auditScore}/100</strong></p>
      <p>We've created an account for you to access your full report and recommendations.</p>
      <p><strong>Login Credentials:</strong></p>
      <p>Email: ${data.email}<br>Temporary Password: <code>${data.temporaryPassword}</code></p>
      <p><a href="${loginUrl}">Login to your dashboard</a></p>
      <p><strong>Important:</strong> Please change your password after logging in.</p>
      <p>Best regards,<br>The CDM Suite Team</p>
    `;
  }
  
  return sendEmail({
    to: data.email,
    subject: "Welcome to CDM Suite!",
    html,
  });
}

export async function sendContactNotification(data: any, extras?: any): Promise<boolean> {
  // Send notification to admin about new contact
  return sendEmail({
    to: process.env.ADMIN_EMAIL || "hello@cdmsuite.com",
    subject: `New Contact Form Submission from ${data.name}`,
    html: `
      <h2>New Contact Form Submission</h2>
      <p><strong>Name:</strong> ${data.name}</p>
      <p><strong>Email:</strong> ${data.email}</p>
      <p><strong>Phone:</strong> ${data.phone || 'Not provided'}</p>
      <p><strong>Company:</strong> ${data.company || 'Not provided'}</p>
      <p><strong>Message:</strong></p>
      <p>${data.message}</p>
    `,
  });
}

export async function sendContactConfirmation(data: any, extras?: any): Promise<boolean> {
  // Send confirmation email to user
  const firstName = getFirstName(data.name);
  return sendEmail({
    to: data.email,
    subject: "We received your message - CDM Suite",
    html: `
      <h2>Thank you for contacting us!</h2>
      <p>Hi ${firstName},</p>
      <p>We've received your message and will get back to you shortly.</p>
      <p>Best regards,<br>The CDM Suite Team</p>
    `,
  });
}

export async function sendLeadNotification(data: any, extras?: any): Promise<boolean> {
  // Send notification to admin about new lead
  return sendEmail({
    to: process.env.ADMIN_EMAIL || "hello@cdmsuite.com",
    subject: `New Lead: ${data.email}`,
    html: `
      <h2>New Lead Captured</h2>
      <p><strong>Email:</strong> ${data.email}</p>
      <p><strong>Name:</strong> ${data.name || 'Not provided'}</p>
      <p><strong>Source:</strong> ${data.source}</p>
      <p><strong>Interest:</strong> ${data.interest || 'Not specified'}</p>
    `,
  });
}

export async function sendLeadWelcome(data: any, extras?: any): Promise<boolean> {
  // Send welcome email to lead
  const firstName = getFirstName(data.name);
  return sendEmail({
    to: data.email,
    subject: "Welcome! Let's grow your business - CDM Suite",
    html: `
      <h2>Welcome to CDM Suite!</h2>
      <p>Hi ${firstName},</p>
      <p>Thank you for your interest in CDM Suite. We're here to help you grow your business.</p>
      <p>Our team will reach out to you shortly to discuss how we can help.</p>
      <p>Best regards,<br>The CDM Suite Team</p>
    `,
  });
}

export async function sendAssessmentResults(data: { email: string; name: string; score: number; recommendations?: any }): Promise<boolean> {
  const firstName = getFirstName(data.name);
  const reportUrl = `${process.env.NEXTAUTH_URL || 'https://cdmsuite.abacusai.app'}/dashboard/analytics`;
  return sendEmail({
    to: data.email,
    subject: "Your Marketing Assessment Results - CDM Suite",
    html: `
      <h2>Your Marketing Assessment Results</h2>
      <p>Hi ${firstName},</p>
      <p>Thank you for completing the marketing assessment!</p>
      <p><strong>Your Score: ${data.score}/100</strong></p>
      <p><a href="${reportUrl}">View your dashboard</a></p>
      <p>Based on your results, we have personalized recommendations to help improve your marketing strategy.</p>
      <p>Best regards,<br>The CDM Suite Team</p>
    `,
  });
}

/**
 * Send signup notification to admin
 */
export async function sendSignupNotification(data: { 
  email: string; 
  name: string; 
  tier: string;
  company?: string;
  phone?: string;
  referralCode?: string;
}): Promise<boolean> {
  const adminEmail = process.env.ADMIN_EMAIL || "hello@cdmsuite.com";
  const dashboardUrl = `${process.env.NEXTAUTH_URL || 'https://cdmsuite.com'}/admin`;
  
  return sendEmail({
    to: adminEmail,
    subject: `🎉 New Signup: ${data.name} (${data.tier} tier)`,
    html: `
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>New Signup Notification</title>
        </head>
        <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;">
          <table role="presentation" style="width: 100%; border-collapse: collapse;">
            <tr>
              <td align="center" style="padding: 40px 0;">
                <table role="presentation" style="width: 600px; max-width: 100%; border-collapse: collapse; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                  <!-- Header -->
                  <tr>
                    <td style="padding: 40px 40px 20px; text-align: center;">
                      <div style="background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%); color: white; padding: 12px 24px; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 20px;">
                        CDM Suite
                      </div>
                    </td>
                  </tr>
                  
                  <!-- Success Icon -->
                  <tr>
                    <td style="padding: 0 40px; text-align: center;">
                      <div style="background-color: #dcfce7; border-radius: 50%; width: 80px; height: 80px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 40px;">🎉</span>
                      </div>
                      <h1 style="margin: 0 0 10px; font-size: 28px; color: #111827;">New User Signup!</h1>
                      <p style="margin: 0 0 30px; font-size: 16px; color: #6b7280;">
                        A new user has registered for CDM Suite
                      </p>
                    </td>
                  </tr>
                  
                  <!-- User Details -->
                  <tr>
                    <td style="padding: 0 40px 30px;">
                      <div style="background-color: #f9fafb; border-radius: 8px; padding: 25px;">
                        <h2 style="margin: 0 0 20px; font-size: 18px; color: #111827; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                          User Information
                        </h2>
                        
                        <table style="width: 100%; border-collapse: collapse;">
                          <tr>
                            <td style="padding: 10px 0; color: #6b7280; font-size: 14px; width: 40%;">Name:</td>
                            <td style="padding: 10px 0; color: #111827; font-weight: 600;">${data.name || 'Not provided'}</td>
                          </tr>
                          <tr>
                            <td style="padding: 10px 0; color: #6b7280; font-size: 14px;">Email:</td>
                            <td style="padding: 10px 0; color: #111827; font-weight: 600;">
                              <a href="mailto:${data.email}" style="color: #2563eb; text-decoration: none;">${data.email}</a>
                            </td>
                          </tr>
                          ${data.phone ? `
                          <tr>
                            <td style="padding: 10px 0; color: #6b7280; font-size: 14px;">Phone:</td>
                            <td style="padding: 10px 0; color: #111827; font-weight: 600;">
                              <a href="tel:${data.phone}" style="color: #2563eb; text-decoration: none;">${data.phone}</a>
                            </td>
                          </tr>
                          ` : ''}
                          ${data.company ? `
                          <tr>
                            <td style="padding: 10px 0; color: #6b7280; font-size: 14px;">Company:</td>
                            <td style="padding: 10px 0; color: #111827; font-weight: 600;">${data.company}</td>
                          </tr>
                          ` : ''}
                          <tr>
                            <td style="padding: 10px 0; color: #6b7280; font-size: 14px;">Tier:</td>
                            <td style="padding: 10px 0;">
                              <span style="background-color: ${
                                data.tier === 'enterprise' ? '#dcfce7' :
                                data.tier === 'pro' ? '#dbeafe' :
                                data.tier === 'starter' ? '#fef3c7' :
                                '#f3f4f6'
                              }; color: ${
                                data.tier === 'enterprise' ? '#166534' :
                                data.tier === 'pro' ? '#1e40af' :
                                data.tier === 'starter' ? '#92400e' :
                                '#374151'
                              }; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                                ${data.tier}
                              </span>
                            </td>
                          </tr>
                          ${data.referralCode ? `
                          <tr>
                            <td style="padding: 10px 0; color: #6b7280; font-size: 14px;">Referral Code:</td>
                            <td style="padding: 10px 0; color: #111827; font-weight: 600; font-family: monospace; background-color: #fef3c7; padding: 4px 8px; border-radius: 4px;">
                              ${data.referralCode}
                            </td>
                          </tr>
                          ` : ''}
                          <tr>
                            <td style="padding: 10px 0; color: #6b7280; font-size: 14px;">Signup Time:</td>
                            <td style="padding: 10px 0; color: #111827; font-weight: 600;">${new Date().toLocaleString('en-US', { timeZone: 'America/New_York' })} EST</td>
                          </tr>
                        </table>
                      </div>
                      
                      ${data.tier === 'starter' ? `
                      <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 8px; padding: 20px; margin-top: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #92400e; font-weight: 600;">
                          ⏰ Trial Period Active
                        </p>
                        <p style="margin: 5px 0 0; font-size: 13px; color: #92400e;">
                          This user has a 7-day trial period. Follow up before expiration.
                        </p>
                      </div>
                      ` : ''}
                      
                      <div style="text-align: center; margin-top: 30px;">
                        <a href="${dashboardUrl}" 
                           style="display: inline-block; background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%); color: white; padding: 14px 32px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 16px;">
                          View in Admin Dashboard
                        </a>
                      </div>
                    </td>
                  </tr>
                  
                  <!-- Action Items -->
                  <tr>
                    <td style="padding: 20px 40px;">
                      <div style="background-color: #f0f9ff; border-left: 4px solid #2563eb; padding: 20px; border-radius: 4px;">
                        <h3 style="margin: 0 0 15px; font-size: 16px; color: #1e40af;">📋 Recommended Next Steps</h3>
                        <ul style="margin: 0; padding-left: 20px; color: #1e3a8a; line-height: 1.8; font-size: 14px;">
                          <li>Send a personalized welcome email or call</li>
                          <li>Schedule an onboarding call if appropriate</li>
                          <li>Review their account and credit allocation</li>
                          <li>Monitor for first project creation</li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                  
                  <!-- Footer -->
                  <tr>
                    <td style="padding: 20px 40px; background-color: #f9fafb; border-radius: 0 0 8px 8px;">
                      <p style="margin: 0; font-size: 12px; color: #6b7280; text-align: center;">
                        This is an automated notification from CDM Suite
                      </p>
                      <p style="margin: 10px 0 0; font-size: 12px; color: #6b7280; text-align: center;">
                        © 2025 CDM Suite. All rights reserved.
                      </p>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </body>
      </html>
    `,
    tags: [
      { name: 'category', value: 'admin_notification' },
      { name: 'type', value: 'new_signup' },
      { name: 'tier', value: data.tier },
    ],
  });
}

/**
 * HTML Email Template Generator for Tool Results
 */
export function getToolResultsEmail(toolName: string, name: string, email: string, results: any, tripwireOffer: any): string {
  const scoreColor = results.score >= 80 ? '#10b981' : results.score >= 60 ? '#f59e0b' : '#ef4444';
  const baseUrl = process.env.NEXTAUTH_URL || 'https://cdmsuite.abacusai.app';
  
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Your ${toolName} Results</title>
      </head>
      <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;">
        <table role="presentation" style="width: 100%; border-collapse: collapse;">
          <tr>
            <td align="center" style="padding: 40px 0;">
              <table role="presentation" style="width: 600px; max-width: 100%; border-collapse: collapse; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <!-- Header -->
                <tr>
                  <td style="padding: 40px 40px 20px; text-align: center;">
                    <div style="background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%); color: white; padding: 12px 24px; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 20px;">
                      CDM Suite
                    </div>
                  </td>
                </tr>
                
                <!-- Score Section -->
                <tr>
                  <td style="padding: 0 40px;">
                    <h1 style="margin: 0 0 20px; font-size: 24px; color: #111827; text-align: center;">Your ${toolName} Results Are Ready! 🎯</h1>
                    <p style="margin: 0 0 20px; font-size: 16px; line-height: 1.5; color: #4b5563;">
                      Hi ${name},
                    </p>
                    
                    <div style="text-align: center; padding: 30px; background-color: #f9fafb; border-radius: 8px; margin: 20px 0;">
                      <div style="font-size: 48px; font-weight: bold; color: ${scoreColor};">
                        ${results.score || results.overallScore || 'N/A'}/100
                      </div>
                      <div style="font-size: 14px; color: #6b7280; margin-top: 8px;">
                        ${results.score < 70 ? '⚠️ Your website needs immediate attention!' : results.score < 85 ? '✅ Good start, but there\'s room for improvement!' : '🎉 Excellent! You\'re doing great!'}
                      </div>
                    </div>
                  </td>
                </tr>
                
                <!-- Details Section -->
                <tr>
                  <td style="padding: 20px 40px;">
                    <h3 style="margin: 0 0 15px; font-size: 18px; color: #111827;">📊 Key Findings</h3>
                    ${generateDetailsHTML(toolName, results)}
                  </td>
                </tr>
                
                <!-- Special Offer Section -->
                ${tripwireOffer ? `
                <tr>
                  <td style="padding: 0 40px 30px;">
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 8px; padding: 30px; margin: 20px 0;">
                      <div style="text-align: center; margin-bottom: 20px;">
                        <span style="background-color: #dc2626; color: white; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                          ${tripwireOffer.urgency || 'LIMITED TIME OFFER'}
                        </span>
                      </div>
                      
                      <h2 style="margin: 0 0 15px; font-size: 24px; color: #111827; text-align: center;">
                        🎁 ${tripwireOffer.title}
                      </h2>
                      
                      <div style="text-align: center; margin: 20px 0;">
                        <span style="font-size: 32px; font-weight: bold; color: #2563eb;">
                          $${tripwireOffer.discountPrice}
                        </span>
                        <span style="font-size: 20px; color: #6b7280; text-decoration: line-through; margin-left: 10px;">
                          $${tripwireOffer.originalPrice}
                        </span>
                        <div style="color: #059669; font-weight: 600; margin-top: 5px;">
                          Save $${tripwireOffer.savings}!
                        </div>
                      </div>
                      
                      <div style="background-color: white; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <ul style="margin: 0; padding-left: 20px; color: #374151;">
                          ${tripwireOffer.features.map((f: string) => `<li style="margin-bottom: 8px;">${f}</li>`).join('')}
                        </ul>
                      </div>
                      
                      <div style="text-align: center; margin-top: 25px;">
                        <a href="${baseUrl}/api/create-tripwire-checkout?offer=${encodeURIComponent(tripwireOffer.offerName)}&email=${encodeURIComponent(email)}" 
                           style="display: inline-block; background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%); color: white; padding: 16px 40px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 18px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                          ${tripwireOffer.cta}
                        </a>
                      </div>
                      
                      <p style="text-align: center; font-size: 12px; color: #6b7280; margin: 15px 0 0;">
                        ⚡ This exclusive offer expires in 48 hours
                      </p>
                    </div>
                  </td>
                </tr>
                ` : ''}
                
                <!-- CTA Section -->
                <tr>
                  <td style="padding: 20px 40px;">
                    <p style="margin: 0; font-size: 14px; line-height: 1.5; color: #6b7280; text-align: center;">
                      Questions about your results or our services?<br>
                      Call us at <a href="tel:+18622727623" style="color: #2563eb; text-decoration: none; font-weight: 600;">(862) 272-7623</a>
                    </p>
                  </td>
                </tr>
                
                <!-- Footer -->
                <tr>
                  <td style="padding: 20px 40px; background-color: #f9fafb; border-radius: 0 0 8px 8px;">
                    <p style="margin: 0; font-size: 12px; color: #6b7280; text-align: center;">
                      © 2025 CDM Suite. All rights reserved.
                    </p>
                    <p style="margin: 10px 0 0; font-size: 12px; color: #6b7280; text-align: center;">
                      Reply to: <a href="mailto:hello@cdmsuite.com" style="color: #2563eb; text-decoration: none;">hello@cdmsuite.com</a>
                    </p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </body>
    </html>
  `;
}

function generateDetailsHTML(toolName: string, results: any): string {
  // Generate tool-specific details based on results
  if (toolName.toLowerCase().includes('seo')) {
    return `
      <div style="background-color: #f9fafb; border-left: 4px solid #2563eb; padding: 15px; margin-bottom: 15px;">
        <p style="margin: 0 0 10px; font-weight: 600; color: #1e40af;">Title Tag:</p>
        <p style="margin: 0; font-size: 14px; color: #4b5563;">${results.titleTag?.status || 'Check your title tag optimization'}</p>
      </div>
      <div style="background-color: #f9fafb; border-left: 4px solid #2563eb; padding: 15px; margin-bottom: 15px;">
        <p style="margin: 0 0 10px; font-weight: 600; color: #1e40af;">Meta Description:</p>
        <p style="margin: 0; font-size: 14px; color: #4b5563;">${results.metaDescription?.status || 'Optimize your meta description'}</p>
      </div>
      ${results.issues && results.issues.length > 0 ? `
      <div style="background-color: #fef2f2; border-left: 4px solid #dc2626; padding: 15px; margin-bottom: 15px;">
        <p style="margin: 0 0 10px; font-weight: 600; color: #991b1b;">🚨 Critical Issues:</p>
        <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #4b5563;">
          ${results.issues.slice(0, 3).map((issue: string) => `<li>${issue}</li>`).join('')}
        </ul>
      </div>
      ` : ''}
    `;
  }
  
  // Generic details for other tools
  return `
    <div style="background-color: #f9fafb; padding: 15px; border-radius: 6px;">
      <p style="margin: 0; font-size: 14px; color: #4b5563; line-height: 1.6;">
        ${results.summary || 'We\'ve analyzed your data and identified key opportunities for improvement.'}
      </p>
    </div>
  `;
}

/**
 * Order Confirmation Email with Login Details
 */
export function getOrderConfirmationEmail(data: {
  customerName: string;
  customerEmail: string;
  serviceName: string;
  amount: number;
  orderId: string;
  isNewUser?: boolean;
  temporaryPassword?: string;
}): string {
  const baseUrl = process.env.NEXTAUTH_URL || 'https://cdmsuite.abacusai.app';
  
  return `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Order Confirmation - CDM Suite</title>
      </head>
      <body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;">
        <table role="presentation" style="width: 100%; border-collapse: collapse;">
          <tr>
            <td align="center" style="padding: 40px 0;">
              <table role="presentation" style="width: 600px; max-width: 100%; border-collapse: collapse; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <!-- Header -->
                <tr>
                  <td style="padding: 40px 40px 20px; text-align: center;">
                    <div style="background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%); color: white; padding: 12px 24px; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 20px;">
                      CDM Suite
                    </div>
                  </td>
                </tr>
                
                <!-- Success Icon -->
                <tr>
                  <td style="padding: 0 40px; text-align: center;">
                    <div style="background-color: #dcfce7; border-radius: 50%; width: 80px; height: 80px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                      <span style="font-size: 40px;">✓</span>
                    </div>
                    <h1 style="margin: 0 0 10px; font-size: 28px; color: #111827;">Order Confirmed!</h1>
                    <p style="margin: 0 0 30px; font-size: 16px; color: #6b7280;">
                      Thank you for your purchase, ${data.customerName}!
                    </p>
                  </td>
                </tr>
                
                <!-- Order Details -->
                <tr>
                  <td style="padding: 0 40px 30px;">
                    <div style="background-color: #f9fafb; border-radius: 8px; padding: 25px; margin-bottom: 30px;">
                      <h2 style="margin: 0 0 20px; font-size: 18px; color: #111827; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                        Order Summary
                      </h2>
                      
                      <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                          <td style="padding: 10px 0; color: #6b7280; font-size: 14px;">Service:</td>
                          <td style="padding: 10px 0; color: #111827; font-weight: 600; text-align: right;">${data.serviceName}</td>
                        </tr>
                        <tr>
                          <td style="padding: 10px 0; color: #6b7280; font-size: 14px;">Amount:</td>
                          <td style="padding: 10px 0; color: #111827; font-weight: 600; text-align: right; font-size: 20px; color: #2563eb;">$${data.amount.toFixed(2)}</td>
                        </tr>
                        <tr>
                          <td style="padding: 10px 0; color: #6b7280; font-size: 14px;">Order ID:</td>
                          <td style="padding: 10px 0; color: #6b7280; font-family: monospace; font-size: 12px; text-align: right;">${data.orderId}</td>
                        </tr>
                        <tr>
                          <td style="padding: 10px 0; color: #6b7280; font-size: 14px;">Email:</td>
                          <td style="padding: 10px 0; color: #111827; text-align: right;">${data.customerEmail}</td>
                        </tr>
                      </table>
                    </div>
                    
                    ${data.isNewUser && data.temporaryPassword ? `
                    <!-- Login Credentials -->
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%); border: 2px solid #2563eb; border-radius: 8px; padding: 25px; margin-bottom: 30px;">
                      <h2 style="margin: 0 0 15px; font-size: 18px; color: #1e40af;">
                        🔐 Your Dashboard Access
                      </h2>
                      <p style="margin: 0 0 15px; font-size: 14px; color: #1e3a8a;">
                        We've created your account! Use these credentials to access your dashboard:
                      </p>
                      
                      <div style="background-color: white; border-radius: 6px; padding: 15px; margin: 15px 0;">
                        <p style="margin: 0 0 10px; font-size: 14px; color: #6b7280;">Email:</p>
                        <p style="margin: 0 0 15px; font-size: 16px; font-weight: 600; color: #111827;">${data.customerEmail}</p>
                        
                        <p style="margin: 0 0 10px; font-size: 14px; color: #6b7280;">Temporary Password:</p>
                        <p style="margin: 0; font-size: 16px; font-family: monospace; font-weight: 600; color: #111827; background-color: #f9fafb; padding: 10px; border-radius: 4px;">
                          ${data.temporaryPassword}
                        </p>
                      </div>
                      
                      <p style="margin: 15px 0 0; font-size: 12px; color: #1e3a8a;">
                        ⚠️ Please change your password after your first login for security.
                      </p>
                      
                      <div style="text-align: center; margin-top: 20px;">
                        <a href="${baseUrl}/auth/login" 
                           style="display: inline-block; background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%); color: white; padding: 14px 32px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 16px;">
                          Access Your Dashboard →
                        </a>
                      </div>
                    </div>
                    ` : `
                    <div style="text-align: center; margin-bottom: 30px;">
                      <a href="${baseUrl}/dashboard/my-services" 
                         style="display: inline-block; background: linear-gradient(135deg, #2563eb 0%, #9333ea 100%); color: white; padding: 14px 32px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 16px;">
                        View Your Services →
                      </a>
                    </div>
                    `}
                    
                    <!-- What's Next -->
                    <div style="background-color: #f0f9ff; border-left: 4px solid #2563eb; padding: 20px; border-radius: 4px;">
                      <h3 style="margin: 0 0 15px; font-size: 16px; color: #1e40af;">📋 What Happens Next?</h3>
                      <ul style="margin: 0; padding-left: 20px; color: #1e3a8a; line-height: 1.8;">
                        <li>Our team will reach out within 24 hours</li>
                        <li>We'll schedule a kickoff call to discuss your project</li>
                        <li>You'll receive regular updates on progress</li>
                        <li>Track everything in your dashboard</li>
                      </ul>
                    </div>
                  </td>
                </tr>
                
                <!-- Contact Section -->
                <tr>
                  <td style="padding: 20px 40px; border-top: 1px solid #e5e7eb;">
                    <p style="margin: 0 0 15px; font-size: 14px; color: #6b7280; text-align: center;">
                      Have questions? We're here to help!
                    </p>
                    <div style="text-align: center;">
                      <a href="tel:+18622727623" style="color: #2563eb; text-decoration: none; font-weight: 600; margin-right: 20px;">
                        📞 (862) 272-7623
                      </a>
                      <a href="mailto:hello@cdmsuite.com" style="color: #2563eb; text-decoration: none; font-weight: 600;">
                        ✉️ hello@cdmsuite.com
                      </a>
                    </div>
                  </td>
                </tr>
                
                <!-- Footer -->
                <tr>
                  <td style="padding: 20px 40px; background-color: #f9fafb; border-radius: 0 0 8px 8px;">
                    <p style="margin: 0; font-size: 12px; color: #6b7280; text-align: center;">
                      © 2025 CDM Suite. All rights reserved.
                    </p>
                    <p style="margin: 10px 0 0; font-size: 12px; color: #6b7280; text-align: center;">
                      This is an automated receipt for your purchase.
                    </p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </body>
    </html>
  `;
}

// ==========================================
// File: lib/error-logger.ts
// ==========================================


// Comprehensive error logging utility for CDM Suite
import { prisma } from '@/lib/db';

export interface ErrorLog {
  level: 'error' | 'warning' | 'info';
  message: string;
  stack?: string;
  context?: any;
  userId?: string;
  endpoint?: string;
  userEmail?: string;
}

// Error codes for common issues
export const ERROR_CODES = {
  // Authentication errors
  UNAUTHORIZED: 'UNAUTHORIZED',
  INVALID_TOKEN: 'INVALID_TOKEN',
  SESSION_EXPIRED: 'SESSION_EXPIRED',
  
  // Permission errors
  FORBIDDEN: 'FORBIDDEN',
  INSUFFICIENT_PERMISSIONS: 'INSUFFICIENT_PERMISSIONS',
  
  // Validation errors
  VALIDATION_FAILED: 'VALIDATION_FAILED',
  MISSING_REQUIRED_FIELD: 'MISSING_REQUIRED_FIELD',
  INVALID_FORMAT: 'INVALID_FORMAT',
  DUPLICATE_ENTRY: 'DUPLICATE_ENTRY',
  
  // Database errors
  DATABASE_ERROR: 'DATABASE_ERROR',
  RECORD_NOT_FOUND: 'RECORD_NOT_FOUND',
  
  // Business logic errors
  SEQUENCE_NO_STEPS: 'SEQUENCE_NO_STEPS',
  LEAD_ALREADY_IN_SEQUENCE: 'LEAD_ALREADY_IN_SEQUENCE',
  INVALID_STATUS_TRANSITION: 'INVALID_STATUS_TRANSITION',
} as const;

/**
 * Log an error to the database
 */
export async function logError(log: ErrorLog): Promise<void> {
  try {
    // For now, just log to console
    // In production, you'd want to save to a database table or external service
    const timestamp = new Date().toISOString();
    console.error(`[${timestamp}] [${log.level.toUpperCase()}] ${log.endpoint || 'Unknown'}:`, {
      message: log.message,
      userId: log.userId,
      userEmail: log.userEmail,
      stack: log.stack,
      context: log.context,
    });
    
    // TODO: Implement database logging
    // await prisma.errorLog.create({
    //   data: {
    //     level: log.level,
    //     message: log.message,
    //     stack: log.stack,
    //     context: log.context ? JSON.stringify(log.context) : null,
    //     userId: log.userId,
    //     endpoint: log.endpoint,
    //     userEmail: log.userEmail,
    //   },
    // });
  } catch (error) {
    // Fallback to console if logging fails
    console.error('Failed to log error:', error);
    console.error('Original error:', log);
  }
}

/**
 * Create an error handler for a specific endpoint
 */
export function createErrorHandler(endpoint: string) {
  return async (error: any, userId?: string, userEmail?: string) => {
    await logError({
      level: 'error',
      message: error.message || 'Unknown error',
      stack: error.stack,
      context: {
        name: error.name,
        code: error.code,
      },
      userId,
      userEmail,
      endpoint,
    });
  };
}

/**
 * Create a standardized API error response
 */
export class APIError extends Error {
  constructor(
    message: string,
    public statusCode: number = 500,
    public code?: string,
    public details?: any
  ) {
    super(message);
    this.name = 'APIError';
  }
  
  toJSON() {
    return {
      error: this.code || 'ERROR',
      message: this.message,
      details: this.details,
    };
  }
}

/**
 * Wrap an API handler with error logging
 */
export function withErrorLogging<T extends (...args: any[]) => Promise<any>>(
  handler: T,
  endpoint: string
): T {
  return (async (...args: any[]) => {
    try {
      return await handler(...args);
    } catch (error: any) {
      const errorLogger = createErrorHandler(endpoint);
      await errorLogger(error);
      throw error;
    }
  }) as T;
}


// ==========================================
// File: lib/json-helper.ts
// ==========================================


/**
 * Safely parses a JSON string into a typed value.
 * If parsing fails or the input is null/undefined, returns the fallback value.
 */
export function safeJSONParse<T>(value: string | null | undefined, fallback: T): T {
    if (!value) return fallback;
    try {
        return JSON.parse(value) as T;
    } catch (e) {
        console.error('Failed to parse JSON:', value, e);
        return fallback;
    }
}

/**
 * Safely stringifies a value for storage.
 * If the value is null/undefined, returns an empty JSON array string "[]" by default.
 */
export function safeJSONStringify(value: any, fallback: string = "[]"): string {
    if (value === null || value === undefined) return fallback;
    try {
        return JSON.stringify(value);
    } catch (e) {
        console.error('Failed to stringify JSON:', value, e);
        return fallback;
    }
}

// ==========================================
// File: lib/page-builder-types.ts
// ==========================================


// Type definitions for the page builder

export interface PageBlock {
  id: string;
  type: BlockType;
  props: BlockProps;
  children?: PageBlock[];
}

export type BlockType =
  | 'container'
  | 'heading'
  | 'text'
  | 'button'
  | 'image'
  | 'spacer'
  | 'columns'
  | 'hero'
  | 'features'
  | 'cta'
  | 'testimonial'
  | 'pricing'
  | 'form'
  | 'video';

export interface BlockProps {
  // Common props
  className?: string;
  style?: React.CSSProperties;
  margin?: string;
  padding?: string;
  backgroundColor?: string;
  
  // Type-specific props
  [key: string]: any;
}

export interface HeadingProps extends BlockProps {
  text: string;
  level: 1 | 2 | 3 | 4 | 5 | 6;
  align?: 'left' | 'center' | 'right';
  color?: string;
}

export interface TextProps extends BlockProps {
  content: string;
  align?: 'left' | 'center' | 'right';
  color?: string;
  fontSize?: string;
}

export interface ButtonProps extends BlockProps {
  text: string;
  href?: string;
  variant?: 'primary' | 'secondary' | 'outline';
  size?: 'sm' | 'md' | 'lg';
  onClick?: string; // JavaScript code
}

export interface ImageProps extends BlockProps {
  src: string;
  alt: string;
  width?: string;
  height?: string;
  objectFit?: 'cover' | 'contain' | 'fill';
  rounded?: boolean;
}

export interface SpacerProps extends BlockProps {
  height: string;
}

export interface ColumnsProps extends BlockProps {
  columns: number;
  gap?: string;
}

export interface HeroProps extends BlockProps {
  title: string;
  subtitle?: string;
  buttonText?: string;
  buttonHref?: string;
  backgroundImage?: string;
  overlay?: boolean;
  overlayOpacity?: number;
}

export interface FeaturesProps extends BlockProps {
  title?: string;
  features: Array<{
    icon?: string;
    title: string;
    description: string;
  }>;
}

export interface CTAProps extends BlockProps {
  title: string;
  description?: string;
  buttonText: string;
  buttonHref: string;
  variant?: 'primary' | 'secondary';
}

export interface TestimonialProps extends BlockProps {
  quote: string;
  author: string;
  role?: string;
  image?: string;
}

export interface PricingProps extends BlockProps {
  tiers: Array<{
    name: string;
    price: string;
    period?: string;
    features: string[];
    buttonText: string;
    buttonHref: string;
    highlighted?: boolean;
  }>;
}

export interface FormProps extends BlockProps {
  title?: string;
  fields: Array<{
    name: string;
    label: string;
    type: 'text' | 'email' | 'tel' | 'textarea' | 'select';
    required?: boolean;
    options?: string[]; // For select fields
  }>;
  submitText: string;
  submitEndpoint: string;
}

export interface VideoProps extends BlockProps {
  src: string;
  autoplay?: boolean;
  controls?: boolean;
  loop?: boolean;
  muted?: boolean;
}

export interface PageSettings {
  maxWidth?: string;
  backgroundColor?: string;
  fontFamily?: string;
  primaryColor?: string;
  secondaryColor?: string;
}

export interface CustomPage {
  id: string;
  title: string;
  slug: string;
  description?: string;
  content: PageBlock[];
  settings?: PageSettings;
  metaTitle?: string;
  metaDescription?: string;
  metaKeywords?: string[];
  ogImage?: string;
  status: 'draft' | 'published' | 'archived';
  publishedAt?: Date;
  views: number;
  requiresAuth: boolean;
  allowedRoles: string[];
  isTemplate: boolean;
  createdById: string;
  lastEditedById?: string;
  createdAt: Date;
  updatedAt: Date;
}

// ==========================================
// File: lib/page-builder-utils.ts
// ==========================================


// Utility functions for the page builder

import { PageBlock, BlockType } from './page-builder-types';

export function generateBlockId(): string {
  return `block_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

export function createBlock(type: BlockType, props: any = {}): PageBlock {
  return {
    id: generateBlockId(),
    type,
    props: getDefaultProps(type, props),
    children: ['container', 'columns'].includes(type) ? [] : undefined,
  };
}

export function getDefaultProps(type: BlockType, customProps: any = {}): any {
  const defaults: Record<BlockType, any> = {
    container: {
      padding: '2rem',
      backgroundColor: 'transparent',
    },
    heading: {
      text: 'New Heading',
      level: 2,
      align: 'left',
      color: '#000000',
    },
    text: {
      content: 'Add your text here...',
      align: 'left',
      color: '#333333',
      fontSize: '1rem',
    },
    button: {
      text: 'Click Me',
      href: '#',
      variant: 'primary',
      size: 'md',
    },
    image: {
      src: '/placeholder.png',
      alt: 'Image',
      width: '100%',
      height: 'auto',
      objectFit: 'cover',
      rounded: false,
    },
    spacer: {
      height: '2rem',
    },
    columns: {
      columns: 2,
      gap: '2rem',
    },
    hero: {
      title: 'Welcome to Our Site',
      subtitle: 'Discover amazing features and services',
      buttonText: 'Get Started',
      buttonHref: '#',
      overlay: true,
      overlayOpacity: 0.5,
    },
    features: {
      title: 'Our Features',
      features: [
        {
          icon: '🚀',
          title: 'Fast',
          description: 'Lightning fast performance',
        },
        {
          icon: '🎨',
          title: 'Beautiful',
          description: 'Stunning visual design',
        },
        {
          icon: '🔒',
          title: 'Secure',
          description: 'Enterprise-grade security',
        },
      ],
    },
    cta: {
      title: 'Ready to get started?',
      description: 'Join thousands of satisfied customers today',
      buttonText: 'Sign Up Now',
      buttonHref: '#',
      variant: 'primary',
    },
    testimonial: {
      quote: 'This is an amazing product! Highly recommended.',
      author: 'John Doe',
      role: 'CEO, Company Inc',
    },
    pricing: {
      tiers: [
        {
          name: 'Basic',
          price: '$9',
          period: 'per month',
          features: ['Feature 1', 'Feature 2', 'Feature 3'],
          buttonText: 'Get Started',
          buttonHref: '#',
        },
        {
          name: 'Pro',
          price: '$29',
          period: 'per month',
          features: ['All Basic features', 'Feature 4', 'Feature 5', 'Feature 6'],
          buttonText: 'Get Started',
          buttonHref: '#',
          highlighted: true,
        },
      ],
    },
    form: {
      title: 'Contact Us',
      fields: [
        { name: 'name', label: 'Name', type: 'text', required: true },
        { name: 'email', label: 'Email', type: 'email', required: true },
        { name: 'message', label: 'Message', type: 'textarea', required: true },
      ],
      submitText: 'Send Message',
      submitEndpoint: '/api/contact',
    },
    video: {
      src: '',
      autoplay: false,
      controls: true,
      loop: false,
      muted: false,
    },
  };

  return { ...defaults[type], ...customProps };
}

export function findBlockById(blocks: PageBlock[], id: string): PageBlock | null {
  for (const block of blocks) {
    if (block.id === id) return block;
    if (block.children) {
      const found = findBlockById(block.children, id);
      if (found) return found;
    }
  }
  return null;
}

export function updateBlock(
  blocks: PageBlock[],
  id: string,
  updates: Partial<PageBlock>
): PageBlock[] {
  return blocks.map((block) => {
    if (block.id === id) {
      return { ...block, ...updates };
    }
    if (block.children) {
      return {
        ...block,
        children: updateBlock(block.children, id, updates),
      };
    }
    return block;
  });
}

export function deleteBlock(blocks: PageBlock[], id: string): PageBlock[] {
  return blocks
    .filter((block) => block.id !== id)
    .map((block) => {
      if (block.children) {
        return {
          ...block,
          children: deleteBlock(block.children, id),
        };
      }
      return block;
    });
}

export function duplicateBlock(block: PageBlock): PageBlock {
  const newBlock = {
    ...block,
    id: generateBlockId(),
  };

  if (newBlock.children) {
    newBlock.children = newBlock.children.map(duplicateBlock);
  }

  return newBlock;
}

export function moveBlock(
  blocks: PageBlock[],
  dragId: string,
  targetId: string,
  position: 'before' | 'after' | 'inside'
): PageBlock[] {
  const dragBlock = findBlockById(blocks, dragId);
  if (!dragBlock) return blocks;

  // Remove the dragged block
  let newBlocks = deleteBlock(blocks, dragId);

  // Find where to insert it
  const insertBlock = (blocks: PageBlock[]): PageBlock[] => {
    const targetIndex = blocks.findIndex((b) => b.id === targetId);
    
    if (targetIndex !== -1) {
      if (position === 'before') {
        return [
          ...blocks.slice(0, targetIndex),
          dragBlock,
          ...blocks.slice(targetIndex),
        ];
      } else if (position === 'after') {
        return [
          ...blocks.slice(0, targetIndex + 1),
          dragBlock,
          ...blocks.slice(targetIndex + 1),
        ];
      } else {
        // inside
        const target = blocks[targetIndex];
        if (target.children) {
          return blocks.map((b, i) =>
            i === targetIndex
              ? { ...b, children: [...b.children!, dragBlock] }
              : b
          );
        }
      }
    }

    // Recursively search in children
    return blocks.map((block) => {
      if (block.children) {
        return { ...block, children: insertBlock(block.children) };
      }
      return block;
    });
  };

  return insertBlock(newBlocks);
}

export function slugify(text: string): string {
  return text
    .toLowerCase()
    .replace(/[^\w\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-')
    .trim();
}

export function validateSlug(slug: string): boolean {
  return /^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(slug);
}

// ==========================================
// File: lib/page-templates.ts
// ==========================================


// Pre-built section templates for the simplified page builder

export type SectionType = 
  | 'hero'
  | 'text'
  | 'features'
  | 'cta'
  | 'testimonials'
  | 'pricing'
  | 'form'
  | 'image'
  | 'video'
  | 'team'
  | 'faq';

export interface Section {
  id: string;
  type: SectionType;
  data: Record<string, any>;
  order: number;
}

export const sectionTemplates: Record<SectionType, { name: string; description: string; defaultData: Record<string, any> }> = {
  hero: {
    name: 'Hero Section',
    description: 'Eye-catching header with headline, subheading, and CTA',
    defaultData: {
      headline: 'Transform Your Business with Expert Digital Marketing',
      subheading: 'We help businesses grow through strategic digital marketing and automation.',
      ctaText: 'Get Started',
      ctaLink: '/contact',
      backgroundImage: '',
      alignment: 'center',
      textColor: 'white',
      overlayOpacity: 0.5,
    },
  },
  text: {
    name: 'Text Block',
    description: 'Rich text content with formatting',
    defaultData: {
      content: '<p>Add your content here...</p>',
      alignment: 'left',
      maxWidth: 'large',
    },
  },
  features: {
    name: 'Features Grid',
    description: 'Showcase features or services in a grid layout',
    defaultData: {
      title: 'Our Services',
      subtitle: 'Everything you need to grow your business',
      items: [
        {
          icon: '🚀',
          title: 'Feature 1',
          description: 'Description of feature 1',
        },
        {
          icon: '⚡',
          title: 'Feature 2',
          description: 'Description of feature 2',
        },
        {
          icon: '💡',
          title: 'Feature 3',
          description: 'Description of feature 3',
        },
      ],
      columns: 3,
    },
  },
  cta: {
    name: 'Call to Action',
    description: 'Compelling CTA section with button',
    defaultData: {
      headline: 'Ready to Get Started?',
      subheadline: 'Join hundreds of satisfied clients',
      buttonText: 'Start Now',
      buttonLink: '/contact',
      backgroundColor: 'blue',
    },
  },
  testimonials: {
    name: 'Testimonials',
    description: 'Customer testimonials and reviews',
    defaultData: {
      title: 'What Our Clients Say',
      items: [
        {
          quote: 'Working with this team transformed our business.',
          author: 'John Doe',
          position: 'CEO, Company Inc',
          image: '',
        },
      ],
    },
  },
  pricing: {
    name: 'Pricing Table',
    description: 'Display pricing plans',
    defaultData: {
      title: 'Choose Your Plan',
      subtitle: 'Flexible pricing for businesses of all sizes',
      plans: [
        {
          name: 'Starter',
          price: '$99',
          period: 'month',
          features: ['Feature 1', 'Feature 2', 'Feature 3'],
          buttonText: 'Get Started',
          buttonLink: '/contact',
          featured: false,
        },
      ],
    },
  },
  form: {
    name: 'Contact Form',
    description: 'Lead capture or contact form',
    defaultData: {
      title: 'Get in Touch',
      subtitle: 'Fill out the form and we\'ll be in touch soon',
      fields: [
        { type: 'text', name: 'name', label: 'Name', required: true },
        { type: 'email', name: 'email', label: 'Email', required: true },
        { type: 'textarea', name: 'message', label: 'Message', required: true },
      ],
      submitText: 'Send Message',
      successMessage: 'Thank you! We\'ll be in touch soon.',
    },
  },
  image: {
    name: 'Image',
    description: 'Single image with optional caption',
    defaultData: {
      src: '',
      alt: '',
      caption: '',
      width: 'large',
      alignment: 'center',
    },
  },
  video: {
    name: 'Video',
    description: 'Embedded video (YouTube, Vimeo, etc.)',
    defaultData: {
      url: '',
      title: '',
      aspectRatio: '16/9',
    },
  },
  team: {
    name: 'Team Members',
    description: 'Showcase your team',
    defaultData: {
      title: 'Meet Our Team',
      subtitle: 'The experts behind your success',
      members: [
        {
          name: 'Team Member',
          position: 'Position',
          bio: 'Short bio',
          image: '',
          social: {
            linkedin: '',
            twitter: '',
          },
        },
      ],
    },
  },
  faq: {
    name: 'FAQ Section',
    description: 'Frequently asked questions',
    defaultData: {
      title: 'Frequently Asked Questions',
      items: [
        {
          question: 'Question 1?',
          answer: 'Answer to question 1',
        },
      ],
    },
  },
};

export function createSection(type: SectionType): Section {
  return {
    id: `section-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
    type,
    data: JSON.parse(JSON.stringify(sectionTemplates[type].defaultData)), // Deep clone
    order: 0,
  };
}

// ==========================================
// File: lib/pdf-generator.ts
// ==========================================

import { PDFDocument, StandardFonts, rgb, PDFPage, PDFName, PDFDict, PDFArray, PDFNumber } from 'pdf-lib';
import { getContactInfo } from './cdm-suite-knowledge';

export interface ProposalSection {
  title: string;
  content: string;
}

export interface ProposalPDFData {
  title: string;
  solicitationNumber: string;
  companyName: string;
  date: string;
  sections: ProposalSection[];
}

// CDM Suite professional color scheme
const colors = {
  primary: rgb(0.114, 0.169, 0.325), // Dark blue #1D2B53
  secondary: rgb(0.29, 0.56, 0.88), // Light blue #4A90E2
  accent: rgb(0.929, 0.522, 0.133), // Orange #ED8522
  text: rgb(0.2, 0.2, 0.2), // Dark gray for text
  mediumGray: rgb(0.4, 0.4, 0.4),
  lightGray: rgb(0.96, 0.96, 0.96), // Lighter for subtle backgrounds
  white: rgb(1, 1, 1),
  tableBorder: rgb(0.85, 0.85, 0.85),
};

/**
 * Sanitize text for PDF rendering by replacing Unicode characters
 * that are not supported by WinAnsi encoding with ASCII equivalents
 */
function sanitizeTextForPDF(text: string): string {
  if (!text) return '';
  
  return text
    // Arrows
    .replace(/→/g, '->')
    .replace(/←/g, '<-')
    .replace(/↑/g, '^')
    .replace(/↓/g, 'v')
    .replace(/⇒/g, '=>')
    .replace(/⇐/g, '<=')
    // Smart quotes
    .replace(/[""]/g, '"')
    .replace(/['']/g, "'")
    // Dashes
    .replace(/—/g, '--')  // em dash
    .replace(/–/g, '-')   // en dash
    // Ellipsis
    .replace(/…/g, '...')
    // Symbols
    .replace(/©/g, '(c)')
    .replace(/®/g, '(R)')
    .replace(/™/g, '(TM)')
    .replace(/°/g, ' degrees')
    // Math symbols
    .replace(/×/g, 'x')
    .replace(/÷/g, '/')
    .replace(/≤/g, '<=')
    .replace(/≥/g, '>=')
    .replace(/≠/g, '!=')
    .replace(/±/g, '+/-')
    // Currency (keep $ but replace others)
    .replace(/€/g, 'EUR')
    .replace(/£/g, 'GBP')
    .replace(/¥/g, 'YEN')
    // Other common unicode
    .replace(/•/g, '*')  // bullet point (but we handle this separately in rendering)
    .replace(/◦/g, 'o')  // white bullet
    .replace(/▪/g, '-')  // black square
    .replace(/§/g, 'Section')
    .replace(/¶/g, 'Para')
    // Remove any remaining problematic characters (non-printable ASCII)
    .replace(/[^\x20-\x7E\n\r\t]/g, '');
}

/**
 * Strip all markdown formatting from text
 * Removes headers, bold, italic, links, code blocks, horizontal rules, etc.
 */
function stripMarkdown(text: string): string {
  if (!text) return '';
  
  return text
    // Remove horizontal rules (---, ___, ***)
    .replace(/^[\s]*[-_*]{3,}[\s]*$/gm, '')
    // Remove headers (# ## ### etc)
    .replace(/^#{1,6}\s+/gm, '')
    // Remove bold (**text** or __text__)
    .replace(/\*\*(.+?)\*\*/g, '$1')
    .replace(/__(.+?)__/g, '$1')
    // Remove italic (*text* or _text_)
    .replace(/\*(.+?)\*/g, '$1')
    .replace(/_(.+?)_/g, '$1')
    // Remove strikethrough (~~text~~)
    .replace(/~~(.+?)~~/g, '$1')
    // Remove inline code (`code`)
    .replace(/`([^`]+)`/g, '$1')
    // Remove code blocks (```code```)
    .replace(/```[\s\S]*?```/g, '')
    // Remove links [text](url)
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')
    // Remove images ![alt](url)
    .replace(/!\[([^\]]*)\]\([^\)]+\)/g, '$1')
    // Remove blockquotes (> text)
    .replace(/^>\s+/gm, '')
    // Clean up multiple newlines
    .replace(/\n{3,}/g, '\n\n')
    .trim();
}

interface TableRow {
  cells: string[];
}

interface ParsedContent {
  type: 'paragraph' | 'heading' | 'bullet' | 'number' | 'table';
  content: string;
  level?: number;
  tableData?: TableRow[];
}

export async function generateProposalPDF(data: ProposalPDFData): Promise<Buffer> {
  try {
    const pdfDoc = await PDFDocument.create();
    
    // Embed fonts
    const helveticaBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
    const helvetica = await pdfDoc.embedFont(StandardFonts.Helvetica);
    const helveticaOblique = await pdfDoc.embedFont(StandardFonts.HelveticaOblique);
    
    // Page settings - professional margins
    const pageWidth = 612;
    const pageHeight = 792;
    const margin = 72; // 1 inch margins for professional look
    const contentWidth = pageWidth - (margin * 2);
    
    // Track section pages for clickable TOC
    const sectionPageRefs: { pageIndex: number; yPosition: number }[] = [];
    
    // === COVER PAGE - Executive Style ===
    let page = pdfDoc.addPage([pageWidth, pageHeight]);
    let yPosition = pageHeight - 150;
    
    // Top accent bar (thinner, more elegant)
    page.drawRectangle({
      x: 0,
      y: pageHeight - 12,
      width: pageWidth,
      height: 12,
      color: colors.accent,
    });
    
    // Company name on cover - prominent but refined
    page.drawText(sanitizeTextForPDF(stripMarkdown(data.companyName.toUpperCase())), {
      x: margin,
      y: pageHeight - 100,
      size: 18,
      font: helveticaBold,
      color: colors.primary,
    });
    
    // Underline for company name
    page.drawLine({
      start: { x: margin, y: pageHeight - 110 },
      end: { x: margin + (data.companyName.length * 11), y: pageHeight - 110 },
      thickness: 2,
      color: colors.accent,
    });
    
    // Proposal title - large and commanding
    yPosition = pageHeight - 200;
    const titleLines = wrapText(sanitizeTextForPDF(stripMarkdown(data.title)), contentWidth, 36, helveticaBold);
    for (const line of titleLines) {
      page.drawText(line, {
        x: margin,
        y: yPosition,
        size: 36,
        font: helveticaBold,
        color: colors.primary,
      });
      yPosition -= 45;
    }
    
    // Subtitle or tagline area
    yPosition -= 20;
    page.drawText('PROPOSAL RESPONSE', {
      x: margin,
      y: yPosition,
      size: 12,
      font: helveticaBold,
      color: colors.mediumGray,
    });
    
    // Solicitation info box - refined design
    yPosition -= 60;
    const infoBoxHeight = 140;
    const infoBoxY = yPosition - infoBoxHeight;
    
    // Box background
    page.drawRectangle({
      x: margin,
      y: infoBoxY,
      width: contentWidth,
      height: infoBoxHeight,
      color: colors.lightGray,
    });
    
    // Left accent bar on info box
    page.drawRectangle({
      x: margin,
      y: infoBoxY,
      width: 5,
      height: infoBoxHeight,
      color: colors.primary,
    });
    
    yPosition -= 30;
    page.drawText('Solicitation Number', {
      x: margin + 20,
      y: yPosition,
      size: 10,
      font: helveticaBold,
      color: colors.mediumGray,
    });
    
    yPosition -= 20;
    page.drawText(sanitizeTextForPDF(stripMarkdown(data.solicitationNumber)), {
      x: margin + 20,
      y: yPosition,
      size: 16,
      font: helveticaBold,
      color: colors.primary,
    });
    
    yPosition -= 35;
    page.drawText('Submitted By', {
      x: margin + 20,
      y: yPosition,
      size: 10,
      font: helveticaBold,
      color: colors.mediumGray,
    });
    
    yPosition -= 20;
    page.drawText(sanitizeTextForPDF(stripMarkdown(data.companyName)), {
      x: margin + 20,
      y: yPosition,
      size: 14,
      font: helvetica,
      color: colors.text,
    });
    
    yPosition -= 30;
    page.drawText(sanitizeTextForPDF(stripMarkdown(`Submission Date: ${data.date}`)), {
      x: margin + 20,
      y: yPosition,
      size: 10,
      font: helvetica,
      color: colors.text,
    });
    
    // Professional footer on cover with contact information
    page.drawLine({
      start: { x: margin, y: 90 },
      end: { x: pageWidth - margin, y: 90 },
      thickness: 1,
      color: colors.lightGray,
    });
    
    // Get contact information from knowledge base
    const contactInfo = getContactInfo();
    
    // Contact information
    page.drawText('CDM Suite LLC', {
      x: margin,
      y: 70,
      size: 9,
      font: helveticaBold,
      color: colors.text,
    });
    
    page.drawText(`Email: ${contactInfo.email}`, {
      x: margin,
      y: 55,
      size: 8,
      font: helvetica,
      color: colors.mediumGray,
    });
    
    page.drawText(`Phone: ${contactInfo.phone}`, {
      x: margin,
      y: 42,
      size: 8,
      font: helvetica,
      color: colors.mediumGray,
    });
    
    page.drawText('CONFIDENTIAL & PROPRIETARY', {
      x: pageWidth - margin - 160,
      y: 30,
      size: 8,
      font: helveticaBold,
      color: colors.mediumGray,
    });
    
    // === TABLE OF CONTENTS (if more than 3 sections) ===
    let tocPageIndex = -1;
    const tocItems: { yPosition: number; sectionIndex: number }[] = [];
    
    if (data.sections.length > 3) {
      page = pdfDoc.addPage([pageWidth, pageHeight]);
      tocPageIndex = pdfDoc.getPageCount() - 1;
      yPosition = pageHeight - margin - 20;
      
      page.drawText('TABLE OF CONTENTS', {
        x: margin,
        y: yPosition,
        size: 20,
        font: helveticaBold,
        color: colors.primary,
      });
      
      page.drawLine({
        start: { x: margin, y: yPosition - 8 },
        end: { x: margin + 180, y: yPosition - 8 },
        thickness: 2,
        color: colors.accent,
      });
      
      yPosition -= 40;
      
      data.sections.forEach((section, idx) => {
        const sectionNum = `${idx + 1}.`;
        page.drawText(sectionNum, {
          x: margin,
          y: yPosition,
          size: 11,
          font: helveticaBold,
          color: colors.primary,
        });
        
        const truncatedTitle = section.title.length > 65 
          ? section.title.substring(0, 62) + '...'
          : section.title;
        
        page.drawText(sanitizeTextForPDF(stripMarkdown(truncatedTitle)), {
          x: margin + 25,
          y: yPosition,
          size: 11,
          font: helvetica,
          color: colors.text,
        });
        
        // Store TOC item position for later annotation
        tocItems.push({ yPosition, sectionIndex: idx });
        
        yPosition -= 22;
        
        if (yPosition < margin + 50) {
          page = pdfDoc.addPage([pageWidth, pageHeight]);
          yPosition = pageHeight - margin;
        }
      });
    }
    
    // === CONTENT SECTIONS ===
    page = pdfDoc.addPage([pageWidth, pageHeight]);
    yPosition = pageHeight - margin - 20;
    
    for (let i = 0; i < data.sections.length; i++) {
      const section = data.sections[i];
      
      // Check if we need a new page for section title (more conservative)
      if (yPosition < margin + 180) {
        page = pdfDoc.addPage([pageWidth, pageHeight]);
        yPosition = pageHeight - margin - 20;
      }
      
      // Store section page reference for clickable TOC
      sectionPageRefs.push({
        pageIndex: pdfDoc.getPageCount() - 1,
        yPosition: yPosition
      });
      
      // Section number badge
      const sectionNum = `${i + 1}`;
      const badgeWidth = 30;
      const badgeHeight = 26;
      
      page.drawRectangle({
        x: margin - 5,
        y: yPosition - badgeHeight + 5,
        width: badgeWidth,
        height: badgeHeight,
        color: colors.primary,
      });
      
      page.drawText(sectionNum, {
        x: margin + 7,
        y: yPosition - 14,
        size: 16,
        font: helveticaBold,
        color: colors.white,
      });
      
      // Section title - prominent and clear
      const sectionTitleSize = 18;
      const wrappedTitle = wrapText(sanitizeTextForPDF(stripMarkdown(section.title)), contentWidth - 40, sectionTitleSize, helveticaBold);
      
      let titleY = yPosition;
      for (const titleLine of wrappedTitle) {
        page.drawText(titleLine, {
          x: margin + 35,
          y: titleY,
          size: sectionTitleSize,
          font: helveticaBold,
          color: colors.primary,
        });
        titleY -= sectionTitleSize + 5;
      }
      
      // Accent line under title
      page.drawLine({
        start: { x: margin, y: titleY - 5 },
        end: { x: pageWidth - margin, y: titleY - 5 },
        thickness: 1.5,
        color: colors.accent,
      });
      
      yPosition = titleY - 25;
      
      // Parse and render content
      const parsedContent = parseMarkdownContent(section.content);
      
      for (const item of parsedContent) {
        const result = await renderContentItem(
          page,
          item,
          margin,
          yPosition,
          contentWidth,
          helvetica,
          helveticaBold,
          helveticaOblique,
          pdfDoc
        );
        
        page = result.page;
        yPosition = result.yPosition;
      }
      
      // Add space after section
      yPosition -= 30;
    }
    
    // Add clickable links to TOC (if TOC exists)
    if (tocPageIndex >= 0 && tocItems.length > 0) {
      const tocPage = pdfDoc.getPages()[tocPageIndex];
      const context = pdfDoc.context;
      
      tocItems.forEach((tocItem) => {
        const targetPageRef = sectionPageRefs[tocItem.sectionIndex];
        if (targetPageRef) {
          const targetPage = pdfDoc.getPages()[targetPageRef.pageIndex];
          
          // Create clickable link annotation using pdf-lib low-level API
          const linkAnnotDict = context.obj({});
          linkAnnotDict.set(PDFName.of('Type'), PDFName.of('Annot'));
          linkAnnotDict.set(PDFName.of('Subtype'), PDFName.of('Link'));
          linkAnnotDict.set(PDFName.of('Rect'), context.obj([
            margin, 
            tocItem.yPosition - 5, 
            pageWidth - margin, 
            tocItem.yPosition + 16
          ]));
          linkAnnotDict.set(PDFName.of('Border'), context.obj([0, 0, 0]));
          
          // Create destination array
          const destArray = context.obj([
            targetPage.ref, 
            PDFName.of('XYZ'), 
            null, 
            targetPageRef.yPosition, 
            null
          ]);
          linkAnnotDict.set(PDFName.of('Dest'), destArray);
          
          // Add annotation to page
          const tocPageDict = tocPage.node;
          const annotsName = PDFName.of('Annots');
          const existingAnnots = tocPageDict.lookup(annotsName);
          
          if (existingAnnots && existingAnnots instanceof PDFArray) {
            existingAnnots.push(linkAnnotDict);
          } else {
            const newAnnots = context.obj([linkAnnotDict]);
            tocPageDict.set(annotsName, newAnnots);
          }
        }
      });
    }
    
    // Add page numbers and footers to all pages (skip cover)
    const pages = pdfDoc.getPages();
    const pageCount = pages.length;
    
    pages.forEach((page, index) => {
      if (index === 0) return; // Skip cover page
      
      // Footer line
      page.drawLine({
        start: { x: margin, y: 40 },
        end: { x: pageWidth - margin, y: 40 },
        thickness: 1,
        color: colors.lightGray,
      });
      
      // Page number
      const pageText = `Page ${index} of ${pageCount - 1}`;
      const pageTextWidth = pageText.length * 5;
      page.drawText(pageText, {
        x: (pageWidth - pageTextWidth) / 2,
        y: 25,
        size: 9,
        font: helvetica,
        color: colors.text,
      });
      
      // Company name in footer
      page.drawText(sanitizeTextForPDF(stripMarkdown(data.companyName)), {
        x: margin,
        y: 25,
        size: 9,
        font: helveticaBold,
        color: colors.text,
      });
      
      // Solicitation number in footer
      const solTextWidth = data.solicitationNumber.length * 5;
      page.drawText(sanitizeTextForPDF(stripMarkdown(data.solicitationNumber)), {
        x: pageWidth - margin - solTextWidth,
        y: 25,
        size: 9,
        font: helvetica,
        color: colors.text,
      });
    });
    
    const pdfBytes = await pdfDoc.save();
    return Buffer.from(pdfBytes);
  } catch (error) {
    console.error('Error generating PDF:', error);
    throw error;
  }
}

function parseMarkdownContent(content: string): ParsedContent[] {
  const items: ParsedContent[] = [];
  const lines = content.split('\n');
  let currentTable: TableRow[] = [];
  let inTable = false;
  
  for (let i = 0; i < lines.length; i++) {
    let line = lines[i].trim();
    
    if (!line) {
      if (inTable && currentTable.length > 0) {
        items.push({ type: 'table', content: '', tableData: currentTable });
        currentTable = [];
        inTable = false;
      }
      continue;
    }
    
    // Skip horizontal rules (---, ___, ***)
    if (line.match(/^[-_*]{3,}$/)) {
      continue;
    }
    
    // Table detection (do this before markdown stripping to preserve structure)
    if (line.includes('|')) {
      inTable = true;
      // Skip separator rows
      if (line.match(/^[\s|:-]+$/)) continue;
      
      const cells = line.split('|')
        .map(cell => stripMarkdown(cell.trim()))
        .filter(cell => cell.length > 0);
      
      if (cells.length > 0) {
        currentTable.push({ cells });
      }
      continue;
    }
    
    // If we were in a table, save it
    if (inTable && currentTable.length > 0) {
      items.push({ type: 'table', content: '', tableData: currentTable });
      currentTable = [];
      inTable = false;
    }
    
    // Headings (detect before stripping markdown to preserve structure)
    if (line.startsWith('###')) {
      const cleanContent = stripMarkdown(line.replace(/^###\s*/, ''));
      if (cleanContent) {
        items.push({ type: 'heading', content: cleanContent, level: 3 });
      }
    } else if (line.startsWith('##')) {
      const cleanContent = stripMarkdown(line.replace(/^##\s*/, ''));
      if (cleanContent) {
        items.push({ type: 'heading', content: cleanContent, level: 2 });
      }
    }
    // Bullet points
    else if (line.match(/^[-•*]\s/)) {
      const cleanContent = stripMarkdown(line.replace(/^[-•*]\s/, ''));
      if (cleanContent) {
        items.push({ type: 'bullet', content: cleanContent });
      }
    }
    // Numbered lists
    else if (line.match(/^\d+\.\s/)) {
      const cleanContent = stripMarkdown(line.replace(/^\d+\.\s/, ''));
      if (cleanContent) {
        items.push({ type: 'number', content: cleanContent });
      }
    }
    // Regular paragraph
    else {
      const cleanContent = stripMarkdown(line);
      if (cleanContent) {
        items.push({ type: 'paragraph', content: cleanContent });
      }
    }
  }
  
  // Save any remaining table
  if (inTable && currentTable.length > 0) {
    items.push({ type: 'table', content: '', tableData: currentTable });
  }
  
  return items;
}

async function renderContentItem(
  page: PDFPage,
  item: ParsedContent,
  margin: number,
  yPosition: number,
  contentWidth: number,
  helvetica: any,
  helveticaBold: any,
  helveticaOblique: any,
  pdfDoc: PDFDocument
): Promise<{ page: PDFPage; yPosition: number }> {
  const lineHeight = 16;
  const paragraphSize = 11;
  const bulletSize = 11;
  const pageWidth = 612;
  const pageHeight = 792;
  const bottomMargin = margin + 80; // More conservative space for footers
  
  // Helper function to check if we need a new page (more conservative)
  const needsNewPage = (requiredSpace: number) => {
    return yPosition - requiredSpace - 20 < bottomMargin; // Add 20px buffer
  };
  
  // Helper function to create new page
  const createNewPage = () => {
    page = pdfDoc.addPage([pageWidth, pageHeight]);
    return pageHeight - margin - 20; // Start with some padding from top
  };
  
  switch (item.type) {
    case 'heading':
      const headingSize = item.level === 2 ? 15 : 13;
      const headingSpace = headingSize + 20;
      
      if (needsNewPage(headingSpace)) {
        yPosition = createNewPage();
      }
      
      // Small accent bar before heading
      page.drawRectangle({
        x: margin,
        y: yPosition - 3,
        width: 3,
        height: headingSize + 3,
        color: colors.accent,
      });
      
      page.drawText(sanitizeTextForPDF(item.content), {
        x: margin + 10,
        y: yPosition,
        size: headingSize,
        font: helveticaBold,
        color: colors.primary,
      });
      return { page, yPosition: yPosition - headingSize - 15 };
      
    case 'bullet':
      const bulletLines = wrapText(sanitizeTextForPDF(item.content), contentWidth - 30, bulletSize, helvetica);
      
      for (let i = 0; i < bulletLines.length; i++) {
        if (needsNewPage(lineHeight + 10)) {
          yPosition = createNewPage();
        }
        
        // Only draw bullet on first line
        if (i === 0) {
          page.drawEllipse({
            x: margin + 8,
            y: yPosition - 3,
            xScale: 3,
            yScale: 3,
            color: colors.accent,
          });
        }
        
        page.drawText(bulletLines[i], {
          x: margin + 20,
          y: yPosition,
          size: bulletSize,
          font: helvetica,
          color: colors.text,
        });
        yPosition -= lineHeight;
      }
      return { page, yPosition: yPosition - 6 };
      
    case 'number':
      const numberLines = wrapText(sanitizeTextForPDF(item.content), contentWidth - 30, bulletSize, helvetica);
      
      for (const line of numberLines) {
        if (needsNewPage(lineHeight + 10)) {
          yPosition = createNewPage();
        }
        
        page.drawText(line, {
          x: margin + 20,
          y: yPosition,
          size: bulletSize,
          font: helvetica,
          color: colors.text,
        });
        yPosition -= lineHeight;
      }
      return { page, yPosition: yPosition - 6 };
      
    case 'table':
      if (item.tableData && item.tableData.length > 0) {
        const result = renderTable(page, item.tableData, margin, yPosition, contentWidth, helvetica, helveticaBold, pdfDoc);
        return { page: result.page, yPosition: result.yPosition };
      }
      return { page, yPosition };
      
    case 'paragraph':
    default:
      const paraLines = wrapText(sanitizeTextForPDF(item.content), contentWidth, paragraphSize, helvetica);
      
      for (const line of paraLines) {
        if (needsNewPage(lineHeight + 10)) {
          yPosition = createNewPage();
        }
        
        page.drawText(line, {
          x: margin,
          y: yPosition,
          size: paragraphSize,
          font: helvetica,
          color: colors.text,
        });
        yPosition -= lineHeight;
      }
      return { page, yPosition: yPosition - 10 };
  }
}

function renderTable(
  page: PDFPage,
  tableData: TableRow[],
  margin: number,
  yPosition: number,
  contentWidth: number,
  helvetica: any,
  helveticaBold: any,
  pdfDoc: PDFDocument
): { page: PDFPage; yPosition: number } {
  if (tableData.length === 0) return { page, yPosition };
  
  const pageWidth = 612;
  const pageHeight = 792;
  const bottomMargin = margin + 80; // More conservative margin
  const numColumns = tableData[0].cells.length;
  const cellWidth = contentWidth / numColumns;
  const minRowHeight = 26; // Slightly taller minimum for better readability
  const cellPadding = 8;
  const lineHeight = 13; // Slightly more space between lines
  const fontSize = 9;
  
  // Helper to wrap text for a cell
  const wrapCellText = (text: string, maxWidth: number): string[] => {
    return wrapText(sanitizeTextForPDF(text), maxWidth, fontSize, helvetica);
  };
  
  // Helper to calculate row height based on content
  const calculateRowHeight = (row: TableRow): number => {
    let maxLines = 1;
    for (let i = 0; i < row.cells.length; i++) {
      const lines = wrapCellText(row.cells[i], cellWidth - cellPadding * 2);
      maxLines = Math.max(maxLines, lines.length);
    }
    return Math.max(minRowHeight, maxLines * lineHeight + cellPadding * 2);
  };
  
  // Helper to draw header
  const drawHeader = (currentPage: PDFPage, currentY: number) => {
    const headerHeight = calculateRowHeight(tableData[0]);
    
    // Header row with gradient effect (simulated with darker primary)
    currentPage.drawRectangle({
      x: margin,
      y: currentY - headerHeight,
      width: contentWidth,
      height: headerHeight,
      color: colors.primary,
    });
    
    // Orange accent line on top of header
    currentPage.drawRectangle({
      x: margin,
      y: currentY,
      width: contentWidth,
      height: 2,
      color: colors.accent,
    });
    
    // Header cells with multi-line support
    for (let i = 0; i < tableData[0].cells.length; i++) {
      const lines = wrapCellText(tableData[0].cells[i], cellWidth - cellPadding * 2);
      let cellY = currentY - cellPadding - 10;
      
      for (const line of lines) {
        currentPage.drawText(line, {
          x: margin + (i * cellWidth) + cellPadding,
          y: cellY,
          size: fontSize,
          font: helveticaBold,
          color: colors.white,
        });
        cellY -= lineHeight;
      }
      
      // Column separator lines in header
      if (i > 0) {
        currentPage.drawLine({
          start: { x: margin + (i * cellWidth), y: currentY },
          end: { x: margin + (i * cellWidth), y: currentY - headerHeight },
          thickness: 0.5,
          color: rgb(1, 1, 1),
          opacity: 0.3,
        });
      }
    }
    
    return currentY - headerHeight;
  };
  
  // Check if we have space for at least header + 2 rows
  const estimatedHeaderHeight = calculateRowHeight(tableData[0]);
  if (yPosition - (estimatedHeaderHeight + minRowHeight * 2) < bottomMargin) {
    page = pdfDoc.addPage([pageWidth, pageHeight]);
    yPosition = pageHeight - margin;
  }
  
  // Draw header
  yPosition = drawHeader(page, yPosition);
  
  // Data rows with enhanced styling and multi-line support
  for (let rowIndex = 1; rowIndex < tableData.length; rowIndex++) {
    const row = tableData[rowIndex];
    const rowHeight = calculateRowHeight(row);
    
    // Check if we need a new page
    if (yPosition - rowHeight < bottomMargin) {
      page = pdfDoc.addPage([pageWidth, pageHeight]);
      yPosition = pageHeight - margin;
      // Redraw header on new page
      yPosition = drawHeader(page, yPosition);
    }
    
    const bgColor = rowIndex % 2 === 1 ? colors.white : colors.lightGray;
    
    // Row background
    page.drawRectangle({
      x: margin,
      y: yPosition - rowHeight,
      width: contentWidth,
      height: rowHeight,
      color: bgColor,
    });
    
    // Subtle border lines
    page.drawLine({
      start: { x: margin, y: yPosition - rowHeight },
      end: { x: margin + contentWidth, y: yPosition - rowHeight },
      thickness: 0.5,
      color: colors.tableBorder,
    });
    
    // Cell content with multi-line support
    for (let i = 0; i < row.cells.length; i++) {
      const lines = wrapCellText(row.cells[i], cellWidth - cellPadding * 2);
      let cellY = yPosition - cellPadding - 10;
      
      for (const line of lines) {
        page.drawText(line, {
          x: margin + (i * cellWidth) + cellPadding,
          y: cellY,
          size: fontSize,
          font: helvetica,
          color: colors.text,
        });
        cellY -= lineHeight;
      }
      
      // Column separator (subtle)
      if (i > 0) {
        page.drawLine({
          start: { x: margin + (i * cellWidth), y: yPosition },
          end: { x: margin + (i * cellWidth), y: yPosition - rowHeight },
          thickness: 0.3,
          color: colors.tableBorder,
        });
      }
    }
    
    yPosition -= rowHeight;
  }
  
  // Bottom border of table
  page.drawRectangle({
    x: margin,
    y: yPosition,
    width: contentWidth,
    height: 1,
    color: colors.primary,
  });
  
  return { page, yPosition: yPosition - 20 };
}

function wrapText(text: string, maxWidth: number, fontSize: number, font: any): string[] {
  const words = text.split(' ');
  const lines: string[] = [];
  let currentLine = '';
  
  for (const word of words) {
    const testLine = currentLine ? `${currentLine} ${word}` : word;
    const testWidth = font.widthOfTextAtSize(testLine, fontSize);
    
    if (testWidth <= maxWidth) {
      currentLine = testLine;
    } else {
      // If current line has content, push it and start new line
      if (currentLine) {
        lines.push(currentLine);
        currentLine = word;
      } else {
        // Word itself is too long, need to break it
        const chars = word.split('');
        let brokenWord = '';
        for (const char of chars) {
          const testBroken = brokenWord + char;
          const brokenWidth = font.widthOfTextAtSize(testBroken, fontSize);
          if (brokenWidth <= maxWidth) {
            brokenWord = testBroken;
          } else {
            if (brokenWord) lines.push(brokenWord);
            brokenWord = char;
          }
        }
        if (brokenWord) currentLine = brokenWord;
      }
    }
  }
  
  if (currentLine) lines.push(currentLine);
  
  return lines.length > 0 ? lines : [text.substring(0, Math.floor(maxWidth / (fontSize * 0.5)))];
}

function estimateContentHeight(item: ParsedContent): number {
  switch (item.type) {
    case 'heading':
      return 40; // Increased for larger headings with accent bars
    case 'bullet':
    case 'number':
      // Estimate based on content length with better line height
      return Math.ceil(item.content.length / 75) * 16 + 10;
    case 'table':
      // Header (28) + data rows (24 each) + spacing (20) + accent lines (2)
      const tableRows = item.tableData?.length || 0;
      return tableRows === 0 ? 0 : 28 + ((tableRows - 1) * 24) + 22;
    case 'paragraph':
    default:
      // Better estimation with new larger text and spacing
      return Math.ceil(item.content.length / 85) * 16 + 12;
  }
}

export function parseSectionsFromMarkdown(markdown: string): ProposalSection[] {
  const sections: ProposalSection[] = [];
  const parts = markdown.split(/(?=^## )/gm);
  
  parts.forEach(part => {
    const lines = part.trim().split('\n');
    if (lines.length > 0) {
      const title = stripMarkdown(lines[0].replace(/^##\s*/, '')).trim();
      const content = lines.slice(1).join('\n').trim();
      
      if (title && content) {
        sections.push({ title, content });
      }
    }
  });
  
  return sections;
}
// ==========================================
// File: lib/posthog-server.ts
// ==========================================


import { PostHog } from 'posthog-node';

let posthogClient: PostHog | null = null;

export function getPostHogClient() {
  if (!posthogClient) {
    const key = process.env.NEXT_PUBLIC_POSTHOG_KEY;
    const host = process.env.NEXT_PUBLIC_POSTHOG_HOST;

    // Return null if placeholders are still in place
    if (!key || key.startsWith('phc_XXXX') || !host) {
      return null;
    }

    posthogClient = new PostHog(key, {
      host: host,
      flushAt: 1,
      flushInterval: 0,
    });
  }

  return posthogClient;
}

export async function shutdownPostHog() {
  if (posthogClient) {
    await posthogClient.shutdown();
  }
}

// ==========================================
// File: lib/pricing-tiers.ts
// ==========================================


// Centralized pricing tiers for consistent pricing across the website
// Update prices here to reflect changes everywhere

export const AD_MANAGEMENT_TIERS = [
  {
    id: 'ad-starter',
    name: 'Starter',
    price: 250,
    priceRange: '$200-300',
    description: 'Small businesses or those testing digital marketing, with limited budget',
    features: [
      'Meta Ads + Google PPC management (basic campaign setup, standard targeting)',
      'Monthly report',
      'Content calendar (1-2 social posts/blogs)',
      'Basic SEO (on-page optimization for up to few pages)',
      'GBP/local listing optimization',
    ],
    popular: false,
  },
  {
    id: 'ad-growth',
    name: 'Growth',
    price: 550,
    priceRange: '$400-700',
    description: 'Businesses who want to scale, more keywords & optimization',
    features: [
      'Everything in Starter, plus:',
      'Backlink building',
      'A/B testing on ads',
      'More content (blog + social media)',
      'More keywords under SEO (wider scope)',
      'Priority support',
    ],
    popular: true,
  },
  {
    id: 'ad-premium',
    name: 'Pro / Premium',
    price: 1000,
    priceRange: '$800-1,200+',
    description: 'Businesses serious about growth, larger ad budgets, multiple channels',
    features: [
      'Everything in Growth, plus:',
      'TikTok / Snapchat / additional paid social channels',
      'Advanced content / video content',
      'Full SEO + local + technical SEO audit',
      'Conversion Rate Optimization (CRO) consulting',
      'More frequent content reporting / dashboard access',
      'Dedicated account manager / priority support',
    ],
    popular: false,
  },
  {
    id: 'ad-enterprise',
    name: 'Enterprise / Custom',
    price: 3500,
    priceRange: '$2,000-5,000+ or % of ad spend + retainer',
    description: 'Large companies, or those needing a bespoke solution',
    features: [
      'All Premium features plus:',
      'Custom strategy / market research',
      'Integration with other platforms (CRM, automation)',
      'More aggressive ad spend & scaling',
      'Custom KPIs, multiple markets / geographies',
      'Possibly white-glove support, more frequent check-ins, custom features',
    ],
    popular: false,
  },
];

export const SEO_TIERS = [
  {
    id: 'seo-local-basic',
    name: 'Local / Basic SEO',
    price: 175,
    priceRange: '$175/mo',
    description: 'On-page SEO for few pages',
    features: [
      'Keyword research (local terms)',
      'Google My Business / local listing optimization',
      'Basic content optimization',
      'Monthly monitoring & report',
    ],
    popular: false,
  },
  {
    id: 'seo-growth',
    name: 'Growth SEO',
    price: 600,
    priceRange: '$400-800/mo',
    description: 'More keywords, more pages',
    features: [
      'Off-page (backlinks) strategy',
      'Technical SEO (site speed, mobile optimization)',
      'Content development (blogs, articles)',
      'Site audits every quarter',
      'Strong local + international targeting',
    ],
    popular: true,
  },
  {
    id: 'seo-comprehensive',
    name: 'Comprehensive / Global SEO',
    price: 3000,
    priceRange: '$2,500-3,500+/mo',
    description: 'Very competitive keywords',
    features: [
      'Large site audits & overhaul',
      'High content output + editorial strategy',
      'Ongoing link building',
      'Detailed analytics, conversion optimization',
      'Possibly multi-language / multi-region',
    ],
    popular: false,
  },
];

export const SOCIAL_MEDIA_TIERS = [
  {
    id: 'social-basic',
    name: 'Basic / Starter',
    price: 200,
    priceRange: '$200/mo ≈ JMD 31,000',
    description: '1 platform',
    features: [
      '~8 posts/month',
      'Simple graphics',
      'Scheduling & posting',
      'Basic engagement & analytics report monthly',
    ],
    popular: false,
  },
  {
    id: 'social-growth',
    name: 'Growth',
    price: 490,
    priceRange: '$400-580/mo ≈ JMD 65,000-93,000',
    description: '2-3 platforms',
    features: [
      '~12-18 posts/month + stories',
      'More engaging content (video, carousels)',
      'Ad budget managed (small)',
      'More frequent analytics & performance review',
      'Community management',
    ],
    popular: true,
  },
  {
    id: 'social-pro',
    name: 'Pro / Full Spectrum',
    price: 1500,
    priceRange: '$1,000-2,000/mo ≈ JMD 162,000-324,000+',
    description: '3-5 platforms',
    features: [
      'Daily posts + stories',
      'Rich multimedia content (video, animation)',
      'Higher ad spend and optimization',
      'Influencer / collaboration strategy',
      'CRO of social channels',
      'Weekly or biweekly reporting + strategy adjustments',
    ],
    popular: false,
  },
];

export const WEB_DEVELOPMENT_TIERS = [
  {
    id: 'web-starter',
    name: 'Starter',
    price: 420,
    priceRange: '$340-500 ≈ JMD 54,500-82,500',
    description: 'Semi-custom design, up to 5 pages',
    features: [
      'Semi-custom design',
      'Up to 5 pages',
      'Responsive / mobile friendly',
      'Basic on-page SEO',
      '1 revision',
      'Basic contact form',
    ],
    popular: false,
  },
  {
    id: 'web-growth',
    name: 'Growth / Business',
    price: 975,
    priceRange: '$750-$1200+ ≈ JMD 125,000-195,000',
    description: 'Custom design, up to 10-15 pages',
    features: [
      'Custom design',
      'Up to 10-15 pages',
      'Blog / news section',
      'More revisions (2-3)',
      'E-commerce capable (if needed) or payment integration',
      'More storage / bandwidth',
      'Faster turnaround',
    ],
    popular: true,
  },
  {
    id: 'web-premium',
    name: 'Premium / Enterprise',
    price: 3750,
    priceRange: '$2,500-5,000+ ≈ JMD 410,000-820,000+',
    description: 'Fully custom design, unlimited/many pages',
    features: [
      'Fully custom design',
      'Unlimited / many pages',
      'Advanced functionality (member login, booking, etc.)',
      'Custom graphics, photography, potentially video integration',
      'Ongoing maintenance & support',
      'Priority support',
    ],
    popular: false,
  },
];

export const APP_CREATION_TIERS = [
  {
    id: 'app-mvp',
    name: 'MVP / Basic',
    price: 1225,
    priceRange: '$950-1500+',
    description: 'Basic features only (user login, simple UI)',
    features: [
      'iOS or Android (maybe both)',
      'Limited backend',
      'Basic design',
      'Minimal admin panel',
      'Testing & deployment',
    ],
    popular: false,
  },
  {
    id: 'app-growth',
    name: 'Growth / Feature-Rich App',
    price: 3750,
    priceRange: '$2500-5,000+',
    description: 'More complex UI/UX, multiple features',
    features: [
      'Push notifications, payments, user roles, etc.',
      'Support for more platforms',
      'More backend complexity',
      'Integration with APIs',
      'Testing / QA / perhaps maintenance contract',
    ],
    popular: true,
  },
  {
    id: 'app-enterprise',
    name: 'Enterprise / Custom Large-Scale App',
    price: 12500,
    priceRange: '$10,000-15,000+ (or more)',
    description: 'Complex enterprise features',
    features: [
      'Multi-platform (iOS, Android, Web)',
      'High performance, security, possibly offline features',
      'Ongoing updates, support, scaling',
      'Possibly custom hardware integration or advanced features (AI, AR, etc.)',
    ],
    popular: false,
  },
];

export const WEBSITE_MAINTENANCE_TIERS = [
  {
    id: 'maintenance-basic',
    name: 'Basic Care',
    price: 100,
    priceRange: '$100 ≈ JMD 16,200',
    description: 'Small websites (brochure sites, simple portfolios)',
    features: [
      'Monthly updates (WordPress/core/plugins)',
      'Security scans + malware protection',
      'Monthly backup',
      'Uptime monitoring',
      '1 small content update/month',
    ],
    popular: false,
  },
  {
    id: 'maintenance-standard',
    name: 'Standard Support',
    price: 250,
    priceRange: '$250 ≈ JMD 40,400',
    description: 'Growing businesses with moderate updates',
    features: [
      'Everything in Basic',
      'Bi-weekly backups',
      'Speed/performance checks',
      'Up to 3 content updates/month',
      'Contact form + basic troubleshooting',
      'Monthly report',
    ],
    popular: true,
  },
  {
    id: 'maintenance-business',
    name: 'Business Growth',
    price: 500,
    priceRange: '$500 ≈ JMD 81,000',
    description: 'Companies relying on their website for leads/sales',
    features: [
      'Everything in Standard',
      'Weekly backups + advanced security',
      'SEO monitoring (keywords, Google ranking check)',
      'Up to 5 content updates/month',
      'Small design tweaks (banners, images, etc.)',
      'Priority support (24-48hr response)',
    ],
    popular: false,
  },
  {
    id: 'maintenance-premium',
    name: 'Premium / Enterprise',
    price: 1000,
    priceRange: '$1,000+ ≈ JMD 162,000+',
    description: 'High-traffic sites, e-commerce, or mission-critical websites',
    features: [
      'Everything in Business Growth',
      'Daily backups + firewall & DDoS protection',
      'Unlimited content updates',
      'Advanced SEO reports + recommendations',
      'Conversion tracking setup (Google Analytics, Ads)',
      'Dedicated account manager',
      'Emergency support (same-day response)',
    ],
    popular: false,
  },
];

export const APP_MAINTENANCE_TIERS = [
  {
    id: 'app-maintenance-basic',
    name: 'Basic Care',
    price: 350,
    priceRange: '$200-500/month ≈ JMD 32,500-81,000',
    description: 'Simple app / minimal usage user base, stable features',
    features: [
      'Bug fixes',
      'OS version compatibility updates',
      'Hosting & infrastructure',
      'Security patches',
      'Monthly report',
      'Small UI tweaks or content changes (few hrs)',
    ],
    popular: false,
  },
  {
    id: 'app-maintenance-standard',
    name: 'Standard Support',
    price: 975,
    priceRange: '$750-1,200/month ≈ JMD 122,000-195,000',
    description: 'Moderate complexity app, some integrations, regular usage, want minor enhancements',
    features: [
      'All Basic features',
      'Update of third-party libraries / APIs',
      'Performance & crash monitoring',
      'More hours/month for small enhancements',
      'Requests for critical bugs (e.g. response within 24 hrs)',
      'Biweekly or twice monthly reporting',
    ],
    popular: true,
  },
  {
    id: 'app-maintenance-premium',
    name: 'Premium / Growth',
    price: 2750,
    priceRange: '$2,000-3,500/month ≈ JMD 325,000-567,000',
    description: 'Growing app, multiple platforms, frequent updates, higher user base, more demand for features',
    features: [
      'All Standard features',
      'Proactive feature enhancements',
      'Dedicated support contact with priority response',
      'More frequent releases / sprints of improvements',
      'Advanced analytics, conversion optimization',
      'Scalability / performance optimisation',
    ],
    popular: false,
  },
  {
    id: 'app-maintenance-enterprise',
    name: 'Enterprise / Mission-Critical',
    price: 6500,
    priceRange: '$5,000-8,000+/month ≈ JMD 810,000-1.3+ million+',
    description: 'Large scale app, many users, integrations, possibly regulatory / compliance, high SLA demands',
    features: [
      'All Premium features',
      'Very fast response SLAs',
      'Onboarding / offboarding / security audits',
      'API / backend scaling & high availability',
      'Frequent updates & large enhancements',
      'Possibly multi-region, multi-platform maintenance',
    ],
    popular: false,
  },
];

// Helper function to get all tiers
export const ALL_SERVICE_TIERS = {
  adManagement: AD_MANAGEMENT_TIERS,
  seo: SEO_TIERS,
  socialMedia: SOCIAL_MEDIA_TIERS,
  webDevelopment: WEB_DEVELOPMENT_TIERS,
  appCreation: APP_CREATION_TIERS,
  websiteMaintenance: WEBSITE_MAINTENANCE_TIERS,
  appMaintenance: APP_MAINTENANCE_TIERS,
};

// Helper function to map service slugs to tier IDs
function mapServiceSlugToTierId(serviceSlug: string): string {
  // Map database slugs to tier IDs
  const slugMappings: Record<string, string> = {
    // Ad Management
    'ad-management-starter': 'ad-starter',
    'ad-management-growth': 'ad-growth',
    'ad-management-premium': 'ad-premium',
    'ad-management-enterprise': 'ad-enterprise',
    
    // Website Creation
    'website-creation-starter': 'web-starter',
    'website-creation-growth': 'web-growth',
    'website-creation-premium': 'web-premium',
    
    // App Creation
    'app-creation-mvp': 'app-mvp',
    'app-creation-growth': 'app-growth',
    'app-creation-enterprise': 'app-enterprise',
    
    // App Maintenance
    'app-maintenance-basic': 'app-maintenance-basic',
    'app-maintenance-standard': 'app-maintenance-standard',
    'app-maintenance-premium': 'app-maintenance-premium',
    'app-maintenance-enterprise': 'app-maintenance-enterprise',
    
    // Website Maintenance
    'website-maintenance-basic': 'maintenance-basic',
    'website-maintenance-standard': 'maintenance-standard',
    'website-maintenance-business': 'maintenance-business',
    'website-maintenance-premium': 'maintenance-premium',
    
    // Social Media
    'social-media-basic': 'social-basic',
    'social-media-growth': 'social-growth',
    'social-media-pro': 'social-pro',
  };
  
  // Return mapped ID or original slug (for SEO tiers which already match)
  return slugMappings[serviceSlug] || serviceSlug;
}

// Helper function to find a tier by ID
export function getTierById(tierId: string) {
  const allTiers = [
    ...AD_MANAGEMENT_TIERS,
    ...SEO_TIERS,
    ...SOCIAL_MEDIA_TIERS,
    ...WEB_DEVELOPMENT_TIERS,
    ...APP_CREATION_TIERS,
    ...WEBSITE_MAINTENANCE_TIERS,
    ...APP_MAINTENANCE_TIERS,
  ];
  
  // Map the service slug to tier ID before searching
  const mappedId = mapServiceSlugToTierId(tierId);
  return allTiers.find(tier => tier.id === mappedId);
}

// ==========================================
// File: lib/proposal-types.ts
// ==========================================


// Types for proposal system

export interface ProposalItem {
  id: string;
  type: 'service' | 'custom';
  name: string;
  description: string;
  quantity: number;
  unitPrice: number;
  total: number;
  serviceId?: string; // Reference to predefined service
}

export interface Proposal {
  id: string;
  leadId?: string;
  clientName: string;
  clientEmail: string;
  clientPhone?: string;
  clientCompany?: string;
  proposalNumber: string;
  title: string;
  description?: string;
  status: 'draft' | 'sent' | 'viewed' | 'accepted' | 'declined' | 'expired';
  items: ProposalItem[];
  subtotal: number;
  tax: number;
  discount: number;
  total: number;
  terms?: string;
  notes?: string;
  dueDate?: Date;
  validUntil?: Date;
  stripePaymentLinkId?: string;
  stripePaymentUrl?: string;
  createdById: string;
  sentAt?: Date;
  viewedAt?: Date;
  acceptedAt?: Date;
  declinedAt?: Date;
  paidAt?: Date;
  pdfUrl?: string;
  createdAt: Date;
  updatedAt: Date;
  lead?: any;
}

export interface ProposalFormData {
  leadId?: string;
  clientName: string;
  clientEmail: string;
  clientPhone?: string;
  clientCompany?: string;
  title: string;
  description?: string;
  items: ProposalItem[];
  tax: number;
  discount: number;
  terms?: string;
  notes?: string;
  dueDate?: string;
  validUntil?: string;
}

export const DEFAULT_TERMS = `Payment Terms:
• 50% deposit required to begin work
• Remaining balance due upon project completion
• Payment accepted via credit card, bank transfer, or check
• Late payments subject to 1.5% monthly interest charge

Project Terms:
• All work is subject to our standard service agreement
• Revisions beyond the agreed scope will be billed separately
• Client to provide all required materials and content within agreed timelines
• CDM Suite retains the right to showcase completed work in portfolio

Cancellation Policy:
• Projects may be cancelled with 7 days written notice
• Deposits are non-refundable
• Work completed to date will be billed at our hourly rate

By accepting this proposal, you agree to these terms and conditions.`;

export function generateProposalNumber(): string {
  const year = new Date().getFullYear();
  const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  return `PROP-${year}-${random}`;
}

export function calculateProposalTotals(
  items: ProposalItem[],
  tax: number = 0,
  discount: number = 0
) {
  const subtotal = items.reduce((sum, item) => sum + item.total, 0);
  const discountAmount = discount;
  const taxAmount = ((subtotal - discountAmount) * tax) / 100;
  const total = subtotal - discountAmount + taxAmount;

  return {
    subtotal,
    taxAmount,
    discountAmount,
    total,
  };
}

// ==========================================
// File: lib/reddit-tracking.ts
// ==========================================


// Reddit Pixel Tracking utilities with deduplication and enhanced attribution
// This file provides utilities for tracking Reddit Pixel events with deduplication support

/**
 * Generate a unique conversion ID for deduplication
 * Format: timestamp-random-eventType
 */
export function generateConversionId(eventType: string): string {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substring(2, 15);
  return `${timestamp}-${random}-${eventType}`;
}

/**
 * Get Reddit click ID from URL parameters
 */
function getRedditClickId(): string | null {
  if (typeof window === 'undefined') return null;
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('rdt_cid') || urlParams.get('click_id');
}

/**
 * Get screen dimensions
 */
function getScreenDimensions() {
  if (typeof window === 'undefined') return null;
  return {
    width: window.screen.width,
    height: window.screen.height,
  };
}

/**
 * Track a Reddit Pixel event with deduplication and enhanced attribution
 * This sends the event both client-side (via rdt()) and server-side (via API)
 */
export async function trackRedditEvent(
  eventType: string,
  options?: {
    customEventName?: string;
    email?: string;
    phoneNumber?: string;
    externalId?: string;
    value?: number;
    currency?: string;
    itemCount?: number;
    products?: Array<{
      id: string;
      name: string;
      category?: string;
    }>;
    conversionId?: string;
    testId?: string;
  }
) {
  try {
    // Generate conversion ID if not provided
    const conversionId = options?.conversionId || generateConversionId(eventType);
    
    // Get click ID for attribution
    const clickId = getRedditClickId();
    
    // Get screen dimensions
    const screenDimensions = getScreenDimensions();

    // Track client-side via Reddit Pixel
    if (typeof window !== 'undefined' && (window as any).rdt) {
      const eventData: any = {
        conversionId,
      };

      // Add optional parameters
      if (options?.email) eventData.email = options.email;
      if (options?.value) eventData.value = options.value;
      if (options?.currency) eventData.currency = options.currency;
      if (options?.itemCount) eventData.itemCount = options.itemCount;

      // Track the event
      if (eventType === 'custom' && options?.customEventName) {
        (window as any).rdt('track', 'Custom', {
          ...eventData,
          customEventName: options.customEventName,
        });
      } else {
        (window as any).rdt('track', eventType, eventData);
      }
    }

    // Build user data for server-side tracking
    const userData: any = {};
    
    if (options?.phoneNumber) userData.phoneNumber = options.phoneNumber;
    if (options?.externalId) userData.externalId = options.externalId;
    if (screenDimensions) {
      userData.screenWidth = screenDimensions.width;
      userData.screenHeight = screenDimensions.height;
    }

    // Track server-side via Conversions API with enhanced parameters
    const response = await fetch('/api/analytics/reddit-conversion', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        eventType,
        customEventName: options?.customEventName,
        clickId,
        testId: options?.testId, // For testing events
        userData: Object.keys(userData).length > 0 ? userData : undefined,
        eventMetadata: {
          conversionId, // REQUIRED for deduplication
          email: options?.email,
          value: options?.value,
          currency: options?.currency,
          itemCount: options?.itemCount,
          products: options?.products,
        },
      }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.error('Server-side Reddit conversion failed:', errorData);
      throw new Error(JSON.stringify(errorData));
    }

    const result = await response.json();
    console.log('Server-side Reddit conversion success:', result);

    return conversionId;
  } catch (error) {
    console.error('Error tracking Reddit event:', error);
    throw error; // Re-throw so calling code can handle it
  }
}

/**
 * Track a signup event
 */
export async function trackRedditSignup(email?: string): Promise<string> {
  return (await trackRedditEvent('SignUp', { email })) || '';
}

/**
 * Track a lead event (form submission)
 */
export async function trackRedditLead(email?: string): Promise<string> {
  return (await trackRedditEvent('Lead', { email })) || '';
}

/**
 * Track a purchase event with e-commerce details
 */
export async function trackRedditPurchase(
  value: number,
  currency: string = 'USD',
  options?: {
    email?: string;
    phoneNumber?: string;
    itemCount?: number;
    products?: Array<{
      id: string;
      name: string;
      category?: string;
    }>;
  }
): Promise<string> {
  return (await trackRedditEvent('Purchase', { 
    value, 
    currency, 
    email: options?.email,
    phoneNumber: options?.phoneNumber,
    itemCount: options?.itemCount,
    products: options?.products,
  })) || '';
}

/**
 * Track a custom event
 */
export async function trackRedditCustomEvent(
  eventName: string,
  email?: string
): Promise<string> {
  return (
    (await trackRedditEvent('custom', { customEventName: eventName, email })) || ''
  );
}

/**
 * Track a page view
 */
export function trackRedditPageView() {
  if (typeof window !== 'undefined' && (window as any).rdt) {
    (window as any).rdt('track', 'PageVisit');
  }
}

/**
 * Track a view content event
 */
export function trackRedditViewContent(contentName?: string) {
  if (typeof window !== 'undefined' && (window as any).rdt) {
    const eventData: any = {};
    if (contentName) eventData.itemId = contentName;
    (window as any).rdt('track', 'ViewContent', eventData);
  }
}

/**
 * Track an add to cart event
 */
export function trackRedditAddToCart(value?: number, currency: string = 'USD') {
  if (typeof window !== 'undefined' && (window as any).rdt) {
    const eventData: any = {};
    if (value) {
      eventData.value = value;
      eventData.currency = currency;
    }
    (window as any).rdt('track', 'AddToCart', eventData);
  }
}

// ==========================================
// File: lib/resend-client.ts
// ==========================================

import { Resend } from 'resend';

let resendClient: Resend | null = null;

export function getResendClient(): Resend | null {
  const apiKey = process.env.RESEND_API_KEY;

  if (!apiKey) {
    console.warn('⚠️  RESEND_API_KEY not configured. Emails will be logged to console only.');
    return null;
  }

  if (!resendClient) {
    resendClient = new Resend(apiKey);
  }

  return resendClient;
}
// ==========================================
// File: lib/roles.ts
// ==========================================


// Role-based access control types and utilities

export const USER_ROLES = {
  ADMIN: 'admin',
  EMPLOYEE: 'employee',
  CLIENT: 'client',
} as const;

export type UserRole = typeof USER_ROLES[keyof typeof USER_ROLES];

export const EMPLOYEE_ROLES = {
  ACCOUNT_MANAGER: 'account_manager',
  SALES_REP: 'sales_rep',
  DEVELOPER: 'developer',
  DESIGNER: 'designer',
  SEO_SPECIALIST: 'seo_specialist',
  CONTENT_WRITER: 'content_writer',
} as const;

export type EmployeeRole = typeof EMPLOYEE_ROLES[keyof typeof EMPLOYEE_ROLES];

export const DEPARTMENTS = {
  SALES: 'sales',
  FULFILLMENT: 'fulfillment',
  MARKETING: 'marketing',
  DEVELOPMENT: 'development',
} as const;

export type Department = typeof DEPARTMENTS[keyof typeof DEPARTMENTS];

// Capability/Permission definitions
export interface EmployeeCapabilities {
  // AI & Automation
  canApproveSequences: boolean;
  canCreateSequences: boolean;
  canViewAIRecommendations: boolean;
  canApproveAIRecommendations: boolean;
  
  // Project Management
  canViewAllProjects: boolean;
  canViewAssignedProjects: boolean;
  canEditProjects: boolean;
  canDeleteProjects: boolean;
  canAssignProjects: boolean;
  
  // Task Management
  canCreateTasks: boolean;
  canEditTasks: boolean;
  canDeleteTasks: boolean;
  canReassignTasks: boolean;
  
  // File Management
  canUploadFiles: boolean;
  canViewClientFiles: boolean;
  canEditClientFiles: boolean;
  canDeleteFiles: boolean;
  
  // Client Communication
  canMessageClients: boolean;
  canViewClientMessages: boolean;
  canSendClientEmails: boolean;
  
  // Lead Management
  canViewLeads: boolean;
  canCreateLeads: boolean;
  canEditLeads: boolean;
  canDeleteLeads: boolean;
  canAssignLeads: boolean;
  
  // Time Tracking
  canLogTime: boolean;
  canApproveTime: boolean;
  canViewTeamTime: boolean;
  
  // Analytics & Reports
  canViewAnalytics: boolean;
  canViewFinancials: boolean;
  canExportReports: boolean;
  
  // Employee Management
  canManageEmployees: boolean;
  canViewEmployeePerformance: boolean;
}

// Default capabilities by role
export const DEFAULT_CAPABILITIES: Record<EmployeeRole, EmployeeCapabilities> = {
  [EMPLOYEE_ROLES.ACCOUNT_MANAGER]: {
    canApproveSequences: true,
    canCreateSequences: true,
    canViewAIRecommendations: true,
    canApproveAIRecommendations: true,
    canViewAllProjects: true,
    canViewAssignedProjects: true,
    canEditProjects: true,
    canDeleteProjects: false,
    canAssignProjects: true,
    canCreateTasks: true,
    canEditTasks: true,
    canDeleteTasks: true,
    canReassignTasks: true,
    canUploadFiles: true,
    canViewClientFiles: true,
    canEditClientFiles: true,
    canDeleteFiles: false,
    canMessageClients: true,
    canViewClientMessages: true,
    canSendClientEmails: true,
    canViewLeads: true,
    canCreateLeads: true,
    canEditLeads: true,
    canDeleteLeads: false,
    canAssignLeads: true,
    canLogTime: true,
    canApproveTime: false,
    canViewTeamTime: true,
    canViewAnalytics: true,
    canViewFinancials: true,
    canExportReports: true,
    canManageEmployees: false,
    canViewEmployeePerformance: true,
  },
  [EMPLOYEE_ROLES.SALES_REP]: {
    canApproveSequences: false,
    canCreateSequences: false,
    canViewAIRecommendations: true,
    canApproveAIRecommendations: false,
    canViewAllProjects: false,
    canViewAssignedProjects: true,
    canEditProjects: true,
    canDeleteProjects: false,
    canAssignProjects: false,
    canCreateTasks: true,
    canEditTasks: true,
    canDeleteTasks: false,
    canReassignTasks: false,
    canUploadFiles: true,
    canViewClientFiles: true,
    canEditClientFiles: false,
    canDeleteFiles: false,
    canMessageClients: true,
    canViewClientMessages: true,
    canSendClientEmails: true,
    canViewLeads: true,
    canCreateLeads: true,
    canEditLeads: true,
    canDeleteLeads: false,
    canAssignLeads: false,
    canLogTime: true,
    canApproveTime: false,
    canViewTeamTime: false,
    canViewAnalytics: true,
    canViewFinancials: false,
    canExportReports: true,
    canManageEmployees: false,
    canViewEmployeePerformance: false,
  },
  [EMPLOYEE_ROLES.DEVELOPER]: {
    canApproveSequences: false,
    canCreateSequences: false,
    canViewAIRecommendations: true,
    canApproveAIRecommendations: false,
    canViewAllProjects: true, // Changed to true - devs need to see all projects
    canViewAssignedProjects: true,
    canEditProjects: true,
    canDeleteProjects: false,
    canAssignProjects: false,
    canCreateTasks: true,
    canEditTasks: true,
    canDeleteTasks: false,
    canReassignTasks: false,
    canUploadFiles: true,
    canViewClientFiles: true,
    canEditClientFiles: true,
    canDeleteFiles: false,
    canMessageClients: true,
    canViewClientMessages: true,
    canSendClientEmails: false,
    canViewLeads: true, // Changed to true - all employees can see leads
    canCreateLeads: true, // Changed to true - all employees can create leads
    canEditLeads: true, // Changed to true - all employees can edit leads
    canDeleteLeads: false,
    canAssignLeads: false,
    canLogTime: true,
    canApproveTime: false,
    canViewTeamTime: false,
    canViewAnalytics: true, // Changed to true
    canViewFinancials: false,
    canExportReports: false,
    canManageEmployees: false,
    canViewEmployeePerformance: false,
  },
  [EMPLOYEE_ROLES.DESIGNER]: {
    canApproveSequences: false,
    canCreateSequences: false,
    canViewAIRecommendations: true,
    canApproveAIRecommendations: false,
    canViewAllProjects: true, // Changed to true - designers need to see all projects
    canViewAssignedProjects: true,
    canEditProjects: true,
    canDeleteProjects: false,
    canAssignProjects: false,
    canCreateTasks: true,
    canEditTasks: true,
    canDeleteTasks: false,
    canReassignTasks: false,
    canUploadFiles: true,
    canViewClientFiles: true,
    canEditClientFiles: true,
    canDeleteFiles: false,
    canMessageClients: true,
    canViewClientMessages: true,
    canSendClientEmails: false,
    canViewLeads: true, // Changed to true - all employees can see leads
    canCreateLeads: true, // Changed to true - all employees can create leads
    canEditLeads: true, // Changed to true - all employees can edit leads
    canDeleteLeads: false,
    canAssignLeads: false,
    canLogTime: true,
    canApproveTime: false,
    canViewTeamTime: false,
    canViewAnalytics: true, // Changed to true
    canViewFinancials: false,
    canExportReports: false,
    canManageEmployees: false,
    canViewEmployeePerformance: false,
  },
  [EMPLOYEE_ROLES.SEO_SPECIALIST]: {
    canApproveSequences: false,
    canCreateSequences: true, // Changed to true - SEO specialists create content sequences
    canViewAIRecommendations: true,
    canApproveAIRecommendations: false,
    canViewAllProjects: true, // Changed to true - SEO specialists need to see all projects
    canViewAssignedProjects: true,
    canEditProjects: true,
    canDeleteProjects: false,
    canAssignProjects: false,
    canCreateTasks: true,
    canEditTasks: true,
    canDeleteTasks: false,
    canReassignTasks: false,
    canUploadFiles: true,
    canViewClientFiles: true,
    canEditClientFiles: false,
    canDeleteFiles: false,
    canMessageClients: true,
    canViewClientMessages: true,
    canSendClientEmails: false,
    canViewLeads: true, // Changed to true - all employees can see leads
    canCreateLeads: true, // Changed to true - all employees can create leads
    canEditLeads: true, // Changed to true - all employees can edit leads
    canDeleteLeads: false,
    canAssignLeads: false,
    canLogTime: true,
    canApproveTime: false,
    canViewTeamTime: false,
    canViewAnalytics: true,
    canViewFinancials: false,
    canExportReports: true,
    canManageEmployees: false,
    canViewEmployeePerformance: false,
  },
  [EMPLOYEE_ROLES.CONTENT_WRITER]: {
    canApproveSequences: false,
    canCreateSequences: true, // Changed to true - content writers create content
    canViewAIRecommendations: true,
    canApproveAIRecommendations: false,
    canViewAllProjects: true, // Changed to true - content writers need to see all projects
    canViewAssignedProjects: true,
    canEditProjects: true,
    canDeleteProjects: false,
    canAssignProjects: false,
    canCreateTasks: true,
    canEditTasks: true,
    canDeleteTasks: false,
    canReassignTasks: false,
    canUploadFiles: true,
    canViewClientFiles: true,
    canEditClientFiles: false,
    canDeleteFiles: false,
    canMessageClients: true,
    canViewClientMessages: true,
    canSendClientEmails: false,
    canViewLeads: true, // Changed to true - all employees can see leads
    canCreateLeads: true, // Changed to true - all employees can create leads
    canEditLeads: true, // Changed to true - all employees can edit leads
    canDeleteLeads: false,
    canAssignLeads: false,
    canLogTime: true,
    canApproveTime: false,
    canViewTeamTime: false,
    canViewAnalytics: true, // Changed to true
    canViewFinancials: false,
    canExportReports: false,
    canManageEmployees: false,
    canViewEmployeePerformance: false,
  },
};

// Admin has all capabilities
export const ADMIN_CAPABILITIES: EmployeeCapabilities = {
  canApproveSequences: true,
  canCreateSequences: true,
  canViewAIRecommendations: true,
  canApproveAIRecommendations: true,
  canViewAllProjects: true,
  canViewAssignedProjects: true,
  canEditProjects: true,
  canDeleteProjects: true,
  canAssignProjects: true,
  canCreateTasks: true,
  canEditTasks: true,
  canDeleteTasks: true,
  canReassignTasks: true,
  canUploadFiles: true,
  canViewClientFiles: true,
  canEditClientFiles: true,
  canDeleteFiles: true,
  canMessageClients: true,
  canViewClientMessages: true,
  canSendClientEmails: true,
  canViewLeads: true,
  canCreateLeads: true,
  canEditLeads: true,
  canDeleteLeads: true,
  canAssignLeads: true,
  canLogTime: true,
  canApproveTime: true,
  canViewTeamTime: true,
  canViewAnalytics: true,
  canViewFinancials: true,
  canExportReports: true,
  canManageEmployees: true,
  canViewEmployeePerformance: true,
};

// Check if user has admin role
export function isAdmin(userRole: string): boolean {
  return userRole?.toLowerCase() === USER_ROLES.ADMIN;
}

// Check if user is an employee
export function isEmployee(userRole: string): boolean {
  return userRole?.toLowerCase() === USER_ROLES.EMPLOYEE;
}

// Check if user is a client
export function isClient(userRole: string): boolean {
  return userRole?.toLowerCase() === USER_ROLES.CLIENT;
}

// Get capabilities for a user
export function getUserCapabilities(
  userRole: string,
  employeeRole?: string,
  customCapabilities?: Partial<EmployeeCapabilities>
): EmployeeCapabilities {
  // Admin has all capabilities
  if (isAdmin(userRole)) {
    return ADMIN_CAPABILITIES;
  }

  // If not admin or employee, return empty capabilities
  if (!isEmployee(userRole)) {
    return Object.keys(ADMIN_CAPABILITIES).reduce((acc, key) => {
      acc[key as keyof EmployeeCapabilities] = false;
      return acc;
    }, {} as EmployeeCapabilities);
  }

  // Get default capabilities for employee role
  const defaultCaps = employeeRole && employeeRole in DEFAULT_CAPABILITIES
    ? DEFAULT_CAPABILITIES[employeeRole as EmployeeRole]
    : DEFAULT_CAPABILITIES[EMPLOYEE_ROLES.DEVELOPER];

  // Merge with custom capabilities if provided
  return {
    ...defaultCaps,
    ...customCapabilities,
  };
}

// Check if user has a specific capability
export function hasCapability(
  capabilities: EmployeeCapabilities,
  capability: keyof EmployeeCapabilities
): boolean {
  return capabilities[capability] || false;
}

// Get role display name
export function getRoleDisplayName(role: string): string {
  const roleNames: Record<string, string> = {
    admin: 'Administrator',
    employee: 'Employee',
    client: 'Client',
    account_manager: 'Account Manager',
    sales_rep: 'Sales Representative',
    developer: 'Developer',
    designer: 'Designer',
    seo_specialist: 'SEO Specialist',
    content_writer: 'Content Writer',
  };

  return roleNames[role] || role;
}

// Get department display name
export function getDepartmentDisplayName(department: string): string {
  const deptNames: Record<string, string> = {
    sales: 'Sales',
    fulfillment: 'Fulfillment',
    marketing: 'Marketing',
    development: 'Development',
  };

  return deptNames[department] || department;
}

// ==========================================
// File: lib/s3.ts
// ==========================================


import { 
  PutObjectCommand, 
  GetObjectCommand, 
  DeleteObjectCommand,
  CopyObjectCommand,
  DeleteObjectsCommand
} from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';
import { createS3Client, getBucketConfig } from './aws-config';

const s3Client = createS3Client();
const { bucketName, folderPrefix } = getBucketConfig();

/**
 * Upload a file to S3
 * @param buffer File buffer
 * @param fileName Original file name
 * @param contentType MIME type of the file
 * @returns S3 key (cloud_storage_path)
 */
export async function uploadFile(
  buffer: Buffer,
  fileName: string,
  contentType: string
): Promise<string> {
  const timestamp = Date.now();
  const sanitizedFileName = fileName.replace(/[^a-zA-Z0-9.-]/g, '_');
  const key = `${folderPrefix}uploads/${timestamp}-${sanitizedFileName}`;

  const command = new PutObjectCommand({
    Bucket: bucketName,
    Key: key,
    Body: buffer,
    ContentType: contentType,
  });

  await s3Client.send(command);
  return key;
}

/**
 * Get a signed URL for downloading a file
 * @param key S3 key (cloud_storage_path)
 * @param expiresIn URL expiration time in seconds (default: 1 hour)
 * @returns Signed URL
 */
export async function getFileUrl(
  key: string,
  expiresIn: number = 3600
): Promise<string> {
  const command = new GetObjectCommand({
    Bucket: bucketName,
    Key: key,
  });

  return await getSignedUrl(s3Client, command, { expiresIn });
}

/**
 * Download a file from S3 as a Buffer
 * @param key S3 key (cloud_storage_path)
 * @returns File buffer
 */
export async function downloadFile(key: string): Promise<Buffer> {
  const command = new GetObjectCommand({
    Bucket: bucketName,
    Key: key,
  });

  const response = await s3Client.send(command);
  
  // Convert stream to buffer
  const stream = response.Body as any;
  const chunks: Buffer[] = [];
  
  for await (const chunk of stream) {
    chunks.push(Buffer.from(chunk));
  }
  
  return Buffer.concat(chunks);
}

/**
 * Delete a file from S3
 * @param key S3 key (cloud_storage_path)
 */
export async function deleteFile(key: string): Promise<void> {
  const command = new DeleteObjectCommand({
    Bucket: bucketName,
    Key: key,
  });

  await s3Client.send(command);
}

/**
 * Delete multiple files from S3
 * @param keys Array of S3 keys (cloud_storage_paths)
 */
export async function deleteFiles(keys: string[]): Promise<void> {
  if (keys.length === 0) return;

  const command = new DeleteObjectsCommand({
    Bucket: bucketName,
    Delete: {
      Objects: keys.map(key => ({ Key: key })),
    },
  });

  await s3Client.send(command);
}

/**
 * Rename/move a file in S3
 * @param oldKey Current S3 key
 * @param newKey New S3 key
 */
export async function renameFile(oldKey: string, newKey: string): Promise<string> {
  // Copy to new location
  const copyCommand = new CopyObjectCommand({
    Bucket: bucketName,
    CopySource: `${bucketName}/${oldKey}`,
    Key: newKey,
  });
  await s3Client.send(copyCommand);

  // Delete old file
  await deleteFile(oldKey);

  return newKey;
}

// ==========================================
// File: lib/sequence-executor.ts
// ==========================================

/**
 * Sequence Execution Engine
 * Processes sequence steps and executes actions (email, SMS, tasks)
 */

import { prisma } from '@/lib/db';
import { emailService } from '@/lib/email';
import { smsService } from '@/lib/sms';

interface ExecutionResult {
  success: boolean;
  error?: string;
  details?: any;
}

class SequenceExecutor {
  /**
   * Process all active sequence assignments and execute pending steps
   */
  async processSequences(): Promise<{
    processed: number;
    executed: number;
    failed: number;
  }> {
    const stats = { processed: 0, executed: 0, failed: 0 };

    try {
      // Find all active sequence assignments
      const activeAssignments = await prisma.sequenceAssignment.findMany({
        where: {
          status: 'active',
          completedAt: null,
        },
        include: {
          lead: true,
          sequence: {
            include: {
              steps: {
                orderBy: { order: 'asc' },
                where: { active: true },
              },
            },
          },
        },
      });

      console.log(`Found ${activeAssignments.length} active sequence assignments`);
      stats.processed = activeAssignments.length;

      for (const assignment of activeAssignments) {
        try {
          const executed = await this.processAssignment(assignment);
          if (executed) {
            stats.executed++;
          }
        } catch (error) {
          console.error(
            `Error processing sequence assignment ${assignment.id}:`,
            error
          );
          stats.failed++;
        }
      }

      return stats;
    } catch (error) {
      console.error('Error in sequence processing:', error);
      throw error;
    }
  }

  /**
   * Process a single sequence assignment
   */
  private async processAssignment(assignment: any): Promise<boolean> {
    const { lead, sequence, currentStep } = assignment;
    const steps = sequence.steps;

    if (!steps || steps.length === 0) {
      console.log(`No steps found for sequence ${sequence.id}`);
      return false;
    }

    // Get the step to execute
    const stepToExecute = steps.find((s: any) => s.order === currentStep);

    if (!stepToExecute) {
      // Sequence completed
      await this.completeAssignment(assignment.id);
      return false;
    }

    // Check if it's time to execute this step
    const shouldExecute = await this.shouldExecuteStep(assignment, stepToExecute);

    if (!shouldExecute) {
      return false;
    }

    // Execute the step
    const result = await this.executeStep(lead, stepToExecute);

    // Log the activity
    await prisma.sequenceActivity.create({
      data: {
        assignmentId: assignment.id,
        stepOrder: stepToExecute.order,
        actionType: this.getActionType(stepToExecute.stepType, result.success),
        result: result.details ? JSON.stringify(result.details) : null,
        messageId: result.details?.messageId,
        error: result.error,
      },
    });

    // Update metrics
    await this.updateMetrics(assignment, stepToExecute, result.success);

    if (result.success) {
      // Move to next step
      const nextStepOrder = currentStep + 1;
      const nextStep = steps.find((s: any) => s.order === nextStepOrder);

      if (!nextStep) {
        // Sequence completed
        await this.completeAssignment(assignment.id);
      } else {
        // Move to next step
        await prisma.sequenceAssignment.update({
          where: { id: assignment.id },
          data: {
            currentStep: nextStepOrder,
            stepsCompleted: { increment: 1 },
            startedAt: assignment.startedAt || new Date(),
          },
        });
      }

      return true;
    } else {
      // Handle failure
      console.error(
        `Step execution failed for lead ${lead.id}, step ${stepToExecute.order}:`,
        result.error
      );

      return false;
    }
  }

  /**
   * Get action type based on step type and success
   */
  private getActionType(stepType: string, success: boolean): string {
    if (!success) {
      return `${stepType.toLowerCase()}_failed`;
    }
    return `${stepType.toLowerCase()}_sent`;
  }

  /**
   * Check if a step should be executed based on timing
   */
  private async shouldExecuteStep(assignment: any, step: any): Promise<boolean> {
    const now = new Date();

    // If this is the first step and assignment just started
    if (assignment.currentStep === 0 || !assignment.startedAt) {
      return true;
    }

    // Get the last activity for this assignment
    const lastActivity = await prisma.sequenceActivity.findFirst({
      where: { assignmentId: assignment.id },
      orderBy: { timestamp: 'desc' },
    });

    if (!lastActivity) {
      return true;
    }

    // Calculate when the step should execute based on delay
    const delayAmount = step.delayAmount || 0;
    const delayUnit = step.delayUnit || 'hours';

    const delayInMs = this.getDelayInMilliseconds(delayAmount, delayUnit);
    const executeAt = new Date(lastActivity.timestamp.getTime() + delayInMs);

    return now >= executeAt;
  }

  /**
   * Convert delay to milliseconds
   */
  private getDelayInMilliseconds(amount: number, unit: string): number {
    const multipliers: Record<string, number> = {
      minutes: 60 * 1000,
      hours: 60 * 60 * 1000,
      days: 24 * 60 * 60 * 1000,
      weeks: 7 * 24 * 60 * 60 * 1000,
    };

    return amount * (multipliers[unit] || multipliers.hours);
  }

  /**
   * Execute a sequence step
   */
  private async executeStep(lead: any, step: any): Promise<ExecutionResult> {
    console.log(
      `Executing step ${step.order} (${step.stepType}) for lead ${lead.email}`
    );

    try {
      switch (step.stepType.toLowerCase()) {
        case 'email':
          return await this.executeEmailStep(lead, step);

        case 'sms':
          return await this.executeSMSStep(lead, step);

        case 'task':
        case 'reminder':
        case 'note':
          return await this.executeTaskStep(lead, step);

        case 'delay':
          // Delay steps are handled by delayAmount
          return { success: true };

        default:
          return {
            success: false,
            error: `Unknown step type: ${step.stepType}`,
          };
      }
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error',
      };
    }
  }

  /**
   * Execute an email step
   */
  private async executeEmailStep(lead: any, step: any): Promise<ExecutionResult> {
    if (!lead.email) {
      return { success: false, error: 'Lead has no email address' };
    }

    // Personalize the email content
    const personalizedSubject = this.personalizeContent(
      step.subject || step.title || 'Message from CDM Suite',
      lead
    );
    const personalizedBody = this.personalizeContent(
      step.content || '',
      lead
    );

    // Send email
    const result = await emailService.sendEmail({
      to: lead.email,
      subject: personalizedSubject,
      html: this.formatEmailHTML(personalizedBody),
      tags: [
        { name: 'lead_id', value: lead.id },
        { name: 'step_order', value: step.order.toString() },
      ],
    });

    if (result.success) {
      // Create activity record
      await prisma.leadActivity.create({
        data: {
          leadId: lead.id,
          type: 'email',
          title: 'Sequence email sent',
          description: `Sent: ${personalizedSubject}`,
          metadata: JSON.stringify({ stepTitle: step.title }),
        },
      });
    }

    return result;
  }

  /**
   * Execute an SMS step
   */
  private async executeSMSStep(lead: any, step: any): Promise<ExecutionResult> {
    if (!lead.phone) {
      return { success: false, error: 'Lead has no phone number' };
    }

    // Personalize the SMS content
    const personalizedMessage = this.personalizeContent(
      step.content || '',
      lead
    );

    // Send SMS
    const result = await smsService.sendSMS(lead.phone, personalizedMessage);

    if (result.success) {
      // Create activity record
      await prisma.leadActivity.create({
        data: {
          leadId: lead.id,
          type: 'call',
          title: 'Sequence SMS sent',
          description: `SMS: ${step.title}`,
          metadata: JSON.stringify({ stepTitle: step.title }),
        },
      });
    }

    return result;
  }

  /**
   * Execute a task step
   */
  private async executeTaskStep(lead: any, step: any): Promise<ExecutionResult> {
    try {
      // Create a task/activity for the assigned user
      await prisma.leadActivity.create({
        data: {
          leadId: lead.id,
          type: 'note',
          title: step.title || 'Follow up task',
          description: step.content || '',
          createdById: lead.assignedToId || undefined,
        },
      });

      return { success: true };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error',
      };
    }
  }

  /**
   * Personalize content with lead data
   */
  private personalizeContent(content: string, lead: any): string {
    return content
      .replace(/\{\{name\}\}/g, lead.name || '')
      .replace(/\{\{email\}\}/g, lead.email || '')
      .replace(/\{\{phone\}\}/g, lead.phone || '')
      .replace(/\{\{company\}\}/g, lead.company || '');
  }

  /**
   * Format email body as HTML
   */
  private formatEmailHTML(body: string): string {
    // Convert line breaks to <br> tags
    const formattedBody = body.replace(/\n/g, '<br>');

    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
      </head>
      <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
        <div style="padding: 20px 0;">
          ${formattedBody}
        </div>
        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #666;">
          <p>CDM Suite - Creating Digital Magic</p>
          <p>This email was sent as part of an automated sequence.</p>
        </div>
      </body>
      </html>
    `;
  }

  /**
   * Complete a sequence assignment
   */
  private async completeAssignment(assignmentId: string): Promise<void> {
    await prisma.sequenceAssignment.update({
      where: { id: assignmentId },
      data: {
        status: 'completed',
        completedAt: new Date(),
      },
    });

    console.log(`Sequence assignment ${assignmentId} completed`);
  }

  /**
   * Update sequence assignment metrics
   */
  private async updateMetrics(
    assignment: any,
    step: any,
    success: boolean
  ): Promise<void> {
    // Increment execution count
    const updateData: any = {};

    const stepType = step.stepType.toLowerCase();

    if (stepType === 'email') {
      updateData.emailsSent = { increment: 1 };
    } else if (stepType === 'task' || stepType === 'reminder' || stepType === 'note') {
      updateData.tasksCreated = { increment: 1 };
    }

    if (Object.keys(updateData).length > 0) {
      await prisma.sequenceAssignment.update({
        where: { id: assignment.id },
        data: updateData,
      });
    }
  }

  /**
   * Handle email opened event
   */
  async handleEmailOpened(messageId: string): Promise<void> {
    // Find the activity by message ID
    const activity = await prisma.sequenceActivity.findFirst({
      where: { messageId },
      include: { assignment: true },
    });

    if (!activity) {
      console.log(`No activity found for message ID: ${messageId}`);
      return;
    }

    // Update the activity
    await prisma.sequenceActivity.update({
      where: { id: activity.id },
      data: { openedAt: new Date() },
    });

    // Update assignment metrics
    await prisma.sequenceAssignment.update({
      where: { id: activity.assignmentId },
      data: { emailsOpened: { increment: 1 } },
    });

    console.log(`Email opened: ${messageId}`);
  }

  /**
   * Handle email clicked event
   */
  async handleEmailClicked(messageId: string): Promise<void> {
    // Find the activity by message ID
    const activity = await prisma.sequenceActivity.findFirst({
      where: { messageId },
      include: { assignment: { include: { lead: true } } },
    });

    if (!activity) {
      console.log(`No activity found for message ID: ${messageId}`);
      return;
    }

    // Update the activity
    await prisma.sequenceActivity.update({
      where: { id: activity.id },
      data: { clickedAt: new Date() },
    });

    // Update assignment metrics
    await prisma.sequenceAssignment.update({
      where: { id: activity.assignmentId },
      data: { emailsClicked: { increment: 1 } },
    });

    // Update lead score
    await prisma.lead.update({
      where: { id: activity.assignment.leadId },
      data: { score: { increment: 10 } },
    });

    console.log(`Email clicked: ${messageId}`);
  }

  /**
   * Handle email replied event
   */
  async handleEmailReplied(messageId: string): Promise<void> {
    // Find the activity by message ID
    const activity = await prisma.sequenceActivity.findFirst({
      where: { messageId },
      include: { assignment: { include: { lead: true } } },
    });

    if (!activity) {
      console.log(`No activity found for message ID: ${messageId}`);
      return;
    }

    // Update the activity
    await prisma.sequenceActivity.update({
      where: { id: activity.id },
      data: { repliedAt: new Date() },
    });

    // Update assignment metrics
    await prisma.sequenceAssignment.update({
      where: { id: activity.assignmentId },
      data: {
        emailsReplied: { increment: 1 },
        status: 'paused', // Pause sequence on reply
      },
    });

    // Update lead score and status
    await prisma.lead.update({
      where: { id: activity.assignment.leadId },
      data: {
        status: 'qualified',
        score: { increment: 25 },
      },
    });

    // Create activity
    await prisma.leadActivity.create({
      data: {
        leadId: activity.assignment.leadId,
        type: 'email',
        title: 'Lead replied to sequence email',
        description: 'Sequence automatically paused due to reply',
      },
    });

    console.log(`Email replied: ${messageId}`);
  }
}

// Export singleton instance
export const sequenceExecutor = new SequenceExecutor();

// Export main function for cron job
export async function processSequenceQueue() {
  return await sequenceExecutor.processSequences();
}

// Export webhook handlers
export async function trackEmailOpen(messageId: string) {
  return await sequenceExecutor.handleEmailOpened(messageId);
}

export async function trackEmailClick(messageId: string) {
  return await sequenceExecutor.handleEmailClicked(messageId);
}

export async function trackEmailReply(messageId: string) {
  return await sequenceExecutor.handleEmailReplied(messageId);
}

// ==========================================
// File: lib/sequence-types.ts
// ==========================================


// Type definitions for sequence management

export interface SequenceStep {
  id?: string;
  order: number;
  stepType: 'email' | 'sms' | 'task' | 'reminder' | 'note' | 'delay';
  title: string;
  content?: string;
  subject?: string; // For email steps
  delayAmount: number;
  delayUnit: 'minutes' | 'hours' | 'days' | 'weeks';
  delayFrom: 'previous' | 'start';
  conditions?: any; // JSON conditions
  aiSuggested?: boolean;
  aiReasoning?: string;
  mergeTags?: string[];
  active?: boolean;
}

export interface Sequence {
  id: string;
  name: string;
  description?: string;
  type: 'email' | 'sms' | 'task' | 'mixed';
  targetAudience: string;
  aiGenerated: boolean;
  aiPrompt?: string;
  status: 'pending' | 'approved' | 'active' | 'paused' | 'archived';
  approvedById?: string;
  approvedAt?: Date;
  timesUsed: number;
  successRate?: number;
  activatedAt?: Date;
  deactivatedAt?: Date;
  createdBy?: string;
  createdAt: Date;
  updatedAt: Date;
  steps?: SequenceStep[];
  assignments?: SequenceAssignment[];
  approvedBy?: {
    id: string;
    name?: string;
    email: string;
  };
}

export interface SequenceAssignment {
  id: string;
  sequenceId: string;
  leadId: string;
  assignedById: string;
  assignedBy: string;
  approvedById?: string;
  approvedAt?: Date;
  status: 'pending' | 'active' | 'paused' | 'completed' | 'cancelled';
  currentStep: number;
  startedAt?: Date;
  completedAt?: Date;
  pausedAt?: Date;
  stepsCompleted: number;
  emailsSent: number;
  emailsOpened: number;
  emailsClicked: number;
  emailsReplied: number;
  tasksCreated: number;
  tasksCompleted: number;
  converted: boolean;
  convertedAt?: Date;
  conversionType?: string;
  notes?: string;
  createdAt: Date;
  updatedAt: Date;
  sequence?: Sequence;
  lead?: any;
  activities?: SequenceActivity[];
}

export interface SequenceActivity {
  id: string;
  assignmentId: string;
  stepOrder: number;
  actionType: string;
  result?: any;
  messageId?: string;
  emailSubject?: string;
  openedAt?: Date;
  clickedAt?: Date;
  repliedAt?: Date;
  error?: string;
  retryCount: number;
  metadata?: any;
  timestamp: Date;
  createdAt: Date;
}

export interface SequenceFilters {
  status?: string;
  type?: string;
  targetAudience?: string;
  aiGenerated?: boolean;
  createdBy?: string;
  search?: string;
}

export interface SequencePerformanceMetrics {
  totalAssignments: number;
  activeAssignments: number;
  completedAssignments: number;
  emailsSent: number;
  emailsOpened: number;
  emailsClicked: number;
  emailsReplied: number;
  openRate: number;
  clickRate: number;
  replyRate: number;
  conversionRate: number;
  avgTimeToConversion?: number;
}

// Constants
export const SEQUENCE_TYPES = [
  { value: 'email', label: 'Email' },
  { value: 'sms', label: 'SMS' },
  { value: 'task', label: 'Task' },
  { value: 'mixed', label: 'Mixed' },
] as const;

export const SEQUENCE_STATUSES = [
  { value: 'pending', label: 'Pending Approval', color: 'yellow' },
  { value: 'approved', label: 'Approved', color: 'green' },
  { value: 'active', label: 'Active', color: 'blue' },
  { value: 'paused', label: 'Paused', color: 'gray' },
  { value: 'archived', label: 'Archived', color: 'slate' },
] as const;

export const ASSIGNMENT_STATUSES = [
  { value: 'pending', label: 'Pending', color: 'yellow' },
  { value: 'active', label: 'Active', color: 'blue' },
  { value: 'paused', label: 'Paused', color: 'orange' },
  { value: 'completed', label: 'Completed', color: 'green' },
  { value: 'cancelled', label: 'Cancelled', color: 'red' },
] as const;

export const STEP_TYPES = [
  { value: 'email', label: 'Email', icon: '✉️' },
  { value: 'sms', label: 'SMS', icon: '💬' },
  { value: 'task', label: 'Task', icon: '✓' },
  { value: 'reminder', label: 'Reminder', icon: '🔔' },
  { value: 'note', label: 'Note', icon: '📝' },
  { value: 'delay', label: 'Delay', icon: '⏱️' },
] as const;

export const DELAY_UNITS = [
  { value: 'minutes', label: 'Minutes' },
  { value: 'hours', label: 'Hours' },
  { value: 'days', label: 'Days' },
  { value: 'weeks', label: 'Weeks' },
] as const;

export const TARGET_AUDIENCES = [
  { value: 'new_lead', label: 'New Lead' },
  { value: 'consultation_scheduled', label: 'Consultation Scheduled' },
  { value: 'proposal_sent', label: 'Proposal Sent' },
  { value: 'client_onboarding', label: 'Client Onboarding' },
  { value: 'reactivation', label: 'Reactivation' },
  { value: 'custom', label: 'Custom' },
] as const;

export const MERGE_TAGS = [
  { value: '{{firstName}}', label: 'First Name' },
  { value: '{{lastName}}', label: 'Last Name' },
  { value: '{{email}}', label: 'Email' },
  { value: '{{company}}', label: 'Company' },
  { value: '{{phone}}', label: 'Phone' },
  { value: '{{serviceType}}', label: 'Service Type' },
  { value: '{{budget}}', label: 'Budget' },
  { value: '{{timeline}}', label: 'Timeline' },
  { value: '{{assignedTo}}', label: 'Assigned Employee' },
] as const;


// ==========================================
// File: lib/sequence-utils.ts
// ==========================================


// Utility functions for sequence management

import { SequenceStep, SequencePerformanceMetrics } from './sequence-types';

export function formatSequenceStatus(status: string): string {
  const statusMap: Record<string, string> = {
    pending: 'Pending Approval',
    approved: 'Approved',
    active: 'Active',
    paused: 'Paused',
    archived: 'Archived',
  };
  return statusMap[status] || status;
}

export function getSequenceStatusColor(status: string): string {
  const colorMap: Record<string, string> = {
    pending: 'bg-yellow-100 text-yellow-800',
    approved: 'bg-green-100 text-green-800',
    active: 'bg-blue-100 text-blue-800',
    paused: 'bg-gray-100 text-gray-800',
    archived: 'bg-slate-100 text-slate-800',
  };
  return colorMap[status] || 'bg-gray-100 text-gray-800';
}

export function formatStepType(stepType: string): string {
  const typeMap: Record<string, string> = {
    email: 'Email',
    sms: 'SMS',
    task: 'Task',
    reminder: 'Reminder',
    note: 'Note',
    delay: 'Delay',
  };
  return typeMap[stepType] || stepType;
}

export function getStepTypeIcon(stepType: string): string {
  const iconMap: Record<string, string> = {
    email: '✉️',
    sms: '💬',
    task: '✓',
    reminder: '🔔',
    note: '📝',
    delay: '⏱️',
  };
  return iconMap[stepType] || '•';
}

export function formatDelay(amount: number, unit: string): string {
  if (amount === 0) return 'Immediately';
  const unitLabel = amount === 1 ? unit.slice(0, -1) : unit;
  return `Wait ${amount} ${unitLabel}`;
}

export function calculateSequencePerformance(
  assignments: any[]
): SequencePerformanceMetrics {
  const totalAssignments = assignments.length;
  const activeAssignments = assignments.filter((a) => a.status === 'active').length;
  const completedAssignments = assignments.filter((a) => a.status === 'completed').length;

  const emailsSent = assignments.reduce((sum, a) => sum + (a.emailsSent || 0), 0);
  const emailsOpened = assignments.reduce((sum, a) => sum + (a.emailsOpened || 0), 0);
  const emailsClicked = assignments.reduce((sum, a) => sum + (a.emailsClicked || 0), 0);
  const emailsReplied = assignments.reduce((sum, a) => sum + (a.emailsReplied || 0), 0);

  const openRate = emailsSent > 0 ? (emailsOpened / emailsSent) * 100 : 0;
  const clickRate = emailsOpened > 0 ? (emailsClicked / emailsOpened) * 100 : 0;
  const replyRate = emailsSent > 0 ? (emailsReplied / emailsSent) * 100 : 0;

  const conversions = assignments.filter((a) => a.converted).length;
  const conversionRate = totalAssignments > 0 ? (conversions / totalAssignments) * 100 : 0;

  return {
    totalAssignments,
    activeAssignments,
    completedAssignments,
    emailsSent,
    emailsOpened,
    emailsClicked,
    emailsReplied,
    openRate,
    clickRate,
    replyRate,
    conversionRate,
  };
}

export function replaceMergeTags(content: string, leadData: any): string {
  let replaced = content;
  
  // Replace common merge tags
  const tagMap: Record<string, string> = {
    '{{firstName}}': leadData.name?.split(' ')[0] || 'there',
    '{{lastName}}': leadData.name?.split(' ').slice(1).join(' ') || '',
    '{{email}}': leadData.email || '',
    '{{company}}': leadData.company || 'your company',
    '{{phone}}': leadData.phone || '',
    '{{serviceType}}': leadData.interest || 'our services',
    '{{budget}}': leadData.budget || '',
    '{{timeline}}': leadData.timeline || '',
    '{{assignedTo}}': leadData.assignedTo?.name || 'our team',
  };

  Object.entries(tagMap).forEach(([tag, value]) => {
    replaced = replaced.replace(new RegExp(tag, 'g'), value);
  });

  return replaced;
}

export function validateSequenceSteps(steps: SequenceStep[]): {
  valid: boolean;
  errors: string[];
} {
  const errors: string[] = [];

  if (steps.length === 0) {
    errors.push('Sequence must have at least one step');
  }

  steps.forEach((step, index) => {
    if (!step.title?.trim()) {
      errors.push(`Step ${index + 1}: Title is required`);
    }

    if (step.stepType === 'email') {
      if (!step.subject?.trim()) {
        errors.push(`Step ${index + 1}: Email subject is required`);
      }
      if (!step.content?.trim()) {
        errors.push(`Step ${index + 1}: Email content is required`);
      }
    }

    if (step.stepType === 'task' && !step.content?.trim()) {
      errors.push(`Step ${index + 1}: Task description is required`);
    }

    if (step.delayAmount < 0) {
      errors.push(`Step ${index + 1}: Delay amount cannot be negative`);
    }
  });

  return {
    valid: errors.length === 0,
    errors,
  };
}

export function estimateSequenceDuration(steps: SequenceStep[]): {
  totalMinutes: number;
  formatted: string;
} {
  let totalMinutes = 0;

  steps.forEach((step) => {
    const { delayAmount, delayUnit } = step;
    
    switch (delayUnit) {
      case 'minutes':
        totalMinutes += delayAmount;
        break;
      case 'hours':
        totalMinutes += delayAmount * 60;
        break;
      case 'days':
        totalMinutes += delayAmount * 24 * 60;
        break;
      case 'weeks':
        totalMinutes += delayAmount * 7 * 24 * 60;
        break;
    }
  });

  const days = Math.floor(totalMinutes / (24 * 60));
  const hours = Math.floor((totalMinutes % (24 * 60)) / 60);
  const minutes = Math.floor(totalMinutes % 60);

  let formatted = '';
  if (days > 0) formatted += `${days}d `;
  if (hours > 0) formatted += `${hours}h `;
  if (minutes > 0) formatted += `${minutes}m`;
  
  return {
    totalMinutes,
    formatted: formatted.trim() || '0m',
  };
}

export function getNextStepPreview(step: SequenceStep): string {
  const delay = formatDelay(step.delayAmount, step.delayUnit);
  const type = formatStepType(step.stepType);
  
  return `${delay} → ${type}: ${step.title}`;
}


// ==========================================
// File: lib/service-access.ts
// ==========================================


// Service access configuration for different tiers

export const SERVICE_ACCESS_CONFIG = {
  free: {
    tier: 'free',
    toolsAccess: {
      seoChecker: true,
      auditTool: false,
      roiCalculator: true,
      budgetPlanner: true,
      conversionAnalyzer: false,
      emailTester: true,
    },
    limits: {
      auditsPerMonth: 1,
      seoChecksPerMonth: 3,
      projectsLimit: 1,
      aiMessagesPerDay: 5,
      storageGB: 0.5,
    },
    features: {
      prioritySupport: false,
      customReporting: false,
      apiAccess: false,
      whiteLabel: false,
      dedicatedManager: false,
    },
  },
  starter: {
    tier: 'starter',
    toolsAccess: {
      seoChecker: true,
      auditTool: true,
      roiCalculator: true,
      budgetPlanner: true,
      conversionAnalyzer: true,
      emailTester: true,
    },
    limits: {
      auditsPerMonth: 5,
      seoChecksPerMonth: 20,
      projectsLimit: 3,
      aiMessagesPerDay: 25,
      storageGB: 5,
    },
    features: {
      prioritySupport: false,
      customReporting: false,
      apiAccess: false,
      whiteLabel: false,
      dedicatedManager: false,
    },
  },
  growth: {
    tier: 'growth',
    toolsAccess: {
      seoChecker: true,
      auditTool: true,
      roiCalculator: true,
      budgetPlanner: true,
      conversionAnalyzer: true,
      emailTester: true,
    },
    limits: {
      auditsPerMonth: 15,
      seoChecksPerMonth: 100,
      projectsLimit: 10,
      aiMessagesPerDay: 100,
      storageGB: 25,
    },
    features: {
      prioritySupport: true,
      customReporting: true,
      apiAccess: false,
      whiteLabel: false,
      dedicatedManager: false,
    },
  },
  pro: {
    tier: 'pro',
    toolsAccess: {
      seoChecker: true,
      auditTool: true,
      roiCalculator: true,
      budgetPlanner: true,
      conversionAnalyzer: true,
      emailTester: true,
    },
    limits: {
      auditsPerMonth: 50,
      seoChecksPerMonth: 500,
      projectsLimit: 50,
      aiMessagesPerDay: 500,
      storageGB: 100,
    },
    features: {
      prioritySupport: true,
      customReporting: true,
      apiAccess: true,
      whiteLabel: true,
      dedicatedManager: false,
    },
  },
  enterprise: {
    tier: 'enterprise',
    toolsAccess: {
      seoChecker: true,
      auditTool: true,
      roiCalculator: true,
      budgetPlanner: true,
      conversionAnalyzer: true,
      emailTester: true,
    },
    limits: {
      auditsPerMonth: 999,
      seoChecksPerMonth: 9999,
      projectsLimit: 999,
      aiMessagesPerDay: 9999,
      storageGB: 1000,
    },
    features: {
      prioritySupport: true,
      customReporting: true,
      apiAccess: true,
      whiteLabel: true,
      dedicatedManager: true,
    },
  },
};

export function getServiceAccess(tier: string) {
  return SERVICE_ACCESS_CONFIG[tier as keyof typeof SERVICE_ACCESS_CONFIG] || SERVICE_ACCESS_CONFIG.free;
}

export function checkToolAccess(tier: string, toolName: string): boolean {
  const access = getServiceAccess(tier);
  return access.toolsAccess[toolName as keyof typeof access.toolsAccess] || false;
}

export function checkUsageLimit(
  tier: string,
  limitType: string,
  currentUsage: number
): { allowed: boolean; limit: number; remaining: number } {
  const access = getServiceAccess(tier);
  const limit = access.limits[limitType as keyof typeof access.limits] || 0;
  
  return {
    allowed: currentUsage < limit,
    limit,
    remaining: Math.max(0, limit - currentUsage),
  };
}

// ==========================================
// File: lib/session.ts
// ==========================================


import { getServerSession } from "next-auth/next";
import { authOptions } from "@/lib/auth";
import { prisma } from "@/lib/db";

export async function getCurrentUser() {
  const session = await getServerSession(authOptions);

  if (!session?.user?.email) {
    return null;
  }

  const user = await prisma.user.findUnique({
    where: { email: session.user.email },
    select: {
      id: true,
      email: true,
      name: true,
      image: true,
      role: true,
      tier: true,
      subscriptionStatus: true,
      company: true,
      phone: true,
      industry: true,
      credits: true,
      affiliateCode: true,
      onboardingCompleted: true,
      trialEndsAt: true,
      subscriptionEndsAt: true,
      createdAt: true,
      dailyMessageCount: true,
      lastMessageDate: true,
    },
  });

  return user;
}

// ==========================================
// File: lib/slide-generator.ts
// ==========================================


import pptxgen from 'pptxgenjs';
import { getContactInfo } from './cdm-suite-knowledge';

export interface SlideContent {
  title: string;
  bulletPoints: string[];
}

export interface SlideDeckData {
  title: string;
  solicitationNumber: string;
  companyName: string;
  slides: SlideContent[];
}

/**
 * Strip all markdown formatting from text
 * Removes headers, bold, italic, links, code blocks, horizontal rules, etc.
 */
function stripMarkdown(text: string): string {
  if (!text) return '';
  
  return text
    // Remove horizontal rules (---, ___, ***)
    .replace(/^[\s]*[-_*]{3,}[\s]*$/gm, '')
    // Remove headers (# ## ### etc)
    .replace(/^#{1,6}\s+/gm, '')
    // Remove bold (**text** or __text__)
    .replace(/\*\*(.+?)\*\*/g, '$1')
    .replace(/__(.+?)__/g, '$1')
    // Remove italic (*text* or _text_)
    .replace(/\*(.+?)\*/g, '$1')
    .replace(/_(.+?)_/g, '$1')
    // Remove strikethrough (~~text~~)
    .replace(/~~(.+?)~~/g, '$1')
    // Remove inline code (`code`)
    .replace(/`([^`]+)`/g, '$1')
    // Remove code blocks (```code```)
    .replace(/```[\s\S]*?```/g, '')
    // Remove links [text](url)
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')
    // Remove images ![alt](url)
    .replace(/!\[([^\]]*)\]\([^\)]+\)/g, '$1')
    // Remove blockquotes (> text)
    .replace(/^>\s+/gm, '')
    // Clean up multiple newlines
    .replace(/\n{3,}/g, '\n\n')
    .trim();
}

/**
 * Intelligent text wrapping for PowerPoint bullets
 * Ensures no text cutoff and proper line breaks
 */
function wrapBulletText(text: string, maxCharsPerLine: number = 70): string[] {
  const words = text.split(' ');
  const lines: string[] = [];
  let currentLine = '';
  
  for (const word of words) {
    const testLine = currentLine ? `${currentLine} ${word}` : word;
    
    if (testLine.length <= maxCharsPerLine) {
      currentLine = testLine;
    } else {
      if (currentLine) {
        lines.push(currentLine);
        currentLine = word;
      } else {
        // Single word is longer than max, truncate it
        lines.push(word.substring(0, maxCharsPerLine - 3) + '...');
        currentLine = '';
      }
    }
  }
  
  if (currentLine) lines.push(currentLine);
  return lines.length > 0 ? lines : [''];
}

export async function generateSlideDeck(data: SlideDeckData): Promise<Buffer> {
  return new Promise((resolve, reject) => {
    try {
      const pptx = new pptxgen();
      
      // Set presentation properties
      pptx.author = data.companyName;
      pptx.company = data.companyName;
      pptx.title = data.title;
      pptx.subject = `Proposal for ${data.solicitationNumber}`;
      pptx.layout = 'LAYOUT_WIDE';

      // Brand colors for CDM Suite
      const colors = {
        primary: '1D2B53',      // Dark blue
        accent: 'ED8522',       // Orange
        secondary: '4A90E2',    // Light blue
        white: 'FFFFFF',
        lightGray: 'F5F5F5',
        darkGray: '333333',
        mediumGray: '666666'
      };

      // Slide 1: Title Slide - Elegant and Bold
      const titleSlide = pptx.addSlide();
      titleSlide.background = { color: colors.white };
      
      // Large accent bar on left
      titleSlide.addShape(pptx.ShapeType.rect, {
        x: 0,
        y: 0,
        w: 0.4,
        h: 7.5,
        fill: { color: colors.accent }
      });
      
      // Secondary accent bar
      titleSlide.addShape(pptx.ShapeType.rect, {
        x: 0.4,
        y: 0,
        w: 0.1,
        h: 7.5,
        fill: { color: colors.primary }
      });

      // Company Name - Top (strip markdown)
      const cleanCompanyName = stripMarkdown(data.companyName).toUpperCase();
      titleSlide.addText(cleanCompanyName, {
        x: 1.5,
        y: 1.2,
        w: 11,
        h: 0.6,
        fontSize: 28,
        bold: true,
        color: colors.primary,
        fontFace: 'Arial'
      });

      // Proposal Title - Center, Large with proper wrapping (strip markdown)
      const cleanTitle = stripMarkdown(data.title);
      const titleWords = cleanTitle.split(' ');
      const titleLines: string[] = [];
      let currentTitleLine = '';
      
      // Smart title wrapping - max 2 lines, 45 chars per line
      for (const word of titleWords) {
        const testLine = currentTitleLine ? `${currentTitleLine} ${word}` : word;
        if (testLine.length > 45 && currentTitleLine.length > 0) {
          titleLines.push(currentTitleLine);
          currentTitleLine = word;
          if (titleLines.length >= 2) break; // Max 2 lines
        } else {
          currentTitleLine = testLine;
        }
      }
      if (currentTitleLine && titleLines.length < 2) {
        titleLines.push(currentTitleLine);
      }
      
      const titleText = titleLines.join('\n');
      
      titleSlide.addText(titleText, {
        x: 1.5,
        y: 2.5,
        w: 11,
        h: 1.8,
        fontSize: 40,
        bold: true,
        color: colors.darkGray,
        fontFace: 'Arial',
        valign: 'top'
      });

      // Solicitation Box (strip markdown)
      const cleanSolNumber = stripMarkdown(data.solicitationNumber);
      
      titleSlide.addShape(pptx.ShapeType.rect, {
        x: 1.5,
        y: 5.0,
        w: 6,
        h: 1.2,
        fill: { color: colors.lightGray },
        line: { color: colors.primary, width: 2 }
      });

      titleSlide.addText('Solicitation Number', {
        x: 1.7,
        y: 5.15,
        w: 5.6,
        h: 0.3,
        fontSize: 12,
        color: colors.mediumGray,
        fontFace: 'Arial'
      });

      titleSlide.addText(cleanSolNumber, {
        x: 1.7,
        y: 5.55,
        w: 5.6,
        h: 0.5,
        fontSize: 20,
        bold: true,
        color: colors.primary,
        fontFace: 'Arial'
      });

      // Contact Information
      const contactInfo = getContactInfo();
      
      titleSlide.addText(`Contact: ${contactInfo.email} | ${contactInfo.phone}`, {
        x: 1.5,
        y: 6.8,
        w: 11,
        h: 0.4,
        fontSize: 11,
        color: colors.mediumGray,
        fontFace: 'Arial',
        align: 'center'
      });
      
      // Bottom brand line
      titleSlide.addShape(pptx.ShapeType.rect, {
        x: 0,
        y: 7.4,
        w: 13.33,
        h: 0.1,
        fill: { color: colors.accent }
      });

      // Content slides (max 3 more slides = 4 total)
      const contentSlides = data.slides.slice(0, 3);
      
      contentSlides.forEach((slideContent, index) => {
        const slide = pptx.addSlide();
        slide.background = { color: colors.white };
        
        // Top accent bar
        slide.addShape(pptx.ShapeType.rect, {
          x: 0,
          y: 0,
          w: 13.33,
          h: 0.15,
          fill: { color: colors.accent }
        });

        // Left accent element
        slide.addShape(pptx.ShapeType.rect, {
          x: 0,
          y: 0,
          w: 0.15,
          h: 7.5,
          fill: { color: colors.primary }
        });

        // Title with underline - strip markdown and truncate if needed
        const cleanSlideTitle = stripMarkdown(slideContent.title);
        const wrappedTitle = cleanSlideTitle.length > 60 
          ? cleanSlideTitle.substring(0, 57) + '...'
          : cleanSlideTitle;
        
        slide.addText(wrappedTitle, {
          x: 0.6,
          y: 0.6,
          w: 12,
          h: 0.7,
          fontSize: 30,
          bold: true,
          color: colors.primary,
          fontFace: 'Arial'
        });

        // Underline accent
        slide.addShape(pptx.ShapeType.rect, {
          x: 0.6,
          y: 1.4,
          w: 2.5,
          h: 0.08,
          fill: { color: colors.accent }
        });

        // Bullet points with intelligent wrapping and overflow protection
        // Footer starts at 6.8, so we need to stay well above that
        const MAX_CONTENT_Y = 6.2; // Extra safe margin before footer (0.6 inches above footer)
        const START_Y = 2.0;
        const LINE_HEIGHT = 0.28; // Slightly tighter line height
        const BULLET_SPACING = 0.35; // Spacing between bullets
        const MAX_LINES_PER_BULLET = 2; // Limit to 2 lines per bullet for cleaner slides
        
        let currentY = START_Y;
        let bulletsAdded = 0;
        const maxBullets = slideContent.bulletPoints.length;
        
        for (let i = 0; i < maxBullets && bulletsAdded < 6; i++) {
          const point = slideContent.bulletPoints[i];
          
          // Strip markdown from bullet text
          const cleanPoint = stripMarkdown(point);
          
          // Truncate long bullets to fit 2 lines (approximately 100 chars)
          const truncatedPoint = cleanPoint.length > 100 
            ? cleanPoint.substring(0, 97) + '...'
            : cleanPoint;
          
          // Wrap text for proper display - 70 chars per line for better readability
          const wrappedLines = wrapBulletText(truncatedPoint, 70);
          
          // Calculate height based on number of lines (max 2 lines)
          const lineCount = Math.min(wrappedLines.length, MAX_LINES_PER_BULLET);
          const totalHeight = lineCount * LINE_HEIGHT;
          
          // Check if this bullet will fit before the footer
          const nextY = currentY + totalHeight + BULLET_SPACING;
          if (nextY > MAX_CONTENT_Y) {
            console.log(`Slide ${index + 1}: Stopping at bullet ${bulletsAdded + 1} to prevent overflow (nextY: ${nextY.toFixed(2)}, MAX: ${MAX_CONTENT_Y})`);
            break; // Stop adding bullets if they would overflow
          }
          
          // Custom bullet circle - positioned at first line
          slide.addShape(pptx.ShapeType.ellipse, {
            x: 0.7,
            y: currentY + 0.06,
            w: 0.12,
            h: 0.12,
            fill: { color: colors.accent }
          });

          // Bullet text - properly wrapped with line limit
          const displayText = wrappedLines.slice(0, MAX_LINES_PER_BULLET).join('\n');
          slide.addText(displayText, {
            x: 1.0,
            y: currentY,
            w: 11.8, // Use more width for better text display
            h: totalHeight + 0.08,
            fontSize: 14, // Slightly smaller font for better fit
            color: colors.darkGray,
            fontFace: 'Arial',
            valign: 'top',
            wrap: true,
            paraSpaceAfter: 0 // No extra paragraph spacing
          });
          
          // Move to next bullet position with proper spacing
          currentY += totalHeight + BULLET_SPACING;
          bulletsAdded++;
          
          // Log position for debugging
          console.log(`Slide ${index + 1}, Bullet ${bulletsAdded}: Y=${currentY.toFixed(2)}, Lines=${lineCount}`);
        }

        // Footer section - positioned to avoid content overlap
        slide.addShape(pptx.ShapeType.rect, {
          x: 0,
          y: 6.8,
          w: 13.33,
          h: 0.7,
          fill: { color: colors.lightGray }
        });

        // Footer text - Company name (strip markdown)
        const cleanFooterCompany = stripMarkdown(data.companyName);
        slide.addText(cleanFooterCompany, {
          x: 0.6,
          y: 6.95,
          w: 6,
          h: 0.4,
          fontSize: 11,
          bold: true,
          color: colors.primary,
          fontFace: 'Arial',
          valign: 'middle'
        });

        // Footer text - Solicitation and page number (strip markdown)
        const cleanFooterSol = stripMarkdown(data.solicitationNumber);
        slide.addText(`${cleanFooterSol} | Slide ${index + 2}`, {
          x: 7,
          y: 6.95,
          w: 5.7,
          h: 0.4,
          fontSize: 10,
          color: colors.mediumGray,
          align: 'right',
          fontFace: 'Arial',
          valign: 'middle'
        });
      });

      // Generate buffer
      pptx.write({ outputType: 'nodebuffer' })
        .then((buffer) => {
          resolve(buffer as Buffer);
        })
        .catch(reject);
    } catch (error) {
      reject(error);
    }
  });
}

export function parseSlidesFromMarkdown(markdown: string): SlideContent[] {
  const slides: SlideContent[] = [];
  
  // Split by ## headers
  const sections = markdown.split(/(?=^## )/gm);
  
  sections.forEach(section => {
    const lines = section.trim().split('\n');
    if (lines.length > 0) {
      // First line is title - strip markdown and make concise
      let title = stripMarkdown(lines[0].replace(/^##\s*/, '')).trim();
      // Limit title length for better display
      if (title.length > 60) {
        title = title.substring(0, 57) + '...';
      }
      
      // Extract bullet points - prioritize concise, impactful points
      const bulletPoints: string[] = [];
      lines.slice(1).forEach(line => {
        const trimmed = line.trim();
        
        // Skip horizontal rules
        if (trimmed.match(/^[-_*]{3,}$/)) {
          return;
        }
        
        if (trimmed.startsWith('-') || trimmed.startsWith('*') || trimmed.startsWith('•')) {
          let point = stripMarkdown(trimmed.replace(/^[-*•]\s*/, '')).trim();
          // Keep bullets concise - max 150 chars for readability
          if (point.length > 150) {
            point = point.substring(0, 147) + '...';
          }
          if (point) {
            bulletPoints.push(point);
          }
        } else if (trimmed && bulletPoints.length === 0 && !trimmed.startsWith('#')) {
          // Use non-bullet text as first bullet point
          let point = stripMarkdown(trimmed);
          if (point.length > 150) {
            point = point.substring(0, 147) + '...';
          }
          if (point) {
            bulletPoints.push(point);
          }
        }
      });
      
      // Only add slides with meaningful content
      if (title && bulletPoints.length > 0) {
        slides.push({ 
          title, 
          bulletPoints: bulletPoints.slice(0, 5) // Max 5 bullets per slide for elegance
        });
      }
    }
  });
  
  // Return max 3 content slides (+ 1 title slide = 4 total)
  return slides.slice(0, 3);
}

// ==========================================
// File: lib/sms.ts
// ==========================================


/**
 * SMS Service using SMSMode API
 * Docs: https://dev.smsmode.com/
 */

interface SMSSendResponse {
  success: boolean;
  messageId?: string;
  error?: string;
}

interface SMSStatus {
  status: string;
  delivered: boolean;
  timestamp: Date;
}

class SMSModeService {
  private apiKey: string;
  private baseUrl = 'https://api.smsmode.com/http/1.6';

  constructor() {
    this.apiKey = process.env.SMSMODE_API_KEY || '';
    if (!this.apiKey) {
      console.warn('SMSMode API key not configured');
    }
  }

  /**
   * Send an SMS message
   * @param to - Phone number in international format (e.g., +1234567890)
   * @param message - Message content
   * @param from - Optional sender name (11 chars max)
   */
  async sendSMS(
    to: string,
    message: string,
    from: string = 'CDM Suite'
  ): Promise<SMSSendResponse> {
    if (!this.apiKey) {
      return {
        success: false,
        error: 'SMS service not configured',
      };
    }

    try {
      // Clean phone number (remove spaces, dashes, etc.)
      const cleanPhone = to.replace(/[^\d+]/g, '');

      // SMSMode API expects phone without + prefix
      const phoneNumber = cleanPhone.startsWith('+') 
        ? cleanPhone.substring(1) 
        : cleanPhone;

      const params = new URLSearchParams({
        accessToken: this.apiKey,
        message: message,
        numero: phoneNumber,
        emetteur: from.substring(0, 11), // Max 11 chars
      });

      const response = await fetch(`${this.baseUrl}/sendSMS.do`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: params.toString(),
      });

      const text = await response.text();

      // SMSMode returns codes: 0 = success, other = error
      if (text.startsWith('0')) {
        // Format: 0 | messageId
        const messageId = text.split('|')[1]?.trim() || text;
        return {
          success: true,
          messageId,
        };
      } else {
        // Error codes from SMSMode
        const errorMessages: Record<string, string> = {
          '2': 'Missing parameter',
          '3': 'Invalid parameter',
          '5': 'Authentication error',
          '10': 'Insufficient credits',
          '11': 'Recipient count exceeds limit',
          '32': 'Invalid characters in message',
          '35': 'Invalid phone number',
        };

        const errorCode = text.split('|')[0]?.trim() || text;
        const errorMessage = errorMessages[errorCode] || `SMS send failed: ${text}`;

        console.error('SMSMode error:', errorMessage);
        return {
          success: false,
          error: errorMessage,
        };
      }
    } catch (error) {
      console.error('SMS send error:', error);
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Unknown error',
      };
    }
  }

  /**
   * Check SMS delivery status
   * @param messageId - The message ID returned from sendSMS
   */
  async getDeliveryStatus(messageId: string): Promise<SMSStatus | null> {
    if (!this.apiKey) {
      return null;
    }

    try {
      const params = new URLSearchParams({
        accessToken: this.apiKey,
        smsID: messageId,
      });

      const response = await fetch(`${this.baseUrl}/compteRendu.do?${params}`, {
        method: 'GET',
      });

      const text = await response.text();

      // Status codes: 0=sent, 1=delivered, 2=failed, 3=waiting
      const statusMap: Record<string, string> = {
        '0': 'sent',
        '1': 'delivered',
        '2': 'failed',
        '3': 'waiting',
      };

      const statusCode = text.split('|')[0]?.trim() || text;
      const status = statusMap[statusCode] || 'unknown';

      return {
        status,
        delivered: status === 'delivered',
        timestamp: new Date(),
      };
    } catch (error) {
      console.error('SMS status check error:', error);
      return null;
    }
  }

  /**
   * Get account balance/credits
   */
  async getBalance(): Promise<number | null> {
    if (!this.apiKey) {
      return null;
    }

    try {
      const params = new URLSearchParams({
        accessToken: this.apiKey,
      });

      const response = await fetch(`${this.baseUrl}/credit.do?${params}`, {
        method: 'GET',
      });

      const text = await response.text();
      const balance = parseFloat(text);

      return isNaN(balance) ? null : balance;
    } catch (error) {
      console.error('Balance check error:', error);
      return null;
    }
  }
}

// Lazy SMS client accessor to avoid build-time side effects
let smsClient: SMSModeService | null = null;

function getSmsModeClient(): SMSModeService | null {
  const apiKey = process.env.SMSMODE_API_KEY;
  if (!apiKey) {
    console.warn('SMSMode API key not configured');
    return null;
  }

  if (!smsClient) {
    smsClient = new SMSModeService();
  }

  return smsClient;
}

export const smsService = {
  async sendSMS(
    to: string,
    message: string,
    from: string = 'CDM Suite'
  ): Promise<SMSSendResponse> {
    const client = getSmsModeClient();
    if (!client) {
      return {
        success: false,
        error: 'SMS service not configured',
      };
    }

    return client.sendSMS(to, message, from);
  },

  async getDeliveryStatus(messageId: string): Promise<SMSStatus | null> {
    const client = getSmsModeClient();
    if (!client) {
      return null;
    }

    return client.getDeliveryStatus(messageId);
  },

  async getBalance(): Promise<number | null> {
    const client = getSmsModeClient();
    if (!client) {
      return null;
    }

    return client.getBalance();
  },
};

// Export types
export type { SMSSendResponse, SMSStatus };

// ==========================================
// File: lib/stripe-config.ts
// ==========================================

// Edge-safe Stripe configuration helpers

export function getStripePublishableKeyEdge(): string {
  const key = process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY;

  if (!key || key === 'pk_test_XXXXXXXXXXXXXXXXXXXXXXXX') {
    throw new Error('NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY is not configured');
  }

  return key;
}
// ==========================================
// File: lib/stripe.ts
// ==========================================


 // NOTE: This module wraps the Stripe Node SDK and is intended for Node.js runtime only.
 // Web/Edge-safe helpers should live in `lib/stripe-config.ts`.

import Stripe from 'stripe';

let stripeClient: Stripe | null = null;

// This function should only be called on the server side.
// It is safe for Cloudflare builds: it does not throw when STRIPE_SECRET_KEY is missing.
export const getStripeInstance = (): Stripe | null => {
  if (typeof window !== 'undefined') {
    throw new Error('getStripeInstance should only be called on the server side');
  }

  const secretKey = process.env.STRIPE_SECRET_KEY;

  if (!secretKey) {
    console.error(
      'Stripe secret key not found in environment variables; Stripe functionality is disabled.',
    );
    return null;
  }

  if (!stripeClient) {
    stripeClient = new Stripe(secretKey, {
      apiVersion: '2025-10-29.clover',
    });
  }

  return stripeClient;
};

export const PRICING_PACKAGES = [
  {
    id: 'web-design',
    name: 'Responsive Web Design',
    price: 2999,
    description: 'Custom, conversion-optimized website',
    features: [
      'Custom responsive design',
      'Up to 10 pages',
      'SEO optimization',
      'Mobile-first approach',
      '3 rounds of revisions',
      'Contact form integration',
      '30 days post-launch support'
    ]
  },
  {
    id: 'digital-advertising',
    name: 'Digital Advertising Campaign',
    price: 1999,
    description: 'Data-driven ads for measurable growth',
    features: [
      '30-day campaign management',
      'Facebook & Instagram ads',
      'Google Ads setup',
      'Audience targeting & research',
      'A/B testing',
      'Weekly performance reports',
      'Ad creative design (up to 5)'
    ]
  },
  {
    id: 'mobile-app',
    name: 'Mobile App Development',
    price: 9999,
    description: 'Bringing your app idea to life',
    features: [
      'iOS & Android development',
      'Custom UI/UX design',
      'Up to 15 screens',
      'Backend API integration',
      'Push notifications',
      'App store submission',
      '60 days post-launch support'
    ]
  },
  {
    id: 'ai-implementation',
    name: 'AI Implementation Services',
    price: 4999,
    description: 'Integrate smart AI into your business',
    features: [
      'AI chatbot implementation',
      'Custom AI model training',
      'Process automation',
      'Data analysis & insights',
      'Integration with existing systems',
      'Staff training',
      'Ongoing optimization'
    ]
  },
  {
    id: 'full-service',
    name: 'Full Service Package',
    price: 14999,
    description: 'Complete digital transformation',
    features: [
      'Everything from all packages',
      'Priority support',
      'Dedicated project manager',
      'Monthly strategy sessions',
      'Advanced analytics dashboard',
      'Quarterly optimization',
      '1 year of support & maintenance'
    ],
    popular: true
  }
];

// ==========================================
// File: lib/system-settings.ts
// ==========================================


/**
 * System Settings Utilities
 * 
 * Provides functions to fetch and manage system-wide settings
 * with fallback to default values from the knowledge base.
 */

import { prisma } from './db';
import { CDM_SUITE_KNOWLEDGE } from './cdm-suite-knowledge';

/**
 * Fetch a specific setting value from database or fallback to default
 */
export async function getSettingValue(
  settingKey: string,
  defaultValue: string
): Promise<string> {
  try {
    const setting = await prisma.systemSettings.findUnique({
      where: { settingKey },
    });

    return setting?.settingValue || defaultValue;
  } catch (error) {
    console.error(`[System Settings] Error fetching ${settingKey}:`, error);
    return defaultValue;
  }
}

/**
 * Fetch multiple settings in one database call
 */
export async function getSettings(
  keys: string[]
): Promise<Record<string, string>> {
  try {
    const settings = await prisma.systemSettings.findMany({
      where: {
        settingKey: {
          in: keys,
        },
      },
    });

    const settingsMap: Record<string, string> = {};
    settings.forEach((setting: any) => {
      settingsMap[setting.settingKey] = setting.settingValue;
    });

    return settingsMap;
  } catch (error) {
    console.error('[System Settings] Error fetching multiple settings:', error);
    return {};
  }
}

/**
 * Get default contact information with database override support
 * 
 * This function checks the database for system settings first,
 * and falls back to hardcoded defaults from the knowledge base.
 */
export async function getDefaultContactInfo(): Promise<{
  email: string;
  phone: string;
  signees: string[];
}> {
  try {
    const settings = await getSettings([
      'default_contact_email',
      'default_contact_phone',
      'default_signees',
    ]);

    // Use database values if available, otherwise use defaults from knowledge base
    const { company } = CDM_SUITE_KNOWLEDGE;
    
    return {
      email: settings.default_contact_email || company.contactEmail,
      phone: settings.default_contact_phone || company.contactPhone,
      signees: settings.default_signees 
        ? settings.default_signees.split(',').map(s => s.trim())
        : company.authorizedSignees,
    };
  } catch (error) {
    console.error('[System Settings] Error fetching contact info:', error);
    
    // Fallback to knowledge base defaults
    const { company } = CDM_SUITE_KNOWLEDGE;
    return {
      email: company.contactEmail,
      phone: company.contactPhone,
      signees: company.authorizedSignees,
    };
  }
}

/**
 * Seed default settings in database if they don't exist
 * 
 * This should be called on app initialization or migration
 */
export async function seedDefaultSettings(): Promise<void> {
  try {
    const { company } = CDM_SUITE_KNOWLEDGE;

    const defaultSettings = [
      {
        settingKey: 'default_contact_email',
        settingValue: company.contactEmail,
        description: 'Email address used in all bid proposals and contracts',
      },
      {
        settingKey: 'default_contact_phone',
        settingValue: company.contactPhone,
        description: 'Phone number used in all bid proposals and contracts',
      },
      {
        settingKey: 'default_signees',
        settingValue: company.authorizedSignees.join(', '),
        description: 'Authorized signees for contracts',
      },
    ];

    for (const setting of defaultSettings) {
      await prisma.systemSettings.upsert({
        where: { settingKey: setting.settingKey },
        update: {},
        create: setting,
      });
    }

    console.log('[System Settings] Default settings seeded successfully');
  } catch (error) {
    console.error('[System Settings] Error seeding default settings:', error);
  }
}

// ==========================================
// File: lib/team-assignment.ts
// ==========================================


// Team assignment logic with skills matching and load balancing

import { prisma } from '@/lib/db';

interface TaskRequirement {
  requiredSkills: string[];
  estimatedHours: number;
}

interface EmployeeCapacity {
  id: string;
  userId: string;
  skillSet: string[];
  expertiseLevel: string;
  weeklyCapacity: number;
  currentWorkload: number;
  availableForWork: boolean;
  currentProjectCount: number;
  maxConcurrentProjects: number;
  avgProjectRating?: number;
}

/**
 * Find the best employee to assign to a task based on skills and availability
 */
export async function findBestEmployeeForTask(task: TaskRequirement): Promise<string | null> {
  // Get all available employees
  const employees = await prisma.employee.findMany({
    where: {
      status: 'active',
      availableForWork: true,
    },
  });

  if (employees.length === 0) return null;

  // Score each employee
  const scoredEmployees = employees.map((emp: any) => {
    let score = 0;

    // Skill match score (0-40 points)
    const matchedSkills = task.requiredSkills.filter(skill => 
      emp.skillSet.includes(skill)
    );
    const skillMatchRate = matchedSkills.length / task.requiredSkills.length;
    score += skillMatchRate * 40;

    // Availability score (0-30 points)
    const availableHours = emp.weeklyCapacity - emp.currentWorkload;
    if (availableHours >= task.estimatedHours) {
      score += 30;
    } else {
      score += (availableHours / task.estimatedHours) * 30;
    }

    // Expertise score (0-15 points)
    const expertisePoints = {
      'junior': 5,
      'intermediate': 10,
      'senior': 13,
      'expert': 15,
    };
    score += expertisePoints[emp.expertiseLevel as keyof typeof expertisePoints] || 10;

    // Performance score (0-15 points)
    if (emp.avgProjectRating) {
      score += (emp.avgProjectRating / 5) * 15;
    } else {
      score += 10; // Default score for new employees
    }

    // Project capacity penalty
    if (emp.currentProjectCount >= emp.maxConcurrentProjects) {
      score -= 20;
    }

    return {
      employeeId: emp.id,
      score,
      availableHours,
    };
  });

  // Sort by score (descending)
  scoredEmployees.sort(
    (a: { score: number }, b: { score: number }) => b.score - a.score
  );

  // Return the best match if score is above threshold
  const bestMatch = scoredEmployees[0];
  if (bestMatch && bestMatch.score >= 50) {
    return bestMatch.employeeId;
  }

  return null;
}

/**
 * Assign team to a workflow based on required skills
 */
export async function assignTeamToWorkflow(
  workflowId: string,
  tasks: Array<{
    id: string;
    requiredSkills: string[];
    estimatedHours: number;
  }>
): Promise<void> {
  const assignedEmployees = new Map<string, Set<string>>(); // employeeId -> Set of taskIds

  // First pass: assign tasks to best-fit employees
  for (const task of tasks) {
    const employeeId = await findBestEmployeeForTask({
      requiredSkills: task.requiredSkills,
      estimatedHours: task.estimatedHours,
    });

    if (employeeId) {
      // Update task assignment
      await prisma.workflowTask.update({
        where: { id: task.id },
        data: {
          assignedToId: employeeId,
          status: 'assigned',
        },
      });

      // Track assigned employees
      if (!assignedEmployees.has(employeeId)) {
        assignedEmployees.set(employeeId, new Set());
      }
      assignedEmployees.get(employeeId)?.add(task.id);

      // Update employee workload
      await prisma.employee.update({
        where: { id: employeeId },
        data: {
          currentWorkload: {
            increment: task.estimatedHours,
          },
        },
      });
    }
  }

  // Create team assignments for all assigned employees
  for (const [employeeId, taskIds] of assignedEmployees.entries()) {
    const totalHours = tasks
      .filter(t => taskIds.has(t.id))
      .reduce((sum, t) => sum + t.estimatedHours, 0);

    // Determine role based on number of tasks
    const role = taskIds.size >= tasks.length * 0.5 ? 'lead' : 'contributor';

    await prisma.teamAssignment.create({
      data: {
        workflowId,
        employeeId,
        role,
        allocatedHours: totalHours,
        status: 'active',
      },
    });

    // Update employee project count
    await prisma.employee.update({
      where: { id: employeeId },
      data: {
        currentProjectCount: {
          increment: 1,
        },
      },
    });
  }

  // Mark workflow as team assigned
  await prisma.workflowInstance.update({
    where: { id: workflowId },
    data: {
      teamAssigned: true,
      status: 'in_progress',
      startedAt: new Date(),
    },
  });
}

/**
 * Get employee workload summary
 */
export async function getEmployeeWorkload(employeeId: string) {
  const employee = await prisma.employee.findUnique({
    where: { id: employeeId },
    include: {
      teamAssignments: {
        where: {
          status: 'active',
        },
        include: {
          workflow: true,
        },
      },
      workflowTasks: {
        where: {
          status: {
            in: ['assigned', 'in_progress'],
          },
        },
        include: {
          workflow: true,
        },
      },
    },
  });

  if (!employee) return null;

  return {
    employee: {
      id: employee.id,
      name: employee.userId,
      role: employee.employeeRole,
      department: employee.department,
    },
    capacity: {
      weekly: employee.weeklyCapacity,
      current: employee.currentWorkload,
      available: employee.weeklyCapacity - employee.currentWorkload,
      utilizationRate: (employee.currentWorkload / employee.weeklyCapacity) * 100,
    },
    projects: {
      current: employee.currentProjectCount,
      max: employee.maxConcurrentProjects,
    },
    assignments: employee.teamAssignments.length,
    tasks: employee.workflowTasks.length,
  };
}

// ==========================================
// File: lib/tier-config.ts
// ==========================================


// Premium SaaS pricing: Professional DIY tools positioned between entry-level and full professional services
export const TIER_CONFIG = {
  free: {
    name: "Free",
    price: 0,
    features: [
      "1 free DIY website (first project)",
      "AI website generator",
      "Basic templates",
      "Community support",
    ],
    limits: {
      projects: 1, // One free project
      creditsPerMonth: 0,
      analyticsAccess: false,
      builderAccess: true,
      adsAccess: false,
      supportLevel: "community",
    },
  },
  starter: {
    name: "Starter",
    price: 199,
    priceRange: "$199",
    features: [
      "5 website credits/month",
      "AI website builder with advanced features",
      "Professional templates & customization",
      "Email support within 24hrs",
      "Export code capability",
      "Basic SEO optimization",
    ],
    limits: {
      projects: 15,
      creditsPerMonth: 5,
      analyticsAccess: true,
      builderAccess: true,
      adsAccess: false,
      supportLevel: "email",
    },
  },
  growth: {
    name: "Growth",
    price: 499,
    priceRange: "$499",
    features: [
      "15 website credits/month",
      "Priority AI processing",
      "Premium templates & advanced editor",
      "Advanced analytics dashboard",
      "Priority email support (12hr response)",
      "Custom domain integration",
      "Team collaboration (up to 3 users)",
    ],
    limits: {
      projects: 50,
      creditsPerMonth: 15,
      analyticsAccess: true,
      builderAccess: true,
      adsAccess: true,
      supportLevel: "priority",
    },
  },
  pro: {
    name: "Pro",
    price: 999,
    priceRange: "$999",
    features: [
      "40 website credits/month",
      "All premium features",
      "Advanced customization & white-label",
      "Full analytics & reporting suite",
      "Priority support + live chat (4hr response)",
      "API access",
      "Team collaboration (unlimited users)",
      "Monthly strategy consultation",
    ],
    limits: {
      projects: -1, // unlimited
      creditsPerMonth: 40,
      analyticsAccess: true,
      builderAccess: true,
      adsAccess: true,
      supportLevel: "24/7",
    },
  },
  // Removed enterprise tier from SaaS - enterprise clients go straight to professional services
};

export function getTierConfig(tier: string) {
  return TIER_CONFIG[tier as keyof typeof TIER_CONFIG] || TIER_CONFIG.free;
}

export function canAccessFeature(
  userTier: string,
  feature: keyof typeof TIER_CONFIG.free.limits
) {
  const config = getTierConfig(userTier);
  return config.limits[feature];
}

export function getTierHierarchy() {
  return ["free", "starter", "growth", "pro"];
}

export function isUpgrade(fromTier: string, toTier: string) {
  const hierarchy = getTierHierarchy();
  return hierarchy.indexOf(toTier) > hierarchy.indexOf(fromTier);
}

// ==========================================
// File: lib/tool-email-templates.ts
// ==========================================

// Additional Email Templates for Free Tools

import { getResendClient } from '@/lib/resend-client';

function formatCurrency(value: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(value);
}

function formatNumber(value: number): string {
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(value);
}

// SEO Checker Email Template
export function generateSEOCheckerEmail(data: any): string {
  const { name, url, keyword, score, issues, recommendations } = data;
  const scoreColor = score >= 80 ? '#10b981' : score >= 60 ? '#f59e0b' : '#ef4444';
  
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your SEO Analysis Results</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f7fafc;">
  <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f7fafc; padding: 40px 20px;">
    <tr>
      <td align="center">
        <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden;">
          
          <tr>
            <td style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); padding: 40px 30px; text-align: center;">
              <h1 style="margin: 0; color: #ffffff; font-size: 28px; font-weight: bold;">Your SEO Analysis</h1>
              <p style="margin: 10px 0 0 0; color: #D1FAE5; font-size: 16px;">${url}</p>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; text-align: center; background-color: #F8FAFC;">
              <p style="margin: 0 0 15px 0; color: #334155; font-size: 18px;">Hi ${name},</p>
              <p style="margin: 0 0 20px 0; color: #64748B; font-size: 16px;">We analyzed your site for "<strong>${keyword}</strong>"</p>
              <div style="display: inline-block; width: 140px; height: 140px; border-radius: 50%; background: ${scoreColor}; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                <div>
                  <div style="color: #ffffff; font-size: 48px; font-weight: bold; line-height: 1;">${score}</div>
                  <div style="color: #ffffff; font-size: 14px; font-weight: 600;">/100</div>
                </div>
              </div>
              <p style="margin: 0; color: #1E293B; font-size: 20px; font-weight: 600;">SEO Score</p>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background-color: #FEF2F2;">
              <h3 style="margin: 0 0 15px 0; color: #DC2626; font-size: 22px; text-align: center;">⚠️ Critical Issues Holding You Back</h3>
              <ul style="margin: 0; padding-left: 20px; color: #991B1B; font-size: 15px; line-height: 1.8;">
                ${issues.map((issue: string) => `<li style="margin-bottom: 10px;">${issue}</li>`).join('')}
              </ul>
              <p style="margin: 20px 0 0 0; color: #DC2626; font-size: 16px; font-weight: bold; text-align: center;">
                These issues are costing you visitors and customers every single day.
              </p>
            </td>
          </tr>

          <tr>
            <td style="padding: 30px; background-color: #F0FDF4;">
              <p style="margin: 0 0 10px 0; color: #166534; font-size: 15px; font-style: italic; text-align: center;">"We went from page 5 to page 1 in 90 days using CDM Suite's SEO strategy. Traffic increased 340%."</p>
              <p style="margin: 0; color: #15803D; font-size: 13px; text-align: center;">— Mike R., SaaS Founder</p>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); text-align: center;">
              <h3 style="margin: 0 0 15px 0; color: #ffffff; font-size: 24px;">🎯 Get Professional SEO Help</h3>
              <p style="margin: 0 0 25px 0; color: #D1FAE5; font-size: 16px; line-height: 1.6;">
                Book a <strong>FREE SEO strategy call</strong> and get:<br>
                ✅ Detailed roadmap to rank on page 1 (Value: $750)<br>
                ✅ Competitor analysis report<br>
                ✅ 90-day action plan
              </p>
              <a href="https://cdmsuite.abacusai.app/contact?source=seo-checker&score=${score}" style="display: inline-block; padding: 18px 40px; background-color: #FBBF24; color: #1E293B; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                Claim Your Free SEO Strategy →
              </a>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background-color: #EFF6FF; border: 3px solid #3B82F6;">
              <h3 style="margin: 0 0 15px 0; color: #1E40AF; font-size: 24px; text-align: center;">🚀 SEO Service - Utility Pricing</h3>
              <p style="margin: 0 0 20px 0; color: #1E3A8A; font-size: 16px; line-height: 1.6; text-align: center;">
                Get professional SEO optimization with our <strong>no-contract, utility-style pricing</strong>.
              </p>
              <div style="background-color: #ffffff; padding: 30px; border-radius: 12px; border: 2px solid #10b981;">
                <div style="text-align: center; margin-bottom: 25px;">
                  <p style="margin: 0 0 10px 0; color: #10b981; font-size: 48px; font-weight: bold;">$100<span style="font-size: 20px; color: #64748B;">/month</span></p>
                  <div style="display: inline-block; background: linear-gradient(135deg, #FEF3C7 0%, #FED7AA 100%); padding: 10px 20px; border-radius: 25px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #92400E; font-weight: bold;">⚡ Launched in less than 7 days</p>
                  </div>
                  <p style="margin: 0; color: #64748B; font-size: 14px;">Cancel anytime. No setup fees.</p>
                </div>
                <p style="margin: 0 0 15px 0; color: #1E293B; font-size: 18px; font-weight: bold; text-align: center;">What's Included:</p>
                <ul style="margin: 0 0 25px 20px; color: #334155; font-size: 15px; line-height: 1.8;">
                  <li>Complete on-page SEO optimization</li>
                  <li>Keyword research & implementation</li>
                  <li>Content optimization for your key pages</li>
                  <li>Monthly ranking reports & updates</li>
                  <li>Technical SEO fixes</li>
                  <li>Ongoing monthly optimization</li>
                </ul>
                <div style="background-color: #F0FDF4; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                  <p style="margin: 0; color: #166534; font-size: 14px; line-height: 1.6;">
                    <strong>Choose Your Style:</strong><br>
                    ✅ <strong>Done-For-You:</strong> We handle everything<br>
                    ✅ <strong>Self-Service:</strong> Access our platform + tutorials
                  </p>
                </div>
                <div style="text-align: center;">
                  <a href="https://cdmsuite.abacusai.app/contact?source=seo-checker&service=seo-utility" style="display: inline-block; padding: 18px 40px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: #ffffff; text-decoration: none; border-radius: 10px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    Start SEO Service - $100/mo →
                  </a>
                </div>
              </div>
            </td>
          </tr>

          <tr>
            <td style="padding: 30px; background-color: #F8FAFC; text-align: center; border-top: 1px solid #E2E8F0;">
              <p style="margin: 0 0 10px 0; color: #1E293B; font-size: 16px; font-weight: 600;">CDM Suite</p>
              <p style="margin: 0; color: #64748B; font-size: 14px;">
                <a href="https://cdmsuite.abacusai.app" style="color: #3B82F6; text-decoration: none;">Visit Our Website</a> | 
                <a href="tel:8622727623" style="color: #3B82F6; text-decoration: none;">(862) 272-7623</a>
              </p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>
</body>
</html>
  `;
}

// Email Subject Line Tester Template
export function generateEmailTesterEmail(data: any): string {
  const { name, subjectLine, openRatePrediction, recommendations } = data;
  const rateColor = openRatePrediction >= 25 ? '#10b981' : openRatePrediction >= 18 ? '#f59e0b' : '#ef4444';
  
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Email Subject Line Analysis</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f7fafc;">
  <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f7fafc; padding: 40px 20px;">
    <tr>
      <td align="center">
        <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden;">
          
          <tr>
            <td style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); padding: 40px 30px; text-align: center;">
              <h1 style="margin: 0; color: #ffffff; font-size: 28px; font-weight: bold;">Your Email Analysis</h1>
              <p style="margin: 10px 0 0 0; color: #F5D0FE; font-size: 16px;">Subject Line Performance Report</p>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; text-align: center; background: linear-gradient(135deg, #FCE7F3 0%, #F3E8FF 100%);">
              <p style="margin: 0 0 15px 0; color: #334155; font-size: 18px;">Hi ${name},</p>
              <p style="margin: 0 0 20px 0; color: #64748B; font-size: 16px;">We analyzed your subject line:</p>
              <div style="background-color: #ffffff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #8B5CF6;">
                <p style="margin: 0; color: #1E293B; font-size: 16px; font-style: italic;">"${subjectLine}"</p>
              </div>
              <div style="margin: 30px 0;">
                <p style="margin: 0 0 10px 0; color: #64748B; font-size: 14px;">Predicted Open Rate</p>
                <p style="margin: 0; font-size: 56px; font-weight: bold; color: ${rateColor}; line-height: 1;">${openRatePrediction}%</p>
                <p style="margin: 10px 0 0 0; color: #64748B; font-size: 14px;">Industry average is 21%</p>
              </div>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background-color: #FEF2F2;">
              <h3 style="margin: 0 0 15px 0; color: #DC2626; font-size: 22px; text-align: center;">📉 The Truth About Email Marketing</h3>
              <p style="margin: 0 0 15px 0; color: #991B1B; font-size: 16px; line-height: 1.6;">
                The average business loses <strong>$50,000-$100,000 per year</strong> from poor email marketing alone.
              </p>
              <p style="margin: 0 0 15px 0; color: #991B1B; font-size: 16px; line-height: 1.6;">
                Every percentage point increase in open rates = thousands in additional revenue.
              </p>
              <p style="margin: 0; color: #DC2626; font-size: 16px; font-weight: bold; text-align: center;">
                Your competitors are getting this right. Are you?
              </p>
            </td>
          </tr>

          <tr>
            <td style="padding: 30px; background-color: #F0FDF4;">
              <p style="margin: 0 0 10px 0; color: #166534; font-size: 15px; font-style: italic; text-align: center;">"CDM Suite's email campaigns consistently get 40%+ open rates and 12% click rates. They're email wizards!"</p>
              <p style="margin: 0; color: #15803D; font-size: 13px; text-align: center;">— Rachel K., E-commerce Brand</p>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); text-align: center;">
              <h3 style="margin: 0 0 15px 0; color: #ffffff; font-size: 24px;">🎯 Get Professional Email Marketing</h3>
              <p style="margin: 0 0 25px 0; color: #F5D0FE; font-size: 16px; line-height: 1.6;">
                Book a <strong>FREE email marketing consultation</strong> and get:<br>
                ✅ 50 proven subject line templates (Value: $297)<br>
                ✅ Email sequence audit & recommendations<br>
                ✅ A/B testing strategy blueprint
              </p>
              <a href="https://cdmsuite.abacusai.app/contact?source=email-tester" style="display: inline-block; padding: 18px 40px; background-color: #FBBF24; color: #1E293B; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                Claim Your Free Templates →
              </a>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background-color: #EFF6FF; border: 3px solid #3B82F6;">
              <h3 style="margin: 0 0 15px 0; color: #1E40AF; font-size: 24px; text-align: center;">🚀 Email Marketing - Utility Pricing</h3>
              <p style="margin: 0 0 20px 0; color: #1E3A8A; font-size: 16px; line-height: 1.6; text-align: center;">
                Professional email marketing with <strong>no-contract, utility-style pricing</strong>.
              </p>
              <div style="background-color: #ffffff; padding: 30px; border-radius: 12px; border: 2px solid #8B5CF6;">
                <div style="text-align: center; margin-bottom: 25px;">
                  <p style="margin: 0 0 10px 0; color: #8B5CF6; font-size: 48px; font-weight: bold;">$100<span style="font-size: 20px; color: #64748B;">/month</span></p>
                  <div style="display: inline-block; background: linear-gradient(135deg, #FEF3C7 0%, #FED7AA 100%); padding: 10px 20px; border-radius: 25px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #92400E; font-weight: bold;">⚡ First campaign live in less than 7 days</p>
                  </div>
                  <p style="margin: 0; color: #64748B; font-size: 14px;">Cancel anytime. No setup fees.</p>
                </div>
                <p style="margin: 0 0 15px 0; color: #1E293B; font-size: 18px; font-weight: bold; text-align: center;">What's Included:</p>
                <ul style="margin: 0 0 25px 20px; color: #334155; font-size: 15px; line-height: 1.8;">
                  <li>High-converting email sequences (welcome, nurture, re-engagement)</li>
                  <li>Subject line optimization & A/B testing</li>
                  <li>List segmentation & personalization</li>
                  <li>4 campaigns per month + automation setup</li>
                  <li>Monthly analytics & performance reports</li>
                  <li>Template design & copywriting</li>
                </ul>
                <div style="background-color: #F5F3FF; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #8B5CF6;">
                  <p style="margin: 0; color: #5B21B6; font-size: 14px; line-height: 1.6;">
                    <strong>Choose Your Style:</strong><br>
                    ✅ <strong>Done-For-You:</strong> We write, design & send everything<br>
                    ✅ <strong>Self-Service:</strong> Access our templates + automation platform
                  </p>
                </div>
                <div style="text-align: center;">
                  <a href="https://cdmsuite.abacusai.app/contact?source=email-tester&service=email-utility" style="display: inline-block; padding: 18px 40px; background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); color: #ffffff; text-decoration: none; border-radius: 10px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    Start Email Marketing - $100/mo →
                  </a>
                </div>
              </div>
            </td>
          </tr>

          <tr>
            <td style="padding: 30px; background-color: #F8FAFC; text-align: center; border-top: 1px solid #E2E8F0;">
              <p style="margin: 0 0 10px 0; color: #1E293B; font-size: 16px; font-weight: 600;">CDM Suite</p>
              <p style="margin: 0; color: #64748B; font-size: 14px;">
                <a href="https://cdmsuite.abacusai.app" style="color: #3B82F6; text-decoration: none;">Visit Our Website</a> | 
                <a href="tel:8622727623" style="color: #3B82F6; text-decoration: none;">(862) 272-7623</a>
              </p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>
</body>
</html>
  `;
}

// Budget Calculator Email Template
export function generateBudgetCalculatorEmail(data: any): string {
  const { name, annualRevenue, totalBudget, expectedROI, projectedRevenue, channels } = data;
  
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Marketing Budget Plan</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f7fafc;">
  <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f7fafc; padding: 40px 20px;">
    <tr>
      <td align="center">
        <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden;">
          
          <tr>
            <td style="background: linear-gradient(135deg, #F59E0B 0%, #DC2626 100%); padding: 40px 30px; text-align: center;">
              <h1 style="margin: 0; color: #ffffff; font-size: 28px; font-weight: bold;">Your Marketing Budget Blueprint</h1>
              <p style="margin: 10px 0 0 0; color: #FED7AA; font-size: 16px;">Strategic Investment Plan</p>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; text-align: center; background: linear-gradient(135deg, #FEF3C7 0%, #FED7AA 100%);">
              <p style="margin: 0 0 20px 0; color: #78350F; font-size: 18px;">Hi ${name},</p>
              <p style="margin: 0 0 15px 0; color: #92400E; font-size: 16px;">Recommended Annual Budget</p>
              <p style="margin: 0; font-size: 56px; font-weight: bold; color: #DC2626; line-height: 1;">${formatCurrency(totalBudget)}</p>
              <p style="margin: 15px 0 0 0; color: #92400E; font-size: 15px;">Expected ROI: <strong>${expectedROI}%</strong> = ${formatCurrency(projectedRevenue)} in revenue</p>
            </td>
          </tr>

          <tr>
            <td style="padding: 30px;">
              <h3 style="margin: 0 0 20px 0; color: #1E293B; font-size: 20px; text-align: center;">Recommended Channel Allocation</h3>
              ${channels.map((channel: any) => `
                <div style="margin-bottom: 15px; padding: 15px; background-color: #F8FAFC; border-radius: 6px; border-left: 4px solid ${channel.color};">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="color: #1E293B; font-weight: 600;">${channel.name}</span>
                    <span style="color: ${channel.color}; font-weight: bold;">${formatCurrency(channel.amount)}</span>
                  </div>
                  <p style="margin: 0; color: #64748B; font-size: 13px;">${channel.percentage}% of budget</p>
                </div>
              `).join('')}
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background-color: #FEF2F2;">
              <h3 style="margin: 0 0 15px 0; color: #DC2626; font-size: 22px; text-align: center;">⚠️ Most Businesses Waste 40-60% of Their Marketing Budget</h3>
              <p style="margin: 0 0 15px 0; color: #991B1B; font-size: 16px; line-height: 1.6;">
                They invest in the <strong>wrong channels</strong>, at the <strong>wrong time</strong>, with the <strong>wrong messaging</strong>.
              </p>
              <p style="margin: 0; color: #DC2626; font-size: 16px; font-weight: bold; text-align: center;">
                That's throwing away ${formatCurrency(totalBudget * 0.5)} every year!
              </p>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); text-align: center;">
              <h3 style="margin: 0 0 15px 0; color: #ffffff; font-size: 24px;">🎯 Get Expert Budget Planning</h3>
              <p style="margin: 0 0 25px 0; color: #D1FAE5; font-size: 16px; line-height: 1.6;">
                Book a <strong>FREE budget planning session</strong> and get:<br>
                ✅ Month-by-month execution roadmap (Value: $1,000)<br>
                ✅ ROI tracking dashboard setup<br>
                ✅ Channel optimization recommendations
              </p>
              <a href="https://cdmsuite.abacusai.app/contact?source=budget-calculator" style="display: inline-block; padding: 18px 40px; background-color: #FBBF24; color: #1E293B; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                Claim Your Free Planning Session →
              </a>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background-color: #EFF6FF; border: 3px solid #3B82F6;">
              <h3 style="margin: 0 0 15px 0; color: #1E40AF; font-size: 24px; text-align: center;">🚀 Marketing Management - Utility Pricing</h3>
              <p style="margin: 0 0 20px 0; color: #1E3A8A; font-size: 16px; line-height: 1.6; text-align: center;">
                Professional marketing with <strong>no-contract, utility-style pricing</strong>.
              </p>
              <div style="background-color: #ffffff; padding: 30px; border-radius: 12px; border: 2px solid #F59E0B;">
                <div style="text-align: center; margin-bottom: 25px;">
                  <p style="margin: 0 0 10px 0; color: #F59E0B; font-size: 48px; font-weight: bold;">$100<span style="font-size: 20px; color: #64748B;">/month per channel</span></p>
                  <div style="display: inline-block; background: linear-gradient(135deg, #FEF3C7 0%, #FED7AA 100%); padding: 10px 20px; border-radius: 25px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #92400E; font-weight: bold;">⚡ First campaigns live in less than 7 days</p>
                  </div>
                  <p style="margin: 0; color: #64748B; font-size: 14px;">Cancel anytime. No setup fees.</p>
                </div>
                <p style="margin: 0 0 15px 0; color: #1E293B; font-size: 18px; font-weight: bold; text-align: center;">Choose Your Channels (mix & match):</p>
                <ul style="margin: 0 0 25px 20px; color: #334155; font-size: 15px; line-height: 1.8;">
                  <li><strong>$100/mo:</strong> Social Media Management (12 posts + analytics)</li>
                  <li><strong>$100/mo:</strong> Ad Campaign Management (Meta, Google, TikTok)</li>
                  <li><strong>$100/mo:</strong> Content Marketing (4 blogs + SEO optimization)</li>
                  <li><strong>$100/mo:</strong> Email Marketing (campaigns + automation)</li>
                </ul>
                <div style="background-color: #FFFBEB; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #F59E0B;">
                  <p style="margin: 0; color: #92400E; font-size: 14px; line-height: 1.6;">
                    <strong>💰 Bundle Discount:</strong> Add 3+ channels and get 20% off total price<br>
                    <strong>Choose Your Style:</strong><br>
                    ✅ <strong>Done-For-You:</strong> We manage everything<br>
                    ✅ <strong>Self-Service:</strong> Access our tools + training
                  </p>
                </div>
                <div style="text-align: center;">
                  <a href="https://cdmsuite.abacusai.app/contact?source=budget-calculator&service=marketing-utility" style="display: inline-block; padding: 18px 40px; background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: #ffffff; text-decoration: none; border-radius: 10px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    Start Marketing - $100/mo per channel →
                  </a>
                </div>
              </div>
            </td>
          </tr>

          <tr>
            <td style="padding: 30px; background-color: #F8FAFC; text-align: center; border-top: 1px solid #E2E8F0;">
              <p style="margin: 0 0 10px 0; color: #1E293B; font-size: 16px; font-weight: 600;">CDM Suite</p>
              <p style="margin: 0; color: #64748B; font-size: 14px;">
                <a href="https://cdmsuite.abacusai.app" style="color: #3B82F6; text-decoration: none;">Visit Our Website</a> | 
                <a href="tel:8622727623" style="color: #3B82F6; text-decoration: none;">(862) 272-7623</a>
              </p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>
</body>
</html>
  `;
}

// Conversion Analyzer Email Template
export function generateConversionAnalyzerEmail(data: any): string {
  const { name, visitors, overallConversion, potentialRevenue, stages, biggestLeaks } = data;
  
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Funnel Analysis</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f7fafc;">
  <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f7fafc; padding: 40px 20px;">
    <tr>
      <td align="center">
        <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden;">
          
          <tr>
            <td style="background: linear-gradient(135deg, #6366F1 0%, #3B82F6 100%); padding: 40px 30px; text-align: center;">
              <h1 style="margin: 0; color: #ffffff; font-size: 28px; font-weight: bold;">Your Funnel Analysis</h1>
              <p style="margin: 10px 0 0 0; color: #DBEAFE; font-size: 16px;">Where Are You Losing Customers?</p>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; text-align: center; background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);">
              <p style="margin: 0 0 20px 0; color: #334155; font-size: 18px;">Hi ${name},</p>
              <p style="margin: 0 0 15px 0; color: #64748B; font-size: 16px;">Your Overall Conversion Rate</p>
              <p style="margin: 0; font-size: 56px; font-weight: bold; color: ${overallConversion >= 5 ? '#10b981' : overallConversion >= 2 ? '#f59e0b' : '#ef4444'}; line-height: 1;">${overallConversion.toFixed(2)}%</p>
              <p style="margin: 15px 0 0 0; color: #64748B; font-size: 15px;">Industry average: 2-4%</p>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background-color: #FEF2F2;">
              <h3 style="margin: 0 0 15px 0; color: #DC2626; font-size: 22px; text-align: center;">💰 You're Leaving Money on the Table</h3>
              <p style="margin: 0 0 20px 0; color: #991B1B; font-size: 18px; font-weight: bold; text-align: center;">
                Potential Additional Monthly Revenue: ${formatCurrency(potentialRevenue)}
              </p>
              <p style="margin: 0 0 15px 0; color: #991B1B; font-size: 16px; line-height: 1.6;">
                That's <strong>${formatCurrency(potentialRevenue * 12)}</strong> per year you're losing because of funnel leaks.
              </p>
              <div style="background-color: #FEE2E2; padding: 15px; border-radius: 6px; border-left: 4px solid #DC2626;">
                <p style="margin: 0 0 10px 0; color: #DC2626; font-weight: bold;">Your Biggest Issues:</p>
                <ul style="margin: 0; padding-left: 20px; color: #991B1B; font-size: 14px;">
                  ${biggestLeaks.map((leak: string) => `<li style="margin-bottom: 5px;">${leak}</li>`).join('')}
                </ul>
              </div>
            </td>
          </tr>

          <tr>
            <td style="padding: 30px; background-color: #F0FDF4;">
              <p style="margin: 0 0 10px 0; color: #166534; font-size: 15px; font-style: italic; text-align: center;">"We used CDM Suite's CRO strategy and increased conversions by 47% in 60 days. That's an extra $180K per year!"</p>
              <p style="margin: 0; color: #15803D; font-size: 13px; text-align: center;">— Tom H., E-commerce Business</p>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background: linear-gradient(135deg, #6366F1 0%, #3B82F6 100%); text-align: center;">
              <h3 style="margin: 0 0 15px 0; color: #ffffff; font-size: 24px;">🎯 Get Professional CRO Help</h3>
              <p style="margin: 0 0 25px 0; color: #DBEAFE; font-size: 16px; line-height: 1.6;">
                Book a <strong>FREE conversion optimization audit</strong> and get:<br>
                ✅ Stage-by-stage optimization plan (Value: $1,200)<br>
                ✅ A/B testing recommendations<br>
                ✅ User behavior heat maps
              </p>
              <a href="https://cdmsuite.abacusai.app/contact?source=conversion-analyzer" style="display: inline-block; padding: 18px 40px; background-color: #FBBF24; color: #1E293B; text-decoration: none; border-radius: 8px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                Claim Your Free CRO Audit →
              </a>
            </td>
          </tr>

          <tr>
            <td style="padding: 40px 30px; background-color: #EFF6FF; border: 3px solid #3B82F6;">
              <h3 style="margin: 0 0 15px 0; color: #1E40AF; font-size: 24px; text-align: center;">🚀 CRO Service - Utility Pricing</h3>
              <p style="margin: 0 0 20px 0; color: #1E3A8A; font-size: 16px; line-height: 1.6; text-align: center;">
                Conversion optimization with <strong>no-contract, utility-style pricing</strong>.
              </p>
              <div style="background-color: #ffffff; padding: 30px; border-radius: 12px; border: 2px solid #6366F1;">
                <div style="text-align: center; margin-bottom: 25px;">
                  <p style="margin: 0 0 10px 0; color: #6366F1; font-size: 48px; font-weight: bold;">$100<span style="font-size: 20px; color: #64748B;">/month</span></p>
                  <div style="display: inline-block; background: linear-gradient(135deg, #FEF3C7 0%, #FED7AA 100%); padding: 10px 20px; border-radius: 25px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #92400E; font-weight: bold;">⚡ First optimizations live in less than 7 days</p>
                  </div>
                  <p style="margin: 0; color: #64748B; font-size: 14px;">Cancel anytime. No setup fees.</p>
                </div>
                <p style="margin: 0 0 15px 0; color: #1E293B; font-size: 18px; font-weight: bold; text-align: center;">What's Included:</p>
                <ul style="margin: 0 0 25px 20px; color: #334155; font-size: 15px; line-height: 1.8;">
                  <li>Landing page optimization (1 page per month)</li>
                  <li>A/B testing setup & analysis (2 tests/month)</li>
                  <li>User behavior tracking & heatmaps</li>
                  <li>Conversion funnel analysis & recommendations</li>
                  <li>Monthly optimization reports with insights</li>
                  <li>Continuous improvements based on data</li>
                </ul>
                <div style="background-color: #EFF6FF; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #6366F1;">
                  <p style="margin: 0; color: #1E40AF; font-size: 14px; line-height: 1.6;">
                    <strong>Choose Your Style:</strong><br>
                    ✅ <strong>Done-For-You:</strong> We optimize everything for you<br>
                    ✅ <strong>Self-Service:</strong> Access our CRO platform + training
                  </p>
                </div>
                <div style="text-align: center;">
                  <a href="https://cdmsuite.abacusai.app/contact?source=conversion-analyzer&service=cro-utility" style="display: inline-block; padding: 18px 40px; background: linear-gradient(135deg, #6366F1 0%, #3B82F6 100%); color: #ffffff; text-decoration: none; border-radius: 10px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    Start CRO Service - $100/mo →
                  </a>
                  <p style="margin: 15px 0 0 0; color: #64748B; font-size: 12px;">💰 Results-focused or your money back</p>
                </div>
              </div>
            </td>
          </tr>

          <tr>
            <td style="padding: 30px; background-color: #F8FAFC; text-align: center; border-top: 1px solid #E2E8F0;">
              <p style="margin: 0 0 10px 0; color: #1E293B; font-size: 16px; font-weight: 600;">CDM Suite</p>
              <p style="margin: 0; color: #64748B; font-size: 14px;">
                <a href="https://cdmsuite.abacusai.app" style="color: #3B82F6; text-decoration: none;">Visit Our Website</a> | 
                <a href="tel:8622727623" style="color: #3B82F6; text-decoration: none;">(862) 272-7623</a>
              </p>
            </td>
          </tr>

        </table>
      </td>
    </tr>
  </table>
</body>
</html>
  `;
}


// Generate follow-up actions based on tool and assessment data
export function generateToolFollowUpActions(source: string, score: number, assessmentData: any): string[] {
  const actions: string[] = [];

  if (source === 'website-need-checker') {
    // Priority actions based on score
    if (score >= 80) {
      actions.push('🔥 URGENT: Schedule discovery call within 24 hours');
      actions.push('📧 Send case study matching their industry');
      actions.push('💰 Prepare custom proposal with pricing options');
    } else if (score >= 60) {
      actions.push('📞 Schedule consultation call within 48 hours');
      actions.push('📧 Send educational content about website benefits');
      actions.push('📊 Share ROI calculator results');
    } else {
      actions.push('📧 Send nurture email sequence (value-focused)');
      actions.push('📚 Share relevant blog posts and resources');
      actions.push('📅 Follow up in 1 week with success stories');
    }

    // Specific actions based on assessment data
    if (assessmentData) {
      if (assessmentData.hasWebsite === 'no') {
        actions.push('🎨 Showcase website templates in their industry');
        actions.push('💡 Highlight quick launch timeline (7 days)');
      }
      
      if (assessmentData.currentLeadGen === 'referrals' || assessmentData.currentLeadGen === 'none') {
        actions.push('📈 Emphasize lead generation capabilities');
        actions.push('🎯 Share lead generation case study');
      }

      if (assessmentData.goals?.includes('more-customers')) {
        actions.push('🚀 Discuss conversion optimization strategies');
        actions.push('💼 Offer free marketing assessment');
      }

      if (assessmentData.competitors === 'most') {
        actions.push('⚡ Emphasize competitive advantage of modern website');
        actions.push('🔍 Offer competitor analysis report');
      }
    }
  }

  // Add other tool-specific actions here
  if (source === 'seo-checker') {
    actions.push('📊 Send detailed SEO audit report');
    actions.push('🎯 Schedule SEO strategy call');
    actions.push('📈 Share SEO case studies and results');
  }

  if (source === 'website-auditor') {
    actions.push('🔧 Send fix recommendations PDF');
    actions.push('💬 Schedule technical review call');
    actions.push('⚡ Offer quick-win improvements list');
  }

  return actions;
}

// Send email notifications to team and lead
export async function sendToolLeadNotifications({
  lead,
  source,
  score,
  assessmentData,
  followUpActions,
  isUpdate,
}: {
  lead: any;
  source: string;
  score: number;
  assessmentData: any;
  followUpActions: string[];
  isUpdate: boolean;
}) {
  try {
    // Send internal notification to team
    const teamEmail = await sendTeamNotification({
      lead,
      source,
      score,
      assessmentData,
      followUpActions,
      isUpdate,
    });

    // Send thank you email to lead
    const leadEmail = await sendLeadThankYouEmail({
      lead,
      source,
      score,
      assessmentData,
    });

    console.log('✅ Email notifications sent:', { teamEmail, leadEmail });
    return { teamEmail, leadEmail };
  } catch (error) {
    console.error('❌ Error sending notifications:', error);
    throw error;
  }
}

// Send team notification
async function sendTeamNotification({
  lead,
  source,
  score,
  assessmentData,
  followUpActions,
  isUpdate,
}: {
  lead: any;
  source: string;
  score: number;
  assessmentData: any;
  followUpActions: string[];
  isUpdate: boolean;
}) {
  const priority = score >= 80 ? '🔥 HIGH' : score >= 60 ? '⚡ MEDIUM' : '📋 LOW';
  const action = isUpdate ? 'Updated' : 'New';

  const emailHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>${action} Lead: ${lead.name || lead.email}</title>
</head>
<body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f7fafc;">
  <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <div style="background-color: #ffffff; border-radius: 8px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      
      <!-- Header -->
      <h1 style="margin: 0 0 10px 0; color: #1e293b; font-size: 24px;">${priority} ${action} Lead from ${source}</h1>
      <p style="margin: 0 0 20px 0; color: #64748b; font-size: 14px;">Score: ${score}/100</p>

      <!-- Lead Info -->
      <div style="background-color: #f8fafc; padding: 20px; border-radius: 6px; margin-bottom: 20px;">
        <h3 style="margin: 0 0 15px 0; color: #334155; font-size: 16px;">Lead Information</h3>
        <p style="margin: 0 0 8px 0; color: #475569; font-size: 14px;"><strong>Name:</strong> ${lead.name || 'Not provided'}</p>
        <p style="margin: 0 0 8px 0; color: #475569; font-size: 14px;"><strong>Email:</strong> ${lead.email || 'Not provided'}</p>
        <p style="margin: 0 0 8px 0; color: #475569; font-size: 14px;"><strong>Phone:</strong> ${lead.phone || 'Not provided'}</p>
        <p style="margin: 0 0 8px 0; color: #475569; font-size: 14px;"><strong>Company:</strong> ${lead.company || 'Not provided'}</p>
        <p style="margin: 0; color: #475569; font-size: 14px;"><strong>Interest:</strong> ${lead.interest || 'Not provided'}</p>
      </div>

      <!-- Assessment Data -->
      ${assessmentData ? `
      <div style="background-color: #eff6ff; padding: 20px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
        <h3 style="margin: 0 0 15px 0; color: #1e40af; font-size: 16px;">Assessment Results</h3>
        ${formatAssessmentForEmail(assessmentData, source)}
      </div>
      ` : ''}

      <!-- Follow-up Actions -->
      <div style="background-color: #fef3c7; padding: 20px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
        <h3 style="margin: 0 0 15px 0; color: #92400e; font-size: 16px;">🎯 Recommended Follow-Up Actions</h3>
        <ul style="margin: 0; padding-left: 20px; color: #451a03; font-size: 14px; line-height: 1.6;">
          ${followUpActions.map(action => `<li style="margin-bottom: 8px;">${action}</li>`).join('')}
        </ul>
      </div>

      <!-- CTA -->
      <div style="text-align: center; margin-top: 30px;">
        <a href="https://cdmsuite.com/dashboard/crm" style="display: inline-block; padding: 14px 28px; background-color: #3b82f6; color: #ffffff; text-decoration: none; border-radius: 6px; font-size: 16px; font-weight: bold;">
          View in CRM →
        </a>
      </div>

    </div>
  </div>
</body>
</html>
  `;

  const resend = getResendClient();
  if (!resend) {
    console.log('📧 Team Notification (Dev Mode):\n', emailHtml.substring(0, 500));
    return { success: true, mode: 'dev' };
  }

  const result = await resend.emails.send({
    from: 'CDM Suite CRM <leads@cdmsuite.com>',
    to: process.env.TEAM_EMAIL || 'team@cdmsuite.com',
    subject: `${priority} ${action} Lead: ${lead.name || lead.email} (${source})`,
    html: emailHtml,
  });

  return result;
}

// Send thank you email to lead
async function sendLeadThankYouEmail({
  lead,
  source,
  score,
  assessmentData,
}: {
  lead: any;
  source: string;
  score: number;
  assessmentData: any;
}) {
  if (!lead.email) {
    console.log('⚠️  No email provided for lead, skipping thank you email');
    return null;
  }

  const toolNames: { [key: string]: string } = {
    'website-need-checker': 'Website Need Assessment',
    'seo-checker': 'SEO Analysis',
    'website-auditor': 'Website Audit',
    'email-tester': 'Email Subject Line Test',
    'budget-calculator': 'Marketing Budget Calculator',
    'conversion-analyzer': 'Conversion Funnel Analysis',
    'roi-calculator': 'ROI Calculator',
  };

  const toolName = toolNames[source] || source;

  const emailHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Your ${toolName} Results</title>
</head>
<body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f7fafc;">
  <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <div style="background-color: #ffffff; border-radius: 8px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      
      <!-- Header -->
      <h1 style="margin: 0 0 10px 0; color: #1e293b; font-size: 24px;">Thank you for completing the ${toolName}!</h1>
      <p style="margin: 0 0 20px 0; color: #64748b; font-size: 16px;">Hi ${lead.name || 'there'},</p>

      <!-- Score -->
      ${score > 0 ? `
      <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 8px; margin-bottom: 20px;">
        <p style="margin: 0 0 10px 0; color: #64748b; font-size: 14px;">Your Score</p>
        <p style="margin: 0; font-size: 48px; font-weight: bold; color: ${score >= 80 ? '#10b981' : score >= 60 ? '#f59e0b' : '#ef4444'}; line-height: 1;">${score}</p>
        <p style="margin: 5px 0 0 0; color: #64748b; font-size: 14px;">/100</p>
      </div>
      ` : ''}

      <!-- Message -->
      <div style="margin-bottom: 20px;">
        <p style="margin: 0 0 15px 0; color: #475569; font-size: 16px; line-height: 1.6;">
          ${score >= 80 
            ? 'Your results indicate significant opportunities for improvement. Our team will be reaching out within 24 hours to discuss how we can help you achieve your goals.'
            : score >= 60
            ? 'Your results show good potential with room for optimization. We\'d love to discuss strategies that could take you to the next level.'
            : 'Thank you for taking the assessment. We\'ll review your results and be in touch with personalized recommendations.'
          }
        </p>
        <p style="margin: 0; color: #475569; font-size: 16px; line-height: 1.6;">
          In the meantime, feel free to explore our resources or schedule a free consultation.
        </p>
      </div>

      <!-- CTA -->
      <div style="text-align: center; margin-top: 30px;">
        <a href="https://cdmsuite.com/contact?source=${source}" style="display: inline-block; padding: 14px 28px; background-color: #3b82f6; color: #ffffff; text-decoration: none; border-radius: 6px; font-size: 16px; font-weight: bold; margin: 0 10px 10px 0;">
          Schedule Free Consultation
        </a>
        <a href="https://cdmsuite.com/services" style="display: inline-block; padding: 14px 28px; background-color: #64748b; color: #ffffff; text-decoration: none; border-radius: 6px; font-size: 16px; font-weight: bold; margin: 0 0 10px 0;">
          View Our Services
        </a>
      </div>

      <!-- Footer -->
      <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; text-align: center;">
        <p style="margin: 0 0 10px 0; color: #64748b; font-size: 14px;">Questions? We're here to help!</p>
        <p style="margin: 0; color: #64748b; font-size: 14px;">
          <a href="tel:8622727623" style="color: #3b82f6; text-decoration: none;">(862) 272-7623</a> | 
          <a href="mailto:team@cdmsuite.com" style="color: #3b82f6; text-decoration: none;">team@cdmsuite.com</a>
        </p>
      </div>

    </div>
  </div>
</body>
</html>
  `;

  const resend = getResendClient();
  if (!resend) {
    console.log('📧 Lead Thank You Email (Dev Mode):\n', emailHtml.substring(0, 500));
    return { success: true, mode: 'dev' };
  }

  const result = await resend.emails.send({
    from: 'CDM Suite <hello@cdmsuite.com>',
    to: lead.email,
    subject: `Your ${toolName} Results - CDM Suite`,
    html: emailHtml,
  });

  return result;
}

// Helper to format assessment data for email
function formatAssessmentForEmail(data: any, source: string): string {
  if (source === 'website-need-checker') {
    const valueLabels: { [key: string]: { [key: string]: string } } = {
      hasWebsite: {
        no: '❌ No website',
        yes: '⚠️ Outdated website',
        modern: '✅ Modern website',
      },
      industry: {
        'retail': 'Retail / E-commerce',
        'professional-services': 'Professional Services',
        'restaurant': 'Restaurant / Food Service',
        'health': 'Healthcare / Wellness',
        'construction': 'Construction / Home Services',
        'other': 'Other',
      },
      businessAge: {
        'startup': 'Less than 1 year',
        '1-3': '1-3 years',
        '3-5': '3-5 years',
        '5+': '5+ years',
      },
      customerType: {
        'b2c': 'Business to Consumer (B2C)',
        'b2b': 'Business to Business (B2B)',
        'both': 'Both B2C and B2B',
      },
      currentLeadGen: {
        'referrals': 'Referrals only',
        'social': 'Social Media',
        'ads': 'Paid Advertising',
        'seo': 'SEO / Organic',
        'none': 'No active lead generation',
      },
      monthlyRevenue: {
        '0-1k': '$0 - $1,000',
        '1k-5k': '$1,000 - $5,000',
        '5k-10k': '$5,000 - $10,000',
        '10k+': '$10,000+',
      },
      competitors: {
        'none': 'No direct competitors',
        'some': 'Some competitors',
        'most': 'Highly competitive market',
      },
    };

    let formatted = '';
    const fields = [
      { key: 'hasWebsite', label: 'Current Website' },
      { key: 'industry', label: 'Industry' },
      { key: 'businessAge', label: 'Business Age' },
      { key: 'customerType', label: 'Customer Type' },
      { key: 'currentLeadGen', label: 'Lead Generation' },
      { key: 'monthlyRevenue', label: 'Monthly Revenue' },
      { key: 'competitors', label: 'Competition' },
    ];

    fields.forEach(field => {
      if (data[field.key]) {
        const value = valueLabels[field.key]?.[data[field.key]] || data[field.key];
        formatted += `<p style="margin: 0 0 8px 0; color: #1e40af; font-size: 14px;"><strong>${field.label}:</strong> ${value}</p>`;
      }
    });

    if (data.goals && Array.isArray(data.goals)) {
      formatted += `<p style="margin: 0; color: #1e40af; font-size: 14px;"><strong>Goals:</strong> ${data.goals.join(', ')}</p>`;
    }

    return formatted;
  }

  // Default formatting
  return `<p style="margin: 0; color: #1e40af; font-size: 14px;">${JSON.stringify(data, null, 2)}</p>`;
}

// ==========================================
// File: lib/types.ts
// ==========================================

export type Expense = {
  id: string
  amount: number
  category: string
  description: string
  date: Date
}

export type ExpenseFormData = Omit<Expense, 'id' | 'date'> & {
  date: string
}

export const EXPENSE_CATEGORIES = [
  'Food',
  'Transportation',
  'Housing',
  'Utilities',
  'Entertainment',
  'Healthcare',
  'Shopping',
  'Education',
  'Other'
] as const

export type DateRange = {
  from: Date | undefined
  to: Date | undefined
}
// ==========================================
// File: lib/utils.ts
// ==========================================

import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"
import { format, formatDistanceToNow } from 'date-fns'
 
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

export function formatDuration(seconds: number): string {
  const hours = Math.floor(seconds / 3600)
  const minutes = Math.floor((seconds % 3600) / 60)
  const remainingSeconds = seconds % 60

  return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`
}

/**
 * Format a date with detailed timestamp information
 * Shows both the exact date/time and relative time
 * @param date - Date to format
 * @param options - Formatting options
 * @returns Formatted date string with detailed information
 */
export function formatDetailedTimestamp(
  date: Date | string,
  options?: {
    showRelative?: boolean;
    showTime?: boolean;
    dateFormat?: string;
  }
) {
  const dateObj = typeof date === 'string' ? new Date(date) : date;
  const showRelative = options?.showRelative !== false;
  const showTime = options?.showTime !== false;
  const dateFormat = options?.dateFormat || (showTime ? 'MMM d, yyyy h:mm a' : 'MMM d, yyyy');

  const formattedDate = format(dateObj, dateFormat);
  
  if (showRelative) {
    const relativeTime = formatDistanceToNow(dateObj, { addSuffix: true });
    return {
      full: formattedDate,
      relative: relativeTime,
      tooltip: `${formattedDate} (${relativeTime})`,
    };
  }

  return {
    full: formattedDate,
    relative: '',
    tooltip: formattedDate,
  };
}
// ==========================================
// File: lib/workflow-templates.ts
// ==========================================


// Predefined workflow templates for different services

export const WORKFLOW_TEMPLATES = {
  'web-development': {
    starter: {
      name: 'Website Development - Starter',
      estimatedDuration: 14,
      estimatedHours: 30,
      tasks: [
        {
          title: 'Initial Client Consultation',
          description: 'Gather requirements, brand guidelines, content, and design preferences',
          order: 1,
          estimatedHours: 2,
          requiredSkills: ['project_management'],
          visibleToClient: true,
        },
        {
          title: 'Design Mockup Creation',
          description: 'Create homepage and key page designs for approval',
          order: 2,
          estimatedHours: 8,
          requiredSkills: ['web_design', 'ui_ux'],
          visibleToClient: true,
        },
        {
          title: 'Design Approval',
          description: 'Present designs to client and incorporate feedback',
          order: 3,
          estimatedHours: 2,
          requiredSkills: ['project_management'],
          visibleToClient: true,
          dependencies: ['2'],
        },
        {
          title: 'Frontend Development',
          description: 'Build responsive website with approved designs',
          order: 4,
          estimatedHours: 12,
          requiredSkills: ['web_development', 'frontend'],
          dependencies: ['3'],
        },
        {
          title: 'Content Integration',
          description: 'Add client content, images, and optimize for web',
          order: 5,
          estimatedHours: 4,
          requiredSkills: ['web_development', 'content_creation'],
          dependencies: ['4'],
        },
        {
          title: 'Basic SEO Setup',
          description: 'Implement meta tags, sitemap, and basic on-page SEO',
          order: 6,
          estimatedHours: 2,
          requiredSkills: ['seo'],
          dependencies: ['5'],
        },
        {
          title: 'Final Review & Launch',
          description: 'Client review, final adjustments, and site launch',
          order: 7,
          estimatedHours: 3,
          requiredSkills: ['project_management', 'web_development'],
          visibleToClient: true,
          dependencies: ['6'],
        },
      ],
      milestones: [
        { name: 'Design Approved', order: 1, taskIndices: [2, 3] },
        { name: 'Development Complete', order: 2, taskIndices: [4, 5] },
        { name: 'Launched', order: 3, taskIndices: [7] },
      ],
    },
    growth: {
      name: 'Website Development - Growth',
      estimatedDuration: 30,
      estimatedHours: 60,
      tasks: [
        { title: 'Discovery & Strategy Session', description: 'Deep dive into business goals, target audience, and competitive analysis', order: 1, estimatedHours: 3, requiredSkills: ['project_management', 'strategy'], visibleToClient: true },
        { title: 'Sitemap & Wireframes', description: 'Create detailed sitemap and wireframes for all pages', order: 2, estimatedHours: 6, requiredSkills: ['ui_ux', 'web_design'], visibleToClient: true },
        { title: 'Custom Design System', description: 'Create comprehensive design system with custom branding', order: 3, estimatedHours: 12, requiredSkills: ['web_design', 'branding'], dependencies: ['2'] },
        { title: 'Design Approval & Revisions', description: 'Client review and up to 3 revision rounds', order: 4, estimatedHours: 4, requiredSkills: ['project_management'], visibleToClient: true, dependencies: ['3'] },
        { title: 'Frontend Development', description: 'Build fully responsive website with custom features', order: 5, estimatedHours: 20, requiredSkills: ['web_development', 'frontend'], dependencies: ['4'] },
        { title: 'Backend & CMS Setup', description: 'Configure content management system and database', order: 6, estimatedHours: 8, requiredSkills: ['web_development', 'backend'], dependencies: ['5'] },
        { title: 'Content Creation & Integration', description: 'Professional content writing and media optimization', order: 7, estimatedHours: 6, requiredSkills: ['content_creation', 'copywriting'], dependencies: ['6'] },
        { title: 'SEO & Performance Optimization', description: 'Advanced on-page SEO and speed optimization', order: 8, estimatedHours: 4, requiredSkills: ['seo', 'web_development'], dependencies: ['7'] },
        { title: 'Testing & QA', description: 'Cross-browser testing, mobile testing, and bug fixes', order: 9, estimatedHours: 4, requiredSkills: ['qa', 'web_development'], dependencies: ['8'] },
        { title: 'Launch & Training', description: 'Deploy site and train client on CMS', order: 10, estimatedHours: 3, requiredSkills: ['project_management'], visibleToClient: true, dependencies: ['9'] },
      ],
      milestones: [
        { name: 'Strategy Approved', order: 1, taskIndices: [1, 2] },
        { name: 'Design Approved', order: 2, taskIndices: [3, 4] },
        { name: 'Development Complete', order: 3, taskIndices: [5, 6, 7] },
        { name: 'Launched', order: 4, taskIndices: [10] },
      ],
    },
  },
  'seo': {
    growth: {
      name: 'SEO - Growth Package',
      estimatedDuration: 90,
      estimatedHours: 40,
      tasks: [
        { title: 'SEO Audit & Analysis', description: 'Comprehensive site audit, keyword research, and competitor analysis', order: 1, estimatedHours: 6, requiredSkills: ['seo'], visibleToClient: true },
        { title: 'Strategy Development', description: 'Create 3-month SEO roadmap and content strategy', order: 2, estimatedHours: 4, requiredSkills: ['seo', 'strategy'], visibleToClient: true, dependencies: ['1'] },
        { title: 'Technical SEO Fixes', description: 'Implement site speed, mobile, and technical improvements', order: 3, estimatedHours: 8, requiredSkills: ['seo', 'web_development'], dependencies: ['2'] },
        { title: 'On-Page Optimization', description: 'Optimize meta tags, headers, and content for target keywords', order: 4, estimatedHours: 6, requiredSkills: ['seo', 'content_creation'], dependencies: ['3'] },
        { title: 'Content Creation (Month 1)', description: 'Create and optimize 4 blog posts/articles', order: 5, estimatedHours: 8, requiredSkills: ['content_creation', 'seo'], dependencies: ['4'] },
        { title: 'Link Building Campaign', description: 'Build 10-15 quality backlinks through outreach', order: 6, estimatedHours: 6, requiredSkills: ['seo', 'outreach'], dependencies: ['4'] },
        { title: 'Monthly Reporting & Optimization', description: 'Track rankings, traffic, and adjust strategy', order: 7, estimatedHours: 2, requiredSkills: ['seo', 'analytics'], visibleToClient: true, dependencies: ['5', '6'] },
      ],
      milestones: [
        { name: 'Audit Complete', order: 1, taskIndices: [1] },
        { name: 'Technical Setup', order: 2, taskIndices: [3, 4] },
        { name: 'First Month Execution', order: 3, taskIndices: [5, 6] },
        { name: 'First Report Delivered', order: 4, taskIndices: [7] },
      ],
    },
  },
  'social-media': {
    growth: {
      name: 'Social Media Management - Growth',
      estimatedDuration: 30,
      estimatedHours: 20,
      tasks: [
        { title: 'Social Media Audit', description: 'Analyze current profiles and competitor presence', order: 1, estimatedHours: 3, requiredSkills: ['social_media', 'strategy'], visibleToClient: true },
        { title: 'Content Strategy', description: 'Create monthly content calendar and posting schedule', order: 2, estimatedHours: 4, requiredSkills: ['social_media', 'content_creation'], visibleToClient: true, dependencies: ['1'] },
        { title: 'Profile Optimization', description: 'Optimize 2-3 social profiles with branding', order: 3, estimatedHours: 2, requiredSkills: ['social_media', 'branding'], dependencies: ['2'] },
        { title: 'Content Creation', description: 'Create 12-18 posts (graphics, captions, hashtags)', order: 4, estimatedHours: 8, requiredSkills: ['graphic_design', 'content_creation'], dependencies: ['3'] },
        { title: 'Publishing & Engagement', description: 'Schedule posts and engage with audience', order: 5, estimatedHours: 2, requiredSkills: ['social_media'], dependencies: ['4'] },
        { title: 'Monthly Analytics Report', description: 'Report on reach, engagement, and growth', order: 6, estimatedHours: 1, requiredSkills: ['social_media', 'analytics'], visibleToClient: true, dependencies: ['5'] },
      ],
      milestones: [
        { name: 'Strategy Approved', order: 1, taskIndices: [1, 2] },
        { name: 'Content Created', order: 2, taskIndices: [4] },
        { name: 'Month Complete', order: 3, taskIndices: [5, 6] },
      ],
    },
  },
  'ad-management': {
    growth: {
      name: 'Ad Management - Growth',
      estimatedDuration: 30,
      estimatedHours: 25,
      tasks: [
        { title: 'Campaign Strategy', description: 'Define goals, audience, budget allocation', order: 1, estimatedHours: 3, requiredSkills: ['ppc', 'strategy'], visibleToClient: true },
        { title: 'Account Setup & Tracking', description: 'Set up ad accounts, pixels, conversion tracking', order: 2, estimatedHours: 3, requiredSkills: ['ppc', 'analytics'], dependencies: ['1'] },
        { title: 'Creative Development', description: 'Create ad copy and visuals for campaigns', order: 3, estimatedHours: 5, requiredSkills: ['ppc', 'graphic_design'], dependencies: ['2'] },
        { title: 'Campaign Launch', description: 'Launch Meta Ads and Google PPC campaigns', order: 4, estimatedHours: 3, requiredSkills: ['ppc'], visibleToClient: true, dependencies: ['3'] },
        { title: 'Ongoing Optimization', description: 'Daily monitoring and bid/targeting adjustments', order: 5, estimatedHours: 8, requiredSkills: ['ppc', 'analytics'], dependencies: ['4'] },
        { title: 'A/B Testing', description: 'Test ad variations for improved performance', order: 6, estimatedHours: 2, requiredSkills: ['ppc'], dependencies: ['5'] },
        { title: 'Monthly Performance Report', description: 'Detailed report on ad spend, conversions, ROI', order: 7, estimatedHours: 1, requiredSkills: ['ppc', 'analytics'], visibleToClient: true, dependencies: ['5', '6'] },
      ],
      milestones: [
        { name: 'Campaign Strategy Approved', order: 1, taskIndices: [1] },
        { name: 'Campaigns Launched', order: 2, taskIndices: [4] },
        { name: 'First Month Complete', order: 3, taskIndices: [7] },
      ],
    },
  },
};

// Helper to get template by service type and tier
export function getWorkflowTemplate(serviceType: string, serviceTier?: string) {
  const serviceTemplates = WORKFLOW_TEMPLATES[serviceType as keyof typeof WORKFLOW_TEMPLATES];
  if (!serviceTemplates) return null;

  const tier = (serviceTier || 'growth').toLowerCase();
  return serviceTemplates[tier as keyof typeof serviceTemplates] || serviceTemplates['growth' as keyof typeof serviceTemplates];
}

// ==========================================
// File: hooks/use-toast.ts
// ==========================================

'use client';

// Inspired by react-hot-toast library
import * as React from 'react';

import type { ToastActionElement, ToastProps } from '@/components/ui/toast';

const TOAST_LIMIT = 1;
const TOAST_REMOVE_DELAY = 1000000;

type ToasterToast = ToastProps & {
  id: string;
  title?: React.ReactNode;
  description?: React.ReactNode;
  action?: ToastActionElement;
};

const actionTypes = {
  ADD_TOAST: 'ADD_TOAST',
  UPDATE_TOAST: 'UPDATE_TOAST',
  DISMISS_TOAST: 'DISMISS_TOAST',
  REMOVE_TOAST: 'REMOVE_TOAST',
} as const;

let count = 0;

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER;
  return count.toString();
}

type ActionType = typeof actionTypes;

type Action =
  | {
      type: ActionType['ADD_TOAST'];
      toast: ToasterToast;
    }
  | {
      type: ActionType['UPDATE_TOAST'];
      toast: Partial<ToasterToast>;
    }
  | {
      type: ActionType['DISMISS_TOAST'];
      toastId?: ToasterToast['id'];
    }
  | {
      type: ActionType['REMOVE_TOAST'];
      toastId?: ToasterToast['id'];
    };

interface State {
  toasts: ToasterToast[];
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>();

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return;
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId);
    dispatch({
      type: 'REMOVE_TOAST',
      toastId: toastId,
    });
  }, TOAST_REMOVE_DELAY);

  toastTimeouts.set(toastId, timeout);
};

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case 'ADD_TOAST':
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      };

    case 'UPDATE_TOAST':
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      };

    case 'DISMISS_TOAST': {
      const { toastId } = action;

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId);
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id);
        });
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      };
    }
    case 'REMOVE_TOAST':
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        };
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      };
  }
};

const listeners: Array<(state: State) => void> = [];

let memoryState: State = { toasts: [] };

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action);
  listeners.forEach((listener) => {
    listener(memoryState);
  });
}

type Toast = Omit<ToasterToast, 'id'>;

function toast({ ...props }: Toast) {
  const id = genId();

  const update = (props: ToasterToast) =>
    dispatch({
      type: 'UPDATE_TOAST',
      toast: { ...props, id },
    });
  const dismiss = () => dispatch({ type: 'DISMISS_TOAST', toastId: id });

  dispatch({
    type: 'ADD_TOAST',
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss();
      },
    },
  });

  return {
    id: id,
    dismiss,
    update,
  };
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState);

  React.useEffect(() => {
    listeners.push(setState);
    return () => {
      const index = listeners.indexOf(setState);
      if (index > -1) {
        listeners.splice(index, 1);
      }
    };
  }, [state]);

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: 'DISMISS_TOAST', toastId }),
  };
}

export { useToast, toast };

// ==========================================
// File: tailwind.config.ts
// ==========================================

import type { Config } from 'tailwindcss';

const config: Config = {
  darkMode: ['class'],
  content: [
    './pages/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
    './app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      backgroundImage: {
        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
        'gradient-conic':
          'conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))',
      },
      borderRadius: {
        lg: 'var(--radius)',
        md: 'calc(var(--radius) - 2px)',
        sm: 'calc(var(--radius) - 4px)',
      },
      colors: {
        background: 'hsl(var(--background))',
        foreground: 'hsl(var(--foreground))',
        card: {
          DEFAULT: 'hsl(var(--card))',
          foreground: 'hsl(var(--card-foreground))',
        },
        popover: {
          DEFAULT: 'hsl(var(--popover))',
          foreground: 'hsl(var(--popover-foreground))',
        },
        primary: {
          DEFAULT: 'hsl(var(--primary))',
          foreground: 'hsl(var(--primary-foreground))',
        },
        secondary: {
          DEFAULT: 'hsl(var(--secondary))',
          foreground: 'hsl(var(--secondary-foreground))',
        },
        muted: {
          DEFAULT: 'hsl(var(--muted))',
          foreground: 'hsl(var(--muted-foreground))',
        },
        accent: {
          DEFAULT: 'hsl(var(--accent))',
          foreground: 'hsl(var(--accent-foreground))',
        },
        destructive: {
          DEFAULT: 'hsl(var(--destructive))',
          foreground: 'hsl(var(--destructive-foreground))',
        },
        border: 'hsl(var(--border))',
        input: 'hsl(var(--input))',
        ring: 'hsl(var(--ring))',
        // Modern Tech & Trust palette aliases
        'royal-blue': '#1E3A8A',
        'electric-cyan': '#06B6D4',
        'bright-lime': '#A3E635',
        'cool-gray': '#F3F4F6',
        'charcoal': '#111827',
        chart: {
          '1': 'hsl(var(--chart-1))',
          '2': 'hsl(var(--chart-2))',
          '3': 'hsl(var(--chart-3))',
          '4': 'hsl(var(--chart-4))',
          '5': 'hsl(var(--chart-5))',
        },
      },
      keyframes: {
        'accordion-down': {
          from: {
            height: '0',
          },
          to: {
            height: 'var(--radix-accordion-content-height)',
          },
        },
        'accordion-up': {
          from: {
            height: 'var(--radix-accordion-content-height)',
          },
          to: {
            height: '0',
          },
        },
      },
      animation: {
        'accordion-down': 'accordion-down 0.2s ease-out',
        'accordion-up': 'accordion-up 0.2s ease-out',
      },
    },
  },
  plugins: [require('tailwindcss-animate')],
};
export default config;

// ==========================================
// File: postcss.config.js
// ==========================================

module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};

// ==========================================
// File: next.config.js
// ==========================================

const path = require('path');

/** @type {import('next').NextConfig} */
const nextConfig = {
  distDir: process.env.NEXT_DIST_DIR || '.next',
  output: process.env.NEXT_OUTPUT_MODE,
  outputFileTracingRoot: path.join(__dirname),
  experimental: {
  },
  eslint: {
    ignoreDuringBuilds: true,
  },
  typescript: {
    ignoreBuildErrors: false,
  },
  images: { unoptimized: true },
};

module.exports = nextConfig;

// ==========================================
// File: tsconfig.json
// ==========================================

{
  "compilerOptions": {
    "target": "es2020",
    "lib": [
      "dom",
      "dom.iterable",
      "es5",
      "es2020"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".build/types/**/*.ts",
    ".build2/types/**/*.ts"
  ],
  "exclude": [
    "node_modules",
    "nextjs_space"
  ]
}